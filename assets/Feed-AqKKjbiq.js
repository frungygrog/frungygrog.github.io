import{N as M,u as U,n as E,r as g,j as r}from"./vendor-react-DlOpOyxn.js";import{P as L}from"./Post-DauBp_bS.js";import{C as P}from"./Compose-DP1FXD9h.js";import{d as _,e as N,A as C,a as D}from"./index-DcPThPaP.js";import"./vendor-DFcCRmls.js";import"./Popup-C6IAdSN1.js";import"./editor-lib-DRlB_9R9.js";import"./beatmap-preview-KBszVjOw.js";import"./editor-components-BPgr2gO5.js";function Q(){const{data:m}=_(),{tagFilters:d}=N();return M({queryKey:["moddi","feed",d],queryFn:async({pageParam:c=0})=>{const a=new URLSearchParams({limit:"20",offset:String(c)}),i=`${C.moddi.posts}?${a.toString()}`;return await D(i)},enabled:!!m,initialPageParam:0,getNextPageParam:(c,a)=>{var l;const i=a.reduce((p,u)=>{var o;return p+(((o=u.items)==null?void 0:o.length)||0)},0);return(((l=c.items)==null?void 0:l.length)||0)===20?i:void 0}})}function w(){const m=U(),d=E(),{data:c}=_(),{tagFilters:a}=N(),{data:i,fetchNextPage:x,hasNextPage:l,isFetching:p,isFetchingNextPage:u,refetch:o}=Q(),y=g.useMemo(()=>i!=null&&i.pages?i.pages.flatMap(e=>(e.items||[]).map(t=>({...t,user_id:t.user_id??0,username:t.username||"Unknown",avatar_url:t.avatar_url||null,text:t.text??null,uid:t.uid||String(t.id||""),reactions_count:Number(t.reactions_count??0),reacted_by_me:t.reacted_by_me??!1,comments_count:Number(t.comments_count??0)}))):[],[i]),f=g.useMemo(()=>y.filter(e=>{const s=e.tags?typeof e.tags=="string"?e.tags.split(",").map(h=>h.trim()):[]:[],t=!e.tags||s.length===0,n=s.includes("help");return a.untagged&&a.help?!0:a.untagged&&!a.help?t:!a.untagged&&a.help?n:!1}),[y,a]);g.useEffect(()=>{m.pathname==="/md/feed"&&o()},[m.pathname,o]),g.useEffect(()=>{const e=()=>{o()};return window.addEventListener("moddifilterchange",e),()=>window.removeEventListener("moddifilterchange",e)},[o]);const b=e=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(t=>({...t,items:t.items.map(n=>n.id===e.id?e:n)}))})},v=e=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(t=>({...t,items:t.items.filter(n=>n.id!==e)}))})},j=e=>{e&&d.setQueryData(["moddi","feed"],s=>{if(!s)return s;const t={...e,user_id:e.user_id??0,username:e.username||"Unknown",avatar_url:e.avatar_url||null,text:e.text??null,uid:e.uid||String(e.id||""),reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)};return{...s,pages:s.pages.map((n,h)=>h===0?{...n,items:[t,...n.items||[]]}:n)}}),d.invalidateQueries({queryKey:["moddi","feed"]}),o()},F=p&&!u,S=l??!1;return r.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[r.jsxs("div",{className:"feed-header",children:[r.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),r.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),r.jsx(P,{section:"moddi",onPost:j})]}),r.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:r.jsxs("div",{className:"col",style:{gap:0},children:[f.length===0&&!F&&r.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),f.map(e=>r.jsx(L,{post:e,section:"moddi",onUpdate:b,onDelete:v,me:c},e.id)),f.length>0&&S&&r.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:r.jsx("button",{className:"btn secondary",onClick:()=>x(),disabled:u,children:u?"Loading...":"Load more"})})]})})]})}export{w as default};

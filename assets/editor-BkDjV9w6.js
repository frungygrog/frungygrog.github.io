var Ae=Object.defineProperty;var Fe=(t,s,e)=>s in t?Ae(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var Rt=(t,s,e)=>Fe(t,typeof s!="symbol"?s+"":s,e);import{r as x,R as zt,j as p,a as Oe,b as ke,c as Te}from"./vendor-react-CcFPULbg.js";import{J as $e}from"./vendor-zip-B-J1xrE3.js";import{P as De}from"./beatmap-preview-DWWDVpHC.js";function ie(t){const s=(e,n)=>{const o=t==null?void 0:t[e],i=typeof o=="number"?o:Number(o);return Number.isFinite(i)?i:n};return{AR:s("ApproachRate",s("AR",5)),CS:s("CircleSize",5),OD:s("OverallDifficulty",s("OD",5)),HP:s("HPDrainRate",s("HP",5)),SliderMultiplier:s("SliderMultiplier",1.4),SliderTickRate:s("SliderTickRate",1)}}function Ce(t){return 54.4-4.48*t}function je(t){return t<=5?1800-120*t:1200-150*(t-5)}function ze(t){return je(t)*.4}function ce(t){return t?typeof t.uninherited=="number"?t.uninherited===1:(t.beatLength??0)>0:!1}function Ut(t,s){const e=t.timingPoints||[];let n=null,o=null;for(let i=0;i<e.length;i++){const r=e[i];if(r.time<=s)ce(r)?n=r:o=r;else break}if(!n||!o)for(let i=e.length-1;i>=0&&(!n||!o);i--){const r=e[i];r.time<=s&&(ce(r)&&!n&&(n=r),!ce(r)&&!o&&(o=r))}return{base:n,inherited:o}}const Ot=512,Bt=384;function Ue(t){const s=[];for(let i=0;i<t.length;i++){const r=t[i];(!s.length||s[s.length-1].x!==r.x||s[s.length-1].y!==r.y)&&s.push({x:r.x,y:r.y})}const e=[],n=[0];for(let i=1;i<s.length;i++){const r=s[i].x-s[i-1].x,a=s[i].y-s[i-1].y,l=Math.hypot(r,a);e.push(l),n.push(n[n.length-1]+l)}const o=n[n.length-1]||0;return{pts:s,segLen:e,cumLen:n,total:o}}function Wt(t,s){const e=t.total||1,n=Math.max(0,Math.min(e,s*e));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,o-1),r=t.cumLen[i],a=t.segLen[i]||1,l=a>0?(n-r)/a:0,c=t.pts[i],d=t.pts[Math.min(i+1,t.pts.length-1)];return{x:c.x+(d.x-c.x)*l,y:c.y+(d.y-c.y)*l}}function Xe(t,s){const e=t.total||1,n=Math.max(0,Math.min(e,s*e));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,Math.min(t.pts.length-2,o-1)),r=t.pts[i],a=t.pts[i+1];return Math.atan2(a.y-r.y,a.x-r.x)}function ae(t,s){const e=Math.max(0,Math.min(t.total,s));if(e<=0)return[t.pts[0]];if(e>=t.total)return t.pts.slice();const n=[];let o=0;n.push(t.pts[0]);for(let i=1;i<t.pts.length;i++){const r=t.segLen[i-1];if(o+r<e){n.push(t.pts[i]),o+=r;continue}const a=e-o,l=r>0?a/r:0,c=t.pts[i-1],d=t.pts[i];n.push({x:c.x+(d.x-c.x)*l,y:c.y+(d.y-c.y)*l});break}return n}function Ye(t,s){let e=t.map(n=>({x:n.x,y:n.y}));for(;e.length>1;){const n=[];for(let o=0;o<e.length-1;o++)n.push({x:e[o].x+(e[o+1].x-e[o].x)*s,y:e[o].y+(e[o+1].y-e[o].y)*s});e=n}return e[0]}function fe(t,s=64){const e=[];for(let n=0;n<=s;n++){const o=n/s;e.push(Ye(t,o))}return e}function We(t,s=64){const e=[];if(t.length<2)return t.slice();const n=t.slice(),o=.5,i=n.length-1;for(let r=0;r<i;r++){const a=n[Math.max(0,r-1)],l=n[r],c=n[r+1],d=n[Math.min(n.length-1,r+2)];for(let u=0;u<=s;u++){const f=u/s,M=f*f,m=M*f,C=-o*f+2*o*M-o*m,k=1+(o-3)*M+(2-o)*m,N=o*f+(3-2*o)*M+(o-2)*m,w=-o*M+o*m,P=C*a.x+k*l.x+N*c.x+w*d.x,g=C*a.y+k*l.y+N*c.y+w*d.y;e.push({x:P,y:g})}}return e}function _e(t,s=64){if(t.length!==3)return fe(t,96);const[e,n,o]=t,i=n.x-e.x,r=n.y-e.y,a=o.x-e.x,l=o.y-e.y,c=i*(e.x+n.x)+r*(e.y+n.y),d=a*(e.x+o.x)+l*(e.y+o.y),u=2*(i*(o.y-n.y)-r*(o.x-n.x));if(Math.abs(u)<1e-6)return fe(t,96);const f=(l*c-r*d)/u,M=(i*d-a*c)/u,m=Math.atan2(e.y-M,e.x-f),C=Math.atan2(n.y-M,n.x-f),k=Math.atan2(o.y-M,o.x-f),N=W=>(W%(Math.PI*2)+Math.PI*2)%(Math.PI*2),w=N(k-m),P=-N(m-k),$=N(C-m)<=w?w:P,T=Math.hypot(e.x-f,e.y-M),v=[];for(let W=0;W<=s;W++){const D=W/s,X=m+$*D;v.push({x:f+Math.cos(X)*T,y:M+Math.sin(X)*T})}return v}function pe(t,s){return t.x===s.x&&t.y===s.y}function Ke(t,s=64){const e=[];let n=t[0],o=[t[0]];for(let r=1;r<t.length;r++){const a=t[r];pe(a,n)?(o.length>=2&&e.push(o.slice()),o=[a]):(o.push(a),n=a)}o.length>=2&&e.push(o);const i=[];for(const r of e){if(r.length===2){i.length===0&&i.push(r[0]),i.push(r[1]);continue}const a=fe(r,s);i.length>0&&pe(i[i.length-1],a[0])&&a.shift(),i.push(...a)}return i}function qt(t,s){let e;return t==="L"?e=s:t==="B"?e=Ke(s,96):t==="C"?e=We(s,96):e=_e(s,96),Ue(e)}const Ht=new Map;function It(t){return Math.max(0,Math.min(1,t))}function Qt(t,s,e,n,o){t.beginPath(),t.arc(s,e,n,0,Math.PI*2),t.strokeStyle=o,t.lineWidth=3,t.stroke()}function Zt(t,s){if(!(s.length<2)){t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)t.lineTo(s[e].x,s[e].y)}}function He(t){const s=t.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(s){const n=s[1],o=n.length===3?n.split("").map(l=>l+l).join(""):n,i=parseInt(o.slice(0,2),16),r=parseInt(o.slice(2,4),16),a=parseInt(o.slice(4,6),16);return{r:i,g:r,b:a}}const e=t.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return e?{r:Number(e[1]),g:Number(e[2]),b:Number(e[3])}:null}function Ve(t,s,e,n,o,i,r,a=1){if(s.length<2)return;const l=$t.get(s,i,e,n);if(l){t.save(),t.globalAlpha=Math.max(0,Math.min(1,r));const{entry:b,transform:ut}=l;t.translate(ut.tx,ut.ty),t.rotate(ut.angle),t.scale(ut.scale,ut.scale),t.drawImage(b.canvas,b.normMinX-b.pad,b.normMinY-b.pad),t.restore();return}const c=$t.normalizePath(s);let d=1/0,u=1/0,f=-1/0,M=-1/0;for(const b of c)b.x<d&&(d=b.x),b.y<u&&(u=b.y),b.x>f&&(f=b.x),b.y>M&&(M=b.y);const m=Math.ceil(Math.max(e,n)/2)+2,C=Math.max(1,Math.ceil(f-d+m*2)),k=Math.max(1,Math.ceil(M-u+m*2)),N=document.createElement("canvas");N.width=C,N.height=k;const w=N.getContext("2d",{willReadFrequently:!1});w.save(),w.translate(-d+m,-u+m),w.lineCap="round",w.lineJoin="round",w.globalCompositeOperation="source-over",w.globalAlpha=1,w.lineWidth=e,Zt(w,c),w.strokeStyle=o,w.stroke();const P=He(i)||{r:255,g:255,b:255},g=`rgba(${P.r}, ${P.g}, ${P.b}, 1)`;w.lineWidth=n,Zt(w,c),w.strokeStyle=g,w.stroke();const R=Ie(),$=Re[R];w.globalCompositeOperation="soft-light",w.globalCompositeOperation!=="soft-light"&&(w.globalCompositeOperation="screen");const T=$.highlightPasses;for(let b=0;b<T;b++){const ut=b/(T-1),tt=Math.max(1,n*(.96-.7*ut)),St=.15*(1-ut)*(1-ut)*a;w.lineWidth=tt,Zt(w,c),w.strokeStyle=`rgba(255,255,255,${St.toFixed(3)})`,w.stroke()}if($.edgePasses>0){w.globalCompositeOperation="multiply";const b=$.edgePasses;for(let ut=0;ut<b;ut++){const tt=ut/(b-1),St=Math.max(1,n*(.98-.08*tt)),jt=(.1-.03*tt)*a;w.lineWidth=St,Zt(w,c),w.strokeStyle=`rgba(0,0,0,${Math.max(0,jt).toFixed(3)})`,w.stroke()}}w.restore(),$t.set(s,i,e,n,{canvas:N,normalizedWidth:C,normalizedHeight:k,pad:m,normMinX:d,normMinY:u,lastUsed:0,accessCount:0,memoryBytes:C*k*4,pathSignature:$t.generatePathSignature(s)});const v=s[0],W=s[s.length-1],D=c[c.length-1],X=Math.atan2(W.y-v.y,W.x-v.x),dt=Math.atan2(D.y,D.x),Q=X-dt;t.save(),t.globalAlpha=Math.max(0,Math.min(1,r)),t.translate(v.x,v.y),t.rotate(Q),t.drawImage(N,d-m,u-m),t.restore()}function te(t,s,e,n,o,i=1,r){const a=o.hitcircle,l=o.hitcircleoverlay,c=n*2/(a.width||128),d=Math.max(1,Math.round(a.width*c)),u=Math.max(1,Math.round(a.height*c));if(t.save(),t.translate(s,e),t.globalAlpha=i,r){const f=`${a.src}|${r}|${d}x${u}`;let M=Ht.get(f);if(!M){M=document.createElement("canvas"),M.width=d,M.height=u;const m=M.getContext("2d");m.drawImage(a,0,0,d,u),m.globalCompositeOperation="source-in",m.fillStyle=r,m.fillRect(0,0,d,u),Ht.set(f,M)}t.drawImage(M,-d/2,-u/2,d,u)}else t.drawImage(a,-d/2,-u/2,d,u);l&&t.drawImage(l,-d/2,-u/2,d,u),t.restore()}function ye(t,s,e,n,o,i,r){const a=i.approachcircle,l=n*2/(a.width||128),c=Math.max(1,Math.round(a.width*l)),d=Math.max(1,Math.round(a.height*l));if(t.save(),t.globalAlpha=.6*o,t.translate(s,e),r){const u=`${a.src}|approach|${r}|${c}x${d}`;let f=Ht.get(u);if(!f){f=document.createElement("canvas"),f.width=c,f.height=d;const M=f.getContext("2d");M.drawImage(a,0,0,c,d),M.globalCompositeOperation="source-in",M.fillStyle=r,M.fillRect(0,0,c,d),Ht.set(u,f)}t.drawImage(f,-c/2,-d/2,c,d)}else t.drawImage(a,-c/2,-d/2,c,d);t.restore()}function Ge(t,s,e,n,o,i=1){const r=o.sliderfollowcircle,a=n*2/(r.width||256),l=r.width*a,c=r.height*a;t.save(),t.globalAlpha=.9*It(i),t.translate(s,e),t.drawImage(r,-l/2,-c/2,l,c),t.restore()}function xe(t,s,e,n,o,i,r=1){var m;if(!o.digits||i<=0)return;const l=String(i).split("").map(C=>o.digits[Number(C)]),c=((m=l[0])==null?void 0:m.height)||32,u=n*.82*.85/c,f=l.reduce((C,k)=>C+((k==null?void 0:k.width)||20)*u,0);let M=s-f/2;t.save(),t.globalAlpha=r;for(const C of l){const k=((C==null?void 0:C.width)||20)*u,N=((C==null?void 0:C.height)||20)*u;t.drawImage(C,M,e-N/2,k,N),M+=k}t.restore()}function qe(t,s,e){const n=Math.max(1,Math.round(s)),o=`${t.src}|ball|${e}|${n}`;let i=Ht.get(o);if(!i){i=document.createElement("canvas"),i.width=n,i.height=n;const r=i.getContext("2d");r.clearRect(0,0,n,n),r.drawImage(t,0,0,n,n),r.globalCompositeOperation="multiply",r.fillStyle=e,r.fillRect(0,0,n,n),r.globalCompositeOperation="destination-in",r.drawImage(t,0,0,n,n),Ht.set(o,i)}return i}function ee(t,s,e,n,o,i,r,a,l){const c=Math.max(1,o),d=c/Math.max(1,s.width||128),u=(s.width||128)*d,f=(s.height||128)*d;if(t.save(),t.translate(e,n),t.rotate(i),l?t.globalCompositeOperation="lighter":t.globalCompositeOperation="source-over",r&&r!=="#ffffff"&&r!=="rgba(255,255,255,1)"){const M=qe(s,c,r);t.globalAlpha=a,t.drawImage(M,-u/2,-f/2,u,f)}else t.globalAlpha=a,t.drawImage(s,-u/2,-f/2,u,f);t.restore()}function Je(t,s,e,n,o,i){const r=t.createRadialGradient(s-n*.3,e-n*.3,n*.15,s,e,n);r.addColorStop(0,"rgba(255,255,255,1)"),r.addColorStop(1,o),t.save(),t.globalAlpha=i,t.fillStyle=r,t.beginPath(),t.arc(s,e,n,0,Math.PI*2),t.fill(),t.restore()}function _t(t){return t*(2-t)}function Kt(t,s,e,n){const o=n&&n<0?100/-n:1,i=100*e*o;return t.length/Math.max(1e-6,i)*s}function Qe(t,s,e,n,o){const i=n&&n<0?100/-n:1,r=100*e*i,a=t.length/Math.max(1e-6,r),l=1/Math.max(1e-6,o),c=[];for(let d=l;d<a-.001;d+=l){const u=d/a;u>0&&u<1&&c.push(u)}return c}function Pe(t,s,e){let n=1/0;for(let o=1;o<e.pts.length;o++){const i=e.pts[o-1],r=e.pts[o],a=r.x-i.x,l=r.y-i.y,c=a*a+l*l;let d=0;c>0&&(d=((t-i.x)*a+(s-i.y)*l)/c,d=Math.max(0,Math.min(1,d)));const u=i.x+a*d,f=i.y+l*d,M=Math.hypot(u-t,f-s);M<n&&(n=M)}return n}function kt(t,s,e){const n=3*e;return{x:t-n,y:s-n}}function ge(t){const s=(t==null?void 0:t.hitObjects.length)||0,e=new Array(s).fill(0),n=new Array(s).fill(1);if(!t)return{colorIndex:e,number:n};let o=0,i=0;for(let r=0;r<s;r++){const a=t.hitObjects[r];a.newCombo?(o=o+1+(a.comboSkip||0),i=1):i=(i||1)+1,e[r]=o,n[r]=i}return{colorIndex:e,number:n}}function Ze(t){const s=(t==null?void 0:t.hitObjects.length)||0,e=new Array(s).fill(0);if(!t)return e;const n=t.hitObjects,o=60,i=3;for(let r=1;r<s;r++){const a=n[r-1],l=n[r];if(l.time-a.time<=o){const d=l.x-a.x,u=l.y-a.y;if(Math.hypot(d,u)<=i){e[r]=e[r-1]+1;continue}}if(a.kind==="slider"){const d=Gt(t,a),u=Jt(t,a),f=l.time-d;if(f<=o&&f>=-o){const M=Vt(l),m=M.x-u.x,C=M.y-u.y;Math.hypot(m,C)<=i&&(e[r]=e[r-1]+1)}}}return e}function Gt(t,s){if(s.kind==="circle")return s.time;if(s.kind==="spinner")return s.endTime;const{base:e,inherited:n}=Ut(t,s.time),o=(e==null?void 0:e.beatLength)??500,i=n==null?void 0:n.beatLength,r=Kt(s,o,ie(t.difficulty).SliderMultiplier,i),a=Math.max(1,s.slides);return s.time+r*a}function Jt(t,s){if(s.kind==="circle")return Vt(s);if(s.kind==="spinner")return{x:Ot/2,y:Bt/2};const e=s,n=qt(e.curveType,e.points),o=e.length;let i=n;if(o>0&&o<n.total){const f=ae(n,o),M={pts:f,segLen:[],cumLen:[0],total:o};for(let m=1;m<f.length;m++){const C=f[m].x-f[m-1].x,k=f[m].y-f[m-1].y,N=Math.hypot(C,k);M.segLen.push(N),M.cumLen.push(M.cumLen[M.cumLen.length-1]+N)}i=M}const{base:r,inherited:a}=Ut(t,e.time),l=(r==null?void 0:r.beatLength)??500,c=a==null?void 0:a.beatLength;Kt(e,l,ie(t.difficulty).SliderMultiplier,c);const u=(Math.max(1,e.slides)-1)%2===0;return Wt(i,u?1:0)}function Vt(t){if(t.kind==="circle"){const e=t;return typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:{x:t.x,y:t.y}}if(t.kind==="spinner")return{x:Ot/2,y:Bt/2};const s=t;return typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:{x:t.x,y:t.y}}function me(t,s,e,n,o,i,r,a){if(i!==void 0&&r!==void 0&&a!==void 0&&!(i>=r-a&&i<r+240))return!1;const l=t-e,c=s-n;return Math.hypot(l,c)<=o}function ts(t,s,e,n,o,i,r,a){if(a!==void 0){const N=Gt(o,e);if(!(n>=e.time-a&&n<N+240))return!1}const l=Vt(e),c=Jt(o,e),d=kt(l.x,l.y,r);if(me(t,s,d.x,d.y,i))return!0;const u=kt(c.x,c.y,r);if(me(t,s,u.x,u.y,i))return!0;let f=qt(e.curveType,e.points);const M=e.length;if(M>0&&M<f.total){const N=ae(f,M),w={pts:N,segLen:[],cumLen:[0],total:M};for(let P=1;P<N.length;P++){const g=N[P].x-N[P-1].x,R=N[P].y-N[P-1].y,$=Math.hypot(g,R);w.segLen.push($),w.cumLen.push(w.cumLen[w.cumLen.length-1]+$)}f=w}const m={x:d.x-l.x,y:d.y-l.y},C={pts:f.pts.map(N=>({x:N.x+m.x,y:N.y+m.y})),segLen:f.segLen,cumLen:f.cumLen,total:f.total};return Pe(t,s,C)<=i}function es(t,s,e,n){if(t.kind==="circle"){const m=kt(t.x,t.y,n);return{minX:m.x-e,minY:m.y-e,maxX:m.x+e,maxY:m.y+e}}if(t.kind==="spinner"){const m={x:Ot/2,y:Bt/2};return{minX:m.x-e,minY:m.y-e,maxX:m.x+e,maxY:m.y+e}}const o=t,i=qt(o.curveType,o.points),r=Vt(o),a=Jt(s,o),l=kt(r.x,r.y,n),c=kt(a.x,a.y,n);let d=Math.min(l.x,c.x),u=Math.min(l.y,c.y),f=Math.max(l.x,c.x),M=Math.max(l.y,c.y);for(const m of i.pts){const C=kt(m.x,m.y,n);d=Math.min(d,C.x),u=Math.min(u,C.y),f=Math.max(f,C.x),M=Math.max(M,C.y)}return{minX:d-e,minY:u-e,maxX:f+e,maxY:M+e}}function we(t,s,e,n,o){const i=[],r=t.hitObjects,a=1200,l=2e3,c=e-a,d=e+l,u=c-1e4;let f=0,M=r.length;for(;f<M;){const R=f+M>>>1;r[R].time<u?f=R+1:M=R}const m=f;for(f=0,M=r.length;f<M;){const R=f+M>>>1;r[R].time<=d?f=R+1:M=R}const C=f,k=Math.max(0,Math.min(Ot,s.minX)),N=Math.max(0,Math.min(Bt,s.minY)),w=Math.max(0,Math.min(Ot,s.maxX)),P=Math.max(0,Math.min(Bt,s.maxY));if(w<=k||P<=N)return[];const g={minX:k,minY:N,maxX:w,maxY:P};for(let R=m;R<C;R++){const $=r[R];let T=$.time;$.kind==="slider"?T=Gt(t,$):$.kind==="spinner"&&(T=$.endTime);const v=$.time;if(!(T>=c&&v<=d))continue;const D=o[R]||0,X=es($,t,n,D);!(X.maxX<g.minX||X.minX>g.maxX||X.maxY<g.minY||X.minY>g.maxY)&&i.push(R)}return i}class ss{constructor(){Rt(this,"cache",new Map);Rt(this,"maxSize",50);Rt(this,"accessCounter",0);Rt(this,"shapeUsageMap",new Map);Rt(this,"totalMemoryBytes",0);Rt(this,"memoryBudgetBytes");Rt(this,"stats",{hits:0,misses:0,totalRenders:0,cacheSize:0,lastFrameHits:0,lastFrameMisses:0,uniqueShapesInMap:0,get hitRate(){const s=this.hits+this.misses;return s>0?this.hits/s*100:0},get totalDrawCalls(){return this.hits+this.misses}});this.memoryBudgetBytes=this.calculateMemoryBudget()}getStats(){return this.stats.cacheSize=this.cache.size,{...this.stats}}resetFrameStats(){this.stats.lastFrameHits=0,this.stats.lastFrameMisses=0}getMaxSize(){return this.maxSize}getMemoryUsage(){return this.totalMemoryBytes}getMemoryBudget(){return this.memoryBudgetBytes}calculateMemoryBudget(){const s=navigator.hardwareConcurrency||4,e=navigator.deviceMemory||4;return s<=4||e<=4?30*1024*1024:s<=8||e<=8?50*1024*1024:80*1024*1024}resetStats(){this.stats.hits=0,this.stats.misses=0,this.stats.totalRenders=0}normalizePath(s){if(s.length<2)return s;const e=s[0],n=s.map(a=>({x:a.x-e.x,y:a.y-e.y}));let o=0;for(let a=1;a<n.length;a++){const l=n[a].x-n[a-1].x,c=n[a].y-n[a-1].y,d=Math.hypot(l,c);o+=d}if(o<1e-6)return n;const i=n[n.length-1],r=Math.atan2(i.y,i.x);if(Math.hypot(i.x,i.y)>.001){const a=Math.cos(-r),l=Math.sin(-r);return n.map(c=>({x:c.x*a-c.y*l,y:c.x*l+c.y*a}))}return n}generatePathSignature(s){if(s.length<2)return"empty";const e=this.normalizePath(s),n=Math.min(32,e.length),o=[];if(e.length<=n)for(const r of e)o.push(`${r.x.toFixed(3)},${r.y.toFixed(3)}`);else for(let r=0;r<n;r++){const a=Math.floor(r/(n-1)*(e.length-1)),l=e[a];o.push(`${l.x.toFixed(3)},${l.y.toFixed(3)}`)}let i=0;for(let r=1;r<e.length-1;r++){const a=e[r-1],l=e[r],c=e[r+1],d=l.x-a.x,u=l.y-a.y,f=c.x-l.x,M=c.y-l.y,m=Math.atan2(u,d),C=Math.atan2(M,f);i+=Math.abs(C-m)}return`${o.join("|")}-curv:${i.toFixed(2)}`}hashPath(s,e,n,o){if(s.length<2)return`empty-${e}-${Math.round(n)}-${Math.round(o)}`;const i=this.normalizePath(s),r=Math.min(14,i.length),a=[];if(i.length<=r)for(const C of i)a.push(`${C.x.toFixed(2)},${C.y.toFixed(2)}`);else for(let C=0;C<r;C++){const k=Math.floor(C/(r-1)*(i.length-1)),N=i[k];a.push(`${N.x.toFixed(2)},${N.y.toFixed(2)}`)}let l=0;for(let C=1;C<i.length;C++){const k=i[C].x-i[C-1].x,N=i[C].y-i[C-1].y;l+=Math.hypot(k,N)}let c=0;for(let C=1;C<i.length-1;C++){const k=i[C-1],N=i[C],w=i[C+1],P=N.x-k.x,g=N.y-k.y,R=w.x-N.x,$=w.y-N.y,T=Math.atan2(g,P),v=Math.atan2($,R);c+=Math.abs(v-T)}const d=Math.round(n),u=Math.round(o),f=l.toFixed(1),M=c.toFixed(2);return`${a.join("|")}-len:${f}-curv:${M}-pts:${s.length}-${e}-${d}-${u}`}get(s,e,n,o){if(s.length<2)return null;const i=this.hashPath(s,e,n,o),r=this.cache.get(i);if(r){r.lastUsed=++this.accessCounter,r.accessCount++;const a=this.shapeUsageMap.get(i);a&&a.accessCount++,this.stats.hits++,this.stats.lastFrameHits++;const l=this.normalizePath(s),c=s[0],d=s[s.length-1],u=l[l.length-1],f=Math.atan2(d.y-c.y,d.x-c.x),M=Math.atan2(u.y,u.x);let m=f-M;for(;m>Math.PI;)m-=2*Math.PI;for(;m<-Math.PI;)m+=2*Math.PI;return{entry:r,transform:{tx:c.x,ty:c.y,angle:m,scale:1}}}return this.stats.misses++,this.stats.lastFrameMisses++,null}shouldCache(s,e,n,o,i){if(o>2e3||i>2e3)return!1;let a=0;for(let l=1;l<s.length;l++){const c=s[l].x-s[l-1].x,d=s[l].y-s[l-1].y;a+=Math.hypot(c,d)}return!(a<20)}set(s,e,n,o,i){const r=this.hashPath(s,e,n,o),a=i.canvas.width*i.canvas.height*4;if(i.memoryBytes=a,i.pathSignature=this.generatePathSignature(s),i.accessCount=0,(this.cache.size>=this.maxSize||this.totalMemoryBytes+a>this.memoryBudgetBytes)&&!this.cache.has(r)){let d=!1;if(this.shapeUsageMap.size>0){const u=[];for(const[f,M]of this.shapeUsageMap.entries())M.lastUsageTime<Date.now()-5e3&&u.push(f);if(u.length>0)for(const f of u)this.cache.delete(f),this.shapeUsageMap.delete(f),d=!0}d||this.evictByMemory(a)}const c=this.cache.get(r);c&&(this.totalMemoryBytes-=c.memoryBytes),i.lastUsed=++this.accessCounter,this.cache.set(r,i),this.totalMemoryBytes+=a,this.stats.totalRenders++}evictByMemory(s){const e=s+this.memoryBudgetBytes*.1,n=[],o=Date.now();for(const[r,a]of this.cache.entries()){const l=this.shapeUsageMap.get(r),c=l?l.lastUsageTime<o:!1,d=a.accessCount,u=a.memoryBytes;let f=0;c&&(f+=1e3),f+=u/1e3,f-=d*10,f+=(this.accessCounter-a.lastUsed)/100,n.push({key:r,entry:a,score:f})}n.sort((r,a)=>a.score-r.score);let i=0;for(const r of n){if(i>=e)break;this.cache.delete(r.key),this.shapeUsageMap.delete(r.key),this.totalMemoryBytes-=r.entry.memoryBytes,i+=r.entry.memoryBytes}}clear(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0}clearAll(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0,this.memoryBudgetBytes=this.calculateMemoryBudget()}renderShapeToCanvas(s,e,n,o,i){if(s.length<2)return null;let r=1/0,a=1/0,l=-1/0,c=-1/0;for(const g of s)g.x<r&&(r=g.x),g.y<a&&(a=g.y),g.x>l&&(l=g.x),g.y>c&&(c=g.y);const d=Math.ceil(Math.max(e,n)/2)+2,u=Math.max(1,Math.ceil(l-r+d*2)),f=Math.max(1,Math.ceil(c-a+d*2));if(!this.shouldCache(s,e,n,u,f))return null;const M=document.createElement("canvas");M.width=u,M.height=f;const m=M.getContext("2d",{willReadFrequently:!1});m.save(),m.translate(-r+d,-a+d),m.lineCap="round",m.lineJoin="round",m.globalCompositeOperation="source-over",m.globalAlpha=1,m.lineWidth=e,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let g=1;g<s.length;g++)m.lineTo(s[g].x,s[g].y);m.strokeStyle=o,m.stroke();const C=this.rgbFromCss(i)||{r:255,g:255,b:255},k=`rgba(${C.r}, ${C.g}, ${C.b}, 1)`;m.lineWidth=n,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let g=1;g<s.length;g++)m.lineTo(s[g].x,s[g].y);m.strokeStyle=k,m.stroke();const N=Ie(),w=Re[N];m.globalCompositeOperation="soft-light",m.globalCompositeOperation!=="soft-light"&&(m.globalCompositeOperation="screen");const P=w.highlightPasses;for(let g=0;g<P;g++){const R=g/(P-1),$=Math.max(1,n*(.96-.7*R)),T=.15*(1-R)*(1-R);m.lineWidth=$,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let v=1;v<s.length;v++)m.lineTo(s[v].x,s[v].y);m.strokeStyle=`rgba(255,255,255,${T.toFixed(3)})`,m.stroke()}if(w.edgePasses>0){m.globalCompositeOperation="multiply";const g=w.edgePasses;for(let R=0;R<g;R++){const $=R/(g-1),T=Math.max(1,n*(.98-.08*$)),v=.1-.03*$;m.lineWidth=T,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let W=1;W<s.length;W++)m.lineTo(s[W].x,s[W].y);m.strokeStyle=`rgba(0,0,0,${Math.max(0,v).toFixed(3)})`,m.stroke()}}return m.restore(),{canvas:M,minX:r,minY:a,pad:d}}rgbFromCss(s){const e=s.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(e){const o=e[1],i=o.length===3?o.split("").map(c=>c+c).join(""):o,r=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),l=parseInt(i.slice(4,6),16);return{r,g:a,b:l}}const n=s.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return n?{r:Number(n[1]),g:Number(n[2]),b:Number(n[3])}:null}precalculateShapes(s,e,n,o,i=240,r="#ffffff"){if(this.shapeUsageMap.clear(),!s||!s.hitObjects)return;const a=o*2,l=Math.max(1,a-8),c=Math.max(1,a-14),d=ge(s),u=new Set,f=[];for(let R=0;R<s.hitObjects.length;R++){const $=s.hitObjects[R];if($.kind!=="slider")continue;const T=$,v=qt(T.curveType,T.points),W=T.length;let D=v;if(W>0&&W<v.total){const et=ae(v,W),ht={pts:et,segLen:[],cumLen:[0],total:W};for(let it=1;it<et.length;it++){const E=et[it].x-et[it-1].x,F=et[it].y-et[it-1].y,q=Math.hypot(E,F);ht.segLen.push(q),ht.cumLen.push(ht.cumLen[ht.cumLen.length-1]+q)}D=ht}const X=d.colorIndex[R],dt=n[X%n.length],Q=this.hashPath(D.pts,dt,l,c);u.add(Q);const{base:b,inherited:ut}=Ut(s,T.time),tt=(b==null?void 0:b.beatLength)??500,St=ut==null?void 0:ut.beatLength,jt=Kt(T,tt,e.SliderMultiplier,St),Tt=Math.max(1,T.slides),Pt=T.time+jt*Tt+i,A=f.find(et=>et.cacheKey===Q);A?(Pt>A.lastUsageTime&&(A.lastUsageTime=Pt),A.sliderIndices.push(R)):f.push({cacheKey:Q,pts:D.pts,comboColor:dt,lastUsageTime:Pt,sliderIndices:[R]})}const M=u.size;this.stats.uniqueShapesInMap=M;const m=200*200*4,C=Math.floor(this.memoryBudgetBytes/m);this.maxSize=Math.min(Math.ceil(M*.8),C,200);const k=6200,N=f.filter(R=>{var T;return R.sliderIndices.length>1?!0:(((T=s.hitObjects[R.sliderIndices[0]])==null?void 0:T.time)||1/0)<=k});for(const R of f)this.shapeUsageMap.set(R.cacheKey,{cacheKey:R.cacheKey,lastUsageTime:R.lastUsageTime,sliderIndices:R.sliderIndices,accessCount:0,isPreRendered:!1});const w=15;let P=0;const g=()=>{const R=P*w,$=Math.min(R+w,N.length);for(let T=R;T<$;T++){const v=N[T],W=this.normalizePath(v.pts),D=this.renderShapeToCanvas(W,l,c,r,v.comboColor);if(D){const X={canvas:D.canvas,normalizedWidth:D.canvas.width,normalizedHeight:D.canvas.height,pad:D.pad,normMinX:D.minX,normMinY:D.minY,lastUsed:0,accessCount:0,memoryBytes:D.canvas.width*D.canvas.height*4,pathSignature:this.generatePathSignature(v.pts)};this.set(v.pts,v.comboColor,l,c,X);const dt=this.shapeUsageMap.get(v.cacheKey);dt&&(dt.isPreRendered=!0)}}P++,$<N.length&&(typeof requestIdleCallback<"u"?requestIdleCallback(g,{timeout:100}):setTimeout(g,0))};N.length>0&&(typeof requestIdleCallback<"u"?requestIdleCallback(g,{timeout:100}):setTimeout(g,0))}evictExpiredShapes(s){const e=[];for(const[n,o]of this.shapeUsageMap.entries())if(o.lastUsageTime<s){const i=this.cache.get(n);if(i){let r=0;r+=i.memoryBytes/1e3,r-=i.accessCount*10,r-=o.accessCount*5,r+=(this.accessCounter-i.lastUsed)/100,e.push({key:n,entry:i,info:o,score:r})}}e.sort((n,o)=>o.score-n.score);for(const n of e)this.cache.has(n.key)&&(this.cache.delete(n.key),this.totalMemoryBytes-=n.entry.memoryBytes),this.shapeUsageMap.delete(n.key);this.totalMemoryBytes>this.memoryBudgetBytes&&this.evictByMemory(0)}}const $t=new ss;function ns(){const t=navigator.hardwareConcurrency||4,s=navigator.deviceMemory||4;return t<=4||s<=4?"low":t<=8||s<=8?"medium":"high"}const Re={high:{highlightPasses:16,edgePasses:3},medium:{highlightPasses:10,edgePasses:2},low:{highlightPasses:8,edgePasses:1}};let le=null;function Ie(){return le===null&&(le=ns()),le}function he(t,s,e,n,o,i,r,a,l,c,d,u,f,M,m="core",C=1,k=240,N,w){if(e.kind==="circle"){if(m!=="core")return;const P=e.time-r,g=n<=e.time?It((n-P)/Math.max(1,a)):1,R=n<=e.time?1:It(1-(n-e.time)/400);let $=It(g*R);if(w!==void 0&&($=Math.max($,w)),$<=.001)return;const T=typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:kt(e.x,e.y,f);if(o!=null&&o.approachcircle){const W=1+2*It((e.time-n)/Math.max(1,r));ye(t,T.x,T.y,i*W,.8*$,o,d)}o!=null&&o.hitcircle?(t.save(),te(t,T.x,T.y,i,o,$,d),o!=null&&o.digits&&xe(t,T.x,T.y,i,o,u,$),t.restore()):(t.save(),t.globalAlpha=$,Qt(t,T.x,T.y,i,d),t.restore())}else if(e.kind==="slider"){const P=qt(e.curveType,e.points);let g,R,$,T,v;if(N)g=N.base,R=N.inherited,$=N.baseBeat,T=N.ih,v=N.span??Kt(e,$,l,T);else{const E=Ut(s,e.time);g=E.base,R=E.inherited,$=(g==null?void 0:g.beatLength)??500,T=R==null?void 0:R.beatLength,v=Kt(e,$,l,T)}const W=Math.max(1,e.slides),D=e.time+v*W,X=e.time-r,dt=Math.max(1,Math.floor(r*.4)),Q=Math.max(1,k);let b=0;n<X?b=0:n<e.time?b=It((n-X)/dt):n<=D?b=1:b=It(1-(n-D)/Q),w!==void 0&&(b=Math.max(b,w));const ut=e.length;let tt=P;if(ut>0&&ut<P.total){const E=ae(P,ut),F={pts:E,segLen:[],cumLen:[0],total:ut};for(let q=1;q<E.length;q++){const ft=E[q].x-E[q-1].x,L=E[q].y-E[q-1].y,h=Math.hypot(ft,L);F.segLen.push(h),F.cumLen.push(F.cumLen[F.cumLen.length-1]+h)}tt=F}const St=tt.pts,jt=!!M&&Pe(M.x,M.y,tt)<=Math.max(6,i*.35),Tt=typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:kt(e.x,e.y,f),pt={x:Tt.x-e.x,y:Tt.y-e.y},Pt=St.map(E=>({x:E.x+pt.x,y:E.y+pt.y})),A=i*2,et=Math.max(1,A-8),ht=Math.max(1,A-14),it=(o==null?void 0:o.sliderBorder)||"#ffffff";if(m==="body"){if(b<=.01)return;Ve(t,Pt,et,ht,it,d,b,1);return}if(m==="core"){const E=e.time+v*W,F=E-r,q=n<=E?It((n-F)/Math.max(1,a)):1,ft=n<=E?1:It(1-(n-E)/400);let L=It(q*ft)*b;w!==void 0&&(L=Math.max(L,w));const h=(W-1)%2===0,at=Wt(tt,h?1:0),st={x:at.x+pt.x,y:at.y+pt.y};if(L>.001&&(o!=null&&o.hitcircle?te(t,st.x,st.y,i,o,L,d):(t.save(),t.globalAlpha=L,Qt(t,st.x,st.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const rt=i*2/(o.sliderendcircle.width||128),gt=o.sliderendcircle.width*rt,O=o.sliderendcircle.height*rt;t.save(),t.globalAlpha=L,t.translate(st.x,st.y),t.drawImage(o.sliderendcircle,-gt/2,-O/2,gt,O),t.restore()}if(W>1)for(let rt=0;rt<W-1;rt++){const O=rt%2===0?1:0,lt=Wt(tt,O),G={x:lt.x+pt.x,y:lt.y+pt.y},mt=e.time+v*(rt+1),bt=mt-r,xt=n<=mt?It((n-bt)/Math.max(1,a)):1,wt=n<=mt?1:It(1-(n-mt)/400),vt=It(xt*wt);if(vt>0&&(o!=null&&o.hitcircle?te(t,G.x,G.y,i,o,vt,d):(t.save(),t.globalAlpha=vt,Qt(t,G.x,G.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const y=i*2/(o.sliderendcircle.width||128),B=o.sliderendcircle.width*y,nt=o.sliderendcircle.height*y;t.save(),t.globalAlpha=vt,t.translate(G.x,G.y),t.drawImage(o.sliderendcircle,-B/2,-nt/2,B,nt),t.restore()}}const J=Tt,S=e.time-r,yt=n<=e.time?It((n-S)/Math.max(1,a)):1,_=n<=e.time?1:It(1-(n-e.time)/400);let H=It(yt*_)*b;if(w!==void 0&&(H=Math.max(H,w)),H>.001)if(o!=null&&o.hitcircle){if(t.save(),te(t,J.x,J.y,i,o,H,d),o.sliderstartcircle){const rt=o.sliderstartcircle,gt=i*2/(rt.width||128),O=rt.width*gt,lt=rt.height*gt;t.drawImage(rt,J.x-O/2,J.y-lt/2,O,lt)}o!=null&&o.digits&&xe(t,J.x,J.y,i,o,u,H),t.restore()}else t.save(),t.globalAlpha=H,Qt(t,J.x,J.y,i,d),t.restore();if(o!=null&&o.approachcircle&&H>.001){const gt=1+2*It((e.time-n)/Math.max(1,r));ye(t,J.x,J.y,i*gt,.8*H,o,d)}}if(m==="top"&&(w!==void 0||n>=e.time&&n<=D)){let E=n-e.time,F=0,q=0;w!==void 0&&(n<e.time||n>D)?n<e.time?(E=0,F=0,q=0):(E=D-e.time,F=W-1,q=1):(E=n-e.time,F=Math.floor(E/v),q=E%v/v);const L=F%2===0?q:1-q,h=Wt(tt,L),at={x:h.x+pt.x,y:h.y+pt.y};o!=null&&o.sliderfollowcircle&&b>.001&&Ge(t,at.x,at.y,i*1.6,o,b);const st=Math.max(4,Math.max(1,A-6)),J=It(b);if(J<=.001)return;const S=.1/Math.max(1,tt.total),yt=Math.max(0,Math.min(1-S,L)),_=Math.min(1,L+S),z=Wt(tt,yt),H=Wt(tt,_),rt=z.x-H.x,gt=z.y-H.y,lt=(-90+-Math.atan2(rt,gt)*180/Math.PI)*Math.PI/180,G=o==null?void 0:o.sliderballFrames,mt=G&&G.length>0,bt=!!(o!=null&&o.sliderb),xt=tt.total/(v*W),wt=Math.max(.15/xt*(1e3/60),1e3/60),vt=mt?Math.floor(E/wt)%G.length:0,y=d;if(o!=null&&o.sliderbnd&&ee(t,o.sliderbnd,at.x,at.y,st,0,"#000000",J,!1),mt){const B=G[vt];ee(t,B,at.x,at.y,st,lt,y,J,!1)}else bt?ee(t,o.sliderb,at.x,at.y,st,lt,y,J,!1):Je(t,at.x,at.y,st/2,d,J);o!=null&&o.sliderbspec&&ee(t,o.sliderbspec,at.x,at.y,st,0,"#ffffff",J,!0)}if(m==="top"&&(o!=null&&o.reversearrow)&&W>1){let E=-1;for(let F=0;F<W-1;F++){const q=e.time+v*(F+1);if(n<q){E=F;break}}for(let F=0;F<W-1;F++){if(E===-1)continue;let q=!1;if((F===E||E>0&&F===E-1)&&(q=!0),!q)continue;const ft=F%2===0,h=Wt(tt,ft?1:0),at={x:h.x+pt.x,y:h.y+pt.y},st=Xe(tt,ft?1-.001:.001)+(ft?Math.PI:0),J=e.time+v*(F+1),S=J-r,yt=300,_=150,z=((Math.min(n,J)-S)%yt+yt)%yt;let H=0,rt=1;if(n>J){const gt=1.3-_t(z/yt)*.3,O=1.4-gt,lt=Math.min(300,v),G=It((n-J)/lt);rt=gt+_t(G)*O,H=_t(1-G)}else if(n>=S){H=It((n-S)/_);const gt=35,O=250;if(z<gt)rt=1+_t(z/gt)*.3;else{const lt=(z-gt)/(gt+O);rt=1.3-_t(lt)*.3}}if(H*=b,H>.01){t.save(),t.globalAlpha=H,t.translate(at.x,at.y),t.rotate(st),t.scale(rt,rt);const gt=i*2*.72/(o.reversearrow.width||128),O=o.reversearrow.width*gt,lt=o.reversearrow.height*gt;t.drawImage(o.reversearrow,-O/2,-lt/2,O,lt),t.restore()}}}if(m==="top"&&(o!=null&&o.sliderscorepoint)){const F={x:e.x+pt.x,y:e.y+pt.y},q=(W-1)%2===0,ft=Wt(tt,q?1:0),L={x:ft.x+pt.x,y:ft.y+pt.y};for(let h=0;h<W;h++){const at=h%2===1,st=Qe(e,$,l,T,c);for(const J of st){const S=at?1-J:J,yt=Wt(tt,S),_={x:yt.x+pt.x,y:yt.y+pt.y},z=e.time+v*h+v*J,H=Math.hypot(_.x-F.x,_.y-F.y),rt=Math.hypot(_.x-L.x,_.y-L.y);if(H<i||rt<i)continue;const gt=z-r;let O=0;if(n<z?O=It((n-gt)/Math.max(1,a)):O=It(1-(n-z)/200),O*=b,O<=.001)continue;const lt=i*.15;t.save(),t.globalAlpha=O,t.translate(_.x,_.y);const G=o.sliderscorepoint,mt=lt*2/(G.width||64);t.drawImage(G,-G.width*mt/2,-G.height*mt/2,G.width*mt,G.height*mt),t.restore()}}}if(m==="top"&&jt&&e.points.length>0){t.save(),t.globalAlpha=b,t.strokeStyle="#efefef",t.lineWidth=1,t.beginPath();const E=e.points[0];t.moveTo(E.x+pt.x,E.y+pt.y);for(let q=1;q<e.points.length;q++){const ft=e.points[q];t.lineTo(ft.x+pt.x,ft.y+pt.y)}t.stroke();const F=q=>{if(q===0)return!1;if(e.curveType!=="B")return q>0;const ft=e.points[q-1],L=e.points[q];return ft.x===L.x&&ft.y===L.y};for(let q=0;q<e.points.length;q++){const ft=e.points[q],L=ft.x+pt.x,h=ft.y+pt.y;q===0?t.fillStyle="#efefef":F(q)?t.fillStyle="#ff0000":e.curveType==="B"?t.fillStyle="#efefef":t.fillStyle="#ff0000",t.beginPath(),t.arc(L,h,2,0,Math.PI*2),t.fill()}t.restore()}}else if(e.kind==="spinner"){if(m!=="core")return;const P=Ot/2,g=Bt/2,R=e.time-r,$=800,T=e.endTime;if(w===void 0&&(n<R||n>T+$))return;let v=1;if(n<e.time?v=It((n-R)/Math.max(1,a)):n>=e.time&&(v=1-It((n-T)/$)),w!==void 0&&(v=Math.max(v,w)),v<=.001)return;const W=15;if(o!=null&&o.spinnerBottom){const D=o.spinnerBottom,X=W*2/(D.width||128),dt=D.width*X,Q=D.height*X;t.save(),t.globalAlpha=v,t.translate(P,g),t.drawImage(D,-dt/2,-Q/2,dt,Q),t.restore()}else t.save(),t.globalAlpha=v,t.beginPath(),t.arc(P,g,W,0,Math.PI*2),t.strokeStyle="#f9d66b",t.lineWidth=3,t.stroke(),t.restore();if(o!=null&&o.spinnerApproachcircle){const D=o.spinnerApproachcircle,dt=Bt*.9/2,Q=W,b=50,ut=T-e.time;let tt=0,St=dt;if(n>=R&&n<T+b){if(n<e.time){const jt=Math.min(a,r);tt=Math.min(1,Math.max(0,(n-R)/Math.max(1,jt))),St=dt}else if(n>=e.time){const jt=It((n-e.time)/Math.max(1,ut));tt=(1-It((n-T)/b))*.9,St=dt-(dt-Q)*jt}if(tt>.001){const jt=St*2/(D.width||128),Tt=D.width*jt,pt=D.height*jt;t.save(),t.globalAlpha=tt,t.translate(P,g),t.drawImage(D,-Tt/2,-pt/2,Tt,pt),t.restore()}}}}}function os(t,s,e,n,o,i,r,a){const l=r.followpoint,c=32;for(let d=0;d<e.length-1;d++){const u=e[d].obj,f=e[d+1].obj,M=e[d].idx,m=e[d+1].idx,C=Gt(s,u);if(f.time-C<=0||f.newCombo)continue;const N=Jt(s,u),w=Vt(f),P=kt(N.x,N.y,a[M]||0),g=kt(w.x,w.y,a[m]||0),R=g.x-P.x,$=g.y-P.y,T=Math.hypot(R,$);if(T<80)continue;const v=Math.floor((T-48)/c);if(v<=0)continue;const W=u.kind==="slider"?Gt(s,u):u.time,X=f.time-W;if(X<=0)continue;const dt=Math.atan2($,R),b=Math.max(4,i*.15)*2/(l.width||64),ut=Math.max(1,Math.floor(o*.4));t.save(),t.globalCompositeOperation="source-over",t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high";for(let tt=0;tt<v;tt++){const jt=c*(1.5+tt)/T;if(jt>=1)continue;const Tt=W+jt*X,pt=Tt-o;let Pt=0;if(n<pt)Pt=0;else if(n<pt+ut){const ht=(n-pt)/ut;Pt=_t(It(ht))}else if(n<Tt)Pt=1;else{const ht=(n-Tt)/ut;Pt=1-_t(It(ht))}if(Pt<=0)continue;const A=P.x+R*jt,et=P.y+$*jt;t.save(),t.globalAlpha=.9*Pt,t.translate(A,et),t.rotate(dt),t.drawImage(l,-(l.width*b)/2,-(l.height*b)/2,l.width*b,l.height*b),t.restore()}t.restore()}}function Ee(t,s,e){const r=x.useRef(null),a=x.useRef(null),l=x.useRef(0);x.useEffect(()=>{const c=t.current;if(!c)return;const d=()=>{const M=c.getBoundingClientRect(),m=Math.floor(M.width),C=Math.floor(M.height);r.current&&r.current.width===m&&r.current.height===C||(r.current={width:m,height:C},a.current!==null&&clearTimeout(a.current),a.current=window.setTimeout(()=>{const k=performance.now();k-l.current>=100&&(l.current=k,s())},100))},u=window.ResizeObserver;let f=null;return u?(f=new u(d),f.observe(c)):window.addEventListener("resize",d),d(),()=>{f?f.disconnect():window.removeEventListener("resize",d),a.current!==null&&clearTimeout(a.current)}},[t,s,100,100])}const ve=({beatmap:t,timeSec:s,backgroundUrl:e,skin:n,sliderBodyCutoffPx:o=1,sliderFadeOutMs:i=240,selectedIndices:r=new Set,onSelectionChange:a})=>{const l=x.useRef(null),c=x.useRef(null),[d,u]=zt.useState(0),[f,M]=zt.useState(0),[m,C]=zt.useState(null),[k,N]=zt.useState($t.getStats()),w=x.useRef(0),[P,g]=zt.useState(0),R=x.useRef({lastTime:performance.now(),frameCount:0,fps:0}),[$,T]=zt.useState(!1),v=x.useRef(null),[W,D]=zt.useState(!1),X=x.useMemo(()=>ie(t==null?void 0:t.difficulty),[t]),dt=x.useRef(!1),Q=x.useRef(null),b=x.useRef(null),ut=x.useRef(null),tt=x.useRef(null),St=x.useRef(null),[jt,Tt]=zt.useState(0),[pt,Pt]=zt.useState(!1);x.useEffect(()=>{if(v.current){const L=v.current.parentElement,h=!!(L!=null&&L.classList.contains("playfield-container")&&!L.closest(".embed-preview-playfield")&&!L.closest(".embed-preview-body"));D(h)}},[]);const A=x.useMemo(()=>Ce(X.CS),[X.CS]),et=x.useMemo(()=>je(X.AR),[X.AR]),ht=x.useMemo(()=>ze(X.AR),[X.AR]),it=x.useMemo(()=>{var at;const L=(at=t==null?void 0:t.colors)==null?void 0:at.comboColors;if(L&&L.length)return L;const h=n==null?void 0:n.comboColors;return h&&h.length?h:["#FF66AA","#99CCFF","#99FF99","#FFFF66"]},[t==null?void 0:t.colors,n==null?void 0:n.comboColors]),E=x.useMemo(()=>ge(t),[t]),F=x.useMemo(()=>Ze(t),[t]);x.useEffect(()=>{if(!e){c.current=null;return}const L=new Image;return L.onload=()=>{c.current=L,u(h=>h+1)},L.onerror=()=>{c.current=null,u(h=>h+1)},L.src=e,c.current=L,()=>{L.onload=null,L.onerror=null}},[e]);const q=x.useCallback(()=>{M(L=>L+1)},[]);Ee(l,q),x.useEffect(()=>{const L=l.current;if(!L)return;$t.evictExpiredShapes(s*1e3);const h=window.devicePixelRatio||1,at=L.getBoundingClientRect(),st=Math.max(100,at.width),J=Math.max(100,at.height);L.width=Math.round(st*h),L.height=Math.round(J*h);const S=L.getContext("2d",{willReadFrequently:!1});S.setTransform(h,0,0,h,0,0),S.globalCompositeOperation="source-over",S.clearRect(0,0,st,J),S.fillStyle="#02060d",S.fillRect(0,0,st,J);const yt=c.current;if(yt&&yt.complete){const O=Math.max(st/yt.width,J/yt.height),lt=yt.width*O,G=yt.height*O;S.globalAlpha=.2,S.drawImage(yt,(st-lt)/2,(J-G)/2,lt,G),S.globalAlpha=1}const _=16,z=Math.min((st-_*2)/Ot,(J-_*2)/Bt),H=(st-Ot*z)/2,rt=(J-Bt*z)/2;if(S.save(),S.translate(H,rt),S.scale(z,z),S.strokeStyle="#2a3955",S.lineWidth=2/z,S.strokeRect(0,0,Ot,Bt),t){const O=s*1e3,lt=1200,G=2e3,mt=t.hitObjects,bt=O-lt,xt=O+G,wt=bt-1e4;let vt=0,y=mt.length;for(;vt<y;){const j=vt+y>>>1;mt[j].time<wt?vt=j+1:y=j}const B=vt;for(vt=0,y=mt.length;vt<y;){const j=vt+y>>>1;mt[j].time<=xt?vt=j+1:y=j}const nt=vt,Z=[],K=new Set;for(let j=B;j<nt;j++){const I=mt[j],V=I.time;let U=V+600,ot;if(I.kind==="spinner")U=I.endTime;else if(I.kind==="slider"){const{base:ct,inherited:Mt}=Ut(t,I.time),Ct=(ct==null?void 0:ct.beatLength)??500,Lt=Mt==null?void 0:Mt.beatLength,Et=Kt(I,Ct,X.SliderMultiplier,Lt);U=I.time+Et*Math.max(1,I.slides),ot={base:ct,inherited:Mt,baseBeat:Ct,ih:Lt,span:Et}}U>=bt&&V<=xt&&(Z.push({o:I,idx:j,startTime:V,endTime:U,timing:ot}),K.add(j))}for(const j of r){if(K.has(j))continue;const I=mt[j];if(!I)continue;const V=I.time;let U=V+600,ot;if(I.kind==="spinner")U=I.endTime;else if(I.kind==="slider"){const{base:ct,inherited:Mt}=Ut(t,I.time),Ct=(ct==null?void 0:ct.beatLength)??500,Lt=Mt==null?void 0:Mt.beatLength,Et=Kt(I,Ct,X.SliderMultiplier,Lt);U=I.time+Et*Math.max(1,I.slides),ot={base:ct,inherited:Mt,baseBeat:Ct,ih:Lt,span:Et}}Z.push({o:I,idx:j,startTime:V,endTime:U,timing:ot,isSelected:!0})}Z.sort((j,I)=>j.startTime!==I.startTime?j.startTime-I.startTime:j.idx-I.idx);const Y=Z.map(j=>({obj:j.o,idx:j.idx}));n!=null&&n.followpoint&&os(S,t,Y,O,et,A,n,F);for(let j=Z.length-1;j>=0;j--){const{o:I,idx:V,timing:U,isSelected:ot}=Z[j],ct=it[E.colorIndex[V]%it.length],Mt=E.number[V],Ct=F[V],Et=ot===!0?.3:void 0;I.kind==="slider"&&he(S,t,I,O,n,A,et,ht,X.SliderMultiplier,X.SliderTickRate,ct,Mt,Ct,m,"body",o,i,U,Et),he(S,t,I,O,n,A,et,ht,X.SliderMultiplier,X.SliderTickRate,ct,Mt,Ct,m,"core",o,i,U,Et),I.kind==="slider"&&he(S,t,I,O,n,A,et,ht,X.SliderMultiplier,X.SliderTickRate,ct,0,Ct,m,"top",o,i,U,Et)}for(const j of r){const I=mt[j];if(I){if(S.save(),S.strokeStyle="#f59e0b",S.lineWidth=2/z,S.globalAlpha=.8,I.kind==="circle"){const V=typeof I.stackedX=="number"&&typeof I.stackedY=="number"?{x:I.stackedX,y:I.stackedY}:kt(I.x,I.y,F[j]);S.beginPath(),S.arc(V.x,V.y,A+3,0,Math.PI*2),S.stroke()}else if(I.kind==="slider"){const V=Vt(I),U=Jt(t,I),ot=kt(V.x,V.y,F[j]),ct=kt(U.x,U.y,F[j]);S.beginPath(),S.arc(ot.x,ot.y,A+3,0,Math.PI*2),S.stroke(),S.beginPath(),S.arc(ct.x,ct.y,A+3,0,Math.PI*2),S.stroke()}S.restore()}}}if(S.restore(),pt&&Q.current&&b.current){const lt=Math.min((st-32)/Ot,(J-32)/Bt),G=(st-Ot*lt)/2,mt=(J-Bt*lt)/2,bt=G+Math.min(Q.current.x,b.current.x)*lt,xt=mt+Math.min(Q.current.y,b.current.y)*lt,wt=G+Math.max(Q.current.x,b.current.x)*lt,vt=mt+Math.max(Q.current.y,b.current.y)*lt;S.save(),S.strokeStyle="#f59e0b",S.fillStyle="rgba(245, 158, 11, 0.1)",S.lineWidth=2,S.globalAlpha=.5,S.fillRect(bt,xt,wt-bt,vt-xt),S.strokeRect(bt,xt,wt-bt,vt-xt),S.restore()}if(w.current++,w.current%10===0){const O=$t.getStats();N(O),$t.resetFrameStats()}const gt=performance.now();R.current.frameCount++,gt-R.current.lastTime>=1e3&&(R.current.fps=R.current.frameCount,R.current.frameCount=0,R.current.lastTime=gt,g(R.current.fps))},[t,s,e,d,A,et,ht,n,X.SliderMultiplier,X.SliderTickRate,o,i,f,m,r,F,jt,pt]);const ft=x.useCallback((L,h)=>{const at=l.current;if(!at)return null;const st=at.getBoundingClientRect(),J=16,S=Math.min((st.width-J*2)/Ot,(st.height-J*2)/Bt),yt=(st.width-Ot*S)/2,_=(st.height-Bt*S)/2,z=(L-st.left-yt)/S,H=(h-st.top-_)/S;return z>=0&&z<=Ot&&H>=0&&H<=Bt?{x:z,y:H}:null},[]);return x.useEffect(()=>{const L=l.current;if(!L||!t||!a)return;const h=S=>{const yt=ft(S.clientX,S.clientY);if(C(yt||null),dt.current&&ut.current){ut.current[1]={x:S.clientX,y:S.clientY};const _=ft(ut.current[0].x,ut.current[0].y),z=ft(ut.current[1].x,ut.current[1].y);if(_&&z){Q.current=_,b.current=z,Tt(gt=>gt+1);const H={minX:Math.min(_.x,z.x),minY:Math.min(_.y,z.y),maxX:Math.max(_.x,z.x),maxY:Math.max(_.y,z.y)};if(Math.hypot(z.x-_.x,z.y-_.y)>0){const gt=we(t,H,s*1e3,A,F);new Set(gt);const O=(S.ctrlKey||S.metaKey)&&tt.current?new Set(tt.current):new Set;for(const lt of gt)O.add(lt);a(O)}}else Tt(H=>H+1)}},at=S=>{if(S.button!==0)return;const yt=ft(S.clientX,S.clientY);if(!yt)return;ut.current=[{x:S.clientX,y:S.clientY},{x:S.clientX,y:S.clientY}];const _=s*1e3,z=[],H=et+2e3,rt=_-H,gt=_+H;let O=0,lt=t.hitObjects.length;for(;O<lt;){const wt=O+lt>>>1;t.hitObjects[wt].time<rt?O=wt+1:lt=wt}const G=O;for(O=0,lt=t.hitObjects.length;O<lt;){const wt=O+lt>>>1;t.hitObjects[wt].time<=gt?O=wt+1:lt=wt}const mt=O;for(let wt=G;wt<mt;wt++){const vt=t.hitObjects[wt],y=F[wt];if(vt.kind==="circle"){const B=kt(vt.x,vt.y,y);me(yt.x,yt.y,B.x,B.y,A,_,vt.time,et)&&z.push(wt)}else vt.kind==="slider"&&ts(yt.x,yt.y,vt,_,t,A,y,et)&&z.push(wt)}z.sort((wt,vt)=>t.hitObjects[wt].time-t.hitObjects[vt].time);const bt=z[0],xt=new Set(r);if(!S.ctrlKey&&!S.metaKey&&xt.clear(),bt!==void 0){if(dt.current=!1,Pt(!1),Q.current=null,b.current=null,ut.current=null,tt.current=null,S.shiftKey&&St.current!==null){const wt=Math.min(St.current,bt),vt=Math.max(St.current,bt);for(let y=wt;y<=vt;y++)xt.add(y)}else xt.add(bt);St.current=bt,a(xt)}else dt.current=!0,Pt(!0),Q.current=yt,b.current=yt,tt.current=new Set(r),Tt(wt=>wt+1),!S.ctrlKey&&!S.metaKey&&(a(new Set),tt.current=new Set)},st=S=>{if(dt.current&&Q.current&&b.current){const yt={minX:Math.min(Q.current.x,b.current.x),minY:Math.min(Q.current.y,b.current.y),maxX:Math.max(Q.current.x,b.current.x),maxY:Math.max(Q.current.y,b.current.y)};if(Math.hypot(b.current.x-Q.current.x,b.current.y-Q.current.y)>0){const z=we(t,yt,s*1e3,A,F),H=S.ctrlKey||S.metaKey?new Set(r):new Set;for(const rt of z)H.add(rt);a(H)}dt.current=!1,Pt(!1),Q.current=null,b.current=null,ut.current=null,tt.current=null,Tt(z=>z+1)}},J=()=>{C(null)};return L.addEventListener("mousemove",h),L.addEventListener("mousedown",at),L.addEventListener("mouseup",st),L.addEventListener("mouseleave",J),()=>{L.removeEventListener("mousemove",h),L.removeEventListener("mousedown",at),L.removeEventListener("mouseup",st),L.removeEventListener("mouseleave",J);const S=L.getContext("2d");S&&S.clearRect(0,0,L.width,L.height)}},[t,s,A,F,r,a,ft,et]),p.jsxs("div",{ref:v,style:{position:"relative",width:"100%",height:"100%"},children:[p.jsx("canvas",{ref:l,className:"playfield",style:{width:"100%",height:"100%",display:"block"}}),W&&p.jsxs("div",{style:{position:"absolute",top:"8px",right:"8px",background:"#0d111e",color:"#cdd6f4",borderRadius:"4px",fontFamily:"monospace",fontSize:$?"11px":"12px",lineHeight:"1.4",minWidth:$?"220px":"auto",zIndex:1e3,border:"1px solid rgba(255, 255, 255, 0.1)",overflow:"hidden"},children:[p.jsxs("div",{style:{padding:$?"8px 12px":"4px 8px",cursor:"pointer",userSelect:"none",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:$?"1px solid rgba(255,255,255,0.1)":"none",gap:"8px"},onClick:()=>T(!$),children:[$?p.jsx("span",{style:{fontWeight:600,color:"#cdd6f4",textTransform:"lowercase"},children:"performance"}):p.jsxs("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 6px",borderRadius:"4px"},children:[P," fps"]}),p.jsx("span",{style:{color:"#89b4fa",fontSize:"10px"},children:$?"▼":"▶"})]}),$&&p.jsxs("div",{style:{padding:"12px"},children:[p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"fps:"}),p.jsx("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:P})]}),p.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"slider cache (cumulative)"}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"total draw calls:"}),p.jsx("span",{style:{color:"#89b4fa"},children:k.totalDrawCalls.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache hits:"}),p.jsx("span",{style:{color:"#89b4fa"},children:k.hits.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache misses:"}),p.jsx("span",{style:{color:"#89b4fa"},children:k.misses.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hit rate:"}),p.jsxs("span",{style:{color:"#89b4fa",background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:[k.hitRate.toFixed(1),"%"]})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"unique shapes:"}),p.jsxs("span",{style:{color:"#89b4fa"},children:[k.uniqueShapesInMap||k.totalRenders," (cached: ",k.cacheSize,")"]})]}),p.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"per frame (last 10)"}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"draw calls/frame:"}),p.jsx("span",{style:{color:"#89b4fa"},children:(k.lastFrameHits+k.lastFrameMisses).toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hits/frame:"}),p.jsx("span",{style:{color:"#89b4fa"},children:k.lastFrameHits.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"misses/frame:"}),p.jsx("span",{style:{color:"#89b4fa"},children:k.lastFrameMisses.toLocaleString()})]})]})]})]})},be=({isPlaying:t,onPlayPause:s,currentTime:e,duration:n,onSeek:o,onScrubStart:i,onScrubEnd:r,bpm:a,sliderVelocity:l,timingPoints:c})=>{const d=x.useRef(null),u=x.useRef(null),f=x.useRef(null),[M,m]=x.useState(!1),C=x.useRef(null),k=x.useRef(!1),N=T=>{const v=Math.max(0,Math.floor(T*1e3)),W=Math.floor(v/6e4)%100,D=Math.floor(v%6e4/1e3)%60,X=Math.floor(v%1e3);return`${String(W).padStart(2,"0")}:${String(D).padStart(2,"0")}.${String(X).padStart(3,"0")}`},w=x.useCallback(T=>{if(!d.current)return 0;const v=d.current.getBoundingClientRect(),W=T-v.left;return Math.max(0,Math.min(1,W/v.width))*n},[n]),P=T=>{m(!0),i==null||i();const v=w(T.clientX);o(v)},g=T=>{if(T.preventDefault(),T.touches.length===0)return;m(!0),i==null||i();const v=w(T.touches[0].clientX);o(v)},R=T=>{if(T.preventDefault(),!Number.isFinite(n)||n<=0)return;k.current||(k.current=!0,i==null||i()),C.current!==null&&clearTimeout(C.current);const v=T.shiftKey?1:.1,W=T.deltaY>0?1:-1,D=Math.max(0,Math.min(n,e+W*v));o(D),C.current=window.setTimeout(()=>{k.current=!1,r==null||r(),C.current=null},150)};x.useEffect(()=>()=>{C.current!==null&&clearTimeout(C.current)},[]),x.useEffect(()=>{if(!M)return;const T=X=>{const dt=w(X.clientX);o(dt)},v=X=>{if(X.preventDefault(),X.touches.length===0)return;const dt=w(X.touches[0].clientX);o(dt)},W=()=>{m(!1),r==null||r()},D=X=>{if(f.current&&X.changedTouches.length>0){const dt=X.changedTouches[0],Q=document.elementFromPoint(dt.clientX,dt.clientY);Q&&f.current.contains(Q)&&X.preventDefault()}m(!1),r==null||r()};return window.addEventListener("mousemove",T),window.addEventListener("mouseup",W),window.addEventListener("touchmove",v,{passive:!1}),window.addEventListener("touchend",D),window.addEventListener("touchcancel",D),()=>{window.removeEventListener("mousemove",T),window.removeEventListener("mouseup",W),window.removeEventListener("touchmove",v),window.removeEventListener("touchend",D),window.removeEventListener("touchcancel",D)}},[M,n,o,r,w]);const $=n>0?Math.max(0,Math.min(1,e/n)):0;return x.useEffect(()=>{const T=d.current,v=u.current;if(!T||!v)return;const W=T.getBoundingClientRect(),D=Math.max(1,Math.floor(W.width)),X=Math.max(1,Math.floor(W.height)),dt=window.devicePixelRatio||1;(v.width!==Math.round(D*dt)||v.height!==Math.round(X*dt))&&(v.width=Math.round(D*dt),v.height=Math.round(X*dt));const Q=v.getContext("2d");Q.setTransform(dt,0,0,dt,0,0),Q.clearRect(0,0,D,X);const b=Array.isArray(c)?c:[];for(let tt=0;tt<b.length;tt++){const St=b[tt],jt=b[tt+1];if(typeof St.effects=="number"&&(St.effects&1)===1){const pt=Math.max(0,St.time/1e3),Pt=Math.min(n,(jt?jt.time:n*1e3)/1e3);if(Pt>pt){const A=Math.floor(pt/n*D),et=Math.ceil(Pt/n*D);Q.fillStyle="rgba(245, 158, 11, 0.4)";const ht=Math.max(1,Math.round(X/1.6)),it=Math.round((X-ht)/2);Q.fillRect(A,it,Math.max(1,et-A),ht)}}}const ut=(tt,St,jt)=>{const Tt=Math.max(0,tt.time/1e3),pt=Math.floor(Tt/(n||1)*D),Pt=Math.max(1,Math.round(jt)),A=Pt/2,et=X-Pt/2;Q.save(),Q.strokeStyle=St,Q.lineWidth=Pt,Q.lineCap="round",Q.beginPath(),Q.moveTo(pt+.5,A),Q.lineTo(pt+.5,et),Q.stroke(),Q.restore()};for(const tt of b)(typeof tt.uninherited=="number"?tt.uninherited===1:(tt.beatLength||0)>0)||ut(tt,"#22c55e",2);for(const tt of b)(typeof tt.uninherited=="number"?tt.uninherited===1:(tt.beatLength||0)>0)&&ut(tt,"#ef4444",3)},[c,n]),p.jsxs("div",{className:"editor-controls-container",ref:f,children:[p.jsxs("div",{className:"controls-timestamp",children:[p.jsx("div",{className:"timestamp-display",children:N(e)}),p.jsxs("div",{className:"timing-info",children:[p.jsxs("span",{className:"bpm-display",children:[a.toFixed(0),"BPM"]}),p.jsx("span",{className:"sv-display",children:n>0?`${Math.round(e/n*100)}%`:"0%"})]})]}),p.jsxs("div",{className:"controls-center",children:[p.jsx("button",{className:"controls-play-button",onClick:s,title:t?"Pause (Space)":"Play (Space)",children:t?p.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:[p.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),p.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]}):p.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:p.jsx("path",{d:"M8 5v14l11-7z"})})}),p.jsx("div",{className:"controls-progress-wrapper",ref:d,onMouseDown:P,onTouchStart:g,onWheel:R,children:p.jsxs("div",{className:"progress-bar-track",children:[p.jsx("canvas",{ref:u,className:"progress-markers"}),p.jsx("div",{className:"progress-bar-fill",style:{width:`${$*100}%`}}),p.jsx("div",{className:"progress-bar-thumb",style:{left:`${$*100}%`}})]})})]})]})},Me=({masterVolume:t,songVolume:s,hitsoundVolume:e,onMasterVolumeChange:n,onSongVolumeChange:o,onHitsoundVolumeChange:i})=>{const[r,a]=x.useState(!1),l=x.useRef(null),c=x.useRef(null);x.useEffect(()=>{if(!r)return;const u=f=>{l.current&&!l.current.contains(f.target)&&c.current&&!c.current.contains(f.target)&&a(!1)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[r]);const d=u=>`${Math.round(u*100)}%`;return p.jsxs("div",{className:"volume-control-wrapper",children:[p.jsx("button",{ref:c,className:"volume-control-button",onClick:u=>{u.stopPropagation(),a(!r)},"aria-label":"Volume controls","aria-expanded":r,children:t>0?p.jsx(Oe,{size:20}):p.jsx(ke,{size:20})}),r&&p.jsxs("div",{ref:l,className:"volume-control-menu",children:[p.jsxs("div",{className:"volume-control-item",children:[p.jsx("label",{className:"volume-label",children:"Master"}),p.jsxs("div",{className:"volume-slider-container",children:[p.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:t,onChange:u=>n(parseFloat(u.target.value)),className:"volume-slider"}),p.jsx("span",{className:"volume-value",children:d(t)})]})]}),p.jsxs("div",{className:"volume-control-item",children:[p.jsx("label",{className:"volume-label",children:"Song"}),p.jsxs("div",{className:"volume-slider-container",children:[p.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:s,onChange:u=>o(parseFloat(u.target.value)),className:"volume-slider"}),p.jsx("span",{className:"volume-value",children:d(s)})]})]}),p.jsxs("div",{className:"volume-control-item",children:[p.jsx("label",{className:"volume-label",children:"Hitsounds"}),p.jsxs("div",{className:"volume-slider-container",children:[p.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,onChange:u=>i(parseFloat(u.target.value)),className:"volume-slider"}),p.jsx("span",{className:"volume-value",children:d(e)})]})]})]})]})};async function Se(t){const s=await $e.loadAsync(t instanceof File?t:new Blob([t])),e=Object.keys(s.files);async function n(r){const a=s.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("text")}async function o(r){const a=s.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("arraybuffer")}function i(r){return e.find(r)}return{list:e,readText:n,readArrayBuffer:o,findFirst:i}}function se(t){const s=t.indexOf(":");if(s===-1)return null;const e=t.slice(0,s).trim(),n=t.slice(s+1).trim();return[e,n]}function de(t){const s=t.split(/\r?\n/);let e="";const n={},o={},i={},r=[],a=[],l={comboColors:[]};let c="osu file format v?";for(let N=0;N<s.length;N++){const P=s[N].trim();if(P){if(N===0&&/^osu file format/.test(P)){c=P;continue}if(P.startsWith("[")&&P.endsWith("]")){e=P.slice(1,-1);continue}if(!P.startsWith("//"))switch(e){case"General":{const g=se(P);g&&(n[g[0]]=g[1]);break}case"Metadata":{const g=se(P);g&&(o[g[0]]=g[1]);break}case"Difficulty":{const g=se(P);if(!g)break;const R=Number(g[1]);i[g[0]]=Number.isFinite(R)?R:g[1];break}case"TimingPoints":{const g=P.split(",").map($=>$.trim()),R={time:Number(g[0]||0),beatLength:Number(g[1]||0),meter:Number(g[2]||4),sampleSet:g[3]?Number(g[3]):void 0,sampleIndex:g[4]?Number(g[4]):void 0,volume:g[5]?Number(g[5]):void 0,uninherited:g[6]?Number(g[6]):void 0,effects:g[7]?Number(g[7]):void 0};r.push(R);break}case"Colours":{const g=se(P);if(!g)break;const[R,$]=g,T=v=>{const W=v.split(",").map(b=>b.trim());if(W.length<3)return null;const D=Math.max(0,Math.min(255,Number(W[0]||0))),X=Math.max(0,Math.min(255,Number(W[1]||0))),dt=Math.max(0,Math.min(255,Number(W[2]||0))),Q=b=>b.toString(16).padStart(2,"0");return`#${Q(D)}${Q(X)}${Q(dt)}`};if(/^Combo\d+$/i.test(R)){const v=T($);v&&l.comboColors.push(v)}else if(/^SliderBorder$/i.test(R)){const v=T($);v&&(l.sliderBorder=v)}else if(/^SliderTrackOverride$/i.test(R)){const v=T($);v&&(l.sliderTrackOverride=v)}break}case"HitObjects":{const g=P.split(","),R=Number(g[0]),$=Number(g[1]),T=Number(g[2]),v=Number(g[3]),W=Number(g[4]||0),D=Q=>{if(!Q||!Q.includes(":"))return;const b=Q.split(":"),ut=b[0]!==""?Number(b[0]):void 0,tt=b[1]!==""?Number(b[1]):void 0,St=b[2]!==""?Number(b[2]):void 0,jt=b[3]!==""?Number(b[3]):void 0,Tt=b[4]&&b[4]!==""?b[4]:void 0;return{sampleSet:ut,additionSet:tt,customIndex:St,sampleVolume:jt,filename:Tt}},X=(v&4)===4,dt=(v&112)>>4;if((v&1)===1){const Q=D(g[5]);a.push({kind:"circle",x:R,y:$,time:T,hitSound:W,hitSample:Q,newCombo:X,comboSkip:dt})}else if((v&2)===2){const Q=String(g[5]||""),[b,...ut]=Q.split("|"),tt=(b||"B").slice(0,1).toUpperCase(),St=Number(g[6]||1),jt=Number(g[7]||0),Tt=[{x:R,y:$}];for(const ht of ut){const[it,E]=ht.split(":");it&&E&&Tt.push({x:Number(it),y:Number(E)})}let pt;g[8]&&(pt=String(g[8]).split("|").map(ht=>Number(ht||0)));let Pt;g[9]&&(Pt=String(g[9]).split("|").map(ht=>{const[it,E]=ht.split(":"),F=it&&it!==""?Number(it):void 0,q=E&&E!==""?Number(E):void 0;return{sampleSet:F,additionSet:q}}));const A=g[g.length-1],et=D(A);a.push({kind:"slider",x:R,y:$,time:T,hitSound:W,curveType:tt,points:Tt,slides:St,length:jt,edgeSounds:pt,edgeSets:Pt,hitSample:et,newCombo:X,comboSkip:dt})}else if((v&8)===8){const Q=Number(g[5]||T),b=D(g[6]);a.push({kind:"spinner",time:T,endTime:Q,hitSample:b,newCombo:X,comboSkip:dt})}break}}}}const d=Number(n.Mode||"0"),f=["standard","taiko","catch","mania"][Math.max(0,Math.min(3,d))],M=n.AudioFilename;let m;const C=s.findIndex(N=>N.trim()==="[Events]");if(C!==-1)for(let N=C+1;N<s.length;N++){const w=s[N].trim();if(!w||w.startsWith("["))break;const P=w.match(/\"([^\"]+)\"/);if(P){m=P[1];break}}const k={comboColors:l.comboColors.length?l.comboColors:void 0,sliderBorder:l.sliderBorder,sliderTrackOverride:l.sliderTrackOverride};return{format:c,mode:f,general:n,metadata:o,difficulty:i,timingPoints:r,hitObjects:a,audioFilename:M,backgroundFilename:m,colors:k}}async function rs(t,s){var e,n,o,i;try{const r="https://esm.sh/osu-parsers@4.1.7?bundle",a="https://esm.sh/osu-standard-stable@5.0.1?bundle";let l,c;try{l=await import(r),c=await import(a)}catch{const w="osu-parsers",P="osu-standard-stable";l=await import(w),c=await import(P)}const d=new l.BeatmapDecoder,u=new c.StandardRuleset,f=u.applyToBeatmapWithMods(d.decodeFromString(t),u.createModCombination("")),M=c.Circle,m=c.Slider,C=c.Spinner,k=f.hitObjects.filter(w=>w instanceof M||w instanceof m||w instanceof C),N=Math.min(k.length,s.hitObjects.length);for(let w=0;w<N;w++){const P=k[w],g=s.hitObjects[w];if(P instanceof C)continue;const R=(P.startX??((e=P.startPosition)==null?void 0:e.x)??P.x??0)+(((n=P.stackedOffset)==null?void 0:n.x)??0),$=(P.startY??((o=P.startPosition)==null?void 0:o.y)??P.y??0)+(((i=P.stackedOffset)==null?void 0:i.y)??0);g.stackedX=R,g.stackedY=$}return s}catch{return s}}class is{constructor(){Rt(this,"ctx",null);Rt(this,"buffer",null);Rt(this,"src",null);Rt(this,"gainNode",null);Rt(this,"startCtxTime",0);Rt(this,"startOffset",0);Rt(this,"_onTick");Rt(this,"raf",0);Rt(this,"_volume",1);Rt(this,"tick",()=>{this._onTick&&this._onTick(this.currentTime),this.raf=requestAnimationFrame(this.tick)})}get duration(){var s;return((s=this.buffer)==null?void 0:s.duration)??0}get volume(){return this._volume}set volume(s){this._volume=Math.max(0,Math.min(1,s)),this.gainNode&&(this.gainNode.gain.value=this._volume)}async load(s){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext));const e=await this.ctx.decodeAudioData(s.slice(0));this.buffer=e,this.stop()}ensureSrc(){!this.ctx||!this.buffer||(this.gainNode||(this.gainNode=this.ctx.createGain(),this.gainNode.gain.value=this._volume,this.gainNode.connect(this.ctx.destination)),this.src=this.ctx.createBufferSource(),this.src.buffer=this.buffer,this.src.connect(this.gainNode),this.src.onended=()=>{cancelAnimationFrame(this.raf),this.raf=0})}play(s){!this.ctx||!this.buffer||(this.stop(),this.ensureSrc(),this.src&&(this.startOffset=typeof s=="number"?s:this.currentTime,this.startCtxTime=this.ctx.currentTime,this.src.start(0,this.startOffset),this.tick()))}pause(){if(!this.ctx)return;const s=this.currentTime;this.stop(),this.startOffset=s}seek(s){if(!this.ctx)return;const e=!!this.src;this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,s)),e&&this.play(this.startOffset)}setPosition(s){this.ctx&&(this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,s)))}stop(){if(this.src){try{this.src.stop()}catch{}try{this.src.disconnect()}catch{}}this.src=null,this.raf&&cancelAnimationFrame(this.raf),this.raf=0}get isPlaying(){return!!this.src}get currentTime(){if(!this.ctx)return 0;if(!this.src)return Math.min(this.duration,this.startOffset);const s=this.ctx.currentTime-this.startCtxTime;return Math.max(0,Math.min(this.duration,this.startOffset+s))}onTick(s){this._onTick=s}getBuffer(){return this.buffer}getContext(){return this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx}}const ne={1:"normal",2:"soft",3:"drum"};function as(t){const s=["hitnormal"];return t&2&&s.push("hitwhistle"),t&4&&s.push("hitfinish"),t&8&&s.push("hitclap"),s}class oe{constructor(s){Rt(this,"ctx");Rt(this,"buffers",new Map);Rt(this,"loading",null);Rt(this,"slideSrc",null);Rt(this,"slideGain",null);Rt(this,"whistleSrc",null);Rt(this,"whistleGain",null);Rt(this,"active",new Set);Rt(this,"masterGain",null);Rt(this,"_volume",1);this.ctx=s,this.masterGain=s.createGain(),this.masterGain.gain.value=this._volume,this.masterGain.connect(s.destination)}get volume(){return this._volume}set volume(s){this._volume=Math.max(0,Math.min(1,s)),this.masterGain&&(this.masterGain.gain.value=this._volume)}async load(s){if(s||(s="/img/"),s.endsWith("/")||(s+="/"),this.loading)return this.loading;const e=[];for(const n of["normal","soft","drum"])for(const o of["hitnormal","hitwhistle","hitfinish","hitclap","slidertick","sliderslide","sliderwhistle"])e.push(`${n}-${o}.wav`);return this.loading=(async()=>{await Promise.all(e.map(async n=>{try{const o=await fetch(s+n);if(!o.ok)return;const i=await o.arrayBuffer(),r=await this.ctx.decodeAudioData(i.slice(0));this.buffers.set(n,r)}catch{}}))})(),this.loading}playFile(s,e=0,n=.8){const o=this.buffers.get(s);if(!o)return;try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const i=this.ctx.createBufferSource(),r=this.ctx.createGain();r.gain.value=n,i.buffer=o,i.connect(r),this.masterGain?r.connect(this.masterGain):r.connect(this.ctx.destination);const a=Math.max(this.ctx.currentTime,e);i.onended=()=>{try{i.disconnect()}catch{}try{r.disconnect()}catch{}this.active.delete(i)};try{i.start(a)}catch{}this.active.add(i)}playWithFallback(s,e,n=0,o=.8){const i=[e,"normal","soft","drum"],r=new Set;for(const l of i){const c=`${l}-${s}.wav`;if(r.has(c))continue;if(r.add(c),this.buffers.get(c))return this.playFile(c,n,o),!0}const a=`${s}.wav`;return this.buffers.get(a)?(this.playFile(a,n,o),!0):!1}playHit(s,e,n){const o=as(e);for(const i of o)this.playFile(`${s}-${i}.wav`,n)}playTick(s,e){this.playFile(`${s}-slidertick.wav`,e,.7)}playReverse(s,e){this.playFile(`${s}-sliderwhistle.wav`,e,.8)}startLoop(s,e,n,o=.3){const i=[e,"normal","soft","drum"];let r;for(const c of i){const d=`${c}-${s}.wav`,u=this.buffers.get(d);if(u){r=u;break}}if(!r){const c=`${s}.wav`,d=this.buffers.get(c);if(d)r=d;else return}if(s==="sliderslide")this.stopSlide();else{if(this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const a=this.ctx.createBufferSource();a.buffer=r,a.loop=!0;const l=this.ctx.createGain();l.gain.value=typeof o=="number"?Math.max(0,Math.min(1,o)):.3,a.connect(l),this.masterGain?l.connect(this.masterGain):l.connect(this.ctx.destination);try{a.start(Math.max(this.ctx.currentTime,n||0))}catch{}s==="sliderslide"?(this.slideSrc=a,this.slideGain=l):(this.whistleSrc=a,this.whistleGain=l)}startSlide(s,e,n){this.startLoop("sliderslide",s,e,(typeof n=="number"?Math.max(0,Math.min(1,n)):1)*.3)}stopSlide(){if(this.slideSrc){try{this.slideSrc.stop()}catch{}try{this.slideSrc.disconnect()}catch{}this.slideSrc=null}if(this.slideGain){try{this.slideGain.disconnect()}catch{}this.slideGain=null}}startSliderLoops(s,e,n,o){this.startLoop("sliderslide",s,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.3),e&&this.startLoop("sliderwhistle",s,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.25)}stopSliderLoops(){if(this.stopSlide(),this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}stopAll(){this.stopSlide();for(const s of Array.from(this.active)){try{s.stop()}catch{}try{s.disconnect()}catch{}this.active.delete(s)}}}function cs(t,s){var r,a,l;const e=[],n=c=>{let d="normal";for(let u=0;u<t.timingPoints.length;u++){const f=t.timingPoints[u];if(f.time<=c&&f.sampleSet&&(d=ne[f.sampleSet]||d),f.time>c)break}return d},o=(c,d,u,f)=>{const M=f&&f<0?100/-f:1,m=100*u*M;return c.length/Math.max(1e-6,m)*d},i=(c,d,u,f,M)=>{const m=f&&f<0?100/-f:1,C=100*u*m,k=c.length/Math.max(1e-6,C),N=1/Math.max(1e-6,M),w=[];for(let P=N;P<k-.001;P+=N){const g=P/k;g>0&&g<1&&w.push(g)}return w};for(const c of t.hitObjects)if(c.kind==="circle"){const d=n(c.time);e.push({timeMs:c.time,kind:"hit",set:d,bits:c.hitSound})}else if(c.kind==="slider"){const{base:d,inherited:u}=Ut(t,c.time),f=(d==null?void 0:d.beatLength)??500,M=u==null?void 0:u.beatLength,m=o(c,f,s.SliderMultiplier,M),C=Math.max(1,c.slides),k=c.edgeSets&&((r=c.edgeSets[0])==null?void 0:r.sampleSet)&&ne[c.edgeSets[0].sampleSet]||n(c.time),N=c.edgeSounds&&typeof c.edgeSounds[0]=="number"?c.edgeSounds[0]:c.hitSound;e.push({timeMs:c.time,kind:"hit",set:k,bits:N});const w=i(c,f,s.SliderMultiplier,M,s.SliderTickRate);for(let T=0;T<C;T++){const v=c.time+T*m;for(const W of w)e.push({timeMs:v+W*m,kind:"tick",set:k})}for(let T=1;T<C;T++){const v=c.time+T*m,W=c.edgeSets&&((a=c.edgeSets[T])==null?void 0:a.sampleSet)&&ne[c.edgeSets[T].sampleSet]||n(v),D=c.edgeSounds&&typeof c.edgeSounds[T]=="number"?c.edgeSounds[T]:c.hitSound;e.push({timeMs:v,kind:"reverse",set:W,bits:D})}const P=c.time+m*C,g=C,R=c.edgeSets&&((l=c.edgeSets[g])==null?void 0:l.sampleSet)&&ne[c.edgeSets[g].sampleSet]||n(P),$=c.edgeSounds&&typeof c.edgeSounds[g]=="number"?c.edgeSounds[g]:c.hitSound;e.push({timeMs:P,kind:"hit",set:R,bits:$})}else if(c.kind==="spinner"){const d=n(c.endTime);e.push({timeMs:c.endTime,kind:"hit",set:d,bits:0})}return e.sort((c,d)=>c.timeMs-d.timeMs),e}function ls(t){const s={};let e="root";s[e]={};const n=t.split(/\r?\n/);for(let o of n){let i=o.trim();if(!i||i.startsWith(";")||i.startsWith("//"))continue;if(i.startsWith("[")&&i.endsWith("]")){e=i.slice(1,-1).trim(),s[e]||(s[e]={});continue}const r=i.indexOf("=");if(r===-1)continue;const a=i.slice(0,r).trim(),l=i.slice(r+1).trim();s[e][a]=l}return s}function hs(t){const s=t.Colours||t.Colors||{},e=Object.keys(s).filter(o=>/^combo\d+/i.test(o)).sort((o,i)=>{const r=Number(o.replace(/[^\d]/g,"")),a=Number(i.replace(/[^\d]/g,""));return r-a}),n=[];for(const o of e){const r=s[o].split(",").map(a=>Number(a.trim())).filter(a=>Number.isFinite(a));r.length>=3&&n.push(Le(r[0],r[1],r[2]))}return n}function ds(t){const s=t.Colours||t.Colors||{},e=s.SliderBorder||s.sliderborder;if(!e)return null;const n=e.split(",").map(o=>Number(o.trim())).filter(o=>Number.isFinite(o));return n.length>=3?Le(n[0],n[1],n[2]):null}function Le(t,s,e){const n=i=>Math.max(0,Math.min(255,Math.round(i))),o=i=>n(i).toString(16).padStart(2,"0");return`#${o(t)}${o(s)}${o(e)}`}async function us(t){t||(t="/img/"),t.endsWith("/")||(t+="/");const s={},e=async(a,l)=>{try{const c=await ue(t+l);s[a]=c}catch{}};await Promise.all([e("hitcircle","hitcircle.png"),e("hitcircleoverlay","hitcircleoverlay.png"),e("approachcircle","approachcircle.png"),e("sliderfollowcircle","sliderfollowcircle.png"),e("followpoint","followpoint.png"),e("cursor","cursor.png"),e("cursortrail","cursortrail.png"),e("reversearrow","reversearrow.png"),e("sliderscorepoint","sliderscorepoint.png"),e("sliderstartcircle","sliderstartcircle.png"),e("sliderendcircle","sliderendcircle.png"),e("sliderb","sliderb.png"),e("sliderbnd","sliderb-nd.png"),e("sliderbspec","sliderb-spec.png"),e("spinnerApproachcircle","spinner-approachcircle.png"),e("spinnerBottom","spinner-bottom.png")]),s.sliderb||await e("sliderb","sliderb0.png");const n=[];for(let a=0;a<10;a++)try{const l=await ue(t+`sliderb${a}.png`);n.push(l)}catch{}n.length&&(s.sliderballFrames=n);const o=[];for(let a=0;a<=9;a++){const l=`default-${a}.png`,c=ue(t+l).then(d=>d).catch(()=>null);o.push(c)}const r=(await Promise.all(o)).filter(Boolean);r.length===10&&(s.digits=r);try{const a=await fetch(t+"skin.ini");if(a.ok){const l=await a.text(),c=ls(l),d=hs(c);d.length&&(s.comboColors=d);const u=ds(c);u&&(s.sliderBorder=u)}}catch{}return s}async function ue(t){return new Promise((s,e)=>{const n=new Image;n.onload=()=>s(n),n.onerror=o=>e(o),n.src=t})}const fs=({open:t,onClose:s,downloadUrl:e,beatmapVersion:n,beatmapId:o})=>(zt.useEffect(()=>{if(t)return document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}},[t]),t?p.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",onClick:i=>i.stopPropagation(),children:[p.jsx("div",{className:"overlay-backdrop",onClick:s}),p.jsxs("div",{className:"overlay-card embed-preview-card",onClick:i=>i.stopPropagation(),children:[p.jsx("button",{className:"overlay-close",onClick:s,"aria-label":"Close embed preview",children:p.jsx(Te,{size:18})}),p.jsx("div",{className:"embed-preview-body",onClick:i=>i.stopPropagation(),children:p.jsx(De,{downloadUrl:e,beatmapVersion:n,beatmapId:o,onOpenInEditor:()=>{s(),window.location.hash="/editor"}})})]})]}):null),re=1,ms={1:"#ffffff",2:"#ff0000",3:"#b706b7",4:"#3276e6",5:"#e6e605",6:"#843e84",7:"#e6e605",8:"#e6e605",9:"#e6e605"};function gs(t,s){for(t=Math.abs(t),s=Math.abs(s);s;){const e=s;s=t%s,t=e}return t||1}const ps=({beatmap:t,currentTime:s,duration:e,onSeek:n,bookmarks:o,onScrubStart:i,onScrubEnd:r,scale:a,onScaleChange:l,beatSnapDivisor:c=4,onBeatSnapChange:d,skin:u,isPlaying:f,onPlayPause:M,selectedIndices:m=new Set,onSelectionChange:C})=>{const k=x.useRef(null),N=48,[w,P]=x.useState(a??.4),g=x.useRef(!1),R=x.useRef([0,0]),$=x.useRef(null),[,T]=x.useState(0),v=x.useRef(null),W=x.useRef(!1);x.useEffect(()=>{a!==void 0&&P(a)},[a]);const D=(A,et,ht)=>et/2+(A-ht)/(re/w),X=(A,et,ht)=>ht+(A-et/2)*(re/w),dt=A=>[1,2,4,8,16].includes(A)?"even":[3,6,12].includes(A)?"triplets":"custom",Q=x.useRef(new Map),b=(A,et,ht)=>{const it=Math.max(1,Math.round(et)),E=`${A.src}|mini|${ht}|${it}`,F=Q.current,q=F.get(E);if(q)return q;const ft=document.createElement("canvas");ft.width=it,ft.height=it;const L=ft.getContext("2d");return L.drawImage(A,0,0,it,it),L.globalCompositeOperation="multiply",L.fillStyle=ht,L.fillRect(0,0,it,it),L.globalCompositeOperation="destination-in",L.drawImage(A,0,0,it,it),F.set(E,ft),ft};function ut(A,et,ht,it,E,F){if(ht<=0)return;const q=et==null?void 0:et.digits,ft=Math.max(6,Math.floor(F*.75));if(q&&q.length===10){const h=String(ht).split("").map(J=>q[Number(J)]),at=h.reduce((J,S)=>J+Math.max(1,Math.round(((S==null?void 0:S.width)||10)*(ft/((S==null?void 0:S.height)||ft)))),0);let st=it-at/2;A.save();for(const J of h){const S=Math.max(1,Math.round(((J==null?void 0:J.width)||10)*(ft/((J==null?void 0:J.height)||ft)))),yt=ft;J&&A.drawImage(J,st,E-yt/2,S,yt),st+=S}A.restore()}else A.save(),A.fillStyle="#fff",A.font=`bold ${ft}px system-ui, sans-serif`,A.textAlign="center",A.textBaseline="middle",A.fillText(String(ht),it,E),A.restore()}function tt(A,et){const{base:ht,inherited:it}=Ut(A,et.time),E=(ht==null?void 0:ht.beatLength)??500,F=it==null?void 0:it.beatLength,q=F&&F<0?100/-F:1,L=100*Number(A.difficulty.SliderMultiplier??1)*q;return et.length/Math.max(1e-6,L)*E}function St(A,et){return tt(A,et)*Math.max(1,et.slides)}const jt=x.useCallback(()=>{T(A=>A+1)},[]);Ee(k,jt),x.useEffect(()=>{var yt;const A=k.current;if(!A)return;const et=window.devicePixelRatio||1,ht=Math.min(3,Math.max(1,et)),it=A.getBoundingClientRect(),E=Math.max(200,Math.min(it.width,1e4)),F=N,q=16384,ft=Math.min(q,Math.max(1,Math.round(E*ht))),L=Math.min(q,Math.max(1,Math.round(F*ht)));A.width=ft,A.height=L;const h=A.getContext("2d");try{h.setTransform(ht,0,0,ht,0,0)}catch{}h.globalCompositeOperation="source-over",h.clearRect(0,0,E,F),h.fillStyle="#0f1626",h.fillRect(0,0,E,F);const at=s*1e3,st=E/2*(re/w)+120,J=at-st,S=at+st;if(t){const{base:_}=Ut(t,at);if(_&&_.beatLength>0){const z=_.beatLength,H=c,rt=_.time+z*Math.ceil((at-_.time)/z),gt=O=>{const lt=D(O,E,at);if(lt<-1||lt>E+1)return;const G=Math.round(O-(Math.round((O-_.time)/z)*z+_.time))===0,mt=G&&Math.round((O-_.time)/z)%(_.meter||4)===0;let bt="#cdd6f4";if(!G){const xt=Math.floor((O-_.time)/z)*z+_.time,wt=Math.round((O-xt)/(z/H)),vt=H/gs(H,wt);bt=ms[vt]||"#929292"}h.strokeStyle=bt,h.lineWidth=G?2:1,h.beginPath(),h.moveTo(lt+.5,mt?0:10),h.lineTo(lt+.5,mt?F:F-10),h.stroke()};for(let O=rt;O<=S;O+=z/H)gt(O);for(let O=rt-z/H;O>=J;O-=z/H)gt(O)}}if(t){const _=t.hitObjects,z=(yt=t.colors)!=null&&yt.comboColors&&t.colors.comboColors.length?t.colors.comboColors:u!=null&&u.comboColors&&u.comboColors.length?u.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],H=new Array(_.length).fill(0),rt=new Array(_.length).fill(1);{let bt=0;for(let xt=0;xt<_.length;xt++){const wt=_[xt];wt.newCombo&&(bt=bt+1+(wt.comboSkip||0)),H[xt]=bt,xt===0||H[xt]!==H[xt-1]?rt[xt]=1:rt[xt]=(rt[xt-1]||1)+1}}const[gt,O]=R.current;if(Math.abs(gt-O)>0){const bt=D(Math.min(gt,O),E,at),xt=D(Math.max(gt,O),E,at);h.fillStyle="rgba(255,255,255,0.25)",h.fillRect(Math.max(0,bt),0,Math.max(0,Math.min(E,xt)-Math.max(0,bt)),F)}const G=Math.floor(F*.5),mt=Math.max(2,Math.floor(F*.38));for(let bt=_.length-1;bt>=0;bt--){const xt=_[bt],wt=xt.time,vt=xt.kind==="slider"?wt+St(t,xt):xt.endTime??wt;if(vt<J||wt>S)continue;const y=D(wt,E,at),B=D(vt,E,at),nt=m.has(bt),Z=z[H[bt]%z.length];if(h.fillStyle=nt?"#f59e0b":"#1f2b45",h.fillRect(Math.floor(y),0,1,F),xt.kind==="circle"){const K=u==null?void 0:u.hitcircle,Y=u==null?void 0:u.hitcircleoverlay;if(K){const j=mt*2,I=j/(K.width||128),V=(K.width||128)*I,U=(K.height||128)*I;h.save(),h.globalAlpha=.95;const ot=b(K,Math.max(1,Math.round(j)),Z);h.drawImage(ot,y-V/2,G-U/2,V,U),Y&&h.drawImage(Y,y-V/2,G-U/2,V,U),h.restore(),ut(h,u,rt[bt],y,G,mt)}else h.save(),h.beginPath(),h.arc(y,G,mt,0,Math.PI*2),h.fillStyle=Z,h.fill(),h.restore(),ut(h,u,rt[bt],y,G,mt)}else if(xt.kind==="slider"){h.save();const K=Math.min(y,B),Y=Math.max(4,Math.abs(B-y)),j=Math.max(6,Math.floor(F*.7)),I=Math.floor((F-j)/2),V=3;h.beginPath(),h.moveTo(K+V,I),h.lineTo(K+Y-V,I),h.quadraticCurveTo(K+Y,I,K+Y,I+V),h.lineTo(K+Y,I+j-V),h.quadraticCurveTo(K+Y,I+j,K+Y-V,I+j),h.lineTo(K+V,I+j),h.quadraticCurveTo(K,I+j,K,I+j-V),h.lineTo(K,I+V),h.quadraticCurveTo(K,I,K+V,I),h.closePath(),h.fillStyle=nt?"rgba(245,158,11,0.9)":Z,h.globalAlpha=nt?.95:.85,h.fill(),h.restore();const U=u==null?void 0:u.hitcircle,ot=u==null?void 0:u.hitcircleoverlay;if(U){const Ct=mt*2,Lt=Ct/(U.width||128),Et=(U.width||128)*Lt,Nt=(U.height||128)*Lt;h.save(),h.globalAlpha=.95;const Dt=b(U,Math.max(1,Math.round(Ct)),Z);h.drawImage(Dt,y-Et/2,G-Nt/2,Et,Nt),ot&&h.drawImage(ot,y-Et/2,G-Nt/2,Et,Nt),h.restore(),ut(h,u,rt[bt],y,G,mt),h.save(),h.globalAlpha=.95;const At=b(U,Math.max(1,Math.round(Ct)),Z);h.drawImage(At,B-Et/2,G-Nt/2,Et,Nt),ot&&h.drawImage(ot,B-Et/2,G-Nt/2,Et,Nt),h.restore()}const ct=xt,Mt=Math.max(1,ct.slides);if(Mt>1&&t){const Ct=tt(t,ct);for(let Lt=1;Lt<Mt;Lt++){const Et=wt+Ct*Lt;if(Et<J||Et>S)continue;const Nt=D(Et,E,at),Dt=u==null?void 0:u.reversearrow;if(Dt){const Ft=Math.max(8,Math.floor(mt*1.2))/(Dt.width||128),Xt=(Dt.width||128)*Ft,Yt=(Dt.height||128)*Ft;h.save(),h.globalAlpha=.9,h.translate(Nt,G),h.drawImage(Dt,-Xt/2,-Yt/2,Xt,Yt),h.restore()}else if(U){const At=Math.max(4,Math.floor(mt*.75)),Ft=At/(U.width||128),Xt=(U.width||128)*Ft,Yt=(U.height||128)*Ft;h.save(),h.globalAlpha=.85;const Ne=nt?"#f59e0b":Z,Be=b(U,Math.max(1,Math.round(At*2)),Ne);h.drawImage(Be,Nt-Xt/2,G-Yt/2,Xt,Yt),ot&&(h.globalAlpha=.7,h.drawImage(ot,Nt-Xt/2,G-Yt/2,Xt,Yt)),h.restore()}else h.save(),h.beginPath(),h.arc(Nt,G,Math.max(2,Math.floor(mt*.6)),0,Math.PI*2),h.fillStyle=nt?"#f59e0b":Z,h.globalAlpha=.85,h.fill(),h.restore()}}}else if(xt.kind==="spinner"){const Y=wt-36,j=vt-36,I=D(Y,E,at),V=D(j,E,at),U=Math.min(I,V),ot=Math.max(4,Math.abs(V-I)),ct=Math.max(6,Math.floor(F*.7)),Mt=Math.floor((F-ct)/2);h.save();const Ct=3;h.beginPath(),h.moveTo(U+Ct,Mt),h.lineTo(U+ot-Ct,Mt),h.quadraticCurveTo(U+ot,Mt,U+ot,Mt+Ct),h.lineTo(U+ot,Mt+ct-Ct),h.quadraticCurveTo(U+ot,Mt+ct,U+ot-Ct,Mt+ct),h.lineTo(U+Ct,Mt+ct),h.quadraticCurveTo(U,Mt+ct,U,Mt+ct-Ct),h.lineTo(U,Mt+Ct),h.quadraticCurveTo(U,Mt,U+Ct,Mt),h.closePath(),h.fillStyle=nt?"rgba(245,158,11,0.9)":"rgba(87,177,255,0.85)",h.globalAlpha=nt?.95:.85,h.fill(),h.restore();const Lt=u==null?void 0:u.hitcircle,Et=u==null?void 0:u.hitcircleoverlay;if(Lt){const Nt=mt*2,Dt=Nt/(Lt.width||128),At=(Lt.width||128)*Dt,Ft=(Lt.height||128)*Dt;h.save(),h.globalAlpha=.95;const Xt=b(Lt,Math.max(1,Math.round(Nt)),Z);h.drawImage(Xt,I-At/2,G-Ft/2,At,Ft),Et&&h.drawImage(Et,I-At/2,G-Ft/2,At,Ft),h.restore(),h.save(),h.globalAlpha=.95;const Yt=b(Lt,Math.max(1,Math.round(Nt)),Z);h.drawImage(Yt,V-At/2,G-Ft/2,At,Ft),Et&&h.drawImage(Et,V-At/2,G-Ft/2,At,Ft),h.restore()}else h.save(),h.beginPath(),h.arc(I,G,mt,0,Math.PI*2),h.fillStyle=Z,h.fill(),h.restore(),h.save(),h.beginPath(),h.arc(V,G,mt,0,Math.PI*2),h.fillStyle=Z,h.fill(),h.restore()}if(vt>wt){const K=D(vt,E,at);h.fillStyle=nt?"rgba(245,158,11,0.35)":"rgba(87,177,255,0.2)",h.fillRect(Math.min(y,K),F-8,Math.max(1,Math.abs(K-y)),6)}}}if(o&&o.length>0){h.fillStyle="#f59e0b";for(const _ of o){const z=_*1e3,H=D(z,E,at);H<-6||H>E+6||(h.beginPath(),h.moveTo(H,0),h.lineTo(H+6,10),h.lineTo(H-6,10),h.closePath(),h.fill())}}h.strokeStyle="#cdd6f4",h.lineWidth=2,h.beginPath(),h.moveTo(E/2+.5,0),h.lineTo(E/2+.5,F),h.stroke(),h.beginPath(),h.moveTo(E/2-3,0),h.lineTo(E/2,3),h.lineTo(E/2+3,0),h.closePath(),h.fillStyle="#cdd6f4",h.fill(),h.beginPath(),h.moveTo(E/2-3,F),h.lineTo(E/2,F-3),h.lineTo(E/2+3,F),h.closePath(),h.fill()},[t,s,e,o,w,c,u]),x.useEffect(()=>{const A=k.current;if(!A)return;const et=ht=>{if(ht.altKey){ht.preventDefault();const q=ht.deltaY>0?Math.max(.5,w-.1):Math.min(1.5,w+.1),ft=Math.round(q*10)/10;P(ft),l==null||l(ft);return}ht.preventDefault(),W.current||(W.current=!0,i==null||i()),v.current!==null&&clearTimeout(v.current);const it=ht.shiftKey?1:.1,E=ht.deltaY>0?1:-1,F=Math.max(0,Math.min(e,s+E*it));n(F),v.current=window.setTimeout(()=>{W.current=!1,r==null||r(),v.current=null},150)};return A.addEventListener("wheel",et,{passive:!1}),()=>{A.removeEventListener("wheel",et),v.current!==null&&clearTimeout(v.current)}},[w,l,s,e,n,i,r]),x.useEffect(()=>{const A=k.current;if(!A||!t||!C)return;const et=it=>{const E=A.getBoundingClientRect(),F=E.width,q=s*1e3,ft=it.clientX-E.left,L=X(ft,F,q);g.current=!0;const h=40*(re/w),at=[];for(let _=0;_<t.hitObjects.length;_++){const z=t.hitObjects[_],H=z.time,rt=z.kind==="slider"?H+St(t,z):z.endTime??H;z.kind==="slider"?L>=H-h&&L<=rt+h&&at.push(_):(L-h<H&&L+h>H||L-h<rt&&L+h>rt||H-h<L&&L<rt+h)&&at.push(_)}at.sort((_,z)=>{const H=t.hitObjects[_],rt=t.hitObjects[z],gt=Math.abs(H.time-L),O=Math.abs(rt.time-L);return gt-O});const st=at[0],J=it.button===0&&(it.ctrlKey||!st&&!it.shiftKey);if(J)R.current=[L,L],it.ctrlKey||C(new Set);else if(st!==void 0){const _=new Set(m);if(it.shiftKey&&$.current!==null){const z=Math.min($.current,st),H=Math.max($.current,st);for(let rt=z;rt<=H;rt++)_.add(rt)}else it.ctrlKey||it.metaKey?_.has(st)?_.delete(st):_.add(st):(_.clear(),_.add(st));$.current=st,C(_)}else i&&i(),n(Math.max(0,Math.min(e,L/1e3)));const S=_=>{if(!g.current)return;const z=X(Math.max(0,Math.min(E.width,_.clientX-E.left)),F,q);if(J){R.current=[L,z];const H=Math.min(L,z),rt=Math.max(L,z),gt=it.ctrlKey?new Set(m):new Set;for(let O=0;O<t.hitObjects.length;O++){const lt=t.hitObjects[O],G=lt.time,mt=lt.kind==="slider"?G+St(t,lt):lt.endTime??G;(H<G&&rt>G||H<mt&&rt>mt||G<rt&&mt>H)&&gt.add(O)}C(gt),T(O=>O+1)}else n(Math.max(0,Math.min(e,z/1e3)))},yt=()=>{g.current=!1,R.current=[0,0],J||r&&r(),window.removeEventListener("mousemove",S),window.removeEventListener("mouseup",yt)};window.addEventListener("mousemove",S),window.addEventListener("mouseup",yt)},ht=it=>{if(it.preventDefault(),it.touches.length===0)return;const E=A.getBoundingClientRect(),F=E.width,q=s*1e3,ft=it.touches[0],L=X(Math.max(0,Math.min(E.width,ft.clientX-E.left)),F,q);g.current=!0,i&&i(),n(Math.max(0,Math.min(e,L/1e3)));const h=st=>{if(st.preventDefault(),!g.current||st.touches.length===0)return;const J=st.touches[0],S=X(Math.max(0,Math.min(E.width,J.clientX-E.left)),F,q);n(Math.max(0,Math.min(e,S/1e3)))},at=st=>{st.preventDefault(),g.current=!1,r&&r(),window.removeEventListener("touchmove",h),window.removeEventListener("touchend",at),window.removeEventListener("touchcancel",at)};window.addEventListener("touchmove",h,{passive:!1}),window.addEventListener("touchend",at),window.addEventListener("touchcancel",at)};return A.addEventListener("mousedown",et),A.addEventListener("touchstart",ht,{passive:!1}),()=>{A.removeEventListener("mousedown",et),A.removeEventListener("touchstart",ht)}},[t,s,e,n,i,r,w,m,C]);const[Tt,pt]=x.useState(()=>{try{return localStorage.getItem("editor:theme")||"dark"}catch{return"dark"}});x.useEffect(()=>{document.documentElement.setAttribute("data-theme",Tt);try{localStorage.setItem("editor:theme",Tt)}catch{}},[Tt]);const Pt=()=>{pt(A=>A==="dark"?"light":"dark")};return p.jsx("div",{className:"timeline-wrapper",children:p.jsxs("div",{className:"timeline-row",children:[p.jsx("canvas",{ref:k,className:"timeline",style:{height:N,display:"block"}}),p.jsxs("div",{className:"zoom-column",children:[p.jsx("button",{className:"zoom-btn small",onClick:()=>{const A=Math.min(1.5,w+.1);P(A),l==null||l(A)},children:"+"}),p.jsx("button",{className:"zoom-btn small",onClick:()=>{const A=Math.max(.5,w-.1);P(A),l==null||l(A)},children:"-"})]}),p.jsxs("div",{className:"beatsnap-vertical",children:[p.jsx("div",{className:"bs-label",children:"Beat Snap Divisor"}),p.jsxs("div",{className:"bs-value",children:["1/",c]}),p.jsxs("div",{className:"bs-arrows",children:[p.jsx("button",{className:"beat-snap-btn icon xs",title:"Prev divisor",onClick:()=>d==null?void 0:d(Math.max(1,c===16?12:c===12?9:c-1)),children:"◀"}),p.jsx("span",{className:"bs-kind",children:dt(c)}),p.jsx("button",{className:"beat-snap-btn icon xs",title:"Next divisor",onClick:()=>d==null?void 0:d(Math.min(16,c===9?12:c===12?16:c+1)),children:"▶"})]})]}),p.jsx("div",{className:"zoom-column",style:{marginLeft:4},children:p.jsx("button",{className:"zoom-btn small",onClick:Pt,title:`Switch to ${Tt==="dark"?"light":"dark"} mode`,children:Tt==="dark"?"☀":"☾"})})]})})},bs=()=>{const[t,s]=x.useState(null),[e,n]=x.useState(void 0),o=x.useRef(void 0),[i,r]=x.useState(""),a=x.useRef(new is),[l,c]=x.useState(0),[d,u]=x.useState(!1),[f,M]=x.useState(0),[m,C]=x.useState(null),k=x.useRef(null),N=x.useRef([]),w=x.useRef(0),P=x.useRef(0),g=x.useRef(0),R=x.useRef(0),[$,T]=x.useState([]),[v,W]=x.useState(1),[D,X]=x.useState(!1),dt=x.useRef(!1),Q=x.useRef(!1),b=x.useRef(null),ut=x.useRef(!1),tt=x.useRef(),[St,jt]=x.useState(.4),[Tt,pt]=x.useState(4),[Pt,A]=x.useState(!1),[et,ht]=x.useState(.6),[it,E]=x.useState(1),[F,q]=x.useState(.6),ft=x.useRef(null),[L,h]=x.useState([]),[at,st]=x.useState(""),[J,S]=x.useState(!1),[yt,_]=x.useState(!1),[z,H]=x.useState(new Set),rt=x.useCallback(async(y,B)=>{var nt,Z;$t.clearAll(),H(new Set);try{const K=await y.readText(B);let Y=de(K);try{Y=await rs(K,Y)}catch{}s(Y);try{const j=Y.metadata.TitleUnicode||Y.metadata.Title||"",I=Y.metadata.ArtistUnicode||Y.metadata.Artist||"",V=Y.metadata.Creator||Y.metadata.creator||"",U=Y.metadata.Version||"",ot=Number(Y.metadata.BeatmapID||0)||null;window.dispatchEvent(new CustomEvent("editor:info",{detail:{title:j,artist:I,mapper:V,version:U,beatmapId:ot}}))}catch{}try{const j=ie(Y.difficulty);N.current=cs(Y,j),w.current=0;const I=(nt=Y.colors)!=null&&nt.comboColors&&Y.colors.comboColors.length?Y.colors.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],V=Ce(j.CS),U=(m==null?void 0:m.sliderBorder)||((Z=Y.colors)==null?void 0:Z.sliderBorder)||"#ffffff";$t.precalculateShapes(Y,j,I,V,240,U)}catch{N.current=[],w.current=0}if(M(0),Y.audioFilename){const j=y.findFirst(I=>I.toLowerCase().endsWith(Y.audioFilename.toLowerCase()))||Y.audioFilename;try{const I=await y.readArrayBuffer(j);await a.current.load(I),M(a.current.duration||0)}catch(I){console.warn("Failed to load audio:",I)}}if(Y.backgroundFilename)try{const j=y.findFirst(U=>U.toLowerCase().endsWith(Y.backgroundFilename.toLowerCase()))||Y.backgroundFilename,I=await y.readArrayBuffer(j);o.current&&URL.revokeObjectURL(o.current);const V=URL.createObjectURL(new Blob([I]));o.current=V,n(V)}catch{o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0)}else o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0);a.current.seek(0),c(0),u(!1)}catch(K){console.error("Error loading beatmap path:",K),alert(K instanceof Error?K.message:String(K))}},[]);x.useEffect(()=>{const y=a.current;return y.onTick(B=>{dt.current||c(B)}),()=>y.stop()},[]),x.useEffect(()=>{const y=()=>A(!0);return window.addEventListener("editor:embed:preview",y),()=>window.removeEventListener("editor:embed:preview",y)},[]),x.useEffect(()=>{const y=window.__editorTransferOsz,B=window.__editorTransferPath,nt=y?null:sessionStorage.getItem("editor:transfer:osz"),Z=B?null:sessionStorage.getItem("editor:transfer:path");if(!y&&!nt||!B&&!Z)return;y?(delete window.__editorTransferOsz,delete window.__editorTransferPath):(sessionStorage.removeItem("editor:transfer:osz"),sessionStorage.removeItem("editor:transfer:path"));let K=null;return K=window.setTimeout(()=>{window.__editorTransferOsz&&(delete window.__editorTransferOsz,delete window.__editorTransferPath)},6e4),(async()=>{try{let Y;if(y)Y=y;else{const ct=atob(nt),Mt=new Uint8Array(ct.length);for(let Ct=0;Ct<ct.length;Ct++)Mt[Ct]=ct.charCodeAt(Ct);Y=Mt.buffer}const j=B||Z,I=await Se(Y);ft.current=I;const V=I.list.filter(ct=>ct.toLowerCase().endsWith(".osu"));if(!V.length)throw new Error("No .osu file in archive");const U=[];for(const ct of V)try{const Mt=await I.readText(ct),Ct=de(Mt),Lt=String(Ct.metadata.Version||"");U.push({path:ct,version:Lt,mode:Ct.mode})}catch{}h(U);const ot=V.includes(j)?j:V[0];st(ot);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:U,selected:ot}}))}catch{}await rt(I,ot),r("Transferred from preview"),K!==null&&clearTimeout(K)}catch(Y){console.error("Failed to load transferred OSZ:",Y),alert(Y instanceof Error?Y.message:"Failed to load transferred beatmap"),K!==null&&clearTimeout(K)}})(),()=>{K!==null&&clearTimeout(K)}},[rt]),x.useEffect(()=>{if(!Pt)return;const y=B=>{B.key==="Escape"&&A(!1)};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[Pt]),x.useEffect(()=>{try{localStorage.getItem("editor:welcome:hidden")==="1"||S(!0)}catch{S(!0)}},[]),x.useEffect(()=>{const y=async()=>{try{const B=a.current.getContext();if(B.state!=="running"&&await B.resume(),!k.current){const nt=new oe(B);k.current=nt,nt.volume=F*et,await nt.load().catch(()=>{})}}catch{}window.removeEventListener("pointerdown",y),window.removeEventListener("keydown",y)};return window.addEventListener("pointerdown",y,{once:!0}),window.addEventListener("keydown",y,{once:!0}),()=>{window.removeEventListener("pointerdown",y),window.removeEventListener("keydown",y)}},[]),x.useEffect(()=>{us().then(y=>C(y)).catch(()=>C(null))},[]),x.useEffect(()=>{$t.clearAll()},[]),x.useEffect(()=>()=>{var y;P.current&&(cancelAnimationFrame(P.current),P.current=0),a.current.stop(),$t.clearAll(),o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),b.current!==null&&(clearTimeout(b.current),b.current=null);try{(y=k.current)==null||y.stopAll()}catch{}},[]),x.useEffect(()=>{a.current&&(a.current.volume=it*et)},[it,et]),x.useEffect(()=>{k.current&&(k.current.volume=F*et)},[F,et]);const gt=x.useCallback(async y=>{console.log("Attempting to load OSZ file:",y.name),r(y.name);try{const B=await Se(y);console.log("OSZ loaded, contents:",B.list),ft.current=B;const nt=B.list.filter(K=>K.toLowerCase().endsWith(".osu"));if(!nt.length)throw new Error("No .osu file in archive");const Z=[];for(const K of nt)try{const Y=await B.readText(K),j=de(Y),I=String(j.metadata.Version||"");Z.push({path:K,version:I,mode:j.mode})}catch{}h(Z),st(nt[0]);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:Z,selected:nt[0]}}))}catch{}await rt(B,nt[0])}catch(B){console.error("Error in onOpenOsz:",B),alert(B instanceof Error?B.message:String(B))}},[]),O=x.useMemo(()=>{if(f>0)return f;if(!t)return 0;const y=t.hitObjects[t.hitObjects.length-1];return y?(("endTime"in y?y.endTime:y.time)+2e3)/1e3:0},[f,t]),lt=x.useCallback(y=>{var Y;D?(a.current&&f>0&&a.current.setPosition(y),c(y)):(a.current.seek(y),c(y));const B=y*1e3,nt=N.current;let Z=0,K=nt.length;for(;Z<K;){const j=Z+K>>>1;nt[j].timeMs<=B?Z=j+1:K=j}w.current=Z;try{(Y=k.current)==null||Y.stopSlide()}catch{}f===0&&d&&!D&&(g.current=performance.now(),R.current=y)},[D,f,d]),G=x.useCallback(async()=>{var Z,K;if(a.current.isPlaying&&f>0||d){a.current.pause(),u(!1),a.current.isPlaying&&a.current.stop(),P.current&&(cancelAnimationFrame(P.current),P.current=0);try{(Z=k.current)==null||Z.stopAll()}catch{}}else{if(dt.current)return;try{const Y=a.current.getContext();if(Y.state!=="running"&&await Y.resume(),!k.current){const j=new oe(Y);k.current=j,j.volume=F*et,await j.load().catch(()=>{})}}catch{}if(f>0){const Y=Math.max(0,f);let j=Math.max(0,Math.min(Y,typeof l=="number"?l:0));if(j>=Y-.001&&(j=0),j!==l){c(j);const I=j*1e3,V=N.current;let U=0,ot=V.length;for(;U<ot;){const ct=U+ot>>>1;V[ct].timeMs<=I?U=ct+1:ot=ct}w.current=U}xt.current=j,a.current.play(j),u(!0),a.current.isPlaying||u(!1);try{const I=(typeof l=="number"?l:0)*1e3,V=N.current;let U=-1;for(let ot=0;ot<V.length;ot++)V[ot].timeMs<=I&&V[ot].kind==="slide_start"&&(U=ot);if(U!==-1){let ot=!1;for(let ct=U+1;ct<V.length;ct++)if(V[ct].kind==="slide_end"){ot=V[ct].timeMs>=I;break}if(ot){const ct=V[U];(K=k.current)==null||K.startSlide(ct.set)}}}catch{}}else{u(!0),g.current=performance.now();const Y=Math.max(0,O||0),j=typeof l=="number"&&l>=Y-.001?0:l;if(j!==l){c(j);const V=j*1e3,U=N.current;let ot=0,ct=U.length;for(;ot<ct;){const Mt=ot+ct>>>1;U[Mt].timeMs<=V?ot=Mt+1:ct=Mt}w.current=ot}R.current=j;const I=()=>{if(dt.current){P.current=0;return}const V=(performance.now()-g.current)/1e3,U=Math.min(O||1/0,R.current+V);if(c(U),U>=(O||1/0)){u(!1);return}P.current=requestAnimationFrame(I)};P.current=requestAnimationFrame(I)}}},[d,f,l,O]);x.useEffect(()=>{tt.current=G},[G]);const mt=x.useMemo(()=>{if(!t)return{bpm:0,sliderVelocity:0};const{base:y,inherited:B}=Ut(t,l*1e3),nt=y?6e4/y.beatLength:0,Z=B?-100/B.beatLength:1;return{bpm:nt,sliderVelocity:Z}},[t,l]);x.useCallback(y=>{var nt;const B=(nt=y.target.files)==null?void 0:nt[0];if(B){console.log("File selected in input:",B.name);try{const Z=a.current.getContext();if(Z.state!=="running"&&Z.resume(),!k.current){const K=new oe(Z);k.current=K,K.volume=F*et,K.load().catch(()=>{})}}catch{}gt(B).catch(Z=>{console.error("Error from onOpenOsz via file input:",Z),alert(String((Z==null?void 0:Z.message)||Z))})}},[gt]),x.useEffect(()=>{const y=B=>{const Z=B.detail;Z&&gt(Z).catch(K=>{alert(K instanceof Error?K.message:String(K))})};return window.addEventListener("editor:file",y),()=>window.removeEventListener("editor:file",y)},[gt]);const bt=x.useCallback(y=>{H(new Set(y))},[]);x.useEffect(()=>{const y=B=>{if(!(B.target&&B.target.tagName==="INPUT")&&(B.code==="KeyC"||B.code==="Keyc")&&B.ctrlKey){if(B.preventDefault(),!t||z.size===0)return;const nt=Array.from(z).map(ot=>({idx:ot,obj:t.hitObjects[ot]})).filter(ot=>ot.obj).sort((ot,ct)=>ot.obj.time-ct.obj.time);if(nt.length===0)return;const Z=nt[0].obj.time,K=ge(t),Y=nt.map(ot=>K.number[ot.idx]).join(","),j=Math.floor(Z/1e3/60),I=Math.floor(Z/1e3%60),V=Math.floor(Z%1e3),U=`${j.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}:${V.toString().padStart(3,"0")} (${Y})`;navigator.clipboard.writeText(U).catch(()=>{});return}};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[t,z]),x.useEffect(()=>{const y=B=>{if(B.target&&B.target.tagName==="INPUT")return;if(B.code==="Space"){B.preventDefault(),tt.current&&tt.current();return}const nt=B.shiftKey?1:.1;B.code==="ArrowLeft"&&(B.preventDefault(),lt(Math.max(0,l-nt))),B.code==="ArrowRight"&&(B.preventDefault(),lt(Math.min(O,l+nt))),B.code==="Home"&&(B.preventDefault(),lt(0)),B.code==="End"&&(B.preventDefault(),lt(O)),B.code==="KeyB"&&(B.preventDefault(),T(Z=>[...Z,l]))};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[G,lt,l,O]),x.useEffect(()=>{const y=B=>{var ot;const nt=B.target;if(!nt||nt.closest(".top-nav")||nt.tagName==="INPUT"||nt.tagName==="TEXTAREA"||B.altKey||nt.closest(".timeline-wrapper")||nt.closest(".editor-controls-container")||(B.preventDefault(),!Number.isFinite(O)||O<=0))return;if(!ut.current){ut.current=!0;const ct=a.current.isPlaying&&f>0;Q.current=ct,ct&&a.current.pause(),u(!1),dt.current=!0,X(!0)}b.current!==null&&clearTimeout(b.current);const Z=B.shiftKey?1:.1,K=B.deltaY>0?1:-1,Y=Math.max(0,Math.min(O,l+K*Z));f>0&&a.current.setPosition(Y),c(Y);const j=Y*1e3,I=N.current;let V=0,U=I.length;for(;V<U;){const ct=V+U>>>1;I[ct].timeMs<=j?V=ct+1:U=ct}w.current=V;try{(ot=k.current)==null||ot.stopSlide()}catch{}b.current=window.setTimeout(()=>{ut.current=!1,dt.current=!1,X(!1),b.current=null},150)};return window.addEventListener("wheel",y,{passive:!1}),()=>{window.removeEventListener("wheel",y),b.current!==null&&clearTimeout(b.current)}},[l,O,d,f]),x.useEffect(()=>{const y=B=>{var Y;const Z=(Y=B.detail)==null?void 0:Y.path,K=ft.current;!K||!Z||(st(Z),rt(K,Z).then(()=>{try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:L,selected:Z}}))}catch{}}))};return window.addEventListener("editor:difficulty:select",y),()=>window.removeEventListener("editor:difficulty:select",y)},[L,rt]);const xt=x.useRef(0);x.useEffect(()=>{if(!t){xt.current=l;return}const y=k.current;if(!y){xt.current=l;return}const B=xt.current,nt=l;if(xt.current=l,!d||D||nt<=B||nt-B>1)return;try{const j=a.current.getContext();if(j.state!=="running"){j.resume().catch(()=>{});return}}catch{}const Z=nt*1e3,K=N.current;let Y=w.current;for(;Y<K.length&&K[Y].timeMs<=Z;Y++){const j=K[Y];j.kind==="hit"?y.playHit(j.set,j.bits||0):j.kind==="tick"?y.playTick(j.set):j.kind==="reverse"&&(typeof j.bits=="number"?y.playHit(j.set,j.bits):y.playReverse(j.set))}w.current=Y},[l,t,d,D]);const wt=x.useCallback(()=>{const y=a.current.isPlaying&&f>0;Q.current=y,y&&a.current.pause(),P.current&&(cancelAnimationFrame(P.current),P.current=0),u(!1),dt.current=!0,X(!0)},[f]);x.useEffect(()=>{const y=B=>{if(B.key==="theme"){const nt=B.newValue;(nt==="light"||nt==="dark")&&document.documentElement.setAttribute("data-theme",nt)}};return window.addEventListener("storage",y),()=>window.removeEventListener("storage",y)},[]);const vt=x.useCallback(async()=>{dt.current=!1,X(!1);try{const y=a.current.getContext();if(y.state!=="running"&&await y.resume(),!k.current){const B=new oe(y);k.current=B,B.volume=F*et,await B.load().catch(()=>{})}}catch{}},[F,et]);return p.jsxs("div",{className:"app fullscreen-editor",children:[p.jsx(ps,{beatmap:t,currentTime:l,duration:O,onSeek:lt,bookmarks:$,onScrubStart:wt,onScrubEnd:vt,scale:St,onScaleChange:jt,beatSnapDivisor:Tt,onBeatSnapChange:pt,skin:m||void 0,isPlaying:d,onPlayPause:G,selectedIndices:z,onSelectionChange:bt}),p.jsxs("div",{className:"playfield-container",children:[p.jsx(ve,{beatmap:t,timeSec:l,backgroundUrl:e,skin:m,sliderBodyCutoffPx:v,selectedIndices:z,onSelectionChange:bt}),p.jsx(Me,{masterVolume:et,songVolume:it,hitsoundVolume:F,onMasterVolumeChange:ht,onSongVolumeChange:E,onHitsoundVolumeChange:q})]}),p.jsx(be,{isPlaying:d,onPlayPause:G,currentTime:l,duration:O,onSeek:lt,onScrubStart:wt,onScrubEnd:vt,bpm:mt.bpm,sliderVelocity:mt.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints}),J&&p.jsx("div",{className:"editor-modal-overlay",children:p.jsxs("div",{className:"editor-modal",children:[p.jsx("div",{className:"modal-title",children:"Hey!"}),p.jsx("div",{className:"modal-body",children:p.jsxs("p",{children:["If you use this website solely for the editor, ",p.jsx("strong",{children:"don't"}),". This is a fork of ",p.jsx("strong",{children:"JoSu! 2.0"})," (",p.jsx("a",{href:"https://preview.tryz.id.vn/",target:"_blank",rel:"noreferrer",children:"preview.tryz.id.vn"}),") adapted specifically for this website. JoSu is superior in almost every way."]})}),p.jsxs("div",{className:"modal-actions",children:[p.jsxs("label",{className:"check-bubble",children:[p.jsx("input",{type:"checkbox",checked:yt,onChange:y=>_(y.target.checked)}),p.jsx("span",{className:"check-text",children:"Don't show this again"})]}),p.jsx("button",{className:"btn secondary",onClick:()=>{try{yt&&localStorage.setItem("editor:welcome:hidden","1")}catch{}S(!1)},children:"OK"})]})]})}),Pt&&p.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",children:[p.jsx("div",{className:"overlay-backdrop",onClick:()=>A(!1)}),p.jsxs("div",{className:"overlay-card embed-preview-card",children:[p.jsx("button",{className:"overlay-close",onClick:()=>A(!1),"aria-label":"Close embed preview",children:p.jsx(Te,{size:18})}),p.jsx("div",{className:"embed-preview-body",children:t?p.jsxs(p.Fragment,{children:[p.jsxs("div",{className:"embed-preview-playfield",children:[p.jsx(ve,{beatmap:t,timeSec:l,backgroundUrl:e,skin:m,sliderBodyCutoffPx:v,selectedIndices:z,onSelectionChange:bt}),p.jsx(Me,{masterVolume:et,songVolume:it,hitsoundVolume:F,onMasterVolumeChange:ht,onSongVolumeChange:E,onHitsoundVolumeChange:q})]}),p.jsx(be,{isPlaying:d,onPlayPause:G,currentTime:l,duration:O,onSeek:lt,bpm:mt.bpm,sliderVelocity:mt.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints})]}):p.jsx("div",{className:"embed-preview-empty",children:"Load a beatmap to see the embed preview."})})]})]})]})},Ms=Object.freeze(Object.defineProperty({__proto__:null,default:fs},Symbol.toStringTag,{value:"Module"}));export{is as A,fs as B,be as C,bs as E,oe as H,ve as P,Me as V,Se as a,rs as b,cs as c,Ms as d,us as l,de as p,ie as r,$t as s,Ut as t};

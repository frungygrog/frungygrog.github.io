import{s as it,t as be,v as ve,w as Fe,r as i,j as e,x as He,l as Ce,y as ot,e as lt,o as Ke,u as Pe,q as Je,L as Ye,z as dt,B as Le,k as De,f as ct,C as ut,D as mt,E as ze,d as Ge,G as Re,H as Ae,I as pt,c as Te,J as gt,K as Xe,M as ht,N as ft,O as Oe,A as yt,h as xt,P as bt,Q as vt}from"./vendor-react-DjZENDOm.js";import{a as w,A as S,g as jt,u as ye,b as Ve,P as Ze,C as St,c as wt}from"./mappi-routes-B7tERAAm.js";import{i as kt,a as _t,b as Nt,c as Tt}from"./editor-components-DLfFEG70.js";import{B as et}from"./editor-lib-CpbIpUG4.js";const Ct=()=>{try{const t=localStorage.getItem("filter_modes")||"standard",n=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{standard:n.has("standard")||n.size===0,taiko:n.has("taiko"),mania:n.has("mania"),catch:n.has("catch")}}catch{return{standard:!0,taiko:!1,mania:!1,catch:!1}}},zt=()=>{try{const t=localStorage.getItem("filter_moddi_tags")||"untagged,help",n=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{untagged:n.has("untagged")||n.size===0,help:n.has("help")||n.size===0}}catch{return{untagged:!0,help:!0}}},Ft=()=>{try{const t=localStorage.getItem("filter_queue_status")||"unchecked,accepted,denied,finished",n=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{unchecked:n.has("unchecked")||n.size===0,accepted:n.has("accepted")||n.size===0,denied:n.has("denied")||n.size===0,finished:n.has("finished")||n.size===0,archived:n.has("archived")}}catch{return{unchecked:!0,accepted:!0,denied:!0,finished:!0,archived:!1}}},It=()=>{try{const t=localStorage.getItem("last_section");return t==="mappi"||t==="moddi"?t:null}catch{return null}},Ee=it(t=>({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1,filtersOpen:!1,modeFilters:Ct(),tagFilters:zt(),queueStatusFilters:Ft(),lastSection:It(),previousLocation:null,setMenuOpen:n=>t({menuOpen:n}),setMobileNavOpen:n=>t({mobileNavOpen:n}),setNotifOpen:n=>t({notifOpen:n}),setFiltersOpen:n=>t({filtersOpen:n}),closeAllPanels:()=>t({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1,filtersOpen:!1}),setModeFilters:n=>{t({modeFilters:n});try{const h=Object.entries(n).filter(([v,x])=>x).map(([v])=>v),u=h.length?h:["standard"];localStorage.setItem("filter_modes",u.join(","))}catch{}},setTagFilters:n=>{t({tagFilters:n});try{const h=Object.entries(n).filter(([v,x])=>x).map(([v])=>v),u=h.length?h:["untagged","help"];localStorage.setItem("filter_moddi_tags",u.join(","))}catch{}},setQueueStatusFilters:n=>{t({queueStatusFilters:n});try{const h=Object.entries(n).filter(([v,x])=>x).map(([v])=>v),u=h.length?h:["unchecked","accepted","denied","finished"];localStorage.setItem("filter_queue_status",u.join(","))}catch{}},setLastSection:n=>{t({lastSection:n});try{n?localStorage.setItem("last_section",n):localStorage.removeItem("last_section")}catch{}},setPreviousLocation:n=>{t({previousLocation:n})}}));function qe(){return be({queryKey:["user","me"],queryFn:async()=>{try{return await w(S.auth.me)}catch{return null}},staleTime:5*60*1e3})}function Jt(t=!0){return be({queryKey:["user","quota"],queryFn:async()=>{try{return await w(S.user.quota)}catch{return null}},enabled:t,refetchInterval:30*1e3})}function Yt(){const t=ve();return Fe({mutationFn:async()=>{await w(S.auth.logout,{method:"POST"})},onSuccess:()=>{t.setQueryData(["user","me"],null),t.clear(),window.location.href="/"}})}function Mt(t=!0){return be({queryKey:["notifications"],queryFn:async()=>{try{const n=await w(S.user.notifications);return Array.isArray(n.items)?n.items:[]}catch{return[]}},enabled:t,refetchInterval:45*1e3})}function Rt(){return be({queryKey:["notifications","detailed"],queryFn:async()=>{try{const t=await w("/api/me/notifications/detailed");return Array.isArray(t.items)?t.items:[]}catch{return[]}},refetchInterval:30*1e3})}function Gt(){const{data:t=[]}=Mt();return t.filter(n=>n.kind==="system"&&n.id.startsWith("b:")&&(n.expiresAt||0)<=Date.now()?!1:!n.read).length}function Lt(){const t=ve();return Fe({mutationFn:async n=>{await w(S.user.markNotificationsRead,{method:"POST",body:JSON.stringify({ids:n})})},onSuccess:()=>{t.setQueryData(["notifications"],n=>(n==null?void 0:n.map(s=>({...s,read:!0})))||[])}})}function Pt(){const t=ve();return Fe({mutationFn:async n=>{const s=jt();await w(S.user.deleteNotification(n),{method:"DELETE",headers:{"X-CSRF-Token":s}})},onSuccess:(n,s)=>{t.setQueryData(["notifications"],h=>(h==null?void 0:h.filter(u=>u.id!==s))||[])}})}const Ue={standard:Tt,taiko:Nt,mania:_t,catch:kt},We={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Et=({value:t,onChange:n})=>{const[s,h]=i.useState(!1),u=i.useRef(null);i.useEffect(()=>{if(!s)return;const x=N=>{u.current&&!u.current.contains(N.target)&&h(!1)},_=N=>{N.key==="Escape"&&h(!1)};return document.addEventListener("mousedown",x),document.addEventListener("keydown",_),()=>{document.removeEventListener("mousedown",x),document.removeEventListener("keydown",_)}},[s]);const v=x=>e.jsxs("button",{className:`mode-option${x===t?" selected":""}`,onClick:()=>{n(x),h(!1)},role:"option","aria-selected":x===t,children:[e.jsx("img",{className:"mode-icon",src:Ue[x],width:24,height:24,alt:""}),e.jsx("span",{children:We[x]})]},x);return e.jsxs("div",{className:"mode-select",ref:u,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":s,onClick:()=>h(x=>!x),children:[e.jsx("img",{className:"mode-icon",src:Ue[t],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:We[t]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),s&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(v)})]})};function Qe(t){if(!t)return"standard";const n=String(t).toLowerCase().trim();return n==="osu"||n==="0"||n==="standard"?"standard":n==="taiko"||n==="1"?"taiko":n==="catch"||n==="fruits"||n==="2"?"catch":n==="mania"||n==="3"?"mania":"standard"}function qt({section:t,onUpload:n,onPost:s}){const{notify:h}=ye(),u=t==="mappi",[v,x]=i.useState(!1),[_,N]=i.useState(""),[d,b]=i.useState(null),[y,z]=i.useState(null),[k,L]=i.useState(!1),[K,E]=i.useState(""),r=i.useRef(0),[c,f]=i.useState(""),[R,A]=i.useState("standard"),[P,X]=i.useState(null),[H,g]=i.useState(0),[M,W]=i.useState(""),[Y,te]=i.useState(""),[ee,de]=i.useState(null),[pe,O]=i.useState(""),[Q,$]=i.useState(""),[q,G]=i.useState(null),[o,C]=i.useState(!1),[se,ae]=i.useState(null),ce=100*1024*1024,ne=i.useMemo(()=>P?`${P.name}:${P.size}:${P.lastModified}`:null,[P]),[B,ue]=i.useState(""),[he,oe]=i.useState(!1),[re,ge]=i.useState([]),xe=i.useRef(null);i.useEffect(()=>{r.current&&window.clearTimeout(r.current);const j=(_||"").trim();if(!j){E(""),b(null),z(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(j)){E(""),b(null),z(null);return}return r.current=window.setTimeout(async()=>{var m;try{let F;try{F=new URL(j)}catch{E("Invalid URL format");return}const U=F.hash.match(/#osu\/(\d+)/),I=U?U[1]:null;F.hash="";const ke={url:F.toString()};I&&(ke.beatmap_id=I);const Z=await w(S.osu.resolveBeatmap+Ve(ke),{requireAuth:!1}),me=Array.isArray(Z==null?void 0:Z.diffs)?Z.diffs:[];if(!me.length&&!Z.setId){E("No difficulties found"),b(null),z(null);return}if(b({setId:Number(Z.setId)||0,beatmapId:Z.beatmapId??null,title:String(Z.title||""),artist:String(Z.artist||""),mapper:String(Z.mapper||""),diffs:me}),me.length>0){const le=Number.isFinite(Number(Z.beatmapId))?Number(Z.beatmapId):Number((m=me[0])==null?void 0:m.id),ie=me.find(Ie=>Number(Ie.id)===le)||me[0],_e=Qe(ie==null?void 0:ie.mode);z({beatmapId:Number(ie==null?void 0:ie.id)||null,version:String((ie==null?void 0:ie.version)||""),mode:_e}),u&&A(_e)}else z(null);E("")}catch(F){const U=(F==null?void 0:F.message)||"Unknown error";E(`Failed to resolve: ${U}`),b(null),z(null)}},400),()=>{r.current&&window.clearTimeout(r.current)}},[_,u]);async function fe(){return te("info"),W("Requesting upload URL..."),await w(S.uploads.new,{method:"POST",body:JSON.stringify({description:c.slice(0,100),beatmap_url:_||void 0,size_bytes:(P==null?void 0:P.size)??void 0,mode:R,beatmapset_id:(d==null?void 0:d.setId)??void 0,beatmap_id:(y==null?void 0:y.beatmapId)??void 0,beatmap_version:(y==null?void 0:y.version)??void 0,beatmap_title:d?`${d.title}`:void 0,beatmap_artist:d?`${d.artist}`:void 0,beatmap_mapper:d?`${d.mapper}`:void 0})})}async function je(j,T,m="form"){await new Promise((F,U)=>{const I=new XMLHttpRequest;if(I.open("POST",j),I.upload.onprogress=V=>{V.lengthComputable&&g(Math.round(V.loaded/V.total*100))},I.onload=()=>I.status>=200&&I.status<300?F():U(new Error(`Upload failed (${I.status}) ${I.responseText||""}`)),I.onerror=()=>U(new Error("Network error")),m==="form"){const V=new FormData;V.append("file",T,T.name),I.send(V)}else I.setRequestHeader("Content-Type","application/octet-stream"),I.send(T)})}async function Se(){if(!(!P||!u)){if(P.size>ce){O("File exceeds 100MB limit");return}if(typeof q=="number"&&q>60.5){$("Clip exceeds 60s limit");return}ne&&(C(!0),ae(ne)),g(0),te("info");try{const j=await fe();de(j.streamUID);let T=j.streamUID;try{W("Uploading..."),await je(j.uploadURL,P,"form")}catch(m){te("warn"),W(`Retrying upload... (${(m==null?void 0:m.message)||m})`);const F=await fe();de(F.streamUID),T=F.streamUID,await je(F.uploadURL,P,"binary")}te("info"),W("Processing...");for(let m=0;m<60;m++){await new Promise(F=>setTimeout(F,3e3));try{if((await w(S.videos.get(T),{requireAuth:!1})).status==="ready"){te("success"),W("Ready!"),h("Upload complete!",{variant:"success"}),X(null),f(""),N(""),b(null),z(null),A("standard"),g(0),de(null),O(""),$(""),G(null),C(!1),ae(null),n&&n();break}}catch{}}}catch(j){te("error"),W(j.message||"Error"),h(j.message||"Upload failed",{variant:"error"})}}}const we=async j=>{if(j.preventDefault(),!u){if(!B.trim()){h("Text is required",{variant:"error"});return}if(B.length>200){h("Text must be 200 characters or less",{variant:"error"});return}oe(!0);try{const T=await w(S.moddi.posts,{method:"POST",body:JSON.stringify({text:B.trim(),beatmap_url:_.trim()||void 0,beatmapset_id:(d==null?void 0:d.setId)??void 0,beatmap_id:(y==null?void 0:y.beatmapId)??(d==null?void 0:d.beatmapId)??void 0,beatmap_version:(y==null?void 0:y.version)??void 0,tags:re.length>0?re.join(","):void 0})});if(T){console.log("Post created response:",T);const m=T==null?void 0:T.post;m?(!m.uid&&m.id&&(console.warn("Created post missing uid, using id as fallback:",m),m.uid=String(m.id)),s&&s(m)):s&&s(),h("Post created!",{variant:"success"}),ue(""),N(""),b(null),z(null),E(""),L(!1),ge([])}}catch{h("Failed to create post",{variant:"error"})}finally{oe(!1)}}};return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:u?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>x(!v),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:u?"Upload a clip":"Create a post!"}),v?e.jsx(He,{size:16}):e.jsx(Ce,{size:16})]}),v&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Et,{value:R,onChange:A})]}),d?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[d.artist," – ",d.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",d.mapper]})]}),d.diffs.length>0&&e.jsx("select",{value:(y==null?void 0:y.beatmapId)??d.beatmapId??void 0,onChange:j=>{const T=Number(j.target.value),m=(d==null?void 0:d.diffs.find(F=>Number(F.id)===T))||null;if(m){const F=Qe(m.mode);z({beatmapId:T,version:m.version,mode:F}),A(F)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:d.diffs.map(j=>e.jsxs("option",{value:j.id,children:[j.version," (",j.mode,")"]},j.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>L(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{b(null),z(null),N("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:_,onChange:j=>N(j.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:c,onChange:j=>f(j.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),K&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:K}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:j=>{var F;const T=((F=j.target.files)==null?void 0:F[0])||null;if(X(T),G(null),T&&T.size>ce?O("File exceeds 100MB limit"):O(""),T)try{const U=URL.createObjectURL(T),I=document.createElement("video");I.preload="metadata",I.src=U,I.onloadedmetadata=()=>{URL.revokeObjectURL(U);const V=Number.isFinite(I.duration)?I.duration:NaN;Number.isFinite(V)&&G(V),Number.isFinite(V)&&V>60.5?$("Clip exceeds 60s limit"):$("")},I.onerror=()=>{URL.revokeObjectURL(U),G(null)}}catch{G(null)}else $("");const m=T?`${T.name}:${T.size}:${T.lastModified}`:null;m&&m!==se&&C(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:Se,disabled:!P||!!pe||!!Q||o,style:{flexShrink:0},children:"Upload"})]}),pe&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:pe}),Q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:Q}),P&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",P.name," • ",(P.size/1024/1024).toFixed(1)," MB",o&&se===ne?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(H>0||M)&&e.jsxs("div",{className:"upload-status",children:[M&&e.jsx("div",{className:`chip ${Y||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:M}),H>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":H,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,H))}%`}})})]}),ee&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",ee]})]})]}):e.jsx("form",{onSubmit:we,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:xe,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:B,onChange:j=>ue(j.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),d?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[d.artist," – ",d.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",d.mapper]})]}),d.diffs.length>0&&e.jsx("select",{value:(y==null?void 0:y.beatmapId)??d.beatmapId??void 0,onChange:j=>{const T=Number(j.target.value),m=(d==null?void 0:d.diffs.find(F=>Number(F.id)===T))||null;m&&z({beatmapId:T,version:m.version,mode:String(m.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:d.diffs.map(j=>e.jsxs("option",{value:j.id,children:[j.version," (",j.mode,")"]},j.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:_,onChange:j=>N(j.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),K&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:K}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{re.includes("help")?ge(re.filter(j=>j!=="help")):ge([...re,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:re.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:re.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:re.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>L(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{b(null),z(null),N("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:he||!B.trim()||B.length>200,children:he?"Posting...":"Post"})]})]})})}),k&&d&&e.jsx(et,{open:k,onClose:()=>L(!1),downloadUrl:S.osu.downloadBeatmapset(d.setId),beatmapId:(y==null?void 0:y.beatmapId)??d.beatmapId??void 0,beatmapVersion:y==null?void 0:y.version})]})}function Bt(){const{data:t}=qe(),{tagFilters:n}=Ee();return ot({queryKey:["moddi","feed",n],queryFn:async({pageParam:s=0})=>{const h=new URLSearchParams({limit:"20",offset:String(s)}),u=`${S.moddi.posts}?${h.toString()}`;return await w(u)},enabled:!!t,initialPageParam:0,getNextPageParam:(s,h)=>{var x;const u=h.reduce((_,N)=>{var d;return _+(((d=N.items)==null?void 0:d.length)||0)},0);return(((x=s.items)==null?void 0:x.length)||0)===20?u:void 0}})}function Xt(){const t=lt(),n=ve(),{data:s}=qe(),{tagFilters:h}=Ee(),{data:u,fetchNextPage:v,hasNextPage:x,isFetching:_,isFetchingNextPage:N,refetch:d}=Bt(),b=i.useMemo(()=>u!=null&&u.pages?u.pages.flatMap(r=>(r.items||[]).map(f=>({...f,user_id:f.user_id??0,username:f.username||"Unknown",avatar_url:f.avatar_url||null,text:f.text??null,uid:f.uid||String(f.id||""),reactions_count:Number(f.reactions_count??0),reacted_by_me:f.reacted_by_me??!1,comments_count:Number(f.comments_count??0)}))):[],[u]),y=i.useMemo(()=>b.filter(r=>{const c=r.tags?typeof r.tags=="string"?r.tags.split(",").map(A=>A.trim()):[]:[],f=!r.tags||c.length===0,R=c.includes("help");return h.untagged&&h.help?!0:h.untagged&&!h.help?f:!h.untagged&&h.help?R:!1}),[b,h]);i.useEffect(()=>{t.pathname==="/md/feed"&&d()},[t.pathname,d]),i.useEffect(()=>{const r=()=>{d()};return window.addEventListener("moddifilterchange",r),()=>window.removeEventListener("moddifilterchange",r)},[d]);const z=r=>{n.setQueryData(["moddi","feed"],c=>c&&{...c,pages:c.pages.map(f=>({...f,items:f.items.map(R=>R.id===r.id?r:R)}))})},k=r=>{n.setQueryData(["moddi","feed"],c=>c&&{...c,pages:c.pages.map(f=>({...f,items:f.items.filter(R=>R.id!==r)}))})},L=r=>{r&&n.setQueryData(["moddi","feed"],c=>{if(!c)return c;const f={...r,user_id:r.user_id??0,username:r.username||"Unknown",avatar_url:r.avatar_url||null,text:r.text??null,uid:r.uid||String(r.id||""),reactions_count:Number(r.reactions_count??0),reacted_by_me:r.reacted_by_me??!1,comments_count:Number(r.comments_count??0)};return{...c,pages:c.pages.map((R,A)=>A===0?{...R,items:[f,...R.items||[]]}:R)}}),n.invalidateQueries({queryKey:["moddi","feed"]}),d()},K=_&&!N,E=x??!1;return e.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"feed-header",children:[e.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),e.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),e.jsx(qt,{section:"moddi",onPost:L})]}),e.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:0},children:[y.length===0&&!K&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),y.map(r=>e.jsx(Ze,{post:r,section:"moddi",onUpdate:z,onDelete:k,me:s},r.id)),y.length>0&&E&&e.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("button",{className:"btn secondary",onClick:()=>v(),disabled:N,children:N?"Loading...":"Load more"})})]})})]})}function Vt(){const{uid:t}=Ke(),n=Pe(),[s,h]=i.useState(null),[u,v]=i.useState([]),[x,_]=i.useState(!0),[N,d]=i.useState(null),[b,y]=i.useState(""),[z,k]=i.useState(null),[L,K]=i.useState(!1),{notify:E}=ye();i.useEffect(()=>{w(S.auth.me,{requireAuth:!1}).then(g=>d(g)).catch(()=>{})},[]);const r=async()=>{if(!t||t==="null"||t==="undefined"){E("Invalid post identifier",{variant:"error"}),n("/md/feed");return}_(!0);try{const g=await w(S.moddi.post(t),{requireAuth:!1}),M={...g,user_id:g.user_id??0,username:g.username||"Unknown",avatar_url:g.avatar_url||null,uid:g.uid||String(g.id)||t,text:g.text??null,beatmap_url:g.beatmap_url??null,beatmapset_id:g.beatmapset_id??null,beatmap_id:g.beatmap_id??null,beatmap_version:g.beatmap_version??null,tags:g.tags??null,reactions_count:Number(g.reactions_count??0),reacted_by_me:g.reacted_by_me??!1,comments_count:Number(g.comments_count??0)};h(M)}catch{E("Failed to load post",{variant:"error"}),n("/md/feed")}finally{_(!1)}},c=async()=>{if(s!=null&&s.id)try{const g=await w(S.moddi.postComments(s.id),{requireAuth:!1});v(g.items||[])}catch{}};i.useEffect(()=>{r()},[t]),i.useEffect(()=>{s!=null&&s.id&&c()},[s==null?void 0:s.id]);const f=g=>{h(g)},R=()=>{n("/md/feed")},A=async g=>{if(g.preventDefault(),!(!b.trim()||!(s!=null&&s.id))){K(!0);try{await w(S.moddi.postComments(s.id),{method:"POST",body:JSON.stringify({text:b.trim(),parent_id:z||void 0})}),y(""),k(null),c(),r(),E("Comment posted!",{variant:"success"})}catch(M){E((M==null?void 0:M.message)||"Failed to post comment",{variant:"error"})}finally{K(!1)}}},P=g=>{v(M=>M.filter(W=>W.id!==g))};if(x)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!s)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const X=u.filter(g=>!g.parent_id),H=new Map;return u.filter(g=>g.parent_id).forEach(g=>{const M=g.parent_id;H.has(M)||H.set(M,[]),H.get(M).push(g)}),e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link",onClick:()=>n("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(Je,{size:20})}),e.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(Ze,{post:s,section:"moddi",onUpdate:f,onDelete:R,me:N})}),N&&!z&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:A,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:b,onChange:g=>y(g.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:g=>{const M=g.target;M.style.height="auto",M.style.height=`${Math.min(M.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:L||!b.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:L?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:X.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:X.map(g=>e.jsx(St,{comment:g,replies:H.get(g.id)||[],me:N,section:"moddi",onReply:M=>k(M),onDelete:P,replyingTo:z,replyText:b,onReplyTextChange:y,onReplySubmit:A,posting:L,onCancelReply:()=>{k(null),y("")},repliesMap:H},g.id))})})]})}function Dt({queue:t}){return e.jsx(Ye,{to:`/md/queues/${t.id}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",cursor:"pointer"},onMouseEnter:n=>n.currentTarget.style.background="rgba(255,255,255,0.02)",onMouseLeave:n=>n.currentTarget.style.background="rgba(255,255,255,0.01)",children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,marginBottom:8},children:[t.is_group?e.jsx(dt,{size:18}):e.jsx(Le,{size:18}),e.jsx("strong",{style:{fontSize:16},children:t.name}),t.is_member&&e.jsx("span",{className:"chip",style:{fontSize:11,padding:"2px 8px"},children:"Member"})]}),t.description&&e.jsx("div",{className:"muted",style:{fontSize:14,marginBottom:8},children:t.description}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,fontSize:12},children:[t.owner_avatar_url&&e.jsx("img",{src:t.owner_avatar_url,width:20,height:20,style:{borderRadius:"50%"}}),e.jsxs("span",{className:"muted",children:["by ",t.owner_username,t.member_count!==void 0&&Number(t.member_count)>0&&(Number(t.member_count)===1&&t.first_member_username?` and ${t.first_member_username}`:` & ${t.member_count} others`)]}),e.jsx("span",{className:"muted",children:"•"}),e.jsx("span",{className:"muted",children:new Date(t.created_at*1e3).toLocaleDateString()})]})]})})}function At(){return be({queryKey:["moddi","queues"],queryFn:async()=>{const t=await w(S.moddi.queues);return Array.isArray(t.items)?t.items:[]}})}function Ot(){const t=ve();return Fe({mutationFn:async n=>{var s;return await w(S.moddi.queues,{method:"POST",body:JSON.stringify({name:n.name.trim(),description:((s=n.description)==null?void 0:s.trim())||null,is_group:n.is_group??!1})})},onSuccess:()=>{t.invalidateQueries({queryKey:["moddi","queues"]})}})}function Zt(){const{data:t=[],isLoading:n}=At(),{data:s}=qe(),h=Ot(),{notify:u}=ye(),[v,x]=i.useState(!1),[_,N]=i.useState(""),[d,b]=i.useState(""),y=i.useMemo(()=>s?t.some(k=>k.owner_id===s.id):!1,[s,t]),z=async k=>{if(k.preventDefault(),y){u("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!_.trim()){u("Queue name is required",{variant:"error"});return}h.mutate({name:_.trim(),description:d.trim()||null,is_group:!1},{onSuccess:()=>{u("Queue created!",{variant:"success"}),x(!1),N(""),b("")},onError:L=>{u((L==null?void 0:L.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx("div",{className:"feed-header",children:e.jsx("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:0},children:y?e.jsx("div",{style:{padding:"12px"},children:e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>x(!v),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:"Create a queue!"}),v?e.jsx(He,{size:16}):e.jsx(Ce,{size:16})]}),v&&e.jsx("form",{onSubmit:z,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:_,onChange:k=>N(k.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:d,onChange:k=>b(k.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:k=>{k.stopPropagation(),x(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:h.isPending||y,onClick:k=>k.stopPropagation(),children:h.isPending?"Creating...":"Create"})]})]})})]})})}),e.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("div",{className:"col",style:{gap:0},children:n?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No queues yet. Create one to get started!"}):t.map(k=>e.jsx(Dt,{queue:k},k.id))})})]})}function Ut({beatmapMeta:t,beatmapVersion:n}){const s=i.useRef(null),h=i.useRef(null),[u,v]=i.useState(!1),[x,_]=i.useState(!1),[N,d]=i.useState(0);i.useEffect(()=>{if(s.current&&h.current){const z=s.current.offsetWidth,k=h.current.scrollWidth;d(k),_(k>z)}},[t,n]);const b=t?e.jsxs(e.Fragment,{children:[t.artist," – ",t.title,t.mapper?` (by ${t.mapper})`:"",n?` [${n}]`:""]}):n?`[${n}]`:"Beatmap",y=N>0?Math.max(3,N/50):3;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),e.jsxs("div",{ref:s,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:x?"pointer":"default"},onMouseEnter:()=>x&&v(!0),onMouseLeave:()=>v(!1),children:[e.jsx("span",{ref:h,style:{display:"inline-block",animation:u&&x?`beatmap-marquee ${y}s linear infinite`:"none"},children:b}),u&&x&&e.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:b})]})]})}function Wt({submission:t,canManage:n,onUpdate:s,onDelete:h,isGroup:u=!1}){const[v,x]=i.useState(!1),[_,N]=i.useState(!1),[d,b]=i.useState(null),[y,z]=i.useState(t.beatmapset_id),[k,L]=i.useState(!1),[K,E]=i.useState(!1),[r,c]=i.useState(null),[f,R]=i.useState(!1),[A,P]=i.useState(t.acknowledgments||[]),[X,H]=i.useState(t.acknowledged_by_me||!1),g=i.useRef(null),M=i.useRef(null),W=i.useRef(null),{notify:Y}=ye();i.useEffect(()=>{P(t.acknowledgments||[]),H(t.acknowledged_by_me||!1)},[t.acknowledgments,t.acknowledged_by_me]),i.useEffect(()=>{console.log("[QueueSubmission] Submission data:",{id:t.id,beatmap_url:t.beatmap_url,beatmapset_id:t.beatmapset_id,beatmap_id:t.beatmap_id,beatmap_version:t.beatmap_version})},[t.id]),i.useEffect(()=>{if(!t.beatmap_url||d&&y)return;let o=!1;return(async()=>{try{console.log("[QueueSubmission] Fetching beatmap metadata...",{beatmap_url:t.beatmap_url,existing_beatmapset_id:t.beatmapset_id,existing_beatmap_id:t.beatmap_id});let C;try{C=new URL(t.beatmap_url)}catch(B){console.error("[QueueSubmission] Invalid beatmap URL:",t.beatmap_url,B);return}const se=C.hash.match(/#osu\/(\d+)/),ae=se?se[1]:null;C.hash="";const ne={url:C.toString()};if(ae?ne.beatmap_id=ae:t.beatmap_id&&(ne.beatmap_id=String(t.beatmap_id)),console.log("[QueueSubmission] Resolving beatmap with params:",ne),!o){const B=await w(S.osu.resolveBeatmap+Ve(ne),{requireAuth:!1});console.log("[QueueSubmission] Beatmap resolve response:",B),B.setId&&!y&&(console.log("[QueueSubmission] Setting beatmapset_id from API:",B.setId),z(Number(B.setId))),(B.title||B.artist)&&b({title:B.title||null,artist:B.artist||null,mapper:B.mapper||null})}}catch(C){console.error("[QueueSubmission] Error fetching beatmap metadata:",C)}})(),()=>{o=!0}},[t.beatmap_url,t.beatmap_id,t.beatmapset_id,d,y]),i.useEffect(()=>{if(!k||!W.current){c(null);return}const o=()=>{if(W.current){const C=W.current.getBoundingClientRect();c({top:C.bottom+8,right:window.innerWidth-C.right})}};return o(),window.addEventListener("resize",o),window.addEventListener("scroll",o,!0),()=>{window.removeEventListener("resize",o),window.removeEventListener("scroll",o,!0)}},[k]),i.useEffect(()=>{if(!_)return;const o=C=>{const se=C.target;g.current&&!g.current.contains(se)&&!se.closest("[data-status-dropdown]")&&N(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[_]),i.useEffect(()=>{if(!k)return;const o=C=>{M.current&&!M.current.contains(C.target)&&W.current&&!W.current.contains(C.target)&&L(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[k]);const te=async o=>{if(!v){x(!0);try{await w(S.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({status:o})});const C={...t,status:o,updated_at:Math.floor(Date.now()/1e3)};s&&s(C),Y("Status updated",{variant:"success"})}catch{Y("Failed to update status",{variant:"error"})}finally{x(!1),N(!1)}}},ee=async()=>{if(!v){x(!0);try{const o=!!t.is_archived;await w(S.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({is_archived:!o})});const C={...t,is_archived:o?0:1,updated_at:Math.floor(Date.now()/1e3)};s&&s(C),Y(o?"Unarchived":"Archived",{variant:"success"})}catch{Y("Failed to update archive status",{variant:"error"})}finally{x(!1)}}},de=async()=>{if(confirm("Are you sure you want to delete this submission? This action cannot be undone.")&&!v){x(!0);try{await w(S.moddi.queueSubmissionDelete(String(t.queue_id),t.id),{method:"DELETE"}),Y("Submission deleted",{variant:"success"}),h&&h(t.id)}catch{Y("Failed to delete submission",{variant:"error"})}finally{x(!1)}}},pe=async()=>{if(!f){R(!0);try{if(X){if(await w(S.moddi.queueSubmissionUnacknowledge(String(t.queue_id),t.id),{method:"DELETE"}),H(!1),Y("Unacknowledged",{variant:"info"}),s){const o={...t,acknowledged_by_me:!1};s(o)}}else if(await w(S.moddi.queueSubmissionAcknowledge(String(t.queue_id),t.id),{method:"POST"}),H(!0),Y("Acknowledged",{variant:"success"}),s){const o={...t,acknowledged_by_me:!0};s(o)}}catch{Y("Failed to update acknowledgment",{variant:"error"})}finally{R(!1)}}},O={unchecked:"#f59e0b",accepted:"#10b981",denied:"#ef4444",finished:"#6366f1"},Q={unchecked:"Pending",accepted:"Accepted",denied:"Denied",finished:"Finished"},$=y||t.beatmapset_id,q=$?`https://assets.ppy.sh/beatmaps/${$}/covers/card.jpg`:null;i.useEffect(()=>{q?console.log("[QueueSubmission] Background image URL:",q,"for beatmapset_id:",$):console.log("[QueueSubmission] No background image URL - beatmapset_id:",$,"submission.beatmapset_id:",t.beatmapset_id)},[q,$,t.beatmapset_id]);const G=!!t.is_archived;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"relative",borderRadius:12,overflow:"hidden",borderBottom:"1px solid rgba(255,255,255,0.06)",background:q?"transparent":"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",opacity:G?.6:1},onMouseEnter:o=>{q||(o.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)")},onMouseLeave:o=>{q||(o.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)")},children:[q&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:q,alt:"",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover",opacity:.35,zIndex:0,pointerEvents:"none"},onError:o=>{o.currentTarget.style.display="none"}}),e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.75) 100%)",zIndex:0}})]}),e.jsx("div",{style:{position:"relative",zIndex:1,padding:"16px"},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",justifyContent:"space-between",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[t.beatmap_url&&e.jsx("div",{style:{marginBottom:8},children:e.jsx(Ut,{beatmapMeta:d,beatmapVersion:t.beatmap_version})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,marginTop:8},children:[t.avatar_url&&e.jsx("img",{src:t.avatar_url,width:24,height:24,style:{borderRadius:"50%"},alt:t.username}),e.jsx("span",{style:{fontSize:13},children:t.username}),e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(t.created_at*1e3).toLocaleDateString()})]}),t.message&&e.jsxs("div",{style:{marginTop:12,padding:10,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,fontSize:13,lineHeight:1.5},children:[e.jsx("div",{className:"muted",style:{fontSize:11,marginBottom:4,fontWeight:600},children:"Message:"}),t.message]}),A&&A.length>0&&e.jsxs("div",{style:{marginTop:12,padding:8,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6,fontSize:12},children:[e.jsx("div",{className:"muted",style:{fontSize:11,marginBottom:6,fontWeight:600},children:"Acknowledged by:"}),e.jsxs("div",{className:"row",style:{flexWrap:"wrap",gap:6,alignItems:"center"},children:[A.slice(0,5).map(o=>e.jsxs("div",{className:"row",style:{alignItems:"center",gap:4},children:[o.avatar_url&&e.jsx("img",{src:o.avatar_url,width:20,height:20,style:{borderRadius:"50%"},alt:o.username}),e.jsx("span",{style:{fontSize:11,color:"var(--text)"},children:o.username})]},o.user_id)),A.length>5&&e.jsxs("span",{className:"muted",style:{fontSize:11},children:["+",A.length-5," more"]})]})]}),t.beatmap_url&&e.jsx("div",{style:{marginTop:12,display:"flex",alignItems:"center",gap:8},children:e.jsxs("button",{ref:W,className:"chip-btn link",onClick:o=>{o.preventDefault(),o.stopPropagation(),L(C=>!C)},title:"Beatmap options","aria-label":"Beatmap options",style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 12px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:6,color:"var(--text)",fontSize:13,cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:o=>{o.currentTarget.style.background="rgba(255,255,255,0.1)",o.currentTarget.style.borderColor="rgba(255,255,255,0.2)"},onMouseLeave:o=>{o.currentTarget.style.background="rgba(255,255,255,0.05)",o.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[e.jsx(De,{size:14}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),e.jsx(Ce,{size:12,style:{marginLeft:4,opacity:.7}})]})})]}),n?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("button",{className:"icon-link",onClick:pe,disabled:f||v,title:X?"Unacknowledge":"Acknowledge",style:{color:X?"#10b981":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:X?"rgba(16, 185, 129, 0.1)":"transparent"},onMouseEnter:o=>{!f&&!v&&(o.currentTarget.style.background=X?"rgba(16, 185, 129, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:o=>{o.currentTarget.style.background=X?"rgba(16, 185, 129, 0.1)":"transparent"},children:e.jsx(ct,{size:16})}),e.jsx("button",{className:"icon-link",onClick:ee,disabled:v,title:G?"Unarchive":"Archive",style:{color:G?"#6366f1":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:G?"rgba(99, 102, 241, 0.1)":"transparent"},onMouseEnter:o=>{v||(o.currentTarget.style.background=G?"rgba(99, 102, 241, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:o=>{o.currentTarget.style.background=G?"rgba(99, 102, 241, 0.1)":"transparent"},children:G?e.jsx(ut,{size:16}):e.jsx(mt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:de,disabled:v,title:"Delete submission",style:{color:"var(--danger)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:"transparent"},onMouseEnter:o=>{v||(o.currentTarget.style.background="rgba(239, 68, 68, 0.1)")},onMouseLeave:o=>{o.currentTarget.style.background="transparent"},children:e.jsx(ze,{size:16})}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("button",{ref:g,onClick:()=>N(!_),disabled:v,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:O[t.status]+"15",border:`1.5px solid ${O[t.status]}50`,color:O[t.status],whiteSpace:"nowrap",cursor:v?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:v?.6:1},onMouseEnter:o=>{v||(o.currentTarget.style.background=O[t.status]+"25",o.currentTarget.style.borderColor=O[t.status]+"70",o.currentTarget.style.transform="translateY(-1px)")},onMouseLeave:o=>{o.currentTarget.style.background=O[t.status]+"15",o.currentTarget.style.borderColor=O[t.status]+"50",o.currentTarget.style.transform="translateY(0)"},children:[e.jsx("span",{children:Q[t.status]}),e.jsx(Ce,{size:14,style:{marginLeft:2,transition:"transform 0.2s ease",transform:_?"rotate(180deg)":"rotate(0deg)"}})]}),_&&g.current&&Ge.createPortal(e.jsx("div",{"data-status-dropdown":!0,style:{position:"fixed",background:"var(--panel)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:6,zIndex:1e4,minWidth:140,boxShadow:"0 8px 24px rgba(0,0,0,0.4)",...(()=>{const o=g.current.getBoundingClientRect();return{top:o.bottom+6,right:window.innerWidth-o.right}})()},onClick:o=>o.stopPropagation(),children:["unchecked","accepted","denied","finished"].map(o=>e.jsx("button",{onClick:()=>te(o),style:{display:"block",width:"100%",padding:"8px 12px",borderRadius:6,fontSize:13,fontWeight:o===t.status?600:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",textAlign:"left",background:o===t.status?O[o]+"15":"transparent",color:o===t.status?O[o]:"var(--text)",border:"none",cursor:"pointer",transition:"all 0.15s ease",marginBottom:2},onMouseEnter:C=>{o!==t.status&&(C.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:C=>{o!==t.status&&(C.currentTarget.style.background="transparent")},children:Q[o]},o))}),document.body)]})]}):e.jsx("span",{style:{display:"inline-flex",alignItems:"center",padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:O[t.status]+"15",border:`1.5px solid ${O[t.status]}50`,color:O[t.status],whiteSpace:"nowrap"},children:Q[t.status]})]})})]}),k&&r&&t.beatmap_url&&e.jsxs("div",{ref:M,style:{position:"fixed",top:r.top,right:r.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>L(!1),children:[e.jsx(De,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),$&&e.jsx("button",{className:"menu-item",onClick:()=>{E(!0),L(!1)},children:"Preview"})]}),K&&$&&e.jsx(et,{open:K,onClose:()=>E(!1),downloadUrl:`${wt}${S.osu.downloadBeatmapset($)}`,beatmapId:t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0})]})}const $e=({content:t})=>e.jsx("div",{style:{fontSize:13,lineHeight:1.6,color:"var(--text)"},children:e.jsx(ft,{components:{p:({children:n})=>e.jsx("p",{style:{margin:"0 0 8px 0"},children:n}),ul:({children:n})=>e.jsx("ul",{style:{margin:"0 0 8px 0",paddingLeft:20},children:n}),ol:({children:n})=>e.jsx("ol",{style:{margin:"0 0 8px 0",paddingLeft:20},children:n}),li:({children:n})=>e.jsx("li",{style:{margin:"0 0 4px 0"},children:n}),strong:({children:n})=>e.jsx("strong",{style:{fontWeight:600},children:n}),em:({children:n})=>e.jsx("em",{children:n}),code:({children:n})=>e.jsx("code",{style:{background:"rgba(255,255,255,0.1)",padding:"2px 4px",borderRadius:4,fontSize:12},children:n}),h1:({children:n})=>e.jsx("h1",{style:{fontSize:18,fontWeight:700,margin:"0 0 8px 0"},children:n}),h2:({children:n})=>e.jsx("h2",{style:{fontSize:16,fontWeight:700,margin:"0 0 8px 0"},children:n}),h3:({children:n})=>e.jsx("h3",{style:{fontSize:14,fontWeight:600,margin:"0 0 8px 0"},children:n})},children:t})});function es(){const{id:t}=Ke(),n=Pe(),[s,h]=i.useState(null),[u,v]=i.useState([]),[x,_]=i.useState([]),[N,d]=i.useState(!0),[b,y]=i.useState(null),[z,k]=i.useState(!1),[L,K]=i.useState(!1),[E,r]=i.useState(""),[c,f]=i.useState(""),[R,A]=i.useState(null),[P,X]=i.useState(!1),[H,g]=i.useState(""),[M,W]=i.useState(""),[Y,te]=i.useState(""),[ee,de]=i.useState(!1),[pe,O]=i.useState(!1),[Q,$]=i.useState("general"),[q,G]=i.useState(!1),[o,C]=i.useState(!1),[se,ae]=i.useState(null),[ce,ne]=i.useState(""),[B,ue]=i.useState([]),[he,oe]=i.useState(!1),re=i.useRef(null),ge=i.useRef(null),xe=i.useRef(null),[fe,je]=i.useState([]),[Se,we]=i.useState(!1),[j,T]=i.useState(null),{notify:m}=ye(),{queueStatusFilters:F}=Ee(),U=async()=>{var a,p;if(t){d(!0);try{const l=await w(S.moddi.queue(t),{requireAuth:!1});h(l.queue||null),v(l.members||[]),_(l.submissions||[])}catch(l){(a=l==null?void 0:l.message)!=null&&a.includes("403")||(p=l==null?void 0:l.message)!=null&&p.includes("Forbidden")?(m("You do not have access to this queue",{variant:"error"}),n("/md/queues")):m("Failed to load queue",{variant:"error"})}finally{d(!1)}}};i.useEffect(()=>{U(),w(S.auth.me,{requireAuth:!1}).then(a=>y(a)).catch(()=>{})},[t]);const I=b&&s&&(s.owner_id===b.id||u.some(a=>a.user_id===b.id&&a.joined_at));b&&u.some(a=>a.user_id===b.id&&a.joined_at);const V=b&&s&&(s.owner_id===b.id||u.some(a=>a.user_id===b.id&&a.joined_at)),ke=async a=>{if(a.preventDefault(),!s||s.is_open===0){m("Queue is closed for submissions",{variant:"error"});return}if(!E.trim()){m("Beatmap URL is required",{variant:"error"});return}K(!0);try{await w(S.moddi.queueSubmit(t),{method:"POST",body:JSON.stringify({beatmap_url:E.trim(),message:c.trim()||null})}),m("Submission created!",{variant:"success"}),k(!1),r(""),f(""),U()}catch(p){m((p==null?void 0:p.message)||"Failed to create submission",{variant:"error"})}finally{K(!1)}},Z=a=>{_(p=>p.map(l=>l.id===a.id?a:l)),a.acknowledged_by_me!==void 0&&U()},me=()=>{s&&(g(s.name),W(s.description||""),te(s.rules||""),X(!0),$("general"))},le=()=>{X(!1),g(""),W(""),te("")},ie=async()=>{if(!(!s||!V)){O(!0);try{const a=s.is_open!==1;await w(S.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_open:a})}),m(`Queue ${a?"opened":"closed"}`,{variant:"success"}),U()}catch(a){m((a==null?void 0:a.message)||"Failed to update status",{variant:"error"})}finally{O(!1)}}},_e=async a=>{if(a.preventDefault(),!s||!H.trim()){m("Queue name is required",{variant:"error"});return}G(!0);try{const p=u.filter(l=>l.user_id!==s.owner_id&&l.role!=="owner").length>0;await w(S.moddi.queue(t),{method:"PATCH",body:JSON.stringify({name:H.trim(),description:M.trim()||null,rules:Y.trim()||null,is_group:p})}),m("Queue updated!",{variant:"success"}),le(),U()}catch(p){m((p==null?void 0:p.message)||"Failed to update queue",{variant:"error"})}finally{G(!1)}};i.useEffect(()=>{if(!ce.trim()){ue([]),oe(!1);return}const a=setTimeout(async()=>{try{const l=(await w(S.moddi.usersSearch(ce),{requireAuth:!1})).items||[];ue(l),oe(l.length>0)}catch(p){console.error("Search failed:",p),ue([]),oe(!1)}},300);return()=>clearTimeout(a)},[ce]);const Ie=async a=>{if(!o){C(!0);try{await w(S.moddi.queueInvite(t),{method:"POST",body:JSON.stringify({user_id:a})}),m("Invite sent!",{variant:"success"}),ne(""),ue([]),oe(!1),U()}catch(p){m((p==null?void 0:p.message)||"Failed to invite member",{variant:"error"})}finally{C(!1)}}},Me=async()=>{if(!(!t||!I))try{const a=await w(S.moddi.queueBlockedUsers(t));je(a.blocked||[])}catch(a){console.error("Failed to load blocked users:",a)}},tt=async a=>{if(!(!t||Se)&&confirm("Block this user from submitting to this queue?")){we(!0);try{await w(S.moddi.queueBlockUser(t),{method:"POST",body:JSON.stringify({user_id:a})}),m("User blocked",{variant:"success"}),Me(),ne(""),ue([]),oe(!1)}catch(p){m((p==null?void 0:p.message)||"Failed to block user",{variant:"error"})}finally{we(!1)}}},Be=async a=>{if(!(!t||j===a)){T(a);try{await w(S.moddi.queueUnblockUser(t,a),{method:"DELETE"}),m("User unblocked",{variant:"success"}),Me()}catch(p){m((p==null?void 0:p.message)||"Failed to unblock user",{variant:"error"})}finally{T(null)}}};i.useEffect(()=>{Q==="members"&&I&&t&&Me()},[Q,I,t]);const st=async()=>{if(s&&confirm(`Are you sure you want to delete "${s.name}"? This action cannot be undone.`)){de(!0);try{await w(S.moddi.queue(t),{method:"DELETE"}),m("Queue deleted",{variant:"success"}),n("/md/queues")}catch(a){m((a==null?void 0:a.message)||"Failed to delete queue",{variant:"error"})}finally{de(!1)}}},at=async a=>{if(!b||!s||b.id!==s.owner_id){m("Only the queue owner can remove members",{variant:"error"});return}if(confirm("Remove this member from the queue?")){ae(a);try{await w(S.moddi.queueMember(t,a),{method:"DELETE"}),m("Member removed",{variant:"success"});const l=u.filter(D=>D.user_id!==a).some(D=>D.user_id!==(s==null?void 0:s.owner_id)&&D.role!=="owner");if(s&&s.is_group===1&&!l)try{await w(S.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after removing last member")}U()}catch(p){m((p==null?void 0:p.message)||"Failed to remove member",{variant:"error"})}finally{ae(null)}}},nt=async()=>{if(b&&confirm("Leave this queue? You will need to be invited again to rejoin.")){ae(b.id);try{await w(S.moddi.queueMember(t,b.id),{method:"DELETE"}),m("Left queue",{variant:"success"});const p=u.filter(l=>l.user_id!==b.id).some(l=>l.user_id!==(s==null?void 0:s.owner_id)&&l.role!=="owner");if(s&&s.is_group===1&&!p)try{await w(S.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after leaving")}n("/md/queues")}catch(a){m((a==null?void 0:a.message)||"Failed to leave queue",{variant:"error"})}finally{ae(null)}}},rt=async a=>{if(confirm("Cancel this invitation?")){ae(a);try{await w(S.moddi.queueMember(t,a),{method:"DELETE"}),m("Invitation canceled",{variant:"success"}),U()}catch(p){m((p==null?void 0:p.message)||"Failed to cancel invitation",{variant:"error"})}finally{ae(null)}}};return i.useEffect(()=>{if(!P)return;const a=p=>{const l=p.target;l.closest(".manage-overlay")||l.closest(".manage-overlay-backdrop")||!l.closest(".manage-popup")&&xe.current&&!xe.current.contains(l)&&le()};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[P]),i.useEffect(()=>{if(!he)return;const a=p=>{const l=p.target;re.current&&!re.current.contains(l)&&ge.current&&!ge.current.contains(l)&&oe(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[he]),N?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):s?e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:12,marginBottom:16,paddingTop:16},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flex:1,minWidth:0},children:[e.jsx("button",{className:"icon-link",onClick:()=>n("/md/queues"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(Je,{size:20})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:10,flex:1,minWidth:0},children:[e.jsx("div",{className:"title",style:{flex:1,minWidth:0},children:s.name}),V&&e.jsxs("button",{onClick:ie,disabled:pe,className:`queue-status-badge ${s.is_open===1?"status-open":"status-closed"}`,title:s.is_open===1?"Close queue":"Open queue","aria-label":s.is_open===1?"Close queue":"Open queue",children:[s.is_open===1?e.jsx(Re,{size:14}):e.jsx(Ae,{size:14}),e.jsx("span",{children:s.is_open===1?"Open":"Closed"})]})]})]}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[I&&e.jsx("button",{ref:xe,className:"icon-link",onClick:me,style:{width:"auto",height:"auto",padding:"4px"},title:"Manage Queue","aria-label":"Manage Queue",children:e.jsx(pt,{size:18})}),u.length>0&&e.jsx("div",{style:{display:"flex",alignItems:"center",gap:6},children:u.filter(a=>a.joined_at!==null).sort((a,p)=>{const l=a.role==="owner"||a.user_id===(s==null?void 0:s.owner_id),D=p.role==="owner"||p.user_id===(s==null?void 0:s.owner_id);return l&&!D?-1:!l&&D?1:(p.joined_at||0)-(a.joined_at||0)}).map(a=>e.jsxs("div",{style:{position:"relative"},onMouseEnter:()=>A(a.user_id),onMouseLeave:()=>A(null),children:[e.jsx(Ye,{to:`/profile/${a.user_id}`,className:"queue-member-avatar",title:a.username,children:a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:a.username}):e.jsx("div",{style:{width:"100%",height:"100%",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,color:"var(--muted)"},children:a.username.charAt(0).toUpperCase()})}),R===a.user_id&&e.jsxs("div",{className:"queue-member-tooltip",children:[a.username," ",a.role!=="member"?`(${a.role})`:""]})]},a.user_id))})]})]}),s.description&&e.jsx("div",{className:"muted",style:{marginBottom:16,fontSize:14,padding:"0 4px"},children:s.description}),s.rules&&e.jsxs("div",{style:{marginBottom:16,padding:12,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10},children:[e.jsx("div",{style:{fontSize:14,fontWeight:600,marginBottom:8},children:"Rules"}),e.jsx($e,{content:s.rules})]}),s.is_open===0&&e.jsx("div",{style:{marginBottom:12,padding:10,background:"rgba(245, 158, 11, 0.1)",border:"1px solid rgba(245, 158, 11, 0.3)",borderRadius:10,textAlign:"center",fontSize:14,color:"#f59e0b"},children:"This queue is currently closed for submissions"}),e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:12,opacity:s.is_open===0?.6:1},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:s.is_open===1?"pointer":"not-allowed",padding:"8px 12px",minHeight:36},onClick:()=>s.is_open===1&&k(!z),children:[e.jsxs("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:["Submit a beatmap ",s.is_open===0&&"(Closed)"]}),s.is_open===1&&(z?e.jsx(Te,{size:16}):e.jsx(gt,{size:16}))]}),z&&e.jsx("form",{onSubmit:ke,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:E,onChange:a=>r(a.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:c,onChange:a=>f(a.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),c.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[c.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:a=>{a.stopPropagation(),k(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:L,onClick:a=>a.stopPropagation(),children:L?"Submitting...":"Submit"})]})]})})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("div",{className:"col",style:{gap:0},children:x.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No submissions yet."}):x.filter(a=>{const p=!!a.is_archived;return F[a.status]&&(F.archived||!p)}).map(a=>e.jsx(Wt,{submission:a,canManage:!!I,isGroup:(s==null?void 0:s.is_group)===1,onUpdate:Z,onDelete:p=>{_(l=>l.filter(D=>D.id!==p))}},a.id))})}),P&&Ge.createPortal(e.jsxs("div",{className:"overlay manage-overlay",children:[e.jsx("div",{className:"overlay-backdrop manage-overlay-backdrop",onClick:le}),e.jsxs("div",{className:"overlay-card",style:{maxWidth:500},children:[e.jsx("button",{className:"overlay-close",onClick:le,"aria-label":"Close",children:e.jsx(Te,{size:18})}),e.jsxs("div",{className:"col",style:{gap:0,padding:"0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:16,padding:"20px 16px 12px",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("div",{className:"title",style:{fontSize:20,margin:0,padding:0,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Manage Queue"}),e.jsxs("div",{className:"tabs",role:"tablist",style:{margin:0},children:[e.jsx("button",{role:"tab","aria-selected":Q==="general",className:`tab ${Q==="general"?"active":""}`,onClick:()=>$("general"),children:"General"}),e.jsx("button",{role:"tab","aria-selected":Q==="rules",className:`tab ${Q==="rules"?"active":""}`,onClick:()=>$("rules"),children:"Rules"}),e.jsx("button",{role:"tab","aria-selected":Q==="members",className:`tab ${Q==="members"?"active":""}`,onClick:()=>$("members"),children:"Members"})]})]}),e.jsx("hr",{className:"subtle-divider",style:{margin:"0 16px"}}),e.jsxs("form",{onSubmit:_e,className:"col",style:{gap:0,padding:"16px"},children:[Q==="general"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Queue Name"}),e.jsx("input",{type:"text",value:H,onChange:a=>g(a.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}})]}),e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Description (optional)"}),e.jsx("textarea",{placeholder:"Description",value:M,onChange:a=>W(a.target.value),rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"space-between",alignItems:"center",marginTop:8},children:[e.jsxs("button",{type:"button",className:"btn secondary",onClick:st,disabled:ee||q,style:{background:"rgba(248, 113, 113, 0.1)",borderColor:"rgba(248, 113, 113, 0.3)",color:"var(--danger)",fontSize:13,padding:"8px 12px"},children:[e.jsx(ze,{size:14,style:{marginRight:6}}),ee?"Deleting...":"Delete Queue"]}),e.jsxs("div",{className:"row",style:{gap:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:le,disabled:q||ee,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:q||ee,style:{fontSize:13,padding:"8px 16px"},children:q?"Updating...":"Save Changes"})]})]})]}),Q==="rules"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Rules (optional, markdown supported)"}),e.jsx("textarea",{placeholder:"Rules in markdown format...",value:Y,onChange:a=>te(a.target.value),rows:8,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:13,resize:"vertical"}}),Y&&e.jsxs("div",{style:{padding:10,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,fontSize:12},children:[e.jsx("div",{style:{fontSize:12,fontWeight:600,marginBottom:6,opacity:.8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Preview:"}),e.jsx($e,{content:Y})]})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:le,disabled:q||ee,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:q||ee,style:{fontSize:13,padding:"8px 16px"},children:q?"Updating...":"Save Changes"})]})]}),Q==="members"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6,position:"relative"},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invite Members"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{ref:re,type:"text",placeholder:"Search username or ID",value:ce,onChange:a=>ne(a.target.value),onKeyDown:a=>{a.key==="Enter"&&a.preventDefault()},onFocus:()=>{B.length>0&&oe(!0)},style:{width:"100%",background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),he&&B.length>0&&e.jsx("div",{ref:ge,style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,maxHeight:300,overflowY:"auto",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},children:e.jsx("div",{className:"col",style:{gap:0},children:B.map(a=>{const p=u.some(J=>J.user_id===a.id&&J.joined_at),l=u.some(J=>J.user_id===a.id&&J.invited_at&&!J.joined_at),D=fe.some(J=>J.user_id===a.id);return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"8px 12px"},children:[e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:8,minWidth:0},children:[a.avatar_url&&e.jsx("img",{src:a.avatar_url,width:20,height:20,style:{borderRadius:"50%",flexShrink:0}}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontSize:13,fontWeight:500,display:"flex",alignItems:"center",gap:8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("span",{children:a.username}),p&&e.jsx("span",{style:{color:"var(--muted)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Already a member"}),l&&e.jsx("span",{style:{color:"var(--accent)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]}),e.jsxs("div",{className:"muted",style:{fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["id ",a.id," • osu ",a.osu_user_id]})]})]}),I&&!p&&!l&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{className:"icon-link",onClick:J=>{J.stopPropagation(),o||Ie(a.id)},disabled:o,title:"Invite user",style:{width:"auto",height:"auto",padding:"4px"},children:e.jsx(Xe,{size:16})}),e.jsx("button",{className:"icon-link",onClick:J=>{J.stopPropagation(),D?Be(a.id):tt(a.id)},disabled:Se||j===a.id,title:D?"Unblock user":"Block user",style:{width:"auto",height:"auto",padding:"4px",color:D?"var(--accent)":"var(--danger)"},children:D?e.jsx(Re,{size:16}):e.jsx(Ae,{size:16})})]})]},a.id)})})})]})]}),u.length>0&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Members"}),e.jsx("div",{className:"col",style:{gap:4},children:(()=>{const a=u.filter(l=>l.joined_at!==null).sort((l,D)=>{const J=l.role==="owner"||l.user_id===(s==null?void 0:s.owner_id),Ne=D.role==="owner"||D.user_id===(s==null?void 0:s.owner_id);return J&&!Ne?-1:!J&&Ne?1:(D.joined_at||0)-(l.joined_at||0)}),p=u.filter(l=>l.invited_at!==null&&l.joined_at===null);return e.jsxs(e.Fragment,{children:[a.map(l=>{const D=b&&s&&b.id===s.owner_id,J=l.user_id===(b==null?void 0:b.id),Ne=l.user_id===(s==null?void 0:s.owner_id)||l.role==="owner";return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[l.avatar_url&&e.jsx("img",{src:l.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:l.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:l.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:l.role})]})]}),D&&!Ne&&e.jsx("button",{className:"icon-link",onClick:()=>at(l.user_id),disabled:se===l.user_id,title:"Remove member",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(ze,{size:16})}),!D&&J&&e.jsx("button",{className:"icon-link",onClick:nt,disabled:se===l.user_id,title:"Leave queue",style:{width:"auto",height:"auto",padding:"4px",color:"var(--muted)"},children:e.jsx(ht,{size:16})})]},l.user_id)}),p.length>0&&e.jsx(e.Fragment,{children:p.map(l=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",opacity:.7},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[l.avatar_url&&e.jsx("img",{src:l.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:l.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:l.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>rt(l.user_id),disabled:se===l.user_id,title:"Cancel invitation",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(Te,{size:16})})]},l.user_id))})]})})()})]}),I&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Blocked Users"}),fe.length===0?e.jsx("div",{className:"muted",style:{fontSize:12,padding:"8px 0",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"No blocked users"}):e.jsx("div",{className:"col",style:{gap:4},children:fe.map(a=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[a.avatar_url&&e.jsx("img",{src:a.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:a.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:a.username}),a.blocked_by_username&&e.jsxs("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["Blocked by ",a.blocked_by_username]})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>Be(a.user_id),disabled:j===a.user_id,title:"Unblock user",style:{width:"auto",height:"auto",padding:"4px",color:"var(--accent)"},children:e.jsx(Re,{size:16})})]},a.user_id))})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:le,disabled:q||ee,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:q||ee,style:{fontSize:13,padding:"8px 16px"},children:q?"Updating...":"Save Changes"})]})]})]})]})]})]}),document.body),e.jsx("style",{children:`
        .queue-member-avatar {
          width: 32px;
          height: 32px;
          border-radius: 9999px;
          padding: 0;
          border: 1px solid rgba(255,255,255,0.08);
          overflow: hidden;
          cursor: pointer;
          background: transparent;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: border-color 0.2s;
        }
        .queue-member-avatar:hover {
          border-color: rgba(167, 139, 250, 0.4);
        }
        .queue-member-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }
        .queue-member-tooltip {
          position: absolute;
          bottom: calc(100% + 8px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(18, 20, 24, 0.95);
          color: var(--text, #e5e7eb);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 6px;
          padding: 6px 10px;
          font-size: 14px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          pointer-events: none;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
        }
        .queue-member-tooltip::after {
          content: '';
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-top: 5px solid rgba(18, 20, 24, 0.95);
        }
        .queue-status-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
          border: 1px solid;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        }
        .queue-status-badge:disabled {
          cursor: not-allowed;
          opacity: 0.6;
        }
        .queue-status-badge.status-open {
          background: rgba(52, 211, 153, 0.15);
          border-color: rgba(52, 211, 153, 0.4);
          color: #34d399;
        }
        .queue-status-badge.status-open:hover:not(:disabled) {
          background: rgba(52, 211, 153, 0.25);
          border-color: rgba(52, 211, 153, 0.5);
        }
        .queue-status-badge.status-closed {
          background: rgba(245, 158, 11, 0.15);
          border-color: rgba(245, 158, 11, 0.4);
          color: #f59e0b;
        }
        .queue-status-badge.status-closed:hover:not(:disabled) {
          background: rgba(245, 158, 11, 0.25);
          border-color: rgba(245, 158, 11, 0.5);
        }
      `})]}):e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Queue not found"})}function ts(){const{data:t=[],isLoading:n}=Rt(),s=Lt(),h=Pt(),{notify:u}=ye(),v=Pe(),[x,_]=i.useState(new Set),N=async r=>{s.mutate(r,{onSuccess:()=>{}})},d=async r=>{r.startsWith("n:")&&h.mutate(r)},b=async()=>{const r=t.filter(c=>!c.read&&(c.id.startsWith("n:")||c.kind==="system"&&!c.id.startsWith("b:"))).map(c=>c.id);r.length>0&&(await N(r),u("All notifications marked as read",{variant:"success"}))},y=r=>{if(!r)return null;try{const c=JSON.parse(r);if((c==null?void 0:c.type)==="queue_invite"&&(c!=null&&c.queue_id))return c}catch{}return null},z=async(r,c)=>{if(!x.has(r.id)){_(f=>new Set(f).add(r.id));try{await w(S.moddi.queueAccept(String(c)),{method:"POST"}),u("Invitation accepted!",{variant:"success"}),d(r.id),v(`/md/queues/${c}`)}catch(f){u((f==null?void 0:f.message)||"Failed to accept invitation",{variant:"error"})}finally{_(f=>{const R=new Set(f);return R.delete(r.id),R})}}},k=async(r,c)=>{if(!x.has(r.id)){_(f=>new Set(f).add(r.id));try{await w(S.moddi.queueDeny(String(c)),{method:"POST"}),u("Invitation declined",{variant:"success"}),d(r.id)}catch(f){u((f==null?void 0:f.message)||"Failed to decline invitation",{variant:"error"})}finally{_(f=>{const R=new Set(f);return R.delete(r.id),R})}}},L=r=>y(r.text)?e.jsx(Xe,{size:20,color:"#a78bfa"}):r.kind==="star"?e.jsx(yt,{size:20,color:"#f59e0b"}):r.kind==="likes5"?e.jsx(xt,{size:20,color:"#f472b6"}):r.kind==="comment"?e.jsx(Le,{size:20,color:"#60a5fa"}):r.kind==="inspiration"?e.jsx(Le,{size:20,color:"#7dd3fc"}):r.kind==="reaction"?e.jsx(bt,{size:20,color:"#10b981"}):r.id.startsWith("b:")?e.jsx(vt,{size:20,color:"#a78bfa"}):null,K=r=>y(r.text)?"Queue Invitation":r.kind==="star"?"Star":r.kind==="likes5"?"Likes":r.kind==="comment"?"Comment":r.kind==="inspiration"?"Inspiration":r.kind==="reaction"?"Reaction":r.id.startsWith("b:")?"Global":"System",E=t.filter(r=>!r.read&&!(r.id.startsWith("b:")&&r.expiresAt&&r.expiresAt<=Date.now())).length;return e.jsxs("div",{className:"col",style:{width:"100%",maxWidth:700,margin:"0 auto"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{className:"title",children:"Notifications"}),E>0&&e.jsxs("button",{className:"btn secondary",onClick:b,children:[e.jsx(Oe,{size:16,style:{marginRight:6}}),"Mark all read"]})]}),n?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"No notifications yet."}):e.jsx("div",{className:"col",style:{gap:8},children:t.filter(r=>!(r.id.startsWith("b:")&&r.expiresAt&&r.expiresAt<=Date.now())).map(r=>e.jsx("div",{style:{background:r.read?"var(--panel-dark)":"var(--panel)",border:`1px solid ${r.read?"rgba(255,255,255,0.08)":"rgba(125, 211, 252, 0.3)"}`,borderRadius:12,padding:16,cursor:r.videoId?"pointer":"default",opacity:r.read?.7:1},onClick:()=>{!r.read&&r.id.startsWith("n:")&&N([r.id]),r.videoId&&(window.location.hash="/mp/feed")},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12},children:[e.jsx("div",{style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",borderRadius:"50%"},children:L(r)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[e.jsx("strong",{style:{fontSize:14},children:K(r)}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(r.createdAt).toLocaleDateString()}),r.id.startsWith("n:")&&e.jsx("button",{className:"icon-link",onClick:c=>{c.stopPropagation(),d(r.id)},style:{padding:4},children:e.jsx(ze,{size:14})})]})]}),e.jsx("div",{style:{fontSize:14,wordBreak:"break-word"},children:(()=>{const c=y(r.text);return c?`${c.inviter_username} invited you to join queue: ${c.queue_name}`:r.text||(r.kind==="star"?"One of your posts was starred!":r.kind==="likes5"?"One of your posts reached 5 likes!":r.kind==="comment"?"Someone commented on your post":r.kind==="inspiration"?"Someone is inspired by you!":r.kind==="reaction"?"Someone raised their hand on your post!":"")})()}),(()=>{const c=y(r.text);return c&&!x.has(r.id)?e.jsxs("div",{className:"row",style:{gap:8,marginTop:12},children:[e.jsxs("button",{className:"btn",onClick:f=>{f.stopPropagation(),z(r,c.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Oe,{size:14,style:{marginRight:4}}),"Accept"]}),e.jsxs("button",{className:"btn secondary",onClick:f=>{f.stopPropagation(),k(r,c.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Te,{size:14,style:{marginRight:4}}),"Decline"]})]}):c&&x.has(r.id)?e.jsx("div",{className:"muted",style:{fontSize:12,marginTop:8},children:"Processing..."}):null})(),r.read&&r.readAt&&e.jsxs("div",{className:"muted",style:{fontSize:11,marginTop:4},children:["Read ",new Date(r.readAt).toLocaleString()]})]})]})},r.id))})]})}export{qt as C,Xt as M,ts as N,Vt as P,Zt as Q,qe as a,Jt as b,Mt as c,Gt as d,Yt as e,Lt as f,Pt as g,es as h,Ee as u};

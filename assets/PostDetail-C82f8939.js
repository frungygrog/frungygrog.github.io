import{K as F,N as D,r as i,j as o,P as E}from"./vendor-react-Bj2Cd7tG.js";import{P as z}from"./Post-BP0y2fCk.js";import{C as A}from"./Comment-BOe5lOBC.js";import{u as I}from"./index-DN6gLxUg.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-DvUOAkfg.js";import"./beatmap-preview-Ch7r1MMc.js";import"./editor-components-B-SB05wW.js";const p="https://api.osumappi.ng";function H(a){var s;return(s=document.cookie.split("; ").map(e=>e.split("=")).find(([e])=>e===a))==null?void 0:s[1]}function q(){const{uid:a}=F(),s=D(),[e,x]=i.useState(null),[y,b]=i.useState([]),[T,j]=i.useState(!0),[u,w]=i.useState(null),[r,l]=i.useState(""),[f,g]=i.useState(null),[h,v]=i.useState(!1),{notify:d}=I();i.useEffect(()=>{fetch(`${p}/api/me`,{credentials:"include"}).then(t=>t.ok?t.json():null).then(t=>w(t)).catch(()=>{})},[]);const S=async()=>{if(a){j(!0);try{const t=await fetch(`${p}/api/moddiposts/${a}`,{credentials:"include"});if(t.ok){const n=await t.json();x(n)}else d("Failed to load post",{variant:"error"}),s("/md/feed")}catch{d("Failed to load post",{variant:"error"}),s("/md/feed")}finally{j(!1)}}},C=async()=>{if(e!=null&&e.id)try{const t=await fetch(`${p}/api/moddiposts/${e.id}/comments`,{credentials:"include"});if(t.ok){const n=await t.json();b(n.items||[])}}catch{}};i.useEffect(()=>{S()},[a]),i.useEffect(()=>{e!=null&&e.id&&C()},[e==null?void 0:e.id]);const N=t=>{x(t)},R=()=>{s("/md/feed")},k=async t=>{if(t.preventDefault(),!(!r.trim()||!(e!=null&&e.id))){v(!0);try{const n=H("csrf")||"",m=await fetch(`${p}/api/moddiposts/${e.id}/comments`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":n},body:JSON.stringify({text:r.trim(),parent_id:f||void 0})});if(m.ok)l(""),g(null),C(),S(),d("Comment posted!",{variant:"success"});else{const B=await m.json().catch(()=>({}));d(B.error||"Failed to post comment",{variant:"error"})}}catch{d("Failed to post comment",{variant:"error"})}finally{v(!1)}}},$=t=>{b(n=>n.filter(m=>m.id!==t))};if(T)return o.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!e)return o.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const P=y.filter(t=>!t.parent_id),c=new Map;return y.filter(t=>t.parent_id).forEach(t=>{const n=t.parent_id;c.has(n)||c.set(n,[]),c.get(n).push(t)}),o.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[o.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[o.jsx("button",{className:"icon-link",onClick:()=>s("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:o.jsx(E,{size:20})}),o.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),o.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:o.jsx(z,{post:e,section:"moddi",onUpdate:N,onDelete:R,me:u})}),u&&!f&&o.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:o.jsxs("form",{onSubmit:k,style:{display:"flex",alignItems:"flex-end",gap:8},children:[o.jsx("textarea",{placeholder:"Write a comment...",value:r,onChange:t=>l(t.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:t=>{const n=t.target;n.style.height="auto",n.style.height=`${Math.min(n.scrollHeight,120)}px`}}),o.jsx("button",{type:"submit",className:"btn compact",disabled:h||!r.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:h?"...":"Post"})]})}),o.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:P.length===0?o.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):o.jsx("div",{className:"col",style:{gap:0},children:P.map(t=>o.jsx(A,{comment:t,replies:c.get(t.id)||[],me:u,section:"moddi",onReply:n=>g(n),onDelete:$,replyingTo:f,replyText:r,onReplyTextChange:l,onReplySubmit:k,posting:h,onCancelReply:()=>{g(null),l("")}},t.id))})})]})}export{q as default};

var se=Object.defineProperty;var ae=(n,t,e)=>t in n?se(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var O=(n,t,e)=>ae(n,typeof t!="symbol"?t+"":t,e);import{_ as ce}from"./index-B1MAaWze.js";import{r as b,j as q,Z as ie}from"./vendor-react-_vsaDC62.js";import{H as I}from"./vendor-DBgzFpze.js";const de="video-cache",le=2,R="segments",$="manifests",P="video-tracking",ue=7*24*60*60*1e3,Y=500*1024*1024,me=3;let B=null,V=null;function M(){return B?Promise.resolve(B):V||(V=new Promise((n,t)=>{const e=indexedDB.open(de,le);e.onerror=()=>t(e.error),e.onsuccess=()=>{B=e.result,n(B)},e.onupgradeneeded=a=>{const o=a.target.result;a.oldVersion;let s;o.objectStoreNames.contains(R)?s=a.target.transaction.objectStore(R):(s=o.createObjectStore(R,{keyPath:"url"}),s.createIndex("timestamp","timestamp",{unique:!1})),s.indexNames.contains("videoId")||s.createIndex("videoId","videoId",{unique:!1});let c;o.objectStoreNames.contains($)?c=a.target.transaction.objectStore($):(c=o.createObjectStore($,{keyPath:"url"}),c.createIndex("timestamp","timestamp",{unique:!1})),c.indexNames.contains("videoId")||c.createIndex("videoId","videoId",{unique:!1}),o.objectStoreNames.contains(P)||o.createObjectStore(P,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),V)}function fe(n){try{const t=n.match(/videodelivery\.net\/([^\/]+)\//);if(t)return t[1];const e=new URL(n),a=e.pathname.split("/").filter(o=>o);return a.length>0?e.origin+"/"+a[0]:e.origin}catch{return null}}async function Z(n,t=!1,e){const a=performance.now(),o=t?"MANIFEST":"SEGMENT";try{const s=performance.now(),c=await M(),i=performance.now()-s;console.log(`[VIDEO CACHE] IndexedDB initialized in ${i.toFixed(2)}ms`);const d=t?$:R,l=c.transaction([d],"readonly").objectStore(d),m=K(n,t),h=performance.now(),u=l.get(m);return new Promise(E=>{u.onsuccess=()=>{const y=performance.now()-h,S=performance.now()-a,A=u.result;if(!A){console.log(`[VIDEO CACHE] ${o} not found in cache (lookup took ${S.toFixed(2)}ms, request: ${y.toFixed(2)}ms)`),E(null);return}const L=Date.now()-A.timestamp;if(L>ue){console.log(`[VIDEO CACHE] ${o} cache entry expired (age: ${(L/1e3).toFixed(2)}s), deleting`),Q(n,t).catch(()=>{}),E(null);return}console.log(`[VIDEO CACHE] ${o} found in cache (lookup took ${S.toFixed(2)}ms, request: ${y.toFixed(2)}ms, size: ${A.data.byteLength} bytes, age: ${(L/1e3).toFixed(2)}s)`),E(A.data)},u.onerror=()=>{const y=performance.now()-a;console.error(`[VIDEO CACHE] Error looking up ${o} after ${y.toFixed(2)}ms`),E(null)}})}catch(s){const c=performance.now()-a;return console.error(`[VIDEO CACHE] Exception during ${o} lookup after ${c.toFixed(2)}ms:`,s),null}}async function J(n,t,e=!1,a){const o=performance.now(),s=e?"MANIFEST":"SEGMENT";try{const c=performance.now(),i=await M(),d=performance.now()-c,f=e?$:R,m=i.transaction([f],"readwrite").objectStore(f),h=K(n,e),u=a||fe(n),E={url:h,data:t,timestamp:Date.now(),size:t.byteLength,videoId:u||void 0},y=performance.now();await new Promise((w,k)=>{const T=m.put(E);T.onsuccess=()=>{const C=performance.now()-y;console.log(`[VIDEO CACHE] ${s} stored in IndexedDB in ${C.toFixed(2)}ms (size: ${t.byteLength} bytes)`),w()},T.onerror=()=>{const C=performance.now()-y;console.error(`[VIDEO CACHE] Error storing ${s} after ${C.toFixed(2)}ms:`,T.error),k(T.error)}});const S=performance.now();await pe();const A=performance.now()-S;A>10&&console.log(`[VIDEO CACHE] Cache cleanup took ${A.toFixed(2)}ms`);const L=performance.now()-o;console.log(`[VIDEO CACHE] Total ${s} cache write time: ${L.toFixed(2)}ms`)}catch(c){const i=performance.now()-o;console.error(`[VIDEO CACHE] Exception storing ${s} after ${i.toFixed(2)}ms:`,c)}}async function Q(n,t=!1){try{const e=await M(),a=t?$:R,s=e.transaction([a],"readwrite").objectStore(a),c=K(n,t);await new Promise((i,d)=>{const f=s.delete(c);f.onsuccess=()=>i(),f.onerror=()=>d(f.error)})}catch{}}async function he(){try{const n=await M();let t=0;for(const e of[R,$]){const s=n.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{s.onsuccess=()=>{const i=s.result;t+=i.reduce((d,f)=>d+f.size,0),c()},s.onerror=()=>c()})}return t}catch{return 0}}async function pe(){try{const n=await he();if(n<=Y)return;const t=await M(),e=[];for(const o of[R,$]){const s=o===$,d=t.transaction([o],"readonly").objectStore(o).getAll();await new Promise(f=>{d.onsuccess=()=>{const l=d.result;e.push(...l.map(m=>({url:m.url,timestamp:m.timestamp,size:m.size,isManifest:s}))),f()},d.onerror=()=>f()})}e.sort((o,s)=>o.timestamp-s.timestamp);let a=n;for(const o of e){if(a<=Y*.8)break;await Q(o.url,o.isManifest),a-=o.size}}catch{}}async function we(n){try{const a=(await M()).transaction([P],"readwrite").objectStore(P),o={videoId:n,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((s,c)=>{const i=a.put(o);i.onsuccess=()=>s(),i.onerror=()=>c(i.error)})}catch{}}async function Ee(n){try{const o=(await M()).transaction([P],"readonly").objectStore(P).index("lastAccessed");return new Promise(s=>{const c=o.openCursor(null,"prev"),i=[];c.onsuccess=d=>{const f=d.target.result;f&&i.length<n?(i.push(f.value.videoId),f.continue()):s(i)},c.onerror=()=>s([])})}catch{return[]}}async function ge(n){try{const t=await M(),e=await Ee(me),a=new Set([n,...e]);for(const o of[R,$]){const c=t.transaction([o],"readwrite").objectStore(o),i=c.index("videoId"),d=c.getAll();await new Promise(f=>{d.onsuccess=async()=>{const l=d.result;let m=0;for(const h of l)h.videoId&&!a.has(h.videoId)&&await new Promise(u=>{const E=c.delete(h.url);E.onsuccess=()=>{m++,u()},E.onerror=()=>u()});f()},d.onerror=()=>f()})}}catch{}}function ee(n){return n.includes(".m3u8")||n.endsWith("/manifest")}function K(n,t){if(t)try{const e=new URL(n),a=new URLSearchParams(e.search),o=Array.from(a.entries()).sort(([s],[c])=>s.localeCompare(c));return e.search=new URLSearchParams(o).toString(),e.toString()}catch{return n}else try{const e=new URL(n);return e.origin+e.pathname}catch{const e=n.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return e?e[0]:n.split("?")[0]}}const ye=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:ge,getCached:Z,isManifest:ee,normalizeCacheKey:K,setCached:J,trackVideoAccess:we},Symbol.toStringTag,{value:"Module"}));class Se{constructor(){O(this,"cache",new Map);O(this,"maxSize",100);O(this,"maxAge",5*60*1e3)}get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.maxAge?(this.cache.delete(t),null):(this.cache.delete(t),this.cache.set(t,e),e.data):null}set(t,e){if(this.cache.size>=this.maxSize){const a=this.cache.keys().next().value;a&&this.cache.delete(a)}this.cache.set(t,{data:e,timestamp:Date.now()})}clear(){this.cache.clear()}}const W=new Se;class te{constructor(t){O(this,"context",null);O(this,"stats");O(this,"defaultLoader",null);O(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,a){this.context=t;const o=t.url,s=ee(o),c=performance.now(),i=s?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Loading ${i}: ${o} at ${c.toFixed(2)}ms`);let d;try{const u=o.match(/videodelivery\.net\/([^\/]+)\//);u&&(d=u[1])}catch{}const f=performance.now(),l=W.get(o),m=performance.now()-f;if(l){const u=performance.now()-c;console.log(`[CACHE LOADER] ${i} found in memory cache in ${u.toFixed(2)}ms (lookup: ${m.toFixed(2)}ms)`);let E;s?E=new TextDecoder().decode(l):E=l;const y=performance.now();this.stats.loading.start=y,this.stats.loading.first=y,this.stats.loading.end=y,this.stats.loaded=l.byteLength,this.stats.total=l.byteLength,this.stats.aborted=!1;const S={data:E,url:o,code:200};a.onSuccess(S,this.stats,t,{});return}console.log(`[CACHE LOADER] ${i} not in memory cache (lookup took ${m.toFixed(2)}ms), checking IndexedDB`);const h=performance.now();Z(o,s).then(u=>{const E=performance.now()-h;if(u){const y=performance.now()-c;console.log(`[CACHE LOADER] ${i} found in IndexedDB cache in ${y.toFixed(2)}ms (lookup: ${E.toFixed(2)}ms)`),W.set(o,u);let S;s?S=new TextDecoder().decode(u):S=u;const A=performance.now();this.stats.loading.start=A,this.stats.loading.first=A,this.stats.loading.end=A,this.stats.loaded=u.byteLength,this.stats.total=u.byteLength,this.stats.aborted=!1;const L={data:S,url:o,code:200};a.onSuccess(L,this.stats,t,{});return}console.log(`[CACHE LOADER] ${i} not in IndexedDB cache (lookup took ${E.toFixed(2)}ms), fetching from network`),this.fetchFromNetwork(o,s,t,e,a,d)}).catch(u=>{const E=performance.now()-h;console.error(`[CACHE LOADER] IndexedDB lookup error after ${E.toFixed(2)}ms:`,u),this.fetchFromNetwork(o,s,t,e,a,d)})}async fetchFromNetwork(t,e,a,o,s,c){var f;const i=performance.now(),d=e?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Fetching ${d} from network: ${t} at ${i.toFixed(2)}ms`);try{const l=this.abortController||new AbortController,m=await fetch(t,{method:a.method||"GET",headers:a.headers||{},signal:l.signal}).catch(C=>{throw C.name==="AbortError",C});if(!m.ok)throw new Error(`HTTP ${m.status}: ${m.statusText}`);let h;const u=m.headers.get("content-type")||"";e||u.includes("application/vnd.apple.mpegurl")||u.includes("text")?h=await m.text():h=await m.arrayBuffer();const E=performance.now(),y=E-i,S=typeof h=="string"?new TextEncoder().encode(h).length:h.byteLength;console.log(`[CACHE LOADER] ${d} fetched from network in ${y.toFixed(2)}ms, size: ${S} bytes`),this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=E,this.stats.loaded=S,this.stats.total=S,this.stats.aborted=!1;const A=performance.now(),L=h instanceof ArrayBuffer?h:new TextEncoder().encode(h).buffer,w=performance.now();W.set(t,L);const k=performance.now()-w;console.log(`[CACHE LOADER] ${d} stored in memory cache in ${k.toFixed(2)}ms`),J(t,L,e,c).then(()=>{const C=performance.now()-A;console.log(`[CACHE LOADER] ${d} stored in IndexedDB in ${C.toFixed(2)}ms`)}).catch(C=>{console.error(`[CACHE LOADER] Error storing ${d} in IndexedDB:`,C)});const T={data:h,url:m.url,code:m.status};s.onSuccess(T,this.stats,a,{})}catch(l){const m=performance.now();if(this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=m,this.stats.loaded=0,this.stats.total=0,l instanceof Error&&l.name==="AbortError")this.stats.aborted=!0,(f=s.onAbort)==null||f.call(s,this.stats,a,{});else if(!(l instanceof Error&&l.name==="AbortError")){this.stats.aborted=!1;const h=l instanceof Error?l:new Error("Network error");s.onError({code:0,text:h.message},a,{},this.stats)}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=new AbortController)}destroy(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.context=null,this.defaultLoader=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const ve=Object.freeze(Object.defineProperty({__proto__:null,CachedLoader:te,memoryCache:W},Symbol.toStringTag,{value:"Module"})),Le=({playbackUrl:n,streamUID:t,aspectRatio:e,preferNative:a=!1,autoplay:o=!1,loop:s=!1,muted:c=!1,controls:i=!0,onVideoRef:d,onClick:f})=>{const[l,m]=b.useState(1.7777777777777777),h=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;b.useEffect(()=>{if(!h)return;const r=()=>m(window.innerWidth/Math.max(1,window.innerHeight));return r(),window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[h]);const u=b.useRef(null),[E,y]=b.useState(null),S=b.useMemo(()=>{const r=1.3333333333333333,x=16/9,g=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(g)return Math.min(x,Math.max(r,g));const H=h?l:16/9;return Math.min(x,Math.max(r,H))},[h,l,e]),L=`${E??S} / 1`,w=b.useMemo(()=>n||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[n,t]),k=b.useRef(null),T=b.useMemo(()=>{if(!w)return null;try{const r=w.match(/videodelivery\.net\/([^\/]+)\//);return r?r[1]:w}catch{return w}},[w]);b.useEffect(()=>{!w||!T||(ce(async()=>{const{trackVideoAccess:r,clearOldVideoCache:x}=await Promise.resolve().then(()=>ye);return{trackVideoAccess:r,clearOldVideoCache:x}},void 0).then(({trackVideoAccess:r,clearOldVideoCache:x})=>{r(T).catch(()=>{}),k.current&&k.current!==w&&x(T).catch(()=>{})}),k.current=w)},[w,T]),b.useEffect(()=>{y(null)},[w]),b.useEffect(()=>{if(!a||!u.current)return;const r=u.current;let x=!1;const g=()=>{if(!x)if(r.videoWidth>0&&r.videoHeight>0){const H=r.videoWidth/r.videoHeight,j=4/3,z=16/9,X=Math.min(z,Math.max(j,H));y(X),x=!0}else y(S),x=!0};return r.addEventListener("loadedmetadata",g),r.readyState>=1&&g(),()=>{r.removeEventListener("loadedmetadata",g)}},[a,S,w]),b.useEffect(()=>{if(!w)return;let r=null,x=null,g=!1,H=null;const j=()=>{if(document.hidden&&r){const p=u.current;if(p)try{p.pause()}catch{}try{r.stopLoad()}catch{}}},z=()=>{if(g=!0,r){try{r.stopLoad(),r.detachMedia(),r.destroy()}catch{}r=null}};return document.addEventListener("visibilitychange",j),window.addEventListener("beforeunload",z),g||(()=>{const p=u.current;if(!p||g)return;const F=performance.now();if(console.log(`[HLS] Starting HLS setup for ${w} at ${F.toFixed(2)}ms`),I.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const _={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,startFragPrefetch:!0,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3,loader:te};try{const N=performance.now();r=new I(_);const v=performance.now()-N;console.log(`[HLS] HLS instance created in ${v.toFixed(2)}ms`);const D=performance.now();r.loadSource(w);const U=performance.now()-D;console.log(`[HLS] loadSource() called in ${U.toFixed(2)}ms`);const oe=performance.now();r.attachMedia(p);const re=performance.now()-oe;console.log(`[HLS] attachMedia() completed in ${re.toFixed(2)}ms`);const ne=performance.now()-F;console.log(`[HLS] Total HLS setup time: ${ne.toFixed(2)}ms`)}catch(N){const v=performance.now()-F;if(console.error(`[HLS] Failed to initialize HLS after ${v.toFixed(2)}ms:`,N),r){try{r.destroy()}catch{}r=null}return}r.on(I.Events.MANIFEST_PARSED,()=>{const N=performance.now()-F;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${N.toFixed(2)}ms after setup start`),!(g||!p)&&(s&&(H=()=>{if(!(g||!p||!r))try{r.stopLoad(),p.currentTime=0,r.startLoad(),p.play().catch(v=>{v.name!=="AbortError"&&v.name!=="NotAllowedError"&&console.debug("Loop play failed:",v)})}catch{p.currentTime=0,p.play().catch(()=>{})}},p.addEventListener("ended",H)),o&&!g)){const v=performance.now();p.play().then(()=>{const D=performance.now()-v;console.log(`[HLS] Autoplay succeeded in ${D.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(D=>{const U=performance.now()-v;D.name!=="AbortError"&&D.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${U.toFixed(2)}ms:`,D)})}}),r.on(I.Events.ERROR,(N,v)=>{if(!g&&v.fatal)switch(v.type){case I.ErrorTypes.NETWORK_ERROR:if(!g&&r)try{r.startLoad()}catch{}break;case I.ErrorTypes.MEDIA_ERROR:if(!g&&r)try{r.recoverMediaError()}catch{}break;default:r&&(r.destroy(),r=null);break}})}else g||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),p.src=w,x=()=>{g||console.warn("Native HLS playback failed")},p.addEventListener("error",x),o&&!g&&p.play().catch(_=>{_.name!=="AbortError"&&_.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",_)})})(),()=>{g=!0,document.removeEventListener("visibilitychange",j),window.removeEventListener("beforeunload",z);const p=u.current;if(p&&H&&(p.removeEventListener("ended",H),H=null),r){try{r.off(I.Events.MANIFEST_PARSED),r.off(I.Events.ERROR),r.off(I.Events.MEDIA_ATTACHED),r.off(I.Events.MEDIA_DETACHED),r.off(I.Events.MANIFEST_LOADED),r.stopLoad(),r.detachMedia(),r.destroy()}catch{}r=null}if(p){x&&(p.removeEventListener("error",x),x=null);try{p.pause(),p.src="",p.srcObject=null,p.load()}catch{}}}},[w,o]),b.useEffect(()=>{d&&d(u.current)},[d,a,w]);const C="100%",G=h?{width:"100%",maxWidth:C,maxHeight:"100%",aspectRatio:L,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:C,maxHeight:"100%",height:"var(--player-height)",aspectRatio:L,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return w?q.jsx("div",{style:G,children:q.jsx("video",{ref:u,autoPlay:o,loop:!1,muted:c,controls:i,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:f?"pointer":"default"},children:"Your browser does not support the video tag."},w)}):q.jsx("div",{style:G,children:"No video available"})},Te=({open:n,onClose:t,buttonRef:e,children:a,align:o="right",minWidth:s=160})=>{const[c,i]=b.useState(null),d=b.useRef(null);if(b.useEffect(()=>{if(!n||!e.current){i(null);return}const l=()=>{if(!e.current)return;const m=e.current.getBoundingClientRect();i({top:m.bottom+8,[o]:window.innerWidth-m[o==="right"?"right":"left"]})};return l(),window.addEventListener("resize",l),window.addEventListener("scroll",l,!0),()=>{window.removeEventListener("resize",l),window.removeEventListener("scroll",l,!0)}},[n,e,o]),b.useEffect(()=>{if(!n)return;const l=m=>{d.current&&!d.current.contains(m.target)&&e.current&&!e.current.contains(m.target)&&t()};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[n,t,e]),!n||!c)return null;const f=q.jsx("div",{ref:d,style:{position:"fixed",top:c.top,[o]:c[o],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:s,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:a});return ie.createPortal(f,document.body)};export{Le as P,Te as a,ve as h,ye as v};

import{r as a,R as q,j as t,D as ze,E as Pe,L as xe,A as Me,G as Fe,I as Te,p as Ae,J as De,K as Ue,M as ve,w as Be}from"./vendor-react-DRMPtHf0.js";import{P as Oe}from"./Player-BRfwXn_C.js";import{P as Ve}from"./beatmap-preview-Cn-wWWdw.js";import{u as He}from"./index-Czi0WKlo.js";import"./vendor-Dm_EoMJn.js";import"./editor-lib-1S8E8MTP.js";import"./editor-components-B-NcqUmU.js";const f="https://api.osumappi.ng",x={};function Ye(){var we,ge;const[R,_]=a.useState(x.history||[]),[u,C]=a.useState(x.index||-1),n=u>=0?R[u]:null,[ie,ae]=a.useState(!1),[ye,oe]=a.useState(!1),[je,re]=a.useState(!1),[W,A]=a.useState(!1),X=q.useRef(null),[J,G]=a.useState(!1),K=q.useRef(null),[E,ke]=a.useState(null),[D,M]=a.useState(!1),[Q,U]=a.useState(!1),Y=q.useRef(null),I=q.useRef(null),[Z,Se]=a.useState(null),{notify:j}=He(),[B,ee]=a.useState(!0),te=a.useRef(null),[g,$]=a.useState(x.queue||[]),v=a.useRef(x.seenIds||new Set),ce=a.useRef(new Set),ne=a.useRef(!1),le=a.useRef(null),[de,L]=a.useState(x.eligibleCount||null),[ue,z]=a.useState(x.viewedCount||0),[O,N]=a.useState(!1),[k,Ne]=a.useState(()=>typeof window>"u"?!1:window.matchMedia("(max-width: 600px), (pointer: coarse)").matches);a.useEffect(()=>()=>{x.history=R,x.index=u,x.queue=g,x.seenIds=v.current,x.eligibleCount=de,x.viewedCount=ue},[R,u,g,de,ue]);function F(e){var s;return(s=document.cookie.split("; ").map(i=>i.split("=")).find(([i])=>i===e))==null?void 0:s[1]}function Re(){try{const e=Array.from(v.current).slice(-200);localStorage.setItem("feed_seen_ids",JSON.stringify(e))}catch{}}function S(){try{const e=localStorage.getItem("filter_modes"),s=(e?String(e):"standard").toLowerCase().split(",").map(r=>r.trim()).filter(Boolean),i=["standard","taiko","mania","catch"],o=Array.from(new Set(s.filter(r=>i.includes(r))));return o.length?o:["standard"]}catch{return["standard"]}}const fe=async(e=3)=>{if(ne.current)return[];ne.current=!0;try{const s=async()=>{const d=[];for(let y=0;y<e;y++)try{const m=Array.from(v.current).slice(-200),l=S().join(","),h=await fetch(`${f}/api/feed/next?exclude=${encodeURIComponent(m.join(","))}&modes=${encodeURIComponent(l)}`,{credentials:"include"});if(h.status===401){re(!0);break}if(h.status===429){j("Please slow down a bit.",{durationMs:3e3,variant:"warn"});break}if(!h.ok)break;const w=await h.json(),P=w&&(w.id?w:w.video);if(!P)break;d.push(P)}catch{break}return d};if(le.current===!1){const d=await s(),y=new Set(g.map(l=>l.id)),m=d.filter(l=>!v.current.has(l.id)&&!y.has(l.id));if(m.length>0&&$(l=>[...l,...m]),m.length===0&&g.length===0)try{const l=S().join(","),h=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(l)}`,{credentials:"include"});if(h.ok){const w=await h.json();L(Number(w.eligible||0)),z(Number(w.viewed||0)),N(!!w.caught_up)}}catch{}return m}const i=Array.from(v.current).slice(-200),o=S().join(","),r=await fetch(`${f}/api/feed/batch?size=${e}&exclude=${encodeURIComponent(i.join(","))}&modes=${encodeURIComponent(o)}`,{credentials:"include"});if(r.status===401)return re(!0),[];if(r.status===429)return j("Please slow down a bit.",{durationMs:4e3,variant:"warn"}),[];if(r.status===404){le.current=!1;const d=await s(),y=new Set(g.map(l=>l.id)),m=d.filter(l=>!v.current.has(l.id)&&!y.has(l.id));if(m.length>0&&$(l=>[...l,...m]),m.length===0&&g.length===0)try{const l=S().join(","),h=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(l)}`,{credentials:"include"});if(h.ok){const w=await h.json(),P=Number(w.eligible||0),be=Number(w.viewed||0);L(P),z(be);const Le=P>0&&be>=P;N(Le)}}catch{}return m}const c=await r.json(),p=c&&Array.isArray(c.items)?c.items:[],b=new Set,se=p.filter(d=>b.has(d.id)?!1:(b.add(d.id),!0)),$e=new Set(g.map(d=>d.id)),H=se.filter(d=>!v.current.has(d.id)&&!$e.has(d.id));if(H.length>0&&$(d=>[...d,...H]),H.length===0&&g.length===0)try{const d=S().join(","),y=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(d)}`,{credentials:"include"});if(y.ok){const m=await y.json(),l=Number(m.eligible||0),h=Number(m.viewed||0);L(l),z(h);const w=l>0&&h>=l;N(w)}}catch{}return H}catch{return[]}finally{ne.current=!1}},V=async()=>{if(!ie){ae(!0);try{let e=[];g.length===0&&(e=await fe(3));let s;if(g.length>0?(s=g[0],$(i=>i.slice(1))):e.length>0&&(s=e[0],e.length>1&&$(i=>[...i,...e.slice(1)])),s){if(v.current.add(s.id),Re(),_(i=>{const o=[...i.slice(0,u+1),s];return C(o.length-1),o}),!ce.current.has(s.id)){ce.current.add(s.id);const i=F("csrf")||"";try{const o=await fetch(`${f}/api/videos/${s.id}/view`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":i}});if(o.ok){const r=await o.json();r&&_(c=>{const p=[...c],b=p.findIndex(se=>se.id===s.id);return b!==-1&&(p[b]={...p[b],views_count:r.views_count??p[b].views_count??0,viewed_by_me:!0}),p})}}catch{}}}else try{const i=S().join(","),o=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(i)}`,{credentials:"include"});if(o.ok){const r=await o.json(),c=Number(r.eligible||0),p=Number(r.viewed||0);L(c),z(p);const b=c>0&&p>=c;N(b)}}catch{}g.length<=1&&fe(3)}finally{ae(!1)}}},_e=()=>{u>0&&(C(u-1),M(!1))},Ce=()=>{if(u<R.length-1){C(u+1),M(!1);return}O||V()},T=()=>{k&&(ee(!0),te.current&&window.clearTimeout(te.current),te.current=window.setTimeout(()=>ee(!1),1800))};a.useEffect(()=>{const e=()=>{const s=window.matchMedia("(max-width: 600px), (pointer: coarse)").matches;Ne(s),s||ee(!0)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Ee=async()=>{if(n){oe(!0);try{const e=F("csrf")||"",s=n.liked_by_me?"DELETE":"POST",i=await fetch(`${f}/api/videos/${n.id}/like`,{method:s,credentials:"include",headers:{"X-CSRF-Token":e}});if(i.status===429){j("Please slow down a bit.",{durationMs:5e3,variant:"warn"});return}if(i.ok){const o=await i.json();_(r=>{const c=[...r];return c[u]={...c[u],liked_by_me:!n.liked_by_me,likes_count:o.likes_count},c})}}finally{oe(!1)}}};async function me(e){if(!n)return;const s=F("csrf")||"";(await fetch(`${f}/api/videos/${n.id}/flag`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":s},body:JSON.stringify({reason:e})})).ok?j("Thanks for your report.",{variant:"info"}):j("Report failed",{variant:"error"}),A(!1)}a.useEffect(()=>{if(!W)return;const e=s=>{X.current&&!X.current.contains(s.target)&&A(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[W]),a.useEffect(()=>{if(!J)return;const e=s=>{K.current&&!K.current.contains(s.target)&&G(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[J]),a.useEffect(()=>{if(!Q||!I.current)return;const e=()=>{if(I.current){const i=I.current.getBoundingClientRect();Se({top:i.bottom+8,right:window.innerWidth-i.right})}};e(),window.addEventListener("resize",e),window.addEventListener("scroll",e,!0);const s=i=>{Y.current&&!Y.current.contains(i.target)&&I.current&&!I.current.contains(i.target)&&U(!1)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s),window.removeEventListener("resize",e),window.removeEventListener("scroll",e,!0)}},[Q]),a.useEffect(()=>{R.length===0&&V()},[]),a.useEffect(()=>{(async()=>{try{const e=S().join(","),s=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(e)}`,{credentials:"include"});if(s.ok){const i=await s.json(),o=Number(i.eligible||0),r=Number(i.viewed||0);L(o),z(r);const c=o>0&&r>=o;N(c)}}catch{}})()},[]),a.useEffect(()=>{const e=()=>{_([]),$([]),v.current.clear(),C(-1),N(!1),(async()=>{try{const s=S().join(","),i=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(s)}`,{credentials:"include"});if(i.ok){const o=await i.json(),r=Number(o.eligible||0),c=Number(o.viewed||0);L(r),z(c),N(!1)}}catch{}V()})()};return window.addEventListener("filterchange",e),()=>window.removeEventListener("filterchange",e)},[]),a.useEffect(()=>{try{const e=localStorage.getItem("feed_seen_ids");if(e){const s=JSON.parse(e);if(Array.isArray(s))for(const i of s)typeof i=="number"&&v.current.add(i)}}catch{}},[]),a.useEffect(()=>{(async()=>{try{const e=await fetch(`${f}/api/me`,{credentials:"include"});e.ok&&ke(await e.json())}catch{}})()},[]),a.useEffect(()=>{M(!1)},[n==null?void 0:n.id]);const pe=!!(E!=null&&E.is_admin||E!=null&&E.is_mod);async function Ie(){if(!n)return;const e=F("csrf")||"",s=!n.is_starred,i=s?"star":"unstar";(await fetch(`${f}/api/admin/videos/${n.id}/${i}`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":e}})).ok?(_(r=>{const c=[...r];return c[u]={...c[u],is_starred:s},c}),G(!1),j(s?"Post starred":"Star removed",{variant:"success"})):j("Action failed",{variant:"error"})}async function he(){if(!n||!confirm("Permanently delete this video?"))return;const e=F("csrf")||"";(await fetch(`${f}/api/videos/${n.id}`,{method:"DELETE",credentials:"include",headers:{"X-CSRF-Token":e}})).ok?(j("Deleted",{variant:"warn"}),A(!1),_(i=>{const o=i.filter((r,c)=>c!==u);return o.length===0?(C(-1),setTimeout(V,0)):C(r=>Math.max(0,Math.min(r,o.length-1))),o})):alert("Delete failed")}return t.jsxs("div",{className:"player-wrap",style:{height:"100%",display:"flex",flexDirection:"column"},children:[O&&t.jsx("div",{className:"chip info",style:{alignSelf:"center",marginBottom:8},children:"You're all caught up. Check 'Feed' to watch videos you've seen already."}),t.jsx("button",{className:"nav-arrow left",onClick:()=>{T(),_e()},disabled:u<=0,"aria-label":"Previous",style:{opacity:k&&!B?0:1,pointerEvents:k&&!B?"none":"auto"},children:t.jsx(ze,{size:22})}),t.jsx("button",{className:"nav-arrow right",onClick:()=>{T(),Ce()},disabled:ie||O&&u>=R.length-1,"aria-label":"Next",style:{opacity:k&&!B?0:1,pointerEvents:k&&!B?"none":"auto"},children:t.jsx(Pe,{size:22})}),t.jsx("div",{className:"video-area",onMouseMove:k?T:void 0,onPointerDown:k?T:void 0,onTouchStart:k?T:void 0,children:je?t.jsxs("div",{className:"col",style:{alignItems:"center"},children:[t.jsx("div",{className:"muted",style:{marginBottom:8},children:"Please log in to view videos."}),t.jsx("button",{className:"btn",onClick:()=>window.location.href=`${f}/api/auth/login`,children:"Login with osu!"})]}):n?t.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",minHeight:D?"500px":"auto",maxHeight:D?"calc(70vh + 64px)":"70vh",width:"100%",maxWidth:D?"100%":"min(900px, 100%)",overflow:"hidden",boxSizing:"border-box",position:"relative"},children:D&&n.beatmapset_id?t.jsx("div",{style:{width:"100%",maxWidth:"min(900px, 100%)",height:"100%",maxHeight:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0,margin:"0 auto"},children:t.jsx(Ve,{downloadUrl:`${f}/api/osu/beatmapsets/${n.beatmapset_id}/download?noVideo=1`,beatmapId:n.beatmap_id??void 0,beatmapVersion:n.beatmap_version??void 0,onOpenInEditor:()=>{M(!1),window.location.hash="/editor"}})}):t.jsx(Oe,{streamUID:n.stream_uid,playbackUrl:n.playback_url,aspectRatio:n!=null&&n.width&&(n!=null&&n.height)?n.width/n.height:16/9})}):O?null:t.jsx("div",{className:"muted",children:"No videos yet"})}),t.jsx("div",{className:"info-area",children:n&&t.jsxs("div",{className:"section-panel",children:[t.jsxs("div",{className:"row-between",children:[t.jsxs("div",{className:"row",style:{alignItems:"center"},children:[t.jsx(xe,{to:`/profile/${(we=n.uploader)==null?void 0:we.id}`,style:{display:"inline-flex",alignItems:"center",textDecoration:"none",color:"inherit"},children:((ge=n.uploader)==null?void 0:ge.avatar_url)&&t.jsx("img",{src:n.uploader.avatar_url,width:32,height:32,style:{borderRadius:"50%"}})}),(()=>{var r,c,p,b;const e=(r=n.uploader)==null?void 0:r.is_admin,s=(c=n.uploader)==null?void 0:c.is_mod,i=e?"#fff3bf":s?"#d7fbe8":void 0,o=t.jsxs(t.Fragment,{children:[t.jsxs("strong",{className:"one-line",style:{color:i,display:"inline-flex",alignItems:"center",gap:6},children:[(p=n.uploader)==null?void 0:p.username,n.is_starred?t.jsx(Me,{size:14,color:"#f59e0b",title:"Starred"}):null]}),(e||s)&&t.jsx(Fe,{size:14,color:i,style:{marginLeft:6},title:e?"admin":"mod"})]});return t.jsx(xe,{to:`/profile/${(b=n.uploader)==null?void 0:b.id}`,style:{textDecoration:"none",color:"inherit",display:"inline-flex",alignItems:"center",marginLeft:6},children:o})})()]}),t.jsxs("div",{className:"row wrap post-actions",style:{alignItems:"center",gap:8,marginTop:4,position:"relative"},children:[t.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",children:[t.jsx(Te,{size:12}),t.jsx("span",{children:n.views_count??0})]}),t.jsxs("button",{className:`chip-btn like ${n.liked_by_me?"liked":""}`,onClick:Ee,disabled:ye,"aria-label":n.liked_by_me?"Unlike":"Like",title:n.liked_by_me?"Unlike":"Like",children:[n.liked_by_me?t.jsx(Ae,{size:16}):t.jsx(De,{size:16}),t.jsx("span",{children:n.likes_count??0})]}),pe?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"chip-btn",onClick:()=>G(e=>!e),title:"Manage","aria-label":"Manage",children:t.jsx("span",{className:"muted",style:{fontSize:12},children:"Manage"})}),J&&t.jsxs("div",{ref:K,style:{position:"absolute",right:0,bottom:36,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:6,minWidth:180,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsx("button",{className:"menu-item",onClick:Ie,children:n.is_starred?"Unstar post":"Star post"}),t.jsx("button",{className:"menu-item",onClick:he,children:"Delete video"})]})]}):t.jsxs("button",{className:"chip-btn report",onClick:()=>A(e=>!e),title:"Report","aria-label":"Report",children:[t.jsx(Ue,{size:16}),t.jsx("span",{className:"muted",style:{fontSize:12},children:"Report"})]}),n.beatmap_url&&t.jsx("div",{style:{marginLeft:"auto"},children:t.jsxs("button",{ref:I,className:"chip-btn link",onClick:()=>U(e=>!e),title:"Beatmap options","aria-label":"Beatmap options",children:[t.jsx(ve,{size:16}),t.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),t.jsx(Be,{size:14,style:{marginLeft:4,opacity:.7}})]})}),W&&t.jsxs("div",{ref:X,style:{position:"absolute",right:0,bottom:36,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:6,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsx("div",{className:"muted",style:{fontSize:12,padding:"4px 8px"},children:"Report asâ€¦"}),t.jsx("button",{className:"menu-item",onClick:()=>me("unrelated"),children:"Unrelated"}),t.jsx("button",{className:"menu-item",onClick:()=>me("explicit"),children:"Explicit"}),pe&&t.jsx("button",{className:"menu-item",onClick:he,children:"Delete video"})]})]})]}),t.jsx("div",{className:"muted one-line desc-line",children:(n.description??"").trim()?n.description:"No description."})]})}),Q&&Z&&(n==null?void 0:n.beatmap_url)&&t.jsxs("div",{ref:Y,style:{position:"fixed",top:Z.top,right:Z.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsxs("a",{className:"menu-item",href:n.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>U(!1),children:[t.jsx(ve,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),n.beatmapset_id&&t.jsx("button",{className:"menu-item",onClick:()=>{M(!0),U(!1)},children:"Preview"})]})]})}export{Ye as default};

import{j as e,c as q,P as M,T as $,e as J,u as V,r as i,U as X,L as Y,A as G}from"./vendor-react-C7NF2CWg.js";import{P as K}from"./Post-B1zYCnW7.js";import{C as Q}from"./Comment-Bprh95U9.js";import{P as Z}from"./Popup-CoSBxWSJ.js";import{P as ee}from"./beatmap-preview-zeCbv474.js";import{u as te,a as h,A as m,c as ae}from"./index-CV8g-6Hr.js";import"./vendor-RuoRctBR.js";import"./editor-lib-BiYBlHYf.js";import"./editor-components-CZPSM51n.js";const se=({streamUID:p,playbackUrl:f,aspectRatio:r,onClose:d,headerLeft:g,headerRight:n,children:t,beatmapDownloadUrl:c,beatmapVersion:v,beatmapId:y,onOpenInEditor:P})=>{const b=typeof r=="number"&&isFinite(r)&&r>0?r:1.7777777777777777,o=!!c;return e.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:l=>l.stopPropagation(),children:[e.jsx("div",{className:"overlay-backdrop",onClick:d}),e.jsxs("div",{className:"overlay-card",onClick:l=>l.stopPropagation(),children:[e.jsx("button",{className:"overlay-close",onClick:d,"aria-label":"Close",children:e.jsx(q,{size:18})}),e.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:o?"500px":"auto",height:"auto",maxHeight:o?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:l=>l.stopPropagation(),children:o?e.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:e.jsx(ee,{downloadUrl:c,beatmapVersion:v,beatmapId:y,onOpenInEditor:P})}):e.jsx(Z,{streamUID:p||void 0,playbackUrl:f||void 0,aspectRatio:b,inOverlay:!0})}),(g||n||t)&&e.jsxs("div",{className:"section-panel",children:[(g||n)&&e.jsxs("div",{className:"row-between",children:[e.jsx("div",{className:"row",style:{alignItems:"center"},children:g}),n?e.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:n}):e.jsx("div",{})]}),t]})]})]})};function ue(){var z,F,U,H;const{uid:p}=M(),[f,r]=$(),d=J(),n=((z=V().state)==null?void 0:z.returnTo)||"/mp/feed",[t,c]=i.useState(null),[v,y]=i.useState([]),[P,b]=i.useState(!0),[o,l]=i.useState(null),[u,j]=i.useState(""),[S,N]=i.useState(null),[C,T]=i.useState(!1),[L,k]=i.useState(!1),{notify:_}=te(),I=i.useRef(new Set);i.useEffect(()=>{h(m.auth.me,{requireAuth:!1}).then(a=>l(a)).catch(()=>{})},[]),i.useEffect(()=>{f.get("preview")==="true"&&k(!0)},[f]);const A=async()=>{if(p){b(!0);try{const a=await h(m.videos.get(p),{requireAuth:!1});c(a)}catch{_("Failed to load post",{variant:"error"}),d(n)}finally{b(!1)}}},B=async()=>{if(t!=null&&t.id)try{const a=await h(m.videos.comments(t.id),{requireAuth:!1});y(a.items||[])}catch{}};i.useEffect(()=>{A()},[p]),i.useEffect(()=>{t!=null&&t.id&&B()},[t==null?void 0:t.id]),i.useEffect(()=>{t!=null&&t.id&&(I.current.has(t.id)||(I.current.add(t.id),h(m.videos.view(t.id),{method:"POST"}).then(a=>{if(!a)return;const s=Number(a.views_count??0);c(w=>w?{...w,views_count:s,viewed_by_me:!0}:null)}).catch(()=>{})))},[t==null?void 0:t.id]);const O=a=>{"stream_uid"in a&&c(a)},R=()=>{d(n)},D=async a=>{if(a.preventDefault(),!(!u.trim()||!(t!=null&&t.id))){T(!0);try{await h(m.videos.comments(t.id),{method:"POST",body:JSON.stringify({text:u.trim(),parent_id:S||void 0})}),j(""),N(null),B(),A(),_("Comment posted!",{variant:"success"})}catch(s){_((s==null?void 0:s.message)||"Failed to post comment",{variant:"error"})}finally{T(!1)}}},W=a=>{y(s=>s.filter(w=>w.id!==a))};if(P)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!t)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const E=v.filter(a=>!a.parent_id),x=new Map;return v.filter(a=>a.parent_id).forEach(a=>{const s=a.parent_id;x.has(s)||x.set(s,[]),x.get(s).push(a)}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link",onClick:()=>d(n),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(X,{size:20})}),e.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(K,{post:t,section:"mappi",onUpdate:O,onDelete:R,me:o})}),o&&!S&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:D,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:u,onChange:a=>j(a.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:a=>{const s=a.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:C||!u.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:C?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:E.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:E.map(a=>e.jsx(Q,{comment:a,replies:x.get(a.id)||[],me:o,section:"mappi",onReply:s=>N(s),onDelete:W,replyingTo:S,replyText:u,onReplyTextChange:j,onReplySubmit:D,posting:C,onCancelReply:()=>{N(null),j("")},repliesMap:x},a.id))})})]}),t&&L&&t.beatmapset_id&&e.jsx(se,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{k(!1),r({})},beatmapDownloadUrl:`${ae}${m.osu.downloadBeatmapset(t.beatmapset_id)}`,beatmapId:t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0,onOpenInEditor:()=>{k(!1),r({}),window.location.hash="/editor"},headerLeft:e.jsxs(e.Fragment,{children:[((F=t.uploader)==null?void 0:F.avatar_url)&&e.jsx("img",{src:t.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),e.jsxs(Y,{to:`/profile/${(U=t.uploader)==null?void 0:U.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[e.jsx("span",{children:(H=t.uploader)==null?void 0:H.username}),t.is_starred?e.jsx(G,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{ue as default};

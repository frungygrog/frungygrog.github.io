import{r as t,j as l,F as ie}from"./vendor-react-lgmFq2cc.js";import{A as oe,l as ae,a as ce,p as U,b as ue,r as le,c as fe,H as X,t as de,P as me,V as he,C as pe}from"./editor-lib-DeTrzXBy.js";const ge=({onOpenInEditor:V,beatmapId:v})=>{const[b,y]=t.useState(!1),d=t.useRef(null),S=t.useRef(null);t.useEffect(()=>{if(!b)return;const a=j=>{d.current&&!d.current.contains(j.target)&&S.current&&!S.current.contains(j.target)&&y(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[b]);const z=()=>{y(!1),V()},C=()=>{y(!1),v?window.open(`https://preview.tryz.id.vn/?b=${v}`,"_blank","noopener,noreferrer"):window.open("https://preview.tryz.id.vn/","_blank","noopener,noreferrer")};return l.jsxs("div",{className:"editor-button-wrapper",children:[l.jsx("button",{ref:S,className:"editor-button",onClick:a=>{a.stopPropagation(),y(!b)},"aria-label":"Editor options","aria-expanded":b,children:l.jsx(ie,{size:20})}),b&&l.jsxs("div",{ref:d,className:"editor-button-menu",children:[l.jsx("button",{className:"editor-button-menu-item",onClick:z,children:"Open in editor"}),l.jsx("button",{className:"editor-button-menu-item",onClick:C,children:"Open in JoSu!"})]})]})},ye=({downloadUrl:V,beatmapVersion:v,beatmapId:b,onOpenInEditor:y})=>{const[d,S]=t.useState(null),[z,C]=t.useState(void 0),[a,j]=t.useState(0),[h,E]=t.useState(0),[k,L]=t.useState(!1),[Y,A]=t.useState(!1),[q,J]=t.useState(null),[T,G]=t.useState(.6),[D,Q]=t.useState(1),[I,Z]=t.useState(.6),[B,M]=t.useState(!1),F=t.useRef(!1),$=t.useRef(!1),P=t.useRef(null),W=t.useRef(!1),c=t.useRef(new oe),w=t.useRef(null),N=t.useRef([]),R=t.useRef(0),H=t.useRef(null),_=t.useRef("");t.useEffect(()=>{const e=c.current;return e.onTick(n=>{F.current||E(n)}),()=>e.stop()},[]),t.useEffect(()=>{ae().then(e=>J(e)).catch(()=>J(null))},[]),t.useEffect(()=>{c.current&&(c.current.volume=D*T)},[D,T]),t.useEffect(()=>{w.current&&(w.current.volume=I*T)},[I,T]),t.useEffect(()=>{let e=!1;return A(!0),S(null),(async()=>{try{const n=await fetch(V,{credentials:"include"});if(!n.ok)throw new Error("Failed to download");const s=await n.arrayBuffer();H.current=s;const i=await ce(s),p=i.list.filter(u=>u.toLowerCase().endsWith(".osu"));let r,o;if(b)for(const u of p){const f=await i.readText(u),x=U(f),g=Number(x.metadata.BeatmapID||0);if(Number.isFinite(g)&&g===b){r=u,o=f;break}}if(!r)for(const u of p){const f=await i.readText(u),x=U(f),g=String(x.metadata.Version||"");if(v&&g.toLowerCase()===String(v).toLowerCase()){r=u,o=f;break}}if(r||(r=p[0],o=await i.readText(r)),e)return;_.current=r;let m=U(o);try{m=await ue(o,m)}catch{}S(m);try{const u=le(m.difficulty);N.current=fe(m,u),R.current=0}catch{N.current=[],R.current=0}if(j(0),m.audioFilename){const u=i.findFirst(f=>f.toLowerCase().endsWith(m.audioFilename.toLowerCase()))||m.audioFilename;try{const f=await i.readArrayBuffer(u);await c.current.load(f),j(c.current.duration||0)}catch{}}if(m.backgroundFilename)try{const u=i.findFirst(g=>g.toLowerCase().endsWith(m.backgroundFilename.toLowerCase()))||m.backgroundFilename,f=await i.readArrayBuffer(u),x=URL.createObjectURL(new Blob([f]));C(x)}catch{C(void 0)}else C(void 0);c.current.seek(0),E(0),L(!1),A(!1)}catch(n){console.error("Failed to load beatmap:",n),A(!1),S(null)}})(),()=>{e=!0}},[V,v,b]);const ee=t.useCallback(e=>{var r;B?(c.current&&a>0&&c.current.setPosition(e),E(e)):(c.current.seek(e),E(e));const n=e*1e3,s=N.current;let i=0,p=s.length;for(;i<p;){const o=i+p>>>1;s[o].timeMs<=n?i=o+1:p=o}R.current=i;try{(r=w.current)==null||r.stopSlide()}catch{}},[B,a]),te=t.useCallback(async()=>{var e;if(k){c.current.pause(),L(!1);try{(e=w.current)==null||e.stopAll()}catch{}return}try{const n=c.current.getContext();if(n.state!=="running"&&await n.resume(),!w.current){const s=new X(n);w.current=s,await s.load().catch(()=>{})}}catch{}c.current.play(Math.max(0,Math.min(a,h))),L(!0)},[k,h,a]),K=t.useMemo(()=>{if(!d)return{bpm:0,sliderVelocity:0};const{base:e,inherited:n}=de(d,h*1e3),s=e?6e4/e.beatLength:0,i=n?-100/n.beatLength:1;return{bpm:s,sliderVelocity:i}},[d,h]),ne=t.useCallback(()=>{const e=c.current.isPlaying&&a>0;$.current=e,e&&c.current.pause(),L(!1),F.current=!0,M(!0)},[a]),re=t.useCallback(async()=>{F.current=!1,M(!1);try{const e=c.current.getContext();if(e.state!=="running"&&await e.resume(),!w.current){const n=new X(e);w.current=n,await n.load().catch(()=>{})}}catch{}},[]);t.useEffect(()=>{const e=n=>{var x;const s=n.target;if(!s||s.closest(".editor-controls-container")||s.tagName==="INPUT"||s.tagName==="TEXTAREA"||(n.preventDefault(),!Number.isFinite(a)||a<=0))return;if(!W.current){W.current=!0;const g=c.current.isPlaying&&a>0;$.current=g,g&&c.current.pause(),L(!1),F.current=!0,M(!0)}P.current!==null&&clearTimeout(P.current);const i=n.shiftKey?1:.1,p=n.deltaY>0?1:-1,r=Math.max(0,Math.min(a,h+p*i));a>0&&c.current.setPosition(r),E(r);const o=r*1e3,m=N.current;let u=0,f=m.length;for(;u<f;){const g=u+f>>>1;m[g].timeMs<=o?u=g+1:f=g}R.current=u;try{(x=w.current)==null||x.stopSlide()}catch{}P.current=window.setTimeout(()=>{W.current=!1,F.current=!1,M(!1),P.current=null},150)};return window.addEventListener("wheel",e,{passive:!1}),()=>{window.removeEventListener("wheel",e),P.current!==null&&clearTimeout(P.current)}},[h,a,k]);const O=t.useRef(0);t.useEffect(()=>{if(!d){O.current=h;return}const e=w.current;if(!e){O.current=h;return}const n=O.current,s=h;if(O.current=h,!k||B||s<=n||s-n>1)return;const i=s*1e3,p=N.current;let r=R.current;for(;r<p.length&&p[r].timeMs<=i;r++){const o=p[r];o.kind==="hit"?e.playHit(o.set,o.bits||0):o.kind==="tick"?e.playTick(o.set):o.kind==="reverse"&&e.playReverse(o.set)}R.current=r},[h,d,k,B]);const se=t.useCallback(()=>{if(!(!H.current||!_.current))try{const e=H.current.byteLength/1048576;if(e>6){alert(`Beatmap is too large (${e.toFixed(1)}MB) to transfer. Please load it manually in the editor.`);return}const n=H.current.slice(0);window.__editorTransferOsz=n,window.__editorTransferPath=_.current,y?y():window.location.hash="/editor"}catch(e){console.error("Failed to transfer to editor:",e),alert("Failed to open in editor. The beatmap may be too large.")}},[y]);return Y?l.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"400px",gap:16},children:[l.jsx("div",{className:"loading-spinner"}),l.jsx("div",{className:"muted",children:"Loading beatmap..."})]}):d?l.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"100%",height:"100%",maxHeight:"100%",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:[l.jsxs("div",{className:"embed-preview-playfield",style:{flex:"1 1 auto",minHeight:"400px",maxHeight:"none",aspectRatio:"16/9",width:"100%"},children:[l.jsx(me,{beatmap:d,timeSec:h,backgroundUrl:z,skin:q||void 0,sliderBodyCutoffPx:1}),l.jsx(he,{masterVolume:T,songVolume:D,hitsoundVolume:I,onMasterVolumeChange:G,onSongVolumeChange:Q,onHitsoundVolumeChange:Z}),l.jsx(ge,{onOpenInEditor:se,beatmapId:b})]}),l.jsx("div",{style:{flexShrink:0},children:l.jsx(pe,{isPlaying:k,onPlayPause:te,currentTime:h,duration:a,onSeek:ee,onScrubStart:ne,onScrubEnd:re,bpm:K.bpm,sliderVelocity:K.sliderVelocity,timingPoints:d==null?void 0:d.timingPoints})})]}):l.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"400px"},children:l.jsx("div",{className:"muted",children:"Failed to load beatmap"})})};export{ye as P};

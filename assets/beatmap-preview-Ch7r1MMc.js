import{r as t,j as o,F as ie}from"./vendor-react-Bj2Cd7tG.js";import{A as ae,l as oe,a as ce,p as U,b as ue,r as le,c as de,H as Y,t as fe,P as me,V as he,C as ge}from"./editor-lib-DvUOAkfg.js";const be=({onOpenInEditor:V,beatmapId:v})=>{const[x,w]=t.useState(!1),d=t.useRef(null),k=t.useRef(null);return t.useEffect(()=>{if(!x)return;const p=R=>{d.current&&!d.current.contains(R.target)&&k.current&&!k.current.contains(R.target)&&w(!1)};return document.addEventListener("mousedown",p),()=>document.removeEventListener("mousedown",p)},[x]),o.jsxs("div",{style:{position:"relative"},children:[o.jsxs("button",{ref:k,className:"editor-button",onClick:()=>w(!x),"aria-label":"Editor options",title:"Open in editor",style:{position:"absolute",top:12,right:12,background:"rgba(0,0,0,0.6)",border:"1px solid rgba(255,255,255,0.2)",borderRadius:8,padding:"8px 12px",color:"#fff",cursor:"pointer",display:"flex",alignItems:"center",gap:6,fontSize:13,fontWeight:500,zIndex:10,transition:"background 0.15s ease, border-color 0.15s ease"},onMouseEnter:p=>{p.currentTarget.style.background="rgba(0,0,0,0.8)",p.currentTarget.style.borderColor="rgba(255,255,255,0.3)"},onMouseLeave:p=>{p.currentTarget.style.background="rgba(0,0,0,0.6)",p.currentTarget.style.borderColor="rgba(255,255,255,0.2)"},children:[o.jsx("span",{children:"Editor"}),o.jsx(ie,{size:14})]}),x&&o.jsxs("div",{ref:d,style:{position:"absolute",top:48,right:12,background:"#121418",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:180,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[o.jsx("button",{className:"menu-item",onClick:()=>{w(!1),V()},children:"Open in editor"}),v&&o.jsx("a",{className:"menu-item",href:`https://osu.ppy.sh/beatmaps/${v}`,target:"_blank",rel:"noreferrer",onClick:()=>w(!1),children:"View on osu.ppy.sh"})]})]})},xe=({downloadUrl:V,beatmapVersion:v,beatmapId:x,onOpenInEditor:w})=>{const[d,k]=t.useState(null),[p,R]=t.useState(void 0),[m,_]=t.useState(0),[h,E]=t.useState(0),[C,T]=t.useState(!1),[q,W]=t.useState(!1),[G,$]=t.useState(null),[L,J]=t.useState(.6),[A,Q]=t.useState(1),[D,Z]=t.useState(.6),[B,N]=t.useState(!1),F=t.useRef(!1),K=t.useRef(!1),P=t.useRef(null),I=t.useRef(!1),c=t.useRef(new ae),y=t.useRef(null),M=t.useRef([]),j=t.useRef(0),H=t.useRef(null),O=t.useRef("");t.useEffect(()=>{const e=c.current;return e.onTick(r=>{F.current||E(r)}),()=>e.stop()},[]),t.useEffect(()=>{oe().then(e=>$(e)).catch(()=>$(null))},[]),t.useEffect(()=>{c.current&&(c.current.volume=A*L)},[A,L]),t.useEffect(()=>{y.current&&(y.current.volume=D*L)},[D,L]),t.useEffect(()=>{let e=!1;return W(!0),k(null),(async()=>{try{const r=await fetch(V,{credentials:"include"});if(!r.ok)throw new Error("Failed to download");const s=await r.arrayBuffer();H.current=s;const i=await ce(s),g=i.list.filter(u=>u.toLowerCase().endsWith(".osu"));let n,a;if(x)for(const u of g){const l=await i.readText(u),S=U(l),b=Number(S.metadata.BeatmapID||0);if(Number.isFinite(b)&&b===x){n=u,a=l;break}}if(!n)for(const u of g){const l=await i.readText(u),S=U(l),b=String(S.metadata.Version||"");if(v&&b.toLowerCase()===String(v).toLowerCase()){n=u,a=l;break}}if(n||(n=g[0],a=await i.readText(n)),e)return;O.current=n;let f=U(a);try{f=await ue(a,f)}catch{}k(f);try{const u=le(f.difficulty);M.current=de(f,u),j.current=0}catch{M.current=[],j.current=0}if(_(0),f.audioFilename){const u=i.findFirst(l=>l.toLowerCase().endsWith(f.audioFilename.toLowerCase()))||f.audioFilename;try{const l=await i.readArrayBuffer(u);await c.current.load(l),_(c.current.duration||0)}catch{}}if(f.backgroundFilename)try{const u=i.findFirst(b=>b.toLowerCase().endsWith(f.backgroundFilename.toLowerCase()))||f.backgroundFilename,l=await i.readArrayBuffer(u),S=URL.createObjectURL(new Blob([l]));R(S)}catch{R(void 0)}else R(void 0);c.current.seek(0),E(0),T(!1),W(!1)}catch(r){console.error("Failed to load beatmap:",r),W(!1),k(null)}})(),()=>{e=!0}},[V,v,x]);const ee=t.useCallback(e=>{var n;B?(c.current&&m>0&&c.current.setPosition(e),E(e)):(c.current.seek(e),E(e));const r=e*1e3,s=M.current;let i=0,g=s.length;for(;i<g;){const a=i+g>>>1;s[a].timeMs<=r?i=a+1:g=a}j.current=i;try{(n=y.current)==null||n.stopSlide()}catch{}},[B,m]),te=t.useCallback(async()=>{var e;if(C){c.current.pause(),T(!1);try{(e=y.current)==null||e.stopAll()}catch{}return}try{const r=c.current.getContext();if(r.state!=="running"&&await r.resume(),!y.current){const s=new Y(r);y.current=s,await s.load().catch(()=>{})}}catch{}c.current.play(Math.max(0,Math.min(m,h))),T(!0)},[C,h,m]),X=t.useMemo(()=>{if(!d)return{bpm:0,sliderVelocity:0};const{base:e,inherited:r}=fe(d,h*1e3),s=e?6e4/e.beatLength:0,i=r?-100/r.beatLength:1;return{bpm:s,sliderVelocity:i}},[d,h]),re=t.useCallback(()=>{const e=c.current.isPlaying&&m>0;K.current=e,e&&c.current.pause(),T(!1),F.current=!0,N(!0)},[m]),ne=t.useCallback(async()=>{F.current=!1,N(!1);try{const e=c.current.getContext();if(e.state!=="running"&&await e.resume(),!y.current){const r=new Y(e);y.current=r,await r.load().catch(()=>{})}}catch{}},[]);t.useEffect(()=>{const e=r=>{var S;const s=r.target;if(!s||s.closest(".editor-controls-container")||s.tagName==="INPUT"||s.tagName==="TEXTAREA"||(r.preventDefault(),!Number.isFinite(m)||m<=0))return;if(!I.current){I.current=!0;const b=c.current.isPlaying&&m>0;K.current=b,b&&c.current.pause(),T(!1),F.current=!0,N(!0)}P.current!==null&&clearTimeout(P.current);const i=r.shiftKey?1:.1,g=r.deltaY>0?1:-1,n=Math.max(0,Math.min(m,h+g*i));m>0&&c.current.setPosition(n),E(n);const a=n*1e3,f=M.current;let u=0,l=f.length;for(;u<l;){const b=u+l>>>1;f[b].timeMs<=a?u=b+1:l=b}j.current=u;try{(S=y.current)==null||S.stopSlide()}catch{}P.current=window.setTimeout(()=>{I.current=!1,F.current=!1,N(!1),P.current=null},150)};return window.addEventListener("wheel",e,{passive:!1}),()=>{window.removeEventListener("wheel",e),P.current!==null&&clearTimeout(P.current)}},[h,m,C]);const z=t.useRef(0);t.useEffect(()=>{if(!d){z.current=h;return}const e=y.current;if(!e){z.current=h;return}const r=z.current,s=h;if(z.current=h,!C||B||s<=r||s-r>1)return;const i=s*1e3,g=M.current;let n=j.current;for(;n<g.length&&g[n].timeMs<=i;n++){const a=g[n];a.kind==="hit"?e.playHit(a.set,a.bits||0):a.kind==="tick"?e.playTick(a.set):a.kind==="reverse"&&e.playReverse(a.set)}j.current=n},[h,d,C,B]);const se=t.useCallback(()=>{if(!(!H.current||!O.current))try{const e=H.current.byteLength/1048576;if(e>6){alert(`Beatmap is too large (${e.toFixed(1)}MB) to transfer. Please load it manually in the editor.`);return}const r=H.current.slice(0);window.__editorTransferOsz=r,window.__editorTransferPath=O.current,w?w():window.location.hash="/editor"}catch(e){console.error("Failed to transfer to editor:",e),alert("Failed to open in editor. The beatmap may be too large.")}},[w]);return q?o.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"400px",gap:16},children:[o.jsx("div",{className:"loading-spinner"}),o.jsx("div",{className:"muted",children:"Loading beatmap..."})]}):d?o.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"100%",height:"100%",maxHeight:"100%",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:[o.jsxs("div",{className:"embed-preview-playfield",style:{flex:"1 1 auto",minHeight:"400px",maxHeight:"none",aspectRatio:"16/9",width:"100%"},children:[o.jsx(me,{beatmap:d,timeSec:h,backgroundUrl:p,skin:G||void 0,sliderBodyCutoffPx:1}),o.jsx(he,{masterVolume:L,songVolume:A,hitsoundVolume:D,onMasterVolumeChange:J,onSongVolumeChange:Q,onHitsoundVolumeChange:Z}),o.jsx(be,{onOpenInEditor:se,beatmapId:x})]}),o.jsx("div",{style:{flexShrink:0},children:o.jsx(ge,{isPlaying:C,onPlayPause:te,currentTime:h,duration:m,onSeek:ee,onScrubStart:re,onScrubEnd:ne,bpm:X.bpm,sliderVelocity:X.sliderVelocity,timingPoints:d==null?void 0:d.timingPoints})})]}):o.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"400px"},children:o.jsx("div",{className:"muted",children:"Failed to load beatmap"})})};export{xe as P};

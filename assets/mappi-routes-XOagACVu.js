const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/editor-CCRXOUzg.js","assets/vendor-react-5Lxm-uQd.js","assets/vendor-XeNgptnJ.js","assets/beatmap-preview-BBMxK6Lq.js","assets/vendor-zip-D_60cdrC.js","assets/editor-CG1yLUbS.css"])))=>i.map(i=>d[i]);
import{r as n,j as e,d as Dt,u as yt,e as wt,f as At,g as St,h as jt,i as st,L as Ve,A as rt,F as kt,k as Ht,l as Et,m as nt,n as at,o as Ze,p as it,q as Ot,s as Bt,R as Ct,t as Ut,v as qt,w as Wt,b as Yt,a as Vt,x as Kt,y as ft,c as _t,z as Qt,B as Jt,C as Xt}from"./vendor-react-5Lxm-uQd.js";import{i as Gt,a as Zt,b as en,c as tn}from"./editor-components-BstHLSQQ.js";import{B as Lt}from"./editor-CCRXOUzg.js";import{H as je}from"./vendor-hls-B_fsdCYC.js";import{P as nn}from"./beatmap-preview-BBMxK6Lq.js";function Ke(){if(typeof window>"u")return!1;try{const t=navigator.userAgentData;if(t&&typeof t.mobile=="boolean"&&t.mobile||window.matchMedia&&(window.matchMedia("(pointer: coarse)").matches||window.matchMedia("(hover: none)").matches))return!0;const a=navigator.userAgent||"";if(/Android|iPhone|iPad|iPod|Mobile|Silk|Kindle|Opera Mini|IEMobile|WPDesktop/i.test(a))return!0}catch{}return!1}function Ln(){var f;if(typeof window>"u"||typeof document>"u")return()=>{};const t=()=>{const u=Ke();document.documentElement.classList.toggle("is-mobile",u),document.documentElement.setAttribute("data-mobile",u?"true":"false")};t();const a=["(pointer: coarse)","(hover: none)","(orientation: landscape)","(orientation: portrait)"],o=[];try{for(const u of a)if(window.matchMedia){const m=window.matchMedia(u);(f=m.addEventListener)==null||f.call(m,"change",t),o.push(m)}}catch{}return window.addEventListener("resize",t),()=>{try{o.forEach(u=>{var m;return(m=u.removeEventListener)==null?void 0:m.call(u,"change",t)}),window.removeEventListener("resize",t)}catch{}}}const Nt=n.createContext(null);function Nn({children:t}){const[a,o]=n.useState([]),f=n.useRef(1),u=n.useRef(new Map),m=d=>{const g=u.current.get(d);g&&(clearTimeout(g),u.current.delete(d))},l=(d,g)=>{m(d);const x=window.setTimeout(()=>j(d),g);u.current.set(d,x)},j=n.useCallback(d=>{m(d),o(g=>g.filter(x=>x.id!==d))},[]),c=n.useCallback((d,g)=>{const x=typeof g=="number"?g:(g==null?void 0:g.durationMs)??5e3,E=typeof g=="number"?"info":(g==null?void 0:g.variant)??"info",F=Ke();let I=null;return o(F?q=>{const w=q[0];if(w&&w.message===d&&w.variant===E){const z={...w,count:w.count+1,duration:x};return I=z.id,[z]}q.forEach(z=>m(z.id));const y=f.current++,A={id:y,message:d,duration:x,variant:E,count:1};return I=y,[A]}:q=>{const w=q.findIndex(z=>z.message===d&&z.variant===E);if(w!==-1){const z=[...q],W={...z[w],count:z[w].count+1};return z[w]=W,I=W.id,z}const y=f.current++,A={id:y,message:d,duration:x,variant:E,count:1};return I=y,[...q,A]}),I!=null&&l(I,x),I??-1},[]),_=n.useMemo(()=>({notify:c,close:j}),[c,j]);return e.jsxs(Nt.Provider,{value:_,children:[t,e.jsx("div",{className:"toasts",children:a.map(d=>e.jsxs("div",{className:`toast ${d.variant}`,children:[e.jsxs("div",{className:"toast-text",children:[d.message,d.count>1&&e.jsxs("span",{style:{marginLeft:6,opacity:.8},children:["×",d.count]})]}),e.jsx("button",{className:"toast-close",onClick:()=>j(d.id),"aria-label":"Close",children:"×"})]},d.id))})]})}function Je(){const t=n.useContext(Nt);if(!t)throw new Error("useToasts must be used within ToastProvider");return t}const Te=["#7dd3fc","#a78bfa","#34d399","#f472b6","#f59e0b"];function an({i:t}){const a=t*1337,o=(E,F)=>{const I=Math.sin(a+E+F)*1e4,q=I-Math.floor(I);return Math.floor(q*(F-E+1)+E)},f=o(0,100),u=o(24,50),m=.7+o(0,100)/100*.3,l=u*m,j=o(0,4e3),c=o(-10,10),_=o(-8,8),d=o(0,100),g=d<60?1:d<80?1.5:2,x=[{size:200*g,alpha:.06,dx:-22,dy:12,color:Te[o(0,Te.length-1)]},{size:150*g,alpha:.08,dx:-9,dy:7,color:Te[o(0,Te.length-1)]},{size:120*g,alpha:.1,dx:0,dy:0,color:Te[o(0,Te.length-1)]},{size:90*g,alpha:.12,dx:12,dy:-4,color:Te[o(0,Te.length-1)]},{size:64*g,alpha:.13,dx:20,dy:-7,color:Te[o(0,Te.length-1)]}];return e.jsx("div",{className:"cluster",style:{left:`${f}vw`,animationDuration:`${l}s`,animationDelay:`${j}ms`,"--tx":`${c}vw`,transform:`rotate(${_}deg)`},children:x.map((E,F)=>e.jsx("svg",{width:E.size,height:E.size,viewBox:"0 0 100 100",style:{left:`${50+E.dx}%`,bottom:`${E.dy}px`,transform:"translateX(-50%)","--alpha":E.alpha},children:e.jsx("polygon",{points:"50,0 100,100 0,100",fill:E.color})},F))})}function sn({paused:t=!1}){const a=n.useMemo(()=>new Array(20).fill(0).map((o,f)=>f),[]);return e.jsx("div",{className:`triangles ${t?"paused":""}`,children:a.map(o=>e.jsx(an,{i:o},o))})}const rn=()=>{try{const t=localStorage.getItem("filter_modes")||"standard",a=new Set(t.toLowerCase().split(",").map(o=>o.trim()).filter(Boolean));return{standard:a.has("standard")||a.size===0,taiko:a.has("taiko"),mania:a.has("mania"),catch:a.has("catch")}}catch{return{standard:!0,taiko:!1,mania:!1,catch:!1}}},on=()=>{try{const t=localStorage.getItem("filter_moddi_tags")||"untagged,help",a=new Set(t.toLowerCase().split(",").map(o=>o.trim()).filter(Boolean));return{untagged:a.has("untagged")||a.size===0,help:a.has("help")||a.size===0}}catch{return{untagged:!0,help:!0}}},ln=()=>{try{const t=localStorage.getItem("filter_queue_status")||"unchecked,accepted,denied,finished",a=new Set(t.toLowerCase().split(",").map(o=>o.trim()).filter(Boolean));return{unchecked:a.has("unchecked")||a.size===0,accepted:a.has("accepted")||a.size===0,denied:a.has("denied")||a.size===0,finished:a.has("finished")||a.size===0,archived:a.has("archived")}}catch{return{unchecked:!0,accepted:!0,denied:!0,finished:!0,archived:!1}}},dn=()=>{try{const t=localStorage.getItem("last_section");return t==="mappi"||t==="moddi"?t:null}catch{return null}},It=Dt(t=>({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1,modeFilters:rn(),tagFilters:on(),queueStatusFilters:ln(),lastSection:dn(),previousLocation:null,setMenuOpen:a=>t({menuOpen:a}),setMobileNavOpen:a=>t({mobileNavOpen:a}),setNotifOpen:a=>t({notifOpen:a}),closeAllPanels:()=>t({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1}),setModeFilters:a=>{t({modeFilters:a});try{const f=Object.entries(a).filter(([m,l])=>l).map(([m])=>m),u=f.length?f:["standard"];localStorage.setItem("filter_modes",u.join(","))}catch{}},setTagFilters:a=>{t({tagFilters:a});try{const f=Object.entries(a).filter(([m,l])=>l).map(([m])=>m),u=f.length?f:["untagged","help"];localStorage.setItem("filter_moddi_tags",u.join(","))}catch{}},setQueueStatusFilters:a=>{t({queueStatusFilters:a});try{const f=Object.entries(a).filter(([m,l])=>l).map(([m])=>m),u=f.length?f:["unchecked","accepted","denied","finished"];localStorage.setItem("filter_queue_status",u.join(","))}catch{}},setLastSection:a=>{t({lastSection:a});try{a?localStorage.setItem("last_section",a):localStorage.removeItem("last_section")}catch{}},setPreviousLocation:a=>{t({previousLocation:a})}})),Qe="https://api.osumappi.ng";function cn(){var t;try{return((t=document.cookie.split("; ").map(a=>a.split("=")).find(([a])=>a==="csrf"))==null?void 0:t[1])||""}catch{return""}}async function B(t,a={}){const{requireAuth:o=!0,skipCsrf:f=!1,...u}=a,m={...u.headers};if(u.body&&!m["Content-Type"]&&(m["Content-Type"]="application/json"),o&&!f){const j=cn();j&&(m["X-CSRF-Token"]=j)}const l=await fetch(`${Qe}${t}`,{...u,credentials:"include",headers:m});if(!l.ok){const j=await l.json().catch(()=>({error:`HTTP ${l.status}`}));throw new Error(j.error||`HTTP ${l.status}: ${l.statusText}`)}return l.json()}function et(t){const a=new URLSearchParams;for(const[f,u]of Object.entries(t))u!=null&&a.append(f,String(u));const o=a.toString();return o?`?${o}`:""}const M={auth:{login:"/api/auth/login",logout:"/api/auth/logout",me:"/api/me"},user:{quota:"/api/me/upload_quota",notifications:"/api/me/notifications",markNotificationsRead:"/api/me/notifications/mark_read",deleteNotification:t=>`/api/me/notifications/${encodeURIComponent(t)}`},feed:{next:"/api/feed/next",batch:"/api/feed/batch",progress:t=>`/api/feed/progress${t?`?modes=${encodeURIComponent(t)}`:""}`,recent:"/api/videos/recent"},videos:{like:t=>`/api/videos/${t}/like`,view:t=>`/api/videos/${t}/view`,update:t=>`/api/videos/${t}`,delete:t=>`/api/videos/${t}`,flag:t=>`/api/videos/${t}/flag`,comments:t=>`/api/videos/${t}/comments`,get:t=>`/api/videos/${t}`},uploads:{new:"/api/uploads/new"},moddi:{posts:"/api/moddiposts",post:t=>`/api/moddiposts/${t}`,postReact:t=>`/api/moddiposts/${t}/react`,postComments:t=>`/api/moddiposts/${t}/comments`,queues:"/api/moddi/queues",queue:t=>`/api/moddi/queues/${t}`,queueSubmit:t=>`/api/moddi/queues/${t}/submit`,queueAccept:t=>`/api/moddi/queues/${t}/accept`,queueDeny:t=>`/api/moddi/queues/${t}/deny`,queueInvite:t=>`/api/moddi/queues/${t}/invite`,queueMember:(t,a)=>`/api/moddi/queues/${t}/members/${a}`,queueSubmission:(t,a)=>`/api/moddi/queues/${t}/submissions/${a}`,queueSubmissionDelete:(t,a)=>`/api/moddi/queues/${t}/submissions/${a}`,queueBlockUser:t=>`/api/moddi/queues/${t}/block`,queueUnblockUser:(t,a)=>`/api/moddi/queues/${t}/block/${a}`,queueBlockedUsers:t=>`/api/moddi/queues/${t}/blocked`,queueSubmissionAcknowledge:(t,a)=>`/api/moddi/queues/${t}/submissions/${a}/acknowledge`,queueSubmissionUnacknowledge:(t,a)=>`/api/moddi/queues/${t}/submissions/${a}/acknowledge`,usersSearch:t=>`/api/moddi/users/search?q=${encodeURIComponent(t)}`},osu:{resolveBeatmap:"/api/osu/beatmap/resolve",downloadBeatmapset:t=>`/api/osu/beatmapsets/${t}/download?noVideo=1`,usersSearch:t=>`/api/osu/users/search?q=${encodeURIComponent(t)}`},users:{get:t=>`/api/users/${t}`,videos:t=>`/api/users/${t}/videos`,likes:t=>`/api/users/${t}/likes`,myVideos:"/api/me/videos"},admin:{clearViews:"/api/admin/me/clear_views",debugState:"/api/debug/state",settingsModeration:"/api/admin/settings/moderation",videosPending:"/api/admin/videos/pending",videosApprove:t=>`/api/admin/videos/${t}/approve`,videosReject:t=>`/api/admin/videos/${t}/reject`,videosAction:(t,a)=>`/api/admin/videos/${t}/${a}`,analytics:"/api/admin/analytics",usersSearch:t=>`/api/admin/users/search?q=${encodeURIComponent(t)}`,userVideos:t=>`/api/admin/users/${t}/videos`,userUpdate:t=>`/api/admin/users/${t}`,notificationsSystem:"/api/admin/notifications/system",notificationsTest:"/api/admin/notifications/test"}};function Rt(){return yt({queryKey:["user","me"],queryFn:async()=>{try{return await B(M.auth.me)}catch{return null}},staleTime:5*60*1e3})}function In(t=!0){return yt({queryKey:["user","quota"],queryFn:async()=>{try{return await B(M.user.quota)}catch{return null}},enabled:t,refetchInterval:30*1e3})}function Rn(){const t=wt();return At({mutationFn:async()=>{await B(M.auth.logout,{method:"POST"})},onSuccess:()=>{t.setQueryData(["user","me"],null),t.clear(),window.location.href="/"}})}const zt=({open:t,onClose:a,buttonRef:o,children:f,align:u="right",minWidth:m=160})=>{const[l,j]=n.useState(null),c=n.useRef(null);if(n.useEffect(()=>{if(!t||!o.current){j(null);return}const d=()=>{if(!o.current)return;const g=o.current.getBoundingClientRect();j({top:g.bottom+8,[u]:window.innerWidth-g[u==="right"?"right":"left"]})};return d(),window.addEventListener("resize",d),window.addEventListener("scroll",d,!0),()=>{window.removeEventListener("resize",d),window.removeEventListener("scroll",d,!0)}},[t,o,u]),n.useEffect(()=>{if(!t)return;const d=g=>{c.current&&!c.current.contains(g.target)&&o.current&&!o.current.contains(g.target)&&a()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[t,a,o]),!t||!l)return null;const _=e.jsx("div",{ref:c,style:{position:"fixed",top:l.top,[u]:l[u],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:m,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:f});return St.createPortal(_,document.body)},ot=({playbackUrl:t,streamUID:a,aspectRatio:o,preferNative:f=!1,autoplay:u=!1,loop:m=!1,muted:l=!1,controls:j=!0,onVideoRef:c,onClick:_,inOverlay:d=!1})=>{const g=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,x=n.useRef(null),[E,F]=n.useState(null),I=n.useMemo(()=>{const h=typeof o=="number"&&isFinite(o)&&o>0?o:null;return h||16/9},[o]),w=`${E??I} / 1`,y=n.useMemo(()=>t||(a?`https://videodelivery.net/${a}/manifest/video.m3u8`:null),[t,a]),A=n.useRef(null);n.useEffect(()=>{y&&(A.current=y)},[y]),n.useEffect(()=>{F(null)},[y]),n.useEffect(()=>{if(!f||!x.current)return;const h=x.current;let Z=!1;const U=()=>{if(!Z)if(h.videoWidth>0&&h.videoHeight>0){const ae=h.videoWidth/h.videoHeight;F(ae),Z=!0}else F(I),Z=!0};return h.addEventListener("loadedmetadata",U),h.readyState>=1&&U(),()=>{h.removeEventListener("loadedmetadata",U)}},[f,I,y]);const z=n.useRef(null),W=n.useRef(null);n.useEffect(()=>{if(!y)return;let h=z.current,Z=null,U=!1,ae=null;if(h&&W.current&&W.current!==y){console.log(`[HLS] URL changed from ${W.current} to ${y}, using loadSource`);try{h.stopLoad(),h.loadSource(y),W.current=y;const v=x.current;if(v)try{v.pause(),v.currentTime=0,v.load()}catch(X){console.warn("[HLS] Error resetting video element:",X)}}catch(v){console.error("[HLS] Error switching source:",v);try{h.destroy()}catch{}h=null,z.current=null,W.current=null}}if(h&&W.current===y)return console.log(`[HLS] URL unchanged (${y}), reusing existing HLS instance`),()=>{U=!0};const we=()=>{if(document.hidden&&h){const v=x.current;if(v)try{v.pause()}catch{}try{h.stopLoad()}catch{}}},J=()=>{if(U=!0,h){try{h.stopLoad(),h.detachMedia(),h.destroy()}catch{}h=null}};document.addEventListener("visibilitychange",we),window.addEventListener("beforeunload",J);const ge=()=>{const v=x.current;if(!v||U)return;try{for(v.pause(),v.currentTime=0,v.src="",v.srcObject=null;v.firstChild;)v.removeChild(v.firstChild);v.load()}catch(C){console.warn("[HLS] Error resetting video element:",C)}const X=performance.now();if(console.log(`[HLS] Starting HLS setup for ${y} at ${X.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:v.readyState,isConnected:v.isConnected,paused:v.paused,currentTime:v.currentTime}),je.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const C={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const R=performance.now();h=new je(C),z.current=h,W.current=y;const ee=performance.now()-R;console.log(`[HLS] HLS instance created in ${ee.toFixed(2)}ms`);const te=performance.now();h.loadSource(y);const re=performance.now()-te;console.log(`[HLS] loadSource() called in ${re.toFixed(2)}ms`);const ne=performance.now();h.attachMedia(v);const xe=performance.now()-ne;console.log(`[HLS] attachMedia() completed in ${xe.toFixed(2)}ms`);const V=performance.now()-X;console.log(`[HLS] Total HLS setup time: ${V.toFixed(2)}ms`)}catch(R){const ee=performance.now()-X;if(console.error(`[HLS] Failed to initialize HLS after ${ee.toFixed(2)}ms:`,R),h){try{h.destroy()}catch{}h=null}return}h.on(je.Events.MANIFEST_PARSED,()=>{const R=performance.now()-X;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${R.toFixed(2)}ms after setup start`),U||!v)return;m&&(ae=()=>{if(!(U||!v||!h))try{v.currentTime=0,v.play().catch(te=>{te.name!=="AbortError"&&te.name!=="NotAllowedError"&&console.debug("Loop play failed:",te)})}catch{v.currentTime=0,v.play().catch(()=>{})}},v.addEventListener("ended",ae)),(()=>{if(!(U||!v))if(v.readyState>=2){if(u){const te=performance.now();v.play().then(()=>{const re=performance.now()-te;console.log(`[HLS] Autoplay succeeded in ${re.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(re=>{const ne=performance.now()-te;re.name!=="AbortError"&&re.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${ne.toFixed(2)}ms:`,re)})}}else{const te=()=>{if(!(U||!v)&&(v.removeEventListener("canplay",te),u)){const re=performance.now();v.play().then(()=>{const ne=performance.now()-re;console.log(`[HLS] Autoplay succeeded in ${ne.toFixed(2)}ms after canplay event`)}).catch(ne=>{const xe=performance.now()-re;ne.name!=="AbortError"&&ne.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${xe.toFixed(2)}ms:`,ne)})}};v.addEventListener("canplay",te,{once:!0})}})()}),h.on(je.Events.ERROR,(R,ee)=>{if(!U&&ee.fatal)switch(ee.type){case je.ErrorTypes.NETWORK_ERROR:if(!U&&h)try{h.startLoad()}catch{}break;case je.ErrorTypes.MEDIA_ERROR:if(!U&&h)try{h.recoverMediaError()}catch{}break;default:h&&(h.destroy(),h=null);break}})}else U||console.warn("HLS.js not supported, falling back to native HLS"),v.src=y,v.loop=m,Z=()=>{U||console.warn("Native HLS playback failed")},v.addEventListener("error",Z),u&&!U&&v.play().catch(C=>{C.name!=="AbortError"&&C.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",C)})};let de=0;const se=10,ce=()=>{if(U)return;if(de++,de>se){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const v=x.current;if(!v){requestAnimationFrame(ce);return}if(!v.isConnected){requestAnimationFrame(ce);return}ge()},he=requestAnimationFrame(()=>{requestAnimationFrame(ce)});return()=>{cancelAnimationFrame(he),U=!0,document.removeEventListener("visibilitychange",we),window.removeEventListener("beforeunload",J);const v=x.current;if(v&&ae&&(v.removeEventListener("ended",ae),ae=null),h){try{h.stopLoad(),h.off(je.Events.MANIFEST_PARSED),h.off(je.Events.ERROR),h.off(je.Events.MEDIA_ATTACHED),h.off(je.Events.MEDIA_DETACHED),h.off(je.Events.MANIFEST_LOADED),h.off(je.Events.MEDIA_ATTACHING),h.off(je.Events.MEDIA_DETACHING),h.off(je.Events.DESTROYING),h.destroy()}catch{try{h&&h.detachMedia()}catch{}}h=null,z.current=null,W.current=null}if(v){Z&&(v.removeEventListener("error",Z),Z=null);try{v.pause()}catch{}}}},[y,u]),n.useEffect(()=>(c&&x.current&&c(x.current),()=>{c&&c(null)}),[c,f,y]);const D=g||!d?{width:"auto",maxWidth:"100%",height:"100%",maxHeight:"100%",aspectRatio:w,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"100%",maxWidth:"100%",maxHeight:"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",aspectRatio:w,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"};return y?e.jsx("div",{style:D,children:e.jsx("video",{ref:x,autoPlay:u,loop:!1,muted:l,controls:j,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:_?"pointer":"default"},children:"Your browser does not support the video tag."})}):e.jsx("div",{style:D,children:"No video available"})};function un({beatmapMeta:t,beatmapVersion:a}){const o=n.useRef(null),f=n.useRef(null),[u,m]=n.useState(!1),[l,j]=n.useState(!1),[c,_]=n.useState(0);n.useEffect(()=>{if(o.current&&f.current){const x=o.current.offsetWidth,E=f.current.scrollWidth;_(E),j(E>x)}},[t,a]);const d=t?e.jsxs(e.Fragment,{children:[t.artist," – ",t.title,t.mapper?` (by ${t.mapper})`:"",a?` [${a}]`:""]}):a?`[${a}]`:"Beatmap",g=c>0?Math.max(3,c/50):3;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),e.jsxs("div",{ref:o,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:l?"pointer":"default"},onMouseEnter:()=>l&&m(!0),onMouseLeave:()=>m(!1),children:[e.jsx("span",{ref:f,style:{display:"inline-block",animation:u&&l?`beatmap-marquee ${g}s linear infinite`:"none"},children:d}),u&&l&&e.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:d})]})]})}function mn(t){return"post_type"in t?t.post_type==="mappi":!!t.stream_uid}function Mt({post:t,section:a,onUpdate:o,onDelete:f,me:u}){const m=jt(),l=st(),j=a==="mappi"?l.pathname.startsWith("/mp/feed/"):l.pathname.startsWith("/md/feed/"),c=mn(t);t.id;const _=c?t.stream_uid||String(t.id||""):t.uid||String(t.id||""),d=_&&_!=="null"&&_!=="undefined"?a==="mappi"?`/mp/feed/${_}`:`/md/feed/${_}`:a==="mappi"?`/mp/feed/${t.id}`:`/md/feed/${t.id}`,[g,x]=n.useState(!1),[E,F]=n.useState(!1),[I,q]=n.useState(!1),[w,y]=n.useState(!1),[A,z]=n.useState(!1),W=n.useRef(null),D=n.useRef(null),h=n.useRef(null),[Z,U]=n.useState(null),[ae,we]=n.useState(null),{notify:J}=Je(),[ge,de]=n.useState(c?t.liked_by_me:void 0),[se,ce]=n.useState(c?t.likes_count:0),[he,v]=n.useState(c?void 0:t.reacted_by_me),[X,C]=n.useState(c?0:t.reactions_count);n.useEffect(()=>{if(c){const r=t;de(r.liked_by_me),ce(r.likes_count)}else{const r=t;v(!!r.reacted_by_me),C(r.reactions_count)}},[t,c]);const[R,ee]=n.useState(!1),[te,re]=n.useState(c?"":t.text??""),[ne,xe]=n.useState(t.beatmap_url||""),[V,ie]=n.useState(null),[oe,ue]=n.useState(null),[Ae,be]=n.useState(""),H=n.useRef(0),Pe=u&&((c?t.uploader&&u.id===t.uploader.id:u.id===t.user_id)||u.is_admin||u.is_mod),$e=(()=>{const r=t.created_at;if(!r)return"";const k=Math.floor(Date.now()/1e3)-r;return k<60?"just now":k<3600?`${Math.floor(k/60)}m`:k<86400?`${Math.floor(k/3600)}h`:k<604800?`${Math.floor(k/86400)}d`:new Date(r*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();n.useEffect(()=>{if(!R&&!c){const r=t;re(r.text??""),xe(r.beatmap_url||""),ie(null),ue(null),be("")}},[t,R,c]),n.useEffect(()=>{if(!R||c)return;H.current&&window.clearTimeout(H.current);const r=(ne||"").trim();if(!r){be(""),ie(null),ue(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(r)){be(""),ie(null),ue(null);return}return H.current=window.setTimeout(async()=>{var T;try{let Y;try{Y=new URL(r)}catch{be("Invalid URL format");return}const ve=Y.hash.match(/#osu\/(\d+)/),Ee=ve?ve[1]:null;Y.hash="";const Re={url:Y.toString()};Ee&&(Re.beatmap_id=Ee);const ye=await B(M.osu.resolveBeatmap+et(Re),{requireAuth:!1}),_e=Array.isArray(ye==null?void 0:ye.diffs)?ye.diffs:[];if(!_e.length&&!ye.setId){be("No difficulties found"),ie(null),ue(null);return}if(ie({setId:Number(ye.setId)||0,beatmapId:ye.beatmapId??null,title:String(ye.title||""),artist:String(ye.artist||""),mapper:String(ye.mapper||""),diffs:_e}),_e.length>0){const Xe=Number.isFinite(Number(ye.beatmapId))?Number(ye.beatmapId):Number((T=_e[0])==null?void 0:T.id),Le=_e.find(Ge=>Number(Ge.id)===Xe)||_e[0];ue({beatmapId:Number(Le==null?void 0:Le.id)||null,version:String((Le==null?void 0:Le.version)||""),mode:String((Le==null?void 0:Le.mode)||"standard")})}else ue(null);be("")}catch(Y){be(`Failed to resolve: ${(Y==null?void 0:Y.message)||"Unknown error"}`),ie(null),ue(null)}},400),()=>{H.current&&window.clearTimeout(H.current)}},[ne,R,c]),n.useEffect(()=>{if(c||!t.beatmap_url||ae)return;const r=t;let k=!1;return(async()=>{try{let T;try{T=new URL(r.beatmap_url)}catch{return}const Y=T.hash.match(/#osu\/(\d+)/),ve=Y?Y[1]:null;T.hash="";const Ce={url:T.toString()};if(ve?Ce.beatmap_id=ve:r.beatmap_id&&(Ce.beatmap_id=String(r.beatmap_id)),!k){const Re=await B(M.osu.resolveBeatmap+et(Ce),{requireAuth:!1});(Re.title||Re.artist)&&we({title:Re.title||null,artist:Re.artist||null,mapper:Re.mapper||null})}}catch{}})(),()=>{k=!0}},[t,c,ae]);const He=async()=>{if(g||!c)return;x(!0);const r=ge??!1,k=se,T=!r,Y=T?se+1:Math.max(0,se-1);de(T),ce(Y);try{const ve=r?"DELETE":"POST",Ee=await B(M.videos.like(t.id),{method:ve}),Ce={...t,liked_by_me:T,likes_count:Ee.likes_count||Y};de(T),ce(Ee.likes_count??Y),o&&o(Ce)}catch{de(r),ce(k),J("Failed to like",{variant:"error"})}finally{x(!1)}},Oe=async()=>{if(E||c)return;F(!0);const r=he??!1,k=X,T=!r,Y=T?X+1:Math.max(0,X-1);v(T),C(Y);try{const ve=r?"DELETE":"POST",Ee=await B(M.moddi.postReact(t.id),{method:ve}),Ce={...t,reacted_by_me:T,reactions_count:Ee.reactions_count||Y};v(T),C(Ee.reactions_count??Y),o&&o(Ce)}catch{v(r),C(k),J("Failed to react",{variant:"error"})}finally{F(!1)}},Be=async()=>{if(confirm(c?"Permanently delete this video?":"Permanently delete this post?")){try{const r=c?M.videos.delete(t.id):M.moddi.post(String(t.id));await B(r,{method:"DELETE"}),J(c?"Video deleted":"Post deleted",{variant:"warn"}),f&&f(t.id)}catch(r){J((r==null?void 0:r.message)||(c?"Failed to delete video":"Failed to delete post"),{variant:"error"})}y(!1)}},Ye=async()=>{if(c){try{const r=!t.is_starred,k=r?"star":"unstar";await B(M.admin.videosAction(t.id,k),{method:"POST"});const T={...t,is_starred:r};o&&o(T),J(r?"Post starred":"Star removed",{variant:"success"})}catch{J("Action failed",{variant:"error"})}y(!1)}},Ue=()=>{c||(ee(!0),re(t.text??""),xe(t.beatmap_url||""),ie(null),ue(null),be(""),y(!1))},L=async()=>{if(!c)try{await B(M.moddi.post(String(t.id)),{method:"PATCH",body:JSON.stringify({text:te.trim(),beatmap_url:ne.trim()||null,beatmapset_id:(V==null?void 0:V.setId)??void 0,beatmap_id:(oe==null?void 0:oe.beatmapId)??(V==null?void 0:V.beatmapId)??void 0,beatmap_version:(oe==null?void 0:oe.version)??void 0})});const r=await B(M.moddi.post(String(t.id)),{method:"GET",requireAuth:!1});o&&r.post&&o({...t,...r.post}),J("Post updated",{variant:"success"}),ee(!1)}catch(r){J((r==null?void 0:r.message)||"Failed to update post",{variant:"error"})}},O=()=>{ee(!1);const r=t;re(r.text??""),xe(r.beatmap_url||""),ie(null),ue(null),be("")};n.useEffect(()=>{if(!I||!D.current){U(null);return}const r=()=>{if(D.current){const k=D.current.getBoundingClientRect();U({top:k.bottom+8,right:window.innerWidth-k.right})}};return r(),window.addEventListener("resize",r),window.addEventListener("scroll",r,!0),()=>{window.removeEventListener("resize",r),window.removeEventListener("scroll",r,!0)}},[I]),n.useEffect(()=>{if(!I)return;const r=k=>{W.current&&!W.current.contains(k.target)&&D.current&&!D.current.contains(k.target)&&q(!1)};return document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[I]);const $=r=>{const k=r.target;if(k.closest("button")||k.closest(".menu-panel")||k.closest("input")||k.closest("textarea")||k.closest("select"))return;const T=k.closest("a");T&&T.getAttribute("href")!==`#${d}`||m(d)},P=c?t.uploader||{id:0,username:"Unknown",avatar_url:null}:{id:t.user_id||0,username:t.username||"Unknown",avatar_url:t.avatar_url||null},le=!c&&(he??(t.reacted_by_me===!0||t.reacted_by_me===1)),G=!c&&t.tags&&(typeof t.tags=="string"?t.tags.split(",").map(r=>r.trim()):[]).includes("help"),s=t.beatmapset_id,Se=t.beatmap_id,fe=t.beatmap_version;return e.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:r=>r.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:r=>r.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",onClick:$,children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[P.avatar_url?e.jsx(Ve,{to:`/profile/${P.id}`,onClick:r=>r.stopPropagation(),style:{flexShrink:0},children:e.jsx("img",{src:P.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:P.username})}):e.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),e.jsx(Ve,{to:d,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:r=>{const k=r.target,T=k.closest("a");if(T&&T!==r.currentTarget){r.preventDefault(),r.stopPropagation();return}if(k.closest("button")||k.closest(".menu-panel")||k.closest("input")||k.closest("textarea")||k.closest("select")){r.preventDefault(),r.stopPropagation();return}r.stopPropagation()},children:e.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx(Ve,{to:`/profile/${P.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:r=>r.stopPropagation(),onMouseEnter:r=>r.currentTarget.style.color="#7dd3fc",onMouseLeave:r=>r.currentTarget.style.color="inherit",children:P.username}),c&&t.is_starred&&e.jsx(rt,{size:14,color:"#f59e0b",title:"Starred"}),c&&t.mode&&e.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:t.mode}),!c&&G&&e.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[$e&&e.jsx("span",{className:"muted",style:{fontSize:13},children:$e}),Pe&&e.jsx("button",{ref:h,onClick:r=>{r.preventDefault(),r.stopPropagation(),y(k=>!k)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:r=>r.currentTarget.style.backgroundColor="rgba(255,255,255,0.05)",onMouseLeave:r=>r.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:e.jsx(kt,{size:16})})]})]}),c&&j&&t.playback_url&&e.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10"},children:e.jsx(ot,{playbackUrl:t.playback_url,streamUID:t.stream_uid,aspectRatio:t.width&&t.height?t.width/t.height:null})}),c&&!j&&t.poster_url&&e.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10",aspectRatio:t.width&&t.height?`${t.width} / ${t.height}`:"16 / 9",position:"relative"},children:[e.jsx("img",{src:t.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),t.duration_sec&&e.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(t.duration_sec/60),":",(t.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!c&&R?e.jsx("div",{style:{marginBottom:12},children:e.jsxs("div",{className:"col",style:{gap:8},children:[e.jsx("textarea",{value:te,onChange:r=>re(r.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),V?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[V.artist," – ",V.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",V.mapper]})]}),V.diffs.length>0&&e.jsx("select",{value:(oe==null?void 0:oe.beatmapId)??(V==null?void 0:V.beatmapId)??void 0,onChange:r=>{const k=Number(r.target.value),T=(V==null?void 0:V.diffs.find(Y=>Number(Y.id)===k))||null;T&&ue({beatmapId:k,version:T.version,mode:String(T.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:V.diffs.map(r=>e.jsxs("option",{value:r.id,children:[r.version," (",r.mode,")"]},r.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{ie(null),ue(null),xe("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:ne,onChange:r=>xe(r.target.value),style:{fontSize:13,padding:"6px 8px"}}),Ae&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:Ae}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{className:"btn secondary",onClick:O,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),e.jsx("button",{className:"btn",onClick:L,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):e.jsxs(e.Fragment,{children:[(()=>{if(c){const r=t.description??"";return r.trim()?e.jsx("div",{style:{marginBottom:t.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:r}):null}else{const r=t.text??"";return r.trim()?e.jsx("div",{style:{marginBottom:t.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:r}):null}})(),c&&t.beatmap_title&&e.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"#7b8491",lineHeight:1.4},children:[t.beatmap_artist," – ",t.beatmap_title," ",t.beatmap_mapper?`(by ${t.beatmap_mapper})`:""," ",t.beatmap_version?`[${t.beatmap_version}]`:""]}),!R&&e.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[c&&t.beatmap_url&&!t.beatmap_title&&e.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!c&&t.beatmap_url&&(ae||t.beatmapset_id||t.beatmap_id)&&e.jsx(un,{beatmapMeta:ae,beatmapVersion:t.beatmap_version}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[c&&e.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:r=>{r.preventDefault(),r.stopPropagation()},children:[e.jsx(Ht,{size:12}),e.jsx("span",{children:t.views_count??0})]}),e.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:r=>{r.preventDefault(),r.stopPropagation()},children:[e.jsx(Et,{size:12}),e.jsx("span",{children:t.comments_count??0})]}),c?e.jsxs("button",{className:`chip-btn like ${ge?"liked":""}`,onClick:r=>{r.preventDefault(),r.stopPropagation(),He()},disabled:g,"aria-label":ge?"Unlike":"Like",title:ge?"Unlike":"Like",children:[ge?e.jsx(nt,{size:16}):e.jsx(at,{size:16}),e.jsx("span",{children:se})]}):e.jsxs("button",{className:`chip-btn like ${le?"liked":""}`,onClick:r=>{r.preventDefault(),r.stopPropagation(),Oe()},disabled:E,"aria-label":le?"Remove reaction":"React",title:le?"Remove reaction":"React",children:[G?e.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):le?e.jsx(nt,{size:16}):e.jsx(at,{size:16}),e.jsx("span",{children:X})]}),t.beatmap_url&&e.jsxs("button",{ref:D,className:"chip-btn link",onClick:r=>{r.preventDefault(),r.stopPropagation(),q(k=>!k)},title:"Beatmap options","aria-label":"Beatmap options",children:[e.jsx(Ze,{size:16}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),e.jsx(it,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),I&&Z&&t.beatmap_url&&e.jsxs("div",{ref:W,style:{position:"fixed",top:Z.top,right:Z.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>q(!1),children:[e.jsx(Ze,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),s&&e.jsx("button",{className:"menu-item",onClick:()=>{z(!0),q(!1)},children:"Preview"})]}),A&&s&&e.jsx(Lt,{open:A,onClose:()=>z(!1),downloadUrl:`${Qe}${M.osu.downloadBeatmapset(s)}`,beatmapId:Se??void 0,beatmapVersion:fe??void 0}),Pe&&e.jsx(zt,{open:w,onClose:()=>y(!1),buttonRef:h,minWidth:160,children:c?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"menu-item",onClick:r=>{r.preventDefault(),r.stopPropagation(),Ye()},children:t.is_starred?"Unstar post":"Star post"}),e.jsx("button",{className:"menu-item",onClick:r=>{r.preventDefault(),r.stopPropagation(),Be()},children:"Delete video"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"menu-item",onClick:Ue,children:"Edit post"}),e.jsx("button",{className:"menu-item",onClick:Be,children:"Delete post"})]})})]})}const ht={standard:tn,taiko:en,mania:Zt,catch:Gt},gt={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},pn=({value:t,onChange:a})=>{const[o,f]=n.useState(!1),u=n.useRef(null);n.useEffect(()=>{if(!o)return;const l=c=>{u.current&&!u.current.contains(c.target)&&f(!1)},j=c=>{c.key==="Escape"&&f(!1)};return document.addEventListener("mousedown",l),document.addEventListener("keydown",j),()=>{document.removeEventListener("mousedown",l),document.removeEventListener("keydown",j)}},[o]);const m=l=>e.jsxs("button",{className:`mode-option${l===t?" selected":""}`,onClick:()=>{a(l),f(!1)},role:"option","aria-selected":l===t,children:[e.jsx("img",{className:"mode-icon",src:ht[l],width:24,height:24,alt:""}),e.jsx("span",{children:gt[l]})]},l);return e.jsxs("div",{className:"mode-select",ref:u,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":o,onClick:()=>f(l=>!l),children:[e.jsx("img",{className:"mode-icon",src:ht[t],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:gt[t]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),o&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(m)})]})};function xt(t){if(!t)return"standard";const a=String(t).toLowerCase().trim();return a==="osu"||a==="0"||a==="standard"?"standard":a==="taiko"||a==="1"?"taiko":a==="catch"||a==="fruits"||a==="2"?"catch":a==="mania"||a==="3"?"mania":"standard"}function Tt({section:t,onUpload:a,onPost:o,forceExpanded:f}){const{notify:u}=Je(),m=t==="mappi",[l,j]=n.useState(!1),[c,_]=n.useState(""),[d,g]=n.useState(null),[x,E]=n.useState(null),[F,I]=n.useState(!1),[q,w]=n.useState(""),y=n.useRef(0),[A,z]=n.useState(""),[W,D]=n.useState("standard"),[h,Z]=n.useState(null),[U,ae]=n.useState(0),[we,J]=n.useState(""),[ge,de]=n.useState(""),[se,ce]=n.useState(null),[he,v]=n.useState(""),[X,C]=n.useState(""),[R,ee]=n.useState(null),[te,re]=n.useState(!1),[ne,xe]=n.useState(null),V=100*1024*1024,ie=n.useMemo(()=>h?`${h.name}:${h.size}:${h.lastModified}`:null,[h]),[oe,ue]=n.useState(""),[Ae,be]=n.useState(!1),[H,Pe]=n.useState([]),$e=n.useRef(null);n.useEffect(()=>{y.current&&window.clearTimeout(y.current);const L=(c||"").trim();if(!L){w(""),g(null),E(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(L)){w(""),g(null),E(null);return}return y.current=window.setTimeout(async()=>{var $;try{let P;try{P=new URL(L)}catch{w("Invalid URL format");return}const le=P.hash.match(/#osu\/(\d+)/),G=le?le[1]:null;P.hash="";const Se={url:P.toString()};G&&(Se.beatmap_id=G);const fe=await B(M.osu.resolveBeatmap+et(Se),{requireAuth:!1}),r=Array.isArray(fe==null?void 0:fe.diffs)?fe.diffs:[];if(!r.length&&!fe.setId){w("No difficulties found"),g(null),E(null);return}if(g({setId:Number(fe.setId)||0,beatmapId:fe.beatmapId??null,title:String(fe.title||""),artist:String(fe.artist||""),mapper:String(fe.mapper||""),diffs:r}),r.length>0){const k=Number.isFinite(Number(fe.beatmapId))?Number(fe.beatmapId):Number(($=r[0])==null?void 0:$.id),T=r.find(ve=>Number(ve.id)===k)||r[0],Y=xt(T==null?void 0:T.mode);E({beatmapId:Number(T==null?void 0:T.id)||null,version:String((T==null?void 0:T.version)||""),mode:Y}),m&&D(Y)}else E(null);w("")}catch(P){const le=(P==null?void 0:P.message)||"Unknown error";w(`Failed to resolve: ${le}`),g(null),E(null)}},400),()=>{y.current&&window.clearTimeout(y.current)}},[c,m]);async function He(){return de("info"),J("Requesting upload URL..."),await B(M.uploads.new,{method:"POST",body:JSON.stringify({description:A.slice(0,100),beatmap_url:c||void 0,size_bytes:(h==null?void 0:h.size)??void 0,mode:W,beatmapset_id:(d==null?void 0:d.setId)??void 0,beatmap_id:(x==null?void 0:x.beatmapId)??void 0,beatmap_version:(x==null?void 0:x.version)??void 0,beatmap_title:d?`${d.title}`:void 0,beatmap_artist:d?`${d.artist}`:void 0,beatmap_mapper:d?`${d.mapper}`:void 0})})}async function Oe(L,O,$="form"){await new Promise((P,le)=>{const G=new XMLHttpRequest;if(G.open("POST",L),G.upload.onprogress=s=>{s.lengthComputable&&ae(Math.round(s.loaded/s.total*100))},G.onload=()=>G.status>=200&&G.status<300?P():le(new Error(`Upload failed (${G.status}) ${G.responseText||""}`)),G.onerror=()=>le(new Error("Network error")),$==="form"){const s=new FormData;s.append("file",O,O.name),G.send(s)}else G.setRequestHeader("Content-Type","application/octet-stream"),G.send(O)})}async function Be(){if(!(!h||!m)){if(h.size>V){v("File exceeds 100MB limit");return}if(typeof R=="number"&&R>60.5){C("Clip exceeds 60s limit");return}ie&&(re(!0),xe(ie)),ae(0),de("info");try{const L=await He();ce(L.streamUID);let O=L.streamUID;try{J("Uploading..."),await Oe(L.uploadURL,h,"form")}catch($){de("warn"),J(`Retrying upload... (${($==null?void 0:$.message)||$})`);const P=await He();ce(P.streamUID),O=P.streamUID,await Oe(P.uploadURL,h,"binary")}de("info"),J("Processing...");for(let $=0;$<60;$++){await new Promise(P=>setTimeout(P,3e3));try{if((await B(M.videos.get(O),{requireAuth:!1})).status==="ready"){de("success"),J("Ready!"),u("Upload complete!",{variant:"success"}),Z(null),z(""),_(""),g(null),E(null),D("standard"),ae(0),ce(null),v(""),C(""),ee(null),re(!1),xe(null),a&&a();break}}catch{}}}catch(L){de("error"),J(L.message||"Error"),u(L.message||"Upload failed",{variant:"error"})}}}const Ye=async L=>{if(L.preventDefault(),!m){if(!oe.trim()){u("Text is required",{variant:"error"});return}if(oe.length>200){u("Text must be 200 characters or less",{variant:"error"});return}be(!0);try{const O=await B(M.moddi.posts,{method:"POST",body:JSON.stringify({text:oe.trim(),beatmap_url:c.trim()||void 0,beatmapset_id:(d==null?void 0:d.setId)??void 0,beatmap_id:(x==null?void 0:x.beatmapId)??(d==null?void 0:d.beatmapId)??void 0,beatmap_version:(x==null?void 0:x.version)??void 0,tags:H.length>0?H.join(","):void 0})});if(O){console.log("Post created response:",O);const $=O==null?void 0:O.post;$?(!$.uid&&$.id&&(console.warn("Created post missing uid, using id as fallback:",$),$.uid=String($.id)),o&&o($)):o&&o(),u("Post created!",{variant:"success"}),ue(""),_(""),g(null),E(null),w(""),I(!1),Pe([])}}catch{u("Failed to create post",{variant:"error"})}finally{be(!1)}}},Ue=!!f||l;return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:m?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:f?"default":"pointer",padding:"8px 12px",minHeight:36},onClick:()=>{f||j(!l)},children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:m?"Upload a clip":"Create a post!"}),Ue?e.jsx(Ot,{size:16}):e.jsx(it,{size:16})]}),Ue&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(pn,{value:W,onChange:D})]}),d?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[d.artist," – ",d.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",d.mapper]})]}),d.diffs.length>0&&e.jsx("select",{value:(x==null?void 0:x.beatmapId)??d.beatmapId??void 0,onChange:L=>{const O=Number(L.target.value),$=(d==null?void 0:d.diffs.find(P=>Number(P.id)===O))||null;if($){const P=xt($.mode);E({beatmapId:O,version:$.version,mode:P}),D(P)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:d.diffs.map(L=>e.jsxs("option",{value:L.id,children:[L.version," (",L.mode,")"]},L.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>I(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{g(null),E(null),_("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:c,onChange:L=>_(L.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:A,onChange:L=>z(L.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:q}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:L=>{var P;const O=((P=L.target.files)==null?void 0:P[0])||null;if(Z(O),ee(null),O&&O.size>V?v("File exceeds 100MB limit"):v(""),O)try{const le=URL.createObjectURL(O),G=document.createElement("video");G.preload="metadata",G.src=le,G.onloadedmetadata=()=>{URL.revokeObjectURL(le);const s=Number.isFinite(G.duration)?G.duration:NaN;Number.isFinite(s)&&ee(s),Number.isFinite(s)&&s>60.5?C("Clip exceeds 60s limit"):C("")},G.onerror=()=>{URL.revokeObjectURL(le),ee(null)}}catch{ee(null)}else C("");const $=O?`${O.name}:${O.size}:${O.lastModified}`:null;$&&$!==ne&&re(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:Be,disabled:!h||!!he||!!X||te,style:{flexShrink:0},children:"Upload"})]}),he&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:he}),X&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:X}),h&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",h.name," • ",(h.size/1024/1024).toFixed(1)," MB",te&&ne===ie?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(U>0||we)&&e.jsxs("div",{className:"upload-status",children:[we&&e.jsx("div",{className:`chip ${ge||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:we}),U>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":U,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,U))}%`}})})]}),se&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",se]})]})]}):e.jsx("form",{onSubmit:Ye,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:$e,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:oe,onChange:L=>ue(L.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),d?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[d.artist," – ",d.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",d.mapper]})]}),d.diffs.length>0&&e.jsx("select",{value:(x==null?void 0:x.beatmapId)??d.beatmapId??void 0,onChange:L=>{const O=Number(L.target.value),$=(d==null?void 0:d.diffs.find(P=>Number(P.id)===O))||null;$&&E({beatmapId:O,version:$.version,mode:String($.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:d.diffs.map(L=>e.jsxs("option",{value:L.id,children:[L.version," (",L.mode,")"]},L.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:c,onChange:L=>_(L.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:q}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{H.includes("help")?Pe(H.filter(L=>L!=="help")):Pe([...H,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:H.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:H.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:H.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>I(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{g(null),E(null),_("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:Ae||!oe.trim()||oe.length>200,children:Ae?"Posting...":"Post"})]})]})})}),F&&d&&e.jsx(Lt,{open:F,onClose:()=>I(!1),downloadUrl:M.osu.downloadBeatmapset(d.setId),beatmapId:(x==null?void 0:x.beatmapId)??d.beatmapId??void 0,beatmapVersion:x==null?void 0:x.version})]})}function fn(){const{data:t}=Rt(),{modeFilters:a}=It(),o=Object.entries(a).filter(([u,m])=>m).map(([u])=>u),f=o.length?o.join(","):"standard";return Bt({queryKey:["mappi","feed",f],queryFn:async({pageParam:u=0})=>{const m=new URLSearchParams({limit:"20",offset:String(u),modes:f}),l=`${M.feed.recent}?${m.toString()}`;return await B(l)},enabled:!!t,initialPageParam:0,getNextPageParam:(u,m)=>{var c;const l=m.reduce((_,d)=>{var g;return _+(((g=d.items)==null?void 0:g.length)||0)},0);return(((c=u.items)==null?void 0:c.length)||0)===20?l:void 0}})}function hn({open:t,onClose:a,children:o}){const f=n.useRef(null),u=n.useRef(null),m=n.useRef(!1),l=d=>{var g;u.current=((g=d.touches[0])==null?void 0:g.clientY)??null,m.current=!1},j=d=>{var F,I;if(u.current==null)return;const g=((F=d.touches[0])==null?void 0:F.clientY)??null;if(g==null)return;const x=g-u.current;(((I=f.current)==null?void 0:I.scrollTop)??0)<=0&&x>60?m.current=!0:m.current=!1},c=()=>{m.current&&a(),u.current=null,m.current=!1};if(!t)return null;const _=e.jsx("div",{className:"mobile-upload-overlay",onClick:a,children:e.jsx("div",{ref:f,className:"mobile-upload-sheet",onClick:d=>d.stopPropagation(),onTouchStart:l,onTouchMove:j,onTouchEnd:c,children:o})});return St.createPortal(_,document.body)}function gn({section:t,onUpload:a,onPost:o}){const[f,u]=Ct.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":t==="mappi"?"Upload clip":"New post",title:t==="mappi"?"Upload clip":"New post",onClick:()=>u(!0),children:e.jsx(Ut,{size:22})}),e.jsx(hn,{open:f,onClose:()=>u(!1),children:e.jsx("div",{style:{paddingTop:6},children:e.jsx(Tt,{section:t,forceExpanded:!0,onUpload:()=>{a==null||a(),u(!1)},onPost:m=>{o==null||o(m),u(!1)}})})})]})}function zn(){const t=st(),a=wt(),{data:o}=Rt(),{modeFilters:f}=It(),{data:u,fetchNextPage:m,hasNextPage:l,isFetching:j,isFetchingNextPage:c,refetch:_}=fn(),d=n.useMemo(()=>(u==null?void 0:u.pages.flatMap(w=>w.items||[]))||[],[u]),g=n.useMemo(()=>{const w=Object.entries(f).filter(([A,z])=>z).map(([A])=>A.toLowerCase()),y=new Set(w.length?w:["standard"]);return d.filter(A=>{const z=String(A.mode||"standard").toLowerCase();return y.has(z)})},[d,f]);n.useEffect(()=>{t.pathname==="/mp/feed"&&_()},[t.pathname,_]),n.useEffect(()=>{const w=()=>{_()};return window.addEventListener("filterchange",w),()=>window.removeEventListener("filterchange",w)},[_]);const x=w=>{a.setQueryData(["mappi","feed"],y=>y&&{...y,pages:y.pages.map(A=>({...A,items:A.items.map(z=>z.id===w.id?w:z)}))})},E=w=>{a.setQueryData(["mappi","feed"],y=>y&&{...y,pages:y.pages.map(A=>({...A,items:A.items.filter(z=>z.id!==w)}))})},F=()=>{_()},I=j&&!c,q=l??!1;return e.jsxs("div",{className:"feed-container mappi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"feed-header",children:[e.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),e.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Clips auto-delete after 60 days. Starred posts are preserved."}),e.jsx(Tt,{section:"mappi",onUpload:F})]}),e.jsx(gn,{section:"mappi",onUpload:F}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)",paddingBottom:"100px"},children:e.jsxs("div",{className:"col",style:{gap:0},children:[g.length===0&&!I&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No videos match the selected filter."}),g.map(w=>e.jsx(Mt,{post:w,section:"mappi",onUpdate:x,onDelete:E,me:o},w.id)),g.length>0&&q&&e.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("button",{className:"btn secondary",onClick:()=>m(),disabled:c,children:c?"Loading...":"Load more"})})]})})]})}const xn="modulepreload",bn=function(t){return"/"+t},bt={},vn=function(a,o,f){let u=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),j=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));u=Promise.allSettled(o.map(c=>{if(c=bn(c),c in bt)return;bt[c]=!0;const _=c.endsWith(".css"),d=_?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const g=document.createElement("link");if(g.rel=_?"stylesheet":xn,_||(g.as="script"),g.crossOrigin="",g.href=c,j&&g.setAttribute("nonce",j),document.head.appendChild(g),_)return new Promise((x,E)=>{g.addEventListener("load",x),g.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${c}`)))})}))}function m(l){const j=new Event("vite:preloadError",{cancelable:!0});if(j.payload=l,window.dispatchEvent(j),!j.defaultPrevented)throw l}return u.then(l=>{for(const j of l||[])j.status==="rejected"&&m(j.reason);return a().catch(m)})};function lt({comment:t,replies:a,me:o,onReply:f,onDelete:u,replyingTo:m,replyText:l,onReplyTextChange:j,onReplySubmit:c,posting:_,onCancelReply:d,section:g,repliesMap:x}){const[E,F]=n.useState(!1),I=n.useRef(null),{notify:q}=Je(),[w,y]=n.useState(!1),A=t.parent_id!==null,z=o&&(o.id===t.user_id||o.is_admin||o.is_mod),W=async()=>{if(confirm("Delete this comment?"))try{const D=g==="mappi"?M.videos.comments(t.post_id)+`/${t.id}`:M.moddi.postComments(t.post_id)+`/${t.id}`;await B(D,{method:"DELETE"}),u(t.id),q("Comment deleted",{variant:"success"})}catch{q("Failed to delete comment",{variant:"error"})}finally{F(!1)}};return e.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease"},onMouseEnter:D=>D.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:D=>D.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",children:[e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[e.jsx("span",{style:{fontSize:13,fontWeight:500},children:t.username}),e.jsx("span",{className:"muted",style:{fontSize:11},children:new Date(t.created_at*1e3).toLocaleDateString()})]}),e.jsx("div",{style:{fontSize:14,lineHeight:1.5,wordBreak:"break-word"},children:t.text}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:12,marginTop:8},children:e.jsxs("button",{onClick:()=>f(t.id),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:12,padding:0},children:[e.jsx(qt,{size:14}),"Reply"]})}),m===t.id&&o&&e.jsx("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("form",{onSubmit:c,style:{display:"flex",alignItems:"flex-end",gap:6},children:[e.jsx("textarea",{placeholder:`Reply to ${t.username}...`,value:l||"",onChange:D=>j==null?void 0:j(D.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:12,resize:"none",minHeight:"28px",maxHeight:"100px",overflowY:"auto"},onInput:D=>{const h=D.target;h.style.height="auto",h.style.height=`${Math.min(h.scrollHeight,100)}px`},autoFocus:!0}),e.jsx("button",{type:"submit",className:"btn compact",disabled:_||!(l!=null&&l.trim()),style:{padding:"5px 10px",fontSize:11,flexShrink:0},children:_?"...":"Reply"}),d&&e.jsx("button",{type:"button",onClick:d,style:{padding:"5px 10px",fontSize:11,flexShrink:0,background:"transparent",border:"1px solid rgba(255,255,255,0.12)",color:"var(--muted)",borderRadius:6,cursor:"pointer"},children:"Cancel"})]})})]}),z&&e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{ref:I,className:"icon-link",onClick:()=>F(!E),style:{width:"auto",height:"auto",padding:"4px"},title:"More options","aria-label":"More options",children:e.jsx(kt,{size:16})}),e.jsx(zt,{open:E,onClose:()=>F(!1),buttonRef:I,children:e.jsx("button",{className:"menu-item",onClick:W,style:{color:"var(--danger)"},children:"Delete"})})]})]}),a.length>0&&e.jsxs("div",{style:{marginTop:12,marginLeft:16,paddingLeft:16,borderLeft:"1px solid rgba(255,255,255,0.06)"},children:[A&&e.jsxs("button",{onClick:()=>y(!w),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:11,padding:"4px 0",marginBottom:4},children:[w?e.jsx(it,{size:12}):e.jsx(Wt,{size:12}),w?"Hide":"Show"," ",a.length," ",a.length===1?"reply":"replies"]}),(!A||w)&&e.jsx(e.Fragment,{children:a.map(D=>e.jsx(lt,{comment:D,replies:(x==null?void 0:x.get(D.id))||[],me:o,onReply:f,onDelete:u,replyingTo:m,replyText:l,onReplyTextChange:j,onReplySubmit:c,posting:_,onCancelReply:d,section:g,repliesMap:x},D.id))})]})]})}const yn=n.lazy(()=>vn(()=>import("./editor-CCRXOUzg.js").then(t=>t.d),__vite__mapDeps([0,1,2,3,4,5])).then(t=>({default:t.BeatmapEmbedOverlay}))),Ie={};function wn(){try{const t=localStorage.getItem("feed_seen_ids");if(t){const a=JSON.parse(t);Array.isArray(a)&&(Ie.seenIds=a.filter(o=>typeof o=="number"))}}catch{}return Ie}function vt(t){Object.assign(Ie,t);try{const a=Array.from(new Set(Ie.seenIds||[])).slice(-200);localStorage.setItem("feed_seen_ids",JSON.stringify(a))}catch{}}function Mn(){var ut,mt,pt;const{notify:t}=Je(),[a,o]=n.useState(Ie.history||[]),[f,u]=n.useState(Ie.index??-1),[m,l]=n.useState(Ie.queue||[]),[j,c]=n.useState(!1),[_,d]=n.useState(!1),[g,x]=n.useState(Ie.eligibleCount??null),[E,F]=n.useState(Ie.viewedCount??0),[I,q]=n.useState(!1),[w,y]=n.useState(!0),[A,z]=n.useState(!1),[W,D]=n.useState(!1),[h,Z]=n.useState(!1),[U,ae]=n.useState(!1),[we,J]=n.useState(!1),[ge,de]=n.useState([]),[se,ce]=n.useState(""),[he,v]=n.useState(null),[X,C]=n.useState(!1),[R,ee]=n.useState(null),[te,re]=n.useState(!1),ne=n.useRef(new Set(Ie.seenIds||[])),xe=n.useRef(new Set),V=n.useRef(!1),ie=n.useRef(Ie.lastShownVideoId??null),oe=n.useRef(!1),ue=n.useRef(0),Ae=n.useRef(0),be=n.useRef(0),H=n.useRef(null),Pe=n.useRef(null),$e=n.useRef(null),He=n.useRef(null),Oe=n.useRef(null),Be=n.useRef(null),Ye=n.useRef(null),Ue=n.useRef(null),L=n.useRef(0),O=n.useRef(0),$=n.useRef(null),P=n.useRef(null),[le,G]=n.useState(0),s=n.useMemo(()=>f>=0?a[f]:null,[a,f]);n.useEffect(()=>{wn()},[]),n.useEffect(()=>{vt({history:a,index:f,queue:m,seenIds:Array.from(ne.current),eligibleCount:g??void 0,viewedCount:E,lastShownVideoId:ie.current??void 0})},[a,f,m,g,E]);const Se=n.useCallback(()=>{try{const i=localStorage.getItem("filter_modes"),p=(i?String(i):"standard").toLowerCase().split(",").map(N=>N.trim()).filter(Boolean),b=["standard","taiko","mania","catch"],S=Array.from(new Set(p.filter(N=>b.includes(N))));return S.length?S:["standard"]}catch{return["standard"]}},[]),fe=n.useCallback(()=>{const i=new Set;return ie.current!==null&&i.add(ie.current),Array.from(ne.current).slice(-200).forEach(b=>i.add(b)),m.forEach(b=>i.add(b.id)),Array.from(i)},[m]),r=n.useCallback(async(i=3)=>{var S,N,K,ze;if(V.current)return[];const p=Date.now();if(p<ue.current){const pe=Math.ceil((ue.current-p)/1e3);return t(`Rate limited. Please wait ${pe}s.`,{durationMs:3e3,variant:"warn"}),[]}const b=p-be.current;if(b<2e3){const pe=2e3-b;await new Promise(We=>setTimeout(We,pe))}V.current=!0,be.current=Date.now();try{const pe=fe(),We=Se().join(","),Me=[],Fe=new Set(m.map(ke=>ke.id));let De=[...pe];const tt=Math.min(i,3);for(let ke=0;ke<tt;ke++){if(ke>0){const Q=Date.now()-Ae.current,me=1e3;Q<me&&await new Promise(Ne=>setTimeout(Ne,me-Q))}try{Ae.current=Date.now();const Q=await B(M.feed.next+et({exclude:De.join(","),modes:We}),{requireAuth:!1}),me=Q&&("id"in Q?Q:Q.video)||null;if(!me)break;if(ne.current.has(me.id)||Fe.has(me.id)||me.id===ie.current){De.push(me.id);continue}Me.push(me),De.push(me.id),Fe.add(me.id)}catch(Q){if((S=Q==null?void 0:Q.message)!=null&&S.includes("401")||(N=Q==null?void 0:Q.message)!=null&&N.includes("Unauthorized")){q(!0);break}else if((K=Q==null?void 0:Q.message)!=null&&K.includes("429")||(ze=Q==null?void 0:Q.message)!=null&&ze.includes("rate limit")){ue.current=Date.now()+5e3,t("Rate limited. Please wait a moment.",{durationMs:5e3,variant:"warn"});break}}}if(Me.length>0&&l(ke=>{const Q=new Set(ke.map(Ne=>Ne.id)),me=Me.filter(Ne=>!Q.has(Ne.id));return[...ke,...me]}),Me.length===0&&m.length===0)try{const ke=Se().join(","),Q=await B(M.feed.progress(ke),{requireAuth:!1});x(Number(Q.eligible||0)),F(Number(Q.viewed||0)),d(Number(Q.caught_up||0)===1)}catch{}return Me}catch{return[]}finally{V.current=!1}},[fe,Se,m,t]),k=n.useCallback(async()=>{if(!j){c(!0);try{m.length<=2&&r(3).catch(()=>{});let i;if(m.length>0)i=m[0],l(p=>p.filter(b=>b.id!==i.id));else{const p=await r(3);p.length>0&&(i=p[0],p.length>1&&l(b=>{const S=new Set(b.map(K=>K.id)),N=p.slice(1).filter(K=>!S.has(K.id));return[...b,...N]}))}if(i)ie.current=i.id,ne.current.add(i.id),vt({seenIds:Array.from(ne.current)}),o(p=>{const b=[...p.slice(0,f+1),i];return u(b.length-1),b}),xe.current.has(i.id)||(xe.current.add(i.id),B(M.videos.view(i.id),{method:"POST"}).then(p=>{p&&o(b=>{const S=[...b],N=S.findIndex(K=>K.id===i.id);return N!==-1&&(S[N]={...S[N],views_count:p.views_count??S[N].views_count??0,viewed_by_me:!0}),S})}).catch(()=>{}));else try{const p=Se().join(","),b=await B(M.feed.progress(p),{requireAuth:!1});x(Number(b.eligible||0)),F(Number(b.viewed||0)),d(Number(b.eligible||0)>0&&Number(b.viewed||0)>=Number(b.eligible||0))}catch{}}finally{c(!1)}}},[j,m,r,f,Se]),T=n.useCallback(()=>{H.current&&!H.current.paused&&H.current.pause(),z(!0),J(!1)},[]),Y=n.useCallback(()=>{f>0&&(u(f-1),z(!1))},[f]),ve=n.useCallback(()=>{const i=Date.now();if(!(i-O.current<300)){if(O.current=i,w||(oe.current=!0,y(!1)),f<a.length-1){const p=a[f+1];console.log("[Discover] Navigating to next video in history:",{currentIndex:f,nextIndex:f+1,currentVideoId:s==null?void 0:s.id,nextVideoId:p==null?void 0:p.id,nextVideoStreamUID:p==null?void 0:p.stream_uid}),p&&(ie.current=p.id),u(f+1),z(!1);return}if(!_){if(Date.now()<ue.current){const p=Math.ceil((ue.current-Date.now())/1e3);t(`Rate limited. Please wait ${p}s.`,{durationMs:3e3,variant:"warn"});return}console.log("[Discover] Fetching next video (queue empty)"),k()}}},[f,a,w,_,k,t,s]);n.useEffect(()=>{const i=Pe.current;if(!i)return;const p=N=>{if(I||Math.abs(N.deltaY)<Math.abs(N.deltaX))return;N.preventDefault(),N.stopPropagation();const K=Date.now();if(!(K<L.current)){if(L.current=K+1e3,!s){N.deltaY>0&&!j&&k();return}N.deltaY>0?ve():Y()}},b=N=>{$.current=N.touches[0].clientY,P.current=Date.now()},S=N=>{if(I||$.current===null||P.current===null)return;const K=N.changedTouches[0].clientY,ze=Date.now(),pe=$.current-K,We=ze-P.current;if($.current=null,P.current=null,Math.abs(pe)<50||We>300)return;const Me=Date.now();if(!(Me<L.current)){if(L.current=Me+1e3,!s){pe>0&&!j&&k();return}pe>0?ve():Y()}};return i.addEventListener("wheel",p,{passive:!1,capture:!0}),i.addEventListener("touchstart",b,{passive:!0}),i.addEventListener("touchend",S,{passive:!0}),window.addEventListener("wheel",p,{passive:!1,capture:!0}),()=>{i.removeEventListener("wheel",p,{capture:!0}),i.removeEventListener("touchstart",b),i.removeEventListener("touchend",S),window.removeEventListener("wheel",p,{capture:!0})}},[ve,Y,s,j,k,I]);const Ee=n.useCallback(async()=>{var i,p;if(!(!s||te)){re(!0);try{const b=s.liked_by_me?"DELETE":"POST",S=await B(M.videos.like(s.id),{method:b});o(N=>{const K=[...N],ze=K.findIndex(pe=>pe.id===s.id);return ze!==-1&&(K[ze]={...K[ze],liked_by_me:!s.liked_by_me,likes_count:S.likes_count}),K})}catch(b){((i=b==null?void 0:b.message)!=null&&i.includes("429")||(p=b==null?void 0:b.message)!=null&&p.includes("rate limit"))&&t("Please slow down a bit.",{durationMs:5e3,variant:"warn"})}finally{re(!1)}}},[s,te,t]),Ce=n.useCallback(async i=>{if(s)try{await B(M.videos.flag(s.id),{method:"POST",body:JSON.stringify({reason:i})}),t("Thanks for your report.",{variant:"info"})}catch{t("Report failed",{variant:"error"})}finally{Z(!1)}},[s,t]),Re=n.useCallback(async()=>{if(!s)return;const i=!s.is_starred,p=i?"star":"unstar";try{await B(M.admin.videosAction(s.id,p),{method:"POST"}),o(b=>{const S=[...b],N=S.findIndex(K=>K.id===s.id);return N!==-1&&(S[N]={...S[N],is_starred:i}),S}),ae(!1),t(i?"Post starred":"Star removed",{variant:"success"})}catch{t("Action failed",{variant:"error"})}},[s,t]),ye=n.useCallback(async()=>{if(!(!s||!confirm("Permanently delete this video?")))try{await B(M.videos.delete(s.id),{method:"DELETE"}),t("Deleted",{variant:"warn"}),Z(!1),o(i=>{const p=i.filter((b,S)=>S!==f);return p.length===0?(u(-1),setTimeout(k,0)):u(b=>Math.max(0,Math.min(b,p.length-1))),p})}catch{alert("Delete failed")}},[s,f,k,t]),_e=n.useCallback(async()=>{if(s!=null&&s.id)try{const i=await B(M.videos.comments(s.id),{requireAuth:!1});de(i.items||[])}catch{}},[s==null?void 0:s.id]);n.useEffect(()=>{W&&(s!=null&&s.id)&&_e()},[W,s==null?void 0:s.id,_e]);const Xe=n.useCallback(async i=>{if(i.preventDefault(),!(!se.trim()||!(s!=null&&s.id))){C(!0);try{await B(M.videos.comments(s.id),{method:"POST",body:JSON.stringify({text:se.trim(),parent_id:he||void 0})}),ce(""),v(null),_e(),o(p=>{const b=[...p],S=b.findIndex(N=>N.id===s.id);return S!==-1&&(b[S]={...b[S],comments_count:(b[S].comments_count||0)+1}),b}),t("Comment posted!",{variant:"success"})}catch(p){t((p==null?void 0:p.message)||"Failed to post comment",{variant:"error"})}finally{C(!1)}}},[se,s,he,_e,t]),Le=n.useCallback(i=>{de(p=>p.filter(b=>b.id!==i)),o(p=>{const b=[...p],S=b.findIndex(N=>N.id===(s==null?void 0:s.id));return S!==-1&&(b[S]={...b[S],comments_count:Math.max(0,(b[S].comments_count||0)-1)}),b})},[s==null?void 0:s.id]),{topLevelComments:Ge,repliesMap:dt}=n.useMemo(()=>{const i=ge.filter(b=>!b.parent_id),p=new Map;return ge.filter(b=>b.parent_id).forEach(b=>{const S=b.parent_id;p.has(S)||p.set(S,[]),p.get(S).push(b)}),{topLevelComments:i,repliesMap:p}},[ge]),Pt=n.useCallback(()=>{if(!H.current)return;const i=!w;y(i),H.current.muted=i,i||(oe.current=!0),!i&&H.current.paused&&H.current.play().catch(()=>{})},[w]),$t=n.useCallback(i=>{H.current=i,i&&(i.muted=w)},[w]);n.useEffect(()=>{z(!1),D(!1),oe.current?y(!1):y(!0)},[s==null?void 0:s.id,s==null?void 0:s.stream_uid,f,a.length]),n.useEffect(()=>{H.current&&(H.current.muted=w)},[w]),n.useEffect(()=>{if(!s)return;const i=!oe.current;y(i);const p=setTimeout(()=>{H.current&&(H.current.muted=i)},100);return()=>clearTimeout(p)},[s==null?void 0:s.id]),n.useEffect(()=>{s&&(ie.current=s.id)},[s==null?void 0:s.id]),n.useEffect(()=>{A&&H.current&&!H.current.paused&&H.current.pause()},[A]),n.useEffect(()=>{a.length===0&&k()},[]),n.useEffect(()=>{(async()=>{try{const i=Se().join(","),p=await B(M.feed.progress(i),{requireAuth:!1}),b=Number(p.eligible||0),S=Number(p.viewed||0);x(b),F(S),d(b>0&&S>=b)}catch{}})()},[Se]),n.useEffect(()=>{const i=()=>{o([]),l([]),ne.current.clear(),ie.current=null,u(-1),d(!1),(async()=>{try{const p=Se().join(","),b=await B(M.feed.progress(p),{requireAuth:!1}),S=Number(b.eligible||0),N=Number(b.viewed||0);x(S),F(N),d(!1)}catch{}k()})()};return window.addEventListener("filterchange",i),()=>window.removeEventListener("filterchange",i)},[Se,k]),n.useEffect(()=>{(async()=>{try{const i=await B(M.auth.me,{requireAuth:!1});ee(i)}catch{}})()},[]);const[qe,Ft]=n.useState(()=>typeof window<"u"?Ke():!1);n.useEffect(()=>{const i=()=>{const p=document.querySelector(".top-nav");p&&G(p.offsetHeight),Ft(Ke())};return i(),window.addEventListener("resize",i),()=>{window.removeEventListener("resize",i)}},[]),n.useEffect(()=>{var b;if(!$e.current||!He.current||!s||!H.current)return;const i=()=>{var We;const S=(We=He.current)==null?void 0:We.querySelector("div"),N=H.current;if(!S||!N||!$e.current)return;const K=$e.current,ze=Ke();let pe;if(s.width&&s.height?pe=s.width/s.height:N.videoWidth>0&&N.videoHeight>0?pe=N.videoWidth/N.videoHeight:pe=16/9,ze){const Fe=K.offsetWidth,De=Fe/pe;S.style.width=`${Fe}px`,S.style.height=`${De}px`,S.style.maxWidth="100%",S.style.maxHeight="100%"}else{const Fe=K.offsetWidth-32,De=K.offsetHeight-32,tt=16/9,ke=Fe/tt;let me=Math.min(De,ke),Ne=me*pe;Ne>Fe&&(Ne=Fe,me=Ne/pe),me>De&&(me=De,Ne=me*pe),S.style.width=`${Ne}px`,S.style.height=`${me}px`,S.style.maxWidth="100%",S.style.maxHeight="100%"}},p=()=>{requestAnimationFrame(i)};if(H.current.readyState>=1)i();else{const S=()=>{var N;i(),(N=H.current)==null||N.removeEventListener("loadedmetadata",S)};(b=H.current)==null||b.addEventListener("loadedmetadata",S)}return window.addEventListener("resize",p),()=>{window.removeEventListener("resize",p)}},[s==null?void 0:s.id,s==null?void 0:s.width,s==null?void 0:s.height]),n.useEffect(()=>{if(!h)return;const i=p=>{Oe.current&&!Oe.current.contains(p.target)&&Z(!1)};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[h]),n.useEffect(()=>{if(!U)return;const i=p=>{Be.current&&!Be.current.contains(p.target)&&ae(!1)};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[U]),n.useEffect(()=>{if(!we)return;const i=p=>{Ye.current&&!Ye.current.contains(p.target)&&Ue.current&&!Ue.current.contains(p.target)&&J(!1)};return document.addEventListener("mousedown",i),()=>{document.removeEventListener("mousedown",i)}},[we]);const ct=!!(R!=null&&R.is_admin||R!=null&&R.is_mod);return e.jsxs(e.Fragment,{children:[e.jsx(sn,{paused:qe}),e.jsx("style",{children:`
        .video-area .discover-player-wrapper {
          position: relative !important;
          width: 100% !important;
          height: 100% !important;
          max-width: 100% !important;
          max-height: 100% !important;
          min-height: 100% !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          box-sizing: border-box !important;
        }
        .video-area .discover-player-wrapper > div {
          position: relative !important;
          /* Dimensions will be set by JavaScript to ensure proper fit */
          box-sizing: border-box !important;
          /* Center the video within container */
          flex-shrink: 1 !important;
          min-width: 0 !important;
          min-height: 0 !important;
          align-self: center !important;
        }
        .video-area .discover-player-wrapper > div[style] {
          /* JavaScript will set width and height, but ensure max constraints */
          max-width: 100% !important;
          max-height: 100% !important;
          box-sizing: border-box !important;
          flex-shrink: 1 !important;
          min-width: 0 !important;
          min-height: 0 !important;
        }
        /* Ensure wrapper constrains width to prevent overflow */
        .video-area .discover-player-wrapper {
          max-width: 100% !important;
          width: 100% !important;
          overflow: hidden !important;
          /* Use flexbox to center and constrain */
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
        }
        .video-area .discover-player-wrapper video {
          /* Ensure video content is fully visible - no cropping */
          width: 100% !important;
          height: 100% !important;
          object-fit: contain !important;
          max-width: 100% !important;
          max-height: 100% !important;
        }
        /* Mobile-specific: ensure videos take full width */
        html.is-mobile .video-area .discover-player-wrapper > div,
        html.is-mobile .video-area .discover-player-wrapper > div[style] {
          min-width: 100% !important;
          max-width: 100% !important;
        }
      `}),e.jsxs("div",{ref:Pe,className:"player-wrap",style:{height:"100dvh",width:"100vw",position:"fixed",top:qe?"calc(0px - env(safe-area-inset-top, 0px))":0,left:0,right:0,bottom:0,overflow:"hidden",background:"transparent",zIndex:1,margin:0,padding:0,boxSizing:"border-box"},children:[_&&e.jsx("div",{className:"chip info",style:{position:"absolute",top:le+20,left:"50%",transform:"translateX(-50%)",zIndex:10,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(10px)"},children:"You're all caught up. Check 'Feed' to watch videos you've seen already."}),e.jsx("div",{ref:$e,className:"video-area discover-video-container",style:{position:"absolute",top:qe?0:le,left:0,right:0,bottom:qe?"-10px":0,maxHeight:qe?"calc(100dvh + env(safe-area-inset-top, 0px) + 2px)":`calc(100dvh - ${le}px)`,height:qe?"calc(100dvh + env(safe-area-inset-top, 0px) + 2px)":`calc(100dvh - ${le}px)`,display:"flex",alignItems:"center",justifyContent:"center",background:"#000",transition:qe?"none":"bottom 0.3s ease-out, max-height 0.3s ease-out, height 0.3s ease-out",overflow:"hidden",boxSizing:"border-box",padding:qe?"0":"16px",maxWidth:"100vw",width:"100%"},children:I?e.jsxs("div",{className:"col",style:{alignItems:"center",zIndex:10},children:[e.jsx("div",{className:"muted",style:{marginBottom:8},children:"Please log in to view videos."}),e.jsx("button",{className:"btn",onClick:()=>window.location.href=Qe+M.auth.login,children:"Login with osu!"})]}):s?e.jsx("div",{style:{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",boxSizing:"border-box",overflow:"hidden"},children:e.jsxs("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:10,pointerEvents:"none"}}),e.jsxs("div",{onClick:Pt,style:{position:"relative",width:"100%",height:"100%",cursor:"pointer",zIndex:1,display:"flex",alignItems:"center",justifyContent:"center",maxWidth:"100%",maxHeight:"100%"},children:[e.jsx("div",{ref:He,className:"discover-player-wrapper",children:e.jsx(ot,{streamUID:s.stream_uid,playbackUrl:s.playback_url,aspectRatio:s.width&&s.height?s.width/s.height:null,preferNative:!0,autoplay:!0,loop:!0,muted:w,controls:!1,onVideoRef:$t})}),e.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"rgba(0,0,0,0.6)",backdropFilter:"blur(10px)",borderRadius:"50%",width:56,height:56,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",transition:"opacity 0.3s ease",opacity:w?1:0,zIndex:2},children:w?e.jsx(Yt,{size:28,color:"#fff"}):e.jsx(Vt,{size:28,color:"#fff"})})]})]})}):_?null:e.jsxs("div",{className:"muted",style:{zIndex:10,textAlign:"center",padding:"20px",maxWidth:"400px",pointerEvents:"none"},children:[e.jsx("div",{style:{marginBottom:12,fontSize:14,fontWeight:500},children:"How to navigate"}),e.jsxs("div",{style:{fontSize:12,lineHeight:1.6},children:[e.jsx("div",{children:"• Scroll up/down or swipe to change videos"}),e.jsx("div",{children:"• Click video to toggle mute/unmute"}),e.jsx("div",{children:"• Hold to pause temporarily"})]})]})}),s&&!A&&e.jsxs("div",{style:{position:"absolute",right:16,top:"50%",display:"flex",flexDirection:"column",gap:20,alignItems:"center",zIndex:15,pointerEvents:"auto",transform:"translateY(-50%) scale(1)",transformOrigin:"center right"},onClick:i=>i.stopPropagation(),children:[e.jsx(Ve,{to:`/profile/${(ut=s.uploader)==null?void 0:ut.id}`,style:{width:48,height:48,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.3)",overflow:"hidden",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",textDecoration:"none"},children:(mt=s.uploader)!=null&&mt.avatar_url?e.jsx("img",{src:s.uploader.avatar_url,width:48,height:48,style:{borderRadius:"50%",objectFit:"cover",display:"block"},alt:s.uploader.username}):e.jsx("div",{style:{width:48,height:48,background:"rgba(255,255,255,0.1)"}})}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[e.jsx("button",{onClick:Ee,disabled:te,"aria-label":s.liked_by_me?"Unlike":"Like",title:s.liked_by_me?"Unlike":"Like",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:s.liked_by_me?"#f87171":"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:i=>i.currentTarget.style.transform="scale(1.1)",onMouseLeave:i=>i.currentTarget.style.transform="scale(1)",children:s.liked_by_me?e.jsx(nt,{size:28}):e.jsx(at,{size:28})}),e.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:s.likes_count??0})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[e.jsx("button",{onClick:()=>D(!0),"aria-label":"Comments",title:"Comments",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:i=>i.currentTarget.style.transform="scale(1.1)",onMouseLeave:i=>i.currentTarget.style.transform="scale(1)",children:e.jsx(Et,{size:28})}),e.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:s.comments_count??0})]}),s.beatmap_url&&e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{ref:Ue,onClick:()=>J(i=>!i),title:"Beatmap options","aria-label":"Beatmap options",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:i=>i.currentTarget.style.transform="scale(1.1)",onMouseLeave:i=>i.currentTarget.style.transform="scale(1)",children:e.jsx(Ze,{size:24})}),we&&e.jsxs("div",{ref:Ye,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:s.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>J(!1),children:[e.jsx(Ze,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),s.beatmapset_id&&e.jsx("button",{className:"menu-item",onClick:T,children:"Preview"})]})]}),ct?e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{onClick:()=>ae(i=>!i),title:"Manage","aria-label":"Manage",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:i=>i.currentTarget.style.transform="scale(1.1)",onMouseLeave:i=>i.currentTarget.style.transform="scale(1)",children:e.jsx(ft,{size:24})}),U&&e.jsxs("div",{ref:Be,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:180,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsx("button",{className:"menu-item",onClick:Re,children:s.is_starred?"Unstar post":"Star post"}),e.jsx("button",{className:"menu-item",onClick:ye,children:"Delete video"})]})]}):e.jsx("button",{onClick:()=>Z(i=>!i),title:"Report","aria-label":"Report",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:i=>i.currentTarget.style.transform="scale(1.1)",onMouseLeave:i=>i.currentTarget.style.transform="scale(1)",children:e.jsx(Kt,{size:24})}),h&&e.jsxs("div",{ref:Oe,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsx("div",{className:"muted",style:{fontSize:12,padding:"4px 8px"},children:"Report as…"}),e.jsx("button",{className:"menu-item",onClick:()=>Ce("unrelated"),children:"Unrelated"}),e.jsx("button",{className:"menu-item",onClick:()=>Ce("explicit"),children:"Explicit"}),ct&&e.jsx("button",{className:"menu-item",onClick:ye,children:"Delete video"})]})]}),s&&!A&&e.jsxs("div",{style:{position:"absolute",left:16,bottom:80,right:80,zIndex:15,pointerEvents:"none",display:"flex",flexDirection:"column",gap:12,transformOrigin:"bottom left"},onClick:i=>i.stopPropagation(),children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,pointerEvents:"auto"},children:e.jsx(Ve,{to:`/profile/${(pt=s.uploader)==null?void 0:pt.id}`,style:{textDecoration:"none",color:"#fff",fontWeight:600,fontSize:"clamp(14px, 16px, 18px)",display:"flex",alignItems:"center",gap:8,textShadow:"0 1px 3px rgba(0,0,0,0.8)",transition:"font-size 0.3s ease-out"},children:(()=>{var S,N,K;const i=(S=s.uploader)==null?void 0:S.is_admin,p=(N=s.uploader)==null?void 0:N.is_mod,b=i?"#fff3bf":p?"#d7fbe8":"#fff";return e.jsxs(e.Fragment,{children:[e.jsxs("span",{style:{color:b},children:["@",(K=s.uploader)==null?void 0:K.username]}),s.is_starred&&e.jsx(rt,{size:16,color:"#f59e0b",title:"Starred"}),(i||p)&&e.jsx(ft,{size:14,color:b,title:i?"admin":"mod"})]})})()})}),(s.description??"").trim()&&e.jsx("div",{style:{color:"#fff",fontSize:"clamp(12px, 14px, 16px)",lineHeight:1.5,textShadow:"0 1px 3px rgba(0,0,0,0.8)",maxWidth:"85%",wordBreak:"break-word",pointerEvents:"auto",transition:"font-size 0.3s ease-out"},children:s.description}),s.beatmap_title&&e.jsxs("div",{style:{color:"rgba(255,255,255,0.9)",fontSize:"clamp(11px, 13px, 15px)",textShadow:"0 1px 3px rgba(0,0,0,0.8)",pointerEvents:"auto",transition:"font-size 0.3s ease-out"},children:[s.beatmap_artist," – ",s.beatmap_title," ",s.beatmap_mapper?`(by ${s.beatmap_mapper})`:""," ",s.beatmap_version?`[${s.beatmap_version}]`:""]})]}),W&&s&&e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
              @keyframes slideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
              }
            `}),e.jsxs("div",{style:{position:"fixed",bottom:0,left:0,right:0,height:"50%",background:"var(--panel)",borderTop:"1px solid rgba(255,255,255,0.08)",borderTopLeftRadius:20,borderTopRightRadius:20,display:"flex",flexDirection:"column",zIndex:20,boxShadow:"0 -4px 20px rgba(0,0,0,0.3)",animation:"slideUp 0.3s ease-out"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px 20px",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:[e.jsxs("div",{style:{fontSize:18,fontWeight:600},children:["Comments (",s.comments_count??0,")"]}),e.jsx("button",{onClick:()=>D(!1),style:{background:"transparent",border:"none",color:"var(--text)",cursor:"pointer",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center"},"aria-label":"Close comments",children:e.jsx(_t,{size:24})})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"8px 0"},children:Ge.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:Ge.map(i=>e.jsx(lt,{comment:i,replies:dt.get(i.id)||[],me:R,section:"mappi",onReply:p=>v(p),onDelete:Le,replyingTo:he,replyText:se,onReplyTextChange:ce,onReplySubmit:Xe,posting:X,onCancelReply:()=>{v(null),ce("")},repliesMap:dt},i.id))})}),R&&!he&&e.jsx("div",{style:{padding:"12px 20px",borderTop:"1px solid rgba(255,255,255,0.06)",background:"var(--panel-dark)"},children:e.jsxs("form",{onSubmit:Xe,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:se,onChange:i=>ce(i.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"8px 12px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"36px",maxHeight:"120px",overflowY:"auto"},onInput:i=>{const p=i.target;p.style.height="auto",p.style.height=`${Math.min(p.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:X||!se.trim(),style:{padding:"8px 16px",fontSize:13,flexShrink:0},children:X?"...":"Post"})]})})]})]}),A&&(s==null?void 0:s.beatmapset_id)&&e.jsx(n.Suspense,{fallback:null,children:e.jsx(yn,{open:A,onClose:()=>z(!1),downloadUrl:`${Qe}${M.osu.downloadBeatmapset(s.beatmapset_id)}`,beatmapId:s.beatmap_id??void 0,beatmapVersion:s.beatmap_version??void 0})})]})]})}const Sn=({streamUID:t,playbackUrl:a,aspectRatio:o,onClose:f,headerLeft:u,headerRight:m,children:l,beatmapDownloadUrl:j,beatmapVersion:c,beatmapId:_,onOpenInEditor:d})=>{const g=typeof o=="number"&&isFinite(o)&&o>0?o:1.7777777777777777,x=!!j;return Ct.useEffect(()=>(document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}),[]),e.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:E=>E.stopPropagation(),children:[e.jsx("div",{className:"overlay-backdrop",onClick:f}),e.jsxs("div",{className:"overlay-card",onClick:E=>E.stopPropagation(),children:[e.jsx("button",{className:"overlay-close",onClick:f,"aria-label":"Close",children:e.jsx(_t,{size:18})}),e.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:x?0:"auto",maxHeight:x?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:E=>E.stopPropagation(),children:x?e.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:e.jsx(nn,{downloadUrl:j,beatmapVersion:c,beatmapId:_,onOpenInEditor:d})}):e.jsx(ot,{streamUID:t||void 0,playbackUrl:a||void 0,aspectRatio:g,inOverlay:!0})}),(u||m||l)&&e.jsxs("div",{className:"section-panel",children:[(u||m)&&e.jsxs("div",{className:"row-between",children:[e.jsx("div",{className:"row",style:{alignItems:"center"},children:u}),m?e.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:m}):e.jsx("div",{})]}),l]})]})]})};function Tn(){var ce,he,v,X;const{uid:t}=Qt(),[a,o]=Jt(),f=jt(),m=((ce=st().state)==null?void 0:ce.returnTo)||"/mp/feed",[l,j]=n.useState(null),[c,_]=n.useState([]),[d,g]=n.useState(!0),[x,E]=n.useState(null),[F,I]=n.useState(""),[q,w]=n.useState(null),[y,A]=n.useState(!1),[z,W]=n.useState(!1),{notify:D}=Je(),h=n.useRef(new Set);n.useEffect(()=>{B(M.auth.me,{requireAuth:!1}).then(C=>E(C)).catch(()=>{})},[]),n.useEffect(()=>{a.get("preview")==="true"&&W(!0)},[a]);const Z=async()=>{if(t){g(!0);try{const C=await B(M.videos.get(t),{requireAuth:!1});j(C)}catch{D("Failed to load post",{variant:"error"}),f(m)}finally{g(!1)}}},U=async()=>{if(l!=null&&l.id)try{const C=await B(M.videos.comments(l.id),{requireAuth:!1});_(C.items||[])}catch{}};n.useEffect(()=>{Z()},[t]),n.useEffect(()=>{l!=null&&l.id&&U()},[l==null?void 0:l.id]),n.useEffect(()=>{l!=null&&l.id&&(h.current.has(l.id)||(h.current.add(l.id),B(M.videos.view(l.id),{method:"POST"}).then(C=>{if(!C)return;const R=Number(C.views_count??0);j(ee=>ee?{...ee,views_count:R,viewed_by_me:!0}:null)}).catch(()=>{})))},[l==null?void 0:l.id]);const ae=C=>{"stream_uid"in C&&j(C)},we=()=>{f(m)},J=async C=>{if(C.preventDefault(),!(!F.trim()||!(l!=null&&l.id))){A(!0);try{await B(M.videos.comments(l.id),{method:"POST",body:JSON.stringify({text:F.trim(),parent_id:q||void 0})}),I(""),w(null),U(),Z(),D("Comment posted!",{variant:"success"})}catch(R){D((R==null?void 0:R.message)||"Failed to post comment",{variant:"error"})}finally{A(!1)}}},ge=C=>{_(R=>R.filter(ee=>ee.id!==C))};if(d)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!l)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const de=c.filter(C=>!C.parent_id),se=new Map;return c.filter(C=>C.parent_id).forEach(C=>{const R=C.parent_id;se.has(R)||se.set(R,[]),se.get(R).push(C)}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>f(m),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(Xt,{size:20})}),e.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(Mt,{post:l,section:"mappi",onUpdate:ae,onDelete:we,me:x})}),x&&!q&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:J,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:F,onChange:C=>I(C.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:C=>{const R=C.target;R.style.height="auto",R.style.height=`${Math.min(R.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:y||!F.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:y?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:de.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:de.map(C=>e.jsx(lt,{comment:C,replies:se.get(C.id)||[],me:x,section:"mappi",onReply:R=>w(R),onDelete:ge,replyingTo:q,replyText:F,onReplyTextChange:I,onReplySubmit:J,posting:y,onCancelReply:()=>{w(null),I("")},repliesMap:se},C.id))})})]}),l&&z&&l.beatmapset_id&&e.jsx(Sn,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{W(!1),o({})},beatmapDownloadUrl:`${Qe}${M.osu.downloadBeatmapset(l.beatmapset_id)}`,beatmapId:l.beatmap_id??void 0,beatmapVersion:l.beatmap_version??void 0,onOpenInEditor:()=>{W(!1),o({}),window.location.hash="/editor"},headerLeft:e.jsxs(e.Fragment,{children:[((he=l.uploader)==null?void 0:he.avatar_url)&&e.jsx("img",{src:l.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),e.jsxs(Ve,{to:`/profile/${(v=l.uploader)==null?void 0:v.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[e.jsx("span",{children:(X=l.uploader)==null?void 0:X.username}),l.is_starred?e.jsx(rt,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{M as A,sn as B,Tt as C,Mn as D,zn as F,gn as M,Mt as P,Nn as T,B as a,It as b,Je as c,lt as d,hn as e,et as f,cn as g,Qe as h,In as i,Rn as j,Ke as k,Ln as l,Tn as m,Rt as u};

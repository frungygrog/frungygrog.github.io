import{r as o,j as F,Z as G}from"./vendor-react-C7NF2CWg.js";import{H as i}from"./vendor-RuoRctBR.js";const J=({playbackUrl:v,streamUID:w,aspectRatio:s,preferNative:H=!1,autoplay:c=!1,loop:b=!1,muted:A=!1,controls:T=!0,onVideoRef:m,onClick:M,inOverlay:l=!1})=>{const S=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,d=o.useRef(null),[j,k]=o.useState(null),D=o.useMemo(()=>{const e=typeof s=="number"&&isFinite(s)&&s>0?s:null;return e||16/9},[s]),C=`${j??D} / 1`,r=o.useMemo(()=>v||(w?`https://videodelivery.net/${w}/manifest/video.m3u8`:null),[v,w]),O=o.useRef(null);o.useEffect(()=>{r&&(O.current=r)},[r]),o.useEffect(()=>{k(null)},[r]),o.useEffect(()=>{if(!H||!d.current)return;const e=d.current;let p=!1;const n=()=>{if(!p)if(e.videoWidth>0&&e.videoHeight>0){const L=e.videoWidth/e.videoHeight;k(L),p=!0}else k(D),p=!0};return e.addEventListener("loadedmetadata",n),e.readyState>=1&&n(),()=>{e.removeEventListener("loadedmetadata",n)}},[H,D,r]);const R=o.useRef(null),E=o.useRef(null);o.useEffect(()=>{if(!r)return;let e=R.current,p=null,n=!1,L=null;if(e&&E.current&&E.current!==r){console.log(`[HLS] URL changed from ${E.current} to ${r}, using loadSource`);try{e.stopLoad(),e.loadSource(r),E.current=r;const t=d.current;if(t)try{t.pause(),t.currentTime=0,t.load()}catch(u){console.warn("[HLS] Error resetting video element:",u)}}catch(t){console.error("[HLS] Error switching source:",t);try{e.destroy()}catch{}e=null,R.current=null,E.current=null}}if(e&&E.current===r)return console.log(`[HLS] URL unchanged (${r}), reusing existing HLS instance`),()=>{n=!0};const P=()=>{if(document.hidden&&e){const t=d.current;if(t)try{t.pause()}catch{}try{e.stopLoad()}catch{}}},W=()=>{if(n=!0,e){try{e.stopLoad(),e.detachMedia(),e.destroy()}catch{}e=null}};document.addEventListener("visibilitychange",P),window.addEventListener("beforeunload",W);const B=()=>{const t=d.current;if(!t||n)return;try{for(t.pause(),t.currentTime=0,t.src="",t.srcObject=null;t.firstChild;)t.removeChild(t.firstChild);t.load()}catch(y){console.warn("[HLS] Error resetting video element:",y)}const u=performance.now();if(console.log(`[HLS] Starting HLS setup for ${r} at ${u.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:t.readyState,isConnected:t.isConnected,paused:t.paused,currentTime:t.currentTime}),i.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const y={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const x=performance.now();e=new i(y),R.current=e,E.current=r;const g=performance.now()-x;console.log(`[HLS] HLS instance created in ${g.toFixed(2)}ms`);const a=performance.now();e.loadSource(r);const f=performance.now()-a;console.log(`[HLS] loadSource() called in ${f.toFixed(2)}ms`);const h=performance.now();e.attachMedia(t);const I=performance.now()-h;console.log(`[HLS] attachMedia() completed in ${I.toFixed(2)}ms`);const q=performance.now()-u;console.log(`[HLS] Total HLS setup time: ${q.toFixed(2)}ms`)}catch(x){const g=performance.now()-u;if(console.error(`[HLS] Failed to initialize HLS after ${g.toFixed(2)}ms:`,x),e){try{e.destroy()}catch{}e=null}return}e.on(i.Events.MANIFEST_PARSED,()=>{const x=performance.now()-u;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${x.toFixed(2)}ms after setup start`),n||!t)return;b&&(L=()=>{if(!(n||!t||!e))try{t.currentTime=0,t.play().catch(a=>{a.name!=="AbortError"&&a.name!=="NotAllowedError"&&console.debug("Loop play failed:",a)})}catch{t.currentTime=0,t.play().catch(()=>{})}},t.addEventListener("ended",L)),(()=>{if(!(n||!t))if(t.readyState>=2){if(c){const a=performance.now();t.play().then(()=>{const f=performance.now()-a;console.log(`[HLS] Autoplay succeeded in ${f.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(f=>{const h=performance.now()-a;f.name!=="AbortError"&&f.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${h.toFixed(2)}ms:`,f)})}}else{const a=()=>{if(!(n||!t)&&(t.removeEventListener("canplay",a),c)){const f=performance.now();t.play().then(()=>{const h=performance.now()-f;console.log(`[HLS] Autoplay succeeded in ${h.toFixed(2)}ms after canplay event`)}).catch(h=>{const I=performance.now()-f;h.name!=="AbortError"&&h.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${I.toFixed(2)}ms:`,h)})}};t.addEventListener("canplay",a,{once:!0})}})()}),e.on(i.Events.ERROR,(x,g)=>{if(!n&&g.fatal)switch(g.type){case i.ErrorTypes.NETWORK_ERROR:if(!n&&e)try{e.startLoad()}catch{}break;case i.ErrorTypes.MEDIA_ERROR:if(!n&&e)try{e.recoverMediaError()}catch{}break;default:e&&(e.destroy(),e=null);break}})}else n||console.warn("HLS.js not supported, falling back to native HLS"),t.src=r,t.loop=b,p=()=>{n||console.warn("Native HLS playback failed")},t.addEventListener("error",p),c&&!n&&t.play().catch(y=>{y.name!=="AbortError"&&y.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",y)})};let _=0;const z=10,$=()=>{if(n)return;if(_++,_>z){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const t=d.current;if(!t){requestAnimationFrame($);return}if(!t.isConnected){requestAnimationFrame($);return}B()},U=requestAnimationFrame(()=>{requestAnimationFrame($)});return()=>{cancelAnimationFrame(U),n=!0,document.removeEventListener("visibilitychange",P),window.removeEventListener("beforeunload",W);const t=d.current;if(t&&L&&(t.removeEventListener("ended",L),L=null),e){try{e.stopLoad(),e.off(i.Events.MANIFEST_PARSED),e.off(i.Events.ERROR),e.off(i.Events.MEDIA_ATTACHED),e.off(i.Events.MEDIA_DETACHED),e.off(i.Events.MANIFEST_LOADED),e.off(i.Events.MEDIA_ATTACHING),e.off(i.Events.MEDIA_DETACHING),e.off(i.Events.DESTROYING),e.destroy()}catch{try{e&&e.detachMedia()}catch{}}e=null,R.current=null,E.current=null}if(t){p&&(t.removeEventListener("error",p),p=null);try{t.pause()}catch{}}}},[r,c]),o.useEffect(()=>(m&&d.current&&m(d.current),()=>{m&&m(null)}),[m,H,r]);const N=S||!l?{height:"100%",maxHeight:"100%",width:"auto",maxWidth:"100%",aspectRatio:C,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"100%",maxWidth:"100%",maxHeight:"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",aspectRatio:C,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"};return r?F.jsx("div",{style:N,children:F.jsx("video",{ref:d,autoPlay:c,loop:!1,muted:A,controls:T,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:M?"pointer":"default"},children:"Your browser does not support the video tag."})}):F.jsx("div",{style:N,children:"No video available"})},Q=({open:v,onClose:w,buttonRef:s,children:H,align:c="right",minWidth:b=160})=>{const[A,T]=o.useState(null),m=o.useRef(null);if(o.useEffect(()=>{if(!v||!s.current){T(null);return}const l=()=>{if(!s.current)return;const S=s.current.getBoundingClientRect();T({top:S.bottom+8,[c]:window.innerWidth-S[c==="right"?"right":"left"]})};return l(),window.addEventListener("resize",l),window.addEventListener("scroll",l,!0),()=>{window.removeEventListener("resize",l),window.removeEventListener("scroll",l,!0)}},[v,s,c]),o.useEffect(()=>{if(!v)return;const l=S=>{m.current&&!m.current.contains(S.target)&&s.current&&!s.current.contains(S.target)&&w()};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[v,w,s]),!v||!A)return null;const M=F.jsx("div",{ref:m,style:{position:"fixed",top:A.top,[c]:A[c],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:b,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:H});return G.createPortal(M,document.body)};export{J as P,Q as a};

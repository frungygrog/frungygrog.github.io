import{u as _e,e as me,f as Ne,r,s as ut,i as mt,j as e,z as Ye,h as ke,C as Je,L as Xe,D as gt,E as ce,R as ae,t as Te,q as pt,p as xe,o as Ee,k as ht,G as ft,H as xt,I as ue,g as Ke,J as we,K as Le,M as yt,c as fe,N as Ge,O as bt,P as vt,Q as De,S as Be,A as We,m as Qe,T as Oe,U as Ue}from"./vendor-react-5Lxm-uQd.js";import{a as S,A as w,g as jt,u as ge,b as Ce,C as St,M as wt,P as Ze,c as le,d as _t,e as ze,f as Nt,h as kt}from"./mappi-routes-XOagACVu.js";import{B as Tt}from"./editor-CCRXOUzg.js";function Ct(t=!0){return _e({queryKey:["notifications"],queryFn:async()=>{try{const i=await S(w.user.notifications);return Array.isArray(i.items)?i.items:[]}catch{return[]}},enabled:t,refetchInterval:45*1e3})}function zt(){return _e({queryKey:["notifications","detailed"],queryFn:async()=>{try{const t=await S("/api/me/notifications/detailed");return Array.isArray(t.items)?t.items:[]}catch{return[]}},refetchInterval:30*1e3})}function Wt(){const{data:t=[]}=Ct();return t.filter(i=>i.kind==="system"&&i.id.startsWith("b:")&&(i.expiresAt||0)<=Date.now()?!1:!i.read).length}function It(){const t=me();return Ne({mutationFn:async i=>{await S(w.user.markNotificationsRead,{method:"POST",body:JSON.stringify({ids:i})})},onSuccess:()=>{t.setQueryData(["notifications"],i=>(i==null?void 0:i.map(a=>({...a,read:!0})))||[])}})}function Ft(){const t=me();return Ne({mutationFn:async i=>{const a=jt();await S(w.user.deleteNotification(i),{method:"DELETE",headers:{"X-CSRF-Token":a}})},onSuccess:(i,a)=>{t.setQueryData(["notifications"],p=>(p==null?void 0:p.filter(c=>c.id!==a))||[]),t.setQueryData(["notifications","detailed"],p=>(p==null?void 0:p.filter(c=>c.id!==a))||[])}})}function Mt(t,i,a,p){r.useEffect(()=>{if(!a)return;const c=j=>{const b=j.target;i.current&&!i.current.contains(b)&&t.current&&!t.current.contains(b)&&p()};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[a,p,t,i])}function Rt(){const{data:t}=ge(),{tagFilters:i}=Ce();return ut({queryKey:["moddi","feed",i],queryFn:async({pageParam:a=0})=>{const p=new URLSearchParams({limit:"20",offset:String(a)}),c=`${w.moddi.posts}?${p.toString()}`;return await S(c)},enabled:!!t,initialPageParam:0,getNextPageParam:(a,p)=>{var b;const c=p.reduce((N,_)=>{var v;return N+(((v=_.items)==null?void 0:v.length)||0)},0);return(((b=a.items)==null?void 0:b.length)||0)===20?c:void 0}})}function Qt(){const t=mt(),i=me(),{data:a}=ge(),{tagFilters:p}=Ce(),{data:c,fetchNextPage:j,hasNextPage:b,isFetching:N,isFetchingNextPage:_,refetch:v}=Rt(),h=r.useMemo(()=>c!=null&&c.pages?c.pages.flatMap(y=>(y.items||[]).map(I=>({...I,user_id:I.user_id??0,username:I.username||"Unknown",avatar_url:I.avatar_url||null,text:I.text??null,uid:I.uid||String(I.id||""),reactions_count:Number(I.reactions_count??0),reacted_by_me:I.reacted_by_me??!1,comments_count:Number(I.comments_count??0)}))):[],[c]),k=r.useMemo(()=>h.filter(y=>{const z=y.tags?typeof y.tags=="string"?y.tags.split(",").map(H=>H.trim()):[]:[],I=!y.tags||z.length===0,A=z.includes("help");return p.untagged&&p.help?!0:p.untagged&&!p.help?I:!p.untagged&&p.help?A:!1}),[h,p]);r.useEffect(()=>{t.pathname==="/md/feed"&&v()},[t.pathname,v]),r.useEffect(()=>{const y=()=>{v()};return window.addEventListener("moddifilterchange",y),()=>window.removeEventListener("moddifilterchange",y)},[v]);const T=y=>{i.setQueryData(["moddi","feed"],z=>z&&{...z,pages:z.pages.map(I=>({...I,items:I.items.map(A=>A.id===y.id?y:A)}))})},x=y=>{i.setQueryData(["moddi","feed"],z=>z&&{...z,pages:z.pages.map(I=>({...I,items:I.items.filter(A=>A.id!==y)}))})},C=y=>{y&&i.setQueryData(["moddi","feed"],z=>{if(!z)return z;const I={...y,user_id:y.user_id??0,username:y.username||"Unknown",avatar_url:y.avatar_url||null,text:y.text??null,uid:y.uid||String(y.id||""),reactions_count:Number(y.reactions_count??0),reacted_by_me:y.reacted_by_me??!1,comments_count:Number(y.comments_count??0)};return{...z,pages:z.pages.map((A,H)=>H===0?{...A,items:[I,...A.items||[]]}:A)}}),i.invalidateQueries({queryKey:["moddi","feed"]}),v()},F=N&&!_,W=b??!1;return e.jsxs("div",{className:"feed-container moddi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"feed-header",children:[e.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),e.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),e.jsx(St,{section:"moddi",onPost:C})]}),e.jsx(wt,{section:"moddi",onPost:C}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)",paddingBottom:"100px"},children:e.jsxs("div",{className:"col",style:{gap:0},children:[k.length===0&&!F&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),k.map(y=>e.jsx(Ze,{post:y,section:"moddi",onUpdate:T,onDelete:x,me:a},y.id)),k.length>0&&W&&e.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("button",{className:"btn secondary",onClick:()=>j(),disabled:_,children:_?"Loading...":"Load more"})})]})})]})}function Ot(){const{uid:t}=Ye(),i=ke(),[a,p]=r.useState(null),[c,j]=r.useState([]),[b,N]=r.useState(!0),[_,v]=r.useState(null),[h,k]=r.useState(""),[T,x]=r.useState(null),[C,F]=r.useState(!1),{notify:W}=le();r.useEffect(()=>{S(w.auth.me,{requireAuth:!1}).then(u=>v(u)).catch(()=>{})},[]);const y=async()=>{if(!t||t==="null"||t==="undefined"){W("Invalid post identifier",{variant:"error"}),i("/md/feed");return}N(!0);try{const u=await S(w.moddi.post(t),{requireAuth:!1}),R={...u,user_id:u.user_id??0,username:u.username||"Unknown",avatar_url:u.avatar_url||null,uid:u.uid||String(u.id)||t,text:u.text??null,beatmap_url:u.beatmap_url??null,beatmapset_id:u.beatmapset_id??null,beatmap_id:u.beatmap_id??null,beatmap_version:u.beatmap_version??null,tags:u.tags??null,reactions_count:Number(u.reactions_count??0),reacted_by_me:u.reacted_by_me??!1,comments_count:Number(u.comments_count??0)};p(R)}catch{W("Failed to load post",{variant:"error"}),i("/md/feed")}finally{N(!1)}},z=async()=>{if(a!=null&&a.id)try{const u=await S(w.moddi.postComments(a.id),{requireAuth:!1});j(u.items||[])}catch{}};r.useEffect(()=>{y()},[t]),r.useEffect(()=>{a!=null&&a.id&&z()},[a==null?void 0:a.id]);const I=u=>{p(u)},A=()=>{i("/md/feed")},H=async u=>{if(u.preventDefault(),!(!h.trim()||!(a!=null&&a.id))){F(!0);try{await S(w.moddi.postComments(a.id),{method:"POST",body:JSON.stringify({text:h.trim(),parent_id:T||void 0})}),k(""),x(null),z(),y(),W("Comment posted!",{variant:"success"})}catch(R){W((R==null?void 0:R.message)||"Failed to post comment",{variant:"error"})}finally{F(!1)}}},V=u=>{j(R=>R.filter(te=>te.id!==u))};if(b)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!a)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const P=c.filter(u=>!u.parent_id),ee=new Map;return c.filter(u=>u.parent_id).forEach(u=>{const R=u.parent_id;ee.has(R)||ee.set(R,[]),ee.get(R).push(u)}),e.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>i("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(Je,{size:20})}),e.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(Ze,{post:a,section:"moddi",onUpdate:I,onDelete:A,me:_})}),_&&!T&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:H,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:h,onChange:u=>k(u.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:u=>{const R=u.target;R.style.height="auto",R.style.height=`${Math.min(R.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:C||!h.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:C?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:P.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:P.map(u=>e.jsx(_t,{comment:u,replies:ee.get(u.id)||[],me:_,section:"moddi",onReply:R=>x(R),onDelete:V,replyingTo:T,replyText:h,onReplyTextChange:k,onReplySubmit:H,posting:C,onCancelReply:()=>{x(null),k("")},repliesMap:ee},u.id))})})]})}function qt({queue:t}){return e.jsx(Xe,{to:`/md/queues/${t.id}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",cursor:"pointer"},onMouseEnter:i=>i.currentTarget.style.background="rgba(255,255,255,0.02)",onMouseLeave:i=>i.currentTarget.style.background="rgba(255,255,255,0.01)",children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,marginBottom:8},children:[t.is_group?e.jsx(gt,{size:18}):e.jsx(ce,{size:18}),e.jsx("strong",{style:{fontSize:16},children:t.name}),t.is_member&&e.jsx("span",{className:"chip",style:{fontSize:11,padding:"2px 8px"},children:"Member"})]}),t.description&&e.jsx("div",{className:"muted",style:{fontSize:14,marginBottom:8},children:t.description}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,fontSize:12},children:[t.owner_avatar_url&&e.jsx("img",{src:t.owner_avatar_url,width:20,height:20,style:{borderRadius:"50%"}}),e.jsxs("span",{className:"muted",children:["by ",t.owner_username,t.member_count!==void 0&&Number(t.member_count)>0&&(Number(t.member_count)===1&&t.first_member_username?` and ${t.first_member_username}`:` & ${t.member_count} others`)]}),e.jsx("span",{className:"muted",children:"•"}),e.jsx("span",{className:"muted",children:new Date(t.created_at*1e3).toLocaleDateString()})]})]})})}function Ie(){return _e({queryKey:["moddi","queues"],queryFn:async()=>{const t=await S(w.moddi.queues);return Array.isArray(t.items)?t.items:[]}})}function Ve(){const t=me();return Ne({mutationFn:async i=>{var a;return await S(w.moddi.queues,{method:"POST",body:JSON.stringify({name:i.name.trim(),description:((a=i.description)==null?void 0:a.trim())||null,is_group:i.is_group??!1})})},onSuccess:()=>{t.invalidateQueries({queryKey:["moddi","queues"]})}})}function Pt(){const[t,i]=ae.useState(!1),[a,p]=ae.useState(""),[c,j]=ae.useState(""),{data:b=[]}=Ie(),{data:N}=ge(),{notify:_}=le(),v=Ve(),h=ae.useMemo(()=>N?b.some(T=>T.owner_id===N.id):!1,[N,b]),k=T=>{if(T&&T.preventDefault(),h){_("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!a.trim()){_("Queue name is required",{variant:"error"});return}v.mutate({name:a.trim(),description:c.trim()||null,is_group:!1},{onSuccess:()=>{_("Queue created!",{variant:"success"}),i(!1),p(""),j("")},onError:x=>{_((x==null?void 0:x.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Create queue",title:"Create queue",onClick:()=>i(!0),children:e.jsx(Te,{size:22})}),e.jsx(ze,{open:t,onClose:()=>i(!1),children:e.jsxs("form",{onSubmit:k,className:"col",style:{gap:12},children:[h?e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:a,onChange:T=>p(T.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:c,onChange:T=>j(T.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>i(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:v.isPending||h,children:v.isPending?"Creating...":"Create"})]})]})})]})}function Ut(){const{data:t=[],isLoading:i}=Ie(),{data:a}=ge(),p=Ve(),{notify:c}=le(),[j,b]=r.useState(!1),[N,_]=r.useState(""),[v,h]=r.useState(""),k=r.useMemo(()=>a?t.some(x=>x.owner_id===a.id):!1,[a,t]),T=async x=>{if(x.preventDefault(),k){c("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!N.trim()){c("Queue name is required",{variant:"error"});return}p.mutate({name:N.trim(),description:v.trim()||null,is_group:!1},{onSuccess:()=>{c("Queue created!",{variant:"success"}),b(!1),_(""),h("")},onError:C=>{c((C==null?void 0:C.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs("div",{className:"feed-container queues-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx(Pt,{}),e.jsx("div",{className:"feed-header",children:e.jsx("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:0},children:k?e.jsx("div",{style:{padding:"12px"},children:e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>b(!j),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:"Create a queue!"}),j?e.jsx(pt,{size:16}):e.jsx(xe,{size:16})]}),j&&e.jsx("form",{onSubmit:T,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:N,onChange:x=>_(x.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:v,onChange:x=>h(x.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:x=>{x.stopPropagation(),b(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:p.isPending||k,onClick:x=>x.stopPropagation(),children:p.isPending?"Creating...":"Create"})]})]})})]})})}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)",paddingBottom:"100px"},children:e.jsx("div",{className:"col",style:{gap:0},children:i?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No queues yet. Create one to get started!"}):t.map(x=>e.jsx(qt,{queue:x},x.id))})})]})}function At({beatmapMeta:t,beatmapVersion:i}){const a=r.useRef(null),p=r.useRef(null),[c,j]=r.useState(!1),[b,N]=r.useState(!1),[_,v]=r.useState(0);r.useEffect(()=>{if(a.current&&p.current){const T=a.current.offsetWidth,x=p.current.scrollWidth;v(x),N(x>T)}},[t,i]);const h=t?e.jsxs(e.Fragment,{children:[t.artist," – ",t.title,t.mapper?` (by ${t.mapper})`:"",i?` [${i}]`:""]}):i?`[${i}]`:"Beatmap",k=_>0?Math.max(3,_/50):3;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),e.jsxs("div",{ref:a,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:b?"pointer":"default"},onMouseEnter:()=>b&&j(!0),onMouseLeave:()=>j(!1),children:[e.jsx("span",{ref:p,style:{display:"inline-block",animation:c&&b?`beatmap-marquee ${k}s linear infinite`:"none"},children:h}),c&&b&&e.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:h})]})]})}function $e({submission:t,canManage:i,onUpdate:a,onDelete:p,isGroup:c=!1}){const[j,b]=r.useState(!1),[N,_]=r.useState(!1),[v,h]=r.useState(null),[k,T]=r.useState(t.beatmapset_id),[x,C]=r.useState(t.beatmap_id),[F,W]=r.useState(!1),[y,z]=r.useState(!1),[I,A]=r.useState(null),[H,V]=r.useState(!1),[P,ee]=r.useState(t.acknowledgments||[]),[u,R]=r.useState(t.acknowledged_by_me||!1),te=r.useRef(null),L=r.useRef(null),d=r.useRef(null),{notify:g}=le();r.useEffect(()=>{ee(t.acknowledgments||[]),R(t.acknowledged_by_me||!1)},[t.acknowledgments,t.acknowledged_by_me]),r.useEffect(()=>{if(t.beatmap_url)try{const n=new URL(t.beatmap_url),f=n.pathname.match(/\/beatmapsets\/(\d+)/);if(f&&!t.beatmapset_id){const X=Number(f[1]);isNaN(X)||T(X)}const U=n.hash.match(/#osu\/(\d+)/);if(U&&!t.beatmap_id){const X=Number(U[1]);isNaN(X)||C(X)}}catch(n){console.error("[QueueSubmission] Error parsing beatmap URL:",t.beatmap_url,n)}},[t.beatmap_url,t.beatmapset_id,t.beatmap_id,t.id]),r.useEffect(()=>{console.log("[QueueSubmission] Submission data:",{id:t.id,beatmap_url:t.beatmap_url,beatmapset_id:t.beatmapset_id,beatmap_id:t.beatmap_id,extracted_beatmapset_id:k,extracted_beatmap_id:x,beatmap_version:t.beatmap_version})},[t.id,k,x]),r.useEffect(()=>{if(!t.beatmap_url||v&&k)return;let n=!1;return(async()=>{try{console.log("[QueueSubmission] Fetching beatmap metadata...",{beatmap_url:t.beatmap_url,existing_beatmapset_id:t.beatmapset_id,existing_beatmap_id:t.beatmap_id});let f;try{f=new URL(t.beatmap_url)}catch(Q){console.error("[QueueSubmission] Invalid beatmap URL:",t.beatmap_url,Q);return}const U=f.hash.match(/#osu\/(\d+)/),X=U?U[1]:null;f.hash="";const $={url:f.toString()};if(X?$.beatmap_id=X:t.beatmap_id&&($.beatmap_id=String(t.beatmap_id)),console.log("[QueueSubmission] Resolving beatmap with params:",$),!n){const Q=await S(w.osu.resolveBeatmap+Nt($),{requireAuth:!1});console.log("[QueueSubmission] Beatmap resolve response:",Q),Q.setId&&!k&&(console.log("[QueueSubmission] Setting beatmapset_id from API:",Q.setId),T(Number(Q.setId))),(Q.title||Q.artist)&&h({title:Q.title||null,artist:Q.artist||null,mapper:Q.mapper||null})}}catch(f){console.error("[QueueSubmission] Error fetching beatmap metadata:",f)}})(),()=>{n=!0}},[t.beatmap_url,t.beatmap_id,t.beatmapset_id,v,k]),r.useEffect(()=>{if(!F||!d.current){A(null);return}const n=()=>{if(d.current){const f=d.current.getBoundingClientRect();A({top:f.bottom+8,right:window.innerWidth-f.right})}};return n(),window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),()=>{window.removeEventListener("resize",n),window.removeEventListener("scroll",n,!0)}},[F]),r.useEffect(()=>{if(!N)return;const n=f=>{const U=f.target;te.current&&!te.current.contains(U)&&!U.closest("[data-status-dropdown]")&&_(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[N]),r.useEffect(()=>{if(!F)return;const n=f=>{L.current&&!L.current.contains(f.target)&&d.current&&!d.current.contains(f.target)&&W(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[F]);const m=async n=>{if(!j){b(!0);try{await S(w.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({status:n})});const f={...t,status:n,updated_at:Math.floor(Date.now()/1e3)};a&&a(f),g("Status updated",{variant:"success"})}catch{g("Failed to update status",{variant:"error"})}finally{b(!1),_(!1)}}},K=async()=>{if(!j){b(!0);try{const n=!!t.is_archived;await S(w.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({is_archived:!n})});const f={...t,is_archived:n?0:1,updated_at:Math.floor(Date.now()/1e3)};a&&a(f),g(n?"Unarchived":"Archived",{variant:"success"})}catch{g("Failed to update archive status",{variant:"error"})}finally{b(!1)}}},ie=async()=>{if(confirm("Are you sure you want to delete this submission? This action cannot be undone.")&&!j){b(!0);try{await S(w.moddi.queueSubmissionDelete(String(t.queue_id),t.id),{method:"DELETE"}),g("Submission deleted",{variant:"success"}),p&&p(t.id)}catch{g("Failed to delete submission",{variant:"error"})}finally{b(!1)}}},Y=async()=>{if(!H){V(!0);try{if(u){if(await S(w.moddi.queueSubmissionUnacknowledge(String(t.queue_id),t.id),{method:"DELETE"}),R(!1),g("Unacknowledged",{variant:"info"}),a){const n={...t,acknowledged_by_me:!1};a(n)}}else if(await S(w.moddi.queueSubmissionAcknowledge(String(t.queue_id),t.id),{method:"POST"}),R(!0),g("Acknowledged",{variant:"success"}),a){const n={...t,acknowledged_by_me:!0};a(n)}}catch{g("Failed to update acknowledgment",{variant:"error"})}finally{V(!1)}}},D={unchecked:"#f59e0b",accepted:"#10b981",denied:"#ef4444",finished:"#6366f1"},B={unchecked:"Pending",accepted:"Accepted",denied:"Denied",finished:"Finished"},G=k||t.beatmapset_id,Z=G?`https://assets.ppy.sh/beatmaps/${G}/covers/card.jpg`:null;r.useEffect(()=>{Z?console.log("[QueueSubmission] Background image URL:",Z,"for beatmapset_id:",G):console.log("[QueueSubmission] No background image URL - beatmapset_id:",G,"submission.beatmapset_id:",t.beatmapset_id)},[Z,G,t.beatmapset_id]);const J=!!t.is_archived;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"relative",borderRadius:12,overflow:"hidden",borderBottom:"1px solid rgba(255,255,255,0.06)",background:Z?"transparent":"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",opacity:J?.6:1},onMouseEnter:n=>{Z||(n.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)")},onMouseLeave:n=>{Z||(n.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)")},children:[Z&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Z,alt:"",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover",opacity:.35,zIndex:0,pointerEvents:"none"},onError:n=>{n.currentTarget.style.display="none"}}),e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.75) 100%)",zIndex:0}})]}),e.jsx("div",{style:{position:"relative",zIndex:1,padding:"16px"},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",justifyContent:"space-between",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[t.beatmap_url&&e.jsx("div",{style:{marginBottom:8},children:e.jsx(At,{beatmapMeta:v,beatmapVersion:t.beatmap_version})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,marginTop:8},children:[t.avatar_url&&e.jsx("img",{src:t.avatar_url,width:24,height:24,style:{borderRadius:"50%"},alt:t.username}),e.jsx("span",{style:{fontSize:13},children:t.username}),e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(t.created_at*1e3).toLocaleDateString()})]}),t.message&&e.jsx("div",{style:{marginTop:8,fontSize:13,lineHeight:1.5,color:"var(--text)"},children:t.message}),t.beatmap_url&&e.jsx("div",{style:{marginTop:12,display:"flex",alignItems:"center",gap:8},children:e.jsxs("button",{ref:d,className:"chip-btn link",onClick:n=>{n.preventDefault(),n.stopPropagation(),W(f=>!f)},title:"Beatmap options","aria-label":"Beatmap options",style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 12px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:6,color:"var(--text)",fontSize:13,cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:n=>{n.currentTarget.style.background="rgba(255,255,255,0.1)",n.currentTarget.style.borderColor="rgba(255,255,255,0.2)"},onMouseLeave:n=>{n.currentTarget.style.background="rgba(255,255,255,0.05)",n.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[e.jsx(Ee,{size:14}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),e.jsx(xe,{size:12,style:{marginLeft:4,opacity:.7}})]})})]}),i?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[P&&P.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[P.slice(0,5).map((n,f)=>n.avatar_url?e.jsx("img",{src:n.avatar_url,alt:n.username,title:n.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:f>0?-8:0,zIndex:P.length-f,position:"relative",cursor:"pointer"}},n.user_id):e.jsx("div",{title:n.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:f>0?-8:0,zIndex:P.length-f,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:n.username.charAt(0).toUpperCase()},n.user_id)),P.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${P.length-5} more`,children:["+",P.length-5]})]}),e.jsx("button",{className:"icon-link",onClick:Y,disabled:H||j,title:u?"Unacknowledge":"Acknowledge",style:{color:u?"#10b981":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:u?"rgba(16, 185, 129, 0.1)":"transparent"},onMouseEnter:n=>{!H&&!j&&(n.currentTarget.style.background=u?"rgba(16, 185, 129, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:n=>{n.currentTarget.style.background=u?"rgba(16, 185, 129, 0.1)":"transparent"},children:e.jsx(ht,{size:16})}),e.jsx("button",{className:"icon-link",onClick:K,disabled:j,title:J?"Unarchive":"Archive",style:{color:J?"#6366f1":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:J?"rgba(99, 102, 241, 0.1)":"transparent"},onMouseEnter:n=>{j||(n.currentTarget.style.background=J?"rgba(99, 102, 241, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:n=>{n.currentTarget.style.background=J?"rgba(99, 102, 241, 0.1)":"transparent"},children:J?e.jsx(ft,{size:16}):e.jsx(xt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:ie,disabled:j,title:"Delete submission",style:{color:"var(--danger)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:"transparent"},onMouseEnter:n=>{j||(n.currentTarget.style.background="rgba(239, 68, 68, 0.1)")},onMouseLeave:n=>{n.currentTarget.style.background="transparent"},children:e.jsx(ue,{size:16})}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("button",{ref:te,onClick:()=>_(!N),disabled:j,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:D[t.status]+"15",border:`1.5px solid ${D[t.status]}50`,color:D[t.status],whiteSpace:"nowrap",cursor:j?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:j?.6:1},onMouseEnter:n=>{j||(n.currentTarget.style.background=D[t.status]+"25",n.currentTarget.style.borderColor=D[t.status]+"70",n.currentTarget.style.transform="translateY(-1px)")},onMouseLeave:n=>{n.currentTarget.style.background=D[t.status]+"15",n.currentTarget.style.borderColor=D[t.status]+"50",n.currentTarget.style.transform="translateY(0)"},children:[e.jsx("span",{children:B[t.status]}),e.jsx(xe,{size:14,style:{marginLeft:2,transition:"transform 0.2s ease",transform:N?"rotate(180deg)":"rotate(0deg)"}})]}),N&&te.current&&Ke.createPortal(e.jsx("div",{"data-status-dropdown":!0,style:{position:"fixed",background:"var(--panel)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:6,zIndex:1e4,minWidth:140,boxShadow:"0 8px 24px rgba(0,0,0,0.4)",...(()=>{const n=te.current.getBoundingClientRect();return{top:n.bottom+6,right:window.innerWidth-n.right}})()},onClick:n=>n.stopPropagation(),children:["unchecked","accepted","denied","finished"].map(n=>e.jsx("button",{onClick:()=>m(n),style:{display:"block",width:"100%",padding:"8px 12px",borderRadius:6,fontSize:13,fontWeight:n===t.status?600:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",textAlign:"left",background:n===t.status?D[n]+"15":"transparent",color:n===t.status?D[n]:"var(--text)",border:"none",cursor:"pointer",transition:"all 0.15s ease",marginBottom:2},onMouseEnter:f=>{n!==t.status&&(f.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:f=>{n!==t.status&&(f.currentTarget.style.background="transparent")},children:B[n]},n))}),document.body)]})]}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[P&&P.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[P.slice(0,5).map((n,f)=>n.avatar_url?e.jsx("img",{src:n.avatar_url,alt:n.username,title:n.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:f>0?-8:0,zIndex:P.length-f,position:"relative",cursor:"pointer"}},n.user_id):e.jsx("div",{title:n.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:f>0?-8:0,zIndex:P.length-f,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:n.username.charAt(0).toUpperCase()},n.user_id)),P.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${P.length-5} more`,children:["+",P.length-5]})]}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:D[t.status]+"15",border:`1.5px solid ${D[t.status]}50`,color:D[t.status],whiteSpace:"nowrap"},children:B[t.status]})]})]})})]}),F&&I&&t.beatmap_url&&e.jsxs("div",{ref:L,style:{position:"fixed",top:I.top,right:I.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>W(!1),children:[e.jsx(Ee,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),G&&e.jsx("button",{className:"menu-item",onClick:()=>{z(!0),W(!1)},children:"Preview"})]}),y&&G&&e.jsx(Tt,{open:y,onClose:()=>z(!1),downloadUrl:`${kt}${w.osu.downloadBeatmapset(G)}`,beatmapId:x??t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0})]})}function Et({queueId:t,onSubmitted:i}){const[a,p]=ae.useState(!1),[c,j]=ae.useState(t),[b,N]=ae.useState(""),[_,v]=ae.useState(""),[h,k]=ae.useState(!1),{notify:T}=le(),{data:x=[]}=Ie();ae.useEffect(()=>{j(t)},[t]);const C=async()=>{if(!c){T("Please select a queue",{variant:"error"});return}if(!b.trim()){T("Beatmap URL is required",{variant:"error"});return}k(!0);try{await S(w.moddi.queueSubmit(c),{method:"POST",body:JSON.stringify({beatmap_url:b.trim(),message:_.trim()||null})}),T("Submission created!",{variant:"success"}),N(""),v(""),p(!1),i==null||i()}catch(F){T((F==null?void 0:F.message)||"Failed to create submission",{variant:"error"})}finally{k(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Submit to queue",title:"Submit to queue",onClick:()=>p(!0),children:e.jsx(Te,{size:22})}),e.jsx(ze,{open:a,onClose:()=>p(!1),children:e.jsxs("div",{className:"col",style:{gap:12},children:[!t&&e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Queue:"}),e.jsxs("select",{value:c??"",onChange:F=>j(F.target.value||void 0),style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",fontSize:13},children:[e.jsx("option",{value:"",disabled:!0,children:"Select queue"}),x.map(F=>e.jsx("option",{value:String(F.id),children:F.name},F.id))]})]}),e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:b,onChange:F=>N(F.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:_,onChange:F=>v(F.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),_.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[_.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>p(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"btn",disabled:h,onClick:C,children:h?"Submitting...":"Submit"})]})]})})]})}const He=({content:t})=>e.jsx("div",{style:{fontSize:13,lineHeight:1.6,color:"var(--text)"},children:e.jsx(vt,{components:{p:({children:i})=>e.jsx("p",{style:{margin:"0 0 8px 0"},children:i}),ul:({children:i})=>e.jsx("ul",{style:{margin:"0 0 8px 0",paddingLeft:20},children:i}),ol:({children:i})=>e.jsx("ol",{style:{margin:"0 0 8px 0",paddingLeft:20},children:i}),li:({children:i})=>e.jsx("li",{style:{margin:"0 0 4px 0"},children:i}),strong:({children:i})=>e.jsx("strong",{style:{fontWeight:600},children:i}),em:({children:i})=>e.jsx("em",{children:i}),code:({children:i})=>e.jsx("code",{style:{background:"rgba(255,255,255,0.1)",padding:"2px 4px",borderRadius:4,fontSize:12},children:i}),h1:({children:i})=>e.jsx("h1",{style:{fontSize:18,fontWeight:700,margin:"0 0 8px 0"},children:i}),h2:({children:i})=>e.jsx("h2",{style:{fontSize:16,fontWeight:700,margin:"0 0 8px 0"},children:i}),h3:({children:i})=>e.jsx("h3",{style:{fontSize:14,fontWeight:600,margin:"0 0 8px 0"},children:i})},children:t})});function $t(){const{id:t}=Ye(),i=ke(),[a,p]=r.useState(null),[c,j]=r.useState([]),[b,N]=r.useState([]),[_,v]=r.useState(!0),[h,k]=r.useState(null),[T,x]=r.useState(!1),[C,F]=r.useState(!1),[W,y]=r.useState(""),[z,I]=r.useState(""),[A,H]=r.useState(null),[V,P]=r.useState(!1),[ee,u]=r.useState(""),[R,te]=r.useState(""),[L,d]=r.useState(""),[g,m]=r.useState(!1),[K,ie]=r.useState(!1),[Y,D]=r.useState("general"),[B,G]=r.useState(!1),[Z,J]=r.useState(!1),[n,f]=r.useState(null),[U,X]=r.useState(""),[E,$]=r.useState([]),[Q,se]=r.useState(!1),de=r.useRef(null),ye=r.useRef(null),be=r.useRef(null),[ve,et]=r.useState([]),[Fe,Me]=r.useState(!1),[je,Re]=r.useState(null),{notify:q}=le(),{queueStatusFilters:pe}=Ce(),ne=async()=>{var s,l;if(t){v(!0);try{const o=await S(w.moddi.queue(t),{requireAuth:!1});p(o.queue||null),j(o.members||[]),N(o.submissions||[])}catch(o){(s=o==null?void 0:o.message)!=null&&s.includes("403")||(l=o==null?void 0:o.message)!=null&&l.includes("Forbidden")?(q("You do not have access to this queue",{variant:"error"}),i("/md/queues")):q("Failed to load queue",{variant:"error"})}finally{v(!1)}}};r.useEffect(()=>{ne(),S(w.auth.me,{requireAuth:!1}).then(s=>k(s)).catch(()=>{})},[t]);const re=h&&a&&(a.owner_id===h.id||c.some(s=>s.user_id===h.id&&s.joined_at));h&&c.some(s=>s.user_id===h.id&&s.joined_at);const qe=h&&a&&(a.owner_id===h.id||c.some(s=>s.user_id===h.id&&s.joined_at)),tt=async s=>{if(s.preventDefault(),!a||a.is_open===0){q("Queue is closed for submissions",{variant:"error"});return}if(!W.trim()){q("Beatmap URL is required",{variant:"error"});return}F(!0);try{await S(w.moddi.queueSubmit(t),{method:"POST",body:JSON.stringify({beatmap_url:W.trim(),message:z.trim()||null})}),q("Submission created!",{variant:"success"}),x(!1),y(""),I(""),ne()}catch(l){q((l==null?void 0:l.message)||"Failed to create submission",{variant:"error"})}finally{F(!1)}},Pe=s=>{N(l=>l.map(o=>o.id===s.id?s:o)),s.acknowledged_by_me!==void 0&&ne()},st=()=>{a&&(u(a.name),te(a.description||""),d(a.rules||""),P(!0),D("general"))},oe=()=>{P(!1),u(""),te(""),d("")},at=async()=>{if(!(!a||!qe)){ie(!0);try{const s=a.is_open!==1;await S(w.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_open:s})}),q(`Queue ${s?"opened":"closed"}`,{variant:"success"}),ne()}catch(s){q((s==null?void 0:s.message)||"Failed to update status",{variant:"error"})}finally{ie(!1)}}},nt=async s=>{if(s.preventDefault(),!a||!ee.trim()){q("Queue name is required",{variant:"error"});return}G(!0);try{const l=c.filter(o=>o.user_id!==a.owner_id&&o.role!=="owner").length>0;await S(w.moddi.queue(t),{method:"PATCH",body:JSON.stringify({name:ee.trim(),description:R.trim()||null,rules:L.trim()||null,is_group:l})}),q("Queue updated!",{variant:"success"}),oe(),ne()}catch(l){q((l==null?void 0:l.message)||"Failed to update queue",{variant:"error"})}finally{G(!1)}};r.useEffect(()=>{if(!U.trim()){$([]),se(!1);return}const s=setTimeout(async()=>{try{const o=(await S(w.moddi.usersSearch(U),{requireAuth:!1})).items||[];$(o),se(o.length>0)}catch(l){console.error("Search failed:",l),$([]),se(!1)}},300);return()=>clearTimeout(s)},[U]);const rt=async s=>{if(!Z){J(!0);try{await S(w.moddi.queueInvite(t),{method:"POST",body:JSON.stringify({user_id:s})}),q("Invite sent!",{variant:"success"}),X(""),$([]),se(!1),ne()}catch(l){q((l==null?void 0:l.message)||"Failed to invite member",{variant:"error"})}finally{J(!1)}}},Se=async()=>{if(!(!t||!re))try{const s=await S(w.moddi.queueBlockedUsers(t));et(s.blocked||[])}catch(s){console.error("Failed to load blocked users:",s)}},it=async s=>{if(!(!t||Fe)&&confirm("Block this user from submitting to this queue?")){Me(!0);try{await S(w.moddi.queueBlockUser(t),{method:"POST",body:JSON.stringify({user_id:s})}),q("User blocked",{variant:"success"}),Se(),X(""),$([]),se(!1)}catch(l){q((l==null?void 0:l.message)||"Failed to block user",{variant:"error"})}finally{Me(!1)}}},Ae=async s=>{if(!(!t||je===s)){Re(s);try{await S(w.moddi.queueUnblockUser(t,s),{method:"DELETE"}),q("User unblocked",{variant:"success"}),Se()}catch(l){q((l==null?void 0:l.message)||"Failed to unblock user",{variant:"error"})}finally{Re(null)}}};r.useEffect(()=>{Y==="members"&&re&&t&&Se()},[Y,re,t]);const ot=async()=>{if(a&&confirm(`Are you sure you want to delete "${a.name}"? This action cannot be undone.`)){m(!0);try{await S(w.moddi.queue(t),{method:"DELETE"}),q("Queue deleted",{variant:"success"}),i("/md/queues")}catch(s){q((s==null?void 0:s.message)||"Failed to delete queue",{variant:"error"})}finally{m(!1)}}},lt=async s=>{if(!h||!a||h.id!==a.owner_id){q("Only the queue owner can remove members",{variant:"error"});return}if(confirm("Remove this member from the queue?")){f(s);try{await S(w.moddi.queueMember(t,s),{method:"DELETE"}),q("Member removed",{variant:"success"});const o=c.filter(M=>M.user_id!==s).some(M=>M.user_id!==(a==null?void 0:a.owner_id)&&M.role!=="owner");if(a&&a.is_group===1&&!o)try{await S(w.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after removing last member")}ne()}catch(l){q((l==null?void 0:l.message)||"Failed to remove member",{variant:"error"})}finally{f(null)}}},dt=async()=>{if(h&&confirm("Leave this queue? You will need to be invited again to rejoin.")){f(h.id);try{await S(w.moddi.queueMember(t,h.id),{method:"DELETE"}),q("Left queue",{variant:"success"});const l=c.filter(o=>o.user_id!==h.id).some(o=>o.user_id!==(a==null?void 0:a.owner_id)&&o.role!=="owner");if(a&&a.is_group===1&&!l)try{await S(w.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after leaving")}i("/md/queues")}catch(s){q((s==null?void 0:s.message)||"Failed to leave queue",{variant:"error"})}finally{f(null)}}},ct=async s=>{if(confirm("Cancel this invitation?")){f(s);try{await S(w.moddi.queueMember(t,s),{method:"DELETE"}),q("Invitation canceled",{variant:"success"}),ne()}catch(l){q((l==null?void 0:l.message)||"Failed to cancel invitation",{variant:"error"})}finally{f(null)}}};return r.useEffect(()=>{if(!V)return;const s=l=>{const o=l.target;o.closest(".manage-overlay")||o.closest(".manage-overlay-backdrop")||!o.closest(".manage-popup")&&be.current&&!be.current.contains(o)&&oe()};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[V]),r.useEffect(()=>{if(!Q)return;const s=l=>{const o=l.target;de.current&&!de.current.contains(o)&&ye.current&&!ye.current.contains(o)&&se(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[Q]),_?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):a?e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t&&e.jsx(Et,{queueId:t,onSubmitted:()=>ne()}),e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:12,marginBottom:16,paddingTop:16},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flex:1,minWidth:0},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>i("/md/queues"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(Je,{size:20})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:10,flex:1,minWidth:0},children:[e.jsx("div",{className:"title",style:{flex:1,minWidth:0},children:a.name}),qe&&e.jsxs("button",{onClick:at,disabled:K,className:`queue-status-badge ${a.is_open===1?"status-open":"status-closed"}`,title:a.is_open===1?"Close queue":"Open queue","aria-label":a.is_open===1?"Close queue":"Open queue",children:[a.is_open===1?e.jsx(we,{size:14}):e.jsx(Le,{size:14}),e.jsx("span",{children:a.is_open===1?"Open":"Closed"})]})]})]}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[re&&e.jsx("button",{ref:be,className:"icon-link",onClick:st,style:{width:"auto",height:"auto",padding:"4px"},title:"Manage Queue","aria-label":"Manage Queue",children:e.jsx(yt,{size:18})}),c.length>0&&e.jsx("div",{style:{display:"flex",alignItems:"center",gap:6},children:c.filter(s=>s.joined_at!==null).sort((s,l)=>{const o=s.role==="owner"||s.user_id===(a==null?void 0:a.owner_id),M=l.role==="owner"||l.user_id===(a==null?void 0:a.owner_id);return o&&!M?-1:!o&&M?1:(l.joined_at||0)-(s.joined_at||0)}).map(s=>e.jsxs("div",{style:{position:"relative"},onMouseEnter:()=>H(s.user_id),onMouseLeave:()=>H(null),children:[e.jsx(Xe,{to:`/profile/${s.user_id}`,className:"queue-member-avatar",title:s.username,children:s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:s.username}):e.jsx("div",{style:{width:"100%",height:"100%",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,color:"var(--muted)"},children:s.username.charAt(0).toUpperCase()})}),A===s.user_id&&e.jsxs("div",{className:"queue-member-tooltip",children:[s.username," ",s.role!=="member"?`(${s.role})`:""]})]},s.user_id))})]})]}),a.description&&e.jsx("div",{className:"muted",style:{marginBottom:16,fontSize:14,padding:"0 4px"},children:a.description}),a.rules&&e.jsxs("div",{style:{marginBottom:16,padding:12,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10},children:[e.jsx("div",{style:{fontSize:14,fontWeight:600,marginBottom:8},children:"Rules"}),e.jsx(He,{content:a.rules})]}),a.is_open===0&&e.jsx("div",{style:{marginBottom:12,padding:10,background:"rgba(245, 158, 11, 0.1)",border:"1px solid rgba(245, 158, 11, 0.3)",borderRadius:10,textAlign:"center",fontSize:14,color:"#f59e0b"},children:"This queue is currently closed for submissions"}),e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:12,opacity:a.is_open===0?.6:1},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:a.is_open===1?"pointer":"not-allowed",padding:"8px 12px",minHeight:36},onClick:()=>a.is_open===1&&x(!T),children:[e.jsxs("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:["Submit a beatmap ",a.is_open===0&&"(Closed)"]}),a.is_open===1&&(T?e.jsx(fe,{size:16}):e.jsx(Te,{size:16}))]}),T&&e.jsx("form",{onSubmit:tt,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:W,onChange:s=>y(s.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:z,onChange:s=>I(s.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),z.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[z.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:s=>{s.stopPropagation(),x(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:C,onClick:s=>s.stopPropagation(),children:C?"Submitting...":"Submit"})]})]})})]}),e.jsxs("div",{className:"profile-tabs-unified",style:{marginTop:24},children:[e.jsxs("div",{className:"profile-tabs-header",role:"tablist","aria-label":"Submission sections",children:[e.jsx("button",{role:"tab","aria-selected":!0,className:"profile-tab active","data-tab":"active",onClick:s=>{const l=s.currentTarget.closest(".profile-tabs-unified");l.querySelectorAll(".profile-tab").forEach(M=>{M.classList.remove("active"),M.setAttribute("aria-selected","false")}),s.currentTarget.classList.add("active"),s.currentTarget.setAttribute("aria-selected","true"),l.querySelector(".profile-tabs-content").setAttribute("data-active","active")},children:"Active"}),e.jsx("button",{role:"tab","aria-selected":!1,className:"profile-tab","data-tab":"archived",onClick:s=>{const l=s.currentTarget.closest(".profile-tabs-unified");l.querySelectorAll(".profile-tab").forEach(M=>{M.classList.remove("active"),M.setAttribute("aria-selected","false")}),s.currentTarget.classList.add("active"),s.currentTarget.setAttribute("aria-selected","true"),l.querySelector(".profile-tabs-content").setAttribute("data-active","archived")},children:"Archived"})]}),e.jsxs("div",{className:"profile-tabs-content","data-active":"active",children:[e.jsx("div",{className:"panel active",children:e.jsx("div",{className:"col",style:{gap:0},children:b.filter(s=>!!!s.is_archived&&pe[s.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No active submissions."}):b.filter(s=>!!!s.is_archived&&pe[s.status]).map(s=>e.jsx($e,{submission:s,canManage:!!re,isGroup:(a==null?void 0:a.is_group)===1,onUpdate:Pe,onDelete:l=>{N(o=>o.filter(M=>M.id!==l))}},s.id))})}),e.jsx("div",{className:"panel archived",children:e.jsx("div",{className:"col",style:{gap:0},children:b.filter(s=>!!s.is_archived&&pe[s.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No archived submissions."}):b.filter(s=>!!s.is_archived&&pe[s.status]).map(s=>e.jsx($e,{submission:s,canManage:!!re,isGroup:(a==null?void 0:a.is_group)===1,onUpdate:Pe,onDelete:l=>{N(o=>o.filter(M=>M.id!==l))}},s.id))})})]})]}),V&&Ke.createPortal(e.jsxs("div",{className:"overlay manage-overlay",children:[e.jsx("div",{className:"overlay-backdrop manage-overlay-backdrop",onClick:oe}),e.jsxs("div",{className:"overlay-card",style:{maxWidth:500},children:[e.jsx("button",{className:"overlay-close",onClick:oe,"aria-label":"Close",children:e.jsx(fe,{size:18})}),e.jsxs("div",{className:"col",style:{gap:0,padding:"0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:16,padding:"20px 16px 12px",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("div",{className:"title",style:{fontSize:20,margin:0,padding:0,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Manage Queue"}),e.jsxs("div",{className:"tabs",role:"tablist",style:{margin:0},children:[e.jsx("button",{role:"tab","aria-selected":Y==="general",className:`tab ${Y==="general"?"active":""}`,onClick:()=>D("general"),children:"General"}),e.jsx("button",{role:"tab","aria-selected":Y==="rules",className:`tab ${Y==="rules"?"active":""}`,onClick:()=>D("rules"),children:"Rules"}),e.jsx("button",{role:"tab","aria-selected":Y==="members",className:`tab ${Y==="members"?"active":""}`,onClick:()=>D("members"),children:"Members"})]})]}),e.jsx("hr",{className:"subtle-divider",style:{margin:"0 16px"}}),e.jsxs("form",{onSubmit:nt,className:"col",style:{gap:0,padding:"16px"},children:[Y==="general"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Queue Name"}),e.jsx("input",{type:"text",value:ee,onChange:s=>u(s.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}})]}),e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Description (optional)"}),e.jsx("textarea",{placeholder:"Description",value:R,onChange:s=>te(s.target.value),rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"space-between",alignItems:"center",marginTop:8},children:[e.jsxs("button",{type:"button",className:"btn secondary",onClick:ot,disabled:g||B,style:{background:"rgba(248, 113, 113, 0.1)",borderColor:"rgba(248, 113, 113, 0.3)",color:"var(--danger)",fontSize:13,padding:"8px 12px"},children:[e.jsx(ue,{size:14,style:{marginRight:6}}),g?"Deleting...":"Delete Queue"]}),e.jsxs("div",{className:"row",style:{gap:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:oe,disabled:B||g,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:B||g,style:{fontSize:13,padding:"8px 16px"},children:B?"Updating...":"Save Changes"})]})]})]}),Y==="rules"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Rules (optional, markdown supported)"}),e.jsx("textarea",{placeholder:"Rules in markdown format...",value:L,onChange:s=>d(s.target.value),rows:8,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:13,resize:"vertical"}}),L&&e.jsxs("div",{style:{padding:10,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,fontSize:12},children:[e.jsx("div",{style:{fontSize:12,fontWeight:600,marginBottom:6,opacity:.8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Preview:"}),e.jsx(He,{content:L})]})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:oe,disabled:B||g,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:B||g,style:{fontSize:13,padding:"8px 16px"},children:B?"Updating...":"Save Changes"})]})]}),Y==="members"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6,position:"relative"},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invite Members"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{ref:de,type:"text",placeholder:"Search username or ID",value:U,onChange:s=>X(s.target.value),onKeyDown:s=>{s.key==="Enter"&&s.preventDefault()},onFocus:()=>{E.length>0&&se(!0)},style:{width:"100%",background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),Q&&E.length>0&&e.jsx("div",{ref:ye,style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,maxHeight:300,overflowY:"auto",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},children:e.jsx("div",{className:"col",style:{gap:0},children:E.map(s=>{const l=c.some(O=>O.user_id===s.id&&O.joined_at),o=c.some(O=>O.user_id===s.id&&O.invited_at&&!O.joined_at),M=ve.some(O=>O.user_id===s.id);return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"8px 12px"},children:[e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:8,minWidth:0},children:[s.avatar_url&&e.jsx("img",{src:s.avatar_url,width:20,height:20,style:{borderRadius:"50%",flexShrink:0}}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontSize:13,fontWeight:500,display:"flex",alignItems:"center",gap:8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("span",{children:s.username}),l&&e.jsx("span",{style:{color:"var(--muted)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Already a member"}),o&&e.jsx("span",{style:{color:"var(--accent)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]}),e.jsxs("div",{className:"muted",style:{fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["id ",s.id," • osu ",s.osu_user_id]})]})]}),re&&!l&&!o&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{className:"icon-link",onClick:O=>{O.stopPropagation(),Z||rt(s.id)},disabled:Z,title:"Invite user",style:{width:"auto",height:"auto",padding:"4px"},children:e.jsx(Ge,{size:16})}),e.jsx("button",{className:"icon-link",onClick:O=>{O.stopPropagation(),M?Ae(s.id):it(s.id)},disabled:Fe||je===s.id,title:M?"Unblock user":"Block user",style:{width:"auto",height:"auto",padding:"4px",color:M?"var(--accent)":"var(--danger)"},children:M?e.jsx(we,{size:16}):e.jsx(Le,{size:16})})]})]},s.id)})})})]})]}),c.length>0&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Members"}),e.jsx("div",{className:"col",style:{gap:4},children:(()=>{const s=c.filter(o=>o.joined_at!==null).sort((o,M)=>{const O=o.role==="owner"||o.user_id===(a==null?void 0:a.owner_id),he=M.role==="owner"||M.user_id===(a==null?void 0:a.owner_id);return O&&!he?-1:!O&&he?1:(M.joined_at||0)-(o.joined_at||0)}),l=c.filter(o=>o.invited_at!==null&&o.joined_at===null);return e.jsxs(e.Fragment,{children:[s.map(o=>{const M=h&&a&&h.id===a.owner_id,O=o.user_id===(h==null?void 0:h.id),he=o.user_id===(a==null?void 0:a.owner_id)||o.role==="owner";return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[o.avatar_url&&e.jsx("img",{src:o.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:o.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:o.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:o.role})]})]}),M&&!he&&e.jsx("button",{className:"icon-link",onClick:()=>lt(o.user_id),disabled:n===o.user_id,title:"Remove member",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(ue,{size:16})}),!M&&O&&e.jsx("button",{className:"icon-link",onClick:dt,disabled:n===o.user_id,title:"Leave queue",style:{width:"auto",height:"auto",padding:"4px",color:"var(--muted)"},children:e.jsx(bt,{size:16})})]},o.user_id)}),l.length>0&&e.jsx(e.Fragment,{children:l.map(o=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",opacity:.7},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[o.avatar_url&&e.jsx("img",{src:o.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:o.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:o.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>ct(o.user_id),disabled:n===o.user_id,title:"Cancel invitation",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(fe,{size:16})})]},o.user_id))})]})})()})]}),re&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Blocked Users"}),ve.length===0?e.jsx("div",{className:"muted",style:{fontSize:12,padding:"8px 0",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"No blocked users"}):e.jsx("div",{className:"col",style:{gap:4},children:ve.map(s=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[s.avatar_url&&e.jsx("img",{src:s.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:s.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:s.username}),s.blocked_by_username&&e.jsxs("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["Blocked by ",s.blocked_by_username]})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>Ae(s.user_id),disabled:je===s.user_id,title:"Unblock user",style:{width:"auto",height:"auto",padding:"4px",color:"var(--accent)"},children:e.jsx(we,{size:16})})]},s.user_id))})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:oe,disabled:B||g,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:B||g,style:{fontSize:13,padding:"8px 16px"},children:B?"Updating...":"Save Changes"})]})]})]})]})]})]}),document.body),e.jsx("style",{children:`
        .queue-member-avatar {
          width: 32px;
          height: 32px;
          border-radius: 9999px;
          padding: 0;
          border: 1px solid rgba(255,255,255,0.08);
          overflow: hidden;
          cursor: pointer;
          background: transparent;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: border-color 0.2s;
        }
        .queue-member-avatar:hover {
          border-color: rgba(167, 139, 250, 0.4);
        }
        .queue-member-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }
        .queue-member-tooltip {
          position: absolute;
          bottom: calc(100% + 8px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(18, 20, 24, 0.95);
          color: var(--text, #e5e7eb);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 6px;
          padding: 6px 10px;
          font-size: 14px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          pointer-events: none;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
        }
        .queue-member-tooltip::after {
          content: '';
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-top: 5px solid rgba(18, 20, 24, 0.95);
        }
        .queue-status-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
          border: 1px solid;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        }
        .queue-status-badge:disabled {
          cursor: not-allowed;
          opacity: 0.6;
        }
        .queue-status-badge.status-open {
          background: rgba(52, 211, 153, 0.15);
          border-color: rgba(52, 211, 153, 0.4);
          color: #34d399;
        }
        .queue-status-badge.status-open:hover:not(:disabled) {
          background: rgba(52, 211, 153, 0.25);
          border-color: rgba(52, 211, 153, 0.5);
        }
        .queue-status-badge.status-closed {
          background: rgba(245, 158, 11, 0.15);
          border-color: rgba(245, 158, 11, 0.4);
          color: #f59e0b;
        }
        .queue-status-badge.status-closed:hover:not(:disabled) {
          background: rgba(245, 158, 11, 0.25);
          border-color: rgba(245, 158, 11, 0.5);
        }
      `})]}):e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Queue not found"})}function Ht(){const{data:t=[],isLoading:i}=zt(),a=It(),p=Ft(),{notify:c}=le(),j=ke(),b=me(),[N,_]=r.useState(new Set),{data:v}=ge(),[h,k]=r.useState(!1),[T,x]=r.useState(!1),[C,F]=r.useState(!1),W=r.useRef(null),y=r.useRef(null),z=!!(v!=null&&v.is_admin||v!=null&&v.is_mod);Mt(W,y,h,()=>k(!1));const I=async d=>{a.mutate(d,{onSuccess:()=>{}})},A=async d=>{d.startsWith("n:")&&p.mutate(d)},H=async()=>{const d=t.filter(g=>!g.read&&(g.id.startsWith("n:")||g.kind==="system"&&!g.id.startsWith("b:"))).map(g=>g.id);d.length>0&&(await I(d),c("All notifications marked as read",{variant:"success"}))},V=d=>{if(!d)return null;try{const g=JSON.parse(d);if((g==null?void 0:g.type)==="queue_invite"&&(g!=null&&g.queue_id))return g}catch{}return null},P=async(d,g)=>{if(!N.has(d.id)){_(m=>new Set(m).add(d.id));try{await S(w.moddi.queueAccept(String(g)),{method:"POST"}),c("Invitation accepted!",{variant:"success"}),A(d.id),j(`/md/queues/${g}`)}catch(m){c((m==null?void 0:m.message)||"Failed to accept invitation",{variant:"error"})}finally{_(m=>{const K=new Set(m);return K.delete(d.id),K})}}},ee=async(d,g)=>{if(!N.has(d.id)){_(m=>new Set(m).add(d.id));try{await S(w.moddi.queueDeny(String(g)),{method:"POST"}),c("Invitation declined",{variant:"success"}),A(d.id)}catch(m){c((m==null?void 0:m.message)||"Failed to decline invitation",{variant:"error"})}finally{_(m=>{const K=new Set(m);return K.delete(d.id),K})}}},u=d=>V(d.text)?e.jsx(Ge,{size:20,color:"#a78bfa"}):d.kind==="star"?e.jsx(We,{size:20,color:"#f59e0b"}):d.kind==="likes5"?e.jsx(Qe,{size:20,color:"#f472b6"}):d.kind==="comment"?e.jsx(ce,{size:20,color:"#60a5fa"}):d.kind==="inspiration"?e.jsx(ce,{size:20,color:"#7dd3fc"}):d.kind==="reaction"?e.jsx(Oe,{size:20,color:"#10b981"}):d.id.startsWith("b:")?e.jsx(Ue,{size:20,color:"#a78bfa"}):null,R=d=>V(d.text)?"Queue Invitation":d.kind==="star"?"Star":d.kind==="likes5"?"Likes":d.kind==="comment"?"Comment":d.kind==="inspiration"?"Inspiration":d.kind==="reaction"?"Reaction":d.id.startsWith("b:")?"Global":"System",te=t.filter(d=>!d.read&&!(d.id.startsWith("b:")&&d.expiresAt&&d.expiresAt<=Date.now())).length,L=async d=>{if(!(!(v!=null&&v.id)||C)){F(!0);try{const g={kind:d};d==="system"&&(g.text="Test system notification"),await S(w.admin.notificationsTest,{method:"POST",body:JSON.stringify(g)}),c("Test notification sent!",{variant:"success"}),b.invalidateQueries({queryKey:["notifications","detailed"]}),b.invalidateQueries({queryKey:["notifications"]})}catch(g){c((g==null?void 0:g.message)||"Failed to send test notification",{variant:"error"})}finally{F(!1),k(!1),x(!1)}}};return e.jsxs("div",{className:"feed-container moddi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx("div",{className:"feed-header",children:e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{className:"title",children:"Notifications"}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[z&&e.jsxs("div",{style:{position:"relative"},className:"hide-on-mobile",children:[e.jsxs("button",{ref:W,className:"btn secondary",onClick:()=>k(!h),disabled:C,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(De,{size:14}),e.jsx("span",{children:"Test"}),e.jsx(xe,{size:14,style:{transition:"transform 0.2s ease",transform:h?"rotate(180deg)":"rotate(0deg)"}})]}),h&&e.jsxs("div",{ref:y,className:"menu-panel",role:"menu",style:{position:"absolute",top:"100%",right:0,marginTop:8,minWidth:180,zIndex:1e3},children:[e.jsx("button",{className:"menu-item",type:"button",onClick:()=>L("star"),disabled:C,children:"Test Star"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>L("likes5"),disabled:C,children:"Test Likes"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>L("comment"),disabled:C,children:"Test Comment"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>L("inspiration"),disabled:C,children:"Test Inspiration"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>L("reaction"),disabled:C,children:"Test Reaction"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>L("system"),disabled:C,children:"Test System"})]})]}),te>0&&e.jsxs("button",{className:"btn secondary",onClick:H,children:[e.jsx(Be,{size:16,style:{marginRight:6}}),"Mark all read"]})]})]})}),z&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Test notification",title:"Test notification",onClick:()=>x(!0),children:e.jsx(De,{size:22})}),e.jsx(ze,{open:T,onClose:()=>x(!1),children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("div",{className:"title",style:{marginBottom:4},children:"Send Test Notification"}),e.jsx("div",{className:"muted",style:{fontSize:13,marginBottom:8},children:"Send a test notification to yourself to preview how it appears."}),e.jsxs("div",{className:"col",style:{gap:8},children:[e.jsxs("button",{className:"btn secondary",onClick:()=>L("star"),disabled:C,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(We,{size:18,color:"#f59e0b"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Star"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"One of your posts was starred!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>L("likes5"),disabled:C,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Qe,{size:18,color:"#f472b6"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Likes"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"One of your posts reached 5 likes!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>L("comment"),disabled:C,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(ce,{size:18,color:"#60a5fa"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Comment"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Someone commented on your post"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>L("inspiration"),disabled:C,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(ce,{size:18,color:"#7dd3fc"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Inspiration"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Someone is inspired by you!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>L("reaction"),disabled:C,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Oe,{size:18,color:"#10b981"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Reaction"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Someone raised their hand on your post!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>L("system"),disabled:C,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ue,{size:18,color:"#a78bfa"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"System"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Test system notification"})]})]})]})]})})]}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:i?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No notifications yet."}):e.jsx("div",{className:"col",style:{gap:0},children:t.filter(d=>!(d.id.startsWith("b:")&&d.expiresAt&&d.expiresAt<=Date.now())).map(d=>{const g=({notif:m})=>{const[K,ie]=r.useState(0),[Y,D]=r.useState(!1),B=r.useRef(null),G=r.useRef(null),Z=r.useRef(null),J=r.useRef(null),n=E=>{m.id.startsWith("n:")&&(B.current=E.touches[0].clientX,J.current=E.touches[0].clientY,G.current=Date.now(),D(!1))},f=E=>{if(B.current===null||J.current===null||!m.id.startsWith("n:"))return;const $=E.touches[0].clientX,Q=E.touches[0].clientY,se=$-B.current,de=Math.abs(Q-J.current);Math.abs(se)>de&&(D(!0),ie(Math.max(-80,Math.min(0,se))))},U=()=>{if(B.current===null)return;K<=-60&&A(m.id),ie(0),D(!1),B.current=null,J.current=null,G.current=null},X=m.id.startsWith("n:");return e.jsxs("div",{ref:Z,style:{position:"relative",background:m.read?"var(--panel-dark)":"var(--panel)",borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)",padding:16,cursor:m.videoId?"pointer":"default",opacity:m.read?.7:1,transform:`translateX(${K}px)`,transition:Y?"none":"transform 0.2s ease",touchAction:X?"pan-x pan-y":"pan-y"},onTouchStart:n,onTouchMove:f,onTouchEnd:U,onTouchCancel:U,onClick:()=>{Math.abs(K)>10||(!m.read&&m.id.startsWith("n:")&&I([m.id]),m.videoId&&(window.location.hash="/mp/feed"))},children:[X&&e.jsx("div",{style:{position:"absolute",right:0,top:0,bottom:0,width:80,background:"#f87171",display:"flex",alignItems:"center",justifyContent:"center",opacity:Math.abs(K)/80,pointerEvents:"none",zIndex:0},children:e.jsx(ue,{size:20,color:"#fff"})}),e.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12,position:"relative",zIndex:1},children:[e.jsx("div",{style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",borderRadius:"50%"},children:u(m)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[e.jsx("strong",{style:{fontSize:14},children:R(m)}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(m.createdAt).toLocaleDateString()}),m.id.startsWith("n:")&&e.jsx("button",{className:"icon-link hide-on-mobile",onClick:E=>{E.stopPropagation(),A(m.id)},style:{padding:4},children:e.jsx(ue,{size:14})})]})]}),e.jsx("div",{style:{fontSize:14,wordBreak:"break-word"},children:(()=>{const E=V(m.text);return E?`${E.inviter_username} invited you to join queue: ${E.queue_name}`:m.text||(m.kind==="star"?"One of your posts was starred!":m.kind==="likes5"?"One of your posts reached 5 likes!":m.kind==="comment"?"Someone commented on your post":m.kind==="inspiration"?"Someone is inspired by you!":m.kind==="reaction"?"Someone raised their hand on your post!":"")})()}),(()=>{const E=V(m.text);return E&&!N.has(m.id)?e.jsxs("div",{className:"row",style:{gap:8,marginTop:12},children:[e.jsxs("button",{className:"btn",onClick:$=>{$.stopPropagation(),P(m,E.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Be,{size:14,style:{marginRight:4}}),"Accept"]}),e.jsxs("button",{className:"btn secondary",onClick:$=>{$.stopPropagation(),ee(m,E.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(fe,{size:14,style:{marginRight:4}}),"Decline"]})]}):E&&N.has(m.id)?e.jsx("div",{className:"muted",style:{fontSize:12,marginTop:8},children:"Processing..."}):null})(),m.read&&m.readAt&&e.jsxs("div",{className:"muted",style:{fontSize:11,marginTop:4},children:["Read ",new Date(m.readAt).toLocaleString()]})]})]})]},m.id)};return e.jsx(g,{notif:d},d.id)})})})]})}export{Qt as M,Ht as N,Ot as P,Ut as Q,Mt as a,Ct as b,It as c,Ft as d,$t as e,Wt as u};

import{s as pt,t as we,v as Ne,w as Me,R as D,j as e,L as Ue,r as i,x as Ze,l as Fe,d as _e,y as Ee,z as gt,e as ht,o as et,u as Be,q as tt,B as ft,C as De,k as $e,f as yt,D as xt,E as bt,G as Le,H as Ae,I as He,J as vt,c as Ie,K as st,M as jt,N as St,O as Ye,A as wt,h as Nt,P as _t,Q as kt}from"./vendor-react-D9qJr8_Y.js";import{a as C,A as T,g as Tt,u as pe,b as at,P as rt,C as Ct,c as zt}from"./mappi-routes-Drub60bt.js";import{i as Rt,a as It,b as Ft,c as Lt}from"./editor-components-ByPZokBD.js";import{B as nt}from"./editor-lib-CnQh_pvm.js";const Mt=()=>{try{const t=localStorage.getItem("filter_modes")||"standard",r=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{standard:r.has("standard")||r.size===0,taiko:r.has("taiko"),mania:r.has("mania"),catch:r.has("catch")}}catch{return{standard:!0,taiko:!1,mania:!1,catch:!1}}},Et=()=>{try{const t=localStorage.getItem("filter_moddi_tags")||"untagged,help",r=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{untagged:r.has("untagged")||r.size===0,help:r.has("help")||r.size===0}}catch{return{untagged:!0,help:!0}}},Pt=()=>{try{const t=localStorage.getItem("filter_queue_status")||"unchecked,accepted,denied,finished",r=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{unchecked:r.has("unchecked")||r.size===0,accepted:r.has("accepted")||r.size===0,denied:r.has("denied")||r.size===0,finished:r.has("finished")||r.size===0,archived:r.has("archived")}}catch{return{unchecked:!0,accepted:!0,denied:!0,finished:!0,archived:!1}}},qt=()=>{try{const t=localStorage.getItem("last_section");return t==="mappi"||t==="moddi"?t:null}catch{return null}},Oe=pt(t=>({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1,modeFilters:Mt(),tagFilters:Et(),queueStatusFilters:Pt(),lastSection:qt(),previousLocation:null,setMenuOpen:r=>t({menuOpen:r}),setMobileNavOpen:r=>t({mobileNavOpen:r}),setNotifOpen:r=>t({notifOpen:r}),closeAllPanels:()=>t({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1}),setModeFilters:r=>{t({modeFilters:r});try{const y=Object.entries(r).filter(([b,p])=>p).map(([b])=>b),d=y.length?y:["standard"];localStorage.setItem("filter_modes",d.join(","))}catch{}},setTagFilters:r=>{t({tagFilters:r});try{const y=Object.entries(r).filter(([b,p])=>p).map(([b])=>b),d=y.length?y:["untagged","help"];localStorage.setItem("filter_moddi_tags",d.join(","))}catch{}},setQueueStatusFilters:r=>{t({queueStatusFilters:r});try{const y=Object.entries(r).filter(([b,p])=>p).map(([b])=>b),d=y.length?y:["unchecked","accepted","denied","finished"];localStorage.setItem("filter_queue_status",d.join(","))}catch{}},setLastSection:r=>{t({lastSection:r});try{r?localStorage.setItem("last_section",r):localStorage.removeItem("last_section")}catch{}},setPreviousLocation:r=>{t({previousLocation:r})}}));function At(t=!0){return we({queryKey:["notifications"],queryFn:async()=>{try{const r=await C(T.user.notifications);return Array.isArray(r.items)?r.items:[]}catch{return[]}},enabled:t,refetchInterval:45*1e3})}function Dt(){return we({queryKey:["notifications","detailed"],queryFn:async()=>{try{const t=await C("/api/me/notifications/detailed");return Array.isArray(t.items)?t.items:[]}catch{return[]}},refetchInterval:30*1e3})}function Zt(){const{data:t=[]}=At();return t.filter(r=>r.kind==="system"&&r.id.startsWith("b:")&&(r.expiresAt||0)<=Date.now()?!1:!r.read).length}function Ut(){const t=Ne();return Me({mutationFn:async r=>{await C(T.user.markNotificationsRead,{method:"POST",body:JSON.stringify({ids:r})})},onSuccess:()=>{t.setQueryData(["notifications"],r=>(r==null?void 0:r.map(s=>({...s,read:!0})))||[])}})}function Bt(){const t=Ne();return Me({mutationFn:async r=>{const s=Tt();await C(T.user.deleteNotification(r),{method:"DELETE",headers:{"X-CSRF-Token":s}})},onSuccess:(r,s)=>{t.setQueryData(["notifications"],y=>(y==null?void 0:y.filter(d=>d.id!==s))||[])}})}function ke(){return we({queryKey:["user","me"],queryFn:async()=>{try{return await C(T.auth.me)}catch{return null}},staleTime:5*60*1e3})}function es(t=!0){return we({queryKey:["user","quota"],queryFn:async()=>{try{return await C(T.user.quota)}catch{return null}},enabled:t,refetchInterval:30*1e3})}function ts(){const t=Ne();return Me({mutationFn:async()=>{await C(T.auth.logout,{method:"POST"})},onSuccess:()=>{t.setQueryData(["user","me"],null),t.clear(),window.location.href="/"}})}function it({title:t,onRefresh:r}){const{data:s}=ke(),[y,d]=D.useState(!0),[b,p]=D.useState(0),[S,w]=D.useState(!1),N=D.useRef(!1),l=D.useRef(0);return D.useEffect(()=>{const x=document.querySelector(".page");if(!x)return;let v=x.scrollTop,f=!1;const I=()=>{f||(f=!0,requestAnimationFrame(()=>{const M=x.scrollTop,P=M-v;M<=12||P<-12?d(!0):P>12&&d(!1),v=M,f=!1}))};return x.addEventListener("scroll",I,{passive:!0}),()=>x.removeEventListener("scroll",I)},[]),D.useEffect(()=>{const x=document.querySelector(".page");if(!x)return;const v=120,f=70,I=c=>{var m;S||(x.scrollTop<=0?(N.current=!0,l.current=((m=c.touches[0])==null?void 0:m.clientY)??0):N.current=!1)},M=c=>{var B;if(!N.current||S)return;const m=((B=c.touches[0])==null?void 0:B.clientY)??0,R=Math.max(0,m-l.current);if(R>0){const F=Math.min(v,R*.5);p(F)}},P=async()=>{try{if(w(!0),r)await r();else{window.location.reload();return}}finally{setTimeout(()=>{w(!1),p(0)},400)}},n=()=>{!N.current||S||(b>=f?P():p(0),N.current=!1)};return x.addEventListener("touchstart",I,{passive:!0}),x.addEventListener("touchmove",M,{passive:!0}),x.addEventListener("touchend",n),x.addEventListener("touchcancel",n),()=>{x.removeEventListener("touchstart",I),x.removeEventListener("touchmove",M),x.removeEventListener("touchend",n),x.removeEventListener("touchcancel",n)}},[b,S,r]),e.jsxs("div",{className:"mobile-page-header",children:[e.jsxs("div",{className:`mobile-page-header-inner ${y?"show":"hide"}`,children:[e.jsx("div",{className:"mobile-page-header-left",children:e.jsx(Ue,{to:"/profile",className:"icon-link","aria-label":"Profile",children:s!=null&&s.avatar_url?e.jsx("img",{src:s.avatar_url,width:22,height:22,style:{borderRadius:"50%"}}):e.jsx("span",{style:{display:"inline-block",width:22,height:22,borderRadius:"50%",background:"rgba(255,255,255,0.2)"}})})}),t?e.jsx("div",{className:"mobile-page-header-title",children:t}):null]}),e.jsx("div",{className:"mobile-ptr-indicator","aria-hidden":"true",style:{opacity:S||b>4?1:0,transform:`translate(-50%, calc(-100% + ${Math.min(b,70)}px))`},children:e.jsx("div",{className:`mobile-ptr-spinner ${S?"spin":b>60?"ready":""}`})})]})}const Je={standard:Lt,taiko:Ft,mania:It,catch:Rt},Ke={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Ot=({value:t,onChange:r})=>{const[s,y]=i.useState(!1),d=i.useRef(null);i.useEffect(()=>{if(!s)return;const p=w=>{d.current&&!d.current.contains(w.target)&&y(!1)},S=w=>{w.key==="Escape"&&y(!1)};return document.addEventListener("mousedown",p),document.addEventListener("keydown",S),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",S)}},[s]);const b=p=>e.jsxs("button",{className:`mode-option${p===t?" selected":""}`,onClick:()=>{r(p),y(!1)},role:"option","aria-selected":p===t,children:[e.jsx("img",{className:"mode-icon",src:Je[p],width:24,height:24,alt:""}),e.jsx("span",{children:Ke[p]})]},p);return e.jsxs("div",{className:"mode-select",ref:d,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":s,onClick:()=>y(p=>!p),children:[e.jsx("img",{className:"mode-icon",src:Je[t],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:Ke[t]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),s&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(b)})]})};function Ge(t){if(!t)return"standard";const r=String(t).toLowerCase().trim();return r==="osu"||r==="0"||r==="standard"?"standard":r==="taiko"||r==="1"?"taiko":r==="catch"||r==="fruits"||r==="2"?"catch":r==="mania"||r==="3"?"mania":"standard"}function ot({section:t,onUpload:r,onPost:s,forceExpanded:y}){const{notify:d}=pe(),b=t==="mappi",[p,S]=i.useState(!1),[w,N]=i.useState(""),[l,x]=i.useState(null),[v,f]=i.useState(null),[I,M]=i.useState(!1),[P,n]=i.useState(""),c=i.useRef(0),[m,R]=i.useState(""),[B,F]=i.useState("standard"),[k,H]=i.useState(null),[j,q]=i.useState(0),[Y,ee]=i.useState(""),[ie,U]=i.useState(""),[ge,he]=i.useState(null),[ce,J]=i.useState(""),[W,Q]=i.useState(""),[ae,K]=i.useState(null),[ne,o]=i.useState(!1),[_,Z]=i.useState(null),te=100*1024*1024,ue=i.useMemo(()=>k?`${k.name}:${k.size}:${k.lastModified}`:null,[k]),[X,G]=i.useState(""),[de,ye]=i.useState(!1),[oe,fe]=i.useState([]),be=i.useRef(null);i.useEffect(()=>{c.current&&window.clearTimeout(c.current);const g=(w||"").trim();if(!g){n(""),x(null),f(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(g)){n(""),x(null),f(null);return}return c.current=window.setTimeout(async()=>{var z;try{let L;try{L=new URL(g)}catch{n("Invalid URL format");return}const re=L.hash.match(/#osu\/(\d+)/),O=re?re[1]:null;L.hash="";const ze={url:L.toString()};O&&(ze.beatmap_id=O);const $=await C(T.osu.resolveBeatmap+at(ze),{requireAuth:!1}),me=Array.isArray($==null?void 0:$.diffs)?$.diffs:[];if(!me.length&&!$.setId){n("No difficulties found"),x(null),f(null);return}if(x({setId:Number($.setId)||0,beatmapId:$.beatmapId??null,title:String($.title||""),artist:String($.artist||""),mapper:String($.mapper||""),diffs:me}),me.length>0){const Pe=Number.isFinite(Number($.beatmapId))?Number($.beatmapId):Number((z=me[0])==null?void 0:z.id),le=me.find(qe=>Number(qe.id)===Pe)||me[0],xe=Ge(le==null?void 0:le.mode);f({beatmapId:Number(le==null?void 0:le.id)||null,version:String((le==null?void 0:le.version)||""),mode:xe}),b&&F(xe)}else f(null);n("")}catch(L){const re=(L==null?void 0:L.message)||"Unknown error";n(`Failed to resolve: ${re}`),x(null),f(null)}},400),()=>{c.current&&window.clearTimeout(c.current)}},[w,b]);async function Te(){return U("info"),ee("Requesting upload URL..."),await C(T.uploads.new,{method:"POST",body:JSON.stringify({description:m.slice(0,100),beatmap_url:w||void 0,size_bytes:(k==null?void 0:k.size)??void 0,mode:B,beatmapset_id:(l==null?void 0:l.setId)??void 0,beatmap_id:(v==null?void 0:v.beatmapId)??void 0,beatmap_version:(v==null?void 0:v.version)??void 0,beatmap_title:l?`${l.title}`:void 0,beatmap_artist:l?`${l.artist}`:void 0,beatmap_mapper:l?`${l.mapper}`:void 0})})}async function ve(g,E,z="form"){await new Promise((L,re)=>{const O=new XMLHttpRequest;if(O.open("POST",g),O.upload.onprogress=se=>{se.lengthComputable&&q(Math.round(se.loaded/se.total*100))},O.onload=()=>O.status>=200&&O.status<300?L():re(new Error(`Upload failed (${O.status}) ${O.responseText||""}`)),O.onerror=()=>re(new Error("Network error")),z==="form"){const se=new FormData;se.append("file",E,E.name),O.send(se)}else O.setRequestHeader("Content-Type","application/octet-stream"),O.send(E)})}async function Ce(){if(!(!k||!b)){if(k.size>te){J("File exceeds 100MB limit");return}if(typeof ae=="number"&&ae>60.5){Q("Clip exceeds 60s limit");return}ue&&(o(!0),Z(ue)),q(0),U("info");try{const g=await Te();he(g.streamUID);let E=g.streamUID;try{ee("Uploading..."),await ve(g.uploadURL,k,"form")}catch(z){U("warn"),ee(`Retrying upload... (${(z==null?void 0:z.message)||z})`);const L=await Te();he(L.streamUID),E=L.streamUID,await ve(L.uploadURL,k,"binary")}U("info"),ee("Processing...");for(let z=0;z<60;z++){await new Promise(L=>setTimeout(L,3e3));try{if((await C(T.videos.get(E),{requireAuth:!1})).status==="ready"){U("success"),ee("Ready!"),d("Upload complete!",{variant:"success"}),H(null),R(""),N(""),x(null),f(null),F("standard"),q(0),he(null),J(""),Q(""),K(null),o(!1),Z(null),r&&r();break}}catch{}}}catch(g){U("error"),ee(g.message||"Error"),d(g.message||"Upload failed",{variant:"error"})}}}const je=async g=>{if(g.preventDefault(),!b){if(!X.trim()){d("Text is required",{variant:"error"});return}if(X.length>200){d("Text must be 200 characters or less",{variant:"error"});return}ye(!0);try{const E=await C(T.moddi.posts,{method:"POST",body:JSON.stringify({text:X.trim(),beatmap_url:w.trim()||void 0,beatmapset_id:(l==null?void 0:l.setId)??void 0,beatmap_id:(v==null?void 0:v.beatmapId)??(l==null?void 0:l.beatmapId)??void 0,beatmap_version:(v==null?void 0:v.version)??void 0,tags:oe.length>0?oe.join(","):void 0})});if(E){console.log("Post created response:",E);const z=E==null?void 0:E.post;z?(!z.uid&&z.id&&(console.warn("Created post missing uid, using id as fallback:",z),z.uid=String(z.id)),s&&s(z)):s&&s(),d("Post created!",{variant:"success"}),G(""),N(""),x(null),f(null),n(""),M(!1),fe([])}}catch{d("Failed to create post",{variant:"error"})}finally{ye(!1)}}},Se=!!y||p;return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:b?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:y?"default":"pointer",padding:"8px 12px",minHeight:36},onClick:()=>{y||S(!p)},children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:b?"Upload a clip":"Create a post!"}),Se?e.jsx(Ze,{size:16}):e.jsx(Fe,{size:16})]}),Se&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Ot,{value:B,onChange:F})]}),l?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[l.artist," – ",l.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",l.mapper]})]}),l.diffs.length>0&&e.jsx("select",{value:(v==null?void 0:v.beatmapId)??l.beatmapId??void 0,onChange:g=>{const E=Number(g.target.value),z=(l==null?void 0:l.diffs.find(L=>Number(L.id)===E))||null;if(z){const L=Ge(z.mode);f({beatmapId:E,version:z.version,mode:L}),F(L)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:l.diffs.map(g=>e.jsxs("option",{value:g.id,children:[g.version," (",g.mode,")"]},g.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>M(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{x(null),f(null),N("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:w,onChange:g=>N(g.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:m,onChange:g=>R(g.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),P&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:P}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:g=>{var L;const E=((L=g.target.files)==null?void 0:L[0])||null;if(H(E),K(null),E&&E.size>te?J("File exceeds 100MB limit"):J(""),E)try{const re=URL.createObjectURL(E),O=document.createElement("video");O.preload="metadata",O.src=re,O.onloadedmetadata=()=>{URL.revokeObjectURL(re);const se=Number.isFinite(O.duration)?O.duration:NaN;Number.isFinite(se)&&K(se),Number.isFinite(se)&&se>60.5?Q("Clip exceeds 60s limit"):Q("")},O.onerror=()=>{URL.revokeObjectURL(re),K(null)}}catch{K(null)}else Q("");const z=E?`${E.name}:${E.size}:${E.lastModified}`:null;z&&z!==_&&o(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:Ce,disabled:!k||!!ce||!!W||ne,style:{flexShrink:0},children:"Upload"})]}),ce&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:ce}),W&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:W}),k&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",k.name," • ",(k.size/1024/1024).toFixed(1)," MB",ne&&_===ue?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(j>0||Y)&&e.jsxs("div",{className:"upload-status",children:[Y&&e.jsx("div",{className:`chip ${ie||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:Y}),j>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":j,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,j))}%`}})})]}),ge&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",ge]})]})]}):e.jsx("form",{onSubmit:je,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:be,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:X,onChange:g=>G(g.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),l?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[l.artist," – ",l.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",l.mapper]})]}),l.diffs.length>0&&e.jsx("select",{value:(v==null?void 0:v.beatmapId)??l.beatmapId??void 0,onChange:g=>{const E=Number(g.target.value),z=(l==null?void 0:l.diffs.find(L=>Number(L.id)===E))||null;z&&f({beatmapId:E,version:z.version,mode:String(z.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:l.diffs.map(g=>e.jsxs("option",{value:g.id,children:[g.version," (",g.mode,")"]},g.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:w,onChange:g=>N(g.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),P&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:P}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{oe.includes("help")?fe(oe.filter(g=>g!=="help")):fe([...oe,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:oe.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:oe.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:oe.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>M(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{x(null),f(null),N("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:de||!X.trim()||X.length>200,children:de?"Posting...":"Post"})]})]})})}),I&&l&&e.jsx(nt,{open:I,onClose:()=>M(!1),downloadUrl:T.osu.downloadBeatmapset(l.setId),beatmapId:(v==null?void 0:v.beatmapId)??l.beatmapId??void 0,beatmapVersion:v==null?void 0:v.version})]})}function Wt({section:t,onUpload:r,onPost:s}){const[y,d]=D.useState(!1),b=D.useRef(null),p=D.useRef(null),S=D.useRef(!1),w=v=>{var f;p.current=((f=v.touches[0])==null?void 0:f.clientY)??null,S.current=!1},N=v=>{var P,n;if(p.current==null)return;const I=(((P=v.touches[0])==null?void 0:P.clientY)??p.current)-p.current;(((n=b.current)==null?void 0:n.scrollTop)??0)<=0&&I>60?S.current=!0:S.current=!1},l=()=>{S.current&&d(!1),p.current=null,S.current=!1},x=y?e.jsx("div",{className:"mobile-upload-overlay",onClick:()=>d(!1),children:e.jsx("div",{ref:b,className:"mobile-upload-sheet",onClick:v=>v.stopPropagation(),onTouchStart:w,onTouchMove:N,onTouchEnd:l,children:e.jsx("div",{style:{paddingTop:6},children:e.jsx(ot,{section:t,forceExpanded:!0,onUpload:()=>{r==null||r(),d(!1)},onPost:v=>{s==null||s(v),d(!1)}})})})}):null;return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":t==="mappi"?"Upload clip":"New post",title:t==="mappi"?"Upload clip":"New post",onClick:()=>d(!0),children:e.jsx(Ee,{size:22})}),y?_e.createPortal(x,document.body):null]})}function Qt(){const{data:t}=ke(),{tagFilters:r}=Oe();return gt({queryKey:["moddi","feed",r],queryFn:async({pageParam:s=0})=>{const y=new URLSearchParams({limit:"20",offset:String(s)}),d=`${T.moddi.posts}?${y.toString()}`;return await C(d)},enabled:!!t,initialPageParam:0,getNextPageParam:(s,y)=>{var p;const d=y.reduce((S,w)=>{var N;return S+(((N=w.items)==null?void 0:N.length)||0)},0);return(((p=s.items)==null?void 0:p.length)||0)===20?d:void 0}})}function ss(){const t=ht(),r=Ne(),{data:s}=ke(),{tagFilters:y}=Oe(),{data:d,fetchNextPage:b,hasNextPage:p,isFetching:S,isFetchingNextPage:w,refetch:N}=Qt(),l=i.useMemo(()=>d!=null&&d.pages?d.pages.flatMap(n=>(n.items||[]).map(m=>({...m,user_id:m.user_id??0,username:m.username||"Unknown",avatar_url:m.avatar_url||null,text:m.text??null,uid:m.uid||String(m.id||""),reactions_count:Number(m.reactions_count??0),reacted_by_me:m.reacted_by_me??!1,comments_count:Number(m.comments_count??0)}))):[],[d]),x=i.useMemo(()=>l.filter(n=>{const c=n.tags?typeof n.tags=="string"?n.tags.split(",").map(B=>B.trim()):[]:[],m=!n.tags||c.length===0,R=c.includes("help");return y.untagged&&y.help?!0:y.untagged&&!y.help?m:!y.untagged&&y.help?R:!1}),[l,y]);i.useEffect(()=>{t.pathname==="/md/feed"&&N()},[t.pathname,N]),i.useEffect(()=>{const n=()=>{N()};return window.addEventListener("moddifilterchange",n),()=>window.removeEventListener("moddifilterchange",n)},[N]);const v=n=>{r.setQueryData(["moddi","feed"],c=>c&&{...c,pages:c.pages.map(m=>({...m,items:m.items.map(R=>R.id===n.id?n:R)}))})},f=n=>{r.setQueryData(["moddi","feed"],c=>c&&{...c,pages:c.pages.map(m=>({...m,items:m.items.filter(R=>R.id!==n)}))})},I=n=>{n&&r.setQueryData(["moddi","feed"],c=>{if(!c)return c;const m={...n,user_id:n.user_id??0,username:n.username||"Unknown",avatar_url:n.avatar_url||null,text:n.text??null,uid:n.uid||String(n.id||""),reactions_count:Number(n.reactions_count??0),reacted_by_me:n.reacted_by_me??!1,comments_count:Number(n.comments_count??0)};return{...c,pages:c.pages.map((R,B)=>B===0?{...R,items:[m,...R.items||[]]}:R)}}),r.invalidateQueries({queryKey:["moddi","feed"]}),N()},M=S&&!w,P=p??!1;return e.jsxs("div",{className:"feed-container moddi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx(it,{title:"Feed"}),e.jsxs("div",{className:"feed-header",children:[e.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),e.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),e.jsx(ot,{section:"moddi",onPost:I})]}),e.jsx(Wt,{section:"moddi",onPost:I}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:0},children:[x.length===0&&!M&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),x.map(n=>e.jsx(rt,{post:n,section:"moddi",onUpdate:v,onDelete:f,me:s},n.id)),x.length>0&&P&&e.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("button",{className:"btn secondary",onClick:()=>b(),disabled:w,children:w?"Loading...":"Load more"})})]})})]})}function as(){const{uid:t}=et(),r=Be(),[s,y]=i.useState(null),[d,b]=i.useState([]),[p,S]=i.useState(!0),[w,N]=i.useState(null),[l,x]=i.useState(""),[v,f]=i.useState(null),[I,M]=i.useState(!1),{notify:P}=pe();i.useEffect(()=>{C(T.auth.me,{requireAuth:!1}).then(j=>N(j)).catch(()=>{})},[]);const n=async()=>{if(!t||t==="null"||t==="undefined"){P("Invalid post identifier",{variant:"error"}),r("/md/feed");return}S(!0);try{const j=await C(T.moddi.post(t),{requireAuth:!1}),q={...j,user_id:j.user_id??0,username:j.username||"Unknown",avatar_url:j.avatar_url||null,uid:j.uid||String(j.id)||t,text:j.text??null,beatmap_url:j.beatmap_url??null,beatmapset_id:j.beatmapset_id??null,beatmap_id:j.beatmap_id??null,beatmap_version:j.beatmap_version??null,tags:j.tags??null,reactions_count:Number(j.reactions_count??0),reacted_by_me:j.reacted_by_me??!1,comments_count:Number(j.comments_count??0)};y(q)}catch{P("Failed to load post",{variant:"error"}),r("/md/feed")}finally{S(!1)}},c=async()=>{if(s!=null&&s.id)try{const j=await C(T.moddi.postComments(s.id),{requireAuth:!1});b(j.items||[])}catch{}};i.useEffect(()=>{n()},[t]),i.useEffect(()=>{s!=null&&s.id&&c()},[s==null?void 0:s.id]);const m=j=>{y(j)},R=()=>{r("/md/feed")},B=async j=>{if(j.preventDefault(),!(!l.trim()||!(s!=null&&s.id))){M(!0);try{await C(T.moddi.postComments(s.id),{method:"POST",body:JSON.stringify({text:l.trim(),parent_id:v||void 0})}),x(""),f(null),c(),n(),P("Comment posted!",{variant:"success"})}catch(q){P((q==null?void 0:q.message)||"Failed to post comment",{variant:"error"})}finally{M(!1)}}},F=j=>{b(q=>q.filter(Y=>Y.id!==j))};if(p)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!s)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const k=d.filter(j=>!j.parent_id),H=new Map;return d.filter(j=>j.parent_id).forEach(j=>{const q=j.parent_id;H.has(q)||H.set(q,[]),H.get(q).push(j)}),e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link",onClick:()=>r("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(tt,{size:20})}),e.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(rt,{post:s,section:"moddi",onUpdate:m,onDelete:R,me:w})}),w&&!v&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:B,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:l,onChange:j=>x(j.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:j=>{const q=j.target;q.style.height="auto",q.style.height=`${Math.min(q.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:I||!l.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:I?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:k.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:k.map(j=>e.jsx(Ct,{comment:j,replies:H.get(j.id)||[],me:w,section:"moddi",onReply:q=>f(q),onDelete:F,replyingTo:v,replyText:l,onReplyTextChange:x,onReplySubmit:B,posting:I,onCancelReply:()=>{f(null),x("")},repliesMap:H},j.id))})})]})}function $t({queue:t}){return e.jsx(Ue,{to:`/md/queues/${t.id}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",cursor:"pointer"},onMouseEnter:r=>r.currentTarget.style.background="rgba(255,255,255,0.02)",onMouseLeave:r=>r.currentTarget.style.background="rgba(255,255,255,0.01)",children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,marginBottom:8},children:[t.is_group?e.jsx(ft,{size:18}):e.jsx(De,{size:18}),e.jsx("strong",{style:{fontSize:16},children:t.name}),t.is_member&&e.jsx("span",{className:"chip",style:{fontSize:11,padding:"2px 8px"},children:"Member"})]}),t.description&&e.jsx("div",{className:"muted",style:{fontSize:14,marginBottom:8},children:t.description}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,fontSize:12},children:[t.owner_avatar_url&&e.jsx("img",{src:t.owner_avatar_url,width:20,height:20,style:{borderRadius:"50%"}}),e.jsxs("span",{className:"muted",children:["by ",t.owner_username,t.member_count!==void 0&&Number(t.member_count)>0&&(Number(t.member_count)===1&&t.first_member_username?` and ${t.first_member_username}`:` & ${t.member_count} others`)]}),e.jsx("span",{className:"muted",children:"•"}),e.jsx("span",{className:"muted",children:new Date(t.created_at*1e3).toLocaleDateString()})]})]})})}function We(){return we({queryKey:["moddi","queues"],queryFn:async()=>{const t=await C(T.moddi.queues);return Array.isArray(t.items)?t.items:[]}})}function lt(){const t=Ne();return Me({mutationFn:async r=>{var s;return await C(T.moddi.queues,{method:"POST",body:JSON.stringify({name:r.name.trim(),description:((s=r.description)==null?void 0:s.trim())||null,is_group:r.is_group??!1})})},onSuccess:()=>{t.invalidateQueries({queryKey:["moddi","queues"]})}})}function Ht(){const[t,r]=D.useState(!1),[s,y]=D.useState(""),[d,b]=D.useState(""),p=D.useRef(null),S=D.useRef(null),w=D.useRef(!1),{data:N=[]}=We(),{data:l}=ke(),{notify:x}=pe(),v=lt(),f=D.useMemo(()=>l?N.some(m=>m.owner_id===l.id):!1,[l,N]),I=m=>{var R;S.current=((R=m.touches[0])==null?void 0:R.clientY)??null,w.current=!1},M=m=>{var k,H;if(S.current==null)return;const B=(((k=m.touches[0])==null?void 0:k.clientY)??S.current)-S.current;(((H=p.current)==null?void 0:H.scrollTop)??0)<=0&&B>60?w.current=!0:w.current=!1},P=()=>{w.current&&r(!1),S.current=null,w.current=!1},n=m=>{if(m&&m.preventDefault(),f){x("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!s.trim()){x("Queue name is required",{variant:"error"});return}v.mutate({name:s.trim(),description:d.trim()||null,is_group:!1},{onSuccess:()=>{x("Queue created!",{variant:"success"}),r(!1),y(""),b("")},onError:R=>{x((R==null?void 0:R.message)||"Failed to create queue",{variant:"error"})}})},c=t?e.jsx("div",{className:"mobile-upload-overlay",onClick:()=>r(!1),children:e.jsx("div",{ref:p,className:"mobile-upload-sheet",onClick:m=>m.stopPropagation(),onTouchStart:I,onTouchMove:M,onTouchEnd:P,children:e.jsxs("form",{onSubmit:n,className:"col",style:{gap:12},children:[f?e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:s,onChange:m=>y(m.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:d,onChange:m=>b(m.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>r(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:v.isPending||f,children:v.isPending?"Creating...":"Create"})]})]})})}):null;return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Create queue",title:"Create queue",onClick:()=>r(!0),children:e.jsx(Ee,{size:22})}),t?_e.createPortal(c,document.body):null]})}function rs(){const{data:t=[],isLoading:r}=We(),{data:s}=ke(),y=lt(),{notify:d}=pe(),[b,p]=i.useState(!1),[S,w]=i.useState(""),[N,l]=i.useState(""),x=i.useMemo(()=>s?t.some(f=>f.owner_id===s.id):!1,[s,t]),v=async f=>{if(f.preventDefault(),x){d("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!S.trim()){d("Queue name is required",{variant:"error"});return}y.mutate({name:S.trim(),description:N.trim()||null,is_group:!1},{onSuccess:()=>{d("Queue created!",{variant:"success"}),p(!1),w(""),l("")},onError:I=>{d((I==null?void 0:I.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs("div",{className:"feed-container queues-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx(it,{title:"Queues"}),e.jsx(Ht,{}),e.jsx("div",{className:"feed-header",children:e.jsx("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:0},children:x?e.jsx("div",{style:{padding:"12px"},children:e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>p(!b),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:"Create a queue!"}),b?e.jsx(Ze,{size:16}):e.jsx(Fe,{size:16})]}),b&&e.jsx("form",{onSubmit:v,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:S,onChange:f=>w(f.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:N,onChange:f=>l(f.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:f=>{f.stopPropagation(),p(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:y.isPending||x,onClick:f=>f.stopPropagation(),children:y.isPending?"Creating...":"Create"})]})]})})]})})}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("div",{className:"col",style:{gap:0},children:r?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No queues yet. Create one to get started!"}):t.map(f=>e.jsx($t,{queue:f},f.id))})})]})}function Yt({beatmapMeta:t,beatmapVersion:r}){const s=i.useRef(null),y=i.useRef(null),[d,b]=i.useState(!1),[p,S]=i.useState(!1),[w,N]=i.useState(0);i.useEffect(()=>{if(s.current&&y.current){const v=s.current.offsetWidth,f=y.current.scrollWidth;N(f),S(f>v)}},[t,r]);const l=t?e.jsxs(e.Fragment,{children:[t.artist," – ",t.title,t.mapper?` (by ${t.mapper})`:"",r?` [${r}]`:""]}):r?`[${r}]`:"Beatmap",x=w>0?Math.max(3,w/50):3;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),e.jsxs("div",{ref:s,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:p?"pointer":"default"},onMouseEnter:()=>p&&b(!0),onMouseLeave:()=>b(!1),children:[e.jsx("span",{ref:y,style:{display:"inline-block",animation:d&&p?`beatmap-marquee ${x}s linear infinite`:"none"},children:l}),d&&p&&e.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:l})]})]})}function Xe({submission:t,canManage:r,onUpdate:s,onDelete:y,isGroup:d=!1}){const[b,p]=i.useState(!1),[S,w]=i.useState(!1),[N,l]=i.useState(null),[x,v]=i.useState(t.beatmapset_id),[f,I]=i.useState(t.beatmap_id),[M,P]=i.useState(!1),[n,c]=i.useState(!1),[m,R]=i.useState(null),[B,F]=i.useState(!1),[k,H]=i.useState(t.acknowledgments||[]),[j,q]=i.useState(t.acknowledged_by_me||!1),Y=i.useRef(null),ee=i.useRef(null),ie=i.useRef(null),{notify:U}=pe();i.useEffect(()=>{H(t.acknowledgments||[]),q(t.acknowledged_by_me||!1)},[t.acknowledgments,t.acknowledged_by_me]),i.useEffect(()=>{if(t.beatmap_url)try{const o=new URL(t.beatmap_url),_=o.pathname.match(/\/beatmapsets\/(\d+)/);if(_&&!t.beatmapset_id){const te=Number(_[1]);isNaN(te)||v(te)}const Z=o.hash.match(/#osu\/(\d+)/);if(Z&&!t.beatmap_id){const te=Number(Z[1]);isNaN(te)||I(te)}}catch(o){console.error("[QueueSubmission] Error parsing beatmap URL:",t.beatmap_url,o)}},[t.beatmap_url,t.beatmapset_id,t.beatmap_id,t.id]),i.useEffect(()=>{console.log("[QueueSubmission] Submission data:",{id:t.id,beatmap_url:t.beatmap_url,beatmapset_id:t.beatmapset_id,beatmap_id:t.beatmap_id,extracted_beatmapset_id:x,extracted_beatmap_id:f,beatmap_version:t.beatmap_version})},[t.id,x,f]),i.useEffect(()=>{if(!t.beatmap_url||N&&x)return;let o=!1;return(async()=>{try{console.log("[QueueSubmission] Fetching beatmap metadata...",{beatmap_url:t.beatmap_url,existing_beatmapset_id:t.beatmapset_id,existing_beatmap_id:t.beatmap_id});let _;try{_=new URL(t.beatmap_url)}catch(G){console.error("[QueueSubmission] Invalid beatmap URL:",t.beatmap_url,G);return}const Z=_.hash.match(/#osu\/(\d+)/),te=Z?Z[1]:null;_.hash="";const X={url:_.toString()};if(te?X.beatmap_id=te:t.beatmap_id&&(X.beatmap_id=String(t.beatmap_id)),console.log("[QueueSubmission] Resolving beatmap with params:",X),!o){const G=await C(T.osu.resolveBeatmap+at(X),{requireAuth:!1});console.log("[QueueSubmission] Beatmap resolve response:",G),G.setId&&!x&&(console.log("[QueueSubmission] Setting beatmapset_id from API:",G.setId),v(Number(G.setId))),(G.title||G.artist)&&l({title:G.title||null,artist:G.artist||null,mapper:G.mapper||null})}}catch(_){console.error("[QueueSubmission] Error fetching beatmap metadata:",_)}})(),()=>{o=!0}},[t.beatmap_url,t.beatmap_id,t.beatmapset_id,N,x]),i.useEffect(()=>{if(!M||!ie.current){R(null);return}const o=()=>{if(ie.current){const _=ie.current.getBoundingClientRect();R({top:_.bottom+8,right:window.innerWidth-_.right})}};return o(),window.addEventListener("resize",o),window.addEventListener("scroll",o,!0),()=>{window.removeEventListener("resize",o),window.removeEventListener("scroll",o,!0)}},[M]),i.useEffect(()=>{if(!S)return;const o=_=>{const Z=_.target;Y.current&&!Y.current.contains(Z)&&!Z.closest("[data-status-dropdown]")&&w(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[S]),i.useEffect(()=>{if(!M)return;const o=_=>{ee.current&&!ee.current.contains(_.target)&&ie.current&&!ie.current.contains(_.target)&&P(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[M]);const ge=async o=>{if(!b){p(!0);try{await C(T.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({status:o})});const _={...t,status:o,updated_at:Math.floor(Date.now()/1e3)};s&&s(_),U("Status updated",{variant:"success"})}catch{U("Failed to update status",{variant:"error"})}finally{p(!1),w(!1)}}},he=async()=>{if(!b){p(!0);try{const o=!!t.is_archived;await C(T.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({is_archived:!o})});const _={...t,is_archived:o?0:1,updated_at:Math.floor(Date.now()/1e3)};s&&s(_),U(o?"Unarchived":"Archived",{variant:"success"})}catch{U("Failed to update archive status",{variant:"error"})}finally{p(!1)}}},ce=async()=>{if(confirm("Are you sure you want to delete this submission? This action cannot be undone.")&&!b){p(!0);try{await C(T.moddi.queueSubmissionDelete(String(t.queue_id),t.id),{method:"DELETE"}),U("Submission deleted",{variant:"success"}),y&&y(t.id)}catch{U("Failed to delete submission",{variant:"error"})}finally{p(!1)}}},J=async()=>{if(!B){F(!0);try{if(j){if(await C(T.moddi.queueSubmissionUnacknowledge(String(t.queue_id),t.id),{method:"DELETE"}),q(!1),U("Unacknowledged",{variant:"info"}),s){const o={...t,acknowledged_by_me:!1};s(o)}}else if(await C(T.moddi.queueSubmissionAcknowledge(String(t.queue_id),t.id),{method:"POST"}),q(!0),U("Acknowledged",{variant:"success"}),s){const o={...t,acknowledged_by_me:!0};s(o)}}catch{U("Failed to update acknowledgment",{variant:"error"})}finally{F(!1)}}},W={unchecked:"#f59e0b",accepted:"#10b981",denied:"#ef4444",finished:"#6366f1"},Q={unchecked:"Pending",accepted:"Accepted",denied:"Denied",finished:"Finished"},ae=x||t.beatmapset_id,K=ae?`https://assets.ppy.sh/beatmaps/${ae}/covers/card.jpg`:null;i.useEffect(()=>{K?console.log("[QueueSubmission] Background image URL:",K,"for beatmapset_id:",ae):console.log("[QueueSubmission] No background image URL - beatmapset_id:",ae,"submission.beatmapset_id:",t.beatmapset_id)},[K,ae,t.beatmapset_id]);const ne=!!t.is_archived;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"relative",borderRadius:12,overflow:"hidden",borderBottom:"1px solid rgba(255,255,255,0.06)",background:K?"transparent":"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",opacity:ne?.6:1},onMouseEnter:o=>{K||(o.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)")},onMouseLeave:o=>{K||(o.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)")},children:[K&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:K,alt:"",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover",opacity:.35,zIndex:0,pointerEvents:"none"},onError:o=>{o.currentTarget.style.display="none"}}),e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.75) 100%)",zIndex:0}})]}),e.jsx("div",{style:{position:"relative",zIndex:1,padding:"16px"},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",justifyContent:"space-between",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[t.beatmap_url&&e.jsx("div",{style:{marginBottom:8},children:e.jsx(Yt,{beatmapMeta:N,beatmapVersion:t.beatmap_version})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,marginTop:8},children:[t.avatar_url&&e.jsx("img",{src:t.avatar_url,width:24,height:24,style:{borderRadius:"50%"},alt:t.username}),e.jsx("span",{style:{fontSize:13},children:t.username}),e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(t.created_at*1e3).toLocaleDateString()})]}),t.message&&e.jsx("div",{style:{marginTop:8,fontSize:13,lineHeight:1.5,color:"var(--text)"},children:t.message}),t.beatmap_url&&e.jsx("div",{style:{marginTop:12,display:"flex",alignItems:"center",gap:8},children:e.jsxs("button",{ref:ie,className:"chip-btn link",onClick:o=>{o.preventDefault(),o.stopPropagation(),P(_=>!_)},title:"Beatmap options","aria-label":"Beatmap options",style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 12px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:6,color:"var(--text)",fontSize:13,cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:o=>{o.currentTarget.style.background="rgba(255,255,255,0.1)",o.currentTarget.style.borderColor="rgba(255,255,255,0.2)"},onMouseLeave:o=>{o.currentTarget.style.background="rgba(255,255,255,0.05)",o.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[e.jsx($e,{size:14}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),e.jsx(Fe,{size:12,style:{marginLeft:4,opacity:.7}})]})})]}),r?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[k&&k.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[k.slice(0,5).map((o,_)=>o.avatar_url?e.jsx("img",{src:o.avatar_url,alt:o.username,title:o.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:_>0?-8:0,zIndex:k.length-_,position:"relative",cursor:"pointer"}},o.user_id):e.jsx("div",{title:o.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:_>0?-8:0,zIndex:k.length-_,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:o.username.charAt(0).toUpperCase()},o.user_id)),k.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${k.length-5} more`,children:["+",k.length-5]})]}),e.jsx("button",{className:"icon-link",onClick:J,disabled:B||b,title:j?"Unacknowledge":"Acknowledge",style:{color:j?"#10b981":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:j?"rgba(16, 185, 129, 0.1)":"transparent"},onMouseEnter:o=>{!B&&!b&&(o.currentTarget.style.background=j?"rgba(16, 185, 129, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:o=>{o.currentTarget.style.background=j?"rgba(16, 185, 129, 0.1)":"transparent"},children:e.jsx(yt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:he,disabled:b,title:ne?"Unarchive":"Archive",style:{color:ne?"#6366f1":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:ne?"rgba(99, 102, 241, 0.1)":"transparent"},onMouseEnter:o=>{b||(o.currentTarget.style.background=ne?"rgba(99, 102, 241, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:o=>{o.currentTarget.style.background=ne?"rgba(99, 102, 241, 0.1)":"transparent"},children:ne?e.jsx(xt,{size:16}):e.jsx(bt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:ce,disabled:b,title:"Delete submission",style:{color:"var(--danger)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:"transparent"},onMouseEnter:o=>{b||(o.currentTarget.style.background="rgba(239, 68, 68, 0.1)")},onMouseLeave:o=>{o.currentTarget.style.background="transparent"},children:e.jsx(Le,{size:16})}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("button",{ref:Y,onClick:()=>w(!S),disabled:b,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:W[t.status]+"15",border:`1.5px solid ${W[t.status]}50`,color:W[t.status],whiteSpace:"nowrap",cursor:b?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:b?.6:1},onMouseEnter:o=>{b||(o.currentTarget.style.background=W[t.status]+"25",o.currentTarget.style.borderColor=W[t.status]+"70",o.currentTarget.style.transform="translateY(-1px)")},onMouseLeave:o=>{o.currentTarget.style.background=W[t.status]+"15",o.currentTarget.style.borderColor=W[t.status]+"50",o.currentTarget.style.transform="translateY(0)"},children:[e.jsx("span",{children:Q[t.status]}),e.jsx(Fe,{size:14,style:{marginLeft:2,transition:"transform 0.2s ease",transform:S?"rotate(180deg)":"rotate(0deg)"}})]}),S&&Y.current&&_e.createPortal(e.jsx("div",{"data-status-dropdown":!0,style:{position:"fixed",background:"var(--panel)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:6,zIndex:1e4,minWidth:140,boxShadow:"0 8px 24px rgba(0,0,0,0.4)",...(()=>{const o=Y.current.getBoundingClientRect();return{top:o.bottom+6,right:window.innerWidth-o.right}})()},onClick:o=>o.stopPropagation(),children:["unchecked","accepted","denied","finished"].map(o=>e.jsx("button",{onClick:()=>ge(o),style:{display:"block",width:"100%",padding:"8px 12px",borderRadius:6,fontSize:13,fontWeight:o===t.status?600:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",textAlign:"left",background:o===t.status?W[o]+"15":"transparent",color:o===t.status?W[o]:"var(--text)",border:"none",cursor:"pointer",transition:"all 0.15s ease",marginBottom:2},onMouseEnter:_=>{o!==t.status&&(_.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:_=>{o!==t.status&&(_.currentTarget.style.background="transparent")},children:Q[o]},o))}),document.body)]})]}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[k&&k.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[k.slice(0,5).map((o,_)=>o.avatar_url?e.jsx("img",{src:o.avatar_url,alt:o.username,title:o.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:_>0?-8:0,zIndex:k.length-_,position:"relative",cursor:"pointer"}},o.user_id):e.jsx("div",{title:o.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:_>0?-8:0,zIndex:k.length-_,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:o.username.charAt(0).toUpperCase()},o.user_id)),k.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${k.length-5} more`,children:["+",k.length-5]})]}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:W[t.status]+"15",border:`1.5px solid ${W[t.status]}50`,color:W[t.status],whiteSpace:"nowrap"},children:Q[t.status]})]})]})})]}),M&&m&&t.beatmap_url&&e.jsxs("div",{ref:ee,style:{position:"fixed",top:m.top,right:m.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>P(!1),children:[e.jsx($e,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),ae&&e.jsx("button",{className:"menu-item",onClick:()=>{c(!0),P(!1)},children:"Preview"})]}),n&&ae&&e.jsx(nt,{open:n,onClose:()=>c(!1),downloadUrl:`${zt}${T.osu.downloadBeatmapset(ae)}`,beatmapId:f??t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0})]})}function Jt({queueId:t,onSubmitted:r}){const[s,y]=D.useState(!1),[d,b]=D.useState(t),[p,S]=D.useState(""),[w,N]=D.useState(""),[l,x]=D.useState(!1),v=D.useRef(null),f=D.useRef(null),I=D.useRef(!1),{notify:M}=pe(),{data:P=[]}=We();D.useEffect(()=>{b(t)},[t]);const n=F=>{var k;f.current=((k=F.touches[0])==null?void 0:k.clientY)??null,I.current=!1},c=F=>{var q,Y;if(f.current==null)return;const H=(((q=F.touches[0])==null?void 0:q.clientY)??f.current)-f.current;(((Y=v.current)==null?void 0:Y.scrollTop)??0)<=0&&H>60?I.current=!0:I.current=!1},m=()=>{I.current&&y(!1),f.current=null,I.current=!1},R=async()=>{if(!d){M("Please select a queue",{variant:"error"});return}if(!p.trim()){M("Beatmap URL is required",{variant:"error"});return}x(!0);try{await C(T.moddi.queueSubmit(d),{method:"POST",body:JSON.stringify({beatmap_url:p.trim(),message:w.trim()||null})}),M("Submission created!",{variant:"success"}),S(""),N(""),y(!1),r==null||r()}catch(F){M((F==null?void 0:F.message)||"Failed to create submission",{variant:"error"})}finally{x(!1)}},B=s?e.jsx("div",{className:"mobile-upload-overlay",onClick:()=>y(!1),children:e.jsx("div",{ref:v,className:"mobile-upload-sheet",onClick:F=>F.stopPropagation(),onTouchStart:n,onTouchMove:c,onTouchEnd:m,children:e.jsxs("div",{className:"col",style:{gap:12},children:[!t&&e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Queue:"}),e.jsxs("select",{value:d??"",onChange:F=>b(F.target.value||void 0),style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",fontSize:13},children:[e.jsx("option",{value:"",disabled:!0,children:"Select queue"}),P.map(F=>e.jsx("option",{value:String(F.id),children:F.name},F.id))]})]}),e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:p,onChange:F=>S(F.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:w,onChange:F=>N(F.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),w.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[w.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>y(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"btn",disabled:l,onClick:R,children:l?"Submitting...":"Submit"})]})]})})}):null;return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Submit to queue",title:"Submit to queue",onClick:()=>y(!0),children:e.jsx(Ee,{size:22})}),s?_e.createPortal(B,document.body):null]})}const Ve=({content:t})=>e.jsx("div",{style:{fontSize:13,lineHeight:1.6,color:"var(--text)"},children:e.jsx(St,{components:{p:({children:r})=>e.jsx("p",{style:{margin:"0 0 8px 0"},children:r}),ul:({children:r})=>e.jsx("ul",{style:{margin:"0 0 8px 0",paddingLeft:20},children:r}),ol:({children:r})=>e.jsx("ol",{style:{margin:"0 0 8px 0",paddingLeft:20},children:r}),li:({children:r})=>e.jsx("li",{style:{margin:"0 0 4px 0"},children:r}),strong:({children:r})=>e.jsx("strong",{style:{fontWeight:600},children:r}),em:({children:r})=>e.jsx("em",{children:r}),code:({children:r})=>e.jsx("code",{style:{background:"rgba(255,255,255,0.1)",padding:"2px 4px",borderRadius:4,fontSize:12},children:r}),h1:({children:r})=>e.jsx("h1",{style:{fontSize:18,fontWeight:700,margin:"0 0 8px 0"},children:r}),h2:({children:r})=>e.jsx("h2",{style:{fontSize:16,fontWeight:700,margin:"0 0 8px 0"},children:r}),h3:({children:r})=>e.jsx("h3",{style:{fontSize:14,fontWeight:600,margin:"0 0 8px 0"},children:r})},children:t})});function ns(){const{id:t}=et(),r=Be(),[s,y]=i.useState(null),[d,b]=i.useState([]),[p,S]=i.useState([]),[w,N]=i.useState(!0),[l,x]=i.useState(null),[v,f]=i.useState(!1),[I,M]=i.useState(!1),[P,n]=i.useState(""),[c,m]=i.useState(""),[R,B]=i.useState(null),[F,k]=i.useState(!1),[H,j]=i.useState(""),[q,Y]=i.useState(""),[ee,ie]=i.useState(""),[U,ge]=i.useState(!1),[he,ce]=i.useState(!1),[J,W]=i.useState("general"),[Q,ae]=i.useState(!1),[K,ne]=i.useState(!1),[o,_]=i.useState(null),[Z,te]=i.useState(""),[ue,X]=i.useState([]),[G,de]=i.useState(!1),ye=i.useRef(null),oe=i.useRef(null),fe=i.useRef(null),[be,Te]=i.useState([]),[ve,Ce]=i.useState(!1),[je,Se]=i.useState(null),{notify:g}=pe(),{queueStatusFilters:E}=Oe(),z=async()=>{var a,h;if(t){N(!0);try{const u=await C(T.moddi.queue(t),{requireAuth:!1});y(u.queue||null),b(u.members||[]),S(u.submissions||[])}catch(u){(a=u==null?void 0:u.message)!=null&&a.includes("403")||(h=u==null?void 0:u.message)!=null&&h.includes("Forbidden")?(g("You do not have access to this queue",{variant:"error"}),r("/md/queues")):g("Failed to load queue",{variant:"error"})}finally{N(!1)}}};i.useEffect(()=>{z(),C(T.auth.me,{requireAuth:!1}).then(a=>x(a)).catch(()=>{})},[t]);const L=l&&s&&(s.owner_id===l.id||d.some(a=>a.user_id===l.id&&a.joined_at));l&&d.some(a=>a.user_id===l.id&&a.joined_at);const re=l&&s&&(s.owner_id===l.id||d.some(a=>a.user_id===l.id&&a.joined_at)),O=async a=>{if(a.preventDefault(),!s||s.is_open===0){g("Queue is closed for submissions",{variant:"error"});return}if(!P.trim()){g("Beatmap URL is required",{variant:"error"});return}M(!0);try{await C(T.moddi.queueSubmit(t),{method:"POST",body:JSON.stringify({beatmap_url:P.trim(),message:c.trim()||null})}),g("Submission created!",{variant:"success"}),f(!1),n(""),m(""),z()}catch(h){g((h==null?void 0:h.message)||"Failed to create submission",{variant:"error"})}finally{M(!1)}},se=a=>{S(h=>h.map(u=>u.id===a.id?a:u)),a.acknowledged_by_me!==void 0&&z()},ze=()=>{s&&(j(s.name),Y(s.description||""),ie(s.rules||""),k(!0),W("general"))},$=()=>{k(!1),j(""),Y(""),ie("")},me=async()=>{if(!(!s||!re)){ce(!0);try{const a=s.is_open!==1;await C(T.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_open:a})}),g(`Queue ${a?"opened":"closed"}`,{variant:"success"}),z()}catch(a){g((a==null?void 0:a.message)||"Failed to update status",{variant:"error"})}finally{ce(!1)}}},Pe=async a=>{if(a.preventDefault(),!s||!H.trim()){g("Queue name is required",{variant:"error"});return}ae(!0);try{const h=d.filter(u=>u.user_id!==s.owner_id&&u.role!=="owner").length>0;await C(T.moddi.queue(t),{method:"PATCH",body:JSON.stringify({name:H.trim(),description:q.trim()||null,rules:ee.trim()||null,is_group:h})}),g("Queue updated!",{variant:"success"}),$(),z()}catch(h){g((h==null?void 0:h.message)||"Failed to update queue",{variant:"error"})}finally{ae(!1)}};i.useEffect(()=>{if(!Z.trim()){X([]),de(!1);return}const a=setTimeout(async()=>{try{const u=(await C(T.moddi.usersSearch(Z),{requireAuth:!1})).items||[];X(u),de(u.length>0)}catch(h){console.error("Search failed:",h),X([]),de(!1)}},300);return()=>clearTimeout(a)},[Z]);const le=async a=>{if(!K){ne(!0);try{await C(T.moddi.queueInvite(t),{method:"POST",body:JSON.stringify({user_id:a})}),g("Invite sent!",{variant:"success"}),te(""),X([]),de(!1),z()}catch(h){g((h==null?void 0:h.message)||"Failed to invite member",{variant:"error"})}finally{ne(!1)}}},xe=async()=>{if(!(!t||!L))try{const a=await C(T.moddi.queueBlockedUsers(t));Te(a.blocked||[])}catch(a){console.error("Failed to load blocked users:",a)}},qe=async a=>{if(!(!t||ve)&&confirm("Block this user from submitting to this queue?")){Ce(!0);try{await C(T.moddi.queueBlockUser(t),{method:"POST",body:JSON.stringify({user_id:a})}),g("User blocked",{variant:"success"}),xe(),te(""),X([]),de(!1)}catch(h){g((h==null?void 0:h.message)||"Failed to block user",{variant:"error"})}finally{Ce(!1)}}},Qe=async a=>{if(!(!t||je===a)){Se(a);try{await C(T.moddi.queueUnblockUser(t,a),{method:"DELETE"}),g("User unblocked",{variant:"success"}),xe()}catch(h){g((h==null?void 0:h.message)||"Failed to unblock user",{variant:"error"})}finally{Se(null)}}};i.useEffect(()=>{J==="members"&&L&&t&&xe()},[J,L,t]);const dt=async()=>{if(s&&confirm(`Are you sure you want to delete "${s.name}"? This action cannot be undone.`)){ge(!0);try{await C(T.moddi.queue(t),{method:"DELETE"}),g("Queue deleted",{variant:"success"}),r("/md/queues")}catch(a){g((a==null?void 0:a.message)||"Failed to delete queue",{variant:"error"})}finally{ge(!1)}}},ct=async a=>{if(!l||!s||l.id!==s.owner_id){g("Only the queue owner can remove members",{variant:"error"});return}if(confirm("Remove this member from the queue?")){_(a);try{await C(T.moddi.queueMember(t,a),{method:"DELETE"}),g("Member removed",{variant:"success"});const u=d.filter(A=>A.user_id!==a).some(A=>A.user_id!==(s==null?void 0:s.owner_id)&&A.role!=="owner");if(s&&s.is_group===1&&!u)try{await C(T.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after removing last member")}z()}catch(h){g((h==null?void 0:h.message)||"Failed to remove member",{variant:"error"})}finally{_(null)}}},ut=async()=>{if(l&&confirm("Leave this queue? You will need to be invited again to rejoin.")){_(l.id);try{await C(T.moddi.queueMember(t,l.id),{method:"DELETE"}),g("Left queue",{variant:"success"});const h=d.filter(u=>u.user_id!==l.id).some(u=>u.user_id!==(s==null?void 0:s.owner_id)&&u.role!=="owner");if(s&&s.is_group===1&&!h)try{await C(T.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after leaving")}r("/md/queues")}catch(a){g((a==null?void 0:a.message)||"Failed to leave queue",{variant:"error"})}finally{_(null)}}},mt=async a=>{if(confirm("Cancel this invitation?")){_(a);try{await C(T.moddi.queueMember(t,a),{method:"DELETE"}),g("Invitation canceled",{variant:"success"}),z()}catch(h){g((h==null?void 0:h.message)||"Failed to cancel invitation",{variant:"error"})}finally{_(null)}}};return i.useEffect(()=>{if(!F)return;const a=h=>{const u=h.target;u.closest(".manage-overlay")||u.closest(".manage-overlay-backdrop")||!u.closest(".manage-popup")&&fe.current&&!fe.current.contains(u)&&$()};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[F]),i.useEffect(()=>{if(!G)return;const a=h=>{const u=h.target;ye.current&&!ye.current.contains(u)&&oe.current&&!oe.current.contains(u)&&de(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[G]),w?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):s?e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t&&e.jsx(Jt,{queueId:t,onSubmitted:()=>z()}),e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:12,marginBottom:16,paddingTop:16},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flex:1,minWidth:0},children:[e.jsx("button",{className:"icon-link",onClick:()=>r("/md/queues"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(tt,{size:20})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:10,flex:1,minWidth:0},children:[e.jsx("div",{className:"title",style:{flex:1,minWidth:0},children:s.name}),re&&e.jsxs("button",{onClick:me,disabled:he,className:`queue-status-badge ${s.is_open===1?"status-open":"status-closed"}`,title:s.is_open===1?"Close queue":"Open queue","aria-label":s.is_open===1?"Close queue":"Open queue",children:[s.is_open===1?e.jsx(Ae,{size:14}):e.jsx(He,{size:14}),e.jsx("span",{children:s.is_open===1?"Open":"Closed"})]})]})]}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[L&&e.jsx("button",{ref:fe,className:"icon-link",onClick:ze,style:{width:"auto",height:"auto",padding:"4px"},title:"Manage Queue","aria-label":"Manage Queue",children:e.jsx(vt,{size:18})}),d.length>0&&e.jsx("div",{style:{display:"flex",alignItems:"center",gap:6},children:d.filter(a=>a.joined_at!==null).sort((a,h)=>{const u=a.role==="owner"||a.user_id===(s==null?void 0:s.owner_id),A=h.role==="owner"||h.user_id===(s==null?void 0:s.owner_id);return u&&!A?-1:!u&&A?1:(h.joined_at||0)-(a.joined_at||0)}).map(a=>e.jsxs("div",{style:{position:"relative"},onMouseEnter:()=>B(a.user_id),onMouseLeave:()=>B(null),children:[e.jsx(Ue,{to:`/profile/${a.user_id}`,className:"queue-member-avatar",title:a.username,children:a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:a.username}):e.jsx("div",{style:{width:"100%",height:"100%",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,color:"var(--muted)"},children:a.username.charAt(0).toUpperCase()})}),R===a.user_id&&e.jsxs("div",{className:"queue-member-tooltip",children:[a.username," ",a.role!=="member"?`(${a.role})`:""]})]},a.user_id))})]})]}),s.description&&e.jsx("div",{className:"muted",style:{marginBottom:16,fontSize:14,padding:"0 4px"},children:s.description}),s.rules&&e.jsxs("div",{style:{marginBottom:16,padding:12,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10},children:[e.jsx("div",{style:{fontSize:14,fontWeight:600,marginBottom:8},children:"Rules"}),e.jsx(Ve,{content:s.rules})]}),s.is_open===0&&e.jsx("div",{style:{marginBottom:12,padding:10,background:"rgba(245, 158, 11, 0.1)",border:"1px solid rgba(245, 158, 11, 0.3)",borderRadius:10,textAlign:"center",fontSize:14,color:"#f59e0b"},children:"This queue is currently closed for submissions"}),e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:12,opacity:s.is_open===0?.6:1},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:s.is_open===1?"pointer":"not-allowed",padding:"8px 12px",minHeight:36},onClick:()=>s.is_open===1&&f(!v),children:[e.jsxs("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:["Submit a beatmap ",s.is_open===0&&"(Closed)"]}),s.is_open===1&&(v?e.jsx(Ie,{size:16}):e.jsx(Ee,{size:16}))]}),v&&e.jsx("form",{onSubmit:O,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:P,onChange:a=>n(a.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:c,onChange:a=>m(a.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),c.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[c.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:a=>{a.stopPropagation(),f(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:I,onClick:a=>a.stopPropagation(),children:I?"Submitting...":"Submit"})]})]})})]}),e.jsxs("div",{className:"profile-tabs-unified",style:{marginTop:24},children:[e.jsxs("div",{className:"profile-tabs-header",role:"tablist","aria-label":"Submission sections",children:[e.jsx("button",{role:"tab","aria-selected":!0,className:"profile-tab active","data-tab":"active",onClick:a=>{const h=a.currentTarget.closest(".profile-tabs-unified");h.querySelectorAll(".profile-tab").forEach(A=>{A.classList.remove("active"),A.setAttribute("aria-selected","false")}),a.currentTarget.classList.add("active"),a.currentTarget.setAttribute("aria-selected","true"),h.querySelector(".profile-tabs-content").setAttribute("data-active","active")},children:"Active"}),e.jsx("button",{role:"tab","aria-selected":!1,className:"profile-tab","data-tab":"archived",onClick:a=>{const h=a.currentTarget.closest(".profile-tabs-unified");h.querySelectorAll(".profile-tab").forEach(A=>{A.classList.remove("active"),A.setAttribute("aria-selected","false")}),a.currentTarget.classList.add("active"),a.currentTarget.setAttribute("aria-selected","true"),h.querySelector(".profile-tabs-content").setAttribute("data-active","archived")},children:"Archived"})]}),e.jsxs("div",{className:"profile-tabs-content","data-active":"active",children:[e.jsx("div",{className:"panel active",children:e.jsx("div",{className:"col",style:{gap:0},children:p.filter(a=>!!!a.is_archived&&E[a.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No active submissions."}):p.filter(a=>!!!a.is_archived&&E[a.status]).map(a=>e.jsx(Xe,{submission:a,canManage:!!L,isGroup:(s==null?void 0:s.is_group)===1,onUpdate:se,onDelete:h=>{S(u=>u.filter(A=>A.id!==h))}},a.id))})}),e.jsx("div",{className:"panel archived",children:e.jsx("div",{className:"col",style:{gap:0},children:p.filter(a=>!!a.is_archived&&E[a.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No archived submissions."}):p.filter(a=>!!a.is_archived&&E[a.status]).map(a=>e.jsx(Xe,{submission:a,canManage:!!L,isGroup:(s==null?void 0:s.is_group)===1,onUpdate:se,onDelete:h=>{S(u=>u.filter(A=>A.id!==h))}},a.id))})})]})]}),F&&_e.createPortal(e.jsxs("div",{className:"overlay manage-overlay",children:[e.jsx("div",{className:"overlay-backdrop manage-overlay-backdrop",onClick:$}),e.jsxs("div",{className:"overlay-card",style:{maxWidth:500},children:[e.jsx("button",{className:"overlay-close",onClick:$,"aria-label":"Close",children:e.jsx(Ie,{size:18})}),e.jsxs("div",{className:"col",style:{gap:0,padding:"0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:16,padding:"20px 16px 12px",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("div",{className:"title",style:{fontSize:20,margin:0,padding:0,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Manage Queue"}),e.jsxs("div",{className:"tabs",role:"tablist",style:{margin:0},children:[e.jsx("button",{role:"tab","aria-selected":J==="general",className:`tab ${J==="general"?"active":""}`,onClick:()=>W("general"),children:"General"}),e.jsx("button",{role:"tab","aria-selected":J==="rules",className:`tab ${J==="rules"?"active":""}`,onClick:()=>W("rules"),children:"Rules"}),e.jsx("button",{role:"tab","aria-selected":J==="members",className:`tab ${J==="members"?"active":""}`,onClick:()=>W("members"),children:"Members"})]})]}),e.jsx("hr",{className:"subtle-divider",style:{margin:"0 16px"}}),e.jsxs("form",{onSubmit:Pe,className:"col",style:{gap:0,padding:"16px"},children:[J==="general"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Queue Name"}),e.jsx("input",{type:"text",value:H,onChange:a=>j(a.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}})]}),e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Description (optional)"}),e.jsx("textarea",{placeholder:"Description",value:q,onChange:a=>Y(a.target.value),rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"space-between",alignItems:"center",marginTop:8},children:[e.jsxs("button",{type:"button",className:"btn secondary",onClick:dt,disabled:U||Q,style:{background:"rgba(248, 113, 113, 0.1)",borderColor:"rgba(248, 113, 113, 0.3)",color:"var(--danger)",fontSize:13,padding:"8px 12px"},children:[e.jsx(Le,{size:14,style:{marginRight:6}}),U?"Deleting...":"Delete Queue"]}),e.jsxs("div",{className:"row",style:{gap:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:$,disabled:Q||U,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:Q||U,style:{fontSize:13,padding:"8px 16px"},children:Q?"Updating...":"Save Changes"})]})]})]}),J==="rules"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Rules (optional, markdown supported)"}),e.jsx("textarea",{placeholder:"Rules in markdown format...",value:ee,onChange:a=>ie(a.target.value),rows:8,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:13,resize:"vertical"}}),ee&&e.jsxs("div",{style:{padding:10,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,fontSize:12},children:[e.jsx("div",{style:{fontSize:12,fontWeight:600,marginBottom:6,opacity:.8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Preview:"}),e.jsx(Ve,{content:ee})]})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:$,disabled:Q||U,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:Q||U,style:{fontSize:13,padding:"8px 16px"},children:Q?"Updating...":"Save Changes"})]})]}),J==="members"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6,position:"relative"},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invite Members"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{ref:ye,type:"text",placeholder:"Search username or ID",value:Z,onChange:a=>te(a.target.value),onKeyDown:a=>{a.key==="Enter"&&a.preventDefault()},onFocus:()=>{ue.length>0&&de(!0)},style:{width:"100%",background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),G&&ue.length>0&&e.jsx("div",{ref:oe,style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,maxHeight:300,overflowY:"auto",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},children:e.jsx("div",{className:"col",style:{gap:0},children:ue.map(a=>{const h=d.some(V=>V.user_id===a.id&&V.joined_at),u=d.some(V=>V.user_id===a.id&&V.invited_at&&!V.joined_at),A=be.some(V=>V.user_id===a.id);return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"8px 12px"},children:[e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:8,minWidth:0},children:[a.avatar_url&&e.jsx("img",{src:a.avatar_url,width:20,height:20,style:{borderRadius:"50%",flexShrink:0}}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontSize:13,fontWeight:500,display:"flex",alignItems:"center",gap:8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("span",{children:a.username}),h&&e.jsx("span",{style:{color:"var(--muted)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Already a member"}),u&&e.jsx("span",{style:{color:"var(--accent)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]}),e.jsxs("div",{className:"muted",style:{fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["id ",a.id," • osu ",a.osu_user_id]})]})]}),L&&!h&&!u&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{className:"icon-link",onClick:V=>{V.stopPropagation(),K||le(a.id)},disabled:K,title:"Invite user",style:{width:"auto",height:"auto",padding:"4px"},children:e.jsx(st,{size:16})}),e.jsx("button",{className:"icon-link",onClick:V=>{V.stopPropagation(),A?Qe(a.id):qe(a.id)},disabled:ve||je===a.id,title:A?"Unblock user":"Block user",style:{width:"auto",height:"auto",padding:"4px",color:A?"var(--accent)":"var(--danger)"},children:A?e.jsx(Ae,{size:16}):e.jsx(He,{size:16})})]})]},a.id)})})})]})]}),d.length>0&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Members"}),e.jsx("div",{className:"col",style:{gap:4},children:(()=>{const a=d.filter(u=>u.joined_at!==null).sort((u,A)=>{const V=u.role==="owner"||u.user_id===(s==null?void 0:s.owner_id),Re=A.role==="owner"||A.user_id===(s==null?void 0:s.owner_id);return V&&!Re?-1:!V&&Re?1:(A.joined_at||0)-(u.joined_at||0)}),h=d.filter(u=>u.invited_at!==null&&u.joined_at===null);return e.jsxs(e.Fragment,{children:[a.map(u=>{const A=l&&s&&l.id===s.owner_id,V=u.user_id===(l==null?void 0:l.id),Re=u.user_id===(s==null?void 0:s.owner_id)||u.role==="owner";return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[u.avatar_url&&e.jsx("img",{src:u.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:u.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:u.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:u.role})]})]}),A&&!Re&&e.jsx("button",{className:"icon-link",onClick:()=>ct(u.user_id),disabled:o===u.user_id,title:"Remove member",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(Le,{size:16})}),!A&&V&&e.jsx("button",{className:"icon-link",onClick:ut,disabled:o===u.user_id,title:"Leave queue",style:{width:"auto",height:"auto",padding:"4px",color:"var(--muted)"},children:e.jsx(jt,{size:16})})]},u.user_id)}),h.length>0&&e.jsx(e.Fragment,{children:h.map(u=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",opacity:.7},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[u.avatar_url&&e.jsx("img",{src:u.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:u.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:u.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>mt(u.user_id),disabled:o===u.user_id,title:"Cancel invitation",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(Ie,{size:16})})]},u.user_id))})]})})()})]}),L&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Blocked Users"}),be.length===0?e.jsx("div",{className:"muted",style:{fontSize:12,padding:"8px 0",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"No blocked users"}):e.jsx("div",{className:"col",style:{gap:4},children:be.map(a=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[a.avatar_url&&e.jsx("img",{src:a.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:a.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:a.username}),a.blocked_by_username&&e.jsxs("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["Blocked by ",a.blocked_by_username]})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>Qe(a.user_id),disabled:je===a.user_id,title:"Unblock user",style:{width:"auto",height:"auto",padding:"4px",color:"var(--accent)"},children:e.jsx(Ae,{size:16})})]},a.user_id))})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:$,disabled:Q||U,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:Q||U,style:{fontSize:13,padding:"8px 16px"},children:Q?"Updating...":"Save Changes"})]})]})]})]})]})]}),document.body),e.jsx("style",{children:`
        .queue-member-avatar {
          width: 32px;
          height: 32px;
          border-radius: 9999px;
          padding: 0;
          border: 1px solid rgba(255,255,255,0.08);
          overflow: hidden;
          cursor: pointer;
          background: transparent;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: border-color 0.2s;
        }
        .queue-member-avatar:hover {
          border-color: rgba(167, 139, 250, 0.4);
        }
        .queue-member-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }
        .queue-member-tooltip {
          position: absolute;
          bottom: calc(100% + 8px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(18, 20, 24, 0.95);
          color: var(--text, #e5e7eb);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 6px;
          padding: 6px 10px;
          font-size: 14px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          pointer-events: none;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
        }
        .queue-member-tooltip::after {
          content: '';
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-top: 5px solid rgba(18, 20, 24, 0.95);
        }
        .queue-status-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
          border: 1px solid;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        }
        .queue-status-badge:disabled {
          cursor: not-allowed;
          opacity: 0.6;
        }
        .queue-status-badge.status-open {
          background: rgba(52, 211, 153, 0.15);
          border-color: rgba(52, 211, 153, 0.4);
          color: #34d399;
        }
        .queue-status-badge.status-open:hover:not(:disabled) {
          background: rgba(52, 211, 153, 0.25);
          border-color: rgba(52, 211, 153, 0.5);
        }
        .queue-status-badge.status-closed {
          background: rgba(245, 158, 11, 0.15);
          border-color: rgba(245, 158, 11, 0.4);
          color: #f59e0b;
        }
        .queue-status-badge.status-closed:hover:not(:disabled) {
          background: rgba(245, 158, 11, 0.25);
          border-color: rgba(245, 158, 11, 0.5);
        }
      `})]}):e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Queue not found"})}function is(){const{data:t=[],isLoading:r}=Dt(),s=Ut(),y=Bt(),{notify:d}=pe(),b=Be(),[p,S]=i.useState(new Set),w=async n=>{s.mutate(n,{onSuccess:()=>{}})},N=async n=>{n.startsWith("n:")&&y.mutate(n)},l=async()=>{const n=t.filter(c=>!c.read&&(c.id.startsWith("n:")||c.kind==="system"&&!c.id.startsWith("b:"))).map(c=>c.id);n.length>0&&(await w(n),d("All notifications marked as read",{variant:"success"}))},x=n=>{if(!n)return null;try{const c=JSON.parse(n);if((c==null?void 0:c.type)==="queue_invite"&&(c!=null&&c.queue_id))return c}catch{}return null},v=async(n,c)=>{if(!p.has(n.id)){S(m=>new Set(m).add(n.id));try{await C(T.moddi.queueAccept(String(c)),{method:"POST"}),d("Invitation accepted!",{variant:"success"}),N(n.id),b(`/md/queues/${c}`)}catch(m){d((m==null?void 0:m.message)||"Failed to accept invitation",{variant:"error"})}finally{S(m=>{const R=new Set(m);return R.delete(n.id),R})}}},f=async(n,c)=>{if(!p.has(n.id)){S(m=>new Set(m).add(n.id));try{await C(T.moddi.queueDeny(String(c)),{method:"POST"}),d("Invitation declined",{variant:"success"}),N(n.id)}catch(m){d((m==null?void 0:m.message)||"Failed to decline invitation",{variant:"error"})}finally{S(m=>{const R=new Set(m);return R.delete(n.id),R})}}},I=n=>x(n.text)?e.jsx(st,{size:20,color:"#a78bfa"}):n.kind==="star"?e.jsx(wt,{size:20,color:"#f59e0b"}):n.kind==="likes5"?e.jsx(Nt,{size:20,color:"#f472b6"}):n.kind==="comment"?e.jsx(De,{size:20,color:"#60a5fa"}):n.kind==="inspiration"?e.jsx(De,{size:20,color:"#7dd3fc"}):n.kind==="reaction"?e.jsx(_t,{size:20,color:"#10b981"}):n.id.startsWith("b:")?e.jsx(kt,{size:20,color:"#a78bfa"}):null,M=n=>x(n.text)?"Queue Invitation":n.kind==="star"?"Star":n.kind==="likes5"?"Likes":n.kind==="comment"?"Comment":n.kind==="inspiration"?"Inspiration":n.kind==="reaction"?"Reaction":n.id.startsWith("b:")?"Global":"System",P=t.filter(n=>!n.read&&!(n.id.startsWith("b:")&&n.expiresAt&&n.expiresAt<=Date.now())).length;return e.jsxs("div",{className:"moddi-notifications-page col",style:{width:"100%",maxWidth:700,margin:"0 auto"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{className:"title",children:"Notifications"}),P>0&&e.jsxs("button",{className:"btn secondary",onClick:l,children:[e.jsx(Ye,{size:16,style:{marginRight:6}}),"Mark all read"]})]}),r?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"No notifications yet."}):e.jsx("div",{className:"col",style:{gap:8},children:t.filter(n=>!(n.id.startsWith("b:")&&n.expiresAt&&n.expiresAt<=Date.now())).map(n=>e.jsx("div",{style:{background:n.read?"var(--panel-dark)":"var(--panel)",border:`1px solid ${n.read?"rgba(255,255,255,0.08)":"rgba(125, 211, 252, 0.3)"}`,borderRadius:12,padding:16,cursor:n.videoId?"pointer":"default",opacity:n.read?.7:1},onClick:()=>{!n.read&&n.id.startsWith("n:")&&w([n.id]),n.videoId&&(window.location.hash="/mp/feed")},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12},children:[e.jsx("div",{style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",borderRadius:"50%"},children:I(n)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[e.jsx("strong",{style:{fontSize:14},children:M(n)}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(n.createdAt).toLocaleDateString()}),n.id.startsWith("n:")&&e.jsx("button",{className:"icon-link",onClick:c=>{c.stopPropagation(),N(n.id)},style:{padding:4},children:e.jsx(Le,{size:14})})]})]}),e.jsx("div",{style:{fontSize:14,wordBreak:"break-word"},children:(()=>{const c=x(n.text);return c?`${c.inviter_username} invited you to join queue: ${c.queue_name}`:n.text||(n.kind==="star"?"One of your posts was starred!":n.kind==="likes5"?"One of your posts reached 5 likes!":n.kind==="comment"?"Someone commented on your post":n.kind==="inspiration"?"Someone is inspired by you!":n.kind==="reaction"?"Someone raised their hand on your post!":"")})()}),(()=>{const c=x(n.text);return c&&!p.has(n.id)?e.jsxs("div",{className:"row",style:{gap:8,marginTop:12},children:[e.jsxs("button",{className:"btn",onClick:m=>{m.stopPropagation(),v(n,c.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Ye,{size:14,style:{marginRight:4}}),"Accept"]}),e.jsxs("button",{className:"btn secondary",onClick:m=>{m.stopPropagation(),f(n,c.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Ie,{size:14,style:{marginRight:4}}),"Decline"]})]}):c&&p.has(n.id)?e.jsx("div",{className:"muted",style:{fontSize:12,marginTop:8},children:"Processing..."}):null})(),n.read&&n.readAt&&e.jsxs("div",{className:"muted",style:{fontSize:11,marginTop:4},children:["Read ",new Date(n.readAt).toLocaleString()]})]})]})},n.id))})]})}export{ot as C,it as M,is as N,as as P,rs as Q,Zt as a,ke as b,es as c,At as d,ts as e,Ut as f,Bt as g,Wt as h,ss as i,ns as j,Oe as u};

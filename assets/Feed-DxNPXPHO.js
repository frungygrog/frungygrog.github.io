import{J as M,g as E,e as L,r as p,j as o}from"./vendor-react-Bj2Cd7tG.js";import{P as C}from"./Post-BN8eLS7p.js";import{C as S}from"./Compose-Ci1oBmQ9.js";import{a as P,b as v,A as T,c as U}from"./index-C9X7C0OI.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-DvUOAkfg.js";import"./beatmap-preview-Ch7r1MMc.js";import"./editor-components-B-SB05wW.js";function _(){const{data:u}=P(),{tagFilters:c}=v();return M({queryKey:["moddi","feed",c],queryFn:async({pageParam:d=0})=>{const s=new URLSearchParams({limit:"20",offset:String(d)}),r=`${T.moddi.posts}?${s.toString()}`;return await U(r)},enabled:!!u,initialPageParam:0,getNextPageParam:(d,s)=>{var m;const r=s.reduce((h,l)=>{var i;return h+(((i=l.items)==null?void 0:i.length)||0)},0);return(((m=d.items)==null?void 0:m.length)||0)===20?r:void 0}})}function J(){const u=E(),c=L(),{data:d}=P(),{tagFilters:s}=v(),{data:r,fetchNextPage:x,hasNextPage:m,isFetching:h,isFetchingNextPage:l,refetch:i}=_(),y=p.useMemo(()=>r!=null&&r.pages?r.pages.flatMap(t=>(t.items||[]).map(e=>{var a,n,g;return{...e,user_id:e.user_id??((a=e.author)==null?void 0:a.id),username:e.username??((n=e.author)==null?void 0:n.username),avatar_url:e.avatar_url??((g=e.author)==null?void 0:g.avatar_url),uid:e.uid??String(e.id)}})):[],[r]),f=p.useMemo(()=>y.filter(t=>{const e=t.tags?typeof t.tags=="string"?t.tags.split(",").map(g=>g.trim()):[]:[],a=!t.tags||e.length===0,n=e.includes("help");return s.untagged&&s.help?!0:s.untagged&&!s.help?a:!s.untagged&&s.help?n:!1}),[y,s]);p.useEffect(()=>{u.pathname==="/md/feed"&&i()},[u.pathname,i]),p.useEffect(()=>{const t=()=>{i()};return window.addEventListener("moddifilterchange",t),()=>window.removeEventListener("moddifilterchange",t)},[i]);const b=t=>{c.setQueryData(["moddi","feed"],e=>e&&{...e,pages:e.pages.map(a=>({...a,items:a.items.map(n=>n.id===t.id?t:n)}))})},N=t=>{c.setQueryData(["moddi","feed"],e=>e&&{...e,pages:e.pages.map(a=>({...a,items:a.items.filter(n=>n.id!==t)}))})},j=()=>{i()},w=h&&!l,F=m??!1;return o.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[o.jsx(S,{section:"moddi",onPost:j}),o.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:o.jsxs("div",{className:"col",style:{gap:0},children:[f.length===0&&!w&&o.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),f.map(t=>o.jsx(C,{post:t,section:"moddi",onUpdate:b,onDelete:N,me:d},t.id)),f.length>0&&F&&o.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:o.jsx("button",{className:"btn secondary",onClick:()=>x(),disabled:l,children:l?"Loading...":"Load more"})})]})})]})}export{J as default};

import{K as z,M,N as O,r as i,j as a,P as U,L as H,A as W}from"./vendor-react-Bj2Cd7tG.js";import{P as V}from"./Post-BWezSF7F.js";import{C as J}from"./Comment-AU4VbrJ7.js";import{O as K}from"./Overlay-CC029a9L.js";import{u as X}from"./index-C78uQwsh.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";const c="https://api.osumappi.ng";function Y(n){var r;return(r=document.cookie.split("; ").map(o=>o.split("=")).find(([o])=>o===n))==null?void 0:r[1]}function re(){var _,$,F;const{uid:n}=z(),[r,o]=M(),p=O(),[t,v]=i.useState(null),[j,S]=i.useState([]),[N,w]=i.useState(!0),[h,B]=i.useState(null),[l,m]=i.useState(""),[g,x]=i.useState(null),[y,P]=i.useState(!1),[D,b]=i.useState(!1),{notify:d}=X();i.useEffect(()=>{fetch(`${c}/api/me`,{credentials:"include"}).then(e=>e.ok?e.json():null).then(e=>B(e)).catch(()=>{})},[]),i.useEffect(()=>{r.get("preview")==="true"&&b(!0)},[r]);const k=async()=>{if(n){w(!0);try{const e=await fetch(`${c}/api/videos/${n}`,{credentials:"include"});if(e.ok){const s=await e.json();v(s)}else d("Failed to load post",{variant:"error"}),p("/mp/feed")}catch{d("Failed to load post",{variant:"error"}),p("/mp/feed")}finally{w(!1)}}},C=async()=>{if(t!=null&&t.id)try{const e=await fetch(`${c}/api/videos/${t.id}/comments`,{credentials:"include"});if(e.ok){const s=await e.json();S(s.items||[])}}catch{}};i.useEffect(()=>{k()},[n]),i.useEffect(()=>{t!=null&&t.id&&C()},[t==null?void 0:t.id]);const I=e=>{v(e)},E=()=>{p("/mp/feed")},T=async e=>{if(e.preventDefault(),!(!l.trim()||!(t!=null&&t.id))){P(!0);try{const s=Y("csrf")||"",f=await fetch(`${c}/api/videos/${t.id}/comments`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":s},body:JSON.stringify({text:l.trim(),parent_id:g||void 0})});if(f.ok)m(""),x(null),C(),k(),d("Comment posted!",{variant:"success"});else{const A=await f.json().catch(()=>({}));d(A.error||"Failed to post comment",{variant:"error"})}}catch{d("Failed to post comment",{variant:"error"})}finally{P(!1)}}},L=e=>{S(s=>s.filter(f=>f.id!==e))};if(N)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!t)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const R=j.filter(e=>!e.parent_id),u=new Map;return j.filter(e=>e.parent_id).forEach(e=>{const s=e.parent_id;u.has(s)||u.set(s,[]),u.get(s).push(e)}),a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[a.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[a.jsx("button",{className:"icon-link",onClick:()=>p("/mp/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:a.jsx(U,{size:20})}),a.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:a.jsx(V,{post:t,section:"mappi",onUpdate:I,onDelete:E,me:h})}),h&&!g&&a.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:a.jsxs("form",{onSubmit:T,style:{display:"flex",alignItems:"flex-end",gap:8},children:[a.jsx("textarea",{placeholder:"Write a comment...",value:l,onChange:e=>m(e.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:e=>{const s=e.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,120)}px`}}),a.jsx("button",{type:"submit",className:"btn compact",disabled:y||!l.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:y?"...":"Post"})]})}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:R.length===0?a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):a.jsx("div",{className:"col",style:{gap:0},children:R.map(e=>a.jsx(J,{comment:e,replies:u.get(e.id)||[],me:h,section:"mappi",onReply:s=>x(s),onDelete:L,replyingTo:g,replyText:l,onReplyTextChange:m,onReplySubmit:T,posting:y,onCancelReply:()=>{x(null),m("")}},e.id))})})]}),t&&D&&t.beatmapset_id&&a.jsx(K,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{b(!1),o({})},beatmapDownloadUrl:`${c}/api/osu/beatmapsets/${t.beatmapset_id}/download?noVideo=1`,beatmapId:t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0,onOpenInEditor:()=>{b(!1),o({}),window.location.hash="/editor"},headerLeft:a.jsxs(a.Fragment,{children:[((_=t.uploader)==null?void 0:_.avatar_url)&&a.jsx("img",{src:t.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),a.jsxs(H,{to:`/profile/${($=t.uploader)==null?void 0:$.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[a.jsx("span",{children:(F=t.uploader)==null?void 0:F.username}),t.is_starred?a.jsx(W,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{re as default};

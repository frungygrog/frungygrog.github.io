var B=Object.defineProperty;var F=(n,t,e)=>t in n?B(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var A=(n,t,e)=>F(n,typeof t!="symbol"?t+"":t,e);import{r as m,j,Z as D}from"./vendor-react-_vsaDC62.js";import{H as S}from"./vendor-DBgzFpze.js";const X="video-cache",$=1,v="segments",y="manifests",Y=7*24*60*60*1e3,I=500*1024*1024;let N=null,C=null;function R(){return N?Promise.resolve(N):C||(C=new Promise((n,t)=>{const e=indexedDB.open(X,$);e.onerror=()=>t(e.error),e.onsuccess=()=>{N=e.result,n(N)},e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(v)||r.createObjectStore(v,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),r.objectStoreNames.contains(y)||r.createObjectStore(y,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),C)}async function Z(n,t=!1){try{const e=await R(),a=t?y:v,i=e.transaction([a],"readonly").objectStore(a).get(n);return new Promise(l=>{i.onsuccess=()=>{const c=i.result;if(!c){l(null);return}if(Date.now()-c.timestamp>Y){W(n,t).catch(()=>{}),l(null);return}l(c.data)},i.onerror=()=>l(null)})}catch(e){return console.warn("Cache read error:",e),null}}async function O(n,t,e=!1){try{const a=await R(),r=e?y:v,i=a.transaction([r],"readwrite").objectStore(r),l={url:n,data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((c,u)=>{const o=i.put(l);o.onsuccess=()=>c(),o.onerror=()=>u(o.error)}),await K()}catch(a){console.warn("Cache write error:",a)}}async function W(n,t=!1){try{const e=await R(),a=t?y:v,d=e.transaction([a],"readwrite").objectStore(a);await new Promise((i,l)=>{const c=d.delete(n);c.onsuccess=()=>i(),c.onerror=()=>l(c.error)})}catch(e){console.warn("Cache delete error:",e)}}async function G(){try{const n=await R();let t=0;for(const e of[v,y]){const d=n.transaction([e],"readonly").objectStore(e).getAll();await new Promise(i=>{d.onsuccess=()=>{const l=d.result;t+=l.reduce((c,u)=>c+u.size,0),i()},d.onerror=()=>i()})}return t}catch(n){return console.warn("Cache size calculation error:",n),0}}async function K(){try{const n=await G();if(n<=I)return;const t=await R(),e=[];for(const r of[v,y]){const d=r===y,c=t.transaction([r],"readonly").objectStore(r).getAll();await new Promise(u=>{c.onsuccess=()=>{const o=c.result;e.push(...o.map(f=>({url:f.url,timestamp:f.timestamp,size:f.size,isManifest:d}))),u()},c.onerror=()=>u()})}e.sort((r,d)=>r.timestamp-d.timestamp);let a=n;for(const r of e){if(a<=I*.8)break;await W(r.url,r.isManifest),a-=r.size}}catch(n){console.warn("Cache cleanup error:",n)}}function J(n){return n.includes(".m3u8")||n.endsWith("/manifest")}class Q{constructor(){A(this,"context",null);A(this,"stats",null);A(this,"defaultLoader",null)}load(t,e,a){this.context=t;const r=t.url,d=J(r);Z(r,d).then(i=>{if(i){const l={trequest:performance.now(),tfirst:performance.now(),tload:performance.now(),loaded:i.byteLength,total:i.byteLength};this.stats=l;const c={data:i,url:r};a.onSuccess(c,l,t);return}this.fetchFromNetwork(r,d,t,e,a)}).catch(i=>{this.fetchFromNetwork(r,d,t,e,a)})}async fetchFromNetwork(t,e,a,r,d){var l,c;const i=performance.now();try{const u=await fetch(t,{method:a.method||"GET",headers:a.headers||{},signal:(l=a.abortController)==null?void 0:l.signal});if(!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);let o;const f=u.headers.get("content-type")||"";e||f.includes("application/vnd.apple.mpegurl")||f.includes("text")?o=await u.text():o=await u.arrayBuffer();const E=performance.now(),p={trequest:i,tfirst:i,tload:E,loaded:typeof o=="string"?new TextEncoder().encode(o).length:o.byteLength,total:typeof o=="string"?new TextEncoder().encode(o).length:o.byteLength};if(o instanceof ArrayBuffer)await O(t,o,e);else{const x=new TextEncoder().encode(o);await O(t,x.buffer,e)}const z={data:o,url:u.url};this.stats=p,d.onSuccess(z,p,a)}catch(u){const o={trequest:i,tfirst:i,tload:performance.now(),loaded:0,total:0};u instanceof Error&&u.name==="AbortError"?(c=d.onAbort)==null||c.call(d,o,a):d.onError(u instanceof Error?u:new Error("Network error"),a,o)}}abort(){}destroy(){}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const re=({playbackUrl:n,streamUID:t,aspectRatio:e,preferNative:a=!1,autoplay:r=!1,loop:d=!1,muted:i=!1,controls:l=!0,onVideoRef:c,onClick:u})=>{const[o,f]=m.useState(1.7777777777777777),E=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;m.useEffect(()=>{if(!E)return;const s=()=>f(window.innerWidth/Math.max(1,window.innerHeight));return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[E]);const p=m.useRef(null),[z,H]=m.useState(null),x=m.useMemo(()=>{const s=1.3333333333333333,w=16/9,b=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(b)return Math.min(w,Math.max(s,b));const L=E?o:16/9;return Math.min(w,Math.max(s,L))},[E,o,e]),k=`${z??x} / 1`,g=m.useMemo(()=>n||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[n,t]);m.useEffect(()=>{H(null)},[g]),m.useEffect(()=>{if(!a||!p.current)return;const s=p.current;let w=!1;const b=()=>{if(!w)if(s.videoWidth>0&&s.videoHeight>0){const L=s.videoWidth/s.videoHeight,h=4/3,M=16/9,P=Math.min(M,Math.max(h,L));H(P),w=!0}else H(x),w=!0};return s.addEventListener("loadedmetadata",b),s.readyState>=1&&b(),()=>{s.removeEventListener("loadedmetadata",b)}},[a,x,g]),m.useEffect(()=>{if(!g)return;let s=null,w=null;const L=setTimeout(()=>{const h=p.current;if(h)if(S.isSupported()){const M={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:Q};s=new S(M),s.loadSource(g),s.attachMedia(h),s.on(S.Events.MANIFEST_PARSED,()=>{r&&h.play().catch(P=>{console.debug("Autoplay prevented:",P)})}),s.on(S.Events.ERROR,(P,T)=>{if(T.fatal)switch(T.type){case S.ErrorTypes.NETWORK_ERROR:console.warn("HLS network error, trying to recover..."),s==null||s.startLoad();break;case S.ErrorTypes.MEDIA_ERROR:console.warn("HLS media error, trying to recover..."),s==null||s.recoverMediaError();break;default:console.error("HLS fatal error:",T),s==null||s.destroy(),s=null;break}})}else console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=g,w=()=>{console.warn("Native HLS playback failed")},h.addEventListener("error",w),r&&h.play().catch(M=>{console.debug("Autoplay prevented:",M)})},0);return()=>{clearTimeout(L);const h=p.current;s&&(s.destroy(),s=null),h&&(w&&h.removeEventListener("error",w),h.src="")}},[g,r]),m.useEffect(()=>{c&&c(p.current)},[c,a,g]);const _="100%",q=E?{width:"100%",maxWidth:_,maxHeight:"100%",aspectRatio:k,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:_,maxHeight:"100%",height:"var(--player-height)",aspectRatio:k,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return g?j.jsx("div",{style:q,children:j.jsx("video",{ref:p,autoPlay:r,loop:d,muted:i,controls:l,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:u?"pointer":"default"},children:"Your browser does not support the video tag."},g)}):j.jsx("div",{style:q,children:"No video available"})},ne=({open:n,onClose:t,buttonRef:e,children:a,align:r="right",minWidth:d=160})=>{const[i,l]=m.useState(null),c=m.useRef(null);if(m.useEffect(()=>{if(!n||!e.current){l(null);return}const o=()=>{if(!e.current)return;const f=e.current.getBoundingClientRect();l({top:f.bottom+8,[r]:window.innerWidth-f[r==="right"?"right":"left"]})};return o(),window.addEventListener("resize",o),window.addEventListener("scroll",o,!0),()=>{window.removeEventListener("resize",o),window.removeEventListener("scroll",o,!0)}},[n,e,r]),m.useEffect(()=>{if(!n)return;const o=f=>{c.current&&!c.current.contains(f.target)&&e.current&&!e.current.contains(f.target)&&t()};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[n,t,e]),!n||!i)return null;const u=j.jsx("div",{ref:c,style:{position:"fixed",top:i.top,[r]:i[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:d,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:a});return D.createPortal(u,document.body)};export{re as P,ne as a};

import{J as S,g as C,e as D,r as h,j as o}from"./vendor-react-Bj2Cd7tG.js";import{P as Q}from"./Post-mthg35oU.js";import{C as T}from"./Compose-Bo6g-UqY.js";import{a as v,b as N,A as q,c as P}from"./index-CwUSomT9.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";function A(){const{data:p}=v(),{tagFilters:u}=N();return S({queryKey:["moddi","feed",u],queryFn:async({pageParam:m=0})=>{const s=new URLSearchParams({limit:"20",offset:String(m)}),n=`${q.moddi.posts}?${s.toString()}`;return await P(n)},enabled:!!p,initialPageParam:0,getNextPageParam:(m,s)=>{var f;const n=s.reduce((x,l)=>{var i;return x+(((i=l.items)==null?void 0:i.length)||0)},0);return(((f=m.items)==null?void 0:f.length)||0)===20?n:void 0}})}function z(){const p=C(),u=D(),{data:m}=v(),{tagFilters:s}=N(),{data:n,fetchNextPage:y,hasNextPage:f,isFetching:x,isFetchingNextPage:l,refetch:i}=A(),b=h.useMemo(()=>n!=null&&n.pages?n.pages.flatMap(e=>(e.items||[]).map(t=>{var d,g,c;const a=t.uid||String(t.id||"");return(!a||a==="null"||a==="undefined")&&console.warn("Post missing valid uid:",t),{...t,user_id:t.user_id??((d=t.author)==null?void 0:d.id)??0,username:t.username??((g=t.author)==null?void 0:g.username)??"Unknown",avatar_url:t.avatar_url??((c=t.author)==null?void 0:c.avatar_url)??null,text:t.text??null,uid:a,reactions_count:Number(t.reactions_count??0),reacted_by_me:t.reacted_by_me??!1,comments_count:Number(t.comments_count??0)}})):[],[n]),_=h.useMemo(()=>b.filter(e=>{const r=e.tags?typeof e.tags=="string"?e.tags.split(",").map(d=>d.trim()):[]:[],t=!e.tags||r.length===0,a=r.includes("help");return s.untagged&&s.help?!0:s.untagged&&!s.help?t:!s.untagged&&s.help?a:!1}),[b,s]);h.useEffect(()=>{p.pathname==="/md/feed"&&i()},[p.pathname,i]),h.useEffect(()=>{const e=()=>{i()};return window.addEventListener("moddifilterchange",e),()=>window.removeEventListener("moddifilterchange",e)},[i]);const j=e=>{u.setQueryData(["moddi","feed"],r=>r&&{...r,pages:r.pages.map(t=>({...t,items:t.items.map(a=>a.id===e.id?e:a)}))})},U=e=>{u.setQueryData(["moddi","feed"],r=>r&&{...r,pages:r.pages.map(t=>({...t,items:t.items.filter(a=>a.id!==e)}))})},F=e=>{e&&u.setQueryData(["moddi","feed"],r=>{var a,d,g;if(!r)return r;const t={...e,user_id:e.user_id??((a=e.author)==null?void 0:a.id)??0,username:e.username??((d=e.author)==null?void 0:d.username)??"Unknown",avatar_url:e.avatar_url??((g=e.author)==null?void 0:g.avatar_url)??null,text:e.text??null,uid:e.uid||String(e.id||""),reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)};return{...r,pages:r.pages.map((c,L)=>L===0?{...c,items:[t,...c.items||[]]}:c)}}),u.invalidateQueries({queryKey:["moddi","feed"]}),i()},M=x&&!l,E=f??!1;return o.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[o.jsx(T,{section:"moddi",onPost:F}),o.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:o.jsxs("div",{className:"col",style:{gap:0},children:[_.length===0&&!M&&o.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),_.map(e=>o.jsx(Q,{post:e,section:"moddi",onUpdate:j,onDelete:U,me:m},e.id)),_.length>0&&E&&o.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:o.jsx("button",{className:"btn secondary",onClick:()=>y(),disabled:l,children:l?"Loading...":"Load more"})})]})})]})}export{z as default};

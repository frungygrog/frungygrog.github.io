import{J as L,g as S,e as T,r as p,j as i}from"./vendor-react-Bj2Cd7tG.js";import{P as U}from"./Post-Cw5v6VST.js";import{C}from"./Compose-BtxUrVu7.js";import{a as N,b as v,A,c as D}from"./index-Sf404DAb.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";function I(){const{data:l}=N(),{tagFilters:u}=v();return L({queryKey:["moddi","feed",u],queryFn:async({pageParam:d=0})=>{const s=new URLSearchParams({limit:"20",offset:String(d)}),n=`${A.moddi.posts}?${s.toString()}`;return await D(n)},enabled:!!l,initialPageParam:0,getNextPageParam:(d,s)=>{var m;const n=s.reduce((f,c)=>{var o;return f+(((o=c.items)==null?void 0:o.length)||0)},0);return(((m=d.items)==null?void 0:m.length)||0)===20?n:void 0}})}function W(){const l=S(),u=T(),{data:d}=N(),{tagFilters:s}=v(),{data:n,fetchNextPage:x,hasNextPage:m,isFetching:f,isFetchingNextPage:c,refetch:o}=I(),y=p.useMemo(()=>n!=null&&n.pages?n.pages.flatMap(t=>(t.items||[]).map(e=>{var a,g,P,b,_;((a=t.items)==null?void 0:a[0])===e&&console.log("Moddi post from API:",e);const r={...e,user_id:e.user_id??((g=e.author)==null?void 0:g.id)??0,username:e.username&&String(e.username).trim()||((P=e.author)==null?void 0:P.username)||"Unknown",avatar_url:e.avatar_url||((b=e.author)==null?void 0:b.avatar_url)||null,uid:e.uid||(e.id?String(e.id):""),text:e.text||"",reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)};return((_=t.items)==null?void 0:_[0])===e&&console.log("Transformed moddi post:",r),r})):[],[n]),h=p.useMemo(()=>y.filter(t=>{const e=t.tags?typeof t.tags=="string"?t.tags.split(",").map(g=>g.trim()):[]:[],r=!t.tags||e.length===0,a=e.includes("help");return s.untagged&&s.help?!0:s.untagged&&!s.help?r:!s.untagged&&s.help?a:!1}),[y,s]);p.useEffect(()=>{l.pathname==="/md/feed"&&o()},[l.pathname,o]),p.useEffect(()=>{const t=()=>{o()};return window.addEventListener("moddifilterchange",t),()=>window.removeEventListener("moddifilterchange",t)},[o]);const j=t=>{u.setQueryData(["moddi","feed"],e=>e&&{...e,pages:e.pages.map(r=>({...r,items:r.items.map(a=>a.id===t.id?t:a)}))})},w=t=>{u.setQueryData(["moddi","feed"],e=>e&&{...e,pages:e.pages.map(r=>({...r,items:r.items.filter(a=>a.id!==t)}))})},M=()=>{o()},F=f&&!c,E=m??!1;return i.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[i.jsx(C,{section:"moddi",onPost:M}),i.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:i.jsxs("div",{className:"col",style:{gap:0},children:[h.length===0&&!F&&i.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),h.map(t=>i.jsx(U,{post:t,section:"moddi",onUpdate:j,onDelete:w,me:d},t.id)),h.length>0&&E&&i.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:i.jsx("button",{className:"btn secondary",onClick:()=>x(),disabled:c,children:c?"Loading...":"Load more"})})]})})]})}export{W as default};

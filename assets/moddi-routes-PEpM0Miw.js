import{s as pt,t as we,v as _e,w as Re,r as i,j as e,x as Ze,l as Ie,d as De,R as le,y as Me,z as gt,e as ht,o as et,u as Ue,q as tt,L as st,B as ft,C as Ae,k as $e,f as xt,D as yt,E as bt,G as Fe,H as Ee,I as He,J as vt,c as ze,K as at,M as jt,N as St,O as Ye,A as wt,h as _t,P as Nt,Q as kt}from"./vendor-react-D9qJr8_Y.js";import{a as N,A as _,g as Ct,u as pe,b as rt,P as nt,C as Tt,c as zt}from"./mappi-routes-DYabPW9h.js";import{i as It,a as Ft,b as Rt,c as Mt}from"./editor-components-ByPZokBD.js";import{B as it}from"./editor-aqH5Q1Dx.js";const Lt=()=>{try{const t=localStorage.getItem("filter_modes")||"standard",r=new Set(t.toLowerCase().split(",").map(a=>a.trim()).filter(Boolean));return{standard:r.has("standard")||r.size===0,taiko:r.has("taiko"),mania:r.has("mania"),catch:r.has("catch")}}catch{return{standard:!0,taiko:!1,mania:!1,catch:!1}}},qt=()=>{try{const t=localStorage.getItem("filter_moddi_tags")||"untagged,help",r=new Set(t.toLowerCase().split(",").map(a=>a.trim()).filter(Boolean));return{untagged:r.has("untagged")||r.size===0,help:r.has("help")||r.size===0}}catch{return{untagged:!0,help:!0}}},Pt=()=>{try{const t=localStorage.getItem("filter_queue_status")||"unchecked,accepted,denied,finished",r=new Set(t.toLowerCase().split(",").map(a=>a.trim()).filter(Boolean));return{unchecked:r.has("unchecked")||r.size===0,accepted:r.has("accepted")||r.size===0,denied:r.has("denied")||r.size===0,finished:r.has("finished")||r.size===0,archived:r.has("archived")}}catch{return{unchecked:!0,accepted:!0,denied:!0,finished:!0,archived:!1}}},Et=()=>{try{const t=localStorage.getItem("last_section");return t==="mappi"||t==="moddi"?t:null}catch{return null}},Be=pt(t=>({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1,modeFilters:Lt(),tagFilters:qt(),queueStatusFilters:Pt(),lastSection:Et(),previousLocation:null,setMenuOpen:r=>t({menuOpen:r}),setMobileNavOpen:r=>t({mobileNavOpen:r}),setNotifOpen:r=>t({notifOpen:r}),closeAllPanels:()=>t({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1}),setModeFilters:r=>{t({modeFilters:r});try{const g=Object.entries(r).filter(([h,f])=>f).map(([h])=>h),d=g.length?g:["standard"];localStorage.setItem("filter_modes",d.join(","))}catch{}},setTagFilters:r=>{t({tagFilters:r});try{const g=Object.entries(r).filter(([h,f])=>f).map(([h])=>h),d=g.length?g:["untagged","help"];localStorage.setItem("filter_moddi_tags",d.join(","))}catch{}},setQueueStatusFilters:r=>{t({queueStatusFilters:r});try{const g=Object.entries(r).filter(([h,f])=>f).map(([h])=>h),d=g.length?g:["unchecked","accepted","denied","finished"];localStorage.setItem("filter_queue_status",d.join(","))}catch{}},setLastSection:r=>{t({lastSection:r});try{r?localStorage.setItem("last_section",r):localStorage.removeItem("last_section")}catch{}},setPreviousLocation:r=>{t({previousLocation:r})}}));function At(t=!0){return we({queryKey:["notifications"],queryFn:async()=>{try{const r=await N(_.user.notifications);return Array.isArray(r.items)?r.items:[]}catch{return[]}},enabled:t,refetchInterval:45*1e3})}function Dt(){return we({queryKey:["notifications","detailed"],queryFn:async()=>{try{const t=await N("/api/me/notifications/detailed");return Array.isArray(t.items)?t.items:[]}catch{return[]}},refetchInterval:30*1e3})}function Zt(){const{data:t=[]}=At();return t.filter(r=>r.kind==="system"&&r.id.startsWith("b:")&&(r.expiresAt||0)<=Date.now()?!1:!r.read).length}function Ut(){const t=_e();return Re({mutationFn:async r=>{await N(_.user.markNotificationsRead,{method:"POST",body:JSON.stringify({ids:r})})},onSuccess:()=>{t.setQueryData(["notifications"],r=>(r==null?void 0:r.map(a=>({...a,read:!0})))||[])}})}function Bt(){const t=_e();return Re({mutationFn:async r=>{const a=Ct();await N(_.user.deleteNotification(r),{method:"DELETE",headers:{"X-CSRF-Token":a}})},onSuccess:(r,a)=>{t.setQueryData(["notifications"],g=>(g==null?void 0:g.filter(d=>d.id!==a))||[])}})}function Le(){return we({queryKey:["user","me"],queryFn:async()=>{try{return await N(_.auth.me)}catch{return null}},staleTime:5*60*1e3})}function es(t=!0){return we({queryKey:["user","quota"],queryFn:async()=>{try{return await N(_.user.quota)}catch{return null}},enabled:t,refetchInterval:30*1e3})}function ts(){const t=_e();return Re({mutationFn:async()=>{await N(_.auth.logout,{method:"POST"})},onSuccess:()=>{t.setQueryData(["user","me"],null),t.clear(),window.location.href="/"}})}const Je={standard:Mt,taiko:Rt,mania:Ft,catch:It},Ke={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Ot=({value:t,onChange:r})=>{const[a,g]=i.useState(!1),d=i.useRef(null);i.useEffect(()=>{if(!a)return;const f=S=>{d.current&&!d.current.contains(S.target)&&g(!1)},k=S=>{S.key==="Escape"&&g(!1)};return document.addEventListener("mousedown",f),document.addEventListener("keydown",k),()=>{document.removeEventListener("mousedown",f),document.removeEventListener("keydown",k)}},[a]);const h=f=>e.jsxs("button",{className:`mode-option${f===t?" selected":""}`,onClick:()=>{r(f),g(!1)},role:"option","aria-selected":f===t,children:[e.jsx("img",{className:"mode-icon",src:Je[f],width:24,height:24,alt:""}),e.jsx("span",{children:Ke[f]})]},f);return e.jsxs("div",{className:"mode-select",ref:d,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":a,onClick:()=>g(f=>!f),children:[e.jsx("img",{className:"mode-icon",src:Je[t],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:Ke[t]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),a&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(h)})]})};function Ge(t){if(!t)return"standard";const r=String(t).toLowerCase().trim();return r==="osu"||r==="0"||r==="standard"?"standard":r==="taiko"||r==="1"?"taiko":r==="catch"||r==="fruits"||r==="2"?"catch":r==="mania"||r==="3"?"mania":"standard"}function ot({section:t,onUpload:r,onPost:a,forceExpanded:g}){const{notify:d}=pe(),h=t==="mappi",[f,k]=i.useState(!1),[S,C]=i.useState(""),[l,j]=i.useState(null),[x,b]=i.useState(null),[P,I]=i.useState(!1),[D,n]=i.useState(""),u=i.useRef(0),[v,q]=i.useState(""),[J,ae]=i.useState("standard"),[z,ee]=i.useState(null),[y,L]=i.useState(0),[G,X]=i.useState(""),[ne,E]=i.useState(""),[ge,he]=i.useState(null),[ce,W]=i.useState(""),[U,B]=i.useState(""),[te,Q]=i.useState(null),[re,o]=i.useState(!1),[w,K]=i.useState(null),V=100*1024*1024,ue=i.useMemo(()=>z?`${z.name}:${z.size}:${z.lastModified}`:null,[z]),[H,$]=i.useState(""),[de,xe]=i.useState(!1),[ie,fe]=i.useState([]),be=i.useRef(null);i.useEffect(()=>{u.current&&window.clearTimeout(u.current);const m=(S||"").trim();if(!m){n(""),j(null),b(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(m)){n(""),j(null),b(null);return}return u.current=window.setTimeout(async()=>{var T;try{let F;try{F=new URL(m)}catch{n("Invalid URL format");return}const se=F.hash.match(/#osu\/(\d+)/),A=se?se[1]:null;F.hash="";const Ce={url:F.toString()};A&&(Ce.beatmap_id=A);const O=await N(_.osu.resolveBeatmap+rt(Ce),{requireAuth:!1}),me=Array.isArray(O==null?void 0:O.diffs)?O.diffs:[];if(!me.length&&!O.setId){n("No difficulties found"),j(null),b(null);return}if(j({setId:Number(O.setId)||0,beatmapId:O.beatmapId??null,title:String(O.title||""),artist:String(O.artist||""),mapper:String(O.mapper||""),diffs:me}),me.length>0){const qe=Number.isFinite(Number(O.beatmapId))?Number(O.beatmapId):Number((T=me[0])==null?void 0:T.id),oe=me.find(Pe=>Number(Pe.id)===qe)||me[0],ye=Ge(oe==null?void 0:oe.mode);b({beatmapId:Number(oe==null?void 0:oe.id)||null,version:String((oe==null?void 0:oe.version)||""),mode:ye}),h&&ae(ye)}else b(null);n("")}catch(F){const se=(F==null?void 0:F.message)||"Unknown error";n(`Failed to resolve: ${se}`),j(null),b(null)}},400),()=>{u.current&&window.clearTimeout(u.current)}},[S,h]);async function Ne(){return E("info"),X("Requesting upload URL..."),await N(_.uploads.new,{method:"POST",body:JSON.stringify({description:v.slice(0,100),beatmap_url:S||void 0,size_bytes:(z==null?void 0:z.size)??void 0,mode:J,beatmapset_id:(l==null?void 0:l.setId)??void 0,beatmap_id:(x==null?void 0:x.beatmapId)??void 0,beatmap_version:(x==null?void 0:x.version)??void 0,beatmap_title:l?`${l.title}`:void 0,beatmap_artist:l?`${l.artist}`:void 0,beatmap_mapper:l?`${l.mapper}`:void 0})})}async function ve(m,R,T="form"){await new Promise((F,se)=>{const A=new XMLHttpRequest;if(A.open("POST",m),A.upload.onprogress=Z=>{Z.lengthComputable&&L(Math.round(Z.loaded/Z.total*100))},A.onload=()=>A.status>=200&&A.status<300?F():se(new Error(`Upload failed (${A.status}) ${A.responseText||""}`)),A.onerror=()=>se(new Error("Network error")),T==="form"){const Z=new FormData;Z.append("file",R,R.name),A.send(Z)}else A.setRequestHeader("Content-Type","application/octet-stream"),A.send(R)})}async function ke(){if(!(!z||!h)){if(z.size>V){W("File exceeds 100MB limit");return}if(typeof te=="number"&&te>60.5){B("Clip exceeds 60s limit");return}ue&&(o(!0),K(ue)),L(0),E("info");try{const m=await Ne();he(m.streamUID);let R=m.streamUID;try{X("Uploading..."),await ve(m.uploadURL,z,"form")}catch(T){E("warn"),X(`Retrying upload... (${(T==null?void 0:T.message)||T})`);const F=await Ne();he(F.streamUID),R=F.streamUID,await ve(F.uploadURL,z,"binary")}E("info"),X("Processing...");for(let T=0;T<60;T++){await new Promise(F=>setTimeout(F,3e3));try{if((await N(_.videos.get(R),{requireAuth:!1})).status==="ready"){E("success"),X("Ready!"),d("Upload complete!",{variant:"success"}),ee(null),q(""),C(""),j(null),b(null),ae("standard"),L(0),he(null),W(""),B(""),Q(null),o(!1),K(null),r&&r();break}}catch{}}}catch(m){E("error"),X(m.message||"Error"),d(m.message||"Upload failed",{variant:"error"})}}}const je=async m=>{if(m.preventDefault(),!h){if(!H.trim()){d("Text is required",{variant:"error"});return}if(H.length>200){d("Text must be 200 characters or less",{variant:"error"});return}xe(!0);try{const R=await N(_.moddi.posts,{method:"POST",body:JSON.stringify({text:H.trim(),beatmap_url:S.trim()||void 0,beatmapset_id:(l==null?void 0:l.setId)??void 0,beatmap_id:(x==null?void 0:x.beatmapId)??(l==null?void 0:l.beatmapId)??void 0,beatmap_version:(x==null?void 0:x.version)??void 0,tags:ie.length>0?ie.join(","):void 0})});if(R){console.log("Post created response:",R);const T=R==null?void 0:R.post;T?(!T.uid&&T.id&&(console.warn("Created post missing uid, using id as fallback:",T),T.uid=String(T.id)),a&&a(T)):a&&a(),d("Post created!",{variant:"success"}),$(""),C(""),j(null),b(null),n(""),I(!1),fe([])}}catch{d("Failed to create post",{variant:"error"})}finally{xe(!1)}}},Se=!!g||f;return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:h?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:g?"default":"pointer",padding:"8px 12px",minHeight:36},onClick:()=>{g||k(!f)},children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:h?"Upload a clip":"Create a post!"}),Se?e.jsx(Ze,{size:16}):e.jsx(Ie,{size:16})]}),Se&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Ot,{value:J,onChange:ae})]}),l?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[l.artist," – ",l.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",l.mapper]})]}),l.diffs.length>0&&e.jsx("select",{value:(x==null?void 0:x.beatmapId)??l.beatmapId??void 0,onChange:m=>{const R=Number(m.target.value),T=(l==null?void 0:l.diffs.find(F=>Number(F.id)===R))||null;if(T){const F=Ge(T.mode);b({beatmapId:R,version:T.version,mode:F}),ae(F)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:l.diffs.map(m=>e.jsxs("option",{value:m.id,children:[m.version," (",m.mode,")"]},m.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>I(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{j(null),b(null),C("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:S,onChange:m=>C(m.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:v,onChange:m=>q(m.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),D&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:D}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:m=>{var F;const R=((F=m.target.files)==null?void 0:F[0])||null;if(ee(R),Q(null),R&&R.size>V?W("File exceeds 100MB limit"):W(""),R)try{const se=URL.createObjectURL(R),A=document.createElement("video");A.preload="metadata",A.src=se,A.onloadedmetadata=()=>{URL.revokeObjectURL(se);const Z=Number.isFinite(A.duration)?A.duration:NaN;Number.isFinite(Z)&&Q(Z),Number.isFinite(Z)&&Z>60.5?B("Clip exceeds 60s limit"):B("")},A.onerror=()=>{URL.revokeObjectURL(se),Q(null)}}catch{Q(null)}else B("");const T=R?`${R.name}:${R.size}:${R.lastModified}`:null;T&&T!==w&&o(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:ke,disabled:!z||!!ce||!!U||re,style:{flexShrink:0},children:"Upload"})]}),ce&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:ce}),U&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:U}),z&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",z.name," • ",(z.size/1024/1024).toFixed(1)," MB",re&&w===ue?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(y>0||G)&&e.jsxs("div",{className:"upload-status",children:[G&&e.jsx("div",{className:`chip ${ne||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:G}),y>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":y,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,y))}%`}})})]}),ge&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",ge]})]})]}):e.jsx("form",{onSubmit:je,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:be,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:H,onChange:m=>$(m.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),l?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[l.artist," – ",l.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",l.mapper]})]}),l.diffs.length>0&&e.jsx("select",{value:(x==null?void 0:x.beatmapId)??l.beatmapId??void 0,onChange:m=>{const R=Number(m.target.value),T=(l==null?void 0:l.diffs.find(F=>Number(F.id)===R))||null;T&&b({beatmapId:R,version:T.version,mode:String(T.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:l.diffs.map(m=>e.jsxs("option",{value:m.id,children:[m.version," (",m.mode,")"]},m.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:S,onChange:m=>C(m.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),D&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:D}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{ie.includes("help")?fe(ie.filter(m=>m!=="help")):fe([...ie,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:ie.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:ie.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:ie.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>I(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{j(null),b(null),C("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:de||!H.trim()||H.length>200,children:de?"Posting...":"Post"})]})]})})}),P&&l&&e.jsx(it,{open:P,onClose:()=>I(!1),downloadUrl:_.osu.downloadBeatmapset(l.setId),beatmapId:(x==null?void 0:x.beatmapId)??l.beatmapId??void 0,beatmapVersion:x==null?void 0:x.version})]})}function Oe({open:t,onClose:r,children:a}){const g=i.useRef(null),d=i.useRef(null),h=i.useRef(!1),f=l=>{var j;d.current=((j=l.touches[0])==null?void 0:j.clientY)??null,h.current=!1},k=l=>{var P,I;if(d.current==null)return;const j=((P=l.touches[0])==null?void 0:P.clientY)??null;if(j==null)return;const x=j-d.current;(((I=g.current)==null?void 0:I.scrollTop)??0)<=0&&x>60?h.current=!0:h.current=!1},S=()=>{h.current&&r(),d.current=null,h.current=!1};if(!t)return null;const C=e.jsx("div",{className:"mobile-upload-overlay",onClick:r,children:e.jsx("div",{ref:g,className:"mobile-upload-sheet",onClick:l=>l.stopPropagation(),onTouchStart:f,onTouchMove:k,onTouchEnd:S,children:a})});return De.createPortal(C,document.body)}function Wt({section:t,onUpload:r,onPost:a}){const[g,d]=le.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":t==="mappi"?"Upload clip":"New post",title:t==="mappi"?"Upload clip":"New post",onClick:()=>d(!0),children:e.jsx(Me,{size:22})}),e.jsx(Oe,{open:g,onClose:()=>d(!1),children:e.jsx("div",{style:{paddingTop:6},children:e.jsx(ot,{section:t,forceExpanded:!0,onUpload:()=>{r==null||r(),d(!1)},onPost:h=>{a==null||a(h),d(!1)}})})})]})}function Qt(){const{data:t}=Le(),{tagFilters:r}=Be();return gt({queryKey:["moddi","feed",r],queryFn:async({pageParam:a=0})=>{const g=new URLSearchParams({limit:"20",offset:String(a)}),d=`${_.moddi.posts}?${g.toString()}`;return await N(d)},enabled:!!t,initialPageParam:0,getNextPageParam:(a,g)=>{var f;const d=g.reduce((k,S)=>{var C;return k+(((C=S.items)==null?void 0:C.length)||0)},0);return(((f=a.items)==null?void 0:f.length)||0)===20?d:void 0}})}function ss(){const t=ht(),r=_e(),{data:a}=Le(),{tagFilters:g}=Be(),{data:d,fetchNextPage:h,hasNextPage:f,isFetching:k,isFetchingNextPage:S,refetch:C}=Qt(),l=i.useMemo(()=>d!=null&&d.pages?d.pages.flatMap(n=>(n.items||[]).map(v=>({...v,user_id:v.user_id??0,username:v.username||"Unknown",avatar_url:v.avatar_url||null,text:v.text??null,uid:v.uid||String(v.id||""),reactions_count:Number(v.reactions_count??0),reacted_by_me:v.reacted_by_me??!1,comments_count:Number(v.comments_count??0)}))):[],[d]),j=i.useMemo(()=>l.filter(n=>{const u=n.tags?typeof n.tags=="string"?n.tags.split(",").map(J=>J.trim()):[]:[],v=!n.tags||u.length===0,q=u.includes("help");return g.untagged&&g.help?!0:g.untagged&&!g.help?v:!g.untagged&&g.help?q:!1}),[l,g]);i.useEffect(()=>{t.pathname==="/md/feed"&&C()},[t.pathname,C]),i.useEffect(()=>{const n=()=>{C()};return window.addEventListener("moddifilterchange",n),()=>window.removeEventListener("moddifilterchange",n)},[C]);const x=n=>{r.setQueryData(["moddi","feed"],u=>u&&{...u,pages:u.pages.map(v=>({...v,items:v.items.map(q=>q.id===n.id?n:q)}))})},b=n=>{r.setQueryData(["moddi","feed"],u=>u&&{...u,pages:u.pages.map(v=>({...v,items:v.items.filter(q=>q.id!==n)}))})},P=n=>{n&&r.setQueryData(["moddi","feed"],u=>{if(!u)return u;const v={...n,user_id:n.user_id??0,username:n.username||"Unknown",avatar_url:n.avatar_url||null,text:n.text??null,uid:n.uid||String(n.id||""),reactions_count:Number(n.reactions_count??0),reacted_by_me:n.reacted_by_me??!1,comments_count:Number(n.comments_count??0)};return{...u,pages:u.pages.map((q,J)=>J===0?{...q,items:[v,...q.items||[]]}:q)}}),r.invalidateQueries({queryKey:["moddi","feed"]}),C()},I=k&&!S,D=f??!1;return e.jsxs("div",{className:"feed-container moddi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"feed-header",children:[e.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),e.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),e.jsx(ot,{section:"moddi",onPost:P})]}),e.jsx(Wt,{section:"moddi",onPost:P}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:0},children:[j.length===0&&!I&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),j.map(n=>e.jsx(nt,{post:n,section:"moddi",onUpdate:x,onDelete:b,me:a},n.id)),j.length>0&&D&&e.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("button",{className:"btn secondary",onClick:()=>h(),disabled:S,children:S?"Loading...":"Load more"})})]})})]})}function as(){const{uid:t}=et(),r=Ue(),[a,g]=i.useState(null),[d,h]=i.useState([]),[f,k]=i.useState(!0),[S,C]=i.useState(null),[l,j]=i.useState(""),[x,b]=i.useState(null),[P,I]=i.useState(!1),{notify:D}=pe();i.useEffect(()=>{N(_.auth.me,{requireAuth:!1}).then(y=>C(y)).catch(()=>{})},[]);const n=async()=>{if(!t||t==="null"||t==="undefined"){D("Invalid post identifier",{variant:"error"}),r("/md/feed");return}k(!0);try{const y=await N(_.moddi.post(t),{requireAuth:!1}),L={...y,user_id:y.user_id??0,username:y.username||"Unknown",avatar_url:y.avatar_url||null,uid:y.uid||String(y.id)||t,text:y.text??null,beatmap_url:y.beatmap_url??null,beatmapset_id:y.beatmapset_id??null,beatmap_id:y.beatmap_id??null,beatmap_version:y.beatmap_version??null,tags:y.tags??null,reactions_count:Number(y.reactions_count??0),reacted_by_me:y.reacted_by_me??!1,comments_count:Number(y.comments_count??0)};g(L)}catch{D("Failed to load post",{variant:"error"}),r("/md/feed")}finally{k(!1)}},u=async()=>{if(a!=null&&a.id)try{const y=await N(_.moddi.postComments(a.id),{requireAuth:!1});h(y.items||[])}catch{}};i.useEffect(()=>{n()},[t]),i.useEffect(()=>{a!=null&&a.id&&u()},[a==null?void 0:a.id]);const v=y=>{g(y)},q=()=>{r("/md/feed")},J=async y=>{if(y.preventDefault(),!(!l.trim()||!(a!=null&&a.id))){I(!0);try{await N(_.moddi.postComments(a.id),{method:"POST",body:JSON.stringify({text:l.trim(),parent_id:x||void 0})}),j(""),b(null),u(),n(),D("Comment posted!",{variant:"success"})}catch(L){D((L==null?void 0:L.message)||"Failed to post comment",{variant:"error"})}finally{I(!1)}}},ae=y=>{h(L=>L.filter(G=>G.id!==y))};if(f)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!a)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const z=d.filter(y=>!y.parent_id),ee=new Map;return d.filter(y=>y.parent_id).forEach(y=>{const L=y.parent_id;ee.has(L)||ee.set(L,[]),ee.get(L).push(y)}),e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>r("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(tt,{size:20})}),e.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(nt,{post:a,section:"moddi",onUpdate:v,onDelete:q,me:S})}),S&&!x&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:J,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:l,onChange:y=>j(y.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:y=>{const L=y.target;L.style.height="auto",L.style.height=`${Math.min(L.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:P||!l.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:P?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:z.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:z.map(y=>e.jsx(Tt,{comment:y,replies:ee.get(y.id)||[],me:S,section:"moddi",onReply:L=>b(L),onDelete:ae,replyingTo:x,replyText:l,onReplyTextChange:j,onReplySubmit:J,posting:P,onCancelReply:()=>{b(null),j("")},repliesMap:ee},y.id))})})]})}function $t({queue:t}){return e.jsx(st,{to:`/md/queues/${t.id}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",cursor:"pointer"},onMouseEnter:r=>r.currentTarget.style.background="rgba(255,255,255,0.02)",onMouseLeave:r=>r.currentTarget.style.background="rgba(255,255,255,0.01)",children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,marginBottom:8},children:[t.is_group?e.jsx(ft,{size:18}):e.jsx(Ae,{size:18}),e.jsx("strong",{style:{fontSize:16},children:t.name}),t.is_member&&e.jsx("span",{className:"chip",style:{fontSize:11,padding:"2px 8px"},children:"Member"})]}),t.description&&e.jsx("div",{className:"muted",style:{fontSize:14,marginBottom:8},children:t.description}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,fontSize:12},children:[t.owner_avatar_url&&e.jsx("img",{src:t.owner_avatar_url,width:20,height:20,style:{borderRadius:"50%"}}),e.jsxs("span",{className:"muted",children:["by ",t.owner_username,t.member_count!==void 0&&Number(t.member_count)>0&&(Number(t.member_count)===1&&t.first_member_username?` and ${t.first_member_username}`:` & ${t.member_count} others`)]}),e.jsx("span",{className:"muted",children:"•"}),e.jsx("span",{className:"muted",children:new Date(t.created_at*1e3).toLocaleDateString()})]})]})})}function We(){return we({queryKey:["moddi","queues"],queryFn:async()=>{const t=await N(_.moddi.queues);return Array.isArray(t.items)?t.items:[]}})}function lt(){const t=_e();return Re({mutationFn:async r=>{var a;return await N(_.moddi.queues,{method:"POST",body:JSON.stringify({name:r.name.trim(),description:((a=r.description)==null?void 0:a.trim())||null,is_group:r.is_group??!1})})},onSuccess:()=>{t.invalidateQueries({queryKey:["moddi","queues"]})}})}function Ht(){const[t,r]=le.useState(!1),[a,g]=le.useState(""),[d,h]=le.useState(""),{data:f=[]}=We(),{data:k}=Le(),{notify:S}=pe(),C=lt(),l=le.useMemo(()=>k?f.some(x=>x.owner_id===k.id):!1,[k,f]),j=x=>{if(x&&x.preventDefault(),l){S("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!a.trim()){S("Queue name is required",{variant:"error"});return}C.mutate({name:a.trim(),description:d.trim()||null,is_group:!1},{onSuccess:()=>{S("Queue created!",{variant:"success"}),r(!1),g(""),h("")},onError:b=>{S((b==null?void 0:b.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Create queue",title:"Create queue",onClick:()=>r(!0),children:e.jsx(Me,{size:22})}),e.jsx(Oe,{open:t,onClose:()=>r(!1),children:e.jsxs("form",{onSubmit:j,className:"col",style:{gap:12},children:[l?e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:a,onChange:x=>g(x.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:d,onChange:x=>h(x.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>r(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:C.isPending||l,children:C.isPending?"Creating...":"Create"})]})]})})]})}function rs(){const{data:t=[],isLoading:r}=We(),{data:a}=Le(),g=lt(),{notify:d}=pe(),[h,f]=i.useState(!1),[k,S]=i.useState(""),[C,l]=i.useState(""),j=i.useMemo(()=>a?t.some(b=>b.owner_id===a.id):!1,[a,t]),x=async b=>{if(b.preventDefault(),j){d("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!k.trim()){d("Queue name is required",{variant:"error"});return}g.mutate({name:k.trim(),description:C.trim()||null,is_group:!1},{onSuccess:()=>{d("Queue created!",{variant:"success"}),f(!1),S(""),l("")},onError:P=>{d((P==null?void 0:P.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs("div",{className:"feed-container queues-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx(Ht,{}),e.jsx("div",{className:"feed-header",children:e.jsx("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:0},children:j?e.jsx("div",{style:{padding:"12px"},children:e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>f(!h),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:"Create a queue!"}),h?e.jsx(Ze,{size:16}):e.jsx(Ie,{size:16})]}),h&&e.jsx("form",{onSubmit:x,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:k,onChange:b=>S(b.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:C,onChange:b=>l(b.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:b=>{b.stopPropagation(),f(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:g.isPending||j,onClick:b=>b.stopPropagation(),children:g.isPending?"Creating...":"Create"})]})]})})]})})}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("div",{className:"col",style:{gap:0},children:r?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No queues yet. Create one to get started!"}):t.map(b=>e.jsx($t,{queue:b},b.id))})})]})}function Yt({beatmapMeta:t,beatmapVersion:r}){const a=i.useRef(null),g=i.useRef(null),[d,h]=i.useState(!1),[f,k]=i.useState(!1),[S,C]=i.useState(0);i.useEffect(()=>{if(a.current&&g.current){const x=a.current.offsetWidth,b=g.current.scrollWidth;C(b),k(b>x)}},[t,r]);const l=t?e.jsxs(e.Fragment,{children:[t.artist," – ",t.title,t.mapper?` (by ${t.mapper})`:"",r?` [${r}]`:""]}):r?`[${r}]`:"Beatmap",j=S>0?Math.max(3,S/50):3;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),e.jsxs("div",{ref:a,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:f?"pointer":"default"},onMouseEnter:()=>f&&h(!0),onMouseLeave:()=>h(!1),children:[e.jsx("span",{ref:g,style:{display:"inline-block",animation:d&&f?`beatmap-marquee ${j}s linear infinite`:"none"},children:l}),d&&f&&e.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:l})]})]})}function Xe({submission:t,canManage:r,onUpdate:a,onDelete:g,isGroup:d=!1}){const[h,f]=i.useState(!1),[k,S]=i.useState(!1),[C,l]=i.useState(null),[j,x]=i.useState(t.beatmapset_id),[b,P]=i.useState(t.beatmap_id),[I,D]=i.useState(!1),[n,u]=i.useState(!1),[v,q]=i.useState(null),[J,ae]=i.useState(!1),[z,ee]=i.useState(t.acknowledgments||[]),[y,L]=i.useState(t.acknowledged_by_me||!1),G=i.useRef(null),X=i.useRef(null),ne=i.useRef(null),{notify:E}=pe();i.useEffect(()=>{ee(t.acknowledgments||[]),L(t.acknowledged_by_me||!1)},[t.acknowledgments,t.acknowledged_by_me]),i.useEffect(()=>{if(t.beatmap_url)try{const o=new URL(t.beatmap_url),w=o.pathname.match(/\/beatmapsets\/(\d+)/);if(w&&!t.beatmapset_id){const V=Number(w[1]);isNaN(V)||x(V)}const K=o.hash.match(/#osu\/(\d+)/);if(K&&!t.beatmap_id){const V=Number(K[1]);isNaN(V)||P(V)}}catch(o){console.error("[QueueSubmission] Error parsing beatmap URL:",t.beatmap_url,o)}},[t.beatmap_url,t.beatmapset_id,t.beatmap_id,t.id]),i.useEffect(()=>{console.log("[QueueSubmission] Submission data:",{id:t.id,beatmap_url:t.beatmap_url,beatmapset_id:t.beatmapset_id,beatmap_id:t.beatmap_id,extracted_beatmapset_id:j,extracted_beatmap_id:b,beatmap_version:t.beatmap_version})},[t.id,j,b]),i.useEffect(()=>{if(!t.beatmap_url||C&&j)return;let o=!1;return(async()=>{try{console.log("[QueueSubmission] Fetching beatmap metadata...",{beatmap_url:t.beatmap_url,existing_beatmapset_id:t.beatmapset_id,existing_beatmap_id:t.beatmap_id});let w;try{w=new URL(t.beatmap_url)}catch($){console.error("[QueueSubmission] Invalid beatmap URL:",t.beatmap_url,$);return}const K=w.hash.match(/#osu\/(\d+)/),V=K?K[1]:null;w.hash="";const H={url:w.toString()};if(V?H.beatmap_id=V:t.beatmap_id&&(H.beatmap_id=String(t.beatmap_id)),console.log("[QueueSubmission] Resolving beatmap with params:",H),!o){const $=await N(_.osu.resolveBeatmap+rt(H),{requireAuth:!1});console.log("[QueueSubmission] Beatmap resolve response:",$),$.setId&&!j&&(console.log("[QueueSubmission] Setting beatmapset_id from API:",$.setId),x(Number($.setId))),($.title||$.artist)&&l({title:$.title||null,artist:$.artist||null,mapper:$.mapper||null})}}catch(w){console.error("[QueueSubmission] Error fetching beatmap metadata:",w)}})(),()=>{o=!0}},[t.beatmap_url,t.beatmap_id,t.beatmapset_id,C,j]),i.useEffect(()=>{if(!I||!ne.current){q(null);return}const o=()=>{if(ne.current){const w=ne.current.getBoundingClientRect();q({top:w.bottom+8,right:window.innerWidth-w.right})}};return o(),window.addEventListener("resize",o),window.addEventListener("scroll",o,!0),()=>{window.removeEventListener("resize",o),window.removeEventListener("scroll",o,!0)}},[I]),i.useEffect(()=>{if(!k)return;const o=w=>{const K=w.target;G.current&&!G.current.contains(K)&&!K.closest("[data-status-dropdown]")&&S(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[k]),i.useEffect(()=>{if(!I)return;const o=w=>{X.current&&!X.current.contains(w.target)&&ne.current&&!ne.current.contains(w.target)&&D(!1)};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[I]);const ge=async o=>{if(!h){f(!0);try{await N(_.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({status:o})});const w={...t,status:o,updated_at:Math.floor(Date.now()/1e3)};a&&a(w),E("Status updated",{variant:"success"})}catch{E("Failed to update status",{variant:"error"})}finally{f(!1),S(!1)}}},he=async()=>{if(!h){f(!0);try{const o=!!t.is_archived;await N(_.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({is_archived:!o})});const w={...t,is_archived:o?0:1,updated_at:Math.floor(Date.now()/1e3)};a&&a(w),E(o?"Unarchived":"Archived",{variant:"success"})}catch{E("Failed to update archive status",{variant:"error"})}finally{f(!1)}}},ce=async()=>{if(confirm("Are you sure you want to delete this submission? This action cannot be undone.")&&!h){f(!0);try{await N(_.moddi.queueSubmissionDelete(String(t.queue_id),t.id),{method:"DELETE"}),E("Submission deleted",{variant:"success"}),g&&g(t.id)}catch{E("Failed to delete submission",{variant:"error"})}finally{f(!1)}}},W=async()=>{if(!J){ae(!0);try{if(y){if(await N(_.moddi.queueSubmissionUnacknowledge(String(t.queue_id),t.id),{method:"DELETE"}),L(!1),E("Unacknowledged",{variant:"info"}),a){const o={...t,acknowledged_by_me:!1};a(o)}}else if(await N(_.moddi.queueSubmissionAcknowledge(String(t.queue_id),t.id),{method:"POST"}),L(!0),E("Acknowledged",{variant:"success"}),a){const o={...t,acknowledged_by_me:!0};a(o)}}catch{E("Failed to update acknowledgment",{variant:"error"})}finally{ae(!1)}}},U={unchecked:"#f59e0b",accepted:"#10b981",denied:"#ef4444",finished:"#6366f1"},B={unchecked:"Pending",accepted:"Accepted",denied:"Denied",finished:"Finished"},te=j||t.beatmapset_id,Q=te?`https://assets.ppy.sh/beatmaps/${te}/covers/card.jpg`:null;i.useEffect(()=>{Q?console.log("[QueueSubmission] Background image URL:",Q,"for beatmapset_id:",te):console.log("[QueueSubmission] No background image URL - beatmapset_id:",te,"submission.beatmapset_id:",t.beatmapset_id)},[Q,te,t.beatmapset_id]);const re=!!t.is_archived;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"relative",borderRadius:12,overflow:"hidden",borderBottom:"1px solid rgba(255,255,255,0.06)",background:Q?"transparent":"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",opacity:re?.6:1},onMouseEnter:o=>{Q||(o.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)")},onMouseLeave:o=>{Q||(o.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)")},children:[Q&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:Q,alt:"",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover",opacity:.35,zIndex:0,pointerEvents:"none"},onError:o=>{o.currentTarget.style.display="none"}}),e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.75) 100%)",zIndex:0}})]}),e.jsx("div",{style:{position:"relative",zIndex:1,padding:"16px"},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",justifyContent:"space-between",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[t.beatmap_url&&e.jsx("div",{style:{marginBottom:8},children:e.jsx(Yt,{beatmapMeta:C,beatmapVersion:t.beatmap_version})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,marginTop:8},children:[t.avatar_url&&e.jsx("img",{src:t.avatar_url,width:24,height:24,style:{borderRadius:"50%"},alt:t.username}),e.jsx("span",{style:{fontSize:13},children:t.username}),e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(t.created_at*1e3).toLocaleDateString()})]}),t.message&&e.jsx("div",{style:{marginTop:8,fontSize:13,lineHeight:1.5,color:"var(--text)"},children:t.message}),t.beatmap_url&&e.jsx("div",{style:{marginTop:12,display:"flex",alignItems:"center",gap:8},children:e.jsxs("button",{ref:ne,className:"chip-btn link",onClick:o=>{o.preventDefault(),o.stopPropagation(),D(w=>!w)},title:"Beatmap options","aria-label":"Beatmap options",style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 12px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:6,color:"var(--text)",fontSize:13,cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:o=>{o.currentTarget.style.background="rgba(255,255,255,0.1)",o.currentTarget.style.borderColor="rgba(255,255,255,0.2)"},onMouseLeave:o=>{o.currentTarget.style.background="rgba(255,255,255,0.05)",o.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[e.jsx($e,{size:14}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),e.jsx(Ie,{size:12,style:{marginLeft:4,opacity:.7}})]})})]}),r?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[z&&z.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[z.slice(0,5).map((o,w)=>o.avatar_url?e.jsx("img",{src:o.avatar_url,alt:o.username,title:o.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",cursor:"pointer"}},o.user_id):e.jsx("div",{title:o.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:o.username.charAt(0).toUpperCase()},o.user_id)),z.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${z.length-5} more`,children:["+",z.length-5]})]}),e.jsx("button",{className:"icon-link",onClick:W,disabled:J||h,title:y?"Unacknowledge":"Acknowledge",style:{color:y?"#10b981":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:y?"rgba(16, 185, 129, 0.1)":"transparent"},onMouseEnter:o=>{!J&&!h&&(o.currentTarget.style.background=y?"rgba(16, 185, 129, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:o=>{o.currentTarget.style.background=y?"rgba(16, 185, 129, 0.1)":"transparent"},children:e.jsx(xt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:he,disabled:h,title:re?"Unarchive":"Archive",style:{color:re?"#6366f1":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:re?"rgba(99, 102, 241, 0.1)":"transparent"},onMouseEnter:o=>{h||(o.currentTarget.style.background=re?"rgba(99, 102, 241, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:o=>{o.currentTarget.style.background=re?"rgba(99, 102, 241, 0.1)":"transparent"},children:re?e.jsx(yt,{size:16}):e.jsx(bt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:ce,disabled:h,title:"Delete submission",style:{color:"var(--danger)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:"transparent"},onMouseEnter:o=>{h||(o.currentTarget.style.background="rgba(239, 68, 68, 0.1)")},onMouseLeave:o=>{o.currentTarget.style.background="transparent"},children:e.jsx(Fe,{size:16})}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("button",{ref:G,onClick:()=>S(!k),disabled:h,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:U[t.status]+"15",border:`1.5px solid ${U[t.status]}50`,color:U[t.status],whiteSpace:"nowrap",cursor:h?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:h?.6:1},onMouseEnter:o=>{h||(o.currentTarget.style.background=U[t.status]+"25",o.currentTarget.style.borderColor=U[t.status]+"70",o.currentTarget.style.transform="translateY(-1px)")},onMouseLeave:o=>{o.currentTarget.style.background=U[t.status]+"15",o.currentTarget.style.borderColor=U[t.status]+"50",o.currentTarget.style.transform="translateY(0)"},children:[e.jsx("span",{children:B[t.status]}),e.jsx(Ie,{size:14,style:{marginLeft:2,transition:"transform 0.2s ease",transform:k?"rotate(180deg)":"rotate(0deg)"}})]}),k&&G.current&&De.createPortal(e.jsx("div",{"data-status-dropdown":!0,style:{position:"fixed",background:"var(--panel)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:6,zIndex:1e4,minWidth:140,boxShadow:"0 8px 24px rgba(0,0,0,0.4)",...(()=>{const o=G.current.getBoundingClientRect();return{top:o.bottom+6,right:window.innerWidth-o.right}})()},onClick:o=>o.stopPropagation(),children:["unchecked","accepted","denied","finished"].map(o=>e.jsx("button",{onClick:()=>ge(o),style:{display:"block",width:"100%",padding:"8px 12px",borderRadius:6,fontSize:13,fontWeight:o===t.status?600:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",textAlign:"left",background:o===t.status?U[o]+"15":"transparent",color:o===t.status?U[o]:"var(--text)",border:"none",cursor:"pointer",transition:"all 0.15s ease",marginBottom:2},onMouseEnter:w=>{o!==t.status&&(w.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:w=>{o!==t.status&&(w.currentTarget.style.background="transparent")},children:B[o]},o))}),document.body)]})]}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[z&&z.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[z.slice(0,5).map((o,w)=>o.avatar_url?e.jsx("img",{src:o.avatar_url,alt:o.username,title:o.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",cursor:"pointer"}},o.user_id):e.jsx("div",{title:o.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:o.username.charAt(0).toUpperCase()},o.user_id)),z.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${z.length-5} more`,children:["+",z.length-5]})]}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:U[t.status]+"15",border:`1.5px solid ${U[t.status]}50`,color:U[t.status],whiteSpace:"nowrap"},children:B[t.status]})]})]})})]}),I&&v&&t.beatmap_url&&e.jsxs("div",{ref:X,style:{position:"fixed",top:v.top,right:v.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>D(!1),children:[e.jsx($e,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),te&&e.jsx("button",{className:"menu-item",onClick:()=>{u(!0),D(!1)},children:"Preview"})]}),n&&te&&e.jsx(it,{open:n,onClose:()=>u(!1),downloadUrl:`${zt}${_.osu.downloadBeatmapset(te)}`,beatmapId:b??t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0})]})}function Jt({queueId:t,onSubmitted:r}){const[a,g]=le.useState(!1),[d,h]=le.useState(t),[f,k]=le.useState(""),[S,C]=le.useState(""),[l,j]=le.useState(!1),{notify:x}=pe(),{data:b=[]}=We();le.useEffect(()=>{h(t)},[t]);const P=async()=>{if(!d){x("Please select a queue",{variant:"error"});return}if(!f.trim()){x("Beatmap URL is required",{variant:"error"});return}j(!0);try{await N(_.moddi.queueSubmit(d),{method:"POST",body:JSON.stringify({beatmap_url:f.trim(),message:S.trim()||null})}),x("Submission created!",{variant:"success"}),k(""),C(""),g(!1),r==null||r()}catch(I){x((I==null?void 0:I.message)||"Failed to create submission",{variant:"error"})}finally{j(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Submit to queue",title:"Submit to queue",onClick:()=>g(!0),children:e.jsx(Me,{size:22})}),e.jsx(Oe,{open:a,onClose:()=>g(!1),children:e.jsxs("div",{className:"col",style:{gap:12},children:[!t&&e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Queue:"}),e.jsxs("select",{value:d??"",onChange:I=>h(I.target.value||void 0),style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",fontSize:13},children:[e.jsx("option",{value:"",disabled:!0,children:"Select queue"}),b.map(I=>e.jsx("option",{value:String(I.id),children:I.name},I.id))]})]}),e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:f,onChange:I=>k(I.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:S,onChange:I=>C(I.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),S.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[S.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>g(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"btn",disabled:l,onClick:P,children:l?"Submitting...":"Submit"})]})]})})]})}const Ve=({content:t})=>e.jsx("div",{style:{fontSize:13,lineHeight:1.6,color:"var(--text)"},children:e.jsx(St,{components:{p:({children:r})=>e.jsx("p",{style:{margin:"0 0 8px 0"},children:r}),ul:({children:r})=>e.jsx("ul",{style:{margin:"0 0 8px 0",paddingLeft:20},children:r}),ol:({children:r})=>e.jsx("ol",{style:{margin:"0 0 8px 0",paddingLeft:20},children:r}),li:({children:r})=>e.jsx("li",{style:{margin:"0 0 4px 0"},children:r}),strong:({children:r})=>e.jsx("strong",{style:{fontWeight:600},children:r}),em:({children:r})=>e.jsx("em",{children:r}),code:({children:r})=>e.jsx("code",{style:{background:"rgba(255,255,255,0.1)",padding:"2px 4px",borderRadius:4,fontSize:12},children:r}),h1:({children:r})=>e.jsx("h1",{style:{fontSize:18,fontWeight:700,margin:"0 0 8px 0"},children:r}),h2:({children:r})=>e.jsx("h2",{style:{fontSize:16,fontWeight:700,margin:"0 0 8px 0"},children:r}),h3:({children:r})=>e.jsx("h3",{style:{fontSize:14,fontWeight:600,margin:"0 0 8px 0"},children:r})},children:t})});function ns(){const{id:t}=et(),r=Ue(),[a,g]=i.useState(null),[d,h]=i.useState([]),[f,k]=i.useState([]),[S,C]=i.useState(!0),[l,j]=i.useState(null),[x,b]=i.useState(!1),[P,I]=i.useState(!1),[D,n]=i.useState(""),[u,v]=i.useState(""),[q,J]=i.useState(null),[ae,z]=i.useState(!1),[ee,y]=i.useState(""),[L,G]=i.useState(""),[X,ne]=i.useState(""),[E,ge]=i.useState(!1),[he,ce]=i.useState(!1),[W,U]=i.useState("general"),[B,te]=i.useState(!1),[Q,re]=i.useState(!1),[o,w]=i.useState(null),[K,V]=i.useState(""),[ue,H]=i.useState([]),[$,de]=i.useState(!1),xe=i.useRef(null),ie=i.useRef(null),fe=i.useRef(null),[be,Ne]=i.useState([]),[ve,ke]=i.useState(!1),[je,Se]=i.useState(null),{notify:m}=pe(),{queueStatusFilters:R}=Be(),T=async()=>{var s,p;if(t){C(!0);try{const c=await N(_.moddi.queue(t),{requireAuth:!1});g(c.queue||null),h(c.members||[]),k(c.submissions||[])}catch(c){(s=c==null?void 0:c.message)!=null&&s.includes("403")||(p=c==null?void 0:c.message)!=null&&p.includes("Forbidden")?(m("You do not have access to this queue",{variant:"error"}),r("/md/queues")):m("Failed to load queue",{variant:"error"})}finally{C(!1)}}};i.useEffect(()=>{T(),N(_.auth.me,{requireAuth:!1}).then(s=>j(s)).catch(()=>{})},[t]);const F=l&&a&&(a.owner_id===l.id||d.some(s=>s.user_id===l.id&&s.joined_at));l&&d.some(s=>s.user_id===l.id&&s.joined_at);const se=l&&a&&(a.owner_id===l.id||d.some(s=>s.user_id===l.id&&s.joined_at)),A=async s=>{if(s.preventDefault(),!a||a.is_open===0){m("Queue is closed for submissions",{variant:"error"});return}if(!D.trim()){m("Beatmap URL is required",{variant:"error"});return}I(!0);try{await N(_.moddi.queueSubmit(t),{method:"POST",body:JSON.stringify({beatmap_url:D.trim(),message:u.trim()||null})}),m("Submission created!",{variant:"success"}),b(!1),n(""),v(""),T()}catch(p){m((p==null?void 0:p.message)||"Failed to create submission",{variant:"error"})}finally{I(!1)}},Z=s=>{k(p=>p.map(c=>c.id===s.id?s:c)),s.acknowledged_by_me!==void 0&&T()},Ce=()=>{a&&(y(a.name),G(a.description||""),ne(a.rules||""),z(!0),U("general"))},O=()=>{z(!1),y(""),G(""),ne("")},me=async()=>{if(!(!a||!se)){ce(!0);try{const s=a.is_open!==1;await N(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_open:s})}),m(`Queue ${s?"opened":"closed"}`,{variant:"success"}),T()}catch(s){m((s==null?void 0:s.message)||"Failed to update status",{variant:"error"})}finally{ce(!1)}}},qe=async s=>{if(s.preventDefault(),!a||!ee.trim()){m("Queue name is required",{variant:"error"});return}te(!0);try{const p=d.filter(c=>c.user_id!==a.owner_id&&c.role!=="owner").length>0;await N(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({name:ee.trim(),description:L.trim()||null,rules:X.trim()||null,is_group:p})}),m("Queue updated!",{variant:"success"}),O(),T()}catch(p){m((p==null?void 0:p.message)||"Failed to update queue",{variant:"error"})}finally{te(!1)}};i.useEffect(()=>{if(!K.trim()){H([]),de(!1);return}const s=setTimeout(async()=>{try{const c=(await N(_.moddi.usersSearch(K),{requireAuth:!1})).items||[];H(c),de(c.length>0)}catch(p){console.error("Search failed:",p),H([]),de(!1)}},300);return()=>clearTimeout(s)},[K]);const oe=async s=>{if(!Q){re(!0);try{await N(_.moddi.queueInvite(t),{method:"POST",body:JSON.stringify({user_id:s})}),m("Invite sent!",{variant:"success"}),V(""),H([]),de(!1),T()}catch(p){m((p==null?void 0:p.message)||"Failed to invite member",{variant:"error"})}finally{re(!1)}}},ye=async()=>{if(!(!t||!F))try{const s=await N(_.moddi.queueBlockedUsers(t));Ne(s.blocked||[])}catch(s){console.error("Failed to load blocked users:",s)}},Pe=async s=>{if(!(!t||ve)&&confirm("Block this user from submitting to this queue?")){ke(!0);try{await N(_.moddi.queueBlockUser(t),{method:"POST",body:JSON.stringify({user_id:s})}),m("User blocked",{variant:"success"}),ye(),V(""),H([]),de(!1)}catch(p){m((p==null?void 0:p.message)||"Failed to block user",{variant:"error"})}finally{ke(!1)}}},Qe=async s=>{if(!(!t||je===s)){Se(s);try{await N(_.moddi.queueUnblockUser(t,s),{method:"DELETE"}),m("User unblocked",{variant:"success"}),ye()}catch(p){m((p==null?void 0:p.message)||"Failed to unblock user",{variant:"error"})}finally{Se(null)}}};i.useEffect(()=>{W==="members"&&F&&t&&ye()},[W,F,t]);const dt=async()=>{if(a&&confirm(`Are you sure you want to delete "${a.name}"? This action cannot be undone.`)){ge(!0);try{await N(_.moddi.queue(t),{method:"DELETE"}),m("Queue deleted",{variant:"success"}),r("/md/queues")}catch(s){m((s==null?void 0:s.message)||"Failed to delete queue",{variant:"error"})}finally{ge(!1)}}},ct=async s=>{if(!l||!a||l.id!==a.owner_id){m("Only the queue owner can remove members",{variant:"error"});return}if(confirm("Remove this member from the queue?")){w(s);try{await N(_.moddi.queueMember(t,s),{method:"DELETE"}),m("Member removed",{variant:"success"});const c=d.filter(M=>M.user_id!==s).some(M=>M.user_id!==(a==null?void 0:a.owner_id)&&M.role!=="owner");if(a&&a.is_group===1&&!c)try{await N(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after removing last member")}T()}catch(p){m((p==null?void 0:p.message)||"Failed to remove member",{variant:"error"})}finally{w(null)}}},ut=async()=>{if(l&&confirm("Leave this queue? You will need to be invited again to rejoin.")){w(l.id);try{await N(_.moddi.queueMember(t,l.id),{method:"DELETE"}),m("Left queue",{variant:"success"});const p=d.filter(c=>c.user_id!==l.id).some(c=>c.user_id!==(a==null?void 0:a.owner_id)&&c.role!=="owner");if(a&&a.is_group===1&&!p)try{await N(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after leaving")}r("/md/queues")}catch(s){m((s==null?void 0:s.message)||"Failed to leave queue",{variant:"error"})}finally{w(null)}}},mt=async s=>{if(confirm("Cancel this invitation?")){w(s);try{await N(_.moddi.queueMember(t,s),{method:"DELETE"}),m("Invitation canceled",{variant:"success"}),T()}catch(p){m((p==null?void 0:p.message)||"Failed to cancel invitation",{variant:"error"})}finally{w(null)}}};return i.useEffect(()=>{if(!ae)return;const s=p=>{const c=p.target;c.closest(".manage-overlay")||c.closest(".manage-overlay-backdrop")||!c.closest(".manage-popup")&&fe.current&&!fe.current.contains(c)&&O()};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[ae]),i.useEffect(()=>{if(!$)return;const s=p=>{const c=p.target;xe.current&&!xe.current.contains(c)&&ie.current&&!ie.current.contains(c)&&de(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[$]),S?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):a?e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t&&e.jsx(Jt,{queueId:t,onSubmitted:()=>T()}),e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:12,marginBottom:16,paddingTop:16},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flex:1,minWidth:0},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>r("/md/queues"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(tt,{size:20})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:10,flex:1,minWidth:0},children:[e.jsx("div",{className:"title",style:{flex:1,minWidth:0},children:a.name}),se&&e.jsxs("button",{onClick:me,disabled:he,className:`queue-status-badge ${a.is_open===1?"status-open":"status-closed"}`,title:a.is_open===1?"Close queue":"Open queue","aria-label":a.is_open===1?"Close queue":"Open queue",children:[a.is_open===1?e.jsx(Ee,{size:14}):e.jsx(He,{size:14}),e.jsx("span",{children:a.is_open===1?"Open":"Closed"})]})]})]}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[F&&e.jsx("button",{ref:fe,className:"icon-link",onClick:Ce,style:{width:"auto",height:"auto",padding:"4px"},title:"Manage Queue","aria-label":"Manage Queue",children:e.jsx(vt,{size:18})}),d.length>0&&e.jsx("div",{style:{display:"flex",alignItems:"center",gap:6},children:d.filter(s=>s.joined_at!==null).sort((s,p)=>{const c=s.role==="owner"||s.user_id===(a==null?void 0:a.owner_id),M=p.role==="owner"||p.user_id===(a==null?void 0:a.owner_id);return c&&!M?-1:!c&&M?1:(p.joined_at||0)-(s.joined_at||0)}).map(s=>e.jsxs("div",{style:{position:"relative"},onMouseEnter:()=>J(s.user_id),onMouseLeave:()=>J(null),children:[e.jsx(st,{to:`/profile/${s.user_id}`,className:"queue-member-avatar",title:s.username,children:s.avatar_url?e.jsx("img",{src:s.avatar_url,alt:s.username}):e.jsx("div",{style:{width:"100%",height:"100%",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,color:"var(--muted)"},children:s.username.charAt(0).toUpperCase()})}),q===s.user_id&&e.jsxs("div",{className:"queue-member-tooltip",children:[s.username," ",s.role!=="member"?`(${s.role})`:""]})]},s.user_id))})]})]}),a.description&&e.jsx("div",{className:"muted",style:{marginBottom:16,fontSize:14,padding:"0 4px"},children:a.description}),a.rules&&e.jsxs("div",{style:{marginBottom:16,padding:12,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10},children:[e.jsx("div",{style:{fontSize:14,fontWeight:600,marginBottom:8},children:"Rules"}),e.jsx(Ve,{content:a.rules})]}),a.is_open===0&&e.jsx("div",{style:{marginBottom:12,padding:10,background:"rgba(245, 158, 11, 0.1)",border:"1px solid rgba(245, 158, 11, 0.3)",borderRadius:10,textAlign:"center",fontSize:14,color:"#f59e0b"},children:"This queue is currently closed for submissions"}),e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:12,opacity:a.is_open===0?.6:1},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:a.is_open===1?"pointer":"not-allowed",padding:"8px 12px",minHeight:36},onClick:()=>a.is_open===1&&b(!x),children:[e.jsxs("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:["Submit a beatmap ",a.is_open===0&&"(Closed)"]}),a.is_open===1&&(x?e.jsx(ze,{size:16}):e.jsx(Me,{size:16}))]}),x&&e.jsx("form",{onSubmit:A,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:D,onChange:s=>n(s.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:u,onChange:s=>v(s.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),u.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[u.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:s=>{s.stopPropagation(),b(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:P,onClick:s=>s.stopPropagation(),children:P?"Submitting...":"Submit"})]})]})})]}),e.jsxs("div",{className:"profile-tabs-unified",style:{marginTop:24},children:[e.jsxs("div",{className:"profile-tabs-header",role:"tablist","aria-label":"Submission sections",children:[e.jsx("button",{role:"tab","aria-selected":!0,className:"profile-tab active","data-tab":"active",onClick:s=>{const p=s.currentTarget.closest(".profile-tabs-unified");p.querySelectorAll(".profile-tab").forEach(M=>{M.classList.remove("active"),M.setAttribute("aria-selected","false")}),s.currentTarget.classList.add("active"),s.currentTarget.setAttribute("aria-selected","true"),p.querySelector(".profile-tabs-content").setAttribute("data-active","active")},children:"Active"}),e.jsx("button",{role:"tab","aria-selected":!1,className:"profile-tab","data-tab":"archived",onClick:s=>{const p=s.currentTarget.closest(".profile-tabs-unified");p.querySelectorAll(".profile-tab").forEach(M=>{M.classList.remove("active"),M.setAttribute("aria-selected","false")}),s.currentTarget.classList.add("active"),s.currentTarget.setAttribute("aria-selected","true"),p.querySelector(".profile-tabs-content").setAttribute("data-active","archived")},children:"Archived"})]}),e.jsxs("div",{className:"profile-tabs-content","data-active":"active",children:[e.jsx("div",{className:"panel active",children:e.jsx("div",{className:"col",style:{gap:0},children:f.filter(s=>!!!s.is_archived&&R[s.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No active submissions."}):f.filter(s=>!!!s.is_archived&&R[s.status]).map(s=>e.jsx(Xe,{submission:s,canManage:!!F,isGroup:(a==null?void 0:a.is_group)===1,onUpdate:Z,onDelete:p=>{k(c=>c.filter(M=>M.id!==p))}},s.id))})}),e.jsx("div",{className:"panel archived",children:e.jsx("div",{className:"col",style:{gap:0},children:f.filter(s=>!!s.is_archived&&R[s.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No archived submissions."}):f.filter(s=>!!s.is_archived&&R[s.status]).map(s=>e.jsx(Xe,{submission:s,canManage:!!F,isGroup:(a==null?void 0:a.is_group)===1,onUpdate:Z,onDelete:p=>{k(c=>c.filter(M=>M.id!==p))}},s.id))})})]})]}),ae&&De.createPortal(e.jsxs("div",{className:"overlay manage-overlay",children:[e.jsx("div",{className:"overlay-backdrop manage-overlay-backdrop",onClick:O}),e.jsxs("div",{className:"overlay-card",style:{maxWidth:500},children:[e.jsx("button",{className:"overlay-close",onClick:O,"aria-label":"Close",children:e.jsx(ze,{size:18})}),e.jsxs("div",{className:"col",style:{gap:0,padding:"0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:16,padding:"20px 16px 12px",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("div",{className:"title",style:{fontSize:20,margin:0,padding:0,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Manage Queue"}),e.jsxs("div",{className:"tabs",role:"tablist",style:{margin:0},children:[e.jsx("button",{role:"tab","aria-selected":W==="general",className:`tab ${W==="general"?"active":""}`,onClick:()=>U("general"),children:"General"}),e.jsx("button",{role:"tab","aria-selected":W==="rules",className:`tab ${W==="rules"?"active":""}`,onClick:()=>U("rules"),children:"Rules"}),e.jsx("button",{role:"tab","aria-selected":W==="members",className:`tab ${W==="members"?"active":""}`,onClick:()=>U("members"),children:"Members"})]})]}),e.jsx("hr",{className:"subtle-divider",style:{margin:"0 16px"}}),e.jsxs("form",{onSubmit:qe,className:"col",style:{gap:0,padding:"16px"},children:[W==="general"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Queue Name"}),e.jsx("input",{type:"text",value:ee,onChange:s=>y(s.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}})]}),e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Description (optional)"}),e.jsx("textarea",{placeholder:"Description",value:L,onChange:s=>G(s.target.value),rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"space-between",alignItems:"center",marginTop:8},children:[e.jsxs("button",{type:"button",className:"btn secondary",onClick:dt,disabled:E||B,style:{background:"rgba(248, 113, 113, 0.1)",borderColor:"rgba(248, 113, 113, 0.3)",color:"var(--danger)",fontSize:13,padding:"8px 12px"},children:[e.jsx(Fe,{size:14,style:{marginRight:6}}),E?"Deleting...":"Delete Queue"]}),e.jsxs("div",{className:"row",style:{gap:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:O,disabled:B||E,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:B||E,style:{fontSize:13,padding:"8px 16px"},children:B?"Updating...":"Save Changes"})]})]})]}),W==="rules"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Rules (optional, markdown supported)"}),e.jsx("textarea",{placeholder:"Rules in markdown format...",value:X,onChange:s=>ne(s.target.value),rows:8,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:13,resize:"vertical"}}),X&&e.jsxs("div",{style:{padding:10,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,fontSize:12},children:[e.jsx("div",{style:{fontSize:12,fontWeight:600,marginBottom:6,opacity:.8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Preview:"}),e.jsx(Ve,{content:X})]})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:O,disabled:B||E,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:B||E,style:{fontSize:13,padding:"8px 16px"},children:B?"Updating...":"Save Changes"})]})]}),W==="members"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6,position:"relative"},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invite Members"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{ref:xe,type:"text",placeholder:"Search username or ID",value:K,onChange:s=>V(s.target.value),onKeyDown:s=>{s.key==="Enter"&&s.preventDefault()},onFocus:()=>{ue.length>0&&de(!0)},style:{width:"100%",background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),$&&ue.length>0&&e.jsx("div",{ref:ie,style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,maxHeight:300,overflowY:"auto",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},children:e.jsx("div",{className:"col",style:{gap:0},children:ue.map(s=>{const p=d.some(Y=>Y.user_id===s.id&&Y.joined_at),c=d.some(Y=>Y.user_id===s.id&&Y.invited_at&&!Y.joined_at),M=be.some(Y=>Y.user_id===s.id);return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"8px 12px"},children:[e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:8,minWidth:0},children:[s.avatar_url&&e.jsx("img",{src:s.avatar_url,width:20,height:20,style:{borderRadius:"50%",flexShrink:0}}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontSize:13,fontWeight:500,display:"flex",alignItems:"center",gap:8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("span",{children:s.username}),p&&e.jsx("span",{style:{color:"var(--muted)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Already a member"}),c&&e.jsx("span",{style:{color:"var(--accent)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]}),e.jsxs("div",{className:"muted",style:{fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["id ",s.id," • osu ",s.osu_user_id]})]})]}),F&&!p&&!c&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{className:"icon-link",onClick:Y=>{Y.stopPropagation(),Q||oe(s.id)},disabled:Q,title:"Invite user",style:{width:"auto",height:"auto",padding:"4px"},children:e.jsx(at,{size:16})}),e.jsx("button",{className:"icon-link",onClick:Y=>{Y.stopPropagation(),M?Qe(s.id):Pe(s.id)},disabled:ve||je===s.id,title:M?"Unblock user":"Block user",style:{width:"auto",height:"auto",padding:"4px",color:M?"var(--accent)":"var(--danger)"},children:M?e.jsx(Ee,{size:16}):e.jsx(He,{size:16})})]})]},s.id)})})})]})]}),d.length>0&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Members"}),e.jsx("div",{className:"col",style:{gap:4},children:(()=>{const s=d.filter(c=>c.joined_at!==null).sort((c,M)=>{const Y=c.role==="owner"||c.user_id===(a==null?void 0:a.owner_id),Te=M.role==="owner"||M.user_id===(a==null?void 0:a.owner_id);return Y&&!Te?-1:!Y&&Te?1:(M.joined_at||0)-(c.joined_at||0)}),p=d.filter(c=>c.invited_at!==null&&c.joined_at===null);return e.jsxs(e.Fragment,{children:[s.map(c=>{const M=l&&a&&l.id===a.owner_id,Y=c.user_id===(l==null?void 0:l.id),Te=c.user_id===(a==null?void 0:a.owner_id)||c.role==="owner";return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[c.avatar_url&&e.jsx("img",{src:c.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:c.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:c.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:c.role})]})]}),M&&!Te&&e.jsx("button",{className:"icon-link",onClick:()=>ct(c.user_id),disabled:o===c.user_id,title:"Remove member",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(Fe,{size:16})}),!M&&Y&&e.jsx("button",{className:"icon-link",onClick:ut,disabled:o===c.user_id,title:"Leave queue",style:{width:"auto",height:"auto",padding:"4px",color:"var(--muted)"},children:e.jsx(jt,{size:16})})]},c.user_id)}),p.length>0&&e.jsx(e.Fragment,{children:p.map(c=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",opacity:.7},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[c.avatar_url&&e.jsx("img",{src:c.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:c.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:c.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>mt(c.user_id),disabled:o===c.user_id,title:"Cancel invitation",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(ze,{size:16})})]},c.user_id))})]})})()})]}),F&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Blocked Users"}),be.length===0?e.jsx("div",{className:"muted",style:{fontSize:12,padding:"8px 0",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"No blocked users"}):e.jsx("div",{className:"col",style:{gap:4},children:be.map(s=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[s.avatar_url&&e.jsx("img",{src:s.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:s.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:s.username}),s.blocked_by_username&&e.jsxs("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["Blocked by ",s.blocked_by_username]})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>Qe(s.user_id),disabled:je===s.user_id,title:"Unblock user",style:{width:"auto",height:"auto",padding:"4px",color:"var(--accent)"},children:e.jsx(Ee,{size:16})})]},s.user_id))})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:O,disabled:B||E,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:B||E,style:{fontSize:13,padding:"8px 16px"},children:B?"Updating...":"Save Changes"})]})]})]})]})]})]}),document.body),e.jsx("style",{children:`
        .queue-member-avatar {
          width: 32px;
          height: 32px;
          border-radius: 9999px;
          padding: 0;
          border: 1px solid rgba(255,255,255,0.08);
          overflow: hidden;
          cursor: pointer;
          background: transparent;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: border-color 0.2s;
        }
        .queue-member-avatar:hover {
          border-color: rgba(167, 139, 250, 0.4);
        }
        .queue-member-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }
        .queue-member-tooltip {
          position: absolute;
          bottom: calc(100% + 8px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(18, 20, 24, 0.95);
          color: var(--text, #e5e7eb);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 6px;
          padding: 6px 10px;
          font-size: 14px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          pointer-events: none;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
        }
        .queue-member-tooltip::after {
          content: '';
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-top: 5px solid rgba(18, 20, 24, 0.95);
        }
        .queue-status-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
          border: 1px solid;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        }
        .queue-status-badge:disabled {
          cursor: not-allowed;
          opacity: 0.6;
        }
        .queue-status-badge.status-open {
          background: rgba(52, 211, 153, 0.15);
          border-color: rgba(52, 211, 153, 0.4);
          color: #34d399;
        }
        .queue-status-badge.status-open:hover:not(:disabled) {
          background: rgba(52, 211, 153, 0.25);
          border-color: rgba(52, 211, 153, 0.5);
        }
        .queue-status-badge.status-closed {
          background: rgba(245, 158, 11, 0.15);
          border-color: rgba(245, 158, 11, 0.4);
          color: #f59e0b;
        }
        .queue-status-badge.status-closed:hover:not(:disabled) {
          background: rgba(245, 158, 11, 0.25);
          border-color: rgba(245, 158, 11, 0.5);
        }
      `})]}):e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Queue not found"})}function is(){const{data:t=[],isLoading:r}=Dt(),a=Ut(),g=Bt(),{notify:d}=pe(),h=Ue(),[f,k]=i.useState(new Set),S=async n=>{a.mutate(n,{onSuccess:()=>{}})},C=async n=>{n.startsWith("n:")&&g.mutate(n)},l=async()=>{const n=t.filter(u=>!u.read&&(u.id.startsWith("n:")||u.kind==="system"&&!u.id.startsWith("b:"))).map(u=>u.id);n.length>0&&(await S(n),d("All notifications marked as read",{variant:"success"}))},j=n=>{if(!n)return null;try{const u=JSON.parse(n);if((u==null?void 0:u.type)==="queue_invite"&&(u!=null&&u.queue_id))return u}catch{}return null},x=async(n,u)=>{if(!f.has(n.id)){k(v=>new Set(v).add(n.id));try{await N(_.moddi.queueAccept(String(u)),{method:"POST"}),d("Invitation accepted!",{variant:"success"}),C(n.id),h(`/md/queues/${u}`)}catch(v){d((v==null?void 0:v.message)||"Failed to accept invitation",{variant:"error"})}finally{k(v=>{const q=new Set(v);return q.delete(n.id),q})}}},b=async(n,u)=>{if(!f.has(n.id)){k(v=>new Set(v).add(n.id));try{await N(_.moddi.queueDeny(String(u)),{method:"POST"}),d("Invitation declined",{variant:"success"}),C(n.id)}catch(v){d((v==null?void 0:v.message)||"Failed to decline invitation",{variant:"error"})}finally{k(v=>{const q=new Set(v);return q.delete(n.id),q})}}},P=n=>j(n.text)?e.jsx(at,{size:20,color:"#a78bfa"}):n.kind==="star"?e.jsx(wt,{size:20,color:"#f59e0b"}):n.kind==="likes5"?e.jsx(_t,{size:20,color:"#f472b6"}):n.kind==="comment"?e.jsx(Ae,{size:20,color:"#60a5fa"}):n.kind==="inspiration"?e.jsx(Ae,{size:20,color:"#7dd3fc"}):n.kind==="reaction"?e.jsx(Nt,{size:20,color:"#10b981"}):n.id.startsWith("b:")?e.jsx(kt,{size:20,color:"#a78bfa"}):null,I=n=>j(n.text)?"Queue Invitation":n.kind==="star"?"Star":n.kind==="likes5"?"Likes":n.kind==="comment"?"Comment":n.kind==="inspiration"?"Inspiration":n.kind==="reaction"?"Reaction":n.id.startsWith("b:")?"Global":"System",D=t.filter(n=>!n.read&&!(n.id.startsWith("b:")&&n.expiresAt&&n.expiresAt<=Date.now())).length;return e.jsxs("div",{className:"moddi-notifications-page col",style:{width:"100%",maxWidth:700,margin:"0 auto"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[e.jsx("div",{className:"title",children:"Notifications"}),D>0&&e.jsxs("button",{className:"btn secondary",onClick:l,children:[e.jsx(Ye,{size:16,style:{marginRight:6}}),"Mark all read"]})]}),r?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"No notifications yet."}):e.jsx("div",{className:"col",style:{gap:8},children:t.filter(n=>!(n.id.startsWith("b:")&&n.expiresAt&&n.expiresAt<=Date.now())).map(n=>e.jsx("div",{style:{background:n.read?"var(--panel-dark)":"var(--panel)",border:`1px solid ${n.read?"rgba(255,255,255,0.08)":"rgba(125, 211, 252, 0.3)"}`,borderRadius:12,padding:16,cursor:n.videoId?"pointer":"default",opacity:n.read?.7:1},onClick:()=>{!n.read&&n.id.startsWith("n:")&&S([n.id]),n.videoId&&(window.location.hash="/mp/feed")},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12},children:[e.jsx("div",{style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",borderRadius:"50%"},children:P(n)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[e.jsx("strong",{style:{fontSize:14},children:I(n)}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(n.createdAt).toLocaleDateString()}),n.id.startsWith("n:")&&e.jsx("button",{className:"icon-link",onClick:u=>{u.stopPropagation(),C(n.id)},style:{padding:4},children:e.jsx(Fe,{size:14})})]})]}),e.jsx("div",{style:{fontSize:14,wordBreak:"break-word"},children:(()=>{const u=j(n.text);return u?`${u.inviter_username} invited you to join queue: ${u.queue_name}`:n.text||(n.kind==="star"?"One of your posts was starred!":n.kind==="likes5"?"One of your posts reached 5 likes!":n.kind==="comment"?"Someone commented on your post":n.kind==="inspiration"?"Someone is inspired by you!":n.kind==="reaction"?"Someone raised their hand on your post!":"")})()}),(()=>{const u=j(n.text);return u&&!f.has(n.id)?e.jsxs("div",{className:"row",style:{gap:8,marginTop:12},children:[e.jsxs("button",{className:"btn",onClick:v=>{v.stopPropagation(),x(n,u.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Ye,{size:14,style:{marginRight:4}}),"Accept"]}),e.jsxs("button",{className:"btn secondary",onClick:v=>{v.stopPropagation(),b(n,u.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(ze,{size:14,style:{marginRight:4}}),"Decline"]})]}):u&&f.has(n.id)?e.jsx("div",{className:"muted",style:{fontSize:12,marginTop:8},children:"Processing..."}):null})(),n.read&&n.readAt&&e.jsxs("div",{className:"muted",style:{fontSize:11,marginTop:4},children:["Read ",new Date(n.readAt).toLocaleString()]})]})]})},n.id))})]})}export{ot as C,Wt as M,is as N,as as P,rs as Q,Zt as a,Le as b,es as c,At as d,ts as e,Ut as f,Bt as g,ss as h,ns as i,Be as u};

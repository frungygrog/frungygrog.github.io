import{r,j as e,T as Se,w as Ne}from"./vendor-react-_vsaDC62.js";import{c as ke,b as Ce,a as Ie,i as ze}from"./editor-components-CKFEosPJ.js";import{B as Ue}from"./editor-lib-Cf56EpaA.js";import{u as Le}from"./index-ByI_yUEs.js";const fe={standard:ze,taiko:Ie,mania:Ce,catch:ke},he={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Te=({value:b,onChange:c})=>{const[p,g]=r.useState(!1),v=r.useRef(null);r.useEffect(()=>{if(!p)return;const m=j=>{v.current&&!v.current.contains(j.target)&&g(!1)},S=j=>{j.key==="Escape"&&g(!1)};return document.addEventListener("mousedown",m),document.addEventListener("keydown",S),()=>{document.removeEventListener("mousedown",m),document.removeEventListener("keydown",S)}},[p]);const L=m=>e.jsxs("button",{className:`mode-option${m===b?" selected":""}`,onClick:()=>{c(m),g(!1)},role:"option","aria-selected":m===b,children:[e.jsx("img",{className:"mode-icon",src:fe[m],width:24,height:24,alt:""}),e.jsx("span",{children:he[m]})]},m);return e.jsxs("div",{className:"mode-select",ref:v,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":p,onClick:()=>g(m=>!m),children:[e.jsx("img",{className:"mode-icon",src:fe[b],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:he[b]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),p&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(L)})]})},M="https://api.osumappi.ng";function ge(b){if(!b)return"standard";const c=String(b).toLowerCase().trim();return c==="osu"||c==="0"||c==="standard"?"standard":c==="taiko"||c==="1"?"taiko":c==="catch"||c==="fruits"||c==="2"?"catch":c==="mania"||c==="3"?"mania":"standard"}function xe(b){var c;return(c=document.cookie.split("; ").map(p=>p.split("=")).find(([p])=>p===b))==null?void 0:c[1]}function Me({section:b,onUpload:c,onPost:p}){const{notify:g}=Le(),v=b==="mappi",[L,m]=r.useState(!1),[S,j]=r.useState(""),[a,w]=r.useState(null),[l,f]=r.useState(null),[G,O]=r.useState(!1),[B,N]=r.useState(""),T=r.useRef(0),[Y,Q]=r.useState(""),[Z,D]=r.useState("standard"),[u,ee]=r.useState(null),[P,H]=r.useState(0),[W,C]=r.useState(""),[be,I]=r.useState(""),[te,K]=r.useState(null),[A,_]=r.useState(""),[q,R]=r.useState(""),[ae,$]=r.useState(null),[se,X]=r.useState(!1),[ne,ie]=r.useState(null),re=100*1024*1024,J=r.useMemo(()=>u?`${u.name}:${u.size}:${u.lastModified}`:null,[u]),[z,oe]=r.useState(""),[le,de]=r.useState(!1),[k,V]=r.useState([]),ve=r.useRef(null);r.useEffect(()=>{T.current&&window.clearTimeout(T.current);const t=(S||"").trim();if(!t){N(""),w(null),f(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(t)){N(""),w(null),f(null);return}return T.current=window.setTimeout(async()=>{var i;try{let s;try{s=new URL(t)}catch{N("Invalid URL format");return}const o=s.hash.match(/#osu\/(\d+)/),d=o?o[1]:null;s.hash="";const h=s.toString(),pe=new URLSearchParams({url:h});d&&pe.set("beatmap_id",d);const E=await fetch(`${M}/api/osu/beatmap/resolve?${pe.toString()}`,{credentials:"include"});if(!E.ok){const F=await E.json().catch(()=>({})),y=String((F==null?void 0:F.error)||`HTTP ${E.status}: ${E.statusText}`);N(y),w(null),f(null);return}const x=await E.json(),U=Array.isArray(x==null?void 0:x.diffs)?x.diffs:[];if(!U.length&&!x.setId){N("No difficulties found"),w(null),f(null);return}if(w({setId:Number(x.setId)||0,beatmapId:x.beatmapId??null,title:String(x.title||""),artist:String(x.artist||""),mapper:String(x.mapper||""),diffs:U}),U.length>0){const F=Number.isFinite(Number(x.beatmapId))?Number(x.beatmapId):Number((i=U[0])==null?void 0:i.id),y=U.find(we=>Number(we.id)===F)||U[0],me=ge(y==null?void 0:y.mode);f({beatmapId:Number(y==null?void 0:y.id)||null,version:String((y==null?void 0:y.version)||""),mode:me}),v&&D(me)}else f(null);N("")}catch(s){N(`Failed to resolve: ${(s==null?void 0:s.message)||"Unknown error"}`),w(null),f(null)}},400),()=>{T.current&&window.clearTimeout(T.current)}},[S,v]);async function ce(){I("info"),C("Requesting upload URL...");const t=xe("csrf"),n=await fetch(`${M}/api/uploads/new`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":t||"","Content-Type":"application/json"},body:JSON.stringify({description:Y.slice(0,100),beatmap_url:S||void 0,size_bytes:(u==null?void 0:u.size)??void 0,mode:Z,beatmapset_id:(a==null?void 0:a.setId)??void 0,beatmap_id:(l==null?void 0:l.beatmapId)??void 0,beatmap_version:(l==null?void 0:l.version)??void 0,beatmap_title:a?`${a.title}`:void 0,beatmap_artist:a?`${a.artist}`:void 0,beatmap_mapper:a?`${a.mapper}`:void 0})});if(!n.ok){let s="Failed to create upload";try{const o=await n.json();s=(o==null?void 0:o.error)||(o==null?void 0:o.message)||s}catch{try{s=await n.text()}catch{}}throw new Error(s)}return await n.json()}async function ue(t,n,i="form"){await new Promise((s,o)=>{const d=new XMLHttpRequest;if(d.open("POST",t),d.upload.onprogress=h=>{h.lengthComputable&&H(Math.round(h.loaded/h.total*100))},d.onload=()=>d.status>=200&&d.status<300?s():o(new Error(`Upload failed (${d.status}) ${d.responseText||""}`)),d.onerror=()=>o(new Error("Network error")),i==="form"){const h=new FormData;h.append("file",n,n.name),d.send(h)}else d.setRequestHeader("Content-Type","application/octet-stream"),d.send(n)})}async function ye(){if(!(!u||!v)){if(u.size>re){_("File exceeds 100MB limit");return}if(typeof ae=="number"&&ae>60.5){R("Clip exceeds 60s limit");return}J&&(X(!0),ie(J)),H(0),I("info");try{const t=await ce();K(t.streamUID);let n=t.streamUID;try{C("Uploading..."),await ue(t.uploadURL,u,"form")}catch(i){I("warn"),C(`Retrying upload... (${(i==null?void 0:i.message)||i})`);const s=await ce();K(s.streamUID),n=s.streamUID,await ue(s.uploadURL,u,"binary")}I("info"),C("Processing...");for(let i=0;i<60;i++){await new Promise(o=>setTimeout(o,3e3));const s=await fetch(`${M}/api/videos/${n}`,{credentials:"include"});if(s.ok&&(await s.json()).status==="ready"){I("success"),C("Ready!"),g("Upload complete!",{variant:"success"}),ee(null),Q(""),j(""),w(null),f(null),D("standard"),H(0),K(null),_(""),R(""),$(null),X(!1),ie(null),c&&c();break}}}catch(t){I("error"),C(t.message||"Error"),g(t.message||"Upload failed",{variant:"error"})}}}const je=async t=>{if(t.preventDefault(),!v){if(!z.trim()){g("Text is required",{variant:"error"});return}if(z.length>200){g("Text must be 200 characters or less",{variant:"error"});return}de(!0);try{const n=xe("csrf")||"",i=await fetch(`${M}/api/moddiposts`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":n},body:JSON.stringify({text:z.trim(),beatmap_url:S.trim()||void 0,beatmapset_id:(a==null?void 0:a.setId)??void 0,beatmap_id:(l==null?void 0:l.beatmapId)??(a==null?void 0:a.beatmapId)??void 0,beatmap_version:(l==null?void 0:l.version)??void 0,tags:k.length>0?k.join(","):void 0})});if(i.ok){const s=await i.json().catch(()=>({}));console.log("Post created response:",s);const o=s==null?void 0:s.post;o?(!o.uid&&o.id&&(console.warn("Created post missing uid, using id as fallback:",o),o.uid=String(o.id)),p&&p(o)):p&&p(),g("Post created!",{variant:"success"}),oe(""),j(""),w(null),f(null),N(""),O(!1),V([])}else{const s=await i.json().catch(()=>({}));g(s.error||"Failed to create post",{variant:"error"})}}catch{g("Failed to create post",{variant:"error"})}finally{de(!1)}}};return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:v?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>m(!L),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:v?"Upload a clip":"Create a post!"}),L?e.jsx(Se,{size:16}):e.jsx(Ne,{size:16})]}),L&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Te,{value:Z,onChange:D})]}),a?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[a.artist," – ",a.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",a.mapper]})]}),a.diffs.length>0&&e.jsx("select",{value:(l==null?void 0:l.beatmapId)??a.beatmapId??void 0,onChange:t=>{const n=Number(t.target.value),i=(a==null?void 0:a.diffs.find(s=>Number(s.id)===n))||null;if(i){const s=ge(i.mode);f({beatmapId:n,version:i.version,mode:s}),D(s)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:a.diffs.map(t=>e.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>O(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{w(null),f(null),j("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:S,onChange:t=>j(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:Y,onChange:t=>Q(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),B&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:B}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:t=>{var s;const n=((s=t.target.files)==null?void 0:s[0])||null;if(ee(n),$(null),n&&n.size>re?_("File exceeds 100MB limit"):_(""),n)try{const o=URL.createObjectURL(n),d=document.createElement("video");d.preload="metadata",d.src=o,d.onloadedmetadata=()=>{URL.revokeObjectURL(o);const h=Number.isFinite(d.duration)?d.duration:NaN;Number.isFinite(h)&&$(h),Number.isFinite(h)&&h>60.5?R("Clip exceeds 60s limit"):R("")},d.onerror=()=>{URL.revokeObjectURL(o),$(null)}}catch{$(null)}else R("");const i=n?`${n.name}:${n.size}:${n.lastModified}`:null;i&&i!==ne&&X(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:ye,disabled:!u||!!A||!!q||se,style:{flexShrink:0},children:"Upload"})]}),A&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:A}),q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:q}),u&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",u.name," • ",(u.size/1024/1024).toFixed(1)," MB",se&&ne===J?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(P>0||W)&&e.jsxs("div",{className:"upload-status",children:[W&&e.jsx("div",{className:`chip ${be||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:W}),P>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":P,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,P))}%`}})})]}),te&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",te]})]})]}):e.jsx("form",{onSubmit:je,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:ve,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:z,onChange:t=>oe(t.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),a?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[a.artist," – ",a.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",a.mapper]})]}),a.diffs.length>0&&e.jsx("select",{value:(l==null?void 0:l.beatmapId)??a.beatmapId??void 0,onChange:t=>{const n=Number(t.target.value),i=(a==null?void 0:a.diffs.find(s=>Number(s.id)===n))||null;i&&f({beatmapId:n,version:i.version,mode:String(i.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:a.diffs.map(t=>e.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:S,onChange:t=>j(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),B&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:B}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{k.includes("help")?V(k.filter(t=>t!=="help")):V([...k,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:k.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:k.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:k.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[a&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>O(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{w(null),f(null),j("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:le||!z.trim()||z.length>200,children:le?"Posting...":"Post"})]})]})})}),G&&a&&e.jsx(Ue,{open:G,onClose:()=>O(!1),downloadUrl:`${M}/api/osu/beatmapsets/${a.setId}/download?noVideo=1`,beatmapId:(l==null?void 0:l.beatmapId)??a.beatmapId??void 0,beatmapVersion:l==null?void 0:l.version})]})}export{Me as C};

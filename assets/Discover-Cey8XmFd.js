import{r as o,R as Y,i as Me,j as n,L as ke,p as De,D as Fe,E as Pe,G as Ue,I as Se,J as Ae,K as Ee,A as Oe}from"./vendor-react-Dd0bvrP_.js";import{P as Be}from"./Player-D15hAWtj.js";import{P as He}from"./beatmap-preview-h_Xqs5wO.js";import{u as qe}from"./index-gJPm3Sqe.js";import"./vendor-BAdBCfSz.js";import"./editor-lib-DAvsPXRb.js";import"./editor-components-Z31k2Ye9.js";const f="https://api.osumappi.ng",v={};function Qe(){var ve,we,ye;const[S,I]=o.useState(v.history||[]),[u,$]=o.useState(v.index||-1),t=u>=0?S[u]:null,[U,ae]=o.useState(!1),[Re,le]=o.useState(!1),[_e,ce]=o.useState(!1),[X,A]=o.useState(!1),V=Y.useRef(null),[J,G]=o.useState(!1),K=Y.useRef(null),[N,Ce]=o.useState(null),[Q,F]=o.useState(!1),[Z,O]=o.useState(!1),ee=Y.useRef(null),te=Y.useRef(null),{notify:E}=qe(),[x,L]=o.useState(v.queue||[]),w=o.useRef(v.seenIds||new Set),de=o.useRef(new Set),ne=o.useRef(!1),ue=o.useRef(null),[fe,T]=o.useState(v.eligibleCount||null),[pe,z]=o.useState(v.viewedCount||0),[M,_]=o.useState(!1);o.useEffect(()=>()=>{v.history=S,v.index=u,v.queue=x,v.seenIds=w.current,v.eligibleCount=fe,v.viewedCount=pe},[S,u,x,fe,pe]);function P(e){var s;return(s=document.cookie.split("; ").map(r=>r.split("=")).find(([r])=>r===e))==null?void 0:s[1]}function Ie(){try{const e=Array.from(w.current).slice(-200);localStorage.setItem("feed_seen_ids",JSON.stringify(e))}catch{}}function R(){try{const e=localStorage.getItem("filter_modes"),s=(e?String(e):"standard").toLowerCase().split(",").map(i=>i.trim()).filter(Boolean),r=["standard","taiko","mania","catch"],a=Array.from(new Set(s.filter(i=>r.includes(i))));return a.length?a:["standard"]}catch{return["standard"]}}const he=async(e=3)=>{if(ne.current)return[];ne.current=!0;try{const s=async()=>{const d=[];for(let k=0;k<e;k++)try{const m=Array.from(w.current).slice(-200),c=R().join(","),g=await fetch(`${f}/api/feed/next?exclude=${encodeURIComponent(m.join(","))}&modes=${encodeURIComponent(c)}`,{credentials:"include"});if(g.status===401){ce(!0);break}if(g.status===429){E("Please slow down a bit.",{durationMs:3e3,variant:"warn"});break}if(!g.ok)break;const b=await g.json(),D=b&&(b.id?b:b.video);if(!D)break;d.push(D)}catch{break}return d};if(ue.current===!1){const d=await s(),k=new Set(x.map(c=>c.id)),m=d.filter(c=>!w.current.has(c.id)&&!k.has(c.id));if(m.length>0&&L(c=>[...c,...m]),m.length===0&&x.length===0)try{const c=R().join(","),g=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(c)}`,{credentials:"include"});if(g.ok){const b=await g.json();T(Number(b.eligible||0)),z(Number(b.viewed||0)),_(!!b.caught_up)}}catch{}return m}const r=Array.from(w.current).slice(-200),a=R().join(","),i=await fetch(`${f}/api/feed/batch?size=${e}&exclude=${encodeURIComponent(r.join(","))}&modes=${encodeURIComponent(a)}`,{credentials:"include"});if(i.status===401)return ce(!0),[];if(i.status===429)return E("Please slow down a bit.",{durationMs:4e3,variant:"warn"}),[];if(i.status===404){ue.current=!1;const d=await s(),k=new Set(x.map(c=>c.id)),m=d.filter(c=>!w.current.has(c.id)&&!k.has(c.id));if(m.length>0&&L(c=>[...c,...m]),m.length===0&&x.length===0)try{const c=R().join(","),g=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(c)}`,{credentials:"include"});if(g.ok){const b=await g.json(),D=Number(b.eligible||0),je=Number(b.viewed||0);T(D),z(je);const ze=D>0&&je>=D;_(ze)}}catch{}return m}const l=await i.json(),p=l&&Array.isArray(l.items)?l.items:[],h=new Set,y=p.filter(d=>h.has(d.id)?!1:(h.add(d.id),!0)),C=new Set(x.map(d=>d.id)),j=y.filter(d=>!w.current.has(d.id)&&!C.has(d.id));if(j.length>0&&L(d=>[...d,...j]),j.length===0&&x.length===0)try{const d=R().join(","),k=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(d)}`,{credentials:"include"});if(k.ok){const m=await k.json(),c=Number(m.eligible||0),g=Number(m.viewed||0);T(c),z(g);const b=c>0&&g>=c;_(b)}}catch{}return j}catch{return[]}finally{ne.current=!1}},B=async()=>{if(!U){ae(!0);try{let e=[];x.length===0&&(e=await he(3));let s;if(x.length>0?(s=x[0],L(r=>r.slice(1))):e.length>0&&(s=e[0],e.length>1&&L(r=>[...r,...e.slice(1)])),s){if(w.current.add(s.id),Ie(),I(r=>{const a=[...r.slice(0,u+1),s];return $(a.length-1),a}),!de.current.has(s.id)){de.current.add(s.id);const r=P("csrf")||"";try{const a=await fetch(`${f}/api/videos/${s.id}/view`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":r}});if(a.ok){const i=await a.json();i&&I(l=>{const p=[...l],h=p.findIndex(y=>y.id===s.id);return h!==-1&&(p[h]={...p[h],views_count:i.views_count??p[h].views_count??0,viewed_by_me:!0}),p})}}catch{}}}else try{const r=R().join(","),a=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(r)}`,{credentials:"include"});if(a.ok){const i=await a.json(),l=Number(i.eligible||0),p=Number(i.viewed||0);T(l),z(p);const h=l>0&&p>=l;_(h)}}catch{}x.length<=1&&he(3)}finally{ae(!1)}}},se=()=>{u>0&&($(u-1),F(!1))},re=()=>{if(u<S.length-1){$(u+1),F(!1);return}M||B()},H=o.useRef(0),q=o.useRef(null),W=o.useRef(null),ie=o.useRef({goNext:re,goPrev:se,index:u,history:S,loading:U,exhausted:M});o.useEffect(()=>{ie.current={goNext:re,goPrev:se,index:u,history:S,loading:U,exhausted:M}},[re,se,u,S,U,M]),o.useEffect(()=>{const e=xe.current;if(!e)return;const s=i=>{if(e){const y=e.getBoundingClientRect(),C=i.clientX,j=i.clientY;if(C<y.left||C>y.right||j<y.top||j>y.bottom)return}i.preventDefault(),i.stopPropagation();const l=Date.now();if(l<H.current||(H.current=l+1e3,Math.abs(i.deltaY)<Math.abs(i.deltaX)))return;const{goNext:p,goPrev:h}=ie.current;i.deltaY>0?p():h()},r=i=>{q.current=i.touches[0].clientY,W.current=Date.now()},a=i=>{if(q.current===null||W.current===null)return;const l=i.changedTouches[0].clientY,p=Date.now(),h=q.current-l,y=p-W.current;if(q.current=null,W.current=null,Math.abs(h)<50||y>300)return;const C=Date.now();if(C<H.current)return;H.current=C+1e3;const{goNext:j,goPrev:d}=ie.current;h>0?j():d()};return e.addEventListener("wheel",s,{passive:!1,capture:!0}),e.addEventListener("touchstart",r,{passive:!0}),e.addEventListener("touchend",a,{passive:!0}),window.addEventListener("wheel",s,{passive:!1,capture:!0}),()=>{e.removeEventListener("wheel",s,{capture:!0}),e.removeEventListener("touchstart",r),e.removeEventListener("touchend",a),window.removeEventListener("wheel",s,{capture:!0})}},[]);const $e=async()=>{if(t){le(!0);try{const e=P("csrf")||"",s=t.liked_by_me?"DELETE":"POST",r=await fetch(`${f}/api/videos/${t.id}/like`,{method:s,credentials:"include",headers:{"X-CSRF-Token":e}});if(r.status===429){E("Please slow down a bit.",{durationMs:5e3,variant:"warn"});return}if(r.ok){const a=await r.json();I(i=>{const l=[...i];return l[u]={...l[u],liked_by_me:!t.liked_by_me,likes_count:a.likes_count},l})}}finally{le(!1)}}};async function me(e){if(!t)return;const s=P("csrf")||"";(await fetch(`${f}/api/videos/${t.id}/flag`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":s},body:JSON.stringify({reason:e})})).ok?E("Thanks for your report.",{variant:"info"}):E("Report failed",{variant:"error"}),A(!1)}o.useEffect(()=>{if(!X)return;const e=s=>{V.current&&!V.current.contains(s.target)&&A(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[X]),o.useEffect(()=>{if(!J)return;const e=s=>{K.current&&!K.current.contains(s.target)&&G(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[J]),o.useEffect(()=>{if(!Z)return;const e=s=>{ee.current&&!ee.current.contains(s.target)&&te.current&&!te.current.contains(s.target)&&O(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[Z]),o.useEffect(()=>{S.length===0&&B()},[]),o.useEffect(()=>{(async()=>{try{const e=R().join(","),s=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(e)}`,{credentials:"include"});if(s.ok){const r=await s.json(),a=Number(r.eligible||0),i=Number(r.viewed||0);T(a),z(i);const l=a>0&&i>=a;_(l)}}catch{}})()},[]),o.useEffect(()=>{const e=()=>{I([]),L([]),w.current.clear(),$(-1),_(!1),(async()=>{try{const s=R().join(","),r=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(s)}`,{credentials:"include"});if(r.ok){const a=await r.json(),i=Number(a.eligible||0),l=Number(a.viewed||0);T(i),z(l),_(!1)}}catch{}B()})()};return window.addEventListener("filterchange",e),()=>window.removeEventListener("filterchange",e)},[]),o.useEffect(()=>{try{const e=localStorage.getItem("feed_seen_ids");if(e){const s=JSON.parse(e);if(Array.isArray(s))for(const r of s)typeof r=="number"&&w.current.add(r)}}catch{}},[]),o.useEffect(()=>{(async()=>{try{const e=await fetch(`${f}/api/me`,{credentials:"include"});e.ok&&Ce(await e.json())}catch{}})()},[]),o.useEffect(()=>{F(!1)},[t==null?void 0:t.id]);const ge=!!(N!=null&&N.is_admin||N!=null&&N.is_mod);async function Ne(){if(!t)return;const e=P("csrf")||"",s=!t.is_starred,r=s?"star":"unstar";(await fetch(`${f}/api/admin/videos/${t.id}/${r}`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":e}})).ok?(I(i=>{const l=[...i];return l[u]={...l[u],is_starred:s},l}),G(!1),E(s?"Post starred":"Star removed",{variant:"success"})):E("Action failed",{variant:"error"})}async function be(){if(!t||!confirm("Permanently delete this video?"))return;const e=P("csrf")||"";(await fetch(`${f}/api/videos/${t.id}`,{method:"DELETE",credentials:"include",headers:{"X-CSRF-Token":e}})).ok?(E("Deleted",{variant:"warn"}),A(!1),I(r=>{const a=r.filter((i,l)=>l!==u);return a.length===0?($(-1),setTimeout(B,0)):$(i=>Math.max(0,Math.min(i,a.length-1))),a})):alert("Delete failed")}const Le=Me(),xe=o.useRef(null),[oe,Te]=o.useState(0);return o.useEffect(()=>{const e=()=>{const s=document.querySelector(".top-nav");s&&Te(s.offsetHeight)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.jsxs("div",{ref:xe,className:"player-wrap",style:{height:"100vh",height:"100dvh",width:"100%",position:"fixed",top:0,left:0,right:0,bottom:0,overflow:"hidden",background:"#000",zIndex:1},children:[M&&n.jsx("div",{className:"chip info",style:{position:"absolute",top:oe+20,left:"50%",transform:"translateX(-50%)",zIndex:10,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(10px)"},children:"You're all caught up. Check 'Feed' to watch videos you've seen already."}),n.jsx("div",{className:"video-area",style:{position:"absolute",top:oe,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",background:"#000"},children:_e?n.jsxs("div",{className:"col",style:{alignItems:"center",zIndex:10},children:[n.jsx("div",{className:"muted",style:{marginBottom:8},children:"Please log in to view videos."}),n.jsx("button",{className:"btn",onClick:()=>window.location.href=`${f}/api/auth/login`,children:"Login with osu!"})]}):t?n.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative"},children:Q&&t.beatmapset_id?n.jsx("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box"},children:n.jsx(He,{downloadUrl:`${f}/api/osu/beatmapsets/${t.beatmapset_id}/download?noVideo=1`,beatmapId:t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0,onOpenInEditor:()=>{F(!1),window.location.hash="/editor"}})}):n.jsxs("div",{style:{width:"75vw",maxWidth:"75vw",height:"100%",maxHeight:`calc(100vh - ${oe}px)`,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto",position:"relative"},children:[n.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:10,pointerEvents:"none"}}),n.jsx("div",{style:{position:"relative",zIndex:1},children:n.jsx(Be,{streamUID:t.stream_uid,playbackUrl:t.playback_url,aspectRatio:t!=null&&t.width&&(t!=null&&t.height)?t.width/t.height:16/9})})]})}):M?null:n.jsx("div",{className:"muted",style:{zIndex:10},children:"No videos yet"})}),t&&!Q&&n.jsxs("div",{style:{position:"absolute",right:16,bottom:"20%",display:"flex",flexDirection:"column",gap:20,alignItems:"center",zIndex:15,pointerEvents:"auto"},children:[n.jsx(ke,{to:`/profile/${(ve=t.uploader)==null?void 0:ve.id}`,style:{width:48,height:48,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.3)",overflow:"hidden",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",textDecoration:"none"},children:(we=t.uploader)!=null&&we.avatar_url?n.jsx("img",{src:t.uploader.avatar_url,width:48,height:48,style:{borderRadius:"50%",objectFit:"cover",display:"block"},alt:t.uploader.username}):n.jsx("div",{style:{width:48,height:48,background:"rgba(255,255,255,0.1)"}})}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[n.jsx("button",{onClick:$e,disabled:Re,"aria-label":t.liked_by_me?"Unlike":"Like",title:t.liked_by_me?"Unlike":"Like",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:t.liked_by_me?"#f87171":"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:t.liked_by_me?n.jsx(De,{size:28}):n.jsx(Fe,{size:28})}),n.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:t.likes_count??0})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[n.jsx("button",{onClick:()=>Le(`/mp/feed/${t.stream_uid||t.id}`),"aria-label":"Comments",title:"Comments",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:n.jsx(Pe,{size:28})}),n.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:t.comments_count??0})]}),n.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[n.jsx("div",{style:{width:48,height:48,borderRadius:"50%",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"},children:n.jsx(Ue,{size:24})}),n.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:t.views_count??0})]}),t.beatmap_url&&n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{ref:te,onClick:()=>O(e=>!e),title:"Beatmap options","aria-label":"Beatmap options",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:n.jsx(Se,{size:24})}),Z&&n.jsxs("div",{ref:ee,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[n.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>O(!1),children:[n.jsx(Se,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),t.beatmapset_id&&n.jsx("button",{className:"menu-item",onClick:()=>{F(!0),O(!1)},children:"Preview"})]})]}),ge?n.jsxs("div",{style:{position:"relative"},children:[n.jsx("button",{onClick:()=>G(e=>!e),title:"Manage","aria-label":"Manage",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:n.jsx(Ee,{size:24})}),J&&n.jsxs("div",{ref:K,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:180,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[n.jsx("button",{className:"menu-item",onClick:Ne,children:t.is_starred?"Unstar post":"Star post"}),n.jsx("button",{className:"menu-item",onClick:be,children:"Delete video"})]})]}):n.jsx("button",{onClick:()=>A(e=>!e),title:"Report","aria-label":"Report",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:n.jsx(Ae,{size:24})}),X&&n.jsxs("div",{ref:V,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[n.jsx("div",{className:"muted",style:{fontSize:12,padding:"4px 8px"},children:"Report as…"}),n.jsx("button",{className:"menu-item",onClick:()=>me("unrelated"),children:"Unrelated"}),n.jsx("button",{className:"menu-item",onClick:()=>me("explicit"),children:"Explicit"}),ge&&n.jsx("button",{className:"menu-item",onClick:be,children:"Delete video"})]})]}),t&&!Q&&n.jsxs("div",{style:{position:"absolute",left:16,bottom:80,right:80,zIndex:15,pointerEvents:"none",display:"flex",flexDirection:"column",gap:12},children:[n.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,pointerEvents:"auto"},children:n.jsx(ke,{to:`/profile/${(ye=t.uploader)==null?void 0:ye.id}`,style:{textDecoration:"none",color:"#fff",fontWeight:600,fontSize:16,display:"flex",alignItems:"center",gap:8,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:(()=>{var a,i,l;const e=(a=t.uploader)==null?void 0:a.is_admin,s=(i=t.uploader)==null?void 0:i.is_mod,r=e?"#fff3bf":s?"#d7fbe8":"#fff";return n.jsxs(n.Fragment,{children:[n.jsxs("span",{style:{color:r},children:["@",(l=t.uploader)==null?void 0:l.username]}),t.is_starred&&n.jsx(Oe,{size:16,color:"#f59e0b",title:"Starred"}),(e||s)&&n.jsx(Ee,{size:14,color:r,title:e?"admin":"mod"})]})})()})}),(t.description??"").trim()&&n.jsx("div",{style:{color:"#fff",fontSize:14,lineHeight:1.5,textShadow:"0 1px 3px rgba(0,0,0,0.8)",maxWidth:"85%",wordBreak:"break-word",pointerEvents:"auto"},children:t.description}),t.beatmap_title&&n.jsxs("div",{style:{color:"rgba(255,255,255,0.9)",fontSize:13,textShadow:"0 1px 3px rgba(0,0,0,0.8)",pointerEvents:"auto"},children:[t.beatmap_artist," – ",t.beatmap_title," ",t.beatmap_mapper?`(by ${t.beatmap_mapper})`:""," ",t.beatmap_version?`[${t.beatmap_version}]`:""]})]})]})}export{Qe as default};

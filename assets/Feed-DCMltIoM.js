import{J as M,g as E,e as L,r as p,j as i}from"./vendor-react-Bj2Cd7tG.js";import{P as U}from"./Post-Bl-xgzxa.js";import{C}from"./Compose-C14dt26O.js";import{a as b,b as _,A as S,c as T}from"./index-Z5xFXEYC.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";function q(){const{data:c}=b(),{tagFilters:d}=_();return M({queryKey:["moddi","feed",d],queryFn:async({pageParam:u=0})=>{const a=new URLSearchParams({limit:"20",offset:String(u)}),r=`${S.moddi.posts}?${a.toString()}`;return await T(r)},enabled:!!c,initialPageParam:0,getNextPageParam:(u,a)=>{var m;const r=a.reduce((h,l)=>{var o;return h+(((o=l.items)==null?void 0:o.length)||0)},0);return(((m=u.items)==null?void 0:m.length)||0)===20?r:void 0}})}function J(){const c=E(),d=L(),{data:u}=b(),{tagFilters:a}=_(),{data:r,fetchNextPage:x,hasNextPage:m,isFetching:h,isFetchingNextPage:l,refetch:o}=q(),y=p.useMemo(()=>r!=null&&r.pages?r.pages.flatMap(t=>(t.items||[]).map(e=>{var n,g,P;return{...e,user_id:e.user_id??((n=e.author)==null?void 0:n.id)??0,username:e.username??((g=e.author)==null?void 0:g.username)??"Unknown",avatar_url:e.avatar_url??((P=e.author)==null?void 0:P.avatar_url)??null,text:e.text??null,uid:e.uid||String(e.id),reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)}})):[],[r]),f=p.useMemo(()=>y.filter(t=>{const s=t.tags?typeof t.tags=="string"?t.tags.split(",").map(g=>g.trim()):[]:[],e=!t.tags||s.length===0,n=s.includes("help");return a.untagged&&a.help?!0:a.untagged&&!a.help?e:!a.untagged&&a.help?n:!1}),[y,a]);p.useEffect(()=>{c.pathname==="/md/feed"&&o()},[c.pathname,o]),p.useEffect(()=>{const t=()=>{o()};return window.addEventListener("moddifilterchange",t),()=>window.removeEventListener("moddifilterchange",t)},[o]);const v=t=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(e=>({...e,items:e.items.map(n=>n.id===t.id?t:n)}))})},N=t=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(e=>({...e,items:e.items.filter(n=>n.id!==t)}))})},j=()=>{d.invalidateQueries({queryKey:["moddi","feed"]}),o()},w=h&&!l,F=m??!1;return i.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[i.jsx(C,{section:"moddi",onPost:j}),i.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:i.jsxs("div",{className:"col",style:{gap:0},children:[f.length===0&&!w&&i.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),f.map(t=>i.jsx(U,{post:t,section:"moddi",onUpdate:v,onDelete:N,me:u},t.id)),f.length>0&&F&&i.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:i.jsx("button",{className:"btn secondary",onClick:()=>x(),disabled:l,children:l?"Loading...":"Load more"})})]})})]})}export{J as default};

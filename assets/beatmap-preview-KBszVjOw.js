import{r as t,j as l,F as ie}from"./vendor-react-DlOpOyxn.js";import{A as oe,l as ae,a as ce,p as U,b as ue,r as le,c as fe,H as X,t as de,P as me,V as he,C as pe}from"./editor-lib-DRlB_9R9.js";const ge=({onOpenInEditor:B,beatmapId:k})=>{const[b,y]=t.useState(!1),d=t.useRef(null),S=t.useRef(null);t.useEffect(()=>{if(!b)return;const a=L=>{d.current&&!d.current.contains(L.target)&&S.current&&!S.current.contains(L.target)&&y(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[b]);const A=()=>{y(!1),B()},E=()=>{y(!1),k?window.open(`https://preview.tryz.id.vn/?b=${k}`,"_blank","noopener,noreferrer"):window.open("https://preview.tryz.id.vn/","_blank","noopener,noreferrer")};return l.jsxs("div",{className:"editor-button-wrapper",children:[l.jsx("button",{ref:S,className:"editor-button",onClick:a=>{a.stopPropagation(),y(!b)},"aria-label":"Editor options","aria-expanded":b,children:l.jsx(ie,{size:20})}),b&&l.jsxs("div",{ref:d,className:"editor-button-menu",children:[l.jsx("button",{className:"editor-button-menu-item",onClick:A,children:"Open in editor"}),l.jsx("button",{className:"editor-button-menu-item",onClick:E,children:"Open in JoSu!"})]})]})},ye=({downloadUrl:B,beatmapVersion:k,beatmapId:b,onOpenInEditor:y})=>{const[d,S]=t.useState(null),[A,E]=t.useState(void 0),[a,L]=t.useState(0),[h,T]=t.useState(0),[P,F]=t.useState(!1),[Y,D]=t.useState(!1),[q,J]=t.useState(null),[x,G]=t.useState(.6),[I,Q]=t.useState(1),[R,Z]=t.useState(.6),[M,H]=t.useState(!1),N=t.useRef(!1),$=t.useRef(!1),C=t.useRef(null),W=t.useRef(!1),c=t.useRef(new oe),w=t.useRef(null),V=t.useRef([]),j=t.useRef(0),O=t.useRef(null),_=t.useRef("");t.useEffect(()=>{const e=c.current;return e.onTick(n=>{N.current||T(n)}),()=>e.stop()},[]),t.useEffect(()=>{ae().then(e=>J(e)).catch(()=>J(null))},[]),t.useEffect(()=>{c.current&&(c.current.volume=I*x)},[I,x]),t.useEffect(()=>{w.current&&(w.current.volume=R*x)},[R,x]),t.useEffect(()=>{let e=!1;return D(!0),S(null),(async()=>{try{const n=await fetch(B,{credentials:"include"});if(!n.ok)throw new Error("Failed to download");const r=await n.arrayBuffer();O.current=r;const i=await ce(r),p=i.list.filter(u=>u.toLowerCase().endsWith(".osu"));let s,o;if(b)for(const u of p){const f=await i.readText(u),v=U(f),g=Number(v.metadata.BeatmapID||0);if(Number.isFinite(g)&&g===b){s=u,o=f;break}}if(!s)for(const u of p){const f=await i.readText(u),v=U(f),g=String(v.metadata.Version||"");if(k&&g.toLowerCase()===String(k).toLowerCase()){s=u,o=f;break}}if(s||(s=p[0],o=await i.readText(s)),e)return;_.current=s;let m=U(o);try{m=await ue(o,m)}catch{}S(m);try{const u=le(m.difficulty);V.current=fe(m,u),j.current=0}catch{V.current=[],j.current=0}if(L(0),m.audioFilename){const u=i.findFirst(f=>f.toLowerCase().endsWith(m.audioFilename.toLowerCase()))||m.audioFilename;try{const f=await i.readArrayBuffer(u);await c.current.load(f),L(c.current.duration||0)}catch{}}if(m.backgroundFilename)try{const u=i.findFirst(g=>g.toLowerCase().endsWith(m.backgroundFilename.toLowerCase()))||m.backgroundFilename,f=await i.readArrayBuffer(u),v=URL.createObjectURL(new Blob([f]));E(v)}catch{E(void 0)}else E(void 0);c.current.seek(0),T(0),F(!1),D(!1)}catch(n){console.error("Failed to load beatmap:",n),D(!1),S(null)}})(),()=>{e=!0}},[B,k,b]);const ee=t.useCallback(e=>{var s;M?(c.current&&a>0&&c.current.setPosition(e),T(e)):(c.current.seek(e),T(e));const n=e*1e3,r=V.current;let i=0,p=r.length;for(;i<p;){const o=i+p>>>1;r[o].timeMs<=n?i=o+1:p=o}j.current=i;try{(s=w.current)==null||s.stopSlide()}catch{}},[M,a]),te=t.useCallback(async()=>{var e;if(P){c.current.pause(),F(!1);try{(e=w.current)==null||e.stopAll()}catch{}return}try{const n=c.current.getContext();if(n.state!=="running"&&await n.resume(),!w.current){const r=new X(n);w.current=r,r.volume=R*x,await r.load().catch(()=>{})}}catch{}c.current.play(Math.max(0,Math.min(a,h))),F(!0)},[P,h,a,R,x]),K=t.useMemo(()=>{if(!d)return{bpm:0,sliderVelocity:0};const{base:e,inherited:n}=de(d,h*1e3),r=e?6e4/e.beatLength:0,i=n?-100/n.beatLength:1;return{bpm:r,sliderVelocity:i}},[d,h]),ne=t.useCallback(()=>{const e=c.current.isPlaying&&a>0;$.current=e,e&&c.current.pause(),F(!1),N.current=!0,H(!0)},[a]),re=t.useCallback(async()=>{N.current=!1,H(!1);try{const e=c.current.getContext();if(e.state!=="running"&&await e.resume(),!w.current){const n=new X(e);w.current=n,n.volume=R*x,await n.load().catch(()=>{})}}catch{}},[]);t.useEffect(()=>{const e=n=>{var v;const r=n.target;if(!r||r.closest(".editor-controls-container")||r.tagName==="INPUT"||r.tagName==="TEXTAREA"||(n.preventDefault(),!Number.isFinite(a)||a<=0))return;if(!W.current){W.current=!0;const g=c.current.isPlaying&&a>0;$.current=g,g&&c.current.pause(),F(!1),N.current=!0,H(!0)}C.current!==null&&clearTimeout(C.current);const i=n.shiftKey?1:.1,p=n.deltaY>0?1:-1,s=Math.max(0,Math.min(a,h+p*i));a>0&&c.current.setPosition(s),T(s);const o=s*1e3,m=V.current;let u=0,f=m.length;for(;u<f;){const g=u+f>>>1;m[g].timeMs<=o?u=g+1:f=g}j.current=u;try{(v=w.current)==null||v.stopSlide()}catch{}C.current=window.setTimeout(()=>{W.current=!1,N.current=!1,H(!1),C.current=null},150)};return window.addEventListener("wheel",e,{passive:!1}),()=>{window.removeEventListener("wheel",e),C.current!==null&&clearTimeout(C.current)}},[h,a,P]);const z=t.useRef(0);t.useEffect(()=>{if(!d){z.current=h;return}const e=w.current;if(!e){z.current=h;return}const n=z.current,r=h;if(z.current=h,!P||M||r<=n||r-n>1)return;const i=r*1e3,p=V.current;let s=j.current;for(;s<p.length&&p[s].timeMs<=i;s++){const o=p[s];o.kind==="hit"?e.playHit(o.set,o.bits||0):o.kind==="tick"?e.playTick(o.set):o.kind==="reverse"&&e.playReverse(o.set)}j.current=s},[h,d,P,M]);const se=t.useCallback(()=>{if(!(!O.current||!_.current))try{const e=O.current.byteLength/1048576;if(e>15){alert(`Beatmap is too large (${e.toFixed(1)}MB) to transfer. Please load it manually in the editor.`);return}const n=O.current.slice(0);window.__editorTransferOsz=n,window.__editorTransferPath=_.current,y?y():window.location.hash="/editor"}catch(e){console.error("Failed to transfer to editor:",e),alert("Failed to open in editor. The beatmap may be too large.")}},[y]);return Y?l.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"400px",gap:16},children:[l.jsx("div",{className:"loading-spinner"}),l.jsx("div",{className:"muted",children:"Loading beatmap..."})]}):d?l.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",maxWidth:"100%",height:"100%",maxHeight:"100%",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:[l.jsxs("div",{className:"embed-preview-playfield",style:{flex:"1 1 auto",minHeight:"400px",maxHeight:"none",aspectRatio:"16/9",width:"100%"},children:[l.jsx(me,{beatmap:d,timeSec:h,backgroundUrl:A,skin:q||void 0,sliderBodyCutoffPx:1}),l.jsx(he,{masterVolume:x,songVolume:I,hitsoundVolume:R,onMasterVolumeChange:G,onSongVolumeChange:Q,onHitsoundVolumeChange:Z}),l.jsx(ge,{onOpenInEditor:se,beatmapId:b})]}),l.jsx("div",{style:{flexShrink:0},children:l.jsx(pe,{isPlaying:P,onPlayPause:te,currentTime:h,duration:a,onSeek:ee,onScrubStart:ne,onScrubEnd:re,bpm:K.bpm,sliderVelocity:K.sliderVelocity,timingPoints:d==null?void 0:d.timingPoints})})]}):l.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"400px"},children:l.jsx("div",{className:"muted",children:"Failed to load beatmap"})})};export{ye as P};

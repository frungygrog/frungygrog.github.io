import{N as Ce,g as Pe,r as o,j as a,L as V,A as $e,F as Ee,D as Ne,V as Re,m as ce,E as ue,I as me,s as ze}from"./vendor-react-Bj2Cd7tG.js";import{u as Ie}from"./index-Cpn37iRT.js";import{P as Le}from"./Popup-BlKZUnaV.js";import{P as Fe}from"./Player-6g6U1utb.js";import{B as Te}from"./editor-lib-FG3lxfNK.js";const y="https://api.osumappi.ng";function F(e){var $;return($=document.cookie.split("; ").map(m=>m.split("=")).find(([m])=>m===e))==null?void 0:$[1]}function Me(e){return"stream_uid"in e}function Ae({post:e,section:$,onUpdate:m,onDelete:X,me:E}){const pe=Ce(),K=Pe(),J=$==="mappi"?K.pathname.startsWith("/mp/feed/"):K.pathname.startsWith("/md/feed/"),r=Me(e);e.id;const q=r?e.stream_uid:e.uid||String(e.id||""),T=$==="mappi"?`/mp/feed/${q}`:`/md/feed/${q}`,[G,Q]=o.useState(!1),[Y,Z]=o.useState(!1),[N,M]=o.useState(!1),[fe,R]=o.useState(!1),[ee,te]=o.useState(!1),O=o.useRef(null),w=o.useRef(null),ae=o.useRef(null),[W,ne]=o.useState(null),[c,be]=o.useState(null),{notify:b}=Ie(),[S,A]=o.useState(!1),[re,D]=o.useState(r?"":e.text??""),[B,z]=o.useState(e.beatmap_url||""),[l,g]=o.useState(null),[v,p]=o.useState(null),[ie,x]=o.useState(""),I=o.useRef(0),se=E&&((r?e.uploader&&E.id===e.uploader.id:E.id===e.user_id)||E.is_admin||E.is_mod),oe=(()=>{const t=e.created_at;if(!t)return"";const n=Math.floor(Date.now()/1e3)-t;return n<60?"just now":n<3600?`${Math.floor(n/60)}m`:n<86400?`${Math.floor(n/3600)}h`:n<604800?`${Math.floor(n/86400)}d`:new Date(t*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();o.useEffect(()=>{if(!S&&!r){const t=e;D(t.text??""),z(t.beatmap_url||""),g(null),p(null),x("")}},[e,S,r]),o.useEffect(()=>{if(!S||r)return;I.current&&window.clearTimeout(I.current);const t=(B||"").trim();if(!t){x(""),g(null),p(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(t)){x(""),g(null),p(null);return}return I.current=window.setTimeout(async()=>{var i;try{let s;try{s=new URL(t)}catch{x("Invalid URL format");return}const u=s.hash.match(/#osu\/(\d+)/),j=u?u[1]:null;s.hash="";const k=s.toString(),_=new URLSearchParams({url:k});j&&_.set("beatmap_id",j);const d=await fetch(`${y}/api/osu/beatmap/resolve?${_.toString()}`,{credentials:"include"});if(!d.ok){const L=await d.json().catch(()=>({})),h=String((L==null?void 0:L.error)||`HTTP ${d.status}: ${d.statusText}`);x(h),g(null),p(null);return}const f=await d.json(),P=Array.isArray(f==null?void 0:f.diffs)?f.diffs:[];if(!P.length&&!f.setId){x("No difficulties found"),g(null),p(null);return}if(g({setId:Number(f.setId)||0,beatmapId:f.beatmapId??null,title:String(f.title||""),artist:String(f.artist||""),mapper:String(f.mapper||""),diffs:P}),P.length>0){const L=Number.isFinite(Number(f.beatmapId))?Number(f.beatmapId):Number((i=P[0])==null?void 0:i.id),h=P.find(Se=>Number(Se.id)===L)||P[0];p({beatmapId:Number(h==null?void 0:h.id)||null,version:String((h==null?void 0:h.version)||""),mode:String((h==null?void 0:h.mode)||"standard")})}else p(null);x("")}catch(s){x(`Failed to resolve: ${(s==null?void 0:s.message)||"Unknown error"}`),g(null),p(null)}},400),()=>{I.current&&window.clearTimeout(I.current)}},[B,S,r]),o.useEffect(()=>{if(r||!e.beatmap_url||!e.beatmapset_id&&!e.beatmap_id||c)return;const t=e;let n=!1;return(async()=>{try{let i;try{i=new URL(t.beatmap_url)}catch{return}const s=i.hash.match(/#osu\/(\d+)/),u=s?s[1]:null;i.hash="";const j=i.toString(),k=new URLSearchParams({url:j});u&&k.set("beatmap_id",u);const _=await fetch(`${y}/api/osu/beatmap/resolve?${k.toString()}`,{credentials:"include"});if(_.ok&&!n){const d=await _.json();(d.title||d.artist)&&be({title:d.title||null,artist:d.artist||null,mapper:d.mapper||null})}}catch{}})(),()=>{n=!0}},[e,r,c]);const he=async()=>{if(!(G||!r)){Q(!0);try{const t=F("csrf")||"",n=e.liked_by_me?"DELETE":"POST",i=await fetch(`${y}/api/videos/${e.id}/like`,{method:n,credentials:"include",headers:{"X-CSRF-Token":t}});if(i.ok){const s=await i.json(),u={...e,liked_by_me:!e.liked_by_me,likes_count:s.likes_count||e.likes_count};m&&m(u)}else b("Failed to like",{variant:"error"})}finally{Q(!1)}}},ge=async()=>{if(!(Y||r)){Z(!0);try{const t=F("csrf")||"",n=e.reacted_by_me?"DELETE":"POST",i=await fetch(`${y}/api/moddiposts/${e.id}/react`,{method:n,credentials:"include",headers:{"X-CSRF-Token":t}});if(i.ok){const s=await i.json(),u={...e,reacted_by_me:!e.reacted_by_me,reactions_count:s.reactions_count||e.reactions_count};m&&m(u)}else b("Failed to react",{variant:"error"})}finally{Z(!1)}}},le=async()=>{if(confirm(r?"Permanently delete this video?":"Permanently delete this post?")){try{const t=F("csrf")||"",n=r?`${y}/api/videos/${e.id}`:`${y}/api/moddiposts/${e.id}`,i=await fetch(n,{method:"DELETE",credentials:"include",headers:{"X-CSRF-Token":t}});if(i.ok)b(r?"Video deleted":"Post deleted",{variant:"warn"}),X&&X(e.id);else{const s=await i.json().catch(()=>({}));b(s.error||(r?"Failed to delete video":"Failed to delete post"),{variant:"error"})}}catch{b(r?"Failed to delete video":"Failed to delete post",{variant:"error"})}R(!1)}},xe=async()=>{if(r){try{const t=F("csrf")||"",n=!e.is_starred,i=n?"star":"unstar";if((await fetch(`${y}/api/admin/videos/${e.id}/${i}`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":t}})).ok){const u={...e,is_starred:n};m&&m(u),b(n?"Post starred":"Star removed",{variant:"success"})}else b("Action failed",{variant:"error"})}catch{b("Action failed",{variant:"error"})}R(!1)}},ve=()=>{r||(A(!0),D(e.text??""),z(e.beatmap_url||""),g(null),p(null),x(""),R(!1))},ye=async()=>{if(!r)try{const t=F("csrf")||"",n=await fetch(`${y}/api/moddiposts/${e.id}`,{method:"PATCH",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify({text:re.trim(),beatmap_url:B.trim()||null,beatmapset_id:(l==null?void 0:l.setId)??void 0,beatmap_id:(v==null?void 0:v.beatmapId)??(l==null?void 0:l.beatmapId)??void 0,beatmap_version:(v==null?void 0:v.version)??void 0})});if(n.ok){const i=await n.json();m&&i.post&&m({...e,...i.post}),b("Post updated",{variant:"success"}),A(!1)}else{const i=await n.json().catch(()=>({}));b(i.error||"Failed to update post",{variant:"error"})}}catch{b("Failed to update post",{variant:"error"})}},_e=()=>{A(!1);const t=e;D(t.text??""),z(t.beatmap_url||""),g(null),p(null),x("")};o.useEffect(()=>{if(!N||!w.current){ne(null);return}const t=()=>{if(w.current){const n=w.current.getBoundingClientRect();ne({top:n.bottom+8,right:window.innerWidth-n.right})}};return t(),window.addEventListener("resize",t),window.addEventListener("scroll",t,!0),()=>{window.removeEventListener("resize",t),window.removeEventListener("scroll",t,!0)}},[N]),o.useEffect(()=>{if(!N)return;const t=n=>{O.current&&!O.current.contains(n.target)&&w.current&&!w.current.contains(n.target)&&M(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[N]);const je=t=>{const n=t.target;if(n.closest("button")||n.closest(".menu-panel")||n.closest("input")||n.closest("textarea")||n.closest("select"))return;const i=n.closest("a");i&&i.getAttribute("href")!==`#${T}`||(r||console.log("Navigating to moddi post:",{postId:e.id,postUid:e.uid,detailPath:T,post:e}),pe(T))},C=r?e.uploader||{id:0,username:"Unknown",avatar_url:null}:(()=>{var u,j,k;const t=e,n=t.user_id??((u=t.author)==null?void 0:u.id)??0,i=t.username??((j=t.author)==null?void 0:j.username)??"Unknown",s=t.avatar_url??((k=t.author)==null?void 0:k.avatar_url)??null;if(!r&&typeof window<"u"){const _=`moddi_post_logged_${t.id}`;window[_]||(window[_]=!0,console.log("Post component extracting user from moddi post:",{postId:t.id,user_id:t.user_id,username:t.username,avatar_url:t.avatar_url,extracted:{userId:n,username:i,avatarUrl:s},hasUsername:"username"in t,usernameType:typeof t.username,allUserKeys:Object.keys(t).filter(d=>d.toLowerCase().includes("user")||d.toLowerCase().includes("name")||d.toLowerCase().includes("avatar"))}))}return{id:n,username:i,avatar_url:s}})(),U=!r&&(e.reacted_by_me===!0||e.reacted_by_me===1),de=!r&&e.tags&&(typeof e.tags=="string"?e.tags.split(",").map(t=>t.trim()):[]).includes("help"),H=e.beatmapset_id,ke=e.beatmap_id,we=e.beatmap_version;return a.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:t=>t.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:t=>t.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",onClick:je,children:[a.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[C.avatar_url?a.jsx(V,{to:`/profile/${C.id}`,onClick:t=>t.stopPropagation(),style:{flexShrink:0},children:a.jsx("img",{src:C.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:C.username})}):a.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),a.jsx(V,{to:T,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:t=>{const n=t.target,i=n.closest("a");if(i&&i!==t.currentTarget){t.preventDefault(),t.stopPropagation();return}if(n.closest("button")||n.closest(".menu-panel")||n.closest("input")||n.closest("textarea")||n.closest("select")){t.preventDefault(),t.stopPropagation();return}t.stopPropagation()},children:a.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[a.jsx(V,{to:`/profile/${C.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:t=>t.stopPropagation(),onMouseEnter:t=>t.currentTarget.style.color="#7dd3fc",onMouseLeave:t=>t.currentTarget.style.color="inherit",children:C.username}),r&&e.is_starred&&a.jsx($e,{size:14,color:"#f59e0b",title:"Starred"}),r&&e.mode&&a.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:e.mode}),!r&&de&&a.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[oe&&a.jsx("span",{className:"muted",style:{fontSize:13},children:oe}),se&&a.jsx("button",{ref:ae,onClick:t=>{t.preventDefault(),t.stopPropagation(),R(n=>!n)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:t=>t.currentTarget.style.backgroundColor="rgba(255,255,255,0.05)",onMouseLeave:t=>t.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:a.jsx(Ee,{size:16})})]})]}),r&&J&&e.playback_url&&a.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10"},children:a.jsx(Fe,{playbackUrl:e.playback_url,streamUID:e.stream_uid,aspectRatio:e.width&&e.height?e.width/e.height:null})}),r&&!J&&e.poster_url&&a.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10",aspectRatio:e.width&&e.height?`${e.width} / ${e.height}`:"16 / 9",position:"relative"},children:[a.jsx("img",{src:e.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),e.duration_sec&&a.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(e.duration_sec/60),":",(e.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!r&&S?a.jsx("div",{style:{marginBottom:12},children:a.jsxs("div",{className:"col",style:{gap:8},children:[a.jsx("textarea",{value:re,onChange:t=>D(t.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),l?a.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[a.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[a.jsxs("strong",{style:{marginRight:4},children:[l.artist," – ",l.title]}),a.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",l.mapper]})]}),l.diffs.length>0&&a.jsx("select",{value:(v==null?void 0:v.beatmapId)??(l==null?void 0:l.beatmapId)??void 0,onChange:t=>{const n=Number(t.target.value),i=(l==null?void 0:l.diffs.find(s=>Number(s.id)===n))||null;i&&p({beatmapId:n,version:i.version,mode:String(i.mode||"standard")})},style:{background:"#0f1217",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:l.diffs.map(t=>a.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))}),a.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{g(null),p(null),z("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):a.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:B,onChange:t=>z(t.target.value),style:{fontSize:13,padding:"6px 8px"}}),ie&&a.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:ie}),a.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[a.jsx("button",{className:"btn secondary",onClick:_e,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),a.jsx("button",{className:"btn",onClick:ye,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):a.jsxs(a.Fragment,{children:[(r?(e.description??"").trim():(e.text??"").trim())&&a.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:r?e.description:e.text??""}),r&&e.beatmap_title&&a.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"#7b8491",lineHeight:1.4},children:[e.beatmap_artist," – ",e.beatmap_title," ",e.beatmap_mapper?`(by ${e.beatmap_mapper})`:""," ",e.beatmap_version?`[${e.beatmap_version}]`:""]}),!r&&e.beatmap_url&&(c||e.beatmapset_id||e.beatmap_id)&&a.jsx("div",{style:{marginBottom:10,fontSize:12,color:"#7b8491",lineHeight:1.4},children:c?a.jsxs(a.Fragment,{children:[c.artist," – ",c.title,c.mapper?` (by ${c.mapper})`:"",e.beatmap_version?` [${e.beatmap_version}]`:""]}):e.beatmap_version?`[${e.beatmap_version}]`:"Beatmap"}),!S&&a.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[r&&e.beatmap_url&&!e.beatmap_title&&a.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!r&&e.beatmap_url&&(c||e.beatmapset_id||e.beatmap_id)&&a.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:c?a.jsxs(a.Fragment,{children:[c.artist," – ",c.title,c.mapper?` (by ${c.mapper})`:"",e.beatmap_version?` [${e.beatmap_version}]`:""]}):e.beatmap_version?`[${e.beatmap_version}]`:"Beatmap"}),a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[r&&a.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:t=>{t.preventDefault(),t.stopPropagation()},children:[a.jsx(Ne,{size:12}),a.jsx("span",{children:e.views_count??0})]}),a.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:t=>{t.preventDefault(),t.stopPropagation()},children:[a.jsx(Re,{size:12}),a.jsx("span",{children:e.comments_count??0})]}),r?a.jsxs("button",{className:`chip-btn like ${e.liked_by_me?"liked":""}`,onClick:t=>{t.preventDefault(),t.stopPropagation(),he()},disabled:G,"aria-label":e.liked_by_me?"Unlike":"Like",title:e.liked_by_me?"Unlike":"Like",children:[e.liked_by_me?a.jsx(ce,{size:16}):a.jsx(ue,{size:16}),a.jsx("span",{children:e.likes_count||0})]}):a.jsxs("button",{className:`chip-btn like ${U?"liked":""}`,onClick:t=>{t.preventDefault(),t.stopPropagation(),ge()},disabled:Y,"aria-label":U?"Remove reaction":"React",title:U?"Remove reaction":"React",children:[de?a.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):U?a.jsx(ce,{size:16}):a.jsx(ue,{size:16}),a.jsx("span",{children:e.reactions_count||0})]}),e.beatmap_url&&a.jsxs("button",{ref:w,className:"chip-btn link",onClick:t=>{t.preventDefault(),t.stopPropagation(),M(n=>!n)},title:"Beatmap options","aria-label":"Beatmap options",children:[a.jsx(me,{size:16}),a.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),a.jsx(ze,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),N&&W&&e.beatmap_url&&a.jsxs("div",{ref:O,style:{position:"fixed",top:W.top,right:W.right,background:"#121418",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[a.jsxs("a",{className:"menu-item",href:e.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>M(!1),children:[a.jsx(me,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),H&&a.jsx("button",{className:"menu-item",onClick:()=>{te(!0),M(!1)},children:"Preview"})]}),ee&&H&&a.jsx(Te,{open:ee,onClose:()=>te(!1),downloadUrl:`${y}/api/osu/beatmapsets/${H}/download?noVideo=1`,beatmapId:ke??void 0,beatmapVersion:we??void 0}),se&&a.jsx(Le,{open:fe,onClose:()=>R(!1),buttonRef:ae,minWidth:160,children:r?a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"menu-item",onClick:t=>{t.preventDefault(),t.stopPropagation(),xe()},children:e.is_starred?"Unstar post":"Star post"}),a.jsx("button",{className:"menu-item",onClick:t=>{t.preventDefault(),t.stopPropagation(),le()},children:"Delete video"})]}):a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"menu-item",onClick:ve,children:"Edit post"}),a.jsx("button",{className:"menu-item",onClick:le,children:"Delete post"})]})})]})}export{Ae as P};

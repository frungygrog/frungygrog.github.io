import{P as U,T as q,e as H,r as i,j as a,U as M,L as W,A as $}from"./vendor-react-DlOpOyxn.js";import{P as J}from"./Post-Cy1Si4w6.js";import{C as V}from"./Comment-CcO8BeJz.js";import{O as Y}from"./Overlay-CgeSQ-bN.js";import{u as G,a as l,A as n,c as K}from"./index-hM29Y9fM.js";import"./vendor-DFcCRmls.js";import"./Popup-C6IAdSN1.js";import"./editor-lib-DRlB_9R9.js";import"./beatmap-preview-KBszVjOw.js";import"./editor-components-BPgr2gO5.js";function oe(){var R,B,E;const{uid:m}=U(),[v,j]=q(),p=H(),[e,u]=i.useState(null),[w,S]=i.useState([]),[k,P]=i.useState(!0),[h,D]=i.useState(null),[r,d]=i.useState(""),[f,g]=i.useState(null),[x,_]=i.useState(!1),[L,y]=i.useState(!1),{notify:b}=G(),T=i.useRef(new Set);i.useEffect(()=>{l(n.auth.me,{requireAuth:!1}).then(t=>D(t)).catch(()=>{})},[]),i.useEffect(()=>{v.get("preview")==="true"&&y(!0)},[v]);const C=async()=>{if(m){P(!0);try{const t=await l(n.videos.get(m),{requireAuth:!1});u(t)}catch{b("Failed to load post",{variant:"error"}),p("/mp/feed")}finally{P(!1)}}},A=async()=>{if(e!=null&&e.id)try{const t=await l(n.videos.comments(e.id),{requireAuth:!1});S(t.items||[])}catch{}};i.useEffect(()=>{C()},[m]),i.useEffect(()=>{e!=null&&e.id&&A()},[e==null?void 0:e.id]),i.useEffect(()=>{e!=null&&e.id&&(T.current.has(e.id)||(T.current.add(e.id),l(n.videos.view(e.id),{method:"POST"}).then(t=>{if(!t)return;const s=Number(t.views_count??0);u(c=>c?{...c,views_count:s,viewed_by_me:!0}:null)}).catch(()=>{})))},[e==null?void 0:e.id]);const F=t=>{"stream_uid"in t&&u(t)},O=()=>{p("/mp/feed")},I=async t=>{if(t.preventDefault(),!(!r.trim()||!(e!=null&&e.id))){_(!0);try{await l(n.videos.comments(e.id),{method:"POST",body:JSON.stringify({text:r.trim(),parent_id:f||void 0})}),d(""),g(null),A(),C(),b("Comment posted!",{variant:"success"})}catch(s){b((s==null?void 0:s.message)||"Failed to post comment",{variant:"error"})}finally{_(!1)}}},z=t=>{S(s=>s.filter(c=>c.id!==t))};if(k)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!e)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const N=w.filter(t=>!t.parent_id),o=new Map;return w.filter(t=>t.parent_id).forEach(t=>{const s=t.parent_id;o.has(s)||o.set(s,[]),o.get(s).push(t)}),a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[a.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[a.jsx("button",{className:"icon-link",onClick:()=>p("/mp/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:a.jsx(M,{size:20})}),a.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:a.jsx(J,{post:e,section:"mappi",onUpdate:F,onDelete:O,me:h})}),h&&!f&&a.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:a.jsxs("form",{onSubmit:I,style:{display:"flex",alignItems:"flex-end",gap:8},children:[a.jsx("textarea",{placeholder:"Write a comment...",value:r,onChange:t=>d(t.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:t=>{const s=t.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,120)}px`}}),a.jsx("button",{type:"submit",className:"btn compact",disabled:x||!r.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:x?"...":"Post"})]})}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:N.length===0?a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):a.jsx("div",{className:"col",style:{gap:0},children:N.map(t=>a.jsx(V,{comment:t,replies:o.get(t.id)||[],me:h,section:"mappi",onReply:s=>g(s),onDelete:z,replyingTo:f,replyText:r,onReplyTextChange:d,onReplySubmit:I,posting:x,onCancelReply:()=>{g(null),d("")},repliesMap:o},t.id))})})]}),e&&L&&e.beatmapset_id&&a.jsx(Y,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{y(!1),j({})},beatmapDownloadUrl:`${K}${n.osu.downloadBeatmapset(e.beatmapset_id)}`,beatmapId:e.beatmap_id??void 0,beatmapVersion:e.beatmap_version??void 0,onOpenInEditor:()=>{y(!1),j({}),window.location.hash="/editor"},headerLeft:a.jsxs(a.Fragment,{children:[((R=e.uploader)==null?void 0:R.avatar_url)&&a.jsx("img",{src:e.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),a.jsxs(W,{to:`/profile/${(B=e.uploader)==null?void 0:B.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[a.jsx("span",{children:(E=e.uploader)==null?void 0:E.username}),e.is_starred?a.jsx($,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{oe as default};

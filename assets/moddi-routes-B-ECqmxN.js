import{s as yt,t as Ce,v as be,w as Le,r,j as e,x as nt,l as ke,d as Oe,R as pe,y as qe,z as bt,e as vt,o as rt,u as De,q as it,L as ot,B as jt,C as Ne,k as $e,f as St,D as wt,E as Nt,G as _e,H as Be,I as He,J as kt,c as Me,K as lt,M as _t,N as Ct,O as Ye,P as Ke,A as Je,h as Xe,Q as Ge,S as Ve}from"./vendor-react-BTN9mWiO.js";import{a as C,A as _,g as Tt,u as fe,b as dt,P as ct,C as zt,c as It}from"./mappi-routes-C-qZ-O_l.js";import{i as Ft,a as Rt,b as Mt,c as Lt}from"./editor-components-CbtOkPyn.js";import{B as ut}from"./editor-DAGTbBEv.js";const qt=()=>{try{const t=localStorage.getItem("filter_modes")||"standard",n=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{standard:n.has("standard")||n.size===0,taiko:n.has("taiko"),mania:n.has("mania"),catch:n.has("catch")}}catch{return{standard:!0,taiko:!1,mania:!1,catch:!1}}},Pt=()=>{try{const t=localStorage.getItem("filter_moddi_tags")||"untagged,help",n=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{untagged:n.has("untagged")||n.size===0,help:n.has("help")||n.size===0}}catch{return{untagged:!0,help:!0}}},Et=()=>{try{const t=localStorage.getItem("filter_queue_status")||"unchecked,accepted,denied,finished",n=new Set(t.toLowerCase().split(",").map(s=>s.trim()).filter(Boolean));return{unchecked:n.has("unchecked")||n.size===0,accepted:n.has("accepted")||n.size===0,denied:n.has("denied")||n.size===0,finished:n.has("finished")||n.size===0,archived:n.has("archived")}}catch{return{unchecked:!0,accepted:!0,denied:!0,finished:!0,archived:!1}}},At=()=>{try{const t=localStorage.getItem("last_section");return t==="mappi"||t==="moddi"?t:null}catch{return null}},Ue=yt(t=>({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1,modeFilters:qt(),tagFilters:Pt(),queueStatusFilters:Et(),lastSection:At(),previousLocation:null,setMenuOpen:n=>t({menuOpen:n}),setMobileNavOpen:n=>t({mobileNavOpen:n}),setNotifOpen:n=>t({notifOpen:n}),closeAllPanels:()=>t({menuOpen:!1,mobileNavOpen:!1,notifOpen:!1}),setModeFilters:n=>{t({modeFilters:n});try{const c=Object.entries(n).filter(([p,h])=>h).map(([p])=>p),l=c.length?c:["standard"];localStorage.setItem("filter_modes",l.join(","))}catch{}},setTagFilters:n=>{t({tagFilters:n});try{const c=Object.entries(n).filter(([p,h])=>h).map(([p])=>p),l=c.length?c:["untagged","help"];localStorage.setItem("filter_moddi_tags",l.join(","))}catch{}},setQueueStatusFilters:n=>{t({queueStatusFilters:n});try{const c=Object.entries(n).filter(([p,h])=>h).map(([p])=>p),l=c.length?c:["unchecked","accepted","denied","finished"];localStorage.setItem("filter_queue_status",l.join(","))}catch{}},setLastSection:n=>{t({lastSection:n});try{n?localStorage.setItem("last_section",n):localStorage.removeItem("last_section")}catch{}},setPreviousLocation:n=>{t({previousLocation:n})}}));function Bt(t=!0){return Ce({queryKey:["notifications"],queryFn:async()=>{try{const n=await C(_.user.notifications);return Array.isArray(n.items)?n.items:[]}catch{return[]}},enabled:t,refetchInterval:45*1e3})}function Ot(){return Ce({queryKey:["notifications","detailed"],queryFn:async()=>{try{const t=await C("/api/me/notifications/detailed");return Array.isArray(t.items)?t.items:[]}catch{return[]}},refetchInterval:30*1e3})}function ts(){const{data:t=[]}=Bt();return t.filter(n=>n.kind==="system"&&n.id.startsWith("b:")&&(n.expiresAt||0)<=Date.now()?!1:!n.read).length}function Dt(){const t=be();return Le({mutationFn:async n=>{await C(_.user.markNotificationsRead,{method:"POST",body:JSON.stringify({ids:n})})},onSuccess:()=>{t.setQueryData(["notifications"],n=>(n==null?void 0:n.map(s=>({...s,read:!0})))||[])}})}function Ut(){const t=be();return Le({mutationFn:async n=>{const s=Tt();await C(_.user.deleteNotification(n),{method:"DELETE",headers:{"X-CSRF-Token":s}})},onSuccess:(n,s)=>{t.setQueryData(["notifications"],c=>(c==null?void 0:c.filter(l=>l.id!==s))||[]),t.setQueryData(["notifications","detailed"],c=>(c==null?void 0:c.filter(l=>l.id!==s))||[])}})}function Wt(t,n,s,c){r.useEffect(()=>{if(!s)return;const l=p=>{const h=p.target;n.current&&!n.current.contains(h)&&t.current&&!t.current.contains(h)&&c()};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[s,c,t,n])}function Te(){return Ce({queryKey:["user","me"],queryFn:async()=>{try{return await C(_.auth.me)}catch{return null}},staleTime:5*60*1e3})}function ss(t=!0){return Ce({queryKey:["user","quota"],queryFn:async()=>{try{return await C(_.user.quota)}catch{return null}},enabled:t,refetchInterval:30*1e3})}function as(){const t=be();return Le({mutationFn:async()=>{await C(_.auth.logout,{method:"POST"})},onSuccess:()=>{t.setQueryData(["user","me"],null),t.clear(),window.location.href="/"}})}const Ze={standard:Lt,taiko:Mt,mania:Rt,catch:Ft},et={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Qt=({value:t,onChange:n})=>{const[s,c]=r.useState(!1),l=r.useRef(null);r.useEffect(()=>{if(!s)return;const h=j=>{l.current&&!l.current.contains(j.target)&&c(!1)},T=j=>{j.key==="Escape"&&c(!1)};return document.addEventListener("mousedown",h),document.addEventListener("keydown",T),()=>{document.removeEventListener("mousedown",h),document.removeEventListener("keydown",T)}},[s]);const p=h=>e.jsxs("button",{className:`mode-option${h===t?" selected":""}`,onClick:()=>{n(h),c(!1)},role:"option","aria-selected":h===t,children:[e.jsx("img",{className:"mode-icon",src:Ze[h],width:24,height:24,alt:""}),e.jsx("span",{children:et[h]})]},h);return e.jsxs("div",{className:"mode-select",ref:l,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":s,onClick:()=>c(h=>!h),children:[e.jsx("img",{className:"mode-icon",src:Ze[t],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:et[t]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),s&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(p)})]})};function tt(t){if(!t)return"standard";const n=String(t).toLowerCase().trim();return n==="osu"||n==="0"||n==="standard"?"standard":n==="taiko"||n==="1"?"taiko":n==="catch"||n==="fruits"||n==="2"?"catch":n==="mania"||n==="3"?"mania":"standard"}function mt({section:t,onUpload:n,onPost:s,forceExpanded:c}){const{notify:l}=fe(),p=t==="mappi",[h,T]=r.useState(!1),[j,N]=r.useState(""),[o,k]=r.useState(null),[f,v]=r.useState(null),[F,R]=r.useState(!1),[Q,S]=r.useState(""),M=r.useRef(0),[q,U]=r.useState(""),[V,Z]=r.useState("standard"),[z,ie]=r.useState(null),[x,E]=r.useState(0),[ae,B]=r.useState(""),[g,y]=r.useState(""),[b,ee]=r.useState(null),[ue,Y]=r.useState(""),[W,O]=r.useState(""),[ne,K]=r.useState(null),[te,i]=r.useState(!1),[w,G]=r.useState(null),se=100*1024*1024,D=r.useMemo(()=>z?`${z.name}:${z.size}:${z.lastModified}`:null,[z]),[$,J]=r.useState(""),[le,ge]=r.useState(!1),[ce,xe]=r.useState([]),ve=r.useRef(null);r.useEffect(()=>{M.current&&window.clearTimeout(M.current);const u=(j||"").trim();if(!u){S(""),k(null),v(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(u)){S(""),k(null),v(null);return}return M.current=window.setTimeout(async()=>{var I;try{let L;try{L=new URL(u)}catch{S("Invalid URL format");return}const de=L.hash.match(/#osu\/(\d+)/),H=de?de[1]:null;L.hash="";const Fe={url:L.toString()};H&&(Fe.beatmap_id=H);const X=await C(_.osu.resolveBeatmap+dt(Fe),{requireAuth:!1}),he=Array.isArray(X==null?void 0:X.diffs)?X.diffs:[];if(!he.length&&!X.setId){S("No difficulties found"),k(null),v(null);return}if(k({setId:Number(X.setId)||0,beatmapId:X.beatmapId??null,title:String(X.title||""),artist:String(X.artist||""),mapper:String(X.mapper||""),diffs:he}),he.length>0){const Ee=Number.isFinite(Number(X.beatmapId))?Number(X.beatmapId):Number((I=he[0])==null?void 0:I.id),me=he.find(Ae=>Number(Ae.id)===Ee)||he[0],ye=tt(me==null?void 0:me.mode);v({beatmapId:Number(me==null?void 0:me.id)||null,version:String((me==null?void 0:me.version)||""),mode:ye}),p&&Z(ye)}else v(null);S("")}catch(L){const de=(L==null?void 0:L.message)||"Unknown error";S(`Failed to resolve: ${de}`),k(null),v(null)}},400),()=>{M.current&&window.clearTimeout(M.current)}},[j,p]);async function ze(){return y("info"),B("Requesting upload URL..."),await C(_.uploads.new,{method:"POST",body:JSON.stringify({description:q.slice(0,100),beatmap_url:j||void 0,size_bytes:(z==null?void 0:z.size)??void 0,mode:V,beatmapset_id:(o==null?void 0:o.setId)??void 0,beatmap_id:(f==null?void 0:f.beatmapId)??void 0,beatmap_version:(f==null?void 0:f.version)??void 0,beatmap_title:o?`${o.title}`:void 0,beatmap_artist:o?`${o.artist}`:void 0,beatmap_mapper:o?`${o.mapper}`:void 0})})}async function je(u,P,I="form"){await new Promise((L,de)=>{const H=new XMLHttpRequest;if(H.open("POST",u),H.upload.onprogress=oe=>{oe.lengthComputable&&E(Math.round(oe.loaded/oe.total*100))},H.onload=()=>H.status>=200&&H.status<300?L():de(new Error(`Upload failed (${H.status}) ${H.responseText||""}`)),H.onerror=()=>de(new Error("Network error")),I==="form"){const oe=new FormData;oe.append("file",P,P.name),H.send(oe)}else H.setRequestHeader("Content-Type","application/octet-stream"),H.send(P)})}async function Ie(){if(!(!z||!p)){if(z.size>se){Y("File exceeds 100MB limit");return}if(typeof ne=="number"&&ne>60.5){O("Clip exceeds 60s limit");return}D&&(i(!0),G(D)),E(0),y("info");try{const u=await ze();ee(u.streamUID);let P=u.streamUID;try{B("Uploading..."),await je(u.uploadURL,z,"form")}catch(I){y("warn"),B(`Retrying upload... (${(I==null?void 0:I.message)||I})`);const L=await ze();ee(L.streamUID),P=L.streamUID,await je(L.uploadURL,z,"binary")}y("info"),B("Processing...");for(let I=0;I<60;I++){await new Promise(L=>setTimeout(L,3e3));try{if((await C(_.videos.get(P),{requireAuth:!1})).status==="ready"){y("success"),B("Ready!"),l("Upload complete!",{variant:"success"}),ie(null),U(""),N(""),k(null),v(null),Z("standard"),E(0),ee(null),Y(""),O(""),K(null),i(!1),G(null),n&&n();break}}catch{}}}catch(u){y("error"),B(u.message||"Error"),l(u.message||"Upload failed",{variant:"error"})}}}const Se=async u=>{if(u.preventDefault(),!p){if(!$.trim()){l("Text is required",{variant:"error"});return}if($.length>200){l("Text must be 200 characters or less",{variant:"error"});return}ge(!0);try{const P=await C(_.moddi.posts,{method:"POST",body:JSON.stringify({text:$.trim(),beatmap_url:j.trim()||void 0,beatmapset_id:(o==null?void 0:o.setId)??void 0,beatmap_id:(f==null?void 0:f.beatmapId)??(o==null?void 0:o.beatmapId)??void 0,beatmap_version:(f==null?void 0:f.version)??void 0,tags:ce.length>0?ce.join(","):void 0})});if(P){console.log("Post created response:",P);const I=P==null?void 0:P.post;I?(!I.uid&&I.id&&(console.warn("Created post missing uid, using id as fallback:",I),I.uid=String(I.id)),s&&s(I)):s&&s(),l("Post created!",{variant:"success"}),J(""),N(""),k(null),v(null),S(""),R(!1),xe([])}}catch{l("Failed to create post",{variant:"error"})}finally{ge(!1)}}},we=!!c||h;return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:p?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:c?"default":"pointer",padding:"8px 12px",minHeight:36},onClick:()=>{c||T(!h)},children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:p?"Upload a clip":"Create a post!"}),we?e.jsx(nt,{size:16}):e.jsx(ke,{size:16})]}),we&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Qt,{value:V,onChange:Z})]}),o?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[o.artist," – ",o.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",o.mapper]})]}),o.diffs.length>0&&e.jsx("select",{value:(f==null?void 0:f.beatmapId)??o.beatmapId??void 0,onChange:u=>{const P=Number(u.target.value),I=(o==null?void 0:o.diffs.find(L=>Number(L.id)===P))||null;if(I){const L=tt(I.mode);v({beatmapId:P,version:I.version,mode:L}),Z(L)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:o.diffs.map(u=>e.jsxs("option",{value:u.id,children:[u.version," (",u.mode,")"]},u.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>R(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{k(null),v(null),N("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:j,onChange:u=>N(u.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:q,onChange:u=>U(u.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),Q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:Q}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:u=>{var L;const P=((L=u.target.files)==null?void 0:L[0])||null;if(ie(P),K(null),P&&P.size>se?Y("File exceeds 100MB limit"):Y(""),P)try{const de=URL.createObjectURL(P),H=document.createElement("video");H.preload="metadata",H.src=de,H.onloadedmetadata=()=>{URL.revokeObjectURL(de);const oe=Number.isFinite(H.duration)?H.duration:NaN;Number.isFinite(oe)&&K(oe),Number.isFinite(oe)&&oe>60.5?O("Clip exceeds 60s limit"):O("")},H.onerror=()=>{URL.revokeObjectURL(de),K(null)}}catch{K(null)}else O("");const I=P?`${P.name}:${P.size}:${P.lastModified}`:null;I&&I!==w&&i(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:Ie,disabled:!z||!!ue||!!W||te,style:{flexShrink:0},children:"Upload"})]}),ue&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:ue}),W&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:W}),z&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",z.name," • ",(z.size/1024/1024).toFixed(1)," MB",te&&w===D?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(x>0||ae)&&e.jsxs("div",{className:"upload-status",children:[ae&&e.jsx("div",{className:`chip ${g||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:ae}),x>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":x,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,x))}%`}})})]}),b&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",b]})]})]}):e.jsx("form",{onSubmit:Se,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:ve,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:$,onChange:u=>J(u.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),o?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[o.artist," – ",o.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",o.mapper]})]}),o.diffs.length>0&&e.jsx("select",{value:(f==null?void 0:f.beatmapId)??o.beatmapId??void 0,onChange:u=>{const P=Number(u.target.value),I=(o==null?void 0:o.diffs.find(L=>Number(L.id)===P))||null;I&&v({beatmapId:P,version:I.version,mode:String(I.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:o.diffs.map(u=>e.jsxs("option",{value:u.id,children:[u.version," (",u.mode,")"]},u.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:j,onChange:u=>N(u.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),Q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:Q}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{ce.includes("help")?xe(ce.filter(u=>u!=="help")):xe([...ce,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:ce.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:ce.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:ce.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[o&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>R(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{k(null),v(null),N("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:le||!$.trim()||$.length>200,children:le?"Posting...":"Post"})]})]})})}),F&&o&&e.jsx(ut,{open:F,onClose:()=>R(!1),downloadUrl:_.osu.downloadBeatmapset(o.setId),beatmapId:(f==null?void 0:f.beatmapId)??o.beatmapId??void 0,beatmapVersion:f==null?void 0:f.version})]})}function Pe({open:t,onClose:n,children:s}){const c=r.useRef(null),l=r.useRef(null),p=r.useRef(!1),h=o=>{var k;l.current=((k=o.touches[0])==null?void 0:k.clientY)??null,p.current=!1},T=o=>{var F,R;if(l.current==null)return;const k=((F=o.touches[0])==null?void 0:F.clientY)??null;if(k==null)return;const f=k-l.current;(((R=c.current)==null?void 0:R.scrollTop)??0)<=0&&f>60?p.current=!0:p.current=!1},j=()=>{p.current&&n(),l.current=null,p.current=!1};if(!t)return null;const N=e.jsx("div",{className:"mobile-upload-overlay",onClick:n,children:e.jsx("div",{ref:c,className:"mobile-upload-sheet",onClick:o=>o.stopPropagation(),onTouchStart:h,onTouchMove:T,onTouchEnd:j,children:s})});return Oe.createPortal(N,document.body)}function $t({section:t,onUpload:n,onPost:s}){const[c,l]=pe.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":t==="mappi"?"Upload clip":"New post",title:t==="mappi"?"Upload clip":"New post",onClick:()=>l(!0),children:e.jsx(qe,{size:22})}),e.jsx(Pe,{open:c,onClose:()=>l(!1),children:e.jsx("div",{style:{paddingTop:6},children:e.jsx(mt,{section:t,forceExpanded:!0,onUpload:()=>{n==null||n(),l(!1)},onPost:p=>{s==null||s(p),l(!1)}})})})]})}function Ht(){const{data:t}=Te(),{tagFilters:n}=Ue();return bt({queryKey:["moddi","feed",n],queryFn:async({pageParam:s=0})=>{const c=new URLSearchParams({limit:"20",offset:String(s)}),l=`${_.moddi.posts}?${c.toString()}`;return await C(l)},enabled:!!t,initialPageParam:0,getNextPageParam:(s,c)=>{var h;const l=c.reduce((T,j)=>{var N;return T+(((N=j.items)==null?void 0:N.length)||0)},0);return(((h=s.items)==null?void 0:h.length)||0)===20?l:void 0}})}function ns(){const t=vt(),n=be(),{data:s}=Te(),{tagFilters:c}=Ue(),{data:l,fetchNextPage:p,hasNextPage:h,isFetching:T,isFetchingNextPage:j,refetch:N}=Ht(),o=r.useMemo(()=>l!=null&&l.pages?l.pages.flatMap(S=>(S.items||[]).map(q=>({...q,user_id:q.user_id??0,username:q.username||"Unknown",avatar_url:q.avatar_url||null,text:q.text??null,uid:q.uid||String(q.id||""),reactions_count:Number(q.reactions_count??0),reacted_by_me:q.reacted_by_me??!1,comments_count:Number(q.comments_count??0)}))):[],[l]),k=r.useMemo(()=>o.filter(S=>{const M=S.tags?typeof S.tags=="string"?S.tags.split(",").map(V=>V.trim()):[]:[],q=!S.tags||M.length===0,U=M.includes("help");return c.untagged&&c.help?!0:c.untagged&&!c.help?q:!c.untagged&&c.help?U:!1}),[o,c]);r.useEffect(()=>{t.pathname==="/md/feed"&&N()},[t.pathname,N]),r.useEffect(()=>{const S=()=>{N()};return window.addEventListener("moddifilterchange",S),()=>window.removeEventListener("moddifilterchange",S)},[N]);const f=S=>{n.setQueryData(["moddi","feed"],M=>M&&{...M,pages:M.pages.map(q=>({...q,items:q.items.map(U=>U.id===S.id?S:U)}))})},v=S=>{n.setQueryData(["moddi","feed"],M=>M&&{...M,pages:M.pages.map(q=>({...q,items:q.items.filter(U=>U.id!==S)}))})},F=S=>{S&&n.setQueryData(["moddi","feed"],M=>{if(!M)return M;const q={...S,user_id:S.user_id??0,username:S.username||"Unknown",avatar_url:S.avatar_url||null,text:S.text??null,uid:S.uid||String(S.id||""),reactions_count:Number(S.reactions_count??0),reacted_by_me:S.reacted_by_me??!1,comments_count:Number(S.comments_count??0)};return{...M,pages:M.pages.map((U,V)=>V===0?{...U,items:[q,...U.items||[]]}:U)}}),n.invalidateQueries({queryKey:["moddi","feed"]}),N()},R=T&&!j,Q=h??!1;return e.jsxs("div",{className:"feed-container moddi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"feed-header",children:[e.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),e.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),e.jsx(mt,{section:"moddi",onPost:F})]}),e.jsx($t,{section:"moddi",onPost:F}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:0},children:[k.length===0&&!R&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),k.map(S=>e.jsx(ct,{post:S,section:"moddi",onUpdate:f,onDelete:v,me:s},S.id)),k.length>0&&Q&&e.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("button",{className:"btn secondary",onClick:()=>p(),disabled:j,children:j?"Loading...":"Load more"})})]})})]})}function rs(){const{uid:t}=rt(),n=De(),[s,c]=r.useState(null),[l,p]=r.useState([]),[h,T]=r.useState(!0),[j,N]=r.useState(null),[o,k]=r.useState(""),[f,v]=r.useState(null),[F,R]=r.useState(!1),{notify:Q}=fe();r.useEffect(()=>{C(_.auth.me,{requireAuth:!1}).then(x=>N(x)).catch(()=>{})},[]);const S=async()=>{if(!t||t==="null"||t==="undefined"){Q("Invalid post identifier",{variant:"error"}),n("/md/feed");return}T(!0);try{const x=await C(_.moddi.post(t),{requireAuth:!1}),E={...x,user_id:x.user_id??0,username:x.username||"Unknown",avatar_url:x.avatar_url||null,uid:x.uid||String(x.id)||t,text:x.text??null,beatmap_url:x.beatmap_url??null,beatmapset_id:x.beatmapset_id??null,beatmap_id:x.beatmap_id??null,beatmap_version:x.beatmap_version??null,tags:x.tags??null,reactions_count:Number(x.reactions_count??0),reacted_by_me:x.reacted_by_me??!1,comments_count:Number(x.comments_count??0)};c(E)}catch{Q("Failed to load post",{variant:"error"}),n("/md/feed")}finally{T(!1)}},M=async()=>{if(s!=null&&s.id)try{const x=await C(_.moddi.postComments(s.id),{requireAuth:!1});p(x.items||[])}catch{}};r.useEffect(()=>{S()},[t]),r.useEffect(()=>{s!=null&&s.id&&M()},[s==null?void 0:s.id]);const q=x=>{c(x)},U=()=>{n("/md/feed")},V=async x=>{if(x.preventDefault(),!(!o.trim()||!(s!=null&&s.id))){R(!0);try{await C(_.moddi.postComments(s.id),{method:"POST",body:JSON.stringify({text:o.trim(),parent_id:f||void 0})}),k(""),v(null),M(),S(),Q("Comment posted!",{variant:"success"})}catch(E){Q((E==null?void 0:E.message)||"Failed to post comment",{variant:"error"})}finally{R(!1)}}},Z=x=>{p(E=>E.filter(ae=>ae.id!==x))};if(h)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!s)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const z=l.filter(x=>!x.parent_id),ie=new Map;return l.filter(x=>x.parent_id).forEach(x=>{const E=x.parent_id;ie.has(E)||ie.set(E,[]),ie.get(E).push(x)}),e.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>n("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(it,{size:20})}),e.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(ct,{post:s,section:"moddi",onUpdate:q,onDelete:U,me:j})}),j&&!f&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:V,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:o,onChange:x=>k(x.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:x=>{const E=x.target;E.style.height="auto",E.style.height=`${Math.min(E.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:F||!o.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:F?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:z.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:z.map(x=>e.jsx(zt,{comment:x,replies:ie.get(x.id)||[],me:j,section:"moddi",onReply:E=>v(E),onDelete:Z,replyingTo:f,replyText:o,onReplyTextChange:k,onReplySubmit:V,posting:F,onCancelReply:()=>{v(null),k("")},repliesMap:ie},x.id))})})]})}function Yt({queue:t}){return e.jsx(ot,{to:`/md/queues/${t.id}`,style:{textDecoration:"none",color:"inherit",display:"block"},children:e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",cursor:"pointer"},onMouseEnter:n=>n.currentTarget.style.background="rgba(255,255,255,0.02)",onMouseLeave:n=>n.currentTarget.style.background="rgba(255,255,255,0.01)",children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,marginBottom:8},children:[t.is_group?e.jsx(jt,{size:18}):e.jsx(Ne,{size:18}),e.jsx("strong",{style:{fontSize:16},children:t.name}),t.is_member&&e.jsx("span",{className:"chip",style:{fontSize:11,padding:"2px 8px"},children:"Member"})]}),t.description&&e.jsx("div",{className:"muted",style:{fontSize:14,marginBottom:8},children:t.description}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,fontSize:12},children:[t.owner_avatar_url&&e.jsx("img",{src:t.owner_avatar_url,width:20,height:20,style:{borderRadius:"50%"}}),e.jsxs("span",{className:"muted",children:["by ",t.owner_username,t.member_count!==void 0&&Number(t.member_count)>0&&(Number(t.member_count)===1&&t.first_member_username?` and ${t.first_member_username}`:` & ${t.member_count} others`)]}),e.jsx("span",{className:"muted",children:"•"}),e.jsx("span",{className:"muted",children:new Date(t.created_at*1e3).toLocaleDateString()})]})]})})}function We(){return Ce({queryKey:["moddi","queues"],queryFn:async()=>{const t=await C(_.moddi.queues);return Array.isArray(t.items)?t.items:[]}})}function pt(){const t=be();return Le({mutationFn:async n=>{var s;return await C(_.moddi.queues,{method:"POST",body:JSON.stringify({name:n.name.trim(),description:((s=n.description)==null?void 0:s.trim())||null,is_group:n.is_group??!1})})},onSuccess:()=>{t.invalidateQueries({queryKey:["moddi","queues"]})}})}function Kt(){const[t,n]=pe.useState(!1),[s,c]=pe.useState(""),[l,p]=pe.useState(""),{data:h=[]}=We(),{data:T}=Te(),{notify:j}=fe(),N=pt(),o=pe.useMemo(()=>T?h.some(f=>f.owner_id===T.id):!1,[T,h]),k=f=>{if(f&&f.preventDefault(),o){j("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!s.trim()){j("Queue name is required",{variant:"error"});return}N.mutate({name:s.trim(),description:l.trim()||null,is_group:!1},{onSuccess:()=>{j("Queue created!",{variant:"success"}),n(!1),c(""),p("")},onError:v=>{j((v==null?void 0:v.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Create queue",title:"Create queue",onClick:()=>n(!0),children:e.jsx(qe,{size:22})}),e.jsx(Pe,{open:t,onClose:()=>n(!1),children:e.jsxs("form",{onSubmit:k,className:"col",style:{gap:12},children:[o?e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."}):e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:s,onChange:f=>c(f.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:l,onChange:f=>p(f.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>n(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:N.isPending||o,children:N.isPending?"Creating...":"Create"})]})]})})]})}function is(){const{data:t=[],isLoading:n}=We(),{data:s}=Te(),c=pt(),{notify:l}=fe(),[p,h]=r.useState(!1),[T,j]=r.useState(""),[N,o]=r.useState(""),k=r.useMemo(()=>s?t.some(v=>v.owner_id===s.id):!1,[s,t]),f=async v=>{if(v.preventDefault(),k){l("You can only create one queue. You can join other queues as a member.",{variant:"error"});return}if(!T.trim()){l("Queue name is required",{variant:"error"});return}c.mutate({name:T.trim(),description:N.trim()||null,is_group:!1},{onSuccess:()=>{l("Queue created!",{variant:"success"}),h(!1),j(""),o("")},onError:F=>{l((F==null?void 0:F.message)||"Failed to create queue",{variant:"error"})}})};return e.jsxs("div",{className:"feed-container queues-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx(Kt,{}),e.jsx("div",{className:"feed-header",children:e.jsx("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:0},children:k?e.jsx("div",{style:{padding:"12px"},children:e.jsx("div",{className:"muted",style:{fontSize:14,lineHeight:1.5},children:"You already own a queue. You can join other queues as a member, but you can only create one queue."})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>h(!p),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:"Create a queue!"}),p?e.jsx(nt,{size:16}):e.jsx(ke,{size:16})]}),p&&e.jsx("form",{onSubmit:f,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"text",placeholder:"Queue name",value:T,onChange:v=>j(v.target.value),maxLength:100,required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{placeholder:"Description (optional)",value:N,onChange:v=>o(v.target.value),maxLength:500,rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical"}}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:v=>{v.stopPropagation(),h(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:c.isPending||k,onClick:v=>v.stopPropagation(),children:c.isPending?"Creating...":"Create"})]})]})})]})})}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx("div",{className:"col",style:{gap:0},children:n?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No queues yet. Create one to get started!"}):t.map(v=>e.jsx(Yt,{queue:v},v.id))})})]})}function Jt({beatmapMeta:t,beatmapVersion:n}){const s=r.useRef(null),c=r.useRef(null),[l,p]=r.useState(!1),[h,T]=r.useState(!1),[j,N]=r.useState(0);r.useEffect(()=>{if(s.current&&c.current){const f=s.current.offsetWidth,v=c.current.scrollWidth;N(v),T(v>f)}},[t,n]);const o=t?e.jsxs(e.Fragment,{children:[t.artist," – ",t.title,t.mapper?` (by ${t.mapper})`:"",n?` [${n}]`:""]}):n?`[${n}]`:"Beatmap",k=j>0?Math.max(3,j/50):3;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),e.jsxs("div",{ref:s,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:h?"pointer":"default"},onMouseEnter:()=>h&&p(!0),onMouseLeave:()=>p(!1),children:[e.jsx("span",{ref:c,style:{display:"inline-block",animation:l&&h?`beatmap-marquee ${k}s linear infinite`:"none"},children:o}),l&&h&&e.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:o})]})]})}function st({submission:t,canManage:n,onUpdate:s,onDelete:c,isGroup:l=!1}){const[p,h]=r.useState(!1),[T,j]=r.useState(!1),[N,o]=r.useState(null),[k,f]=r.useState(t.beatmapset_id),[v,F]=r.useState(t.beatmap_id),[R,Q]=r.useState(!1),[S,M]=r.useState(!1),[q,U]=r.useState(null),[V,Z]=r.useState(!1),[z,ie]=r.useState(t.acknowledgments||[]),[x,E]=r.useState(t.acknowledged_by_me||!1),ae=r.useRef(null),B=r.useRef(null),g=r.useRef(null),{notify:y}=fe();r.useEffect(()=>{ie(t.acknowledgments||[]),E(t.acknowledged_by_me||!1)},[t.acknowledgments,t.acknowledged_by_me]),r.useEffect(()=>{if(t.beatmap_url)try{const i=new URL(t.beatmap_url),w=i.pathname.match(/\/beatmapsets\/(\d+)/);if(w&&!t.beatmapset_id){const se=Number(w[1]);isNaN(se)||f(se)}const G=i.hash.match(/#osu\/(\d+)/);if(G&&!t.beatmap_id){const se=Number(G[1]);isNaN(se)||F(se)}}catch(i){console.error("[QueueSubmission] Error parsing beatmap URL:",t.beatmap_url,i)}},[t.beatmap_url,t.beatmapset_id,t.beatmap_id,t.id]),r.useEffect(()=>{console.log("[QueueSubmission] Submission data:",{id:t.id,beatmap_url:t.beatmap_url,beatmapset_id:t.beatmapset_id,beatmap_id:t.beatmap_id,extracted_beatmapset_id:k,extracted_beatmap_id:v,beatmap_version:t.beatmap_version})},[t.id,k,v]),r.useEffect(()=>{if(!t.beatmap_url||N&&k)return;let i=!1;return(async()=>{try{console.log("[QueueSubmission] Fetching beatmap metadata...",{beatmap_url:t.beatmap_url,existing_beatmapset_id:t.beatmapset_id,existing_beatmap_id:t.beatmap_id});let w;try{w=new URL(t.beatmap_url)}catch(J){console.error("[QueueSubmission] Invalid beatmap URL:",t.beatmap_url,J);return}const G=w.hash.match(/#osu\/(\d+)/),se=G?G[1]:null;w.hash="";const $={url:w.toString()};if(se?$.beatmap_id=se:t.beatmap_id&&($.beatmap_id=String(t.beatmap_id)),console.log("[QueueSubmission] Resolving beatmap with params:",$),!i){const J=await C(_.osu.resolveBeatmap+dt($),{requireAuth:!1});console.log("[QueueSubmission] Beatmap resolve response:",J),J.setId&&!k&&(console.log("[QueueSubmission] Setting beatmapset_id from API:",J.setId),f(Number(J.setId))),(J.title||J.artist)&&o({title:J.title||null,artist:J.artist||null,mapper:J.mapper||null})}}catch(w){console.error("[QueueSubmission] Error fetching beatmap metadata:",w)}})(),()=>{i=!0}},[t.beatmap_url,t.beatmap_id,t.beatmapset_id,N,k]),r.useEffect(()=>{if(!R||!g.current){U(null);return}const i=()=>{if(g.current){const w=g.current.getBoundingClientRect();U({top:w.bottom+8,right:window.innerWidth-w.right})}};return i(),window.addEventListener("resize",i),window.addEventListener("scroll",i,!0),()=>{window.removeEventListener("resize",i),window.removeEventListener("scroll",i,!0)}},[R]),r.useEffect(()=>{if(!T)return;const i=w=>{const G=w.target;ae.current&&!ae.current.contains(G)&&!G.closest("[data-status-dropdown]")&&j(!1)};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[T]),r.useEffect(()=>{if(!R)return;const i=w=>{B.current&&!B.current.contains(w.target)&&g.current&&!g.current.contains(w.target)&&Q(!1)};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[R]);const b=async i=>{if(!p){h(!0);try{await C(_.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({status:i})});const w={...t,status:i,updated_at:Math.floor(Date.now()/1e3)};s&&s(w),y("Status updated",{variant:"success"})}catch{y("Failed to update status",{variant:"error"})}finally{h(!1),j(!1)}}},ee=async()=>{if(!p){h(!0);try{const i=!!t.is_archived;await C(_.moddi.queueSubmission(String(t.queue_id),t.id),{method:"PATCH",body:JSON.stringify({is_archived:!i})});const w={...t,is_archived:i?0:1,updated_at:Math.floor(Date.now()/1e3)};s&&s(w),y(i?"Unarchived":"Archived",{variant:"success"})}catch{y("Failed to update archive status",{variant:"error"})}finally{h(!1)}}},ue=async()=>{if(confirm("Are you sure you want to delete this submission? This action cannot be undone.")&&!p){h(!0);try{await C(_.moddi.queueSubmissionDelete(String(t.queue_id),t.id),{method:"DELETE"}),y("Submission deleted",{variant:"success"}),c&&c(t.id)}catch{y("Failed to delete submission",{variant:"error"})}finally{h(!1)}}},Y=async()=>{if(!V){Z(!0);try{if(x){if(await C(_.moddi.queueSubmissionUnacknowledge(String(t.queue_id),t.id),{method:"DELETE"}),E(!1),y("Unacknowledged",{variant:"info"}),s){const i={...t,acknowledged_by_me:!1};s(i)}}else if(await C(_.moddi.queueSubmissionAcknowledge(String(t.queue_id),t.id),{method:"POST"}),E(!0),y("Acknowledged",{variant:"success"}),s){const i={...t,acknowledged_by_me:!0};s(i)}}catch{y("Failed to update acknowledgment",{variant:"error"})}finally{Z(!1)}}},W={unchecked:"#f59e0b",accepted:"#10b981",denied:"#ef4444",finished:"#6366f1"},O={unchecked:"Pending",accepted:"Accepted",denied:"Denied",finished:"Finished"},ne=k||t.beatmapset_id,K=ne?`https://assets.ppy.sh/beatmaps/${ne}/covers/card.jpg`:null;r.useEffect(()=>{K?console.log("[QueueSubmission] Background image URL:",K,"for beatmapset_id:",ne):console.log("[QueueSubmission] No background image URL - beatmapset_id:",ne,"submission.beatmapset_id:",t.beatmapset_id)},[K,ne,t.beatmapset_id]);const te=!!t.is_archived;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{position:"relative",borderRadius:12,overflow:"hidden",borderBottom:"1px solid rgba(255,255,255,0.06)",background:K?"transparent":"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",opacity:te?.6:1},onMouseEnter:i=>{K||(i.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)")},onMouseLeave:i=>{K||(i.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)")},children:[K&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:K,alt:"",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover",opacity:.35,zIndex:0,pointerEvents:"none"},onError:i=>{i.currentTarget.style.display="none"}}),e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,background:"linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.75) 100%)",zIndex:0}})]}),e.jsx("div",{style:{position:"relative",zIndex:1,padding:"16px"},children:e.jsxs("div",{className:"row",style:{alignItems:"flex-start",justifyContent:"space-between",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[t.beatmap_url&&e.jsx("div",{style:{marginBottom:8},children:e.jsx(Jt,{beatmapMeta:N,beatmapVersion:t.beatmap_version})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,marginTop:8},children:[t.avatar_url&&e.jsx("img",{src:t.avatar_url,width:24,height:24,style:{borderRadius:"50%"},alt:t.username}),e.jsx("span",{style:{fontSize:13},children:t.username}),e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(t.created_at*1e3).toLocaleDateString()})]}),t.message&&e.jsx("div",{style:{marginTop:8,fontSize:13,lineHeight:1.5,color:"var(--text)"},children:t.message}),t.beatmap_url&&e.jsx("div",{style:{marginTop:12,display:"flex",alignItems:"center",gap:8},children:e.jsxs("button",{ref:g,className:"chip-btn link",onClick:i=>{i.preventDefault(),i.stopPropagation(),Q(w=>!w)},title:"Beatmap options","aria-label":"Beatmap options",style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 12px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:6,color:"var(--text)",fontSize:13,cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:i=>{i.currentTarget.style.background="rgba(255,255,255,0.1)",i.currentTarget.style.borderColor="rgba(255,255,255,0.2)"},onMouseLeave:i=>{i.currentTarget.style.background="rgba(255,255,255,0.05)",i.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[e.jsx($e,{size:14}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),e.jsx(ke,{size:12,style:{marginLeft:4,opacity:.7}})]})})]}),n?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[z&&z.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[z.slice(0,5).map((i,w)=>i.avatar_url?e.jsx("img",{src:i.avatar_url,alt:i.username,title:i.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",cursor:"pointer"}},i.user_id):e.jsx("div",{title:i.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:i.username.charAt(0).toUpperCase()},i.user_id)),z.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${z.length-5} more`,children:["+",z.length-5]})]}),e.jsx("button",{className:"icon-link",onClick:Y,disabled:V||p,title:x?"Unacknowledge":"Acknowledge",style:{color:x?"#10b981":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:x?"rgba(16, 185, 129, 0.1)":"transparent"},onMouseEnter:i=>{!V&&!p&&(i.currentTarget.style.background=x?"rgba(16, 185, 129, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:i=>{i.currentTarget.style.background=x?"rgba(16, 185, 129, 0.1)":"transparent"},children:e.jsx(St,{size:16})}),e.jsx("button",{className:"icon-link",onClick:ee,disabled:p,title:te?"Unarchive":"Archive",style:{color:te?"#6366f1":"var(--muted)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:te?"rgba(99, 102, 241, 0.1)":"transparent"},onMouseEnter:i=>{p||(i.currentTarget.style.background=te?"rgba(99, 102, 241, 0.2)":"rgba(255,255,255,0.05)")},onMouseLeave:i=>{i.currentTarget.style.background=te?"rgba(99, 102, 241, 0.1)":"transparent"},children:te?e.jsx(wt,{size:16}):e.jsx(Nt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:ue,disabled:p,title:"Delete submission",style:{color:"var(--danger)",width:"auto",height:"auto",padding:"6px",borderRadius:6,transition:"all 0.2s ease",background:"transparent"},onMouseEnter:i=>{p||(i.currentTarget.style.background="rgba(239, 68, 68, 0.1)")},onMouseLeave:i=>{i.currentTarget.style.background="transparent"},children:e.jsx(_e,{size:16})}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("button",{ref:ae,onClick:()=>j(!T),disabled:p,style:{display:"inline-flex",alignItems:"center",gap:6,padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:W[t.status]+"15",border:`1.5px solid ${W[t.status]}50`,color:W[t.status],whiteSpace:"nowrap",cursor:p?"not-allowed":"pointer",transition:"all 0.2s ease",opacity:p?.6:1},onMouseEnter:i=>{p||(i.currentTarget.style.background=W[t.status]+"25",i.currentTarget.style.borderColor=W[t.status]+"70",i.currentTarget.style.transform="translateY(-1px)")},onMouseLeave:i=>{i.currentTarget.style.background=W[t.status]+"15",i.currentTarget.style.borderColor=W[t.status]+"50",i.currentTarget.style.transform="translateY(0)"},children:[e.jsx("span",{children:O[t.status]}),e.jsx(ke,{size:14,style:{marginLeft:2,transition:"transform 0.2s ease",transform:T?"rotate(180deg)":"rotate(0deg)"}})]}),T&&ae.current&&Oe.createPortal(e.jsx("div",{"data-status-dropdown":!0,style:{position:"fixed",background:"var(--panel)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:6,zIndex:1e4,minWidth:140,boxShadow:"0 8px 24px rgba(0,0,0,0.4)",...(()=>{const i=ae.current.getBoundingClientRect();return{top:i.bottom+6,right:window.innerWidth-i.right}})()},onClick:i=>i.stopPropagation(),children:["unchecked","accepted","denied","finished"].map(i=>e.jsx("button",{onClick:()=>b(i),style:{display:"block",width:"100%",padding:"8px 12px",borderRadius:6,fontSize:13,fontWeight:i===t.status?600:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",textAlign:"left",background:i===t.status?W[i]+"15":"transparent",color:i===t.status?W[i]:"var(--text)",border:"none",cursor:"pointer",transition:"all 0.15s ease",marginBottom:2},onMouseEnter:w=>{i!==t.status&&(w.currentTarget.style.background="rgba(255,255,255,0.05)")},onMouseLeave:w=>{i!==t.status&&(w.currentTarget.style.background="transparent")},children:O[i]},i))}),document.body)]})]}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[z&&z.length>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",marginRight:4},children:[z.slice(0,5).map((i,w)=>i.avatar_url?e.jsx("img",{src:i.avatar_url,alt:i.username,title:i.username,width:24,height:24,style:{borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",cursor:"pointer"}},i.user_id):e.jsx("div",{title:i.username,style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:w>0?-8:0,zIndex:z.length-w,position:"relative",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",cursor:"pointer"},children:i.username.charAt(0).toUpperCase()},i.user_id)),z.length>5&&e.jsxs("div",{style:{width:24,height:24,borderRadius:"50%",border:"2px solid var(--panel)",marginLeft:-8,background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"var(--text)",zIndex:0,position:"relative"},title:`+${z.length-5} more`,children:["+",z.length-5]})]}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",padding:"8px 14px",borderRadius:8,fontSize:13,fontWeight:600,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",background:W[t.status]+"15",border:`1.5px solid ${W[t.status]}50`,color:W[t.status],whiteSpace:"nowrap"},children:O[t.status]})]})]})})]}),R&&q&&t.beatmap_url&&e.jsxs("div",{ref:B,style:{position:"fixed",top:q.top,right:q.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[e.jsxs("a",{className:"menu-item",href:t.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>Q(!1),children:[e.jsx($e,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),ne&&e.jsx("button",{className:"menu-item",onClick:()=>{M(!0),Q(!1)},children:"Preview"})]}),S&&ne&&e.jsx(ut,{open:S,onClose:()=>M(!1),downloadUrl:`${It}${_.osu.downloadBeatmapset(ne)}`,beatmapId:v??t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0})]})}function Xt({queueId:t,onSubmitted:n}){const[s,c]=pe.useState(!1),[l,p]=pe.useState(t),[h,T]=pe.useState(""),[j,N]=pe.useState(""),[o,k]=pe.useState(!1),{notify:f}=fe(),{data:v=[]}=We();pe.useEffect(()=>{p(t)},[t]);const F=async()=>{if(!l){f("Please select a queue",{variant:"error"});return}if(!h.trim()){f("Beatmap URL is required",{variant:"error"});return}k(!0);try{await C(_.moddi.queueSubmit(l),{method:"POST",body:JSON.stringify({beatmap_url:h.trim(),message:j.trim()||null})}),f("Submission created!",{variant:"success"}),T(""),N(""),c(!1),n==null||n()}catch(R){f((R==null?void 0:R.message)||"Failed to create submission",{variant:"error"})}finally{k(!1)}};return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Submit to queue",title:"Submit to queue",onClick:()=>c(!0),children:e.jsx(qe,{size:22})}),e.jsx(Pe,{open:s,onClose:()=>c(!1),children:e.jsxs("div",{className:"col",style:{gap:12},children:[!t&&e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Queue:"}),e.jsxs("select",{value:l??"",onChange:R=>p(R.target.value||void 0),style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",fontSize:13},children:[e.jsx("option",{value:"",disabled:!0,children:"Select queue"}),v.map(R=>e.jsx("option",{value:String(R.id),children:R.name},R.id))]})]}),e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:h,onChange:R=>T(R.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:j,onChange:R=>N(R.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),j.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[j.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>c(!1),children:"Cancel"}),e.jsx("button",{type:"button",className:"btn",disabled:o,onClick:F,children:o?"Submitting...":"Submit"})]})]})})]})}const at=({content:t})=>e.jsx("div",{style:{fontSize:13,lineHeight:1.6,color:"var(--text)"},children:e.jsx(Ct,{components:{p:({children:n})=>e.jsx("p",{style:{margin:"0 0 8px 0"},children:n}),ul:({children:n})=>e.jsx("ul",{style:{margin:"0 0 8px 0",paddingLeft:20},children:n}),ol:({children:n})=>e.jsx("ol",{style:{margin:"0 0 8px 0",paddingLeft:20},children:n}),li:({children:n})=>e.jsx("li",{style:{margin:"0 0 4px 0"},children:n}),strong:({children:n})=>e.jsx("strong",{style:{fontWeight:600},children:n}),em:({children:n})=>e.jsx("em",{children:n}),code:({children:n})=>e.jsx("code",{style:{background:"rgba(255,255,255,0.1)",padding:"2px 4px",borderRadius:4,fontSize:12},children:n}),h1:({children:n})=>e.jsx("h1",{style:{fontSize:18,fontWeight:700,margin:"0 0 8px 0"},children:n}),h2:({children:n})=>e.jsx("h2",{style:{fontSize:16,fontWeight:700,margin:"0 0 8px 0"},children:n}),h3:({children:n})=>e.jsx("h3",{style:{fontSize:14,fontWeight:600,margin:"0 0 8px 0"},children:n})},children:t})});function os(){const{id:t}=rt(),n=De(),[s,c]=r.useState(null),[l,p]=r.useState([]),[h,T]=r.useState([]),[j,N]=r.useState(!0),[o,k]=r.useState(null),[f,v]=r.useState(!1),[F,R]=r.useState(!1),[Q,S]=r.useState(""),[M,q]=r.useState(""),[U,V]=r.useState(null),[Z,z]=r.useState(!1),[ie,x]=r.useState(""),[E,ae]=r.useState(""),[B,g]=r.useState(""),[y,b]=r.useState(!1),[ee,ue]=r.useState(!1),[Y,W]=r.useState("general"),[O,ne]=r.useState(!1),[K,te]=r.useState(!1),[i,w]=r.useState(null),[G,se]=r.useState(""),[D,$]=r.useState([]),[J,le]=r.useState(!1),ge=r.useRef(null),ce=r.useRef(null),xe=r.useRef(null),[ve,ze]=r.useState([]),[je,Ie]=r.useState(!1),[Se,we]=r.useState(null),{notify:u}=fe(),{queueStatusFilters:P}=Ue(),I=async()=>{var a,m;if(t){N(!0);try{const d=await C(_.moddi.queue(t),{requireAuth:!1});c(d.queue||null),p(d.members||[]),T(d.submissions||[])}catch(d){(a=d==null?void 0:d.message)!=null&&a.includes("403")||(m=d==null?void 0:d.message)!=null&&m.includes("Forbidden")?(u("You do not have access to this queue",{variant:"error"}),n("/md/queues")):u("Failed to load queue",{variant:"error"})}finally{N(!1)}}};r.useEffect(()=>{I(),C(_.auth.me,{requireAuth:!1}).then(a=>k(a)).catch(()=>{})},[t]);const L=o&&s&&(s.owner_id===o.id||l.some(a=>a.user_id===o.id&&a.joined_at));o&&l.some(a=>a.user_id===o.id&&a.joined_at);const de=o&&s&&(s.owner_id===o.id||l.some(a=>a.user_id===o.id&&a.joined_at)),H=async a=>{if(a.preventDefault(),!s||s.is_open===0){u("Queue is closed for submissions",{variant:"error"});return}if(!Q.trim()){u("Beatmap URL is required",{variant:"error"});return}R(!0);try{await C(_.moddi.queueSubmit(t),{method:"POST",body:JSON.stringify({beatmap_url:Q.trim(),message:M.trim()||null})}),u("Submission created!",{variant:"success"}),v(!1),S(""),q(""),I()}catch(m){u((m==null?void 0:m.message)||"Failed to create submission",{variant:"error"})}finally{R(!1)}},oe=a=>{T(m=>m.map(d=>d.id===a.id?a:d)),a.acknowledged_by_me!==void 0&&I()},Fe=()=>{s&&(x(s.name),ae(s.description||""),g(s.rules||""),z(!0),W("general"))},X=()=>{z(!1),x(""),ae(""),g("")},he=async()=>{if(!(!s||!de)){ue(!0);try{const a=s.is_open!==1;await C(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_open:a})}),u(`Queue ${a?"opened":"closed"}`,{variant:"success"}),I()}catch(a){u((a==null?void 0:a.message)||"Failed to update status",{variant:"error"})}finally{ue(!1)}}},Ee=async a=>{if(a.preventDefault(),!s||!ie.trim()){u("Queue name is required",{variant:"error"});return}ne(!0);try{const m=l.filter(d=>d.user_id!==s.owner_id&&d.role!=="owner").length>0;await C(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({name:ie.trim(),description:E.trim()||null,rules:B.trim()||null,is_group:m})}),u("Queue updated!",{variant:"success"}),X(),I()}catch(m){u((m==null?void 0:m.message)||"Failed to update queue",{variant:"error"})}finally{ne(!1)}};r.useEffect(()=>{if(!G.trim()){$([]),le(!1);return}const a=setTimeout(async()=>{try{const d=(await C(_.moddi.usersSearch(G),{requireAuth:!1})).items||[];$(d),le(d.length>0)}catch(m){console.error("Search failed:",m),$([]),le(!1)}},300);return()=>clearTimeout(a)},[G]);const me=async a=>{if(!K){te(!0);try{await C(_.moddi.queueInvite(t),{method:"POST",body:JSON.stringify({user_id:a})}),u("Invite sent!",{variant:"success"}),se(""),$([]),le(!1),I()}catch(m){u((m==null?void 0:m.message)||"Failed to invite member",{variant:"error"})}finally{te(!1)}}},ye=async()=>{if(!(!t||!L))try{const a=await C(_.moddi.queueBlockedUsers(t));ze(a.blocked||[])}catch(a){console.error("Failed to load blocked users:",a)}},Ae=async a=>{if(!(!t||je)&&confirm("Block this user from submitting to this queue?")){Ie(!0);try{await C(_.moddi.queueBlockUser(t),{method:"POST",body:JSON.stringify({user_id:a})}),u("User blocked",{variant:"success"}),ye(),se(""),$([]),le(!1)}catch(m){u((m==null?void 0:m.message)||"Failed to block user",{variant:"error"})}finally{Ie(!1)}}},Qe=async a=>{if(!(!t||Se===a)){we(a);try{await C(_.moddi.queueUnblockUser(t,a),{method:"DELETE"}),u("User unblocked",{variant:"success"}),ye()}catch(m){u((m==null?void 0:m.message)||"Failed to unblock user",{variant:"error"})}finally{we(null)}}};r.useEffect(()=>{Y==="members"&&L&&t&&ye()},[Y,L,t]);const gt=async()=>{if(s&&confirm(`Are you sure you want to delete "${s.name}"? This action cannot be undone.`)){b(!0);try{await C(_.moddi.queue(t),{method:"DELETE"}),u("Queue deleted",{variant:"success"}),n("/md/queues")}catch(a){u((a==null?void 0:a.message)||"Failed to delete queue",{variant:"error"})}finally{b(!1)}}},ht=async a=>{if(!o||!s||o.id!==s.owner_id){u("Only the queue owner can remove members",{variant:"error"});return}if(confirm("Remove this member from the queue?")){w(a);try{await C(_.moddi.queueMember(t,a),{method:"DELETE"}),u("Member removed",{variant:"success"});const d=l.filter(A=>A.user_id!==a).some(A=>A.user_id!==(s==null?void 0:s.owner_id)&&A.role!=="owner");if(s&&s.is_group===1&&!d)try{await C(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after removing last member")}I()}catch(m){u((m==null?void 0:m.message)||"Failed to remove member",{variant:"error"})}finally{w(null)}}},ft=async()=>{if(o&&confirm("Leave this queue? You will need to be invited again to rejoin.")){w(o.id);try{await C(_.moddi.queueMember(t,o.id),{method:"DELETE"}),u("Left queue",{variant:"success"});const m=l.filter(d=>d.user_id!==o.id).some(d=>d.user_id!==(s==null?void 0:s.owner_id)&&d.role!=="owner");if(s&&s.is_group===1&&!m)try{await C(_.moddi.queue(t),{method:"PATCH",body:JSON.stringify({is_group:!1})})}catch{console.warn("Failed to convert queue back to individual after leaving")}n("/md/queues")}catch(a){u((a==null?void 0:a.message)||"Failed to leave queue",{variant:"error"})}finally{w(null)}}},xt=async a=>{if(confirm("Cancel this invitation?")){w(a);try{await C(_.moddi.queueMember(t,a),{method:"DELETE"}),u("Invitation canceled",{variant:"success"}),I()}catch(m){u((m==null?void 0:m.message)||"Failed to cancel invitation",{variant:"error"})}finally{w(null)}}};return r.useEffect(()=>{if(!Z)return;const a=m=>{const d=m.target;d.closest(".manage-overlay")||d.closest(".manage-overlay-backdrop")||!d.closest(".manage-popup")&&xe.current&&!xe.current.contains(d)&&X()};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[Z]),r.useEffect(()=>{if(!J)return;const a=m=>{const d=m.target;ge.current&&!ge.current.contains(d)&&ce.current&&!ce.current.contains(d)&&le(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[J]),j?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):s?e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t&&e.jsx(Xt,{queueId:t,onSubmitted:()=>I()}),e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:12,marginBottom:16,paddingTop:16},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flex:1,minWidth:0},children:[e.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>n("/md/queues"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(it,{size:20})}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:10,flex:1,minWidth:0},children:[e.jsx("div",{className:"title",style:{flex:1,minWidth:0},children:s.name}),de&&e.jsxs("button",{onClick:he,disabled:ee,className:`queue-status-badge ${s.is_open===1?"status-open":"status-closed"}`,title:s.is_open===1?"Close queue":"Open queue","aria-label":s.is_open===1?"Close queue":"Open queue",children:[s.is_open===1?e.jsx(Be,{size:14}):e.jsx(He,{size:14}),e.jsx("span",{children:s.is_open===1?"Open":"Closed"})]})]})]}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[L&&e.jsx("button",{ref:xe,className:"icon-link",onClick:Fe,style:{width:"auto",height:"auto",padding:"4px"},title:"Manage Queue","aria-label":"Manage Queue",children:e.jsx(kt,{size:18})}),l.length>0&&e.jsx("div",{style:{display:"flex",alignItems:"center",gap:6},children:l.filter(a=>a.joined_at!==null).sort((a,m)=>{const d=a.role==="owner"||a.user_id===(s==null?void 0:s.owner_id),A=m.role==="owner"||m.user_id===(s==null?void 0:s.owner_id);return d&&!A?-1:!d&&A?1:(m.joined_at||0)-(a.joined_at||0)}).map(a=>e.jsxs("div",{style:{position:"relative"},onMouseEnter:()=>V(a.user_id),onMouseLeave:()=>V(null),children:[e.jsx(ot,{to:`/profile/${a.user_id}`,className:"queue-member-avatar",title:a.username,children:a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:a.username}):e.jsx("div",{style:{width:"100%",height:"100%",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,color:"var(--muted)"},children:a.username.charAt(0).toUpperCase()})}),U===a.user_id&&e.jsxs("div",{className:"queue-member-tooltip",children:[a.username," ",a.role!=="member"?`(${a.role})`:""]})]},a.user_id))})]})]}),s.description&&e.jsx("div",{className:"muted",style:{marginBottom:16,fontSize:14,padding:"0 4px"},children:s.description}),s.rules&&e.jsxs("div",{style:{marginBottom:16,padding:12,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10},children:[e.jsx("div",{style:{fontSize:14,fontWeight:600,marginBottom:8},children:"Rules"}),e.jsx(at,{content:s.rules})]}),s.is_open===0&&e.jsx("div",{style:{marginBottom:12,padding:10,background:"rgba(245, 158, 11, 0.1)",border:"1px solid rgba(245, 158, 11, 0.3)",borderRadius:10,textAlign:"center",fontSize:14,color:"#f59e0b"},children:"This queue is currently closed for submissions"}),e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:12,opacity:s.is_open===0?.6:1},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:s.is_open===1?"pointer":"not-allowed",padding:"8px 12px",minHeight:36},onClick:()=>s.is_open===1&&v(!f),children:[e.jsxs("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:["Submit a beatmap ",s.is_open===0&&"(Closed)"]}),s.is_open===1&&(f?e.jsx(Me,{size:16}):e.jsx(qe,{size:16}))]}),f&&e.jsx("form",{onSubmit:H,style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("input",{type:"url",placeholder:"Beatmap URL e.g. https://osu.ppy.sh/beatmapsets/...",value:Q,onChange:a=>S(a.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),e.jsx("input",{type:"text",placeholder:"Message (optional, max 100 chars)",value:M,onChange:a=>q(a.target.value.slice(0,100)),maxLength:100,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),M.length>0&&e.jsxs("div",{className:"muted",style:{fontSize:12,textAlign:"right",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[M.length,"/100"]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:a=>{a.stopPropagation(),v(!1)},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:F,onClick:a=>a.stopPropagation(),children:F?"Submitting...":"Submit"})]})]})})]}),e.jsxs("div",{className:"profile-tabs-unified",style:{marginTop:24},children:[e.jsxs("div",{className:"profile-tabs-header",role:"tablist","aria-label":"Submission sections",children:[e.jsx("button",{role:"tab","aria-selected":!0,className:"profile-tab active","data-tab":"active",onClick:a=>{const m=a.currentTarget.closest(".profile-tabs-unified");m.querySelectorAll(".profile-tab").forEach(A=>{A.classList.remove("active"),A.setAttribute("aria-selected","false")}),a.currentTarget.classList.add("active"),a.currentTarget.setAttribute("aria-selected","true"),m.querySelector(".profile-tabs-content").setAttribute("data-active","active")},children:"Active"}),e.jsx("button",{role:"tab","aria-selected":!1,className:"profile-tab","data-tab":"archived",onClick:a=>{const m=a.currentTarget.closest(".profile-tabs-unified");m.querySelectorAll(".profile-tab").forEach(A=>{A.classList.remove("active"),A.setAttribute("aria-selected","false")}),a.currentTarget.classList.add("active"),a.currentTarget.setAttribute("aria-selected","true"),m.querySelector(".profile-tabs-content").setAttribute("data-active","archived")},children:"Archived"})]}),e.jsxs("div",{className:"profile-tabs-content","data-active":"active",children:[e.jsx("div",{className:"panel active",children:e.jsx("div",{className:"col",style:{gap:0},children:h.filter(a=>!!!a.is_archived&&P[a.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No active submissions."}):h.filter(a=>!!!a.is_archived&&P[a.status]).map(a=>e.jsx(st,{submission:a,canManage:!!L,isGroup:(s==null?void 0:s.is_group)===1,onUpdate:oe,onDelete:m=>{T(d=>d.filter(A=>A.id!==m))}},a.id))})}),e.jsx("div",{className:"panel archived",children:e.jsx("div",{className:"col",style:{gap:0},children:h.filter(a=>!!a.is_archived&&P[a.status]).length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No archived submissions."}):h.filter(a=>!!a.is_archived&&P[a.status]).map(a=>e.jsx(st,{submission:a,canManage:!!L,isGroup:(s==null?void 0:s.is_group)===1,onUpdate:oe,onDelete:m=>{T(d=>d.filter(A=>A.id!==m))}},a.id))})})]})]}),Z&&Oe.createPortal(e.jsxs("div",{className:"overlay manage-overlay",children:[e.jsx("div",{className:"overlay-backdrop manage-overlay-backdrop",onClick:X}),e.jsxs("div",{className:"overlay-card",style:{maxWidth:500},children:[e.jsx("button",{className:"overlay-close",onClick:X,"aria-label":"Close",children:e.jsx(Me,{size:18})}),e.jsxs("div",{className:"col",style:{gap:0,padding:"0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:16,padding:"20px 16px 12px",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("div",{className:"title",style:{fontSize:20,margin:0,padding:0,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Manage Queue"}),e.jsxs("div",{className:"tabs",role:"tablist",style:{margin:0},children:[e.jsx("button",{role:"tab","aria-selected":Y==="general",className:`tab ${Y==="general"?"active":""}`,onClick:()=>W("general"),children:"General"}),e.jsx("button",{role:"tab","aria-selected":Y==="rules",className:`tab ${Y==="rules"?"active":""}`,onClick:()=>W("rules"),children:"Rules"}),e.jsx("button",{role:"tab","aria-selected":Y==="members",className:`tab ${Y==="members"?"active":""}`,onClick:()=>W("members"),children:"Members"})]})]}),e.jsx("hr",{className:"subtle-divider",style:{margin:"0 16px"}}),e.jsxs("form",{onSubmit:Ee,className:"col",style:{gap:0,padding:"16px"},children:[Y==="general"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Queue Name"}),e.jsx("input",{type:"text",value:ie,onChange:a=>x(a.target.value),required:!0,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}})]}),e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Description (optional)"}),e.jsx("textarea",{placeholder:"Description",value:E,onChange:a=>ae(a.target.value),rows:3,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14,resize:"vertical"}})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"space-between",alignItems:"center",marginTop:8},children:[e.jsxs("button",{type:"button",className:"btn secondary",onClick:gt,disabled:y||O,style:{background:"rgba(248, 113, 113, 0.1)",borderColor:"rgba(248, 113, 113, 0.3)",color:"var(--danger)",fontSize:13,padding:"8px 12px"},children:[e.jsx(_e,{size:14,style:{marginRight:6}}),y?"Deleting...":"Delete Queue"]}),e.jsxs("div",{className:"row",style:{gap:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:X,disabled:O||y,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:O||y,style:{fontSize:13,padding:"8px 16px"},children:O?"Updating...":"Save Changes"})]})]})]}),Y==="rules"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Rules (optional, markdown supported)"}),e.jsx("textarea",{placeholder:"Rules in markdown format...",value:B,onChange:a=>g(a.target.value),rows:8,style:{background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:13,resize:"vertical"}}),B&&e.jsxs("div",{style:{padding:10,background:"var(--panel-dark)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,fontSize:12},children:[e.jsx("div",{style:{fontSize:12,fontWeight:600,marginBottom:6,opacity:.8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Preview:"}),e.jsx(at,{content:B})]})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:X,disabled:O||y,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:O||y,style:{fontSize:13,padding:"8px 16px"},children:O?"Updating...":"Save Changes"})]})]}),Y==="members"&&e.jsxs("div",{className:"col",style:{gap:10},children:[e.jsxs("div",{className:"col",style:{gap:6,position:"relative"},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invite Members"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{ref:ge,type:"text",placeholder:"Search username or ID",value:G,onChange:a=>se(a.target.value),onKeyDown:a=>{a.key==="Enter"&&a.preventDefault()},onFocus:()=>{D.length>0&&le(!0)},style:{width:"100%",background:"var(--bg)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:10,color:"var(--text)",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif",fontSize:14}}),J&&D.length>0&&e.jsx("div",{ref:ce,style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:8,maxHeight:300,overflowY:"auto",zIndex:1e3,boxShadow:"0 4px 12px rgba(0,0,0,0.3)"},children:e.jsx("div",{className:"col",style:{gap:0},children:D.map(a=>{const m=l.some(re=>re.user_id===a.id&&re.joined_at),d=l.some(re=>re.user_id===a.id&&re.invited_at&&!re.joined_at),A=ve.some(re=>re.user_id===a.id);return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"8px 12px"},children:[e.jsxs("div",{style:{flex:1,display:"flex",alignItems:"center",gap:8,minWidth:0},children:[a.avatar_url&&e.jsx("img",{src:a.avatar_url,width:20,height:20,style:{borderRadius:"50%",flexShrink:0}}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{fontSize:13,fontWeight:500,display:"flex",alignItems:"center",gap:8,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:[e.jsx("span",{children:a.username}),m&&e.jsx("span",{style:{color:"var(--muted)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Already a member"}),d&&e.jsx("span",{style:{color:"var(--accent)",fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]}),e.jsxs("div",{className:"muted",style:{fontSize:11,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["id ",a.id," • osu ",a.osu_user_id]})]})]}),L&&!m&&!d&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsx("button",{className:"icon-link",onClick:re=>{re.stopPropagation(),K||me(a.id)},disabled:K,title:"Invite user",style:{width:"auto",height:"auto",padding:"4px"},children:e.jsx(lt,{size:16})}),e.jsx("button",{className:"icon-link",onClick:re=>{re.stopPropagation(),A?Qe(a.id):Ae(a.id)},disabled:je||Se===a.id,title:A?"Unblock user":"Block user",style:{width:"auto",height:"auto",padding:"4px",color:A?"var(--accent)":"var(--danger)"},children:A?e.jsx(Be,{size:16}):e.jsx(He,{size:16})})]})]},a.id)})})})]})]}),l.length>0&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Members"}),e.jsx("div",{className:"col",style:{gap:4},children:(()=>{const a=l.filter(d=>d.joined_at!==null).sort((d,A)=>{const re=d.role==="owner"||d.user_id===(s==null?void 0:s.owner_id),Re=A.role==="owner"||A.user_id===(s==null?void 0:s.owner_id);return re&&!Re?-1:!re&&Re?1:(A.joined_at||0)-(d.joined_at||0)}),m=l.filter(d=>d.invited_at!==null&&d.joined_at===null);return e.jsxs(e.Fragment,{children:[a.map(d=>{const A=o&&s&&o.id===s.owner_id,re=d.user_id===(o==null?void 0:o.id),Re=d.user_id===(s==null?void 0:s.owner_id)||d.role==="owner";return e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[d.avatar_url&&e.jsx("img",{src:d.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:d.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:d.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:d.role})]})]}),A&&!Re&&e.jsx("button",{className:"icon-link",onClick:()=>ht(d.user_id),disabled:i===d.user_id,title:"Remove member",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(_e,{size:16})}),!A&&re&&e.jsx("button",{className:"icon-link",onClick:ft,disabled:i===d.user_id,title:"Leave queue",style:{width:"auto",height:"auto",padding:"4px",color:"var(--muted)"},children:e.jsx(_t,{size:16})})]},d.user_id)}),m.length>0&&e.jsx(e.Fragment,{children:m.map(d=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",opacity:.7},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[d.avatar_url&&e.jsx("img",{src:d.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:d.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:d.username}),e.jsx("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Invited"})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>xt(d.user_id),disabled:i===d.user_id,title:"Cancel invitation",style:{width:"auto",height:"auto",padding:"4px",color:"var(--danger)"},children:e.jsx(Me,{size:16})})]},d.user_id))})]})})()})]}),L&&e.jsxs("div",{className:"col",style:{gap:6},children:[e.jsx("label",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"Blocked Users"}),ve.length===0?e.jsx("div",{className:"muted",style:{fontSize:12,padding:"8px 0",fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:"No blocked users"}):e.jsx("div",{className:"col",style:{gap:4},children:ve.map(a=>e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0"},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flex:1,minWidth:0},children:[a.avatar_url&&e.jsx("img",{src:a.avatar_url,width:32,height:32,style:{borderRadius:"50%"},alt:a.username}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("div",{style:{fontSize:14,fontWeight:500,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:a.username}),a.blocked_by_username&&e.jsxs("div",{className:"muted",style:{fontSize:12,fontFamily:"'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif"},children:["Blocked by ",a.blocked_by_username]})]})]}),e.jsx("button",{className:"icon-link",onClick:()=>Qe(a.user_id),disabled:Se===a.user_id,title:"Unblock user",style:{width:"auto",height:"auto",padding:"4px",color:"var(--accent)"},children:e.jsx(Be,{size:16})})]},a.user_id))})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end",marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:X,disabled:O||y,style:{fontSize:13,padding:"8px 16px"},children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn",disabled:O||y,style:{fontSize:13,padding:"8px 16px"},children:O?"Updating...":"Save Changes"})]})]})]})]})]})]}),document.body),e.jsx("style",{children:`
        .queue-member-avatar {
          width: 32px;
          height: 32px;
          border-radius: 9999px;
          padding: 0;
          border: 1px solid rgba(255,255,255,0.08);
          overflow: hidden;
          cursor: pointer;
          background: transparent;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          text-decoration: none;
          transition: border-color 0.2s;
        }
        .queue-member-avatar:hover {
          border-color: rgba(167, 139, 250, 0.4);
        }
        .queue-member-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
        }
        .queue-member-tooltip {
          position: absolute;
          bottom: calc(100% + 8px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(18, 20, 24, 0.95);
          color: var(--text, #e5e7eb);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 6px;
          padding: 6px 10px;
          font-size: 14px;
          white-space: nowrap;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          pointer-events: none;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
        }
        .queue-member-tooltip::after {
          content: '';
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-top: 5px solid rgba(18, 20, 24, 0.95);
        }
        .queue-status-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
          font-family: 'Torus Pro', Torus, ui-sans-serif, system-ui, sans-serif;
          border: 1px solid;
          cursor: pointer;
          transition: all 0.2s;
          white-space: nowrap;
        }
        .queue-status-badge:disabled {
          cursor: not-allowed;
          opacity: 0.6;
        }
        .queue-status-badge.status-open {
          background: rgba(52, 211, 153, 0.15);
          border-color: rgba(52, 211, 153, 0.4);
          color: #34d399;
        }
        .queue-status-badge.status-open:hover:not(:disabled) {
          background: rgba(52, 211, 153, 0.25);
          border-color: rgba(52, 211, 153, 0.5);
        }
        .queue-status-badge.status-closed {
          background: rgba(245, 158, 11, 0.15);
          border-color: rgba(245, 158, 11, 0.4);
          color: #f59e0b;
        }
        .queue-status-badge.status-closed:hover:not(:disabled) {
          background: rgba(245, 158, 11, 0.25);
          border-color: rgba(245, 158, 11, 0.5);
        }
      `})]}):e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Queue not found"})}function ls(){const{data:t=[],isLoading:n}=Ot(),s=Dt(),c=Ut(),{notify:l}=fe(),p=De(),h=be(),[T,j]=r.useState(new Set),{data:N}=Te(),[o,k]=r.useState(!1),[f,v]=r.useState(!1),[F,R]=r.useState(!1),Q=r.useRef(null),S=r.useRef(null),M=!!(N!=null&&N.is_admin||N!=null&&N.is_mod);Wt(Q,S,o,()=>k(!1));const q=async g=>{s.mutate(g,{onSuccess:()=>{}})},U=async g=>{g.startsWith("n:")&&c.mutate(g)},V=async()=>{const g=t.filter(y=>!y.read&&(y.id.startsWith("n:")||y.kind==="system"&&!y.id.startsWith("b:"))).map(y=>y.id);g.length>0&&(await q(g),l("All notifications marked as read",{variant:"success"}))},Z=g=>{if(!g)return null;try{const y=JSON.parse(g);if((y==null?void 0:y.type)==="queue_invite"&&(y!=null&&y.queue_id))return y}catch{}return null},z=async(g,y)=>{if(!T.has(g.id)){j(b=>new Set(b).add(g.id));try{await C(_.moddi.queueAccept(String(y)),{method:"POST"}),l("Invitation accepted!",{variant:"success"}),U(g.id),p(`/md/queues/${y}`)}catch(b){l((b==null?void 0:b.message)||"Failed to accept invitation",{variant:"error"})}finally{j(b=>{const ee=new Set(b);return ee.delete(g.id),ee})}}},ie=async(g,y)=>{if(!T.has(g.id)){j(b=>new Set(b).add(g.id));try{await C(_.moddi.queueDeny(String(y)),{method:"POST"}),l("Invitation declined",{variant:"success"}),U(g.id)}catch(b){l((b==null?void 0:b.message)||"Failed to decline invitation",{variant:"error"})}finally{j(b=>{const ee=new Set(b);return ee.delete(g.id),ee})}}},x=g=>Z(g.text)?e.jsx(lt,{size:20,color:"#a78bfa"}):g.kind==="star"?e.jsx(Je,{size:20,color:"#f59e0b"}):g.kind==="likes5"?e.jsx(Xe,{size:20,color:"#f472b6"}):g.kind==="comment"?e.jsx(Ne,{size:20,color:"#60a5fa"}):g.kind==="inspiration"?e.jsx(Ne,{size:20,color:"#7dd3fc"}):g.kind==="reaction"?e.jsx(Ge,{size:20,color:"#10b981"}):g.id.startsWith("b:")?e.jsx(Ve,{size:20,color:"#a78bfa"}):null,E=g=>Z(g.text)?"Queue Invitation":g.kind==="star"?"Star":g.kind==="likes5"?"Likes":g.kind==="comment"?"Comment":g.kind==="inspiration"?"Inspiration":g.kind==="reaction"?"Reaction":g.id.startsWith("b:")?"Global":"System",ae=t.filter(g=>!g.read&&!(g.id.startsWith("b:")&&g.expiresAt&&g.expiresAt<=Date.now())).length,B=async g=>{if(!(!(N!=null&&N.id)||F)){R(!0);try{const y={kind:g};g==="system"&&(y.text="Test system notification"),await C(_.admin.notificationsTest,{method:"POST",body:JSON.stringify(y)}),l("Test notification sent!",{variant:"success"}),h.invalidateQueries({queryKey:["notifications","detailed"]}),h.invalidateQueries({queryKey:["notifications"]})}catch(y){l((y==null?void 0:y.message)||"Failed to send test notification",{variant:"error"})}finally{R(!1),k(!1),v(!1)}}};return e.jsxs("div",{className:"feed-container moddi-feed",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsx("div",{className:"feed-header",children:e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[e.jsx("div",{className:"title",children:"Notifications"}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[M&&e.jsxs("div",{style:{position:"relative"},className:"hide-on-mobile",children:[e.jsxs("button",{ref:Q,className:"btn secondary",onClick:()=>k(!o),disabled:F,style:{display:"inline-flex",alignItems:"center",gap:6},children:[e.jsx(Ye,{size:14}),e.jsx("span",{children:"Test"}),e.jsx(ke,{size:14,style:{transition:"transform 0.2s ease",transform:o?"rotate(180deg)":"rotate(0deg)"}})]}),o&&e.jsxs("div",{ref:S,className:"menu-panel",role:"menu",style:{position:"absolute",top:"100%",right:0,marginTop:8,minWidth:180,zIndex:1e3},children:[e.jsx("button",{className:"menu-item",type:"button",onClick:()=>B("star"),disabled:F,children:"Test Star"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>B("likes5"),disabled:F,children:"Test Likes"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>B("comment"),disabled:F,children:"Test Comment"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>B("inspiration"),disabled:F,children:"Test Inspiration"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>B("reaction"),disabled:F,children:"Test Reaction"}),e.jsx("button",{className:"menu-item",type:"button",onClick:()=>B("system"),disabled:F,children:"Test System"})]})]}),ae>0&&e.jsxs("button",{className:"btn secondary",onClick:V,children:[e.jsx(Ke,{size:16,style:{marginRight:6}}),"Mark all read"]})]})]})}),M&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"mobile-fab","aria-label":"Test notification",title:"Test notification",onClick:()=>v(!0),children:e.jsx(Ye,{size:22})}),e.jsx(Pe,{open:f,onClose:()=>v(!1),children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("div",{className:"title",style:{marginBottom:4},children:"Send Test Notification"}),e.jsx("div",{className:"muted",style:{fontSize:13,marginBottom:8},children:"Send a test notification to yourself to preview how it appears."}),e.jsxs("div",{className:"col",style:{gap:8},children:[e.jsxs("button",{className:"btn secondary",onClick:()=>B("star"),disabled:F,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Je,{size:18,color:"#f59e0b"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Star"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"One of your posts was starred!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>B("likes5"),disabled:F,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Xe,{size:18,color:"#f472b6"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Likes"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"One of your posts reached 5 likes!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>B("comment"),disabled:F,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ne,{size:18,color:"#60a5fa"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Comment"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Someone commented on your post"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>B("inspiration"),disabled:F,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ne,{size:18,color:"#7dd3fc"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Inspiration"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Someone is inspired by you!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>B("reaction"),disabled:F,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ge,{size:18,color:"#10b981"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"Reaction"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Someone raised their hand on your post!"})]})]}),e.jsxs("button",{className:"btn secondary",onClick:()=>B("system"),disabled:F,style:{width:"100%",justifyContent:"flex-start",padding:"12px 16px",display:"flex",alignItems:"center",gap:12},children:[e.jsx(Ve,{size:18,color:"#a78bfa"}),e.jsxs("div",{className:"col",style:{gap:2,alignItems:"flex-start",flex:1},children:[e.jsx("span",{style:{fontWeight:500},children:"System"}),e.jsx("span",{className:"muted",style:{fontSize:12},children:"Test system notification"})]})]})]})]})})]}),e.jsx("div",{className:"feed-list-wrapper",style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:n?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."}):t.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No notifications yet."}):e.jsx("div",{className:"col",style:{gap:0},children:t.filter(g=>!(g.id.startsWith("b:")&&g.expiresAt&&g.expiresAt<=Date.now())).map(g=>{const y=({notif:b})=>{const[ee,ue]=r.useState(0),[Y,W]=r.useState(!1),O=r.useRef(null),ne=r.useRef(null),K=r.useRef(null),te=r.useRef(null),i=D=>{b.id.startsWith("n:")&&(O.current=D.touches[0].clientX,te.current=D.touches[0].clientY,ne.current=Date.now(),W(!1))},w=D=>{if(O.current===null||te.current===null||!b.id.startsWith("n:"))return;const $=D.touches[0].clientX,J=D.touches[0].clientY,le=$-O.current,ge=Math.abs(J-te.current);le<0&&Math.abs(le)>ge&&(W(!0),ue(Math.max(-80,le)))},G=()=>{if(O.current===null)return;ee<=-60&&U(b.id),ue(0),W(!1),O.current=null,te.current=null,ne.current=null},se=b.id.startsWith("n:");return e.jsxs("div",{ref:K,style:{position:"relative",background:b.read?"var(--panel-dark)":"var(--panel)",borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)",padding:16,cursor:b.videoId?"pointer":"default",opacity:b.read?.7:1,transform:`translateX(${ee}px)`,transition:Y?"none":"transform 0.2s ease",touchAction:se?"pan-x pan-y":"pan-y"},onTouchStart:i,onTouchMove:w,onTouchEnd:G,onTouchCancel:G,onClick:()=>{Math.abs(ee)>10||(!b.read&&b.id.startsWith("n:")&&q([b.id]),b.videoId&&(window.location.hash="/mp/feed"))},children:[se&&e.jsx("div",{style:{position:"absolute",right:0,top:0,bottom:0,width:80,background:"#f87171",display:"flex",alignItems:"center",justifyContent:"center",opacity:Math.abs(ee)/80,pointerEvents:"none",zIndex:0},children:e.jsx(_e,{size:20,color:"#fff"})}),e.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12,position:"relative",zIndex:1},children:[e.jsx("div",{style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",borderRadius:"50%"},children:x(b)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[e.jsx("strong",{style:{fontSize:14},children:E(b)}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[e.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(b.createdAt).toLocaleDateString()}),b.id.startsWith("n:")&&e.jsx("button",{className:"icon-link hide-on-mobile",onClick:D=>{D.stopPropagation(),U(b.id)},style:{padding:4},children:e.jsx(_e,{size:14})})]})]}),e.jsx("div",{style:{fontSize:14,wordBreak:"break-word"},children:(()=>{const D=Z(b.text);return D?`${D.inviter_username} invited you to join queue: ${D.queue_name}`:b.text||(b.kind==="star"?"One of your posts was starred!":b.kind==="likes5"?"One of your posts reached 5 likes!":b.kind==="comment"?"Someone commented on your post":b.kind==="inspiration"?"Someone is inspired by you!":b.kind==="reaction"?"Someone raised their hand on your post!":"")})()}),(()=>{const D=Z(b.text);return D&&!T.has(b.id)?e.jsxs("div",{className:"row",style:{gap:8,marginTop:12},children:[e.jsxs("button",{className:"btn",onClick:$=>{$.stopPropagation(),z(b,D.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Ke,{size:14,style:{marginRight:4}}),"Accept"]}),e.jsxs("button",{className:"btn secondary",onClick:$=>{$.stopPropagation(),ie(b,D.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[e.jsx(Me,{size:14,style:{marginRight:4}}),"Decline"]})]}):D&&T.has(b.id)?e.jsx("div",{className:"muted",style:{fontSize:12,marginTop:8},children:"Processing..."}):null})(),b.read&&b.readAt&&e.jsxs("div",{className:"muted",style:{fontSize:11,marginTop:4},children:["Read ",new Date(b.readAt).toLocaleString()]})]})]})]},b.id)};return e.jsx(y,{notif:g},g.id)})})})]})}export{mt as C,$t as M,ls as N,rs as P,is as Q,ts as a,Wt as b,Te as c,ss as d,Bt as e,as as f,Dt as g,Ut as h,ns as i,os as j,Ue as u};

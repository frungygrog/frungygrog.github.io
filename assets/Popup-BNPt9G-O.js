import{r as a,j as F,Z as G}from"./vendor-react-_vsaDC62.js";import{H as s}from"./vendor-DBgzFpze.js";const Z=({playbackUrl:v,streamUID:g,aspectRatio:c,preferNative:x=!1,autoplay:l=!1,loop:A=!1,muted:H=!1,controls:b=!0,onVideoRef:p,onClick:D})=>{const u=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,o=a.useRef(null),[B,I]=a.useState(null),$=a.useMemo(()=>{const e=1.3333333333333333,d=16/9,r=typeof c=="number"&&isFinite(c)&&c>0?c:null;return r?Math.min(d,Math.max(e,r)):16/9},[c]),P=`${B??$} / 1`,n=a.useMemo(()=>v||(g?`https://videodelivery.net/${g}/manifest/video.m3u8`:null),[v,g]),W=a.useRef(null);a.useEffect(()=>{n&&(W.current=n)},[n]),a.useEffect(()=>{I(null)},[n]),a.useEffect(()=>{if(!x||!o.current)return;const e=o.current;let d=!1;const r=()=>{if(!d)if(e.videoWidth>0&&e.videoHeight>0){const L=e.videoWidth/e.videoHeight,R=4/3,M=16/9,k=Math.min(M,Math.max(R,L));I(k),d=!0}else I($),d=!0};return e.addEventListener("loadedmetadata",r),e.readyState>=1&&r(),()=>{e.removeEventListener("loadedmetadata",r)}},[x,$,n]);const T=a.useRef(null),E=a.useRef(null);a.useEffect(()=>{if(!n)return;let e=T.current,d=null,r=!1,L=null;if(e&&E.current&&E.current!==n){console.log(`[HLS] URL changed from ${E.current} to ${n}, using loadSource`);try{e.stopLoad(),e.loadSource(n),E.current=n;const t=o.current;if(t)try{t.pause(),t.currentTime=0,t.load()}catch(f){console.warn("[HLS] Error resetting video element:",f)}}catch(t){console.error("[HLS] Error switching source:",t);try{e.destroy()}catch{}e=null,T.current=null,E.current=null}}if(e&&E.current===n)return console.log(`[HLS] URL unchanged (${n}), reusing existing HLS instance`),()=>{r=!0};const R=()=>{if(document.hidden&&e){const t=o.current;if(t)try{t.pause()}catch{}try{e.stopLoad()}catch{}}},M=()=>{if(r=!0,e){try{e.stopLoad(),e.detachMedia(),e.destroy()}catch{}e=null}};document.addEventListener("visibilitychange",R),window.addEventListener("beforeunload",M);const k=()=>{const t=o.current;if(!t||r)return;try{for(t.pause(),t.currentTime=0,t.src="",t.srcObject=null;t.firstChild;)t.removeChild(t.firstChild);t.load()}catch(y){console.warn("[HLS] Error resetting video element:",y)}const f=performance.now();if(console.log(`[HLS] Starting HLS setup for ${n} at ${f.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:t.readyState,isConnected:t.isConnected,paused:t.paused,currentTime:t.currentTime}),s.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const y={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const w=performance.now();e=new s(y),T.current=e,E.current=n;const S=performance.now()-w;console.log(`[HLS] HLS instance created in ${S.toFixed(2)}ms`);const i=performance.now();e.loadSource(n);const m=performance.now()-i;console.log(`[HLS] loadSource() called in ${m.toFixed(2)}ms`);const h=performance.now();e.attachMedia(t);const C=performance.now()-h;console.log(`[HLS] attachMedia() completed in ${C.toFixed(2)}ms`);const q=performance.now()-f;console.log(`[HLS] Total HLS setup time: ${q.toFixed(2)}ms`)}catch(w){const S=performance.now()-f;if(console.error(`[HLS] Failed to initialize HLS after ${S.toFixed(2)}ms:`,w),e){try{e.destroy()}catch{}e=null}return}e.on(s.Events.MANIFEST_PARSED,()=>{const w=performance.now()-f;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${w.toFixed(2)}ms after setup start`),r||!t)return;A&&(L=()=>{if(!(r||!t||!e))try{t.currentTime=0,t.play().catch(i=>{i.name!=="AbortError"&&i.name!=="NotAllowedError"&&console.debug("Loop play failed:",i)})}catch{t.currentTime=0,t.play().catch(()=>{})}},t.addEventListener("ended",L)),(()=>{if(!(r||!t))if(t.readyState>=2){if(l){const i=performance.now();t.play().then(()=>{const m=performance.now()-i;console.log(`[HLS] Autoplay succeeded in ${m.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(m=>{const h=performance.now()-i;m.name!=="AbortError"&&m.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${h.toFixed(2)}ms:`,m)})}}else{const i=()=>{if(!(r||!t)&&(t.removeEventListener("canplay",i),l)){const m=performance.now();t.play().then(()=>{const h=performance.now()-m;console.log(`[HLS] Autoplay succeeded in ${h.toFixed(2)}ms after canplay event`)}).catch(h=>{const C=performance.now()-m;h.name!=="AbortError"&&h.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${C.toFixed(2)}ms:`,h)})}};t.addEventListener("canplay",i,{once:!0})}})()}),e.on(s.Events.ERROR,(w,S)=>{if(!r&&S.fatal)switch(S.type){case s.ErrorTypes.NETWORK_ERROR:if(!r&&e)try{e.startLoad()}catch{}break;case s.ErrorTypes.MEDIA_ERROR:if(!r&&e)try{e.recoverMediaError()}catch{}break;default:e&&(e.destroy(),e=null);break}})}else r||console.warn("HLS.js not supported, falling back to native HLS"),t.src=n,t.loop=A,d=()=>{r||console.warn("Native HLS playback failed")},t.addEventListener("error",d),l&&!r&&t.play().catch(y=>{y.name!=="AbortError"&&y.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",y)})};let O=0;const z=10,N=()=>{if(r)return;if(O++,O>z){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const t=o.current;if(!t){requestAnimationFrame(N);return}if(!t.isConnected){requestAnimationFrame(N);return}k()},U=requestAnimationFrame(()=>{requestAnimationFrame(N)});return()=>{cancelAnimationFrame(U),r=!0,document.removeEventListener("visibilitychange",R),window.removeEventListener("beforeunload",M);const t=o.current;if(t&&L&&(t.removeEventListener("ended",L),L=null),e){try{e.stopLoad(),e.off(s.Events.MANIFEST_PARSED),e.off(s.Events.ERROR),e.off(s.Events.MEDIA_ATTACHED),e.off(s.Events.MEDIA_DETACHED),e.off(s.Events.MANIFEST_LOADED),e.off(s.Events.MEDIA_ATTACHING),e.off(s.Events.MEDIA_DETACHING),e.off(s.Events.DESTROYING),e.destroy()}catch{try{e&&e.detachMedia()}catch{}}e=null,T.current=null,E.current=null}if(t){d&&(t.removeEventListener("error",d),d=null);try{t.pause()}catch{}}}},[n,l]),a.useEffect(()=>(p&&o.current&&p(o.current),()=>{p&&p(null)}),[p,x,n]);const _="100%",j=u?{width:"auto",maxWidth:_,maxHeight:"100%",aspectRatio:P,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:_,maxHeight:"100%",height:"var(--player-height)",aspectRatio:P,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return n?F.jsx("div",{style:j,children:F.jsx("video",{ref:o,autoPlay:l,loop:!1,muted:H,controls:b,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:D?"pointer":"default"},children:"Your browser does not support the video tag."})}):F.jsx("div",{style:j,children:"No video available"})},J=({open:v,onClose:g,buttonRef:c,children:x,align:l="right",minWidth:A=160})=>{const[H,b]=a.useState(null),p=a.useRef(null);if(a.useEffect(()=>{if(!v||!c.current){b(null);return}const u=()=>{if(!c.current)return;const o=c.current.getBoundingClientRect();b({top:o.bottom+8,[l]:window.innerWidth-o[l==="right"?"right":"left"]})};return u(),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),()=>{window.removeEventListener("resize",u),window.removeEventListener("scroll",u,!0)}},[v,c,l]),a.useEffect(()=>{if(!v)return;const u=o=>{p.current&&!p.current.contains(o.target)&&c.current&&!c.current.contains(o.target)&&g()};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[v,g,c]),!v||!H)return null;const D=F.jsx("div",{ref:p,style:{position:"fixed",top:H.top,[l]:H[l],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:A,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:x});return G.createPortal(D,document.body)};export{Z as P,J as a};

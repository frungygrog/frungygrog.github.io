var K=Object.defineProperty;var D=(n,t,e)=>t in n?K(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var P=(n,t,e)=>D(n,typeof t!="symbol"?t+"":t,e);import{r as w,j as I,Z as X}from"./vendor-react-_vsaDC62.js";import{H as A}from"./vendor-DBgzFpze.js";const Y="video-cache",Z=1,C="segments",S="manifests",G=7*24*60*60*1e3,F=500*1024*1024;let z=null,k=null;function T(){return z?Promise.resolve(z):k||(k=new Promise((n,t)=>{const e=indexedDB.open(Y,Z);e.onerror=()=>t(e.error),e.onsuccess=()=>{z=e.result,n(z)},e.onupgradeneeded=s=>{const r=s.target.result;r.objectStoreNames.contains(C)||r.createObjectStore(C,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),r.objectStoreNames.contains(S)||r.createObjectStore(S,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),k)}async function J(n,t=!1){try{const e=await T(),s=t?S:C,i=e.transaction([s],"readonly").objectStore(s).get(n);return new Promise(u=>{i.onsuccess=()=>{const d=i.result;if(!d){u(null);return}if(Date.now()-d.timestamp>G){V(n,t).catch(()=>{}),u(null);return}u(d.data)},i.onerror=()=>u(null)})}catch(e){return console.warn("Cache read error:",e),null}}async function W(n,t,e=!1){try{const s=await T(),r=e?S:C,i=s.transaction([r],"readwrite").objectStore(r),u={url:n,data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((d,l)=>{const o=i.put(u);o.onsuccess=()=>d(),o.onerror=()=>l(o.error)}),await U()}catch(s){console.warn("Cache write error:",s)}}async function V(n,t=!1){try{const e=await T(),s=t?S:C,a=e.transaction([s],"readwrite").objectStore(s);await new Promise((i,u)=>{const d=a.delete(n);d.onsuccess=()=>i(),d.onerror=()=>u(d.error)})}catch(e){console.warn("Cache delete error:",e)}}async function Q(){try{const n=await T();let t=0;for(const e of[C,S]){const a=n.transaction([e],"readonly").objectStore(e).getAll();await new Promise(i=>{a.onsuccess=()=>{const u=a.result;t+=u.reduce((d,l)=>d+l.size,0),i()},a.onerror=()=>i()})}return t}catch(n){return console.warn("Cache size calculation error:",n),0}}async function U(){try{const n=await Q();if(n<=F)return;const t=await T(),e=[];for(const r of[C,S]){const a=r===S,d=t.transaction([r],"readonly").objectStore(r).getAll();await new Promise(l=>{d.onsuccess=()=>{const o=d.result;e.push(...o.map(m=>({url:m.url,timestamp:m.timestamp,size:m.size,isManifest:a}))),l()},d.onerror=()=>l()})}e.sort((r,a)=>r.timestamp-a.timestamp);let s=n;for(const r of e){if(s<=F*.8)break;await V(r.url,r.isManifest),s-=r.size}}catch(n){console.warn("Cache cleanup error:",n)}}function ee(n){return n.includes(".m3u8")||n.endsWith("/manifest")}class te{constructor(){P(this,"context",null);P(this,"stats",{});P(this,"defaultLoader",null)}load(t,e,s){this.context=t;const r=t.url,a=ee(r);J(r,a).then(i=>{if(i){let d;a?d=new TextDecoder().decode(i):d=i;const l={trequest:performance.now(),tfirst:performance.now(),tload:performance.now(),loaded:i.byteLength,total:i.byteLength};this.stats=l;const o={data:d,url:r},m=a?"manifest":"segment",v=(i.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${m}: ${r.substring(r.lastIndexOf("/")+1)} (${v} KB)`),s.onSuccess(o,l,t,{});return}console.log(`[Video Cache] âŒ Cache MISS - ${a?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(r,a,t,e,s)}).catch(i=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${a?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - falling back to network`,i),this.fetchFromNetwork(r,a,t,e,s)})}async fetchFromNetwork(t,e,s,r,a){var u,d;const i=performance.now();try{const l=await fetch(t,{method:s.method||"GET",headers:s.headers||{},signal:(u=s.abortController)==null?void 0:u.signal}).catch(b=>{throw b.name==="AbortError",b});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);let o;const m=l.headers.get("content-type")||"";e||m.includes("application/vnd.apple.mpegurl")||m.includes("text")?o=await l.text():o=await l.arrayBuffer();const v=performance.now(),E={trequest:i,tfirst:i,tload:v,loaded:typeof o=="string"?new TextEncoder().encode(o).length:o.byteLength,total:typeof o=="string"?new TextEncoder().encode(o).length:o.byteLength},H=e?"manifest":"segment";if(o instanceof ArrayBuffer){await W(t,o,e);const b=(o.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${H}: ${t.substring(t.lastIndexOf("/")+1)} (${b} KB)`)}else{const $=new TextEncoder().encode(o);await W(t,$.buffer,e);const N=($.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${H}: ${t.substring(t.lastIndexOf("/")+1)} (${N} KB)`)}const R={data:o,url:l.url};this.stats=E,a.onSuccess(R,E,s,{})}catch(l){const o={trequest:i,tfirst:i,tload:performance.now(),loaded:0,total:0};if(l instanceof Error&&l.name==="AbortError")(d=a.onAbort)==null||d.call(a,o,s,{});else if(!(l instanceof Error&&l.name==="AbortError")){const m=l instanceof Error?l:new Error("Network error");a.onError({code:0,text:m.message},s,o,{})}}}abort(){}destroy(){}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const se=({playbackUrl:n,streamUID:t,aspectRatio:e,preferNative:s=!1,autoplay:r=!1,loop:a=!1,muted:i=!1,controls:u=!0,onVideoRef:d,onClick:l})=>{const[o,m]=w.useState(1.7777777777777777),v=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;w.useEffect(()=>{if(!v)return;const c=()=>m(window.innerWidth/Math.max(1,window.innerHeight));return c(),window.addEventListener("resize",c),()=>window.removeEventListener("resize",c)},[v]);const E=w.useRef(null),[H,R]=w.useState(null),b=w.useMemo(()=>{const c=1.3333333333333333,g=16/9,f=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(f)return Math.min(g,Math.max(c,f));const y=v?o:16/9;return Math.min(g,Math.max(c,y))},[v,o,e]),N=`${H??b} / 1`,p=w.useMemo(()=>n||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[n,t]);w.useEffect(()=>{R(null)},[p]),w.useEffect(()=>{if(!s||!E.current)return;const c=E.current;let g=!1;const f=()=>{if(!g)if(c.videoWidth>0&&c.videoHeight>0){const y=c.videoWidth/c.videoHeight,q=4/3,j=16/9,h=Math.min(j,Math.max(q,y));R(h),g=!0}else R(b),g=!0};return c.addEventListener("loadedmetadata",f),c.readyState>=1&&f(),()=>{c.removeEventListener("loadedmetadata",f)}},[s,b,p]),w.useEffect(()=>{if(!p)return;let c=null,g=null,f=!1,y=null;const j=setTimeout(()=>{const h=E.current;if(!(!h||f))if(A.isSupported()){const x={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:te};c=new A(x),c.loadSource(p),c.attachMedia(h),c.on(A.Events.MANIFEST_PARSED,()=>{if(f||!h)return;const O=p.substring(p.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${O}`);let M=!1;y=()=>{!M&&!f&&(M=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${O}`),h&&y&&h.removeEventListener("playing",y))},h.addEventListener("playing",y),r&&!f&&h.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",L)})}),c.on(A.Events.ERROR,(O,M)=>{if(!f&&M.fatal)switch(M.type){case A.ErrorTypes.NETWORK_ERROR:if(!f&&c){console.warn("HLS network error, trying to recover...");try{c.startLoad()}catch(L){f||console.warn("HLS recovery failed:",L)}}break;case A.ErrorTypes.MEDIA_ERROR:if(!f&&c){console.warn("HLS media error, trying to recover...");try{c.recoverMediaError()}catch(L){f||console.warn("HLS media recovery failed:",L)}}break;default:f||console.error("HLS fatal error:",M),c&&(c.destroy(),c=null);break}})}else f||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=p,g=()=>{f||console.warn("Native HLS playback failed")},h.addEventListener("error",g),r&&!f&&h.play().catch(x=>{x.name!=="AbortError"&&x.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",x)})},0);return()=>{f=!0,clearTimeout(j);const h=E.current;if(h&&y&&(h.removeEventListener("playing",y),y=null),c){try{c.detachMedia(),c.destroy()}catch{}c=null}if(h){g&&h.removeEventListener("error",g);try{h.pause(),h.src="",h.load()}catch{}}}},[p,r]),w.useEffect(()=>{d&&d(E.current)},[d,s,p]);const B="100%",_=v?{width:"100%",maxWidth:B,maxHeight:"100%",aspectRatio:N,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:B,maxHeight:"100%",height:"var(--player-height)",aspectRatio:N,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return p?I.jsx("div",{style:_,children:I.jsx("video",{ref:E,autoPlay:r,loop:a,muted:i,controls:u,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:l?"pointer":"default"},children:"Your browser does not support the video tag."},p)}):I.jsx("div",{style:_,children:"No video available"})},ae=({open:n,onClose:t,buttonRef:e,children:s,align:r="right",minWidth:a=160})=>{const[i,u]=w.useState(null),d=w.useRef(null);if(w.useEffect(()=>{if(!n||!e.current){u(null);return}const o=()=>{if(!e.current)return;const m=e.current.getBoundingClientRect();u({top:m.bottom+8,[r]:window.innerWidth-m[r==="right"?"right":"left"]})};return o(),window.addEventListener("resize",o),window.addEventListener("scroll",o,!0),()=>{window.removeEventListener("resize",o),window.removeEventListener("scroll",o,!0)}},[n,e,r]),w.useEffect(()=>{if(!n)return;const o=m=>{d.current&&!d.current.contains(m.target)&&e.current&&!e.current.contains(m.target)&&t()};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[n,t,e]),!n||!i)return null;const l=I.jsx("div",{ref:d,style:{position:"fixed",top:i.top,[r]:i[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return X.createPortal(l,document.body)};export{se as P,ae as a};

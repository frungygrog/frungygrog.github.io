import{K as $,N as B,r as i,j as a,P as E}from"./vendor-react-Bj2Cd7tG.js";import{P as A}from"./Post-Ww96-GLW.js";import{C as z}from"./Comment-DYnuBruz.js";import{u as L}from"./index-TicTnP3i.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";const f="https://api.osumappi.ng";function H(s){var r;return(r=document.cookie.split("; ").map(o=>o.split("=")).find(([o])=>o===s))==null?void 0:r[1]}function Q(){const{uid:s}=$(),r=B(),[o,v]=i.useState(null),[j,_]=i.useState([]),[D,P]=i.useState(!0),[x,N]=i.useState(null),[m,p]=i.useState(""),[h,y]=i.useState(null),[b,S]=i.useState(!1),{notify:c}=L();i.useEffect(()=>{fetch(`${f}/api/me`,{credentials:"include"}).then(e=>e.ok?e.json():null).then(e=>N(e)).catch(()=>{})},[]);const k=async()=>{var e,n,d;if(!s||s==="null"||s==="undefined"){console.error("Invalid uid in route params:",s),c("Invalid post identifier",{variant:"error"}),r("/md/feed");return}P(!0);try{console.log("Loading moddi post with uid:",s);const l=await fetch(`${f}/api/moddiposts/${encodeURIComponent(s)}`,{credentials:"include"});if(l.ok){const t=await l.json();console.log("PostDetail: Raw API response:",t),console.log("PostDetail: Response keys:",Object.keys(t)),console.log("PostDetail: username value:",t.username,"type:",typeof t.username),console.log("PostDetail: text value:",t.text,"type:",typeof t.text);const g={...t,user_id:t.user_id??((e=t.author)==null?void 0:e.id)??0,username:t.username&&String(t.username).trim()||((n=t.author)==null?void 0:n.username)||"Unknown",avatar_url:t.avatar_url&&String(t.avatar_url).trim()||((d=t.author)==null?void 0:d.avatar_url)||null,uid:t.uid||String(t.id)||s,text:t.text??null,beatmap_url:t.beatmap_url??null,beatmapset_id:t.beatmapset_id??null,beatmap_id:t.beatmap_id??null,beatmap_version:t.beatmap_version??null,tags:t.tags??null,reactions_count:Number(t.reactions_count??0),reacted_by_me:t.reacted_by_me??!1,comments_count:Number(t.comments_count??0)};console.log("PostDetail: Transformed post:",g),console.log("PostDetail: Final username:",g.username),console.log("PostDetail: Final text:",g.text),v(g)}else{const t=await l.text().catch(()=>"");console.error("Failed to load moddi post:",l.status,t),c("Failed to load post",{variant:"error"}),r("/md/feed")}}catch(l){console.error("Error loading moddi post:",l),c("Failed to load post",{variant:"error"}),r("/md/feed")}finally{P(!1)}},C=async()=>{if(o!=null&&o.id)try{const e=await fetch(`${f}/api/moddiposts/${o.id}/comments`,{credentials:"include"});if(e.ok){const n=await e.json();_(n.items||[])}}catch{}};i.useEffect(()=>{k()},[s]),i.useEffect(()=>{o!=null&&o.id&&C()},[o==null?void 0:o.id]);const R=e=>{v(e)},F=()=>{r("/md/feed")},w=async e=>{if(e.preventDefault(),!(!m.trim()||!(o!=null&&o.id))){S(!0);try{const n=H("csrf")||"",d=await fetch(`${f}/api/moddiposts/${o.id}/comments`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":n},body:JSON.stringify({text:m.trim(),parent_id:h||void 0})});if(d.ok)p(""),y(null),C(),k(),c("Comment posted!",{variant:"success"});else{const l=await d.json().catch(()=>({}));c(l.error||"Failed to post comment",{variant:"error"})}}catch{c("Failed to post comment",{variant:"error"})}finally{S(!1)}}},I=e=>{_(n=>n.filter(d=>d.id!==e))};if(D)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!o)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const T=j.filter(e=>!e.parent_id),u=new Map;return j.filter(e=>e.parent_id).forEach(e=>{const n=e.parent_id;u.has(n)||u.set(n,[]),u.get(n).push(e)}),a.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[a.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[a.jsx("button",{className:"icon-link",onClick:()=>r("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:a.jsx(E,{size:20})}),a.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:a.jsx(A,{post:o,section:"moddi",onUpdate:R,onDelete:F,me:x})}),x&&!h&&a.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:a.jsxs("form",{onSubmit:w,style:{display:"flex",alignItems:"flex-end",gap:8},children:[a.jsx("textarea",{placeholder:"Write a comment...",value:m,onChange:e=>p(e.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:e=>{const n=e.target;n.style.height="auto",n.style.height=`${Math.min(n.scrollHeight,120)}px`}}),a.jsx("button",{type:"submit",className:"btn compact",disabled:b||!m.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:b?"...":"Post"})]})}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:T.length===0?a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):a.jsx("div",{className:"col",style:{gap:0},children:T.map(e=>a.jsx(z,{comment:e,replies:u.get(e.id)||[],me:x,section:"moddi",onReply:n=>y(n),onDelete:I,replyingTo:h,replyText:m,onReplyTextChange:p,onReplySubmit:w,posting:b,onCancelReply:()=>{y(null),p("")}},e.id))})})]})}export{Q as default};

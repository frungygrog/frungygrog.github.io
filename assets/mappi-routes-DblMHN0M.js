import{r as a,j as t,d as Ge,u as _e,e as Le,L as pe,A as Ce,F as $e,f as Xe,g as Ye,h as Se,i as je,k as ke,l as Re,m as Je,n as Ke,R as Qe,c as Ze,o as et,p as tt,q as nt}from"./vendor-react-BcztRRPo.js";import{H as O}from"./vendor-hls-B_fsdCYC.js";import{B as at}from"./editor-BU8nWiSI.js";import{P as it}from"./beatmap-preview-BasPDPAs.js";function Pe(){if(typeof window>"u")return!1;try{const e=navigator.userAgentData;if(e&&typeof e.mobile=="boolean"&&e.mobile||window.matchMedia&&(window.matchMedia("(pointer: coarse)").matches||window.matchMedia("(hover: none)").matches))return!0;const l=navigator.userAgent||"";if(/Android|iPhone|iPad|iPod|Mobile|Silk|Kindle|Opera Mini|IEMobile|WPDesktop/i.test(l))return!0}catch{}return!1}function ft(){var v;if(typeof window>"u"||typeof document>"u")return()=>{};const e=()=>{const c=Pe();document.documentElement.classList.toggle("is-mobile",c),document.documentElement.setAttribute("data-mobile",c?"true":"false")};e();const l=["(pointer: coarse)","(hover: none)","(orientation: landscape)","(orientation: portrait)"],d=[];try{for(const c of l)if(window.matchMedia){const f=window.matchMedia(c);(v=f.addEventListener)==null||v.call(f,"change",e),d.push(f)}}catch{}return window.addEventListener("resize",e),()=>{try{d.forEach(c=>{var f;return(f=c.removeEventListener)==null?void 0:f.call(c,"change",e)}),window.removeEventListener("resize",e)}catch{}}}function ht(){if(typeof window>"u")return!1;try{const e=navigator.standalone===!0,l=window.matchMedia&&window.matchMedia("(display-mode: standalone)"),d=!!(l&&l.matches),v=window.matchMedia&&window.matchMedia("(display-mode: minimal-ui)"),c=window.matchMedia&&window.matchMedia("(display-mode: fullscreen)");return e||d||!!(v&&v.matches)||!!(c&&c.matches)}catch{return!1}}const Te=a.createContext(null);function gt({children:e}){const[l,d]=a.useState([]),v=a.useRef(1),c=a.useRef(new Map),f=u=>{const h=c.current.get(u);h&&(clearTimeout(h),c.current.delete(u))},r=(u,h)=>{f(u);const g=window.setTimeout(()=>x(u),h);c.current.set(u,g)},x=a.useCallback(u=>{f(u),d(h=>h.filter(g=>g.id!==u))},[]),i=a.useCallback((u,h)=>{const g=typeof h=="number"?h:(h==null?void 0:h.durationMs)??5e3,L=typeof h=="number"?"info":(h==null?void 0:h.variant)??"info",N=Pe();let j=null;return d(N?T=>{const E=T[0];if(E&&E.message===u&&E.variant===L){const _={...E,count:E.count+1,duration:g};return j=_.id,[_]}T.forEach(_=>f(_.id));const b=v.current++,D={id:b,message:u,duration:g,variant:L,count:1};return j=b,[D]}:T=>{const E=T.findIndex(_=>_.message===u&&_.variant===L);if(E!==-1){const _=[...T],$={..._[E],count:_[E].count+1};return _[E]=$,j=$.id,_}const b=v.current++,D={id:b,message:u,duration:g,variant:L,count:1};return j=b,[...T,D]}),j!=null&&r(j,g),j??-1},[]),C=a.useMemo(()=>({notify:i,close:x}),[i,x]);return t.jsxs(Te.Provider,{value:C,children:[e,t.jsx("div",{className:"toasts",children:l.map(u=>t.jsxs("div",{className:`toast ${u.variant}`,children:[t.jsxs("div",{className:"toast-text",children:[u.message,u.count>1&&t.jsxs("span",{style:{marginLeft:6,opacity:.8},children:["×",u.count]})]}),t.jsx("button",{className:"toast-close",onClick:()=>x(u.id),"aria-label":"Close",children:"×"})]},u.id))})]})}function he(){const e=a.useContext(Te);if(!e)throw new Error("useToasts must be used within ToastProvider");return e}const ge="https://api.osumappi.ng";function rt(){var e;try{return((e=document.cookie.split("; ").map(l=>l.split("=")).find(([l])=>l==="csrf"))==null?void 0:e[1])||""}catch{return""}}async function U(e,l={}){const{requireAuth:d=!0,skipCsrf:v=!1,...c}=l,f={...c.headers};if(c.body&&!f["Content-Type"]&&(f["Content-Type"]="application/json"),d&&!v){const x=rt();x&&(f["X-CSRF-Token"]=x)}const r=await fetch(`${ge}${e}`,{...c,credentials:"include",headers:f});if(!r.ok){const x=await r.json().catch(()=>({error:`HTTP ${r.status}`}));throw new Error(x.error||`HTTP ${r.status}: ${r.statusText}`)}return r.json()}function Ee(e){const l=new URLSearchParams;for(const[v,c]of Object.entries(e))c!=null&&l.append(v,String(c));const d=l.toString();return d?`?${d}`:""}const A={auth:{login:"/api/auth/login",logout:"/api/auth/logout",me:"/api/me"},user:{quota:"/api/me/upload_quota",notifications:"/api/me/notifications",markNotificationsRead:"/api/me/notifications/mark_read",deleteNotification:e=>`/api/me/notifications/${encodeURIComponent(e)}`,pushSubscribe:"/api/me/push/subscribe",pushUnsubscribe:"/api/me/push/unsubscribe",pushList:"/api/me/push/subscriptions",pushTest:"/api/me/push/test",notifPrefs:"/api/me/notification_prefs"},feed:{next:"/api/feed/next",batch:"/api/feed/batch",progress:e=>`/api/feed/progress${e?`?modes=${encodeURIComponent(e)}`:""}`,recent:"/api/videos/recent"},videos:{like:e=>`/api/videos/${e}/like`,view:e=>`/api/videos/${e}/view`,update:e=>`/api/videos/${e}`,delete:e=>`/api/videos/${e}`,flag:e=>`/api/videos/${e}/flag`,comments:e=>`/api/videos/${e}/comments`,get:e=>`/api/videos/${e}`},uploads:{new:"/api/uploads/new"},moddi:{posts:"/api/moddiposts",post:e=>`/api/moddiposts/${e}`,postReact:e=>`/api/moddiposts/${e}/react`,postComments:e=>`/api/moddiposts/${e}/comments`,queues:"/api/moddi/queues",queue:e=>`/api/moddi/queues/${e}`,queueSubmit:e=>`/api/moddi/queues/${e}/submit`,queueAccept:e=>`/api/moddi/queues/${e}/accept`,queueDeny:e=>`/api/moddi/queues/${e}/deny`,queueInvite:e=>`/api/moddi/queues/${e}/invite`,queueMember:(e,l)=>`/api/moddi/queues/${e}/members/${l}`,queueSubmission:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}`,queueSubmissionDelete:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}`,queueBlockUser:e=>`/api/moddi/queues/${e}/block`,queueUnblockUser:(e,l)=>`/api/moddi/queues/${e}/block/${l}`,queueBlockedUsers:e=>`/api/moddi/queues/${e}/blocked`,queueSubmissionAcknowledge:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}/acknowledge`,queueSubmissionUnacknowledge:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}/acknowledge`,usersSearch:e=>`/api/moddi/users/search?q=${encodeURIComponent(e)}`},osu:{resolveBeatmap:"/api/osu/beatmap/resolve",downloadBeatmapset:e=>`/api/osu/beatmapsets/${e}/download?noVideo=1`,usersSearch:e=>`/api/osu/users/search?q=${encodeURIComponent(e)}`},users:{get:e=>`/api/users/${e}`,videos:e=>`/api/users/${e}/videos`,likes:e=>`/api/users/${e}/likes`,myVideos:"/api/me/videos"},admin:{clearViews:"/api/admin/me/clear_views",debugState:"/api/debug/state",settingsModeration:"/api/admin/settings/moderation",videosPending:"/api/admin/videos/pending",videosApprove:e=>`/api/admin/videos/${e}/approve`,videosReject:e=>`/api/admin/videos/${e}/reject`,videosAction:(e,l)=>`/api/admin/videos/${e}/${l}`,analytics:"/api/admin/analytics",usersSearch:e=>`/api/admin/users/search?q=${encodeURIComponent(e)}`,userVideos:e=>`/api/admin/users/${e}/videos`,userUpdate:e=>`/api/admin/users/${e}`,notificationsSystem:"/api/admin/notifications/system",notificationsTest:"/api/admin/notifications/test"}},Ne=({open:e,onClose:l,buttonRef:d,children:v,align:c="right",minWidth:f=160})=>{const[r,x]=a.useState(null),i=a.useRef(null);if(a.useEffect(()=>{if(!e||!d.current){x(null);return}const u=()=>{if(!d.current)return;const h=d.current.getBoundingClientRect();x({top:h.bottom+8,[c]:window.innerWidth-h[c==="right"?"right":"left"]})};return u(),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),()=>{window.removeEventListener("resize",u),window.removeEventListener("scroll",u,!0)}},[e,d,c]),a.useEffect(()=>{if(!e)return;const u=h=>{i.current&&!i.current.contains(h.target)&&d.current&&!d.current.contains(h.target)&&l()};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[e,l,d]),!e||!r)return null;const C=t.jsx("div",{ref:i,style:{position:"fixed",top:r.top,[c]:r[c],background:"var(--panel)",border:"1px solid var(--divider)",borderRadius:10,padding:6,zIndex:1e3,minWidth:f,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:v});return Ge.createPortal(C,document.body)},Me=({playbackUrl:e,streamUID:l,aspectRatio:d,preferNative:v=!1,autoplay:c=!1,loop:f=!1,muted:r=!1,controls:x=!0,onVideoRef:i,onClick:C,inOverlay:u=!1})=>{const h=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,g=a.useRef(null),[L,N]=a.useState(null),j=a.useMemo(()=>{const s=typeof d=="number"&&isFinite(d)&&d>0?d:null;return s||16/9},[d]),E=`${L??j} / 1`,b=a.useMemo(()=>e||(l?`https://videodelivery.net/${l}/manifest/video.m3u8`:null),[e,l]),D=a.useRef(null);a.useEffect(()=>{b&&(D.current=b)},[b]),a.useEffect(()=>{N(null)},[b]),a.useEffect(()=>{if(!v||!g.current)return;const s=g.current;let I=!1;const k=()=>{if(!I)if(s.videoWidth>0&&s.videoHeight>0){const q=s.videoWidth/s.videoHeight;N(q),I=!0}else N(j),I=!0};return s.addEventListener("loadedmetadata",k),s.readyState>=1&&k(),()=>{s.removeEventListener("loadedmetadata",k)}},[v,j,b]);const _=a.useRef(null),$=a.useRef(null);a.useEffect(()=>{if(!b)return;let s=_.current,I=null,k=!1,q=null;if(s&&$.current&&$.current!==b){console.log(`[HLS] URL changed from ${$.current} to ${b}, using loadSource`);try{s.stopLoad(),s.loadSource(b),$.current=b;const o=g.current;if(o)try{o.pause(),o.currentTime=0,o.load()}catch(M){console.warn("[HLS] Error resetting video element:",M)}}catch(o){console.error("[HLS] Error switching source:",o);try{s.destroy()}catch{}s=null,_.current=null,$.current=null}}if(s&&$.current===b)return console.log(`[HLS] URL unchanged (${b}), reusing existing HLS instance`),()=>{k=!0};const le=()=>{if(document.hidden&&s){const o=g.current;if(o)try{o.pause()}catch{}try{s.stopLoad()}catch{}}},B=()=>{if(k=!0,s){try{s.stopLoad(),s.detachMedia(),s.destroy()}catch{}s=null}};document.addEventListener("visibilitychange",le),window.addEventListener("beforeunload",B);const K=()=>{const o=g.current;if(!o||k)return;try{for(o.pause(),o.currentTime=0,o.src="",o.srcObject=null;o.firstChild;)o.removeChild(o.firstChild);o.load()}catch(m){console.warn("[HLS] Error resetting video element:",m)}const M=performance.now();if(console.log(`[HLS] Starting HLS setup for ${b} at ${M.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:o.readyState,isConnected:o.isConnected,paused:o.paused,currentTime:o.currentTime}),O.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const m={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const y=performance.now();s=new O(m),_.current=s,$.current=b;const z=performance.now()-y;console.log(`[HLS] HLS instance created in ${z.toFixed(2)}ms`);const H=performance.now();s.loadSource(b);const F=performance.now()-H;console.log(`[HLS] loadSource() called in ${F.toFixed(2)}ms`);const W=performance.now();s.attachMedia(o);const Q=performance.now()-W;console.log(`[HLS] attachMedia() completed in ${Q.toFixed(2)}ms`);const P=performance.now()-M;console.log(`[HLS] Total HLS setup time: ${P.toFixed(2)}ms`)}catch(y){const z=performance.now()-M;if(console.error(`[HLS] Failed to initialize HLS after ${z.toFixed(2)}ms:`,y),s){try{s.destroy()}catch{}s=null}return}s.on(O.Events.MANIFEST_PARSED,()=>{const y=performance.now()-M;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${y.toFixed(2)}ms after setup start`),k||!o)return;f&&(q=()=>{if(!(k||!o||!s))try{o.currentTime=0,o.play().catch(H=>{H.name!=="AbortError"&&H.name!=="NotAllowedError"&&console.debug("Loop play failed:",H)})}catch{o.currentTime=0,o.play().catch(()=>{})}},o.addEventListener("ended",q)),(()=>{if(!(k||!o))if(o.readyState>=2){if(c){const H=performance.now();o.play().then(()=>{const F=performance.now()-H;console.log(`[HLS] Autoplay succeeded in ${F.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(F=>{const W=performance.now()-H;F.name!=="AbortError"&&F.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${W.toFixed(2)}ms:`,F)})}}else{const H=()=>{if(!(k||!o)&&(o.removeEventListener("canplay",H),c)){const F=performance.now();o.play().then(()=>{const W=performance.now()-F;console.log(`[HLS] Autoplay succeeded in ${W.toFixed(2)}ms after canplay event`)}).catch(W=>{const Q=performance.now()-F;W.name!=="AbortError"&&W.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${Q.toFixed(2)}ms:`,W)})}};o.addEventListener("canplay",H,{once:!0})}})()}),s.on(O.Events.ERROR,(y,z)=>{if(!k&&z.fatal)switch(z.type){case O.ErrorTypes.NETWORK_ERROR:if(!k&&s)try{s.startLoad()}catch{}break;case O.ErrorTypes.MEDIA_ERROR:if(!k&&s)try{s.recoverMediaError()}catch{}break;default:s&&(s.destroy(),s=null);break}})}else k||console.warn("HLS.js not supported, falling back to native HLS"),o.src=b,o.loop=f,I=()=>{k||console.warn("Native HLS playback failed")},o.addEventListener("error",I),c&&!k&&o.play().catch(m=>{m.name!=="AbortError"&&m.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",m)})};let J=0;const V=10,X=()=>{if(k)return;if(J++,J>V){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const o=g.current;if(!o){requestAnimationFrame(X);return}if(!o.isConnected){requestAnimationFrame(X);return}K()},oe=requestAnimationFrame(()=>{requestAnimationFrame(X)});return()=>{cancelAnimationFrame(oe),k=!0,document.removeEventListener("visibilitychange",le),window.removeEventListener("beforeunload",B);const o=g.current;if(o&&q&&(o.removeEventListener("ended",q),q=null),s){try{s.stopLoad(),s.off(O.Events.MANIFEST_PARSED),s.off(O.Events.ERROR),s.off(O.Events.MEDIA_ATTACHED),s.off(O.Events.MEDIA_DETACHED),s.off(O.Events.MANIFEST_LOADED),s.off(O.Events.MEDIA_ATTACHING),s.off(O.Events.MEDIA_DETACHING),s.off(O.Events.DESTROYING),s.destroy()}catch{try{s&&s.detachMedia()}catch{}}s=null,_.current=null,$.current=null}if(o){I&&(o.removeEventListener("error",I),I=null);try{o.pause()}catch{}}}},[b,c]),a.useEffect(()=>(i&&g.current&&i(g.current),()=>{i&&i(null)}),[i,v,b]);const S=h||!u?{width:"auto",maxWidth:"100%",height:"100%",maxHeight:"100%",aspectRatio:E,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"100%",maxWidth:"100%",maxHeight:"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",aspectRatio:E,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"};return b?t.jsx("div",{style:S,children:t.jsx("video",{ref:g,autoPlay:c,loop:!1,muted:r,controls:x,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:C?"pointer":"default"},children:"Your browser does not support the video tag."})}):t.jsx("div",{style:S,children:"No video available"})};function st({beatmapMeta:e,beatmapVersion:l}){const d=a.useRef(null),v=a.useRef(null),[c,f]=a.useState(!1),[r,x]=a.useState(!1),[i,C]=a.useState(0);a.useEffect(()=>{if(d.current&&v.current){const g=d.current.offsetWidth,L=v.current.scrollWidth;C(L),x(L>g)}},[e,l]);const u=e?t.jsxs(t.Fragment,{children:[e.artist," – ",e.title,e.mapper?` (by ${e.mapper})`:"",l?` [${l}]`:""]}):l?`[${l}]`:"Beatmap",h=i>0?Math.max(3,i/50):3;return t.jsxs(t.Fragment,{children:[t.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),t.jsxs("div",{ref:d,className:"muted one-line",style:{fontSize:12,color:"var(--muted)",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:r?"pointer":"default"},onMouseEnter:()=>r&&f(!0),onMouseLeave:()=>f(!1),children:[t.jsx("span",{ref:v,style:{display:"inline-block",animation:c&&r?`beatmap-marquee ${h}s linear infinite`:"none"},children:u}),c&&r&&t.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:u})]})]})}function ot(e){return"post_type"in e?e.post_type==="mappi":!!e.stream_uid}function lt({post:e,section:l,onUpdate:d,onDelete:v,me:c}){const f=_e(),r=Le(),x=l==="mappi"?r.pathname.startsWith("/mp/feed/"):r.pathname.startsWith("/md/feed/"),i=ot(e);e.id;const C=i?e.stream_uid||String(e.id||""):e.uid||String(e.id||""),u=C&&C!=="null"&&C!=="undefined"?l==="mappi"?`/mp/feed/${C}`:`/md/feed/${C}`:l==="mappi"?`/mp/feed/${e.id}`:`/md/feed/${e.id}`,[h,g]=a.useState(!1),[L,N]=a.useState(!1),[j,T]=a.useState(!1),[E,b]=a.useState(!1),[D,_]=a.useState(!1),$=a.useRef(null),S=a.useRef(null),s=a.useRef(null),[I,k]=a.useState(null),[q,le]=a.useState(null),{notify:B}=he(),[K,J]=a.useState(i?e.liked_by_me:void 0),[V,X]=a.useState(i?e.likes_count:0),[oe,o]=a.useState(i?void 0:e.reacted_by_me),[M,m]=a.useState(i?0:e.reactions_count);a.useEffect(()=>{if(i){const n=e;J(n.liked_by_me),X(n.likes_count)}else{const n=e;o(!!n.reacted_by_me),m(n.reactions_count)}},[e,i]);const[y,z]=a.useState(!1),[H,F]=a.useState(i?"":e.text??""),[W,Q]=a.useState(e.beatmap_url||""),[P,Z]=a.useState(null),[ee,Y]=a.useState(null),[be,te]=a.useState(""),ue=a.useRef(0),ve=c&&((i?e.uploader&&c.id===e.uploader.id:c.id===e.user_id)||c.is_admin||c.is_mod),xe=(()=>{const n=e.created_at;if(!n)return"";const p=Math.floor(Date.now()/1e3)-n;return p<60?"just now":p<3600?`${Math.floor(p/60)}m`:p<86400?`${Math.floor(p/3600)}h`:p<604800?`${Math.floor(p/86400)}d`:new Date(n*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();a.useEffect(()=>{if(!y&&!i){const n=e;F(n.text??""),Q(n.beatmap_url||""),Z(null),Y(null),te("")}},[e,y,i]),a.useEffect(()=>{if(!y||i)return;ue.current&&window.clearTimeout(ue.current);const n=(W||"").trim();if(!n){te(""),Z(null),Y(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(n)){te(""),Z(null),Y(null);return}return ue.current=window.setTimeout(async()=>{var w;try{let R;try{R=new URL(n)}catch{te("Invalid URL format");return}const ne=R.hash.match(/#osu\/(\d+)/),ae=ne?ne[1]:null;R.hash="";const se={url:R.toString()};ae&&(se.beatmap_id=ae);const G=await U(A.osu.resolveBeatmap+Ee(se),{requireAuth:!1}),ce=Array.isArray(G==null?void 0:G.diffs)?G.diffs:[];if(!ce.length&&!G.setId){te("No difficulties found"),Z(null),Y(null);return}if(Z({setId:Number(G.setId)||0,beatmapId:G.beatmapId??null,title:String(G.title||""),artist:String(G.artist||""),mapper:String(G.mapper||""),diffs:ce}),ce.length>0){const Ue=Number.isFinite(Number(G.beatmapId))?Number(G.beatmapId):Number((w=ce[0])==null?void 0:w.id),ie=ce.find(Ve=>Number(Ve.id)===Ue)||ce[0];Y({beatmapId:Number(ie==null?void 0:ie.id)||null,version:String((ie==null?void 0:ie.version)||""),mode:String((ie==null?void 0:ie.mode)||"standard")})}else Y(null);te("")}catch(R){te(`Failed to resolve: ${(R==null?void 0:R.message)||"Unknown error"}`),Z(null),Y(null)}},400),()=>{ue.current&&window.clearTimeout(ue.current)}},[W,y,i]),a.useEffect(()=>{if(i||!e.beatmap_url||q)return;const n=e;let p=!1;return(async()=>{try{let w;try{w=new URL(n.beatmap_url)}catch{return}const R=w.hash.match(/#osu\/(\d+)/),ne=R?R[1]:null;w.hash="";const re={url:w.toString()};if(ne?re.beatmap_id=ne:n.beatmap_id&&(re.beatmap_id=String(n.beatmap_id)),!p){const se=await U(A.osu.resolveBeatmap+Ee(re),{requireAuth:!1});(se.title||se.artist)&&le({title:se.title||null,artist:se.artist||null,mapper:se.mapper||null})}}catch{}})(),()=>{p=!0}},[e,i,q]);const He=async()=>{if(h||!i)return;g(!0);const n=K??!1,p=V,w=!n,R=w?V+1:Math.max(0,V-1);J(w),X(R);try{const ne=n?"DELETE":"POST",ae=await U(A.videos.like(e.id),{method:ne}),re={...e,liked_by_me:w,likes_count:ae.likes_count||R};J(w),X(ae.likes_count??R),d&&d(re)}catch{J(n),X(p),B("Failed to like",{variant:"error"})}finally{g(!1)}},Ie=async()=>{if(L||i)return;N(!0);const n=oe??!1,p=M,w=!n,R=w?M+1:Math.max(0,M-1);o(w),m(R);try{const ne=n?"DELETE":"POST",ae=await U(A.moddi.postReact(e.id),{method:ne}),re={...e,reacted_by_me:w,reactions_count:ae.reactions_count||R};o(w),m(ae.reactions_count??R),d&&d(re)}catch{o(n),m(p),B("Failed to react",{variant:"error"})}finally{N(!1)}},ye=async()=>{if(confirm(i?"Permanently delete this video?":"Permanently delete this post?")){try{const n=i?A.videos.delete(e.id):A.moddi.post(String(e.id));await U(n,{method:"DELETE"}),B(i?"Video deleted":"Post deleted",{variant:"warn"}),v&&v(e.id)}catch(n){B((n==null?void 0:n.message)||(i?"Failed to delete video":"Failed to delete post"),{variant:"error"})}b(!1)}},ze=async()=>{if(i){try{const n=!e.is_starred,p=n?"star":"unstar";await U(A.admin.videosAction(e.id,p),{method:"POST"});const w={...e,is_starred:n};d&&d(w),B(n?"Post starred":"Star removed",{variant:"success"})}catch{B("Action failed",{variant:"error"})}b(!1)}},Fe=()=>{i||(z(!0),F(e.text??""),Q(e.beatmap_url||""),Z(null),Y(null),te(""),b(!1))},De=async()=>{if(!i)try{await U(A.moddi.post(String(e.id)),{method:"PATCH",body:JSON.stringify({text:H.trim(),beatmap_url:W.trim()||null,beatmapset_id:(P==null?void 0:P.setId)??void 0,beatmap_id:(ee==null?void 0:ee.beatmapId)??(P==null?void 0:P.beatmapId)??void 0,beatmap_version:(ee==null?void 0:ee.version)??void 0})});const n=await U(A.moddi.post(String(e.id)),{method:"GET",requireAuth:!1});d&&n.post&&d({...e,...n.post}),B("Post updated",{variant:"success"}),z(!1)}catch(n){B((n==null?void 0:n.message)||"Failed to update post",{variant:"error"})}},qe=()=>{z(!1);const n=e;F(n.text??""),Q(n.beatmap_url||""),Z(null),Y(null),te("")};a.useEffect(()=>{if(!j||!S.current){k(null);return}const n=()=>{if(S.current){const p=S.current.getBoundingClientRect();k({top:p.bottom+8,right:window.innerWidth-p.right})}};return n(),window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),()=>{window.removeEventListener("resize",n),window.removeEventListener("scroll",n,!0)}},[j]),a.useEffect(()=>{if(!j)return;const n=p=>{$.current&&!$.current.contains(p.target)&&S.current&&!S.current.contains(p.target)&&T(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[j]);const Be=n=>{const p=n.target;if(p.closest("button")||p.closest(".menu-panel")||p.closest("input")||p.closest("textarea")||p.closest("select"))return;const w=p.closest("a");w&&w.getAttribute("href")!==`#${u}`||f(u)},de=i?e.uploader||{id:0,username:"Unknown",avatar_url:null}:{id:e.user_id||0,username:e.username||"Unknown",avatar_url:e.avatar_url||null},me=!i&&(oe??(e.reacted_by_me===!0||e.reacted_by_me===1)),we=!i&&e.tags&&(typeof e.tags=="string"?e.tags.split(",").map(n=>n.trim()):[]).includes("help"),fe=e.beatmapset_id,We=e.beatmap_id,Oe=e.beatmap_version;return t.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",onClick:Be,children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[de.avatar_url?t.jsx(pe,{to:`/profile/${de.id}`,onClick:n=>n.stopPropagation(),style:{flexShrink:0},children:t.jsx("img",{src:de.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:de.username})}):t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),t.jsx(pe,{to:u,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:n=>{const p=n.target,w=p.closest("a");if(w&&w!==n.currentTarget){n.preventDefault(),n.stopPropagation();return}if(p.closest("button")||p.closest(".menu-panel")||p.closest("input")||p.closest("textarea")||p.closest("select")){n.preventDefault(),n.stopPropagation();return}n.stopPropagation()},children:t.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(pe,{to:`/profile/${de.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:n=>n.stopPropagation(),onMouseEnter:n=>n.currentTarget.style.color="#7dd3fc",onMouseLeave:n=>n.currentTarget.style.color="inherit",children:de.username}),i&&e.is_starred&&t.jsx(Ce,{size:14,color:"#f59e0b",title:"Starred"}),i&&e.mode&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:e.mode}),!i&&we&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[xe&&t.jsx("span",{className:"muted",style:{fontSize:13},children:xe}),ve&&t.jsx("button",{ref:s,onClick:n=>{n.preventDefault(),n.stopPropagation(),b(p=>!p)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:n=>n.currentTarget.style.backgroundColor="var(--hover-overlay)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:t.jsx($e,{size:16})})]})]}),i&&x&&e.playback_url&&t.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"var(--panel-dark)"},children:t.jsx(Me,{playbackUrl:e.playback_url,streamUID:e.stream_uid,aspectRatio:e.width&&e.height?e.width/e.height:null})}),i&&!x&&e.poster_url&&t.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"var(--panel-dark)",aspectRatio:e.width&&e.height?`${e.width} / ${e.height}`:"16 / 9",position:"relative"},children:[t.jsx("img",{src:e.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),e.duration_sec&&t.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(e.duration_sec/60),":",(e.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!i&&y?t.jsx("div",{style:{marginBottom:12},children:t.jsxs("div",{className:"col",style:{gap:8},children:[t.jsx("textarea",{value:H,onChange:n=>F(n.target.value),maxLength:200,rows:2,style:{background:"var(--panel-dark)",border:"1px solid var(--border)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),P?t.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[t.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[t.jsxs("strong",{style:{marginRight:4},children:[P.artist," – ",P.title]}),t.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",P.mapper]})]}),P.diffs.length>0&&t.jsx("select",{value:(ee==null?void 0:ee.beatmapId)??(P==null?void 0:P.beatmapId)??void 0,onChange:n=>{const p=Number(n.target.value),w=(P==null?void 0:P.diffs.find(R=>Number(R.id)===p))||null;w&&Y({beatmapId:p,version:w.version,mode:String(w.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",fontSize:12},children:P.diffs.map(n=>t.jsxs("option",{value:n.id,children:[n.version," (",n.mode,")"]},n.id))}),t.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{Z(null),Y(null),Q("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):t.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:W,onChange:n=>Q(n.target.value),style:{fontSize:13,padding:"6px 8px",background:"var(--panel-dark)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:6}}),be&&t.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:be}),t.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[t.jsx("button",{className:"btn secondary",onClick:qe,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),t.jsx("button",{className:"btn",onClick:De,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):t.jsxs(t.Fragment,{children:[(()=>{if(i){const n=e.description??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"var(--text)"},children:n}):null}else{const n=e.text??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"var(--text)"},children:n}):null}})(),i&&e.beatmap_title&&t.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"var(--muted)",lineHeight:1.4},children:[e.beatmap_artist," – ",e.beatmap_title," ",e.beatmap_mapper?`(by ${e.beatmap_mapper})`:""," ",e.beatmap_version?`[${e.beatmap_version}]`:""]}),!y&&t.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[i&&e.beatmap_url&&!e.beatmap_title&&t.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!i&&e.beatmap_url&&(q||e.beatmapset_id||e.beatmap_id)&&t.jsx(st,{beatmapMeta:q,beatmapVersion:e.beatmap_version}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[i&&t.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Xe,{size:12}),t.jsx("span",{children:e.views_count??0})]}),t.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Ye,{size:12}),t.jsx("span",{children:e.comments_count??0})]}),i?t.jsxs("button",{className:`chip-btn like ${K?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),He()},disabled:h,"aria-label":K?"Unlike":"Like",title:K?"Unlike":"Like",children:[K?t.jsx(Se,{size:16}):t.jsx(je,{size:16}),t.jsx("span",{children:V})]}):t.jsxs("button",{className:`chip-btn like ${me?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),Ie()},disabled:L,"aria-label":me?"Remove reaction":"React",title:me?"Remove reaction":"React",children:[we?t.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):me?t.jsx(Se,{size:16}):t.jsx(je,{size:16}),t.jsx("span",{children:M})]}),e.beatmap_url&&t.jsxs("button",{ref:S,className:"chip-btn link",onClick:n=>{n.preventDefault(),n.stopPropagation(),T(p=>!p)},title:"Beatmap options","aria-label":"Beatmap options",children:[t.jsx(ke,{size:16}),t.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),t.jsx(Re,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),j&&I&&e.beatmap_url&&t.jsxs("div",{ref:$,style:{position:"fixed",top:I.top,right:I.right,background:"var(--panel)",border:"1px solid var(--divider)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsxs("a",{className:"menu-item",href:e.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>T(!1),children:[t.jsx(ke,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),fe&&t.jsx("button",{className:"menu-item",onClick:()=>{_(!0),T(!1)},children:"Preview"})]}),D&&fe&&t.jsx(at,{open:D,onClose:()=>_(!1),downloadUrl:`${ge}${A.osu.downloadBeatmapset(fe)}`,beatmapId:We??void 0,beatmapVersion:Oe??void 0}),ve&&t.jsx(Ne,{open:E,onClose:()=>b(!1),buttonRef:s,minWidth:160,children:i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),ze()},children:e.is_starred?"Unstar post":"Star post"}),t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),ye()},children:"Delete video"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:Fe,children:"Edit post"}),t.jsx("button",{className:"menu-item",onClick:ye,children:"Delete post"})]})})]})}function Ae({comment:e,replies:l,me:d,onReply:v,onDelete:c,replyingTo:f,replyText:r,onReplyTextChange:x,onReplySubmit:i,posting:C,onCancelReply:u,section:h,repliesMap:g}){const[L,N]=a.useState(!1),j=a.useRef(null),{notify:T}=he(),[E,b]=a.useState(!1),D=e.parent_id!==null,_=d&&(d.id===e.user_id||d.is_admin||d.is_mod),$=async()=>{if(confirm("Delete this comment?"))try{const S=h==="mappi"?A.videos.comments(e.post_id)+`/${e.id}`:A.moddi.postComments(e.post_id)+`/${e.id}`;await U(S,{method:"DELETE"}),c(e.id),T("Comment deleted",{variant:"success"})}catch{T("Failed to delete comment",{variant:"error"})}finally{N(!1)}};return t.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--border-subtle)",background:"var(--hover-overlay)",transition:"background-color 0.15s ease"},onMouseEnter:S=>S.currentTarget.style.backgroundColor="var(--hover-overlay-strong)",onMouseLeave:S=>S.currentTarget.style.backgroundColor="var(--hover-overlay)",children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[t.jsx("span",{style:{fontSize:13,fontWeight:500},children:e.username}),t.jsx("span",{className:"muted",style:{fontSize:11},children:new Date(e.created_at*1e3).toLocaleDateString()})]}),t.jsx("div",{style:{fontSize:14,lineHeight:1.5,wordBreak:"break-word"},children:e.text}),t.jsx("div",{style:{display:"flex",alignItems:"center",gap:12,marginTop:8},children:t.jsxs("button",{onClick:()=>v(e.id),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:12,padding:0},children:[t.jsx(Je,{size:14}),"Reply"]})}),f===e.id&&d&&t.jsx("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border-subtle)"},children:t.jsxs("form",{onSubmit:i,style:{display:"flex",alignItems:"flex-end",gap:6},children:[t.jsx("textarea",{placeholder:`Reply to ${e.username}...`,value:r||"",onChange:S=>x==null?void 0:x(S.target.value),rows:1,style:{flex:1,background:"var(--panel-dark)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:12,resize:"none",minHeight:"28px",maxHeight:"100px",overflowY:"auto"},onInput:S=>{const s=S.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,100)}px`},autoFocus:!0}),t.jsx("button",{type:"submit",className:"btn compact",disabled:C||!(r!=null&&r.trim()),style:{padding:"5px 10px",fontSize:11,flexShrink:0},children:C?"...":"Reply"}),u&&t.jsx("button",{type:"button",onClick:u,style:{padding:"5px 10px",fontSize:11,flexShrink:0,background:"transparent",border:"1px solid var(--border)",color:"var(--muted)",borderRadius:6,cursor:"pointer"},children:"Cancel"})]})})]}),_&&t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{ref:j,className:"icon-link",onClick:()=>N(!L),style:{width:"auto",height:"auto",padding:"4px"},title:"More options","aria-label":"More options",children:t.jsx($e,{size:16})}),t.jsx(Ne,{open:L,onClose:()=>N(!1),buttonRef:j,children:t.jsx("button",{className:"menu-item",onClick:$,style:{color:"var(--danger)"},children:"Delete"})})]})]}),l.length>0&&t.jsxs("div",{style:{marginTop:12,marginLeft:16,paddingLeft:16,borderLeft:"1px solid var(--border-subtle)"},children:[D&&t.jsxs("button",{onClick:()=>b(!E),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:11,padding:"4px 0",marginBottom:4},children:[E?t.jsx(Re,{size:12}):t.jsx(Ke,{size:12}),E?"Hide":"Show"," ",l.length," ",l.length===1?"reply":"replies"]}),(!D||E)&&t.jsx(t.Fragment,{children:l.map(S=>t.jsx(Ae,{comment:S,replies:(g==null?void 0:g.get(S.id))||[],me:d,onReply:v,onDelete:c,replyingTo:f,replyText:r,onReplyTextChange:x,onReplySubmit:i,posting:C,onCancelReply:u,section:h,repliesMap:g},S.id))})]})]})}const dt=({streamUID:e,playbackUrl:l,aspectRatio:d,onClose:v,headerLeft:c,headerRight:f,children:r,beatmapDownloadUrl:x,beatmapVersion:i,beatmapId:C,onOpenInEditor:u})=>{const h=typeof d=="number"&&isFinite(d)&&d>0?d:1.7777777777777777,g=!!x;return Qe.useEffect(()=>(document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}),[]),t.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:L=>L.stopPropagation(),children:[t.jsx("div",{className:"overlay-backdrop",onClick:v}),t.jsxs("div",{className:"overlay-card",onClick:L=>L.stopPropagation(),children:[t.jsx("button",{className:"overlay-close",onClick:v,"aria-label":"Close",children:t.jsx(Ze,{size:18})}),t.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:g?0:"auto",maxHeight:g?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:L=>L.stopPropagation(),children:g?t.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:t.jsx(it,{downloadUrl:x,beatmapVersion:i,beatmapId:C,onOpenInEditor:u})}):t.jsx(Me,{streamUID:e||void 0,playbackUrl:l||void 0,aspectRatio:h,inOverlay:!0})}),(c||f||r)&&t.jsxs("div",{className:"section-panel",children:[(c||f)&&t.jsxs("div",{className:"row-between",children:[t.jsx("div",{className:"row",style:{alignItems:"center"},children:c}),f?t.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:f}):t.jsx("div",{})]}),r]})]})]})};function bt(){var X,oe,o,M;const{uid:e}=et(),[l,d]=tt(),v=_e(),f=((X=Le().state)==null?void 0:X.returnTo)||"/mp/feed",[r,x]=a.useState(null),[i,C]=a.useState([]),[u,h]=a.useState(!0),[g,L]=a.useState(null),[N,j]=a.useState(""),[T,E]=a.useState(null),[b,D]=a.useState(!1),[_,$]=a.useState(!1),{notify:S}=he(),s=a.useRef(new Set);a.useEffect(()=>{U(A.auth.me,{requireAuth:!1}).then(m=>L(m)).catch(()=>{})},[]),a.useEffect(()=>{l.get("preview")==="true"&&$(!0)},[l]);const I=async()=>{if(e){h(!0);try{const m=await U(A.videos.get(e),{requireAuth:!1});x(m)}catch{S("Failed to load post",{variant:"error"}),v(f)}finally{h(!1)}}},k=async()=>{if(r!=null&&r.id)try{const m=await U(A.videos.comments(r.id),{requireAuth:!1});C(m.items||[])}catch{}};a.useEffect(()=>{I()},[e]),a.useEffect(()=>{r!=null&&r.id&&k()},[r==null?void 0:r.id]),a.useEffect(()=>{r!=null&&r.id&&(s.current.has(r.id)||(s.current.add(r.id),U(A.videos.view(r.id),{method:"POST"}).then(m=>{if(!m)return;const y=Number(m.views_count??0);x(z=>z?{...z,views_count:y,viewed_by_me:!0}:null)}).catch(()=>{})))},[r==null?void 0:r.id]);const q=m=>{"stream_uid"in m&&x(m)},le=()=>{v(f)},B=async m=>{if(m.preventDefault(),!(!N.trim()||!(r!=null&&r.id))){D(!0);try{await U(A.videos.comments(r.id),{method:"POST",body:JSON.stringify({text:N.trim(),parent_id:T||void 0})}),j(""),E(null),k(),I(),S("Comment posted!",{variant:"success"})}catch(y){S((y==null?void 0:y.message)||"Failed to post comment",{variant:"error"})}finally{D(!1)}}},K=m=>{C(y=>y.filter(z=>z.id!==m))};if(u)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!r)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const J=i.filter(m=>!m.parent_id),V=new Map;return i.filter(m=>m.parent_id).forEach(m=>{const y=m.parent_id;V.has(y)||V.set(y,[]),V.get(y).push(m)}),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[t.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>v(f),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:t.jsx(nt,{size:20})}),t.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:t.jsx(lt,{post:r,section:"mappi",onUpdate:q,onDelete:le,me:g})}),g&&!T&&t.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:t.jsxs("form",{onSubmit:B,style:{display:"flex",alignItems:"flex-end",gap:8},children:[t.jsx("textarea",{placeholder:"Write a comment...",value:N,onChange:m=>j(m.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:m=>{const y=m.target;y.style.height="auto",y.style.height=`${Math.min(y.scrollHeight,120)}px`}}),t.jsx("button",{type:"submit",className:"btn compact",disabled:b||!N.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:b?"...":"Post"})]})}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:J.length===0?t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):t.jsx("div",{className:"col",style:{gap:0},children:J.map(m=>t.jsx(Ae,{comment:m,replies:V.get(m.id)||[],me:g,section:"mappi",onReply:y=>E(y),onDelete:K,replyingTo:T,replyText:N,onReplyTextChange:j,onReplySubmit:B,posting:b,onCancelReply:()=>{E(null),j("")},repliesMap:V},m.id))})})]}),r&&_&&r.beatmapset_id&&t.jsx(dt,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{$(!1),d({})},beatmapDownloadUrl:`${ge}${A.osu.downloadBeatmapset(r.beatmapset_id)}`,beatmapId:r.beatmap_id??void 0,beatmapVersion:r.beatmap_version??void 0,onOpenInEditor:()=>{$(!1),d({}),window.location.hash="/editor"},headerLeft:t.jsxs(t.Fragment,{children:[((oe=r.uploader)==null?void 0:oe.avatar_url)&&t.jsx("img",{src:r.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),t.jsxs(pe,{to:`/profile/${(o=r.uploader)==null?void 0:o.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[t.jsx("span",{children:(M=r.uploader)==null?void 0:M.username}),r.is_starred?t.jsx(Ce,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{A,Ae as C,lt as P,gt as T,U as a,Ee as b,ge as c,ht as d,ft as e,bt as f,rt as g,Me as h,Pe as i,he as u};

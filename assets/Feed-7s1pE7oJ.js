import{J as F,g as E,e as L,r as p,j as r}from"./vendor-react-Bj2Cd7tG.js";import{P as C}from"./Post-DVIJ44J0.js";import{C as T}from"./Compose-DBqwggkh.js";import{a as y,b as P,A as U,c as A}from"./index-Br3VIMS9.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";function D(){const{data:m}=y(),{tagFilters:c}=P();return F({queryKey:["moddi","feed",c],queryFn:async({pageParam:d=0})=>{const s=new URLSearchParams({limit:"20",offset:String(d)}),n=`${U.moddi.posts}?${s.toString()}`;return await A(n)},enabled:!!m,initialPageParam:0,getNextPageParam:(d,s)=>{var g;const n=s.reduce((u,l)=>{var i;return u+(((i=l.items)==null?void 0:i.length)||0)},0);return(((g=d.items)==null?void 0:g.length)||0)===20?n:void 0}})}function K(){const m=E(),c=L(),{data:d}=y(),{tagFilters:s}=P(),{data:n,fetchNextPage:h,hasNextPage:g,isFetching:u,isFetchingNextPage:l,refetch:i}=D(),x=p.useMemo(()=>n!=null&&n.pages?n.pages.flatMap(e=>{const t=e.items||[];return t.length>0&&console.log("Moddi post from API (first item):",t[0]),t}):[],[n]),f=p.useMemo(()=>x.filter(e=>{const t=e.tags?typeof e.tags=="string"?e.tags.split(",").map(w=>w.trim()):[]:[],a=!e.tags||t.length===0,o=t.includes("help");return s.untagged&&s.help?!0:s.untagged&&!s.help?a:!s.untagged&&s.help?o:!1}),[x,s]);p.useEffect(()=>{m.pathname==="/md/feed"&&i()},[m.pathname,i]),p.useEffect(()=>{const e=()=>{i()};return window.addEventListener("moddifilterchange",e),()=>window.removeEventListener("moddifilterchange",e)},[i]);const b=e=>{c.setQueryData(["moddi","feed"],t=>t&&{...t,pages:t.pages.map(a=>({...a,items:a.items.map(o=>o.id===e.id?e:o)}))})},N=e=>{c.setQueryData(["moddi","feed"],t=>t&&{...t,pages:t.pages.map(a=>({...a,items:a.items.filter(o=>o.id!==e)}))})},j=()=>{i()},v=u&&!l,M=g??!1;return r.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[r.jsx(T,{section:"moddi",onPost:j}),r.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:r.jsxs("div",{className:"col",style:{gap:0},children:[f.length===0&&!v&&r.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),f.map(e=>r.jsx(C,{post:e,section:"moddi",onUpdate:b,onDelete:N,me:d},e.id)),f.length>0&&M&&r.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:r.jsx("button",{className:"btn secondary",onClick:()=>h(),disabled:l,children:l?"Loading...":"Load more"})})]})})]})}export{K as default};

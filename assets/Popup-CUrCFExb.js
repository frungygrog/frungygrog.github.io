var D=Object.defineProperty;var X=(o,t,e)=>t in o?D(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var H=(o,t,e)=>X(o,typeof t!="symbol"?t+"":t,e);import{r as g,j,Z as U}from"./vendor-react-_vsaDC62.js";import{H as R}from"./vendor-DBgzFpze.js";const Y="video-cache",Z=1,A="segments",C="manifests",G=7*24*60*60*1e3,F=500*1024*1024;let z=null,N=null;function P(){return z?Promise.resolve(z):N||(N=new Promise((o,t)=>{const e=indexedDB.open(Y,Z);e.onerror=()=>t(e.error),e.onsuccess=()=>{z=e.result,o(z)},e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(A)||r.createObjectStore(A,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),r.objectStoreNames.contains(C)||r.createObjectStore(C,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),N)}async function J(o,t=!1){try{const e=await P(),a=t?C:A,s=e.transaction([a],"readonly").objectStore(a),c=B(o,t),m=s.get(c);return new Promise(n=>{m.onsuccess=()=>{const i=m.result;if(!i){n(null);return}if(Date.now()-i.timestamp>G){V(o,t).catch(()=>{}),n(null);return}n(i.data)},m.onerror=()=>n(null)})}catch(e){return console.warn("Cache read error:",e),null}}async function W(o,t,e=!1){try{const a=await P(),r=e?C:A,c=a.transaction([r],"readwrite").objectStore(r),n={url:B(o,e),data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((i,l)=>{const f=c.put(n);f.onsuccess=()=>i(),f.onerror=()=>l(f.error)}),await ee()}catch(a){console.warn("Cache write error:",a)}}async function V(o,t=!1){try{const e=await P(),a=t?C:A,s=e.transaction([a],"readwrite").objectStore(a),c=B(o,t);await new Promise((m,n)=>{const i=s.delete(c);i.onsuccess=()=>m(),i.onerror=()=>n(i.error)})}catch(e){console.warn("Cache delete error:",e)}}async function Q(){try{const o=await P();let t=0;for(const e of[A,C]){const s=o.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{s.onsuccess=()=>{const m=s.result;t+=m.reduce((n,i)=>n+i.size,0),c()},s.onerror=()=>c()})}return t}catch(o){return console.warn("Cache size calculation error:",o),0}}async function ee(){try{const o=await Q();if(o<=F)return;const t=await P(),e=[];for(const r of[A,C]){const s=r===C,n=t.transaction([r],"readonly").objectStore(r).getAll();await new Promise(i=>{n.onsuccess=()=>{const l=n.result;e.push(...l.map(f=>({url:f.url,timestamp:f.timestamp,size:f.size,isManifest:s}))),i()},n.onerror=()=>i()})}e.sort((r,s)=>r.timestamp-s.timestamp);let a=o;for(const r of e){if(a<=F*.8)break;await V(r.url,r.isManifest),a-=r.size}}catch(o){console.warn("Cache cleanup error:",o)}}function te(o){return o.includes(".m3u8")||o.endsWith("/manifest")}function B(o,t){if(t)try{const e=new URL(o),a=new URLSearchParams(e.search),r=Array.from(a.entries()).sort(([s],[c])=>s.localeCompare(c));return e.search=new URLSearchParams(r).toString(),e.toString()}catch{return o}else try{const e=new URL(o);return e.origin+e.pathname}catch{const e=o.match(/[^\/\?]+\.(ts|m4s|mp4|webm)/i);return e?e[0]:o.split("?")[0]}}class re{constructor(t){H(this,"context",null);H(this,"stats");H(this,"defaultLoader",null);H(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,a){this.context=t;const r=t.url,s=te(r);J(r,s).then(c=>{if(c){let n;s?n=new TextDecoder().decode(c):n=c;const i=performance.now();this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=i,this.stats.loaded=c.byteLength,this.stats.total=c.byteLength,this.stats.aborted=!1;const l={data:n,url:r,code:200},f=s?"manifest":"segment",S=(c.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${f}: ${r.substring(r.lastIndexOf("/")+1)} (${S} KB)`),a.onSuccess(l,this.stats,t,{});return}console.log(`[Video Cache] âŒ Cache MISS - ${s?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(r,s,t,e,a)}).catch(c=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${s?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - falling back to network`,c),this.fetchFromNetwork(r,s,t,e,a)})}async fetchFromNetwork(t,e,a,r,s){var m;const c=performance.now();try{const n=this.abortController||new AbortController,i=await fetch(t,{method:a.method||"GET",headers:a.headers||{},signal:n.signal}).catch(v=>{throw v.name==="AbortError",v});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let l;const f=i.headers.get("content-type")||"";e||f.includes("application/vnd.apple.mpegurl")||f.includes("text")?l=await i.text():l=await i.arrayBuffer();const S=performance.now(),E=typeof l=="string"?new TextEncoder().encode(l).length:l.byteLength;this.stats.loading.start=c,this.stats.loading.first=c,this.stats.loading.end=S,this.stats.loaded=E,this.stats.total=E,this.stats.aborted=!1;const T=e?"manifest":"segment";if(l instanceof ArrayBuffer){await W(t,l,e);const v=(l.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${T}: ${t.substring(t.lastIndexOf("/")+1)} (${v} KB)`)}else{const I=new TextEncoder().encode(l);await W(t,I.buffer,e);const k=(I.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${T}: ${t.substring(t.lastIndexOf("/")+1)} (${k} KB)`)}const M={data:l,url:i.url,code:i.status};s.onSuccess(M,this.stats,a,{})}catch(n){const i=performance.now();if(this.stats.loading.start=c,this.stats.loading.first=c,this.stats.loading.end=i,this.stats.loaded=0,this.stats.total=0,n instanceof Error&&n.name==="AbortError")this.stats.aborted=!0,(m=s.onAbort)==null||m.call(s,this.stats,a,{});else if(!(n instanceof Error&&n.name==="AbortError")){this.stats.aborted=!1;const l=n instanceof Error?n:new Error("Network error");s.onError({code:0,text:l.message},a,{},this.stats)}}}abort(){this.abortController&&this.abortController.abort()}destroy(){this.context=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}},this.abortController&&(this.abortController.abort(),this.abortController=null)}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const ae=({playbackUrl:o,streamUID:t,aspectRatio:e,preferNative:a=!1,autoplay:r=!1,loop:s=!1,muted:c=!1,controls:m=!0,onVideoRef:n,onClick:i})=>{const[l,f]=g.useState(1.7777777777777777),S=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;g.useEffect(()=>{if(!S)return;const d=()=>f(window.innerWidth/Math.max(1,window.innerHeight));return d(),window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[S]);const E=g.useRef(null),[T,M]=g.useState(null),v=g.useMemo(()=>{const d=1.3333333333333333,y=16/9,u=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(u)return Math.min(y,Math.max(d,u));const b=S?l:16/9;return Math.min(y,Math.max(d,b))},[S,l,e]),k=`${T??v} / 1`,p=g.useMemo(()=>o||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[o,t]);g.useEffect(()=>{M(null)},[p]),g.useEffect(()=>{if(!a||!E.current)return;const d=E.current;let y=!1;const u=()=>{if(!y)if(d.videoWidth>0&&d.videoHeight>0){const b=d.videoWidth/d.videoHeight,q=4/3,$=16/9,h=Math.min($,Math.max(q,b));M(h),y=!0}else M(v),y=!0};return d.addEventListener("loadedmetadata",u),d.readyState>=1&&u(),()=>{d.removeEventListener("loadedmetadata",u)}},[a,v,p]),g.useEffect(()=>{if(!p)return;let d=null,y=null,u=!1,b=null;const $=setTimeout(()=>{const h=E.current;if(!(!h||u))if(R.isSupported()){const L={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:re};d=new R(L),d.loadSource(p),d.attachMedia(h),d.on(R.Events.MANIFEST_PARSED,()=>{if(u||!h)return;const O=p.substring(p.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${O}`);let w=!1;b=()=>{!w&&!u&&(w=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${O}`),h&&b&&h.removeEventListener("playing",b))},h.addEventListener("playing",b),r&&!u&&h.play().catch(x=>{x.name!=="AbortError"&&x.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",x)})}),d.on(R.Events.ERROR,(O,w)=>{if(!u&&(console.error("[HLS Error]",{type:w.type,details:w.details,fatal:w.fatal,url:w.url,error:w.error,response:w.response}),w.fatal))switch(w.type){case R.ErrorTypes.NETWORK_ERROR:if(!u&&d){console.warn("HLS network error, trying to recover...",{details:w.details,url:w.url,error:w.error});try{d.startLoad()}catch(x){u||console.warn("HLS recovery failed:",x)}}break;case R.ErrorTypes.MEDIA_ERROR:if(!u&&d){console.warn("HLS media error, trying to recover...");try{d.recoverMediaError()}catch(x){u||console.warn("HLS media recovery failed:",x)}}break;default:u||console.error("HLS fatal error:",w),d&&(d.destroy(),d=null);break}})}else u||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=p,y=()=>{u||console.warn("Native HLS playback failed")},h.addEventListener("error",y),r&&!u&&h.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",L)})},0);return()=>{u=!0,clearTimeout($);const h=E.current;if(h&&b&&(h.removeEventListener("playing",b),b=null),d){try{d.detachMedia(),d.destroy()}catch{}d=null}if(h){y&&h.removeEventListener("error",y);try{h.pause(),h.src="",h.load()}catch{}}}},[p,r]),g.useEffect(()=>{n&&n(E.current)},[n,a,p]);const K="100%",_=S?{width:"100%",maxWidth:K,maxHeight:"100%",aspectRatio:k,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:K,maxHeight:"100%",height:"var(--player-height)",aspectRatio:k,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return p?j.jsx("div",{style:_,children:j.jsx("video",{ref:E,autoPlay:r,loop:s,muted:c,controls:m,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:i?"pointer":"default"},children:"Your browser does not support the video tag."},p)}):j.jsx("div",{style:_,children:"No video available"})},ie=({open:o,onClose:t,buttonRef:e,children:a,align:r="right",minWidth:s=160})=>{const[c,m]=g.useState(null),n=g.useRef(null);if(g.useEffect(()=>{if(!o||!e.current){m(null);return}const l=()=>{if(!e.current)return;const f=e.current.getBoundingClientRect();m({top:f.bottom+8,[r]:window.innerWidth-f[r==="right"?"right":"left"]})};return l(),window.addEventListener("resize",l),window.addEventListener("scroll",l,!0),()=>{window.removeEventListener("resize",l),window.removeEventListener("scroll",l,!0)}},[o,e,r]),g.useEffect(()=>{if(!o)return;const l=f=>{n.current&&!n.current.contains(f.target)&&e.current&&!e.current.contains(f.target)&&t()};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[o,t,e]),!o||!c)return null;const i=j.jsx("div",{ref:n,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:s,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:a});return U.createPortal(i,document.body)};export{ae as P,ie as a};

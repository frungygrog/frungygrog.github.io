import{J as M,g as E,e as L,r as p,j as i}from"./vendor-react-Bj2Cd7tG.js";import{P as C}from"./Post-DhwUSkDR.js";import{C as T}from"./Compose-BsL46LUN.js";import{a as y,b as P,A as U,c as D}from"./index-BQPrkZF9.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-DvUOAkfg.js";import"./beatmap-preview-Ch7r1MMc.js";import"./editor-components-B-SB05wW.js";function S(){const{data:m}=y(),{tagFilters:c}=P();return M({queryKey:["moddi","feed",c],queryFn:async({pageParam:d=0})=>{const s=new URLSearchParams({limit:"20",offset:String(d)}),a=`${U.moddi.posts}?${s.toString()}`;return await D(a)},enabled:!!m,initialPageParam:0,getNextPageParam:(d,s)=>{var g;const a=s.reduce((u,l)=>{var n;return u+(((n=l.items)==null?void 0:n.length)||0)},0);return(((g=d.items)==null?void 0:g.length)||0)===20?a:void 0}})}function K(){const m=E(),c=L(),{data:d}=y(),{tagFilters:s}=P(),{data:a,fetchNextPage:f,hasNextPage:g,isFetching:u,isFetchingNextPage:l,refetch:n}=S(),x=p.useMemo(()=>(a==null?void 0:a.pages.flatMap(e=>e.items||[]))||[],[a]),h=p.useMemo(()=>x.filter(e=>{const t=e.tags?typeof e.tags=="string"?e.tags.split(",").map(F=>F.trim()):[]:[],r=!e.tags||t.length===0,o=t.includes("help");return s.untagged&&s.help?!0:s.untagged&&!s.help?r:!s.untagged&&s.help?o:!1}),[x,s]);p.useEffect(()=>{m.pathname==="/md/feed"&&n()},[m.pathname,n]),p.useEffect(()=>{const e=()=>{n()};return window.addEventListener("moddifilterchange",e),()=>window.removeEventListener("moddifilterchange",e)},[n]);const b=e=>{c.setQueryData(["moddi","feed"],t=>t&&{...t,pages:t.pages.map(r=>({...r,items:r.items.map(o=>o.id===e.id?e:o)}))})},N=e=>{c.setQueryData(["moddi","feed"],t=>t&&{...t,pages:t.pages.map(r=>({...r,items:r.items.filter(o=>o.id!==e)}))})},j=()=>{n()},v=u&&!l,w=g??!1;return i.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[i.jsx(T,{section:"moddi",onPost:j}),i.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:i.jsxs("div",{className:"col",style:{gap:0},children:[h.length===0&&!v&&i.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),h.map(e=>i.jsx(C,{post:e,section:"moddi",onUpdate:b,onDelete:N,me:d},e.id)),h.length>0&&w&&i.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:i.jsx("button",{className:"btn secondary",onClick:()=>f(),disabled:l,children:l?"Loading...":"Load more"})})]})})]})}export{K as default};

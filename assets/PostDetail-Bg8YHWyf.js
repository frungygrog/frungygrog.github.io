import{M as B,i as D,r as s,j as a,P as E}from"./vendor-react-_vsaDC62.js";import{P as I}from"./Post-DssnwJMc.js";import{C as z}from"./Comment-B-_QDH2q.js";import{u as M,a as c,A as u}from"./index-DtbE2Ny4.js";import"./vendor-DBgzFpze.js";import"./Popup-D-8ssjeF.js";import"./editor-lib-BGkr3wNG.js";import"./beatmap-preview-iFLBdsja.js";import"./editor-components-CKFEosPJ.js";function $(){const{uid:i}=B(),r=D(),[n,h]=s.useState(null),[b,y]=s.useState([]),[N,v]=s.useState(!0),[p,T]=s.useState(null),[o,l]=s.useState(""),[g,x]=s.useState(null),[f,_]=s.useState(!1),{notify:d}=M();s.useEffect(()=>{c(u.auth.me,{requireAuth:!1}).then(e=>T(e)).catch(()=>{})},[]);const j=async()=>{if(!i||i==="null"||i==="undefined"){d("Invalid post identifier",{variant:"error"}),r("/md/feed");return}v(!0);try{const e=await c(u.moddi.post(i),{requireAuth:!1}),t={...e,user_id:e.user_id??0,username:e.username||"Unknown",avatar_url:e.avatar_url||null,uid:e.uid||String(e.id)||i,text:e.text??null,beatmap_url:e.beatmap_url??null,beatmapset_id:e.beatmapset_id??null,beatmap_id:e.beatmap_id??null,beatmap_version:e.beatmap_version??null,tags:e.tags??null,reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)};h(t)}catch{d("Failed to load post",{variant:"error"}),r("/md/feed")}finally{v(!1)}},S=async()=>{if(n!=null&&n.id)try{const e=await c(u.moddi.postComments(n.id),{requireAuth:!1});y(e.items||[])}catch{}};s.useEffect(()=>{j()},[i]),s.useEffect(()=>{n!=null&&n.id&&S()},[n==null?void 0:n.id]);const w=e=>{h(e)},k=()=>{r("/md/feed")},P=async e=>{if(e.preventDefault(),!(!o.trim()||!(n!=null&&n.id))){_(!0);try{await c(u.moddi.postComments(n.id),{method:"POST",body:JSON.stringify({text:o.trim(),parent_id:g||void 0})}),l(""),x(null),S(),j(),d("Comment posted!",{variant:"success"})}catch(t){d((t==null?void 0:t.message)||"Failed to post comment",{variant:"error"})}finally{_(!1)}}},A=e=>{y(t=>t.filter(R=>R.id!==e))};if(N)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!n)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const C=b.filter(e=>!e.parent_id),m=new Map;return b.filter(e=>e.parent_id).forEach(e=>{const t=e.parent_id;m.has(t)||m.set(t,[]),m.get(t).push(e)}),a.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[a.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[a.jsx("button",{className:"icon-link",onClick:()=>r("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:a.jsx(E,{size:20})}),a.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:a.jsx(I,{post:n,section:"moddi",onUpdate:w,onDelete:k,me:p})}),p&&!g&&a.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:a.jsxs("form",{onSubmit:P,style:{display:"flex",alignItems:"flex-end",gap:8},children:[a.jsx("textarea",{placeholder:"Write a comment...",value:o,onChange:e=>l(e.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:e=>{const t=e.target;t.style.height="auto",t.style.height=`${Math.min(t.scrollHeight,120)}px`}}),a.jsx("button",{type:"submit",className:"btn compact",disabled:f||!o.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:f?"...":"Post"})]})}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:C.length===0?a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):a.jsx("div",{className:"col",style:{gap:0},children:C.map(e=>a.jsx(z,{comment:e,replies:m.get(e.id)||[],me:p,section:"moddi",onReply:t=>x(t),onDelete:A,replyingTo:g,replyText:o,onReplyTextChange:l,onReplySubmit:P,posting:f,onCancelReply:()=>{x(null),l("")}},e.id))})})]})}export{$ as default};

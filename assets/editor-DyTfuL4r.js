var je=Object.defineProperty;var Pe=(t,e,s)=>e in t?je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var Mt=(t,e,s)=>Pe(t,typeof e!="symbol"?e+"":e,s);import{r as x,R as kt,j as g,a as Re,b as Ie,c as pe}from"./vendor-react-CcFPULbg.js";import{J as Ee}from"./vendor-zip-B-J1xrE3.js";import{P as Le}from"./beatmap-preview-DxZMEkpy.js";function Kt(t){const e=(s,n)=>{const o=t==null?void 0:t[s],i=typeof o=="number"?o:Number(o);return Number.isFinite(i)?i:n};return{AR:e("ApproachRate",e("AR",5)),CS:e("CircleSize",5),OD:e("OverallDifficulty",e("OD",5)),HP:e("HPDrainRate",e("HP",5)),SliderMultiplier:e("SliderMultiplier",1.4),SliderTickRate:e("SliderTickRate",1)}}function ge(t){return 54.4-4.48*t}function ye(t){return t<=5?1800-120*t:1200-150*(t-5)}function Ne(t){return ye(t)*.4}function Jt(t){return t?typeof t.uninherited=="number"?t.uninherited===1:(t.beatLength??0)>0:!1}function $t(t,e){const s=t.timingPoints||[];let n=null,o=null;for(let i=0;i<s.length;i++){const r=s[i];if(r.time<=e)Jt(r)?n=r:o=r;else break}if(!n||!o)for(let i=s.length-1;i>=0&&(!n||!o);i--){const r=s[i];r.time<=e&&(Jt(r)&&!n&&(n=r),!Jt(r)&&!o&&(o=r))}return{base:n,inherited:o}}const Ot=512,Nt=384;function Ae(t){const e=[];for(let i=0;i<t.length;i++){const r=t[i];(!e.length||e[e.length-1].x!==r.x||e[e.length-1].y!==r.y)&&e.push({x:r.x,y:r.y})}const s=[],n=[0];for(let i=1;i<e.length;i++){const r=e[i].x-e[i-1].x,a=e[i].y-e[i-1].y,h=Math.hypot(r,a);s.push(h),n.push(n[n.length-1]+h)}const o=n[n.length-1]||0;return{pts:e,segLen:s,cumLen:n,total:o}}function Ft(t,e){const s=t.total||1,n=Math.max(0,Math.min(s,e*s));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,o-1),r=t.cumLen[i],a=t.segLen[i]||1,h=a>0?(n-r)/a:0,c=t.pts[i],d=t.pts[Math.min(i+1,t.pts.length-1)];return{x:c.x+(d.x-c.x)*h,y:c.y+(d.y-c.y)*h}}function Be(t,e){const s=t.total||1,n=Math.max(0,Math.min(s,e*s));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,Math.min(t.pts.length-2,o-1)),r=t.pts[i],a=t.pts[i+1];return Math.atan2(a.y-r.y,a.x-r.x)}function re(t,e){const s=Math.max(0,Math.min(t.total,e));if(s<=0)return[t.pts[0]];if(s>=t.total)return t.pts.slice();const n=[];let o=0;n.push(t.pts[0]);for(let i=1;i<t.pts.length;i++){const r=t.segLen[i-1];if(o+r<s){n.push(t.pts[i]),o+=r;continue}const a=s-o,h=r>0?a/r:0,c=t.pts[i-1],d=t.pts[i];n.push({x:c.x+(d.x-c.x)*h,y:c.y+(d.y-c.y)*h});break}return n}function Fe(t,e){let s=t.map(n=>({x:n.x,y:n.y}));for(;s.length>1;){const n=[];for(let o=0;o<s.length-1;o++)n.push({x:s[o].x+(s[o+1].x-s[o].x)*e,y:s[o].y+(s[o+1].y-s[o].y)*e});s=n}return s[0]}function ne(t,e=64){const s=[];for(let n=0;n<=e;n++){const o=n/e;s.push(Fe(t,o))}return s}function Oe(t,e=64){const s=[];if(t.length<2)return t.slice();const n=t.slice(),o=.5,i=n.length-1;for(let r=0;r<i;r++){const a=n[Math.max(0,r-1)],h=n[r],c=n[r+1],d=n[Math.min(n.length-1,r+2)];for(let u=0;u<=e;u++){const m=u/e,C=m*m,f=C*m,P=-o*m+2*o*C-o*f,L=1+(o-3)*C+(2-o)*f,I=o*m+(3-2*o)*C+(o-2)*f,b=-o*C+o*f,S=P*a.x+L*h.x+I*c.x+b*d.x,p=P*a.y+L*h.y+I*c.y+b*d.y;s.push({x:S,y:p})}}return s}function $e(t,e=64){if(t.length!==3)return ne(t,96);const[s,n,o]=t,i=n.x-s.x,r=n.y-s.y,a=o.x-s.x,h=o.y-s.y,c=i*(s.x+n.x)+r*(s.y+n.y),d=a*(s.x+o.x)+h*(s.y+o.y),u=2*(i*(o.y-n.y)-r*(o.x-n.x));if(Math.abs(u)<1e-6)return ne(t,96);const m=(h*c-r*d)/u,C=(i*d-a*c)/u,f=Math.atan2(s.y-C,s.x-m),P=Math.atan2(n.y-C,n.x-m),L=Math.atan2(o.y-C,o.x-m),I=R=>(R%(Math.PI*2)+Math.PI*2)%(Math.PI*2),b=I(L-f),S=-I(f-L),k=I(P-f)<=b?b:S,M=Math.hypot(s.x-m,s.y-C),v=[];for(let R=0;R<=e;R++){const _=R/e,Q=f+k*_;v.push({x:m+Math.cos(Q)*M,y:C+Math.sin(Q)*M})}return v}function ce(t,e){return t.x===e.x&&t.y===e.y}function ke(t,e=64){const s=[];let n=t[0],o=[t[0]];for(let r=1;r<t.length;r++){const a=t[r];ce(a,n)?(o.length>=2&&s.push(o.slice()),o=[a]):(o.push(a),n=a)}o.length>=2&&s.push(o);const i=[];for(const r of s){if(r.length===2){i.length===0&&i.push(r[0]),i.push(r[1]);continue}const a=ne(r,e);i.length>0&&ce(i[i.length-1],a[0])&&a.shift(),i.push(...a)}return i}function ie(t,e){let s;return t==="L"?s=e:t==="B"?s=ke(e,96):t==="C"?s=Oe(e,96):s=$e(e,96),Ae(s)}const zt=new Map;function St(t){return Math.max(0,Math.min(1,t))}function Wt(t,e,s,n,o){t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.strokeStyle=o,t.lineWidth=3,t.stroke()}function _t(t,e){if(!(e.length<2)){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y)}}function De(t){const e=t.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(e){const n=e[1],o=n.length===3?n.split("").map(h=>h+h).join(""):n,i=parseInt(o.slice(0,2),16),r=parseInt(o.slice(2,4),16),a=parseInt(o.slice(4,6),16);return{r:i,g:r,b:a}}const s=t.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return s?{r:Number(s[1]),g:Number(s[2]),b:Number(s[3])}:null}function ze(t,e,s,n,o,i,r,a=1){if(e.length<2)return;const h=Et.get(e,i,s,n);if(h){t.save(),t.globalAlpha=Math.max(0,Math.min(1,r));const{entry:A,transform:tt}=h;t.translate(tt.tx,tt.ty),t.rotate(tt.angle),t.scale(tt.scale,tt.scale),t.drawImage(A.canvas,A.normMinX-A.pad,A.normMinY-A.pad),t.restore();return}const c=Et.normalizePath(e);let d=1/0,u=1/0,m=-1/0,C=-1/0;for(const A of c)A.x<d&&(d=A.x),A.y<u&&(u=A.y),A.x>m&&(m=A.x),A.y>C&&(C=A.y);const f=Math.ceil(Math.max(s,n)/2)+2,P=Math.max(1,Math.ceil(m-d+f*2)),L=Math.max(1,Math.ceil(C-u+f*2)),I=document.createElement("canvas");I.width=P,I.height=L;const b=I.getContext("2d",{willReadFrequently:!1});b.save(),b.translate(-d+f,-u+f),b.lineCap="round",b.lineJoin="round",b.globalCompositeOperation="source-over",b.globalAlpha=1,b.lineWidth=s,_t(b,c),b.strokeStyle=o,b.stroke();const S=De(i)||{r:255,g:255,b:255},p=`rgba(${S.r}, ${S.g}, ${S.b}, 1)`;b.lineWidth=n,_t(b,c),b.strokeStyle=p,b.stroke();const O=be(),k=we[O];b.globalCompositeOperation="soft-light",b.globalCompositeOperation!=="soft-light"&&(b.globalCompositeOperation="screen");const M=k.highlightPasses;for(let A=0;A<M;A++){const tt=A/(M-1),ht=Math.max(1,n*(.96-.7*tt)),y=.15*(1-tt)*(1-tt)*a;b.lineWidth=ht,_t(b,c),b.strokeStyle=`rgba(255,255,255,${y.toFixed(3)})`,b.stroke()}if(k.edgePasses>0){b.globalCompositeOperation="multiply";const A=k.edgePasses;for(let tt=0;tt<A;tt++){const ht=tt/(A-1),y=Math.max(1,n*(.98-.08*ht)),W=(.1-.03*ht)*a;b.lineWidth=y,_t(b,c),b.strokeStyle=`rgba(0,0,0,${Math.max(0,W).toFixed(3)})`,b.stroke()}}b.restore(),Et.set(e,i,s,n,{canvas:I,normalizedWidth:P,normalizedHeight:L,pad:f,normMinX:d,normMinY:u,lastUsed:0,accessCount:0,memoryBytes:P*L*4,pathSignature:Et.generatePathSignature(e)});const v=e[0],R=e[e.length-1],_=c[c.length-1],Q=Math.atan2(R.y-v.y,R.x-v.x),et=Math.atan2(_.y,_.x),H=Q-et;t.save(),t.globalAlpha=Math.max(0,Math.min(1,r)),t.translate(v.x,v.y),t.rotate(H),t.drawImage(I,d-f,u-f),t.restore()}function Ht(t,e,s,n,o,i=1,r){const a=o.hitcircle,h=o.hitcircleoverlay,c=n*2/(a.width||128),d=Math.max(1,Math.round(a.width*c)),u=Math.max(1,Math.round(a.height*c));if(t.save(),t.translate(e,s),t.globalAlpha=i,r){const m=`${a.src}|${r}|${d}x${u}`;let C=zt.get(m);if(!C){C=document.createElement("canvas"),C.width=d,C.height=u;const f=C.getContext("2d");f.drawImage(a,0,0,d,u),f.globalCompositeOperation="source-in",f.fillStyle=r,f.fillRect(0,0,d,u),zt.set(m,C)}t.drawImage(C,-d/2,-u/2,d,u)}else t.drawImage(a,-d/2,-u/2,d,u);h&&t.drawImage(h,-d/2,-u/2,d,u),t.restore()}function le(t,e,s,n,o,i,r){const a=i.approachcircle,h=n*2/(a.width||128),c=Math.max(1,Math.round(a.width*h)),d=Math.max(1,Math.round(a.height*h));if(t.save(),t.globalAlpha=.6*o,t.translate(e,s),r){const u=`${a.src}|approach|${r}|${c}x${d}`;let m=zt.get(u);if(!m){m=document.createElement("canvas"),m.width=c,m.height=d;const C=m.getContext("2d");C.drawImage(a,0,0,c,d),C.globalCompositeOperation="source-in",C.fillStyle=r,C.fillRect(0,0,c,d),zt.set(u,m)}t.drawImage(m,-c/2,-d/2,c,d)}else t.drawImage(a,-c/2,-d/2,c,d);t.restore()}function Ue(t,e,s,n,o,i=1){const r=o.sliderfollowcircle,a=n*2/(r.width||256),h=r.width*a,c=r.height*a;t.save(),t.globalAlpha=.9*St(i),t.translate(e,s),t.drawImage(r,-h/2,-c/2,h,c),t.restore()}function he(t,e,s,n,o,i,r=1){var f;if(!o.digits||i<=0)return;const h=String(i).split("").map(P=>o.digits[Number(P)]),c=((f=h[0])==null?void 0:f.height)||32,u=n*.82*.85/c,m=h.reduce((P,L)=>P+((L==null?void 0:L.width)||20)*u,0);let C=e-m/2;t.save(),t.globalAlpha=r;for(const P of h){const L=((P==null?void 0:P.width)||20)*u,I=((P==null?void 0:P.height)||20)*u;t.drawImage(P,C,s-I/2,L,I),C+=L}t.restore()}function We(t,e,s){const n=Math.max(1,Math.round(e)),o=`${t.src}|ball|${s}|${n}`;let i=zt.get(o);if(!i){i=document.createElement("canvas"),i.width=n,i.height=n;const r=i.getContext("2d");r.clearRect(0,0,n,n),r.drawImage(t,0,0,n,n),r.globalCompositeOperation="multiply",r.fillStyle=s,r.fillRect(0,0,n,n),r.globalCompositeOperation="destination-in",r.drawImage(t,0,0,n,n),zt.set(o,i)}return i}function Xt(t,e,s,n,o,i,r,a,h){const c=Math.max(1,o),d=c/Math.max(1,e.width||128),u=(e.width||128)*d,m=(e.height||128)*d;if(t.save(),t.translate(s,n),t.rotate(i),h?t.globalCompositeOperation="lighter":t.globalCompositeOperation="source-over",r&&r!=="#ffffff"&&r!=="rgba(255,255,255,1)"){const C=We(e,c,r);t.globalAlpha=a,t.drawImage(C,-u/2,-m/2,u,m)}else t.globalAlpha=a,t.drawImage(e,-u/2,-m/2,u,m);t.restore()}function _e(t,e,s,n,o,i){const r=t.createRadialGradient(e-n*.3,s-n*.3,n*.15,e,s,n);r.addColorStop(0,"rgba(255,255,255,1)"),r.addColorStop(1,o),t.save(),t.globalAlpha=i,t.fillStyle=r,t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.fill(),t.restore()}function Dt(t){return t*(2-t)}function Ut(t,e,s,n){const o=n&&n<0?100/-n:1,i=100*s*o;return t.length/Math.max(1e-6,i)*e}function He(t,e,s,n,o){const i=n&&n<0?100/-n:1,r=100*s*i,a=t.length/Math.max(1e-6,r),h=1/Math.max(1e-6,o),c=[];for(let d=h;d<a-.001;d+=h){const u=d/a;u>0&&u<1&&c.push(u)}return c}function Xe(t,e,s){let n=1/0;for(let o=1;o<s.pts.length;o++){const i=s.pts[o-1],r=s.pts[o],a=r.x-i.x,h=r.y-i.y,c=a*a+h*h;let d=0;c>0&&(d=((t-i.x)*a+(e-i.y)*h)/c,d=Math.max(0,Math.min(1,d)));const u=i.x+a*d,m=i.y+h*d,C=Math.hypot(u-t,m-e);C<n&&(n=C)}return n}function qt(t,e,s){const n=3*s;return{x:t-n,y:e-n}}function xe(t){const e=(t==null?void 0:t.hitObjects.length)||0,s=new Array(e).fill(0),n=new Array(e).fill(1);if(!t)return{colorIndex:s,number:n};let o=0,i=0;for(let r=0;r<e;r++){const a=t.hitObjects[r];a.newCombo?(o=o+1+(a.comboSkip||0),i=1):i=(i||1)+1,s[r]=o,n[r]=i}return{colorIndex:s,number:n}}function Ye(t){const e=(t==null?void 0:t.hitObjects.length)||0,s=new Array(e).fill(0);if(!t)return s;const n=t.hitObjects,o=60,i=3;for(let r=1;r<e;r++){const a=n[r-1],h=n[r];if(h.time-a.time<=o){const d=h.x-a.x,u=h.y-a.y;if(Math.hypot(d,u)<=i){s[r]=s[r-1]+1;continue}}if(a.kind==="slider"){const d=oe(t,a),u=ve(t,a),m=h.time-d;if(m<=o&&m>=-o){const C=ae(h),f=C.x-u.x,P=C.y-u.y;Math.hypot(f,P)<=i&&(s[r]=s[r-1]+1)}}}return s}function oe(t,e){if(e.kind==="circle")return e.time;if(e.kind==="spinner")return e.endTime;const{base:s,inherited:n}=$t(t,e.time),o=(s==null?void 0:s.beatLength)??500,i=n==null?void 0:n.beatLength,r=Ut(e,o,Kt(t.difficulty).SliderMultiplier,i),a=Math.max(1,e.slides);return e.time+r*a}function ve(t,e){if(e.kind==="circle")return ae(e);if(e.kind==="spinner")return{x:Ot/2,y:Nt/2};const s=e,n=ie(s.curveType,s.points),o=s.length;let i=n;if(o>0&&o<n.total){const m=re(n,o),C={pts:m,segLen:[],cumLen:[0],total:o};for(let f=1;f<m.length;f++){const P=m[f].x-m[f-1].x,L=m[f].y-m[f-1].y,I=Math.hypot(P,L);C.segLen.push(I),C.cumLen.push(C.cumLen[C.cumLen.length-1]+I)}i=C}const{base:r,inherited:a}=$t(t,s.time),h=(r==null?void 0:r.beatLength)??500,c=a==null?void 0:a.beatLength;Ut(s,h,Kt(t.difficulty).SliderMultiplier,c);const u=(Math.max(1,s.slides)-1)%2===0;return Ft(i,u?1:0)}function ae(t){if(t.kind==="circle"){const s=t;return typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:{x:t.x,y:t.y}}if(t.kind==="spinner")return{x:Ot/2,y:Nt/2};const e=t;return typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:{x:t.x,y:t.y}}class Ge{constructor(){Mt(this,"cache",new Map);Mt(this,"maxSize",50);Mt(this,"accessCounter",0);Mt(this,"shapeUsageMap",new Map);Mt(this,"totalMemoryBytes",0);Mt(this,"memoryBudgetBytes");Mt(this,"stats",{hits:0,misses:0,totalRenders:0,cacheSize:0,lastFrameHits:0,lastFrameMisses:0,uniqueShapesInMap:0,get hitRate(){const e=this.hits+this.misses;return e>0?this.hits/e*100:0},get totalDrawCalls(){return this.hits+this.misses}});this.memoryBudgetBytes=this.calculateMemoryBudget()}getStats(){return this.stats.cacheSize=this.cache.size,{...this.stats}}resetFrameStats(){this.stats.lastFrameHits=0,this.stats.lastFrameMisses=0}getMaxSize(){return this.maxSize}getMemoryUsage(){return this.totalMemoryBytes}getMemoryBudget(){return this.memoryBudgetBytes}calculateMemoryBudget(){const e=navigator.hardwareConcurrency||4,s=navigator.deviceMemory||4;return e<=4||s<=4?30*1024*1024:e<=8||s<=8?50*1024*1024:80*1024*1024}resetStats(){this.stats.hits=0,this.stats.misses=0,this.stats.totalRenders=0}normalizePath(e){if(e.length<2)return e;const s=e[0],n=e.map(a=>({x:a.x-s.x,y:a.y-s.y}));let o=0;for(let a=1;a<n.length;a++){const h=n[a].x-n[a-1].x,c=n[a].y-n[a-1].y,d=Math.hypot(h,c);o+=d}if(o<1e-6)return n;const i=n[n.length-1],r=Math.atan2(i.y,i.x);if(Math.hypot(i.x,i.y)>.001){const a=Math.cos(-r),h=Math.sin(-r);return n.map(c=>({x:c.x*a-c.y*h,y:c.x*h+c.y*a}))}return n}generatePathSignature(e){if(e.length<2)return"empty";const s=this.normalizePath(e),n=Math.min(32,s.length),o=[];if(s.length<=n)for(const r of s)o.push(`${r.x.toFixed(3)},${r.y.toFixed(3)}`);else for(let r=0;r<n;r++){const a=Math.floor(r/(n-1)*(s.length-1)),h=s[a];o.push(`${h.x.toFixed(3)},${h.y.toFixed(3)}`)}let i=0;for(let r=1;r<s.length-1;r++){const a=s[r-1],h=s[r],c=s[r+1],d=h.x-a.x,u=h.y-a.y,m=c.x-h.x,C=c.y-h.y,f=Math.atan2(u,d),P=Math.atan2(C,m);i+=Math.abs(P-f)}return`${o.join("|")}-curv:${i.toFixed(2)}`}hashPath(e,s,n,o){if(e.length<2)return`empty-${s}-${Math.round(n)}-${Math.round(o)}`;const i=this.normalizePath(e),r=Math.min(14,i.length),a=[];if(i.length<=r)for(const P of i)a.push(`${P.x.toFixed(2)},${P.y.toFixed(2)}`);else for(let P=0;P<r;P++){const L=Math.floor(P/(r-1)*(i.length-1)),I=i[L];a.push(`${I.x.toFixed(2)},${I.y.toFixed(2)}`)}let h=0;for(let P=1;P<i.length;P++){const L=i[P].x-i[P-1].x,I=i[P].y-i[P-1].y;h+=Math.hypot(L,I)}let c=0;for(let P=1;P<i.length-1;P++){const L=i[P-1],I=i[P],b=i[P+1],S=I.x-L.x,p=I.y-L.y,O=b.x-I.x,k=b.y-I.y,M=Math.atan2(p,S),v=Math.atan2(k,O);c+=Math.abs(v-M)}const d=Math.round(n),u=Math.round(o),m=h.toFixed(1),C=c.toFixed(2);return`${a.join("|")}-len:${m}-curv:${C}-pts:${e.length}-${s}-${d}-${u}`}get(e,s,n,o){const i=this.hashPath(e,s,n,o),r=this.cache.get(i);if(r){r.lastUsed=++this.accessCounter,r.accessCount++;const a=this.shapeUsageMap.get(i);a&&a.accessCount++,this.stats.hits++,this.stats.lastFrameHits++;const h=this.normalizePath(e),c=e[0],d=e[e.length-1],u=h[h.length-1],m=Math.atan2(d.y-c.y,d.x-c.x),C=Math.atan2(u.y,u.x),f=m-C;return{entry:r,transform:{tx:c.x,ty:c.y,angle:f,scale:1}}}return this.stats.misses++,this.stats.lastFrameMisses++,null}shouldCache(e,s,n,o,i){if(o>2e3||i>2e3)return!1;let a=0;for(let h=1;h<e.length;h++){const c=e[h].x-e[h-1].x,d=e[h].y-e[h-1].y;a+=Math.hypot(c,d)}return!(a<20)}set(e,s,n,o,i){const r=this.hashPath(e,s,n,o),a=i.canvas.width*i.canvas.height*4;if(i.memoryBytes=a,i.pathSignature=this.generatePathSignature(e),i.accessCount=0,(this.cache.size>=this.maxSize||this.totalMemoryBytes+a>this.memoryBudgetBytes)&&!this.cache.has(r)){let d=!1;if(this.shapeUsageMap.size>0){const u=[];for(const[m,C]of this.shapeUsageMap.entries())C.lastUsageTime<Date.now()-5e3&&u.push(m);if(u.length>0)for(const m of u)this.cache.delete(m),this.shapeUsageMap.delete(m),d=!0}d||this.evictByMemory(a)}const c=this.cache.get(r);c&&(this.totalMemoryBytes-=c.memoryBytes),i.lastUsed=++this.accessCounter,this.cache.set(r,i),this.totalMemoryBytes+=a,this.stats.totalRenders++}evictByMemory(e){const s=e+this.memoryBudgetBytes*.1,n=[],o=Date.now();for(const[r,a]of this.cache.entries()){const h=this.shapeUsageMap.get(r),c=h?h.lastUsageTime<o:!1,d=a.accessCount,u=a.memoryBytes;let m=0;c&&(m+=1e3),m+=u/1e3,m-=d*10,m+=(this.accessCounter-a.lastUsed)/100,n.push({key:r,entry:a,score:m})}n.sort((r,a)=>a.score-r.score);let i=0;for(const r of n){if(i>=s)break;this.cache.delete(r.key),this.shapeUsageMap.delete(r.key),this.totalMemoryBytes-=r.entry.memoryBytes,i+=r.entry.memoryBytes}}clear(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0}clearAll(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0,this.memoryBudgetBytes=this.calculateMemoryBudget()}renderShapeToCanvas(e,s,n,o,i){if(e.length<2)return null;let r=1/0,a=1/0,h=-1/0,c=-1/0;for(const p of e)p.x<r&&(r=p.x),p.y<a&&(a=p.y),p.x>h&&(h=p.x),p.y>c&&(c=p.y);const d=Math.ceil(Math.max(s,n)/2)+2,u=Math.max(1,Math.ceil(h-r+d*2)),m=Math.max(1,Math.ceil(c-a+d*2));if(!this.shouldCache(e,s,n,u,m))return null;const C=document.createElement("canvas");C.width=u,C.height=m;const f=C.getContext("2d",{willReadFrequently:!1});f.save(),f.translate(-r+d,-a+d),f.lineCap="round",f.lineJoin="round",f.globalCompositeOperation="source-over",f.globalAlpha=1,f.lineWidth=s,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let p=1;p<e.length;p++)f.lineTo(e[p].x,e[p].y);f.strokeStyle=o,f.stroke();const P=this.rgbFromCss(i)||{r:255,g:255,b:255},L=`rgba(${P.r}, ${P.g}, ${P.b}, 1)`;f.lineWidth=n,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let p=1;p<e.length;p++)f.lineTo(e[p].x,e[p].y);f.strokeStyle=L,f.stroke();const I=be(),b=we[I];f.globalCompositeOperation="soft-light",f.globalCompositeOperation!=="soft-light"&&(f.globalCompositeOperation="screen");const S=b.highlightPasses;for(let p=0;p<S;p++){const O=p/(S-1),k=Math.max(1,n*(.96-.7*O)),M=.15*(1-O)*(1-O);f.lineWidth=k,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let v=1;v<e.length;v++)f.lineTo(e[v].x,e[v].y);f.strokeStyle=`rgba(255,255,255,${M.toFixed(3)})`,f.stroke()}if(b.edgePasses>0){f.globalCompositeOperation="multiply";const p=b.edgePasses;for(let O=0;O<p;O++){const k=O/(p-1),M=Math.max(1,n*(.98-.08*k)),v=.1-.03*k;f.lineWidth=M,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let R=1;R<e.length;R++)f.lineTo(e[R].x,e[R].y);f.strokeStyle=`rgba(0,0,0,${Math.max(0,v).toFixed(3)})`,f.stroke()}}return f.restore(),{canvas:C,minX:r,minY:a,pad:d}}rgbFromCss(e){const s=e.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(s){const o=s[1],i=o.length===3?o.split("").map(c=>c+c).join(""):o,r=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),h=parseInt(i.slice(4,6),16);return{r,g:a,b:h}}const n=e.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return n?{r:Number(n[1]),g:Number(n[2]),b:Number(n[3])}:null}precalculateShapes(e,s,n,o,i=240,r="#ffffff"){if(this.shapeUsageMap.clear(),!e||!e.hitObjects)return;const a=o*2,h=Math.max(1,a-8),c=Math.max(1,a-14),d=xe(e),u=new Set,m=[];for(let O=0;O<e.hitObjects.length;O++){const k=e.hitObjects[O];if(k.kind!=="slider")continue;const M=k,v=ie(M.curveType,M.points),R=M.length;let _=v;if(R>0&&R<v.total){const X=re(v,R),st={pts:X,segLen:[],cumLen:[0],total:R};for(let $=1;$<X.length;$++){const l=X[$].x-X[$-1].x,F=X[$].y-X[$-1].y,at=Math.hypot(l,F);st.segLen.push(at),st.cumLen.push(st.cumLen[st.cumLen.length-1]+at)}_=st}const Q=d.colorIndex[O],et=n[Q%n.length],H=this.hashPath(_.pts,et,h,c);u.add(H);const{base:A,inherited:tt}=$t(e,M.time),ht=(A==null?void 0:A.beatLength)??500,y=tt==null?void 0:tt.beatLength,W=Ut(M,ht,s.SliderMultiplier,y),N=Math.max(1,M.slides),j=M.time+W*N+i,B=m.find(X=>X.cacheKey===H);B?(j>B.lastUsageTime&&(B.lastUsageTime=j),B.sliderIndices.push(O)):m.push({cacheKey:H,pts:_.pts,comboColor:et,lastUsageTime:j,sliderIndices:[O]})}const C=u.size;this.stats.uniqueShapesInMap=C;const f=200*200*4,P=Math.floor(this.memoryBudgetBytes/f);this.maxSize=Math.min(Math.ceil(C*.8),P,200);const L=6200,I=m.filter(O=>{var M;return O.sliderIndices.length>1?!0:(((M=e.hitObjects[O.sliderIndices[0]])==null?void 0:M.time)||1/0)<=L});for(const O of m)this.shapeUsageMap.set(O.cacheKey,{cacheKey:O.cacheKey,lastUsageTime:O.lastUsageTime,sliderIndices:O.sliderIndices,accessCount:0,isPreRendered:!1});const b=15;let S=0;const p=()=>{const O=S*b,k=Math.min(O+b,I.length);for(let M=O;M<k;M++){const v=I[M],R=this.normalizePath(v.pts),_=this.renderShapeToCanvas(R,h,c,r,v.comboColor);if(_){const Q={canvas:_.canvas,normalizedWidth:_.canvas.width,normalizedHeight:_.canvas.height,pad:_.pad,normMinX:_.minX,normMinY:_.minY,lastUsed:0,accessCount:0,memoryBytes:_.canvas.width*_.canvas.height*4,pathSignature:this.generatePathSignature(v.pts)};this.set(v.pts,v.comboColor,h,c,Q);const et=this.shapeUsageMap.get(v.cacheKey);et&&(et.isPreRendered=!0)}}S++,k<I.length&&(typeof requestIdleCallback<"u"?requestIdleCallback(p,{timeout:100}):setTimeout(p,0))};I.length>0&&(typeof requestIdleCallback<"u"?requestIdleCallback(p,{timeout:100}):setTimeout(p,0))}evictExpiredShapes(e){const s=[];for(const[n,o]of this.shapeUsageMap.entries())if(o.lastUsageTime<e){const i=this.cache.get(n);if(i){let r=0;r+=i.memoryBytes/1e3,r-=i.accessCount*10,r-=o.accessCount*5,r+=(this.accessCounter-i.lastUsed)/100,s.push({key:n,entry:i,info:o,score:r})}}s.sort((n,o)=>o.score-n.score);for(const n of s)this.cache.has(n.key)&&(this.cache.delete(n.key),this.totalMemoryBytes-=n.entry.memoryBytes),this.shapeUsageMap.delete(n.key);this.totalMemoryBytes>this.memoryBudgetBytes&&this.evictByMemory(0)}}const Et=new Ge;function Ve(){const t=navigator.hardwareConcurrency||4,e=navigator.deviceMemory||4;return t<=4||e<=4?"low":t<=8||e<=8?"medium":"high"}const we={high:{highlightPasses:16,edgePasses:3},medium:{highlightPasses:10,edgePasses:2},low:{highlightPasses:8,edgePasses:1}};let Qt=null;function be(){return Qt===null&&(Qt=Ve()),Qt}function Zt(t,e,s,n,o,i,r,a,h,c,d,u,m,C,f="core",P=1,L=240,I){if(s.kind==="circle"){if(f!=="core")return;const b=s.time-r,S=n<=s.time?St((n-b)/Math.max(1,a)):1,p=n<=s.time?1:St(1-(n-s.time)/400),O=St(S*p);if(O<=.001)return;const k=typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:qt(s.x,s.y,m);if(o!=null&&o.approachcircle){const v=1+2*St((s.time-n)/Math.max(1,r));le(t,k.x,k.y,i*v,.8*O,o,d)}o!=null&&o.hitcircle?(t.save(),Ht(t,k.x,k.y,i,o,O,d),o!=null&&o.digits&&he(t,k.x,k.y,i,o,u,O),t.restore()):(t.save(),t.globalAlpha=O,Wt(t,k.x,k.y,i,d),t.restore())}else if(s.kind==="slider"){const b=ie(s.curveType,s.points);let S,p,O,k,M;if(I)S=I.base,p=I.inherited,O=I.baseBeat,k=I.ih,M=I.span??Ut(s,O,h,k);else{const $=$t(e,s.time);S=$.base,p=$.inherited,O=(S==null?void 0:S.beatLength)??500,k=p==null?void 0:p.beatLength,M=Ut(s,O,h,k)}const v=Math.max(1,s.slides),R=s.time+M*v,_=s.time-r,Q=Math.max(1,Math.floor(r*.4)),et=Math.max(1,L);let H=0;n<_?H=0:n<s.time?H=St((n-_)/Q):n<=R?H=1:H=St(1-(n-R)/et);const A=s.length;let tt=b;if(A>0&&A<b.total){const $=re(b,A),l={pts:$,segLen:[],cumLen:[0],total:A};for(let F=1;F<$.length;F++){const at=$[F].x-$[F-1].x,K=$[F].y-$[F-1].y,dt=Math.hypot(at,K);l.segLen.push(dt),l.cumLen.push(l.cumLen[l.cumLen.length-1]+dt)}tt=l}const ht=tt.pts,y=!!C&&Xe(C.x,C.y,tt)<=Math.max(6,i*.35),W=typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:qt(s.x,s.y,m),N={x:W.x-s.x,y:W.y-s.y},V=ht.map($=>({x:$.x+N.x,y:$.y+N.y})),j=i*2,B=Math.max(1,j-8),X=Math.max(1,j-14),st=(o==null?void 0:o.sliderBorder)||"#ffffff";if(f==="body"){if(H<=.01)return;ze(t,V,B,X,st,d,H,1);return}if(f==="core"){const $=s.time+M*v,l=$-r,F=n<=$?St((n-l)/Math.max(1,a)):1,at=n<=$?1:St(1-(n-$)/400),K=St(F*at)*H,dt=(v-1)%2===0,gt=Ft(tt,dt?1:0),it={x:gt.x+N.x,y:gt.y+N.y};if(K>.001&&(o!=null&&o.hitcircle?Ht(t,it.x,it.y,i,o,K,d):(t.save(),t.globalAlpha=K,Wt(t,it.x,it.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const ot=i*2/(o.sliderendcircle.width||128),q=o.sliderendcircle.width*ot,rt=o.sliderendcircle.height*ot;t.save(),t.globalAlpha=K,t.translate(it.x,it.y),t.drawImage(o.sliderendcircle,-q/2,-rt/2,q,rt),t.restore()}if(v>1)for(let ot=0;ot<v-1;ot++){const rt=ot%2===0?1:0,U=Ft(tt,rt),Z={x:U.x+N.x,y:U.y+N.y},yt=s.time+M*(ot+1),bt=yt-r,Pt=n<=yt?St((n-bt)/Math.max(1,a)):1,w=n<=yt?1:St(1-(n-yt)/400),T=St(Pt*w);if(T>0&&(o!=null&&o.hitcircle?Ht(t,Z.x,Z.y,i,o,T,d):(t.save(),t.globalAlpha=T,Wt(t,Z.x,Z.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const D=i*2/(o.sliderendcircle.width||128),Y=o.sliderendcircle.width*D,G=o.sliderendcircle.height*D;t.save(),t.globalAlpha=T,t.translate(Z.x,Z.y),t.drawImage(o.sliderendcircle,-Y/2,-G/2,Y,G),t.restore()}}const nt=W,pt=s.time-r,vt=n<=s.time?St((n-pt)/Math.max(1,a)):1,xt=n<=s.time?1:St(1-(n-s.time)/400),wt=St(vt*xt)*H;if(wt>.001)if(o!=null&&o.hitcircle){if(t.save(),Ht(t,nt.x,nt.y,i,o,wt,d),o.sliderstartcircle){const ot=o.sliderstartcircle,q=i*2/(ot.width||128),rt=ot.width*q,U=ot.height*q;t.drawImage(ot,nt.x-rt/2,nt.y-U/2,rt,U)}o!=null&&o.digits&&he(t,nt.x,nt.y,i,o,u,wt),t.restore()}else t.save(),t.globalAlpha=wt,Wt(t,nt.x,nt.y,i,d),t.restore();if(o!=null&&o.approachcircle&&wt>.001){const q=1+2*St((s.time-n)/Math.max(1,r));le(t,nt.x,nt.y,i*q,.8*wt,o,d)}}if(f==="top"&&n>=s.time&&n<=R){const $=n-s.time,l=Math.floor($/M),F=$%M/M,K=l%2===0?F:1-F,dt=Ft(tt,K),gt={x:dt.x+N.x,y:dt.y+N.y};o!=null&&o.sliderfollowcircle&&H>.001&&Ue(t,gt.x,gt.y,i*1.6,o,H);const it=Math.max(4,Math.max(1,j-6)),nt=St(H);if(nt<=.001)return;const pt=.1/Math.max(1,tt.total),vt=Math.max(0,Math.min(1-pt,K)),xt=Math.min(1,K+pt),ft=Ft(tt,vt),wt=Ft(tt,xt),ot=ft.x-wt.x,q=ft.y-wt.y,U=(-90+-Math.atan2(ot,q)*180/Math.PI)*Math.PI/180,Z=o==null?void 0:o.sliderballFrames,yt=Z&&Z.length>0,bt=!!(o!=null&&o.sliderb),Pt=tt.total/(M*v),w=Math.max(.15/Pt*(1e3/60),1e3/60),T=yt?Math.floor($/w)%Z.length:0,D=d;if(o!=null&&o.sliderbnd&&Xt(t,o.sliderbnd,gt.x,gt.y,it,0,"#000000",nt,!1),yt){const Y=Z[T];Xt(t,Y,gt.x,gt.y,it,U,D,nt,!1)}else bt?Xt(t,o.sliderb,gt.x,gt.y,it,U,D,nt,!1):_e(t,gt.x,gt.y,it/2,d,nt);o!=null&&o.sliderbspec&&Xt(t,o.sliderbspec,gt.x,gt.y,it,0,"#ffffff",nt,!0)}if(f==="top"&&(o!=null&&o.reversearrow)&&v>1){let $=-1;for(let l=0;l<v-1;l++){const F=s.time+M*(l+1);if(n<F){$=l;break}}for(let l=0;l<v-1;l++){if($===-1)continue;let F=!1;if((l===$||$>0&&l===$-1)&&(F=!0),!F)continue;const at=l%2===0,dt=Ft(tt,at?1:0),gt={x:dt.x+N.x,y:dt.y+N.y},it=Be(tt,at?1-.001:.001)+(at?Math.PI:0),nt=s.time+M*(l+1),pt=nt-r,vt=300,xt=150,ft=((Math.min(n,nt)-pt)%vt+vt)%vt;let wt=0,ot=1;if(n>nt){const q=1.3-Dt(ft/vt)*.3,rt=1.4-q,U=Math.min(300,M),Z=St((n-nt)/U);ot=q+Dt(Z)*rt,wt=Dt(1-Z)}else if(n>=pt){wt=St((n-pt)/xt);const q=35,rt=250;if(ft<q)ot=1+Dt(ft/q)*.3;else{const U=(ft-q)/(q+rt);ot=1.3-Dt(U)*.3}}if(wt*=H,wt>.01){t.save(),t.globalAlpha=wt,t.translate(gt.x,gt.y),t.rotate(it),t.scale(ot,ot);const q=i*2*.72/(o.reversearrow.width||128),rt=o.reversearrow.width*q,U=o.reversearrow.height*q;t.drawImage(o.reversearrow,-rt/2,-U/2,rt,U),t.restore()}}}if(f==="top"&&(o!=null&&o.sliderscorepoint)){const l={x:s.x+N.x,y:s.y+N.y},F=(v-1)%2===0,at=Ft(tt,F?1:0),K={x:at.x+N.x,y:at.y+N.y};for(let dt=0;dt<v;dt++){const gt=dt%2===1,it=He(s,O,h,k,c);for(const nt of it){const pt=gt?1-nt:nt,vt=Ft(tt,pt),xt={x:vt.x+N.x,y:vt.y+N.y},ft=s.time+M*dt+M*nt,wt=Math.hypot(xt.x-l.x,xt.y-l.y),ot=Math.hypot(xt.x-K.x,xt.y-K.y);if(wt<i||ot<i)continue;const q=ft-r;let rt=0;if(n<ft?rt=St((n-q)/Math.max(1,a)):rt=St(1-(n-ft)/200),rt*=H,rt<=.001)continue;const U=i*.15;t.save(),t.globalAlpha=rt,t.translate(xt.x,xt.y);const Z=o.sliderscorepoint,yt=U*2/(Z.width||64);t.drawImage(Z,-Z.width*yt/2,-Z.height*yt/2,Z.width*yt,Z.height*yt),t.restore()}}}if(f==="top"&&y&&s.points.length>0){t.save(),t.globalAlpha=H,t.strokeStyle="#efefef",t.lineWidth=1,t.beginPath();const $=s.points[0];t.moveTo($.x+N.x,$.y+N.y);for(let F=1;F<s.points.length;F++){const at=s.points[F];t.lineTo(at.x+N.x,at.y+N.y)}t.stroke();const l=F=>{if(F===0)return!1;if(s.curveType!=="B")return F>0;const at=s.points[F-1],K=s.points[F];return at.x===K.x&&at.y===K.y};for(let F=0;F<s.points.length;F++){const at=s.points[F],K=at.x+N.x,dt=at.y+N.y;F===0?t.fillStyle="#efefef":l(F)?t.fillStyle="#ff0000":s.curveType==="B"?t.fillStyle="#efefef":t.fillStyle="#ff0000",t.beginPath(),t.arc(K,dt,2,0,Math.PI*2),t.fill()}t.restore()}}else if(s.kind==="spinner"){if(f!=="core")return;const b=Ot/2,S=Nt/2,p=s.time-r,O=800,k=s.endTime;if(n<p||n>k+O)return;let M=1;if(n<s.time?M=St((n-p)/Math.max(1,a)):n>=s.time&&(M=1-St((n-k)/O)),M<=.001)return;const v=15;if(o!=null&&o.spinnerBottom){const R=o.spinnerBottom,_=v*2/(R.width||128),Q=R.width*_,et=R.height*_;t.save(),t.globalAlpha=M,t.translate(b,S),t.drawImage(R,-Q/2,-et/2,Q,et),t.restore()}else t.save(),t.globalAlpha=M,t.beginPath(),t.arc(b,S,v,0,Math.PI*2),t.strokeStyle="#f9d66b",t.lineWidth=3,t.stroke(),t.restore();if(o!=null&&o.spinnerApproachcircle){const R=o.spinnerApproachcircle,Q=Nt*.9/2,et=v,H=50,A=k-s.time;let tt=0,ht=Q;if(n>=p&&n<k+H){if(n<s.time){const y=Math.min(a,r);tt=Math.min(1,Math.max(0,(n-p)/Math.max(1,y))),ht=Q}else if(n>=s.time){const y=St((n-s.time)/Math.max(1,A));tt=(1-St((n-k)/H))*.9,ht=Q-(Q-et)*y}if(tt>.001){const y=ht*2/(R.width||128),W=R.width*y,N=R.height*y;t.save(),t.globalAlpha=tt,t.translate(b,S),t.drawImage(R,-W/2,-N/2,W,N),t.restore()}}}}}function qe(t,e,s,n,o,i,r,a){const h=r.followpoint,c=32;for(let d=0;d<s.length-1;d++){const u=s[d].obj,m=s[d+1].obj,C=s[d].idx,f=s[d+1].idx,P=oe(e,u);if(m.time-P<=0||m.newCombo)continue;const I=ve(e,u),b=ae(m),S=qt(I.x,I.y,a[C]||0),p=qt(b.x,b.y,a[f]||0),O=p.x-S.x,k=p.y-S.y,M=Math.hypot(O,k);if(M<80)continue;const v=Math.floor((M-48)/c);if(v<=0)continue;const R=u.kind==="slider"?oe(e,u):u.time,Q=m.time-R;if(Q<=0)continue;const et=Math.atan2(k,O),A=Math.max(4,i*.15)*2/(h.width||64),tt=Math.max(1,Math.floor(o*.4));t.save(),t.globalCompositeOperation="source-over",t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high";for(let ht=0;ht<v;ht++){const W=c*(1.5+ht)/M;if(W>=1)continue;const N=R+W*Q,V=N-o;let j=0;if(n<V)j=0;else if(n<V+tt){const st=(n-V)/tt;j=Dt(St(st))}else if(n<N)j=1;else{const st=(n-N)/tt;j=1-Dt(St(st))}if(j<=0)continue;const B=S.x+O*W,X=S.y+k*W;t.save(),t.globalAlpha=.9*j,t.translate(B,X),t.rotate(et),t.drawImage(h,-(h.width*A)/2,-(h.height*A)/2,h.width*A,h.height*A),t.restore()}t.restore()}}function Me(t,e,s){const r=x.useRef(null),a=x.useRef(null),h=x.useRef(0);x.useEffect(()=>{const c=t.current;if(!c)return;const d=()=>{const C=c.getBoundingClientRect(),f=Math.floor(C.width),P=Math.floor(C.height);r.current&&r.current.width===f&&r.current.height===P||(r.current={width:f,height:P},a.current!==null&&clearTimeout(a.current),a.current=window.setTimeout(()=>{const L=performance.now();L-h.current>=100&&(h.current=L,e())},100))},u=window.ResizeObserver;let m=null;return u?(m=new u(d),m.observe(c)):window.addEventListener("resize",d),d(),()=>{m?m.disconnect():window.removeEventListener("resize",d),a.current!==null&&clearTimeout(a.current)}},[t,e,100,100])}const de=({beatmap:t,timeSec:e,backgroundUrl:s,skin:n,sliderBodyCutoffPx:o=1,sliderFadeOutMs:i=240})=>{const r=x.useRef(null),a=x.useRef(null),[h,c]=kt.useState(0),[d,u]=kt.useState(0),[m,C]=kt.useState(null),[f,P]=kt.useState(Et.getStats()),L=x.useRef(0),[I,b]=kt.useState(0),S=x.useRef({lastTime:performance.now(),frameCount:0,fps:0}),[p,O]=kt.useState(!1),k=x.useRef(null),[M,v]=kt.useState(!1),R=x.useMemo(()=>Kt(t==null?void 0:t.difficulty),[t]);x.useEffect(()=>{if(k.current){const y=k.current.parentElement,W=!!(y!=null&&y.classList.contains("playfield-container")&&!y.closest(".embed-preview-playfield")&&!y.closest(".embed-preview-body"));v(W)}},[]);const _=x.useMemo(()=>ge(R.CS),[R.CS]),Q=x.useMemo(()=>ye(R.AR),[R.AR]),et=x.useMemo(()=>Ne(R.AR),[R.AR]),H=x.useMemo(()=>{var N;const y=(N=t==null?void 0:t.colors)==null?void 0:N.comboColors;if(y&&y.length)return y;const W=n==null?void 0:n.comboColors;return W&&W.length?W:["#FF66AA","#99CCFF","#99FF99","#FFFF66"]},[t==null?void 0:t.colors,n==null?void 0:n.comboColors]),A=x.useMemo(()=>xe(t),[t]),tt=x.useMemo(()=>Ye(t),[t]);x.useEffect(()=>{if(!s){a.current=null;return}const y=new Image;return y.onload=()=>{a.current=y,c(W=>W+1)},y.onerror=()=>{a.current=null,c(W=>W+1)},y.src=s,a.current=y,()=>{y.onload=null,y.onerror=null}},[s]);const ht=x.useCallback(()=>{u(y=>y+1)},[]);return Me(r,ht),x.useEffect(()=>{const y=r.current;if(!y)return;Et.evictExpiredShapes(e*1e3);const W=window.devicePixelRatio||1,N=y.getBoundingClientRect(),V=Math.max(100,N.width),j=Math.max(100,N.height);y.width=Math.round(V*W),y.height=Math.round(j*W);const B=y.getContext("2d",{willReadFrequently:!1});B.setTransform(W,0,0,W,0,0),B.globalCompositeOperation="source-over",B.clearRect(0,0,V,j),B.fillStyle="#02060d",B.fillRect(0,0,V,j);const X=a.current;if(X&&X.complete){const K=Math.max(V/X.width,j/X.height),dt=X.width*K,gt=X.height*K;B.globalAlpha=.2,B.drawImage(X,(V-dt)/2,(j-gt)/2,dt,gt),B.globalAlpha=1}const st=16,$=Math.min((V-st*2)/Ot,(j-st*2)/Nt),l=(V-Ot*$)/2,F=(j-Nt*$)/2;if(B.save(),B.translate(l,F),B.scale($,$),B.strokeStyle="#2a3955",B.lineWidth=2/$,B.strokeRect(0,0,Ot,Nt),t){const K=e*1e3,dt=1200,gt=2e3,it=t.hitObjects,nt=K-dt,pt=K+gt,vt=nt-1e4;let xt=0,ft=it.length;for(;xt<ft;){const U=xt+ft>>>1;it[U].time<vt?xt=U+1:ft=U}const wt=xt;for(xt=0,ft=it.length;xt<ft;){const U=xt+ft>>>1;it[U].time<=pt?xt=U+1:ft=U}const ot=xt,q=[];for(let U=wt;U<ot;U++){const Z=it[U],yt=Z.time;let bt=yt+600,Pt;if(Z.kind==="spinner")bt=Z.endTime;else if(Z.kind==="slider"){const{base:w,inherited:T}=$t(t,Z.time),D=(w==null?void 0:w.beatLength)??500,Y=T==null?void 0:T.beatLength,G=Ut(Z,D,R.SliderMultiplier,Y);bt=Z.time+G*Math.max(1,Z.slides),Pt={base:w,inherited:T,baseBeat:D,ih:Y,span:G}}bt>=nt&&yt<=pt&&q.push({o:Z,idx:U,startTime:yt,endTime:bt,timing:Pt})}q.sort((U,Z)=>U.startTime!==Z.startTime?U.startTime-Z.startTime:U.idx-Z.idx);const rt=q.map(U=>({obj:U.o,idx:U.idx}));n!=null&&n.followpoint&&qe(B,t,rt,K,Q,_,n,tt);for(let U=q.length-1;U>=0;U--){const{o:Z,idx:yt,timing:bt}=q[U],Pt=H[A.colorIndex[yt]%H.length],w=A.number[yt],T=tt[yt];Z.kind==="slider"&&Zt(B,t,Z,K,n,_,Q,et,R.SliderMultiplier,R.SliderTickRate,Pt,w,T,m,"body",o,i,bt),Zt(B,t,Z,K,n,_,Q,et,R.SliderMultiplier,R.SliderTickRate,Pt,w,T,m,"core",o,i,bt),Z.kind==="slider"&&Zt(B,t,Z,K,n,_,Q,et,R.SliderMultiplier,R.SliderTickRate,Pt,0,T,m,"top",o,i,bt)}}if(B.restore(),L.current++,L.current%10===0){const K=Et.getStats();P(K),Et.resetFrameStats()}const at=performance.now();S.current.frameCount++,at-S.current.lastTime>=1e3&&(S.current.fps=S.current.frameCount,S.current.frameCount=0,S.current.lastTime=at,b(S.current.fps))},[t,e,s,h,_,Q,et,n,R.SliderMultiplier,R.SliderTickRate,o,i,d,m]),x.useEffect(()=>{const y=r.current;if(!y)return;const W=V=>{const j=y.getBoundingClientRect(),B=16,X=Math.min((j.width-B*2)/Ot,(j.height-B*2)/Nt),st=(j.width-Ot*X)/2,$=(j.height-Nt*X)/2,l=(V.clientX-j.left-st)/X,F=(V.clientY-j.top-$)/X;l>=0&&l<=Ot&&F>=0&&F<=Nt?C({x:l,y:F}):C(null)},N=()=>{C(null)};return y.addEventListener("mousemove",W),y.addEventListener("mouseleave",N),()=>{y.removeEventListener("mousemove",W),y.removeEventListener("mouseleave",N);const V=y.getContext("2d");V&&V.clearRect(0,0,y.width,y.height)}},[]),g.jsxs("div",{ref:k,style:{position:"relative",width:"100%",height:"100%"},children:[g.jsx("canvas",{ref:r,className:"playfield",style:{width:"100%",height:"100%",display:"block"}}),M&&g.jsxs("div",{style:{position:"absolute",top:"8px",right:"8px",background:"#0d111e",color:"#cdd6f4",borderRadius:"4px",fontFamily:"monospace",fontSize:p?"11px":"12px",lineHeight:"1.4",minWidth:p?"220px":"auto",zIndex:1e3,border:"1px solid rgba(255, 255, 255, 0.1)",overflow:"hidden"},children:[g.jsxs("div",{style:{padding:p?"8px 12px":"4px 8px",cursor:"pointer",userSelect:"none",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:p?"1px solid rgba(255,255,255,0.1)":"none",gap:"8px"},onClick:()=>O(!p),children:[p?g.jsx("span",{style:{fontWeight:600,color:"#cdd6f4",textTransform:"lowercase"},children:"performance"}):g.jsxs("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 6px",borderRadius:"4px"},children:[I," fps"]}),g.jsx("span",{style:{color:"#89b4fa",fontSize:"10px"},children:p?"▼":"▶"})]}),p&&g.jsxs("div",{style:{padding:"12px"},children:[g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"fps:"}),g.jsx("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:I})]}),g.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"slider cache (cumulative)"}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"total draw calls:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.totalDrawCalls.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache hits:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.hits.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache misses:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.misses.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hit rate:"}),g.jsxs("span",{style:{color:"#89b4fa",background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:[f.hitRate.toFixed(1),"%"]})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"unique shapes:"}),g.jsxs("span",{style:{color:"#89b4fa"},children:[f.uniqueShapesInMap||f.totalRenders," (cached: ",f.cacheSize,")"]})]}),g.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"per frame (last 10)"}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"draw calls/frame:"}),g.jsx("span",{style:{color:"#89b4fa"},children:(f.lastFrameHits+f.lastFrameMisses).toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hits/frame:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.lastFrameHits.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"misses/frame:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.lastFrameMisses.toLocaleString()})]})]})]})]})},ue=({isPlaying:t,onPlayPause:e,currentTime:s,duration:n,onSeek:o,onScrubStart:i,onScrubEnd:r,bpm:a,sliderVelocity:h,timingPoints:c})=>{const d=x.useRef(null),u=x.useRef(null),m=x.useRef(null),[C,f]=x.useState(!1),P=x.useRef(null),L=x.useRef(!1),I=M=>{const v=Math.max(0,Math.floor(M*1e3)),R=Math.floor(v/6e4)%100,_=Math.floor(v%6e4/1e3)%60,Q=Math.floor(v%1e3);return`${String(R).padStart(2,"0")}:${String(_).padStart(2,"0")}.${String(Q).padStart(3,"0")}`},b=x.useCallback(M=>{if(!d.current)return 0;const v=d.current.getBoundingClientRect(),R=M-v.left;return Math.max(0,Math.min(1,R/v.width))*n},[n]),S=M=>{f(!0),i==null||i();const v=b(M.clientX);o(v)},p=M=>{if(M.preventDefault(),M.touches.length===0)return;f(!0),i==null||i();const v=b(M.touches[0].clientX);o(v)},O=M=>{if(M.preventDefault(),!Number.isFinite(n)||n<=0)return;L.current||(L.current=!0,i==null||i()),P.current!==null&&clearTimeout(P.current);const v=M.shiftKey?1:.1,R=M.deltaY>0?1:-1,_=Math.max(0,Math.min(n,s+R*v));o(_),P.current=window.setTimeout(()=>{L.current=!1,r==null||r(),P.current=null},150)};x.useEffect(()=>()=>{P.current!==null&&clearTimeout(P.current)},[]),x.useEffect(()=>{if(!C)return;const M=Q=>{const et=b(Q.clientX);o(et)},v=Q=>{if(Q.preventDefault(),Q.touches.length===0)return;const et=b(Q.touches[0].clientX);o(et)},R=()=>{f(!1),r==null||r()},_=Q=>{if(m.current&&Q.changedTouches.length>0){const et=Q.changedTouches[0],H=document.elementFromPoint(et.clientX,et.clientY);H&&m.current.contains(H)&&Q.preventDefault()}f(!1),r==null||r()};return window.addEventListener("mousemove",M),window.addEventListener("mouseup",R),window.addEventListener("touchmove",v,{passive:!1}),window.addEventListener("touchend",_),window.addEventListener("touchcancel",_),()=>{window.removeEventListener("mousemove",M),window.removeEventListener("mouseup",R),window.removeEventListener("touchmove",v),window.removeEventListener("touchend",_),window.removeEventListener("touchcancel",_)}},[C,n,o,r,b]);const k=n>0?Math.max(0,Math.min(1,s/n)):0;return x.useEffect(()=>{const M=d.current,v=u.current;if(!M||!v)return;const R=M.getBoundingClientRect(),_=Math.max(1,Math.floor(R.width)),Q=Math.max(1,Math.floor(R.height)),et=window.devicePixelRatio||1;(v.width!==Math.round(_*et)||v.height!==Math.round(Q*et))&&(v.width=Math.round(_*et),v.height=Math.round(Q*et));const H=v.getContext("2d");H.setTransform(et,0,0,et,0,0),H.clearRect(0,0,_,Q);const A=Array.isArray(c)?c:[];for(let ht=0;ht<A.length;ht++){const y=A[ht],W=A[ht+1];if(typeof y.effects=="number"&&(y.effects&1)===1){const V=Math.max(0,y.time/1e3),j=Math.min(n,(W?W.time:n*1e3)/1e3);if(j>V){const B=Math.floor(V/n*_),X=Math.ceil(j/n*_);H.fillStyle="rgba(245, 158, 11, 0.4)";const st=Math.max(1,Math.round(Q/1.6)),$=Math.round((Q-st)/2);H.fillRect(B,$,Math.max(1,X-B),st)}}}const tt=(ht,y,W)=>{const N=Math.max(0,ht.time/1e3),V=Math.floor(N/(n||1)*_),j=Math.max(1,Math.round(W)),B=j/2,X=Q-j/2;H.save(),H.strokeStyle=y,H.lineWidth=j,H.lineCap="round",H.beginPath(),H.moveTo(V+.5,B),H.lineTo(V+.5,X),H.stroke(),H.restore()};for(const ht of A)(typeof ht.uninherited=="number"?ht.uninherited===1:(ht.beatLength||0)>0)||tt(ht,"#22c55e",2);for(const ht of A)(typeof ht.uninherited=="number"?ht.uninherited===1:(ht.beatLength||0)>0)&&tt(ht,"#ef4444",3)},[c,n]),g.jsxs("div",{className:"editor-controls-container",ref:m,children:[g.jsxs("div",{className:"controls-timestamp",children:[g.jsx("div",{className:"timestamp-display",children:I(s)}),g.jsxs("div",{className:"timing-info",children:[g.jsxs("span",{className:"bpm-display",children:[a.toFixed(0),"BPM"]}),g.jsx("span",{className:"sv-display",children:n>0?`${Math.round(s/n*100)}%`:"0%"})]})]}),g.jsxs("div",{className:"controls-center",children:[g.jsx("button",{className:"controls-play-button",onClick:e,title:t?"Pause (Space)":"Play (Space)",children:t?g.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:[g.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),g.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]}):g.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:g.jsx("path",{d:"M8 5v14l11-7z"})})}),g.jsx("div",{className:"controls-progress-wrapper",ref:d,onMouseDown:S,onTouchStart:p,onWheel:O,children:g.jsxs("div",{className:"progress-bar-track",children:[g.jsx("canvas",{ref:u,className:"progress-markers"}),g.jsx("div",{className:"progress-bar-fill",style:{width:`${k*100}%`}}),g.jsx("div",{className:"progress-bar-thumb",style:{left:`${k*100}%`}})]})})]})]})},fe=({masterVolume:t,songVolume:e,hitsoundVolume:s,onMasterVolumeChange:n,onSongVolumeChange:o,onHitsoundVolumeChange:i})=>{const[r,a]=x.useState(!1),h=x.useRef(null),c=x.useRef(null);x.useEffect(()=>{if(!r)return;const u=m=>{h.current&&!h.current.contains(m.target)&&c.current&&!c.current.contains(m.target)&&a(!1)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[r]);const d=u=>`${Math.round(u*100)}%`;return g.jsxs("div",{className:"volume-control-wrapper",children:[g.jsx("button",{ref:c,className:"volume-control-button",onClick:u=>{u.stopPropagation(),a(!r)},"aria-label":"Volume controls","aria-expanded":r,children:t>0?g.jsx(Re,{size:20}):g.jsx(Ie,{size:20})}),r&&g.jsxs("div",{ref:h,className:"volume-control-menu",children:[g.jsxs("div",{className:"volume-control-item",children:[g.jsx("label",{className:"volume-label",children:"Master"}),g.jsxs("div",{className:"volume-slider-container",children:[g.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:t,onChange:u=>n(parseFloat(u.target.value)),className:"volume-slider"}),g.jsx("span",{className:"volume-value",children:d(t)})]})]}),g.jsxs("div",{className:"volume-control-item",children:[g.jsx("label",{className:"volume-label",children:"Song"}),g.jsxs("div",{className:"volume-slider-container",children:[g.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,onChange:u=>o(parseFloat(u.target.value)),className:"volume-slider"}),g.jsx("span",{className:"volume-value",children:d(e)})]})]}),g.jsxs("div",{className:"volume-control-item",children:[g.jsx("label",{className:"volume-label",children:"Hitsounds"}),g.jsxs("div",{className:"volume-slider-container",children:[g.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:s,onChange:u=>i(parseFloat(u.target.value)),className:"volume-slider"}),g.jsx("span",{className:"volume-value",children:d(s)})]})]})]})]})};async function me(t){const e=await Ee.loadAsync(t instanceof File?t:new Blob([t])),s=Object.keys(e.files);async function n(r){const a=e.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("text")}async function o(r){const a=e.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("arraybuffer")}function i(r){return s.find(r)}return{list:s,readText:n,readArrayBuffer:o,findFirst:i}}function Yt(t){const e=t.indexOf(":");if(e===-1)return null;const s=t.slice(0,e).trim(),n=t.slice(e+1).trim();return[s,n]}function te(t){const e=t.split(/\r?\n/);let s="";const n={},o={},i={},r=[],a=[],h={comboColors:[]};let c="osu file format v?";for(let I=0;I<e.length;I++){const S=e[I].trim();if(S){if(I===0&&/^osu file format/.test(S)){c=S;continue}if(S.startsWith("[")&&S.endsWith("]")){s=S.slice(1,-1);continue}if(!S.startsWith("//"))switch(s){case"General":{const p=Yt(S);p&&(n[p[0]]=p[1]);break}case"Metadata":{const p=Yt(S);p&&(o[p[0]]=p[1]);break}case"Difficulty":{const p=Yt(S);if(!p)break;const O=Number(p[1]);i[p[0]]=Number.isFinite(O)?O:p[1];break}case"TimingPoints":{const p=S.split(",").map(k=>k.trim()),O={time:Number(p[0]||0),beatLength:Number(p[1]||0),meter:Number(p[2]||4),sampleSet:p[3]?Number(p[3]):void 0,sampleIndex:p[4]?Number(p[4]):void 0,volume:p[5]?Number(p[5]):void 0,uninherited:p[6]?Number(p[6]):void 0,effects:p[7]?Number(p[7]):void 0};r.push(O);break}case"Colours":{const p=Yt(S);if(!p)break;const[O,k]=p,M=v=>{const R=v.split(",").map(A=>A.trim());if(R.length<3)return null;const _=Math.max(0,Math.min(255,Number(R[0]||0))),Q=Math.max(0,Math.min(255,Number(R[1]||0))),et=Math.max(0,Math.min(255,Number(R[2]||0))),H=A=>A.toString(16).padStart(2,"0");return`#${H(_)}${H(Q)}${H(et)}`};if(/^Combo\d+$/i.test(O)){const v=M(k);v&&h.comboColors.push(v)}else if(/^SliderBorder$/i.test(O)){const v=M(k);v&&(h.sliderBorder=v)}else if(/^SliderTrackOverride$/i.test(O)){const v=M(k);v&&(h.sliderTrackOverride=v)}break}case"HitObjects":{const p=S.split(","),O=Number(p[0]),k=Number(p[1]),M=Number(p[2]),v=Number(p[3]),R=Number(p[4]||0),_=H=>{if(!H||!H.includes(":"))return;const A=H.split(":"),tt=A[0]!==""?Number(A[0]):void 0,ht=A[1]!==""?Number(A[1]):void 0,y=A[2]!==""?Number(A[2]):void 0,W=A[3]!==""?Number(A[3]):void 0,N=A[4]&&A[4]!==""?A[4]:void 0;return{sampleSet:tt,additionSet:ht,customIndex:y,sampleVolume:W,filename:N}},Q=(v&4)===4,et=(v&112)>>4;if((v&1)===1){const H=_(p[5]);a.push({kind:"circle",x:O,y:k,time:M,hitSound:R,hitSample:H,newCombo:Q,comboSkip:et})}else if((v&2)===2){const H=String(p[5]||""),[A,...tt]=H.split("|"),ht=(A||"B").slice(0,1).toUpperCase(),y=Number(p[6]||1),W=Number(p[7]||0),N=[{x:O,y:k}];for(const st of tt){const[$,l]=st.split(":");$&&l&&N.push({x:Number($),y:Number(l)})}let V;p[8]&&(V=String(p[8]).split("|").map(st=>Number(st||0)));let j;p[9]&&(j=String(p[9]).split("|").map(st=>{const[$,l]=st.split(":"),F=$&&$!==""?Number($):void 0,at=l&&l!==""?Number(l):void 0;return{sampleSet:F,additionSet:at}}));const B=p[p.length-1],X=_(B);a.push({kind:"slider",x:O,y:k,time:M,hitSound:R,curveType:ht,points:N,slides:y,length:W,edgeSounds:V,edgeSets:j,hitSample:X,newCombo:Q,comboSkip:et})}else if((v&8)===8){const H=Number(p[5]||M),A=_(p[6]);a.push({kind:"spinner",time:M,endTime:H,hitSample:A,newCombo:Q,comboSkip:et})}break}}}}const d=Number(n.Mode||"0"),m=["standard","taiko","catch","mania"][Math.max(0,Math.min(3,d))],C=n.AudioFilename;let f;const P=e.findIndex(I=>I.trim()==="[Events]");if(P!==-1)for(let I=P+1;I<e.length;I++){const b=e[I].trim();if(!b||b.startsWith("["))break;const S=b.match(/\"([^\"]+)\"/);if(S){f=S[1];break}}const L={comboColors:h.comboColors.length?h.comboColors:void 0,sliderBorder:h.sliderBorder,sliderTrackOverride:h.sliderTrackOverride};return{format:c,mode:m,general:n,metadata:o,difficulty:i,timingPoints:r,hitObjects:a,audioFilename:C,backgroundFilename:f,colors:L}}async function Ke(t,e){var s,n,o,i;try{const r="https://esm.sh/osu-parsers@4.1.7?bundle",a="https://esm.sh/osu-standard-stable@5.0.1?bundle";let h,c;try{h=await import(r),c=await import(a)}catch{const b="osu-parsers",S="osu-standard-stable";h=await import(b),c=await import(S)}const d=new h.BeatmapDecoder,u=new c.StandardRuleset,m=u.applyToBeatmapWithMods(d.decodeFromString(t),u.createModCombination("")),C=c.Circle,f=c.Slider,P=c.Spinner,L=m.hitObjects.filter(b=>b instanceof C||b instanceof f||b instanceof P),I=Math.min(L.length,e.hitObjects.length);for(let b=0;b<I;b++){const S=L[b],p=e.hitObjects[b];if(S instanceof P)continue;const O=(S.startX??((s=S.startPosition)==null?void 0:s.x)??S.x??0)+(((n=S.stackedOffset)==null?void 0:n.x)??0),k=(S.startY??((o=S.startPosition)==null?void 0:o.y)??S.y??0)+(((i=S.stackedOffset)==null?void 0:i.y)??0);p.stackedX=O,p.stackedY=k}return e}catch{return e}}class Je{constructor(){Mt(this,"ctx",null);Mt(this,"buffer",null);Mt(this,"src",null);Mt(this,"gainNode",null);Mt(this,"startCtxTime",0);Mt(this,"startOffset",0);Mt(this,"_onTick");Mt(this,"raf",0);Mt(this,"_volume",1);Mt(this,"tick",()=>{this._onTick&&this._onTick(this.currentTime),this.raf=requestAnimationFrame(this.tick)})}get duration(){var e;return((e=this.buffer)==null?void 0:e.duration)??0}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this.gainNode&&(this.gainNode.gain.value=this._volume)}async load(e){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext));const s=await this.ctx.decodeAudioData(e.slice(0));this.buffer=s,this.stop()}ensureSrc(){!this.ctx||!this.buffer||(this.gainNode||(this.gainNode=this.ctx.createGain(),this.gainNode.gain.value=this._volume,this.gainNode.connect(this.ctx.destination)),this.src=this.ctx.createBufferSource(),this.src.buffer=this.buffer,this.src.connect(this.gainNode),this.src.onended=()=>{cancelAnimationFrame(this.raf),this.raf=0})}play(e){!this.ctx||!this.buffer||(this.stop(),this.ensureSrc(),this.src&&(this.startOffset=typeof e=="number"?e:this.currentTime,this.startCtxTime=this.ctx.currentTime,this.src.start(0,this.startOffset),this.tick()))}pause(){if(!this.ctx)return;const e=this.currentTime;this.stop(),this.startOffset=e}seek(e){if(!this.ctx)return;const s=!!this.src;this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,e)),s&&this.play(this.startOffset)}setPosition(e){this.ctx&&(this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,e)))}stop(){if(this.src){try{this.src.stop()}catch{}try{this.src.disconnect()}catch{}}this.src=null,this.raf&&cancelAnimationFrame(this.raf),this.raf=0}get isPlaying(){return!!this.src}get currentTime(){if(!this.ctx)return 0;if(!this.src)return Math.min(this.duration,this.startOffset);const e=this.ctx.currentTime-this.startCtxTime;return Math.max(0,Math.min(this.duration,this.startOffset+e))}onTick(e){this._onTick=e}getBuffer(){return this.buffer}getContext(){return this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx}}const Gt={1:"normal",2:"soft",3:"drum"};function Qe(t){const e=["hitnormal"];return t&2&&e.push("hitwhistle"),t&4&&e.push("hitfinish"),t&8&&e.push("hitclap"),e}class Vt{constructor(e){Mt(this,"ctx");Mt(this,"buffers",new Map);Mt(this,"loading",null);Mt(this,"slideSrc",null);Mt(this,"slideGain",null);Mt(this,"whistleSrc",null);Mt(this,"whistleGain",null);Mt(this,"active",new Set);Mt(this,"masterGain",null);Mt(this,"_volume",1);this.ctx=e,this.masterGain=e.createGain(),this.masterGain.gain.value=this._volume,this.masterGain.connect(e.destination)}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this.masterGain&&(this.masterGain.gain.value=this._volume)}async load(e){if(e||(e="/img/"),e.endsWith("/")||(e+="/"),this.loading)return this.loading;const s=[];for(const n of["normal","soft","drum"])for(const o of["hitnormal","hitwhistle","hitfinish","hitclap","slidertick","sliderslide","sliderwhistle"])s.push(`${n}-${o}.wav`);return this.loading=(async()=>{await Promise.all(s.map(async n=>{try{const o=await fetch(e+n);if(!o.ok)return;const i=await o.arrayBuffer(),r=await this.ctx.decodeAudioData(i.slice(0));this.buffers.set(n,r)}catch{}}))})(),this.loading}playFile(e,s=0,n=.8){const o=this.buffers.get(e);if(!o)return;try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const i=this.ctx.createBufferSource(),r=this.ctx.createGain();r.gain.value=n,i.buffer=o,i.connect(r),this.masterGain?r.connect(this.masterGain):r.connect(this.ctx.destination);const a=Math.max(this.ctx.currentTime,s);i.onended=()=>{try{i.disconnect()}catch{}try{r.disconnect()}catch{}this.active.delete(i)};try{i.start(a)}catch{}this.active.add(i)}playWithFallback(e,s,n=0,o=.8){const i=[s,"normal","soft","drum"],r=new Set;for(const h of i){const c=`${h}-${e}.wav`;if(r.has(c))continue;if(r.add(c),this.buffers.get(c))return this.playFile(c,n,o),!0}const a=`${e}.wav`;return this.buffers.get(a)?(this.playFile(a,n,o),!0):!1}playHit(e,s,n){const o=Qe(s);for(const i of o)this.playFile(`${e}-${i}.wav`,n)}playTick(e,s){this.playFile(`${e}-slidertick.wav`,s,.7)}playReverse(e,s){this.playFile(`${e}-sliderwhistle.wav`,s,.8)}startLoop(e,s,n,o=.3){const i=[s,"normal","soft","drum"];let r;for(const c of i){const d=`${c}-${e}.wav`,u=this.buffers.get(d);if(u){r=u;break}}if(!r){const c=`${e}.wav`,d=this.buffers.get(c);if(d)r=d;else return}if(e==="sliderslide")this.stopSlide();else{if(this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const a=this.ctx.createBufferSource();a.buffer=r,a.loop=!0;const h=this.ctx.createGain();h.gain.value=typeof o=="number"?Math.max(0,Math.min(1,o)):.3,a.connect(h),this.masterGain?h.connect(this.masterGain):h.connect(this.ctx.destination);try{a.start(Math.max(this.ctx.currentTime,n||0))}catch{}e==="sliderslide"?(this.slideSrc=a,this.slideGain=h):(this.whistleSrc=a,this.whistleGain=h)}startSlide(e,s,n){this.startLoop("sliderslide",e,s,(typeof n=="number"?Math.max(0,Math.min(1,n)):1)*.3)}stopSlide(){if(this.slideSrc){try{this.slideSrc.stop()}catch{}try{this.slideSrc.disconnect()}catch{}this.slideSrc=null}if(this.slideGain){try{this.slideGain.disconnect()}catch{}this.slideGain=null}}startSliderLoops(e,s,n,o){this.startLoop("sliderslide",e,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.3),s&&this.startLoop("sliderwhistle",e,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.25)}stopSliderLoops(){if(this.stopSlide(),this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}stopAll(){this.stopSlide();for(const e of Array.from(this.active)){try{e.stop()}catch{}try{e.disconnect()}catch{}this.active.delete(e)}}}function Ze(t,e){var r,a,h;const s=[],n=c=>{let d="normal";for(let u=0;u<t.timingPoints.length;u++){const m=t.timingPoints[u];if(m.time<=c&&m.sampleSet&&(d=Gt[m.sampleSet]||d),m.time>c)break}return d},o=(c,d,u,m)=>{const C=m&&m<0?100/-m:1,f=100*u*C;return c.length/Math.max(1e-6,f)*d},i=(c,d,u,m,C)=>{const f=m&&m<0?100/-m:1,P=100*u*f,L=c.length/Math.max(1e-6,P),I=1/Math.max(1e-6,C),b=[];for(let S=I;S<L-.001;S+=I){const p=S/L;p>0&&p<1&&b.push(p)}return b};for(const c of t.hitObjects)if(c.kind==="circle"){const d=n(c.time);s.push({timeMs:c.time,kind:"hit",set:d,bits:c.hitSound})}else if(c.kind==="slider"){const{base:d,inherited:u}=$t(t,c.time),m=(d==null?void 0:d.beatLength)??500,C=u==null?void 0:u.beatLength,f=o(c,m,e.SliderMultiplier,C),P=Math.max(1,c.slides),L=c.edgeSets&&((r=c.edgeSets[0])==null?void 0:r.sampleSet)&&Gt[c.edgeSets[0].sampleSet]||n(c.time),I=c.edgeSounds&&typeof c.edgeSounds[0]=="number"?c.edgeSounds[0]:c.hitSound;s.push({timeMs:c.time,kind:"hit",set:L,bits:I});const b=i(c,m,e.SliderMultiplier,C,e.SliderTickRate);for(let M=0;M<P;M++){const v=c.time+M*f;for(const R of b)s.push({timeMs:v+R*f,kind:"tick",set:L})}for(let M=1;M<P;M++){const v=c.time+M*f,R=c.edgeSets&&((a=c.edgeSets[M])==null?void 0:a.sampleSet)&&Gt[c.edgeSets[M].sampleSet]||n(v),_=c.edgeSounds&&typeof c.edgeSounds[M]=="number"?c.edgeSounds[M]:c.hitSound;s.push({timeMs:v,kind:"reverse",set:R,bits:_})}const S=c.time+f*P,p=P,O=c.edgeSets&&((h=c.edgeSets[p])==null?void 0:h.sampleSet)&&Gt[c.edgeSets[p].sampleSet]||n(S),k=c.edgeSounds&&typeof c.edgeSounds[p]=="number"?c.edgeSounds[p]:c.hitSound;s.push({timeMs:S,kind:"hit",set:O,bits:k})}else if(c.kind==="spinner"){const d=n(c.endTime);s.push({timeMs:c.endTime,kind:"hit",set:d,bits:0})}return s.sort((c,d)=>c.timeMs-d.timeMs),s}function ts(t){const e={};let s="root";e[s]={};const n=t.split(/\r?\n/);for(let o of n){let i=o.trim();if(!i||i.startsWith(";")||i.startsWith("//"))continue;if(i.startsWith("[")&&i.endsWith("]")){s=i.slice(1,-1).trim(),e[s]||(e[s]={});continue}const r=i.indexOf("=");if(r===-1)continue;const a=i.slice(0,r).trim(),h=i.slice(r+1).trim();e[s][a]=h}return e}function es(t){const e=t.Colours||t.Colors||{},s=Object.keys(e).filter(o=>/^combo\d+/i.test(o)).sort((o,i)=>{const r=Number(o.replace(/[^\d]/g,"")),a=Number(i.replace(/[^\d]/g,""));return r-a}),n=[];for(const o of s){const r=e[o].split(",").map(a=>Number(a.trim())).filter(a=>Number.isFinite(a));r.length>=3&&n.push(Se(r[0],r[1],r[2]))}return n}function ss(t){const e=t.Colours||t.Colors||{},s=e.SliderBorder||e.sliderborder;if(!s)return null;const n=s.split(",").map(o=>Number(o.trim())).filter(o=>Number.isFinite(o));return n.length>=3?Se(n[0],n[1],n[2]):null}function Se(t,e,s){const n=i=>Math.max(0,Math.min(255,Math.round(i))),o=i=>n(i).toString(16).padStart(2,"0");return`#${o(t)}${o(e)}${o(s)}`}async function ns(t){t||(t="/img/"),t.endsWith("/")||(t+="/");const e={},s=async(a,h)=>{try{const c=await ee(t+h);e[a]=c}catch{}};await Promise.all([s("hitcircle","hitcircle.png"),s("hitcircleoverlay","hitcircleoverlay.png"),s("approachcircle","approachcircle.png"),s("sliderfollowcircle","sliderfollowcircle.png"),s("followpoint","followpoint.png"),s("cursor","cursor.png"),s("cursortrail","cursortrail.png"),s("reversearrow","reversearrow.png"),s("sliderscorepoint","sliderscorepoint.png"),s("sliderstartcircle","sliderstartcircle.png"),s("sliderendcircle","sliderendcircle.png"),s("sliderb","sliderb.png"),s("sliderbnd","sliderb-nd.png"),s("sliderbspec","sliderb-spec.png"),s("spinnerApproachcircle","spinner-approachcircle.png"),s("spinnerBottom","spinner-bottom.png")]),e.sliderb||await s("sliderb","sliderb0.png");const n=[];for(let a=0;a<10;a++)try{const h=await ee(t+`sliderb${a}.png`);n.push(h)}catch{}n.length&&(e.sliderballFrames=n);const o=[];for(let a=0;a<=9;a++){const h=`default-${a}.png`,c=ee(t+h).then(d=>d).catch(()=>null);o.push(c)}const r=(await Promise.all(o)).filter(Boolean);r.length===10&&(e.digits=r);try{const a=await fetch(t+"skin.ini");if(a.ok){const h=await a.text(),c=ts(h),d=es(c);d.length&&(e.comboColors=d);const u=ss(c);u&&(e.sliderBorder=u)}}catch{}return e}async function ee(t){return new Promise((e,s)=>{const n=new Image;n.onload=()=>e(n),n.onerror=o=>s(o),n.src=t})}const os=({open:t,onClose:e,downloadUrl:s,beatmapVersion:n,beatmapId:o})=>(kt.useEffect(()=>{if(t)return document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}},[t]),t?g.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",onClick:i=>i.stopPropagation(),children:[g.jsx("div",{className:"overlay-backdrop",onClick:e}),g.jsxs("div",{className:"overlay-card embed-preview-card",onClick:i=>i.stopPropagation(),children:[g.jsx("button",{className:"overlay-close",onClick:e,"aria-label":"Close embed preview",children:g.jsx(pe,{size:18})}),g.jsx("div",{className:"embed-preview-body",onClick:i=>i.stopPropagation(),children:g.jsx(Le,{downloadUrl:s,beatmapVersion:n,beatmapId:o,onOpenInEditor:()=>{e(),window.location.hash="/editor"}})})]})]}):null),se=1,rs={1:"#ffffff",2:"#ff0000",3:"#b706b7",4:"#3276e6",5:"#e6e605",6:"#843e84",7:"#e6e605",8:"#e6e605",9:"#e6e605"};function is(t,e){for(t=Math.abs(t),e=Math.abs(e);e;){const s=e;e=t%e,t=s}return t||1}const as=({beatmap:t,currentTime:e,duration:s,onSeek:n,bookmarks:o,onScrubStart:i,onScrubEnd:r,scale:a,onScaleChange:h,beatSnapDivisor:c=4,onBeatSnapChange:d,skin:u,isPlaying:m,onPlayPause:C})=>{const f=x.useRef(null),P=48,[L,I]=x.useState(a??.4),b=x.useRef(!1),S=x.useRef([0,0]),p=x.useRef(new Set),[,O]=x.useState(0),k=x.useRef(null),M=x.useRef(!1);x.useEffect(()=>{a!==void 0&&I(a)},[a]);const v=(y,W,N)=>W/2+(y-N)/(se/L),R=(y,W,N)=>N+(y-W/2)*(se/L),_=y=>[1,2,4,8,16].includes(y)?"even":[3,6,12].includes(y)?"triplets":"custom",Q=x.useRef(new Map),et=(y,W,N)=>{const V=Math.max(1,Math.round(W)),j=`${y.src}|mini|${N}|${V}`,B=Q.current,X=B.get(j);if(X)return X;const st=document.createElement("canvas");st.width=V,st.height=V;const $=st.getContext("2d");return $.drawImage(y,0,0,V,V),$.globalCompositeOperation="multiply",$.fillStyle=N,$.fillRect(0,0,V,V),$.globalCompositeOperation="destination-in",$.drawImage(y,0,0,V,V),B.set(j,st),st};function H(y,W,N,V,j,B){if(N<=0)return;const X=W==null?void 0:W.digits,st=Math.max(6,Math.floor(B*.75));if(X&&X.length===10){const l=String(N).split("").map(K=>X[Number(K)]),F=l.reduce((K,dt)=>K+Math.max(1,Math.round(((dt==null?void 0:dt.width)||10)*(st/((dt==null?void 0:dt.height)||st)))),0);let at=V-F/2;y.save();for(const K of l){const dt=Math.max(1,Math.round(((K==null?void 0:K.width)||10)*(st/((K==null?void 0:K.height)||st)))),gt=st;K&&y.drawImage(K,at,j-gt/2,dt,gt),at+=dt}y.restore()}else y.save(),y.fillStyle="#fff",y.font=`bold ${st}px system-ui, sans-serif`,y.textAlign="center",y.textBaseline="middle",y.fillText(String(N),V,j),y.restore()}function A(y,W){const{base:N,inherited:V}=$t(y,W.time),j=(N==null?void 0:N.beatLength)??500,B=V==null?void 0:V.beatLength,X=B&&B<0?100/-B:1,$=100*Number(y.difficulty.SliderMultiplier??1)*X;return W.length/Math.max(1e-6,$)*j}function tt(y,W){return A(y,W)*Math.max(1,W.slides)}const ht=x.useCallback(()=>{O(y=>y+1)},[]);return Me(f,ht),x.useEffect(()=>{var gt;const y=f.current;if(!y)return;const W=window.devicePixelRatio||1,N=Math.min(3,Math.max(1,W)),V=y.getBoundingClientRect(),j=Math.max(200,Math.min(V.width,1e4)),B=P,X=16384,st=Math.min(X,Math.max(1,Math.round(j*N))),$=Math.min(X,Math.max(1,Math.round(B*N)));y.width=st,y.height=$;const l=y.getContext("2d");try{l.setTransform(N,0,0,N,0,0)}catch{}l.globalCompositeOperation="source-over",l.clearRect(0,0,j,B),l.fillStyle="#0f1626",l.fillRect(0,0,j,B);const F=e*1e3,at=j/2*(se/L)+120,K=F-at,dt=F+at;if(t){const{base:it}=$t(t,F);if(it&&it.beatLength>0){const nt=it.beatLength,pt=c,vt=it.time+nt*Math.ceil((F-it.time)/nt),xt=ft=>{const wt=v(ft,j,F);if(wt<-1||wt>j+1)return;const ot=Math.round(ft-(Math.round((ft-it.time)/nt)*nt+it.time))===0,q=ot&&Math.round((ft-it.time)/nt)%(it.meter||4)===0;let rt="#cdd6f4";if(!ot){const U=Math.floor((ft-it.time)/nt)*nt+it.time,Z=Math.round((ft-U)/(nt/pt)),yt=pt/is(pt,Z);rt=rs[yt]||"#929292"}l.strokeStyle=rt,l.lineWidth=ot?2:1,l.beginPath(),l.moveTo(wt+.5,q?0:10),l.lineTo(wt+.5,q?B:B-10),l.stroke()};for(let ft=vt;ft<=dt;ft+=nt/pt)xt(ft);for(let ft=vt-nt/pt;ft>=K;ft-=nt/pt)xt(ft)}}if(t){const it=t.hitObjects,nt=(gt=t.colors)!=null&&gt.comboColors&&t.colors.comboColors.length?t.colors.comboColors:u!=null&&u.comboColors&&u.comboColors.length?u.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],pt=new Array(it.length).fill(0),vt=new Array(it.length).fill(1);{let rt=0;for(let U=0;U<it.length;U++){const Z=it[U];Z.newCombo&&(rt=rt+1+(Z.comboSkip||0)),pt[U]=rt,U===0||pt[U]!==pt[U-1]?vt[U]=1:vt[U]=(vt[U-1]||1)+1}}const[xt,ft]=S.current;if(Math.abs(xt-ft)>0){const rt=v(Math.min(xt,ft),j,F),U=v(Math.max(xt,ft),j,F);l.fillStyle="rgba(255,255,255,0.25)",l.fillRect(Math.max(0,rt),0,Math.max(0,Math.min(j,U)-Math.max(0,rt)),B)}const ot=Math.floor(B*.5),q=Math.max(2,Math.floor(B*.38));for(let rt=it.length-1;rt>=0;rt--){const U=it[rt],Z=U.time,yt=U.kind==="slider"?Z+tt(t,U):U.endTime??Z;if(yt<K||Z>dt)continue;const bt=v(Z,j,F),Pt=v(yt,j,F),w=p.current.has(rt),T=nt[pt[rt]%nt.length];if(l.fillStyle=w?"#f59e0b":"#1f2b45",l.fillRect(Math.floor(bt),0,1,B),U.kind==="circle"){const D=u==null?void 0:u.hitcircle,Y=u==null?void 0:u.hitcircleoverlay;if(D){const G=q*2,E=G/(D.width||128),z=(D.width||128)*E,J=(D.height||128)*E;l.save(),l.globalAlpha=.95;const ct=et(D,Math.max(1,Math.round(G)),T);l.drawImage(ct,bt-z/2,ot-J/2,z,J),Y&&l.drawImage(Y,bt-z/2,ot-J/2,z,J),l.restore(),H(l,u,vt[rt],bt,ot,q)}else l.save(),l.beginPath(),l.arc(bt,ot,q,0,Math.PI*2),l.fillStyle=T,l.fill(),l.restore(),H(l,u,vt[rt],bt,ot,q)}else if(U.kind==="slider"){l.save();const D=Math.min(bt,Pt),Y=Math.max(4,Math.abs(Pt-bt)),G=Math.max(6,Math.floor(B*.7)),E=Math.floor((B-G)/2),z=3;l.beginPath(),l.moveTo(D+z,E),l.lineTo(D+Y-z,E),l.quadraticCurveTo(D+Y,E,D+Y,E+z),l.lineTo(D+Y,E+G-z),l.quadraticCurveTo(D+Y,E+G,D+Y-z,E+G),l.lineTo(D+z,E+G),l.quadraticCurveTo(D,E+G,D,E+G-z),l.lineTo(D,E+z),l.quadraticCurveTo(D,E,D+z,E),l.closePath(),l.fillStyle=w?"rgba(245,158,11,0.9)":T,l.globalAlpha=w?.95:.85,l.fill(),l.restore();const J=u==null?void 0:u.hitcircle,ct=u==null?void 0:u.hitcircleoverlay;if(J){const lt=q*2,Ct=lt/(J.width||128),Tt=(J.width||128)*Ct,jt=(J.height||128)*Ct;l.save(),l.globalAlpha=.95;const Lt=et(J,Math.max(1,Math.round(lt)),T);l.drawImage(Lt,bt-Tt/2,ot-jt/2,Tt,jt),ct&&l.drawImage(ct,bt-Tt/2,ot-jt/2,Tt,jt),l.restore(),H(l,u,vt[rt],bt,ot,q),l.save(),l.globalAlpha=.95;const Rt=et(J,Math.max(1,Math.round(lt)),T);l.drawImage(Rt,Pt-Tt/2,ot-jt/2,Tt,jt),ct&&l.drawImage(ct,Pt-Tt/2,ot-jt/2,Tt,jt),l.restore()}const mt=U,ut=Math.max(1,mt.slides);if(ut>1&&t){const lt=A(t,mt);for(let Ct=1;Ct<ut;Ct++){const Tt=Z+lt*Ct;if(Tt<K||Tt>dt)continue;const jt=v(Tt,j,F),Lt=u==null?void 0:u.reversearrow;if(Lt){const It=Math.max(8,Math.floor(q*1.2))/(Lt.width||128),At=(Lt.width||128)*It,Bt=(Lt.height||128)*It;l.save(),l.globalAlpha=.9,l.translate(jt,ot),l.drawImage(Lt,-At/2,-Bt/2,At,Bt),l.restore()}else if(J){const Rt=Math.max(4,Math.floor(q*.75)),It=Rt/(J.width||128),At=(J.width||128)*It,Bt=(J.height||128)*It;l.save(),l.globalAlpha=.85;const Te=w?"#f59e0b":T,Ce=et(J,Math.max(1,Math.round(Rt*2)),Te);l.drawImage(Ce,jt-At/2,ot-Bt/2,At,Bt),ct&&(l.globalAlpha=.7,l.drawImage(ct,jt-At/2,ot-Bt/2,At,Bt)),l.restore()}else l.save(),l.beginPath(),l.arc(jt,ot,Math.max(2,Math.floor(q*.6)),0,Math.PI*2),l.fillStyle=w?"#f59e0b":T,l.globalAlpha=.85,l.fill(),l.restore()}}}else if(U.kind==="spinner"){const Y=Z-36,G=yt-36,E=v(Y,j,F),z=v(G,j,F),J=Math.min(E,z),ct=Math.max(4,Math.abs(z-E)),mt=Math.max(6,Math.floor(B*.7)),ut=Math.floor((B-mt)/2);l.save();const lt=3;l.beginPath(),l.moveTo(J+lt,ut),l.lineTo(J+ct-lt,ut),l.quadraticCurveTo(J+ct,ut,J+ct,ut+lt),l.lineTo(J+ct,ut+mt-lt),l.quadraticCurveTo(J+ct,ut+mt,J+ct-lt,ut+mt),l.lineTo(J+lt,ut+mt),l.quadraticCurveTo(J,ut+mt,J,ut+mt-lt),l.lineTo(J,ut+lt),l.quadraticCurveTo(J,ut,J+lt,ut),l.closePath(),l.fillStyle=w?"rgba(245,158,11,0.9)":"rgba(87,177,255,0.85)",l.globalAlpha=w?.95:.85,l.fill(),l.restore();const Ct=u==null?void 0:u.hitcircle,Tt=u==null?void 0:u.hitcircleoverlay;if(Ct){const jt=q*2,Lt=jt/(Ct.width||128),Rt=(Ct.width||128)*Lt,It=(Ct.height||128)*Lt;l.save(),l.globalAlpha=.95;const At=et(Ct,Math.max(1,Math.round(jt)),T);l.drawImage(At,E-Rt/2,ot-It/2,Rt,It),Tt&&l.drawImage(Tt,E-Rt/2,ot-It/2,Rt,It),l.restore(),l.save(),l.globalAlpha=.95;const Bt=et(Ct,Math.max(1,Math.round(jt)),T);l.drawImage(Bt,z-Rt/2,ot-It/2,Rt,It),Tt&&l.drawImage(Tt,z-Rt/2,ot-It/2,Rt,It),l.restore()}else l.save(),l.beginPath(),l.arc(E,ot,q,0,Math.PI*2),l.fillStyle=T,l.fill(),l.restore(),l.save(),l.beginPath(),l.arc(z,ot,q,0,Math.PI*2),l.fillStyle=T,l.fill(),l.restore()}if(yt>Z){const D=v(yt,j,F);l.fillStyle=w?"rgba(245,158,11,0.35)":"rgba(87,177,255,0.2)",l.fillRect(Math.min(bt,D),B-8,Math.max(1,Math.abs(D-bt)),6)}}}if(o&&o.length>0){l.fillStyle="#f59e0b";for(const it of o){const nt=it*1e3,pt=v(nt,j,F);pt<-6||pt>j+6||(l.beginPath(),l.moveTo(pt,0),l.lineTo(pt+6,10),l.lineTo(pt-6,10),l.closePath(),l.fill())}}l.strokeStyle="#cdd6f4",l.lineWidth=2,l.beginPath(),l.moveTo(j/2+.5,0),l.lineTo(j/2+.5,B),l.stroke(),l.beginPath(),l.moveTo(j/2-3,0),l.lineTo(j/2,3),l.lineTo(j/2+3,0),l.closePath(),l.fillStyle="#cdd6f4",l.fill(),l.beginPath(),l.moveTo(j/2-3,B),l.lineTo(j/2,B-3),l.lineTo(j/2+3,B),l.closePath(),l.fill()},[t,e,s,o,L,c,u]),x.useEffect(()=>{const y=f.current;if(!y)return;const W=N=>{if(N.altKey){N.preventDefault();const X=N.deltaY>0?Math.max(.5,L-.1):Math.min(1.5,L+.1),st=Math.round(X*10)/10;I(st),h==null||h(st);return}N.preventDefault(),M.current||(M.current=!0,i==null||i()),k.current!==null&&clearTimeout(k.current);const V=N.shiftKey?1:.1,j=N.deltaY>0?1:-1,B=Math.max(0,Math.min(s,e+j*V));n(B),k.current=window.setTimeout(()=>{M.current=!1,r==null||r(),k.current=null},150)};return y.addEventListener("wheel",W,{passive:!1}),()=>{y.removeEventListener("wheel",W),k.current!==null&&clearTimeout(k.current)}},[L,h,e,s,n,i,r]),x.useEffect(()=>{const y=f.current;if(!y)return;const W=V=>{const j=y.getBoundingClientRect(),B=j.width,X=e*1e3,st=R(V.clientX-j.left,B,X);b.current=!0,V.ctrlKey?S.current=[st,st]:(i&&i(),n(Math.max(0,Math.min(s,st/1e3))));const $=F=>{if(!b.current)return;const at=R(Math.max(0,Math.min(j.width,F.clientX-j.left)),B,X);if(V.ctrlKey){if(S.current=[st,at],t){const K=Math.min(st,at),dt=Math.max(st,at),gt=new Set;for(let it=0;it<t.hitObjects.length;it++){const nt=t.hitObjects[it],pt=nt.time,vt=nt.kind==="slider"?pt+tt(t,nt):nt.endTime??pt;(K<pt&&dt>pt||K<vt&&dt>vt||pt<dt&&vt>K)&&gt.add(it)}p.current=gt}O(K=>K+1)}else n(Math.max(0,Math.min(s,at/1e3)))},l=()=>{b.current=!1,V.ctrlKey||r&&r(),window.removeEventListener("mousemove",$),window.removeEventListener("mouseup",l)};window.addEventListener("mousemove",$),window.addEventListener("mouseup",l)},N=V=>{if(V.preventDefault(),V.touches.length===0)return;const j=y.getBoundingClientRect(),B=j.width,X=e*1e3,st=V.touches[0],$=R(Math.max(0,Math.min(j.width,st.clientX-j.left)),B,X);b.current=!0,i&&i(),n(Math.max(0,Math.min(s,$/1e3)));const l=at=>{if(at.preventDefault(),!b.current||at.touches.length===0)return;const K=at.touches[0],dt=R(Math.max(0,Math.min(j.width,K.clientX-j.left)),B,X);n(Math.max(0,Math.min(s,dt/1e3)))},F=at=>{at.preventDefault(),b.current=!1,r&&r(),window.removeEventListener("touchmove",l),window.removeEventListener("touchend",F),window.removeEventListener("touchcancel",F)};window.addEventListener("touchmove",l,{passive:!1}),window.addEventListener("touchend",F),window.addEventListener("touchcancel",F)};return y.addEventListener("mousedown",W),y.addEventListener("touchstart",N,{passive:!1}),()=>{y.removeEventListener("mousedown",W),y.removeEventListener("touchstart",N)}},[t,e,s,n,i,r]),g.jsx("div",{className:"timeline-wrapper",children:g.jsxs("div",{className:"timeline-row",children:[g.jsx("canvas",{ref:f,className:"timeline",style:{height:P,display:"block"}}),g.jsxs("div",{className:"zoom-column",children:[g.jsx("button",{className:"zoom-btn small",onClick:()=>{const y=Math.min(1.5,L+.1);I(y),h==null||h(y)},children:"+"}),g.jsx("button",{className:"zoom-btn small",onClick:()=>{const y=Math.max(.5,L-.1);I(y),h==null||h(y)},children:"-"})]}),g.jsxs("div",{className:"beatsnap-vertical",children:[g.jsx("div",{className:"bs-label",children:"Beat Snap Divisor"}),g.jsxs("div",{className:"bs-value",children:["1/",c]}),g.jsxs("div",{className:"bs-arrows",children:[g.jsx("button",{className:"beat-snap-btn icon xs",title:"Prev divisor",onClick:()=>d==null?void 0:d(Math.max(1,c===16?12:c===12?9:c-1)),children:"◀"}),g.jsx("span",{className:"bs-kind",children:_(c)}),g.jsx("button",{className:"beat-snap-btn icon xs",title:"Next divisor",onClick:()=>d==null?void 0:d(Math.min(16,c===9?12:c===12?16:c+1)),children:"▶"})]})]})]})})},us=()=>{const[t,e]=x.useState(null),[s,n]=x.useState(void 0),o=x.useRef(void 0),[i,r]=x.useState(""),a=x.useRef(new Je),[h,c]=x.useState(0),[d,u]=x.useState(!1),[m,C]=x.useState(0),[f,P]=x.useState(null),L=x.useRef(null),I=x.useRef([]),b=x.useRef(0),S=x.useRef(0),p=x.useRef(0),O=x.useRef(0),[k,M]=x.useState([]),[v,R]=x.useState(1),[_,Q]=x.useState(!1),et=x.useRef(!1),H=x.useRef(!1),A=x.useRef(null),tt=x.useRef(!1),ht=x.useRef(),[y,W]=x.useState(.4),[N,V]=x.useState(4),[j,B]=x.useState(!1),[X,st]=x.useState(.6),[$,l]=x.useState(1),[F,at]=x.useState(.6),K=x.useRef(null),[dt,gt]=x.useState([]),[it,nt]=x.useState(""),[pt,vt]=x.useState(!1),[xt,ft]=x.useState(!1),wt=x.useCallback(async(w,T)=>{var D,Y;Et.clearAll();try{const G=await w.readText(T);let E=te(G);try{E=await Ke(G,E)}catch{}e(E);try{const z=E.metadata.TitleUnicode||E.metadata.Title||"",J=E.metadata.ArtistUnicode||E.metadata.Artist||"",ct=E.metadata.Creator||E.metadata.creator||"",mt=E.metadata.Version||"",ut=Number(E.metadata.BeatmapID||0)||null;window.dispatchEvent(new CustomEvent("editor:info",{detail:{title:z,artist:J,mapper:ct,version:mt,beatmapId:ut}}))}catch{}try{const z=Kt(E.difficulty);I.current=Ze(E,z),b.current=0;const J=(D=E.colors)!=null&&D.comboColors&&E.colors.comboColors.length?E.colors.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],ct=ge(z.CS),mt=(f==null?void 0:f.sliderBorder)||((Y=E.colors)==null?void 0:Y.sliderBorder)||"#ffffff";Et.precalculateShapes(E,z,J,ct,240,mt)}catch{I.current=[],b.current=0}if(C(0),E.audioFilename){const z=w.findFirst(J=>J.toLowerCase().endsWith(E.audioFilename.toLowerCase()))||E.audioFilename;try{const J=await w.readArrayBuffer(z);await a.current.load(J),C(a.current.duration||0)}catch(J){console.warn("Failed to load audio:",J)}}if(E.backgroundFilename)try{const z=w.findFirst(mt=>mt.toLowerCase().endsWith(E.backgroundFilename.toLowerCase()))||E.backgroundFilename,J=await w.readArrayBuffer(z);o.current&&URL.revokeObjectURL(o.current);const ct=URL.createObjectURL(new Blob([J]));o.current=ct,n(ct)}catch{o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0)}else o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0);a.current.seek(0),c(0),u(!1)}catch(G){console.error("Error loading beatmap path:",G),alert(G instanceof Error?G.message:String(G))}},[]);x.useEffect(()=>{const w=a.current;return w.onTick(T=>{et.current||c(T)}),()=>w.stop()},[]),x.useEffect(()=>{const w=()=>B(!0);return window.addEventListener("editor:embed:preview",w),()=>window.removeEventListener("editor:embed:preview",w)},[]),x.useEffect(()=>{const w=window.__editorTransferOsz,T=window.__editorTransferPath,D=w?null:sessionStorage.getItem("editor:transfer:osz"),Y=T?null:sessionStorage.getItem("editor:transfer:path");if(!w&&!D||!T&&!Y)return;w?(delete window.__editorTransferOsz,delete window.__editorTransferPath):(sessionStorage.removeItem("editor:transfer:osz"),sessionStorage.removeItem("editor:transfer:path"));let G=null;return G=window.setTimeout(()=>{window.__editorTransferOsz&&(delete window.__editorTransferOsz,delete window.__editorTransferPath)},6e4),(async()=>{try{let E;if(w)E=w;else{const lt=atob(D),Ct=new Uint8Array(lt.length);for(let Tt=0;Tt<lt.length;Tt++)Ct[Tt]=lt.charCodeAt(Tt);E=Ct.buffer}const z=T||Y,J=await me(E);K.current=J;const ct=J.list.filter(lt=>lt.toLowerCase().endsWith(".osu"));if(!ct.length)throw new Error("No .osu file in archive");const mt=[];for(const lt of ct)try{const Ct=await J.readText(lt),Tt=te(Ct),jt=String(Tt.metadata.Version||"");mt.push({path:lt,version:jt,mode:Tt.mode})}catch{}gt(mt);const ut=ct.includes(z)?z:ct[0];nt(ut);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:mt,selected:ut}}))}catch{}await wt(J,ut),r("Transferred from preview"),G!==null&&clearTimeout(G)}catch(E){console.error("Failed to load transferred OSZ:",E),alert(E instanceof Error?E.message:"Failed to load transferred beatmap"),G!==null&&clearTimeout(G)}})(),()=>{G!==null&&clearTimeout(G)}},[wt]),x.useEffect(()=>{if(!j)return;const w=T=>{T.key==="Escape"&&B(!1)};return window.addEventListener("keydown",w),()=>window.removeEventListener("keydown",w)},[j]),x.useEffect(()=>{try{localStorage.getItem("editor:welcome:hidden")==="1"||vt(!0)}catch{vt(!0)}},[]),x.useEffect(()=>{const w=async()=>{try{const T=a.current.getContext();if(T.state!=="running"&&await T.resume(),!L.current){const D=new Vt(T);L.current=D,D.volume=F*X,await D.load().catch(()=>{})}}catch{}window.removeEventListener("pointerdown",w),window.removeEventListener("keydown",w)};return window.addEventListener("pointerdown",w,{once:!0}),window.addEventListener("keydown",w,{once:!0}),()=>{window.removeEventListener("pointerdown",w),window.removeEventListener("keydown",w)}},[]),x.useEffect(()=>{ns().then(w=>P(w)).catch(()=>P(null))},[]),x.useEffect(()=>{Et.clearAll()},[]),x.useEffect(()=>()=>{var w;S.current&&(cancelAnimationFrame(S.current),S.current=0),a.current.stop(),Et.clearAll(),o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),A.current!==null&&(clearTimeout(A.current),A.current=null);try{(w=L.current)==null||w.stopAll()}catch{}},[]),x.useEffect(()=>{a.current&&(a.current.volume=$*X)},[$,X]),x.useEffect(()=>{L.current&&(L.current.volume=F*X)},[F,X]);const ot=x.useCallback(async w=>{console.log("Attempting to load OSZ file:",w.name),r(w.name);try{const T=await me(w);console.log("OSZ loaded, contents:",T.list),K.current=T;const D=T.list.filter(G=>G.toLowerCase().endsWith(".osu"));if(!D.length)throw new Error("No .osu file in archive");const Y=[];for(const G of D)try{const E=await T.readText(G),z=te(E),J=String(z.metadata.Version||"");Y.push({path:G,version:J,mode:z.mode})}catch{}gt(Y),nt(D[0]);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:Y,selected:D[0]}}))}catch{}await wt(T,D[0])}catch(T){console.error("Error in onOpenOsz:",T),alert(T instanceof Error?T.message:String(T))}},[]),q=x.useMemo(()=>{if(m>0)return m;if(!t)return 0;const w=t.hitObjects[t.hitObjects.length-1];return w?(("endTime"in w?w.endTime:w.time)+2e3)/1e3:0},[m,t]),rt=x.useCallback(w=>{var E;_?(a.current&&m>0&&a.current.setPosition(w),c(w)):(a.current.seek(w),c(w));const T=w*1e3,D=I.current;let Y=0,G=D.length;for(;Y<G;){const z=Y+G>>>1;D[z].timeMs<=T?Y=z+1:G=z}b.current=Y;try{(E=L.current)==null||E.stopSlide()}catch{}m===0&&d&&!_&&(p.current=performance.now(),O.current=w)},[_,m,d]),U=x.useCallback(async()=>{var Y,G;if(a.current.isPlaying&&m>0||d){a.current.pause(),u(!1),a.current.isPlaying&&a.current.stop(),S.current&&(cancelAnimationFrame(S.current),S.current=0);try{(Y=L.current)==null||Y.stopAll()}catch{}}else{if(et.current)return;try{const E=a.current.getContext();if(E.state!=="running"&&await E.resume(),!L.current){const z=new Vt(E);L.current=z,z.volume=F*X,await z.load().catch(()=>{})}}catch{}if(m>0){const E=Math.max(0,m);let z=Math.max(0,Math.min(E,typeof h=="number"?h:0));if(z>=E-.001&&(z=0),z!==h){c(z);const J=z*1e3,ct=I.current;let mt=0,ut=ct.length;for(;mt<ut;){const lt=mt+ut>>>1;ct[lt].timeMs<=J?mt=lt+1:ut=lt}b.current=mt}yt.current=z,a.current.play(z),u(!0),a.current.isPlaying||u(!1);try{const J=(typeof h=="number"?h:0)*1e3,ct=I.current;let mt=-1;for(let ut=0;ut<ct.length;ut++)ct[ut].timeMs<=J&&ct[ut].kind==="slide_start"&&(mt=ut);if(mt!==-1){let ut=!1;for(let lt=mt+1;lt<ct.length;lt++)if(ct[lt].kind==="slide_end"){ut=ct[lt].timeMs>=J;break}if(ut){const lt=ct[mt];(G=L.current)==null||G.startSlide(lt.set)}}}catch{}}else{u(!0),p.current=performance.now();const E=Math.max(0,q||0),z=typeof h=="number"&&h>=E-.001?0:h;if(z!==h){c(z);const ct=z*1e3,mt=I.current;let ut=0,lt=mt.length;for(;ut<lt;){const Ct=ut+lt>>>1;mt[Ct].timeMs<=ct?ut=Ct+1:lt=Ct}b.current=ut}O.current=z;const J=()=>{if(et.current){S.current=0;return}const ct=(performance.now()-p.current)/1e3,mt=Math.min(q||1/0,O.current+ct);if(c(mt),mt>=(q||1/0)){u(!1);return}S.current=requestAnimationFrame(J)};S.current=requestAnimationFrame(J)}}},[d,m,h,q]);x.useEffect(()=>{ht.current=U},[U]);const Z=x.useMemo(()=>{if(!t)return{bpm:0,sliderVelocity:0};const{base:w,inherited:T}=$t(t,h*1e3),D=w?6e4/w.beatLength:0,Y=T?-100/T.beatLength:1;return{bpm:D,sliderVelocity:Y}},[t,h]);x.useCallback(w=>{var D;const T=(D=w.target.files)==null?void 0:D[0];if(T){console.log("File selected in input:",T.name);try{const Y=a.current.getContext();if(Y.state!=="running"&&Y.resume(),!L.current){const G=new Vt(Y);L.current=G,G.volume=F*X,G.load().catch(()=>{})}}catch{}ot(T).catch(Y=>{console.error("Error from onOpenOsz via file input:",Y),alert(String((Y==null?void 0:Y.message)||Y))})}},[ot]),x.useEffect(()=>{const w=T=>{const Y=T.detail;Y&&ot(Y).catch(G=>{alert(G instanceof Error?G.message:String(G))})};return window.addEventListener("editor:file",w),()=>window.removeEventListener("editor:file",w)},[ot]),x.useEffect(()=>{const w=T=>{if(T.target&&T.target.tagName==="INPUT")return;if(T.code==="Space"){T.preventDefault(),ht.current&&ht.current();return}const D=T.shiftKey?1:.1;T.code==="ArrowLeft"&&(T.preventDefault(),rt(Math.max(0,h-D))),T.code==="ArrowRight"&&(T.preventDefault(),rt(Math.min(q,h+D))),T.code==="Home"&&(T.preventDefault(),rt(0)),T.code==="End"&&(T.preventDefault(),rt(q)),T.code==="KeyB"&&(T.preventDefault(),M(Y=>[...Y,h]))};return window.addEventListener("keydown",w),()=>window.removeEventListener("keydown",w)},[U,rt,h,q]),x.useEffect(()=>{const w=T=>{var ut;const D=T.target;if(!D||D.closest(".top-nav")||D.tagName==="INPUT"||D.tagName==="TEXTAREA"||T.altKey||D.closest(".timeline-wrapper")||D.closest(".editor-controls-container")||(T.preventDefault(),!Number.isFinite(q)||q<=0))return;if(!tt.current){tt.current=!0;const lt=a.current.isPlaying&&m>0;H.current=lt,lt&&a.current.pause(),u(!1),et.current=!0,Q(!0)}A.current!==null&&clearTimeout(A.current);const Y=T.shiftKey?1:.1,G=T.deltaY>0?1:-1,E=Math.max(0,Math.min(q,h+G*Y));m>0&&a.current.setPosition(E),c(E);const z=E*1e3,J=I.current;let ct=0,mt=J.length;for(;ct<mt;){const lt=ct+mt>>>1;J[lt].timeMs<=z?ct=lt+1:mt=lt}b.current=ct;try{(ut=L.current)==null||ut.stopSlide()}catch{}A.current=window.setTimeout(()=>{tt.current=!1,et.current=!1,Q(!1),A.current=null},150)};return window.addEventListener("wheel",w,{passive:!1}),()=>{window.removeEventListener("wheel",w),A.current!==null&&clearTimeout(A.current)}},[h,q,d,m]),x.useEffect(()=>{const w=T=>{var E;const Y=(E=T.detail)==null?void 0:E.path,G=K.current;!G||!Y||(nt(Y),wt(G,Y).then(()=>{try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:dt,selected:Y}}))}catch{}}))};return window.addEventListener("editor:difficulty:select",w),()=>window.removeEventListener("editor:difficulty:select",w)},[dt,wt]);const yt=x.useRef(0);x.useEffect(()=>{if(!t){yt.current=h;return}const w=L.current;if(!w){yt.current=h;return}const T=yt.current,D=h;if(yt.current=h,!d||_||D<=T||D-T>1)return;try{const z=a.current.getContext();if(z.state!=="running"){z.resume().catch(()=>{});return}}catch{}const Y=D*1e3,G=I.current;let E=b.current;for(;E<G.length&&G[E].timeMs<=Y;E++){const z=G[E];z.kind==="hit"?w.playHit(z.set,z.bits||0):z.kind==="tick"?w.playTick(z.set):z.kind==="reverse"&&(typeof z.bits=="number"?w.playHit(z.set,z.bits):w.playReverse(z.set))}b.current=E},[h,t,d,_]);const bt=x.useCallback(()=>{const w=a.current.isPlaying&&m>0;H.current=w,w&&a.current.pause(),S.current&&(cancelAnimationFrame(S.current),S.current=0),u(!1),et.current=!0,Q(!0)},[m]),Pt=x.useCallback(async()=>{et.current=!1,Q(!1);try{const w=a.current.getContext();if(w.state!=="running"&&await w.resume(),!L.current){const T=new Vt(w);L.current=T,T.volume=F*X,await T.load().catch(()=>{})}}catch{}},[F,X]);return g.jsxs("div",{className:"app fullscreen-editor",children:[g.jsx(as,{beatmap:t,currentTime:h,duration:q,onSeek:rt,bookmarks:k,onScrubStart:bt,onScrubEnd:Pt,scale:y,onScaleChange:W,beatSnapDivisor:N,onBeatSnapChange:V,skin:f||void 0,isPlaying:d,onPlayPause:U}),g.jsxs("div",{className:"playfield-container",children:[g.jsx(de,{beatmap:t,timeSec:h,backgroundUrl:s,skin:f,sliderBodyCutoffPx:v}),g.jsx(fe,{masterVolume:X,songVolume:$,hitsoundVolume:F,onMasterVolumeChange:st,onSongVolumeChange:l,onHitsoundVolumeChange:at})]}),g.jsx(ue,{isPlaying:d,onPlayPause:U,currentTime:h,duration:q,onSeek:rt,onScrubStart:bt,onScrubEnd:Pt,bpm:Z.bpm,sliderVelocity:Z.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints}),pt&&g.jsx("div",{className:"editor-modal-overlay",children:g.jsxs("div",{className:"editor-modal",children:[g.jsx("div",{className:"modal-title",children:"Hey!"}),g.jsx("div",{className:"modal-body",children:g.jsxs("p",{children:["If you use this website solely for the editor, ",g.jsx("strong",{children:"don't"}),". This is a fork of ",g.jsx("strong",{children:"JoSu! 2.0"})," (",g.jsx("a",{href:"https://preview.tryz.id.vn/",target:"_blank",rel:"noreferrer",children:"preview.tryz.id.vn"}),") adapted specifically for this website. JoSu is superior in almost every way."]})}),g.jsxs("div",{className:"modal-actions",children:[g.jsxs("label",{className:"check-bubble",children:[g.jsx("input",{type:"checkbox",checked:xt,onChange:w=>ft(w.target.checked)}),g.jsx("span",{className:"check-text",children:"Don't show this again"})]}),g.jsx("button",{className:"btn secondary",onClick:()=>{try{xt&&localStorage.setItem("editor:welcome:hidden","1")}catch{}vt(!1)},children:"OK"})]})]})}),j&&g.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",children:[g.jsx("div",{className:"overlay-backdrop",onClick:()=>B(!1)}),g.jsxs("div",{className:"overlay-card embed-preview-card",children:[g.jsx("button",{className:"overlay-close",onClick:()=>B(!1),"aria-label":"Close embed preview",children:g.jsx(pe,{size:18})}),g.jsx("div",{className:"embed-preview-body",children:t?g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"embed-preview-playfield",children:[g.jsx(de,{beatmap:t,timeSec:h,backgroundUrl:s,skin:f,sliderBodyCutoffPx:v}),g.jsx(fe,{masterVolume:X,songVolume:$,hitsoundVolume:F,onMasterVolumeChange:st,onSongVolumeChange:l,onHitsoundVolumeChange:at})]}),g.jsx(ue,{isPlaying:d,onPlayPause:U,currentTime:h,duration:q,onSeek:rt,bpm:Z.bpm,sliderVelocity:Z.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints})]}):g.jsx("div",{className:"embed-preview-empty",children:"Load a beatmap to see the embed preview."})})]})]})]})},fs=Object.freeze(Object.defineProperty({__proto__:null,default:os},Symbol.toStringTag,{value:"Module"}));export{Je as A,os as B,ue as C,us as E,Vt as H,de as P,fe as V,me as a,Ke as b,Ze as c,fs as d,ns as l,te as p,Kt as r,Et as s,$t as t};

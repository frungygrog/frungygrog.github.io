var fe=Object.defineProperty;var me=(o,t,e)=>t in o?fe(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var _=(o,t,e)=>me(o,typeof t!="symbol"?t+"":t,e);import{_ as he}from"./index-D7jM9rdB.js";import{r as L,j as Q,Z as pe}from"./vendor-react-_vsaDC62.js";import{H as F}from"./vendor-DBgzFpze.js";const ge="video-cache",Ee=2,V="segments",O="manifests",W="video-tracking",we=7*24*60*60*1e3,re=500*1024*1024,ye=10;let X=null,Z=null;function j(){return X?Promise.resolve(X):Z||(Z=new Promise((o,t)=>{const e=indexedDB.open(ge,Ee);e.onerror=()=>t(e.error),e.onsuccess=()=>{X=e.result,o(X)},e.onupgradeneeded=s=>{const n=s.target.result;s.oldVersion;let a;n.objectStoreNames.contains(V)?a=s.target.transaction.objectStore(V):(a=n.createObjectStore(V,{keyPath:"url"}),a.createIndex("timestamp","timestamp",{unique:!1})),a.indexNames.contains("videoId")||a.createIndex("videoId","videoId",{unique:!1});let d;n.objectStoreNames.contains(O)?d=s.target.transaction.objectStore(O):(d=n.createObjectStore(O,{keyPath:"url"}),d.createIndex("timestamp","timestamp",{unique:!1})),d.indexNames.contains("videoId")||d.createIndex("videoId","videoId",{unique:!1}),n.objectStoreNames.contains(W)||n.createObjectStore(W,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),Z)}function Ce(o){try{const t=o.match(/videodelivery\.net\/([^\/]+)\//);if(t)return t[1];const e=new URL(o),s=e.pathname.split("/").filter(n=>n);return s.length>0?e.origin+"/"+s[0]:e.origin}catch{return null}}async function ae(o,t=!1,e){const s=performance.now(),n=t?"MANIFEST":"SEGMENT";try{const a=performance.now(),d=await j(),l=performance.now()-a;console.log(`[VIDEO CACHE] IndexedDB initialized in ${l.toFixed(2)}ms`);const c=t?O:V,h=d.transaction([c],"readonly").objectStore(c),w=te(o,t),g=performance.now(),$=h.get(w);return new Promise(p=>{$.onsuccess=()=>{const f=performance.now()-g,C=performance.now()-s,S=$.result;if(!S){console.log(`[VIDEO CACHE] ${n} not found in cache (lookup took ${C.toFixed(2)}ms, request: ${f.toFixed(2)}ms)`),p(null);return}const A=Date.now()-S.timestamp;if(A>we){console.log(`[VIDEO CACHE] ${n} cache entry expired (age: ${(A/1e3).toFixed(2)}s), deleting`),ie(o,t).catch(()=>{}),p(null);return}console.log(`[VIDEO CACHE] ${n} found in cache (lookup took ${C.toFixed(2)}ms, request: ${f.toFixed(2)}ms, size: ${S.data.byteLength} bytes, age: ${(A/1e3).toFixed(2)}s)`),p(S.data)},$.onerror=()=>{const f=performance.now()-s;console.error(`[VIDEO CACHE] Error looking up ${n} after ${f.toFixed(2)}ms`),p(null)}})}catch(a){const d=performance.now()-s;return console.error(`[VIDEO CACHE] Exception during ${n} lookup after ${d.toFixed(2)}ms:`,a),null}}async function ce(o,t,e=!1,s){const n=performance.now(),a=e?"MANIFEST":"SEGMENT";try{const d=performance.now(),l=await j(),c=performance.now()-d,m=e?O:V,w=l.transaction([m],"readwrite").objectStore(m),g=te(o,e),$=s||Ce(o),p={url:g,data:t,timestamp:Date.now(),size:t.byteLength,videoId:$||void 0},f=performance.now();await new Promise((S,A)=>{const v=w.put(p);v.onsuccess=()=>{const u=performance.now()-f;console.log(`[VIDEO CACHE] ${a} stored in IndexedDB in ${u.toFixed(2)}ms (size: ${t.byteLength} bytes)`),S()},v.onerror=()=>{const u=performance.now()-f;console.error(`[VIDEO CACHE] Error storing ${a} after ${u.toFixed(2)}ms:`,v.error),A(v.error)}});const C=performance.now()-n;console.log(`[VIDEO CACHE] Total ${a} cache write time: ${C.toFixed(2)}ms`),ve().catch(()=>{})}catch(d){const l=performance.now()-n;console.error(`[VIDEO CACHE] Exception storing ${a} after ${l.toFixed(2)}ms:`,d)}}async function ie(o,t=!1){try{const e=await j(),s=t?O:V,a=e.transaction([s],"readwrite").objectStore(s),d=te(o,t);await new Promise((l,c)=>{const m=a.delete(d);m.onsuccess=()=>l(),m.onerror=()=>c(m.error)})}catch{}}async function Se(){try{const o=await j();let t=0;for(const e of[V,O]){const a=o.transaction([e],"readonly").objectStore(e).getAll();await new Promise(d=>{a.onsuccess=()=>{const l=a.result;t+=l.reduce((c,m)=>c+m.size,0),d()},a.onerror=()=>d()})}return t}catch{return 0}}let J=!1,se=0;const $e=5e3;async function ve(){const o=Date.now();if(J||o-se<$e)return;J=!0,se=o;const t=performance.now();try{const e=await Se();if(e<=re){J=!1;return}console.log(`[VIDEO CACHE] Starting cache cleanup (size: ${(e/1024/1024).toFixed(2)}MB, max: ${(re/1024/1024).toFixed(2)}MB)`);const s=await j(),n=[];for(const c of[V,O]){const m=c===O,g=s.transaction([c],"readonly").objectStore(c).index("timestamp");await new Promise($=>{const p=g.openCursor();p.onsuccess=f=>{const C=f.target.result;if(C){const S=C.value;n.push({url:S.url,timestamp:S.timestamp,size:S.size,isManifest:m}),C.continue()}else $()},p.onerror=()=>$()})}let a=e,d=0;for(const c of n){if(a<=re*.8)break;await ie(c.url,c.isManifest),a-=c.size,d++}const l=performance.now()-t;console.log(`[VIDEO CACHE] Cache cleanup completed in ${l.toFixed(2)}ms (deleted ${d} entries, new size: ${(a/1024/1024).toFixed(2)}MB)`)}catch(e){const s=performance.now()-t;console.error(`[VIDEO CACHE] Cache cleanup error after ${s.toFixed(2)}ms:`,e)}finally{J=!1}}async function Le(o){try{const s=(await j()).transaction([W],"readwrite").objectStore(W),n={videoId:o,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((a,d)=>{const l=s.put(n);l.onsuccess=()=>a(),l.onerror=()=>d(l.error)})}catch{}}async function Ae(o){try{const n=(await j()).transaction([W],"readonly").objectStore(W).index("lastAccessed");return new Promise(a=>{const d=n.openCursor(null,"prev"),l=[];d.onsuccess=c=>{const m=c.target.result;m&&l.length<o?(l.push(m.value.videoId),m.continue()):a(l)},d.onerror=()=>a([])})}catch{return[]}}async function xe(o){const t=performance.now();console.log(`[VIDEO CACHE] clearOldVideoCache called for currentVideoId=${o}`);try{const e=await j(),s=performance.now(),n=await Ae(ye),a=performance.now()-s,d=new Set([o,...n]);console.log(`[VIDEO CACHE] Keeping cache for ${d.size} videos: current=${o}, recent=${n.slice(0,5).join(", ")}${n.length>5?"...":""} (lookup took ${a.toFixed(2)}ms)`);let l=0,c=0;for(const h of[V,O]){const g=h===O?"MANIFEST":"SEGMENT",$=performance.now(),f=e.transaction([h],"readwrite").objectStore(h),C=f.index("videoId"),S=f.getAll();await new Promise(A=>{S.onsuccess=async()=>{const v=S.result;c+=v.length;let u=0;console.log(`[VIDEO CACHE] Checking ${v.length} ${g} entries`);for(const x of v)x.videoId&&!d.has(x.videoId)&&await new Promise(B=>{const Y=f.delete(x.url);Y.onsuccess=()=>{u++,l++,B()},Y.onerror=()=>B()});const T=performance.now()-$;console.log(`[VIDEO CACHE] ${g} store: checked ${v.length}, cleared ${u} (took ${T.toFixed(2)}ms)`),A()},S.onerror=()=>{console.error(`[VIDEO CACHE] Error getting ${g} entries`),A()}})}const m=performance.now()-t;console.log(`[VIDEO CACHE] clearOldVideoCache completed in ${m.toFixed(2)}ms: checked ${c} entries, cleared ${l} entries`)}catch(e){const s=performance.now()-t;console.error(`[VIDEO CACHE] Error in clearOldVideoCache after ${s.toFixed(2)}ms:`,e)}}function de(o){return o.includes(".m3u8")||o.endsWith("/manifest")}function te(o,t){if(t)try{const e=new URL(o),s=new URLSearchParams(e.search),n=Array.from(s.entries()).sort(([a],[d])=>a.localeCompare(d));return e.search=new URLSearchParams(n).toString(),e.toString()}catch{return o}else try{const e=new URL(o);return e.origin+e.pathname}catch{const e=o.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return e?e[0]:o.split("?")[0]}}const be=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:xe,getCached:ae,isManifest:de,normalizeCacheKey:te,setCached:ce,trackVideoAccess:Le},Symbol.toStringTag,{value:"Module"}));class Te{constructor(){_(this,"cache",new Map);_(this,"maxSize",100);_(this,"maxAge",5*60*1e3)}get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.maxAge?(this.cache.delete(t),null):(this.cache.delete(t),this.cache.set(t,e),e.data):null}set(t,e){if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s&&this.cache.delete(s)}this.cache.set(t,{data:e,timestamp:Date.now()})}clear(){this.cache.clear()}}const ee=new Te;let P={currentVideoId:null,skipCacheForVideoId:null};function Ie(o){P.currentVideoId=o,o&&P.skipCacheForVideoId!==o&&(P.skipCacheForVideoId=null)}function He(o){P.skipCacheForVideoId=o}function Fe(o){return o?P.skipCacheForVideoId===o?(console.log(`[CACHE CONTROL] Skipping cache for videoId=${o} (explicitly marked to skip)`),!1):P.currentVideoId===o&&P.skipCacheForVideoId!==o?(console.log(`[CACHE CONTROL] Using cache for videoId=${o} (current video for looping)`),!0):P.skipCacheForVideoId!==null?(console.log(`[CACHE CONTROL] Skipping cache for videoId=${o} (backward navigation mode, skipCacheForVideoId=${P.skipCacheForVideoId})`),!1):(console.log(`[CACHE CONTROL] Using cache for videoId=${o} (default - forward navigation)`),!0):!0}class le{constructor(t){_(this,"context",null);_(this,"stats");_(this,"defaultLoader",null);_(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,s){this.context=t;const n=t.url,a=de(n),d=performance.now(),l=a?"MANIFEST":"SEGMENT";let c;try{const f=n.match(/videodelivery\.net\/([^\/]+)\//);f&&(c=f[1])}catch{}console.log(`[CACHE LOADER] Loading ${l}: ${n} at ${d.toFixed(2)}ms${c?` (videoId=${c})`:""}`);let m;try{const f=n.match(/videodelivery\.net\/([^\/]+)\//);f&&(m=f[1])}catch{}if(!Fe(m)){console.log(`[CACHE LOADER] Skipping cache for ${l}${c?` (videoId=${c})`:""} - fetching from network`),this.fetchFromNetwork(n,a,t,e,s,m);return}const w=performance.now(),g=ee.get(n),$=performance.now()-w;if(g){const f=performance.now()-d;console.log(`[CACHE LOADER] ${l} found in memory cache in ${f.toFixed(2)}ms (lookup: ${$.toFixed(2)}ms)${c?` for videoId=${c}`:""}`);let C;a?C=new TextDecoder().decode(g):C=g;const S=performance.now();this.stats.loading.start=S,this.stats.loading.first=S,this.stats.loading.end=S,this.stats.loaded=g.byteLength,this.stats.total=g.byteLength,this.stats.aborted=!1;const A={data:C,url:n,code:200};s.onSuccess(A,this.stats,t,{});return}console.log(`[CACHE LOADER] ${l} not in memory cache (lookup took ${$.toFixed(2)}ms), checking IndexedDB`);const p=performance.now();ae(n,a).then(f=>{const C=performance.now()-p;if(f){const S=performance.now()-d;console.log(`[CACHE LOADER] ${l} found in IndexedDB cache in ${S.toFixed(2)}ms (lookup: ${C.toFixed(2)}ms)${c?` for videoId=${c}`:""}`),ee.set(n,f);let A;a?A=new TextDecoder().decode(f):A=f;const v=performance.now();this.stats.loading.start=v,this.stats.loading.first=v,this.stats.loading.end=v,this.stats.loaded=f.byteLength,this.stats.total=f.byteLength,this.stats.aborted=!1;const u={data:A,url:n,code:200};s.onSuccess(u,this.stats,t,{});return}console.log(`[CACHE LOADER] ${l} not in IndexedDB cache (lookup took ${C.toFixed(2)}ms), fetching from network`),this.fetchFromNetwork(n,a,t,e,s,m)}).catch(f=>{const C=performance.now()-p;console.error(`[CACHE LOADER] IndexedDB lookup error after ${C.toFixed(2)}ms:`,f),this.fetchFromNetwork(n,a,t,e,s,m)})}async fetchFromNetwork(t,e,s,n,a,d){var m;const l=performance.now(),c=e?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Fetching ${c} from network: ${t} at ${l.toFixed(2)}ms`);try{const h=this.abortController||new AbortController,w=await fetch(t,{method:s.method||"GET",headers:s.headers||{},signal:h.signal}).catch(x=>{throw x.name==="AbortError",x});if(!w.ok)throw new Error(`HTTP ${w.status}: ${w.statusText}`);let g;const $=w.headers.get("content-type")||"";e||$.includes("application/vnd.apple.mpegurl")||$.includes("text")?g=await w.text():g=await w.arrayBuffer();const p=performance.now(),f=p-l,C=typeof g=="string"?new TextEncoder().encode(g).length:g.byteLength;console.log(`[CACHE LOADER] ${c} fetched from network in ${f.toFixed(2)}ms, size: ${C} bytes`),this.stats.loading.start=l,this.stats.loading.first=l,this.stats.loading.end=p,this.stats.loaded=C,this.stats.total=C,this.stats.aborted=!1;const S=performance.now(),A=g instanceof ArrayBuffer?g:new TextEncoder().encode(g).buffer,v=performance.now();ee.set(t,A);const u=performance.now()-v;console.log(`[CACHE LOADER] ${c} stored in memory cache in ${u.toFixed(2)}ms`),ce(t,A,e,d).then(()=>{const x=performance.now()-S;console.log(`[CACHE LOADER] ${c} stored in IndexedDB in ${x.toFixed(2)}ms`)}).catch(x=>{console.error(`[CACHE LOADER] Error storing ${c} in IndexedDB:`,x)});const T={data:g,url:w.url,code:w.status};a.onSuccess(T,this.stats,s,{})}catch(h){const w=performance.now();if(this.stats.loading.start=l,this.stats.loading.first=l,this.stats.loading.end=w,this.stats.loaded=0,this.stats.total=0,h instanceof Error&&h.name==="AbortError")this.stats.aborted=!0,(m=a.onAbort)==null||m.call(a,this.stats,s,{});else if(!(h instanceof Error&&h.name==="AbortError")){this.stats.aborted=!1;const g=h instanceof Error?h:new Error("Network error");a.onError({code:0,text:g.message},s,{},this.stats)}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=new AbortController)}destroy(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.context=null,this.defaultLoader=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const Me=Object.freeze(Object.defineProperty({__proto__:null,CachedLoader:le,memoryCache:ee,setCurrentVideoForCache:Ie,skipCacheForVideo:He},Symbol.toStringTag,{value:"Module"})),Pe=({playbackUrl:o,streamUID:t,aspectRatio:e,preferNative:s=!1,autoplay:n=!1,loop:a=!1,muted:d=!1,controls:l=!0,onVideoRef:c,onClick:m,videoKey:h})=>{const[w,g]=L.useState(1.7777777777777777),$=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;L.useEffect(()=>{if(!$)return;const E=()=>g(window.innerWidth/Math.max(1,window.innerHeight));return E(),window.addEventListener("resize",E),()=>window.removeEventListener("resize",E)},[$]);const p=L.useRef(null),[f,C]=L.useState(null),S=L.useMemo(()=>{const E=1.3333333333333333,H=16/9,i=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(i)return Math.min(H,Math.max(E,i));const I=$?w:16/9;return Math.min(H,Math.max(E,I))},[$,w,e]),v=`${f??S} / 1`,u=L.useMemo(()=>o||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[o,t]),T=L.useRef(null),x=L.useMemo(()=>{if(!u)return null;try{const E=u.match(/videodelivery\.net\/([^\/]+)\//);return E?E[1]:u}catch{return u}},[u]);L.useEffect(()=>{if(!u||!x){console.log("[PLAYER] No hlsUrl or videoId, skipping cache tracking");return}const E=T.current&&T.current!==u,H=!T.current,i=T.current&&T.current===u;console.log(`[PLAYER] Video change detected: hlsUrl=${u}, videoId=${x}`),console.log(`[PLAYER] Previous hlsUrl=${T.current||"null"}, isVideoChange=${E}, isInitialMount=${H}, isReturningToVideo=${i}`),he(async()=>{const{trackVideoAccess:I,clearOldVideoCache:y}=await Promise.resolve().then(()=>be);return{trackVideoAccess:I,clearOldVideoCache:y}},void 0).then(({trackVideoAccess:I,clearOldVideoCache:y})=>{const M=performance.now();if(I(x).then(()=>{const k=performance.now()-M;console.log(`[PLAYER] Tracked video access for ${x} in ${k.toFixed(2)}ms`)}).catch(k=>{console.error("[PLAYER] Error tracking video access:",k)}),E&&!i){const k=performance.now();console.log(`[PLAYER] Clearing old video cache (switching from ${T.current} to ${u})`),y(x).then(()=>{const q=performance.now()-k;console.log(`[PLAYER] Old video cache cleared in ${q.toFixed(2)}ms`)}).catch(q=>{console.error("[PLAYER] Error clearing old video cache:",q)})}else console.log(`[PLAYER] Skipping cache clear: isVideoChange=${E}, isReturningToVideo=${i}`)}),T.current=u},[u,x]),L.useEffect(()=>{C(null)},[u]),L.useEffect(()=>{if(!s||!p.current)return;const E=p.current;let H=!1;const i=()=>{if(!H)if(E.videoWidth>0&&E.videoHeight>0){const I=E.videoWidth/E.videoHeight,y=4/3,M=16/9,k=Math.min(M,Math.max(y,I));C(k),H=!0}else C(S),H=!0};return E.addEventListener("loadedmetadata",i),E.readyState>=1&&i(),()=>{E.removeEventListener("loadedmetadata",i)}},[s,S,u]);const B=L.useRef(null);L.useEffect(()=>{if(!u){console.log("[HLS] No hlsUrl provided, skipping HLS setup");return}const E=B.current===u,H=B.current;console.log(`[HLS] HLS effect triggered: hlsUrl=${u}, prevHlsUrl=${H||"null"}, isReturningToVideo=${E}`),B.current=u;let i=null,I=null,y=!1,M=null;const k=()=>{if(document.hidden&&i){const r=p.current;if(r)try{r.pause()}catch{}try{i.stopLoad()}catch{}}},q=()=>{if(y=!0,i){try{i.stopLoad(),i.detachMedia(),i.destroy()}catch{}i=null}};document.addEventListener("visibilitychange",k),window.addEventListener("beforeunload",q);const ue=()=>{const r=p.current;if(!r||y){console.warn(`[HLS] Cannot setup HLS: video=${!!r}, isCleanedUp=${y}`);return}const N=performance.now();if(console.log(`[HLS] Starting HLS setup for ${u} at ${N.toFixed(2)}ms`),console.log(`[HLS] Previous URL was: ${H||"null"}, isReturningToVideo=${E}`),console.log(`[HLS] Video element ready: readyState=${r.readyState}, paused=${r.paused}, currentTime=${r.currentTime.toFixed(2)}s`),F.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const K={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,startFragPrefetch:!0,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3,loader:le};try{const U=performance.now();i=new F(K);const z=performance.now()-U;console.log(`[HLS] HLS instance created in ${z.toFixed(2)}ms`);const b=performance.now();i.loadSource(u);const R=performance.now()-b;console.log(`[HLS] loadSource() called in ${R.toFixed(2)}ms`);const D=performance.now();i.attachMedia(r);const oe=performance.now()-D;console.log(`[HLS] attachMedia() completed in ${oe.toFixed(2)}ms`);const G=performance.now()-N;console.log(`[HLS] Total HLS setup time: ${G.toFixed(2)}ms`)}catch(U){const z=performance.now()-N;if(console.error(`[HLS] Failed to initialize HLS after ${z.toFixed(2)}ms:`,U),i){try{i.destroy()}catch{}i=null}return}i.on(F.Events.MANIFEST_PARSED,()=>{const U=performance.now()-N;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${U.toFixed(2)}ms after setup start`),console.log(`[HLS] This indicates manifest was loaded ${E?"(should be from cache for returning video)":"(may be from network or cache)"}`),y||!r){console.warn("[HLS] MANIFEST_PARSED but video is cleaned up or missing");return}a&&(M=()=>{if(!(y||!r||!i))try{i.stopLoad(),r.currentTime=0,i.startLoad(),r.play().catch(b=>{b.name!=="AbortError"&&b.name!=="NotAllowedError"&&console.debug("Loop play failed:",b)})}catch{r.currentTime=0,r.play().catch(()=>{})}},r.addEventListener("ended",M)),(()=>{if(y||!r){console.log(`[HLS] Skipping autoplay: isCleanedUp=${y}, video=${!!r}`);return}const b=()=>{if(!(y||!r)&&(r.muted=d,n)){const R=performance.now();console.log(`[HLS] Attempting autoplay: readyState=${r.readyState}, paused=${r.paused}, muted=${r.muted}`),r.play().then(()=>{const D=performance.now()-R;console.log(`[HLS] Autoplay succeeded in ${D.toFixed(2)}ms (readyState=${r.readyState})`)}).catch(D=>{const oe=performance.now()-R;if(D.name!=="AbortError"&&D.name!=="NotAllowedError"&&(console.warn(`[HLS] Autoplay prevented after ${oe.toFixed(2)}ms:`,D),r.readyState<3)){const G=()=>{y||!r||(r.removeEventListener("canplaythrough",G),n&&r.paused&&r.play().catch(()=>{}))};r.addEventListener("canplaythrough",G,{once:!0})}})}};if(r.readyState>=3)b();else if(r.readyState>=2){b();const R=()=>{y||!r||(r.removeEventListener("canplaythrough",R),n&&r.paused&&b())};r.addEventListener("canplaythrough",R,{once:!0})}else{const R=()=>{y||!r||(r.removeEventListener("canplay",R),b())};r.addEventListener("canplay",R,{once:!0});const D=()=>{y||!r||(r.removeEventListener("canplaythrough",D),n&&r.paused&&b())};r.addEventListener("canplaythrough",D,{once:!0})}})()}),i.on(F.Events.ERROR,(U,z)=>{if(!y&&z.fatal)switch(z.type){case F.ErrorTypes.NETWORK_ERROR:if(!y&&i)try{i.startLoad()}catch{}break;case F.ErrorTypes.MEDIA_ERROR:if(!y&&i)try{i.recoverMediaError()}catch{}break;default:i&&(i.destroy(),i=null);break}})}else y||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),r.src=u,I=()=>{y||console.warn("Native HLS playback failed")},r.addEventListener("error",I),n&&!y&&r.play().catch(K=>{K.name!=="AbortError"&&K.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",K)})};return y||requestAnimationFrame(()=>{requestAnimationFrame(()=>{!y&&p.current&&(ue(),c&&c(p.current))})}),()=>{y=!0,document.removeEventListener("visibilitychange",k),window.removeEventListener("beforeunload",q);const r=p.current;if(r&&M&&(r.removeEventListener("ended",M),M=null),i){try{i.off(F.Events.MANIFEST_PARSED),i.off(F.Events.ERROR),i.off(F.Events.MEDIA_ATTACHED),i.off(F.Events.MEDIA_DETACHED),i.off(F.Events.MANIFEST_LOADED),i.stopLoad(),i.detachMedia(),i.destroy()}catch{}i=null}if(r){I&&(r.removeEventListener("error",I),I=null);try{for(r.pause(),r.currentTime=0,r.src="",r.srcObject=null;r.firstChild;)r.removeChild(r.firstChild);r.load()}catch{}}console.log(`[HLS] Cleanup completed for ${u}`)}},[u,n]),L.useEffect(()=>{c&&(c(p.current),p.current||requestAnimationFrame(()=>{requestAnimationFrame(()=>{p.current&&c&&c(p.current)})}))},[c,s,u,h]),L.useEffect(()=>{const E=p.current;E&&c&&c(E)},[c]);const Y="100%",ne=$?{width:"100%",maxWidth:Y,maxHeight:"100%",aspectRatio:v,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:Y,maxHeight:"100%",height:"var(--player-height)",aspectRatio:v,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return u?Q.jsx("div",{style:ne,children:Q.jsx("video",{ref:p,autoPlay:n,loop:!1,muted:d,controls:l,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:m?"pointer":"default"},children:"Your browser does not support the video tag."},h!==void 0?`${u}-${h}`:u)}):Q.jsx("div",{style:ne,children:"No video available"})},Ve=({open:o,onClose:t,buttonRef:e,children:s,align:n="right",minWidth:a=160})=>{const[d,l]=L.useState(null),c=L.useRef(null);if(L.useEffect(()=>{if(!o||!e.current){l(null);return}const h=()=>{if(!e.current)return;const w=e.current.getBoundingClientRect();l({top:w.bottom+8,[n]:window.innerWidth-w[n==="right"?"right":"left"]})};return h(),window.addEventListener("resize",h),window.addEventListener("scroll",h,!0),()=>{window.removeEventListener("resize",h),window.removeEventListener("scroll",h,!0)}},[o,e,n]),L.useEffect(()=>{if(!o)return;const h=w=>{c.current&&!c.current.contains(w.target)&&e.current&&!e.current.contains(w.target)&&t()};return document.addEventListener("mousedown",h),()=>document.removeEventListener("mousedown",h)},[o,t,e]),!o||!d)return null;const m=Q.jsx("div",{ref:c,style:{position:"fixed",top:d.top,[n]:d[n],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return pe.createPortal(m,document.body)};export{Pe as P,He as a,Ve as b,Me as h,Ie as s,be as v};

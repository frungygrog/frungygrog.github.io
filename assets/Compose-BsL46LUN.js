import{r,j as e,T as Se,s as Ne}from"./vendor-react-Bj2Cd7tG.js";import{c as ke,b as Ie,a as ze,i as Ce}from"./editor-components-B-SB05wW.js";import{B as Ue}from"./editor-lib-DvUOAkfg.js";import{u as Le}from"./index-BQPrkZF9.js";const fe={standard:Ce,taiko:ze,mania:Ie,catch:ke},he={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Te=({value:x,onChange:c})=>{const[b,h]=r.useState(!1),v=r.useRef(null);r.useEffect(()=>{if(!b)return;const p=j=>{v.current&&!v.current.contains(j.target)&&h(!1)},S=j=>{j.key==="Escape"&&h(!1)};return document.addEventListener("mousedown",p),document.addEventListener("keydown",S),()=>{document.removeEventListener("mousedown",p),document.removeEventListener("keydown",S)}},[b]);const L=p=>e.jsxs("button",{className:`mode-option${p===x?" selected":""}`,onClick:()=>{c(p),h(!1)},role:"option","aria-selected":p===x,children:[e.jsx("img",{className:"mode-icon",src:fe[p],width:24,height:24,alt:""}),e.jsx("span",{children:he[p]})]},p);return e.jsxs("div",{className:"mode-select",ref:v,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":b,onClick:()=>h(p=>!p),children:[e.jsx("img",{className:"mode-icon",src:fe[x],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:he[x]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),b&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(L)})]})},M="https://api.osumappi.ng";function ge(x){if(!x)return"standard";const c=String(x).toLowerCase().trim();return c==="osu"||c==="0"||c==="standard"?"standard":c==="taiko"||c==="1"?"taiko":c==="catch"||c==="fruits"||c==="2"?"catch":c==="mania"||c==="3"?"mania":"standard"}function xe(x){var c;return(c=document.cookie.split("; ").map(b=>b.split("=")).find(([b])=>b===x))==null?void 0:c[1]}function Me({section:x,onUpload:c,onPost:b}){const{notify:h}=Le(),v=x==="mappi",[L,p]=r.useState(!1),[S,j]=r.useState(""),[a,w]=r.useState(null),[o,m]=r.useState(null),[G,O]=r.useState(!1),[B,N]=r.useState(""),T=r.useRef(0),[Y,Q]=r.useState(""),[Z,D]=r.useState("standard"),[u,ee]=r.useState(null),[P,H]=r.useState(0),[W,I]=r.useState(""),[be,z]=r.useState(""),[te,K]=r.useState(null),[A,_]=r.useState(""),[q,R]=r.useState(""),[ae,$]=r.useState(null),[se,X]=r.useState(!1),[ne,re]=r.useState(null),ie=100*1024*1024,J=r.useMemo(()=>u?`${u.name}:${u.size}:${u.lastModified}`:null,[u]),[C,oe]=r.useState(""),[le,de]=r.useState(!1),[k,V]=r.useState([]),ve=r.useRef(null);r.useEffect(()=>{T.current&&window.clearTimeout(T.current);const t=(S||"").trim();if(!t){N(""),w(null),m(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(t)){N(""),w(null),m(null);return}return T.current=window.setTimeout(async()=>{var i;try{let s;try{s=new URL(t)}catch{N("Invalid URL format");return}const d=s.hash.match(/#osu\/(\d+)/),l=d?d[1]:null;s.hash="";const f=s.toString(),pe=new URLSearchParams({url:f});l&&pe.set("beatmap_id",l);const E=await fetch(`${M}/api/osu/beatmap/resolve?${pe.toString()}`,{credentials:"include"});if(!E.ok){const F=await E.json().catch(()=>({})),y=String((F==null?void 0:F.error)||`HTTP ${E.status}: ${E.statusText}`);N(y),w(null),m(null);return}const g=await E.json(),U=Array.isArray(g==null?void 0:g.diffs)?g.diffs:[];if(!U.length&&!g.setId){N("No difficulties found"),w(null),m(null);return}if(w({setId:Number(g.setId)||0,beatmapId:g.beatmapId??null,title:String(g.title||""),artist:String(g.artist||""),mapper:String(g.mapper||""),diffs:U}),U.length>0){const F=Number.isFinite(Number(g.beatmapId))?Number(g.beatmapId):Number((i=U[0])==null?void 0:i.id),y=U.find(we=>Number(we.id)===F)||U[0],me=ge(y==null?void 0:y.mode);m({beatmapId:Number(y==null?void 0:y.id)||null,version:String((y==null?void 0:y.version)||""),mode:me}),v&&D(me)}else m(null);N("")}catch(s){N(`Failed to resolve: ${(s==null?void 0:s.message)||"Unknown error"}`),w(null),m(null)}},400),()=>{T.current&&window.clearTimeout(T.current)}},[S,v]);async function ce(){z("info"),I("Requesting upload URL...");const t=xe("csrf"),n=await fetch(`${M}/api/uploads/new`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":t||"","Content-Type":"application/json"},body:JSON.stringify({description:Y.slice(0,100),beatmap_url:S||void 0,size_bytes:(u==null?void 0:u.size)??void 0,mode:Z,beatmapset_id:(a==null?void 0:a.setId)??void 0,beatmap_id:(o==null?void 0:o.beatmapId)??void 0,beatmap_version:(o==null?void 0:o.version)??void 0,beatmap_title:a?`${a.title}`:void 0,beatmap_artist:a?`${a.artist}`:void 0,beatmap_mapper:a?`${a.mapper}`:void 0})});if(!n.ok){let s="Failed to create upload";try{const d=await n.json();s=(d==null?void 0:d.error)||(d==null?void 0:d.message)||s}catch{try{s=await n.text()}catch{}}throw new Error(s)}return await n.json()}async function ue(t,n,i="form"){await new Promise((s,d)=>{const l=new XMLHttpRequest;if(l.open("POST",t),l.upload.onprogress=f=>{f.lengthComputable&&H(Math.round(f.loaded/f.total*100))},l.onload=()=>l.status>=200&&l.status<300?s():d(new Error(`Upload failed (${l.status}) ${l.responseText||""}`)),l.onerror=()=>d(new Error("Network error")),i==="form"){const f=new FormData;f.append("file",n,n.name),l.send(f)}else l.setRequestHeader("Content-Type","application/octet-stream"),l.send(n)})}async function ye(){if(!(!u||!v)){if(u.size>ie){_("File exceeds 100MB limit");return}if(typeof ae=="number"&&ae>60.5){R("Clip exceeds 60s limit");return}J&&(X(!0),re(J)),H(0),z("info");try{const t=await ce();K(t.streamUID);let n=t.streamUID;try{I("Uploading..."),await ue(t.uploadURL,u,"form")}catch(i){z("warn"),I(`Retrying upload... (${(i==null?void 0:i.message)||i})`);const s=await ce();K(s.streamUID),n=s.streamUID,await ue(s.uploadURL,u,"binary")}z("info"),I("Processing...");for(let i=0;i<60;i++){await new Promise(d=>setTimeout(d,3e3));const s=await fetch(`${M}/api/videos/${n}`,{credentials:"include"});if(s.ok&&(await s.json()).status==="ready"){z("success"),I("Ready!"),h("Upload complete!",{variant:"success"}),ee(null),Q(""),j(""),w(null),m(null),D("standard"),H(0),K(null),_(""),R(""),$(null),X(!1),re(null),c&&c();break}}}catch(t){z("error"),I(t.message||"Error"),h(t.message||"Upload failed",{variant:"error"})}}}const je=async t=>{if(t.preventDefault(),!v){if(!C.trim()){h("Text is required",{variant:"error"});return}if(C.length>200){h("Text must be 200 characters or less",{variant:"error"});return}de(!0);try{const n=xe("csrf")||"",i=await fetch(`${M}/api/moddiposts`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":n},body:JSON.stringify({text:C.trim(),beatmap_url:S.trim()||void 0,beatmapset_id:(a==null?void 0:a.setId)??void 0,beatmap_id:(o==null?void 0:o.beatmapId)??(a==null?void 0:a.beatmapId)??void 0,beatmap_version:(o==null?void 0:o.version)??void 0,tags:k.length>0?k.join(","):void 0})});if(i.ok)h("Post created!",{variant:"success"}),oe(""),j(""),w(null),m(null),N(""),O(!1),V([]),b&&b();else{const s=await i.json().catch(()=>({}));h(s.error||"Failed to create post",{variant:"error"})}}catch{h("Failed to create post",{variant:"error"})}finally{de(!1)}}};return e.jsxs("div",{style:{background:"#121418",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:v?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>p(!L),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:v?"Upload a clip":"Create a post!"}),L?e.jsx(Se,{size:16}):e.jsx(Ne,{size:16})]}),L&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Te,{value:Z,onChange:D})]}),a?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[a.artist," – ",a.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",a.mapper]})]}),a.diffs.length>0&&e.jsx("select",{value:(o==null?void 0:o.beatmapId)??a.beatmapId??void 0,onChange:t=>{const n=Number(t.target.value),i=(a==null?void 0:a.diffs.find(s=>Number(s.id)===n))||null;if(i){const s=ge(i.mode);m({beatmapId:n,version:i.version,mode:s}),D(s)}},style:{background:"#0f1217",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:a.diffs.map(t=>e.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>O(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{w(null),m(null),j("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:S,onChange:t=>j(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:Y,onChange:t=>Q(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),B&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:B}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:t=>{var s;const n=((s=t.target.files)==null?void 0:s[0])||null;if(ee(n),$(null),n&&n.size>ie?_("File exceeds 100MB limit"):_(""),n)try{const d=URL.createObjectURL(n),l=document.createElement("video");l.preload="metadata",l.src=d,l.onloadedmetadata=()=>{URL.revokeObjectURL(d);const f=Number.isFinite(l.duration)?l.duration:NaN;Number.isFinite(f)&&$(f),Number.isFinite(f)&&f>60.5?R("Clip exceeds 60s limit"):R("")},l.onerror=()=>{URL.revokeObjectURL(d),$(null)}}catch{$(null)}else R("");const i=n?`${n.name}:${n.size}:${n.lastModified}`:null;i&&i!==ne&&X(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:ye,disabled:!u||!!A||!!q||se,style:{flexShrink:0},children:"Upload"})]}),A&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:A}),q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:q}),u&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",u.name," • ",(u.size/1024/1024).toFixed(1)," MB",se&&ne===J?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(P>0||W)&&e.jsxs("div",{className:"upload-status",children:[W&&e.jsx("div",{className:`chip ${be||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:W}),P>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":P,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,P))}%`}})})]}),te&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",te]})]})]}):e.jsx("form",{onSubmit:je,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:ve,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:C,onChange:t=>oe(t.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),a?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[a.artist," – ",a.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",a.mapper]})]}),a.diffs.length>0&&e.jsx("select",{value:(o==null?void 0:o.beatmapId)??a.beatmapId??void 0,onChange:t=>{const n=Number(t.target.value),i=(a==null?void 0:a.diffs.find(s=>Number(s.id)===n))||null;i&&m({beatmapId:n,version:i.version,mode:String(i.mode||"standard")})},style:{background:"#0f1217",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:a.diffs.map(t=>e.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:S,onChange:t=>j(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),B&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:B}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{k.includes("help")?V(k.filter(t=>t!=="help")):V([...k,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:k.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:k.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:k.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[a&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>O(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{w(null),m(null),j("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:le||!C.trim()||C.length>200,children:le?"Posting...":"Post"})]})]})})}),G&&a&&e.jsx(Ue,{open:G,onClose:()=>O(!1),downloadUrl:`${M}/api/osu/beatmapsets/${a.setId}/download?noVideo=1`,beatmapId:(o==null?void 0:o.beatmapId)??a.beatmapId??void 0,beatmapVersion:o==null?void 0:o.version})]})}export{Me as C};

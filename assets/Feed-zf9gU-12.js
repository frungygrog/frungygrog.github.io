import{J as M,g as U,e as E,r as g,j as n}from"./vendor-react-BcGuPv3N.js";import{P as L}from"./Post-0HzRSneL.js";import{C as P}from"./Compose-BZGHKsBp.js";import{d as _,e as b,A as C,a as D}from"./index-Bt7aG2Ch.js";import"./vendor-5bngNAZ_.js";import"./Popup-CfRPiBaA.js";import"./editor-lib-B1vDSaUI.js";import"./beatmap-preview-q2bqO_ZX.js";import"./editor-components-ZomeoNmo.js";function Q(){const{data:c}=_(),{tagFilters:d}=b();return M({queryKey:["moddi","feed",d],queryFn:async({pageParam:u=0})=>{const a=new URLSearchParams({limit:"20",offset:String(u)}),i=`${C.moddi.posts}?${a.toString()}`;return await D(i)},enabled:!!c,initialPageParam:0,getNextPageParam:(u,a)=>{var l;const i=a.reduce((p,m)=>{var o;return p+(((o=m.items)==null?void 0:o.length)||0)},0);return(((l=u.items)==null?void 0:l.length)||0)===20?i:void 0}})}function w(){const c=U(),d=E(),{data:u}=_(),{tagFilters:a}=b(),{data:i,fetchNextPage:x,hasNextPage:l,isFetching:p,isFetchingNextPage:m,refetch:o}=Q(),y=g.useMemo(()=>i!=null&&i.pages?i.pages.flatMap(e=>(e.items||[]).map(t=>({...t,user_id:t.user_id??0,username:t.username||"Unknown",avatar_url:t.avatar_url||null,text:t.text??null,uid:t.uid||String(t.id||""),reactions_count:Number(t.reactions_count??0),reacted_by_me:t.reacted_by_me??!1,comments_count:Number(t.comments_count??0)}))):[],[i]),f=g.useMemo(()=>y.filter(e=>{const s=e.tags?typeof e.tags=="string"?e.tags.split(",").map(h=>h.trim()):[]:[],t=!e.tags||s.length===0,r=s.includes("help");return a.untagged&&a.help?!0:a.untagged&&!a.help?t:!a.untagged&&a.help?r:!1}),[y,a]);g.useEffect(()=>{c.pathname==="/md/feed"&&o()},[c.pathname,o]),g.useEffect(()=>{const e=()=>{o()};return window.addEventListener("moddifilterchange",e),()=>window.removeEventListener("moddifilterchange",e)},[o]);const N=e=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(t=>({...t,items:t.items.map(r=>r.id===e.id?e:r)}))})},v=e=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(t=>({...t,items:t.items.filter(r=>r.id!==e)}))})},j=e=>{e&&d.setQueryData(["moddi","feed"],s=>{if(!s)return s;const t={...e,user_id:e.user_id??0,username:e.username||"Unknown",avatar_url:e.avatar_url||null,text:e.text??null,uid:e.uid||String(e.id||""),reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)};return{...s,pages:s.pages.map((r,h)=>h===0?{...r,items:[t,...r.items||[]]}:r)}}),d.invalidateQueries({queryKey:["moddi","feed"]}),o()},F=p&&!m,S=l??!1;return n.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[n.jsx("div",{className:"title",style:{marginBottom:8},children:"Feed"}),n.jsx("div",{className:"muted",style:{fontSize:12,marginBottom:12},children:"Say anything! If you want help, tag it accordingly and others can raise their hand."}),n.jsx(P,{section:"moddi",onPost:j}),n.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:n.jsxs("div",{className:"col",style:{gap:0},children:[f.length===0&&!F&&n.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),f.map(e=>n.jsx(L,{post:e,section:"moddi",onUpdate:N,onDelete:v,me:u},e.id)),f.length>0&&S&&n.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:n.jsx("button",{className:"btn secondary",onClick:()=>x(),disabled:m,children:m?"Loading...":"Load more"})})]})})]})}export{w as default};

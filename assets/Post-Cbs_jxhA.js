import{i as Ee,g as Pe,r as i,j as a,L as K,A as Ce,F as Ne,V as ze,E as Re,p as de,D as ce,G as ue,w as Ie}from"./vendor-react-_vsaDC62.js";import{u as Le,a as _,A as m,b as me,e as Me}from"./index-D6qh1hkn.js";import{P as Te,a as De}from"./Popup-CnqFYqIJ.js";import{B as Fe}from"./editor-lib-BGkr3wNG.js";function Be({beatmapMeta:e,beatmapVersion:p}){const d=i.useRef(null),w=i.useRef(null),[x,D]=i.useState(!1),[j,F]=i.useState(!1),[r,k]=i.useState(0);i.useEffect(()=>{if(d.current&&w.current){const $=d.current.offsetWidth,z=w.current.scrollWidth;k(z),F(z>$)}},[e,p]);const S=e?a.jsxs(a.Fragment,{children:[e.artist," – ",e.title,e.mapper?` (by ${e.mapper})`:"",p?` [${p}]`:""]}):p?`[${p}]`:"Beatmap",B=r>0?Math.max(3,r/50):3;return a.jsxs(a.Fragment,{children:[a.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),a.jsxs("div",{ref:d,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:j?"pointer":"default"},onMouseEnter:()=>j&&D(!0),onMouseLeave:()=>D(!1),children:[a.jsx("span",{ref:w,style:{display:"inline-block",animation:x&&j?`beatmap-marquee ${B}s linear infinite`:"none"},children:S}),x&&j&&a.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:S})]})]})}function $e(e){return"post_type"in e?e.post_type==="mappi":!!e.stream_uid}function Ue({post:e,section:p,onUpdate:d,onDelete:w,me:x}){const D=Ee(),j=Pe(),F=p==="mappi"?j.pathname.startsWith("/mp/feed/"):j.pathname.startsWith("/md/feed/"),r=$e(e);e.id;const k=r?e.stream_uid||String(e.id||""):e.uid||String(e.id||""),S=k&&k!=="null"&&k!=="undefined"?p==="mappi"?`/mp/feed/${k}`:`/md/feed/${k}`:p==="mappi"?`/mp/feed/${e.id}`:`/md/feed/${e.id}`,[B,$]=i.useState(!1),[z,Y]=i.useState(!1),[R,W]=i.useState(!1),[pe,I]=i.useState(!1),[Z,ee]=i.useState(!1),V=i.useRef(null),E=i.useRef(null),te=i.useRef(null),[G,ae]=i.useState(null),[A,fe]=i.useState(null),{notify:y}=Le(),[P,X]=i.useState(!1),[ne,O]=i.useState(r?"":e.text??""),[H,L]=i.useState(e.beatmap_url||""),[l,f]=i.useState(null),[h,u]=i.useState(null),[re,b]=i.useState(""),M=i.useRef(0),ie=x&&((r?e.uploader&&x.id===e.uploader.id:x.id===e.user_id)||x.is_admin||x.is_mod),se=(()=>{const t=e.created_at;if(!t)return"";const n=Math.floor(Date.now()/1e3)-t;return n<60?"just now":n<3600?`${Math.floor(n/60)}m`:n<86400?`${Math.floor(n/3600)}h`:n<604800?`${Math.floor(n/86400)}d`:new Date(t*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();i.useEffect(()=>{if(!P&&!r){const t=e;O(t.text??""),L(t.beatmap_url||""),f(null),u(null),b("")}},[e,P,r]),i.useEffect(()=>{if(!P||r)return;M.current&&window.clearTimeout(M.current);const t=(H||"").trim();if(!t){b(""),f(null),u(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(t)){b(""),f(null),u(null);return}return M.current=window.setTimeout(async()=>{var s;try{let o;try{o=new URL(t)}catch{b("Invalid URL format");return}const T=o.hash.match(/#osu\/(\d+)/),Q=T?T[1]:null;o.hash="";const v={url:o.toString()};Q&&(v.beatmap_id=Q);const c=await _(m.osu.resolveBeatmap+me(v),{requireAuth:!1}),N=Array.isArray(c==null?void 0:c.diffs)?c.diffs:[];if(!N.length&&!c.setId){b("No difficulties found"),f(null),u(null);return}if(f({setId:Number(c.setId)||0,beatmapId:c.beatmapId??null,title:String(c.title||""),artist:String(c.artist||""),mapper:String(c.mapper||""),diffs:N}),N.length>0){const we=Number.isFinite(Number(c.beatmapId))?Number(c.beatmapId):Number((s=N[0])==null?void 0:s.id),g=N.find(Se=>Number(Se.id)===we)||N[0];u({beatmapId:Number(g==null?void 0:g.id)||null,version:String((g==null?void 0:g.version)||""),mode:String((g==null?void 0:g.mode)||"standard")})}else u(null);b("")}catch(o){b(`Failed to resolve: ${(o==null?void 0:o.message)||"Unknown error"}`),f(null),u(null)}},400),()=>{M.current&&window.clearTimeout(M.current)}},[H,P,r]),i.useEffect(()=>{if(r||!e.beatmap_url||A)return;const t=e;let n=!1;return(async()=>{try{let s;try{s=new URL(t.beatmap_url)}catch{return}const o=s.hash.match(/#osu\/(\d+)/),T=o?o[1]:null;s.hash="";const q={url:s.toString()};if(T?q.beatmap_id=T:t.beatmap_id&&(q.beatmap_id=String(t.beatmap_id)),!n){const v=await _(m.osu.resolveBeatmap+me(q),{requireAuth:!1});(v.title||v.artist)&&fe({title:v.title||null,artist:v.artist||null,mapper:v.mapper||null})}}catch{}})(),()=>{n=!0}},[e,r,A]);const he=async()=>{if(!(B||!r)){$(!0);try{const t=e.liked_by_me?"DELETE":"POST",n=await _(m.videos.like(e.id),{method:t}),s={...e,liked_by_me:!e.liked_by_me,likes_count:n.likes_count||e.likes_count};d&&d(s)}catch{y("Failed to like",{variant:"error"})}finally{$(!1)}}},be=async()=>{if(!(z||r)){Y(!0);try{const t=e.reacted_by_me?"DELETE":"POST",n=await _(m.moddi.postReact(e.id),{method:t}),s={...e,reacted_by_me:!e.reacted_by_me,reactions_count:n.reactions_count||e.reactions_count};d&&d(s)}catch{y("Failed to react",{variant:"error"})}finally{Y(!1)}}},le=async()=>{if(confirm(r?"Permanently delete this video?":"Permanently delete this post?")){try{const t=r?m.videos.delete(e.id):m.moddi.post(String(e.id));await _(t,{method:"DELETE"}),y(r?"Video deleted":"Post deleted",{variant:"warn"}),w&&w(e.id)}catch(t){y((t==null?void 0:t.message)||(r?"Failed to delete video":"Failed to delete post"),{variant:"error"})}I(!1)}},ge=async()=>{if(r){try{const t=!e.is_starred,n=t?"star":"unstar";await _(m.admin.videosAction(e.id,n),{method:"POST"});const s={...e,is_starred:t};d&&d(s),y(t?"Post starred":"Star removed",{variant:"success"})}catch{y("Action failed",{variant:"error"})}I(!1)}},xe=()=>{r||(X(!0),O(e.text??""),L(e.beatmap_url||""),f(null),u(null),b(""),I(!1))},ye=async()=>{if(!r)try{await _(m.moddi.post(String(e.id)),{method:"PATCH",body:JSON.stringify({text:ne.trim(),beatmap_url:H.trim()||null,beatmapset_id:(l==null?void 0:l.setId)??void 0,beatmap_id:(h==null?void 0:h.beatmapId)??(l==null?void 0:l.beatmapId)??void 0,beatmap_version:(h==null?void 0:h.version)??void 0})});const t=await _(m.moddi.post(String(e.id)),{method:"GET",requireAuth:!1});d&&t.post&&d({...e,...t.post}),y("Post updated",{variant:"success"}),X(!1)}catch(t){y((t==null?void 0:t.message)||"Failed to update post",{variant:"error"})}},ve=()=>{X(!1);const t=e;O(t.text??""),L(t.beatmap_url||""),f(null),u(null),b("")};i.useEffect(()=>{if(!R||!E.current){ae(null);return}const t=()=>{if(E.current){const n=E.current.getBoundingClientRect();ae({top:n.bottom+8,right:window.innerWidth-n.right})}};return t(),window.addEventListener("resize",t),window.addEventListener("scroll",t,!0),()=>{window.removeEventListener("resize",t),window.removeEventListener("scroll",t,!0)}},[R]),i.useEffect(()=>{if(!R)return;const t=n=>{V.current&&!V.current.contains(n.target)&&E.current&&!E.current.contains(n.target)&&W(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[R]);const _e=t=>{const n=t.target;if(n.closest("button")||n.closest(".menu-panel")||n.closest("input")||n.closest("textarea")||n.closest("select"))return;const s=n.closest("a");s&&s.getAttribute("href")!==`#${S}`||D(S)},C=r?e.uploader||{id:0,username:"Unknown",avatar_url:null}:{id:e.user_id||0,username:e.username||"Unknown",avatar_url:e.avatar_url||null},U=!r&&(e.reacted_by_me===!0||e.reacted_by_me===1),oe=!r&&e.tags&&(typeof e.tags=="string"?e.tags.split(",").map(t=>t.trim()):[]).includes("help"),J=e.beatmapset_id,je=e.beatmap_id,ke=e.beatmap_version;return a.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:t=>t.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:t=>t.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",onClick:_e,children:[a.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[C.avatar_url?a.jsx(K,{to:`/profile/${C.id}`,onClick:t=>t.stopPropagation(),style:{flexShrink:0},children:a.jsx("img",{src:C.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:C.username})}):a.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),a.jsx(K,{to:S,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:t=>{const n=t.target,s=n.closest("a");if(s&&s!==t.currentTarget){t.preventDefault(),t.stopPropagation();return}if(n.closest("button")||n.closest(".menu-panel")||n.closest("input")||n.closest("textarea")||n.closest("select")){t.preventDefault(),t.stopPropagation();return}t.stopPropagation()},children:a.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[a.jsx(K,{to:`/profile/${C.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:t=>t.stopPropagation(),onMouseEnter:t=>t.currentTarget.style.color="#7dd3fc",onMouseLeave:t=>t.currentTarget.style.color="inherit",children:C.username}),r&&e.is_starred&&a.jsx(Ce,{size:14,color:"#f59e0b",title:"Starred"}),r&&e.mode&&a.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:e.mode}),!r&&oe&&a.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[se&&a.jsx("span",{className:"muted",style:{fontSize:13},children:se}),ie&&a.jsx("button",{ref:te,onClick:t=>{t.preventDefault(),t.stopPropagation(),I(n=>!n)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:t=>t.currentTarget.style.backgroundColor="rgba(255,255,255,0.05)",onMouseLeave:t=>t.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:a.jsx(Ne,{size:16})})]})]}),r&&F&&e.playback_url&&a.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10"},children:a.jsx(Te,{playbackUrl:e.playback_url,streamUID:e.stream_uid,aspectRatio:e.width&&e.height?e.width/e.height:null})}),r&&!F&&e.poster_url&&a.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10",aspectRatio:e.width&&e.height?`${e.width} / ${e.height}`:"16 / 9",position:"relative"},children:[a.jsx("img",{src:e.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),e.duration_sec&&a.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(e.duration_sec/60),":",(e.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!r&&P?a.jsx("div",{style:{marginBottom:12},children:a.jsxs("div",{className:"col",style:{gap:8},children:[a.jsx("textarea",{value:ne,onChange:t=>O(t.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),l?a.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[a.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[a.jsxs("strong",{style:{marginRight:4},children:[l.artist," – ",l.title]}),a.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",l.mapper]})]}),l.diffs.length>0&&a.jsx("select",{value:(h==null?void 0:h.beatmapId)??(l==null?void 0:l.beatmapId)??void 0,onChange:t=>{const n=Number(t.target.value),s=(l==null?void 0:l.diffs.find(o=>Number(o.id)===n))||null;s&&u({beatmapId:n,version:s.version,mode:String(s.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:l.diffs.map(t=>a.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))}),a.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{f(null),u(null),L("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):a.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:H,onChange:t=>L(t.target.value),style:{fontSize:13,padding:"6px 8px"}}),re&&a.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:re}),a.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[a.jsx("button",{className:"btn secondary",onClick:ve,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),a.jsx("button",{className:"btn",onClick:ye,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):a.jsxs(a.Fragment,{children:[(()=>{if(r){const t=e.description??"";return t.trim()?a.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:t}):null}else{const t=e.text??"";return t.trim()?a.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:t}):null}})(),r&&e.beatmap_title&&a.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"#7b8491",lineHeight:1.4},children:[e.beatmap_artist," – ",e.beatmap_title," ",e.beatmap_mapper?`(by ${e.beatmap_mapper})`:""," ",e.beatmap_version?`[${e.beatmap_version}]`:""]}),!P&&a.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[r&&e.beatmap_url&&!e.beatmap_title&&a.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!r&&e.beatmap_url&&(A||e.beatmapset_id||e.beatmap_id)&&a.jsx(Be,{beatmapMeta:A,beatmapVersion:e.beatmap_version}),a.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[r&&a.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:t=>{t.preventDefault(),t.stopPropagation()},children:[a.jsx(ze,{size:12}),a.jsx("span",{children:e.views_count??0})]}),a.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:t=>{t.preventDefault(),t.stopPropagation()},children:[a.jsx(Re,{size:12}),a.jsx("span",{children:e.comments_count??0})]}),r?a.jsxs("button",{className:`chip-btn like ${e.liked_by_me?"liked":""}`,onClick:t=>{t.preventDefault(),t.stopPropagation(),he()},disabled:B,"aria-label":e.liked_by_me?"Unlike":"Like",title:e.liked_by_me?"Unlike":"Like",children:[e.liked_by_me?a.jsx(de,{size:16}):a.jsx(ce,{size:16}),a.jsx("span",{children:e.likes_count||0})]}):a.jsxs("button",{className:`chip-btn like ${U?"liked":""}`,onClick:t=>{t.preventDefault(),t.stopPropagation(),be()},disabled:z,"aria-label":U?"Remove reaction":"React",title:U?"Remove reaction":"React",children:[oe?a.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):U?a.jsx(de,{size:16}):a.jsx(ce,{size:16}),a.jsx("span",{children:e.reactions_count||0})]}),e.beatmap_url&&a.jsxs("button",{ref:E,className:"chip-btn link",onClick:t=>{t.preventDefault(),t.stopPropagation(),W(n=>!n)},title:"Beatmap options","aria-label":"Beatmap options",children:[a.jsx(ue,{size:16}),a.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),a.jsx(Ie,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),R&&G&&e.beatmap_url&&a.jsxs("div",{ref:V,style:{position:"fixed",top:G.top,right:G.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[a.jsxs("a",{className:"menu-item",href:e.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>W(!1),children:[a.jsx(ue,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),J&&a.jsx("button",{className:"menu-item",onClick:()=>{ee(!0),W(!1)},children:"Preview"})]}),Z&&J&&a.jsx(Fe,{open:Z,onClose:()=>ee(!1),downloadUrl:`${Me}${m.osu.downloadBeatmapset(J)}`,beatmapId:je??void 0,beatmapVersion:ke??void 0}),ie&&a.jsx(De,{open:pe,onClose:()=>I(!1),buttonRef:te,minWidth:160,children:r?a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"menu-item",onClick:t=>{t.preventDefault(),t.stopPropagation(),ge()},children:e.is_starred?"Unstar post":"Star post"}),a.jsx("button",{className:"menu-item",onClick:t=>{t.preventDefault(),t.stopPropagation(),le()},children:"Delete video"})]}):a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"menu-item",onClick:xe,children:"Edit post"}),a.jsx("button",{className:"menu-item",onClick:le,children:"Delete post"})]})})]})}export{Ue as P};

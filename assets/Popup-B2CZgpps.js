var Y=Object.defineProperty;var Z=(r,t,e)=>t in r?Y(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var H=(r,t,e)=>Z(r,typeof t!="symbol"?t+"":t,e);import{_ as G}from"./index-CWmlHdmd.js";import{r as w,j,Z as J}from"./vendor-react-_vsaDC62.js";import{H as A}from"./vendor-DBgzFpze.js";const Q="video-cache",ee=1,x="segments",C="manifests",te=7*24*60*60*1e3,W=500*1024*1024;let $=null,k=null;function P(){return $?Promise.resolve($):k||(k=new Promise((r,t)=>{const e=indexedDB.open(Q,ee);e.onerror=()=>t(e.error),e.onsuccess=()=>{$=e.result,r($)},e.onupgradeneeded=a=>{const o=a.target.result;o.objectStoreNames.contains(x)||o.createObjectStore(x,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),o.objectStoreNames.contains(C)||o.createObjectStore(C,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),k)}async function D(r,t=!1){try{const e=await P(),a=t?C:x,s=e.transaction([a],"readonly").objectStore(a),n=_(r,t);console.log(`[Video Cache] ðŸ” Looking up cache key: ${n.substring(n.lastIndexOf("/")+1)} (original: ${r.substring(r.lastIndexOf("/")+1).substring(0,50)}...)`);const u=s.get(n);return new Promise(i=>{u.onsuccess=()=>{const l=u.result;if(!l){i(null);return}if(Date.now()-l.timestamp>te){U(r,t).catch(()=>{}),i(null);return}i(l.data)},u.onerror=()=>i(null)})}catch(e){return console.warn("Cache read error:",e),null}}async function B(r,t,e=!1){try{const a=await P(),o=e?C:x,n=a.transaction([o],"readwrite").objectStore(o),u=_(r,e);console.log(`[Video Cache] ðŸ’¾ Storing with cache key: ${u.substring(u.lastIndexOf("/")+1)} (original: ${r.substring(r.lastIndexOf("/")+1).substring(0,50)}...)`);const i={url:u,data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((l,d)=>{const h=n.put(i);h.onsuccess=()=>l(),h.onerror=()=>d(h.error)}),await oe()}catch(a){console.warn("Cache write error:",a)}}async function U(r,t=!1){try{const e=await P(),a=t?C:x,s=e.transaction([a],"readwrite").objectStore(a),n=_(r,t);await new Promise((u,i)=>{const l=s.delete(n);l.onsuccess=()=>u(),l.onerror=()=>i(l.error)})}catch(e){console.warn("Cache delete error:",e)}}async function re(){try{const r=await P();let t=0;for(const e of[x,C]){const s=r.transaction([e],"readonly").objectStore(e).getAll();await new Promise(n=>{s.onsuccess=()=>{const u=s.result;t+=u.reduce((i,l)=>i+l.size,0),n()},s.onerror=()=>n()})}return t}catch(r){return console.warn("Cache size calculation error:",r),0}}async function oe(){try{const r=await re();if(r<=W)return;const t=await P(),e=[];for(const o of[x,C]){const s=o===C,i=t.transaction([o],"readonly").objectStore(o).getAll();await new Promise(l=>{i.onsuccess=()=>{const d=i.result;e.push(...d.map(h=>({url:h.url,timestamp:h.timestamp,size:h.size,isManifest:s}))),l()},i.onerror=()=>l()})}e.sort((o,s)=>o.timestamp-s.timestamp);let a=r;for(const o of e){if(a<=W*.8)break;await U(o.url,o.isManifest),a-=o.size}}catch(r){console.warn("Cache cleanup error:",r)}}async function ne(){try{const r=await P();for(const t of[x,C]){const a=r.transaction([t],"readwrite").objectStore(t);await new Promise((o,s)=>{const n=a.clear();n.onsuccess=()=>{console.log(`[Video Cache] ðŸ—‘ï¸ Cleared ${t} cache`),o()},n.onerror=()=>s(n.error)})}}catch(r){console.warn("Cache clear error:",r)}}function X(r){return r.includes(".m3u8")||r.endsWith("/manifest")}function _(r,t){if(t)try{const e=new URL(r),a=new URLSearchParams(e.search),o=Array.from(a.entries()).sort(([s],[n])=>s.localeCompare(n));return e.search=new URLSearchParams(o).toString(),e.toString()}catch{return r}else try{const e=new URL(r);return e.origin+e.pathname}catch{const e=r.match(/[^\/\?]+\.(ts|m4s|mp4|webm)/i);return e?e[0]:r.split("?")[0]}}const se=Object.freeze(Object.defineProperty({__proto__:null,clearCache:ne,getCached:D,isManifest:X,normalizeCacheKey:_,setCached:B},Symbol.toStringTag,{value:"Module"}));class ae{constructor(t){H(this,"context",null);H(this,"stats");H(this,"defaultLoader",null);H(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,a){this.context=t;const o=t.url,s=X(o);D(o,s).then(n=>{if(n){let i;s?i=new TextDecoder().decode(n):i=n;const l=performance.now();this.stats.loading.start=l,this.stats.loading.first=l,this.stats.loading.end=l,this.stats.loaded=n.byteLength,this.stats.total=n.byteLength,this.stats.aborted=!1;const d={data:i,url:o,code:200},h=s?"manifest":"segment",S=(n.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${h}: ${o.substring(o.lastIndexOf("/")+1)} (${S} KB)`),a.onSuccess(d,this.stats,t,{});return}console.log(`[Video Cache] âŒ Cache MISS - ${s?"manifest":"segment"}: ${o.substring(o.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(o,s,t,e,a)}).catch(n=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${s?"manifest":"segment"}: ${o.substring(o.lastIndexOf("/")+1)} - falling back to network`,n),this.fetchFromNetwork(o,s,t,e,a)})}async fetchFromNetwork(t,e,a,o,s){var u;const n=performance.now();try{const i=this.abortController||new AbortController,l=await fetch(t,{method:a.method||"GET",headers:a.headers||{},signal:i.signal}).catch(v=>{throw v.name==="AbortError",v});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);let d;const h=l.headers.get("content-type")||"";e||h.includes("application/vnd.apple.mpegurl")||h.includes("text")?d=await l.text():d=await l.arrayBuffer();const S=performance.now(),E=typeof d=="string"?new TextEncoder().encode(d).length:d.byteLength;this.stats.loading.start=n,this.stats.loading.first=n,this.stats.loading.end=S,this.stats.loaded=E,this.stats.total=E,this.stats.aborted=!1;const I=e?"manifest":"segment";if(d instanceof ArrayBuffer){await B(t,d,e);const v=(d.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${I}: ${t.substring(t.lastIndexOf("/")+1)} (${v} KB)`)}else{const z=new TextEncoder().encode(d);await B(t,z.buffer,e);const T=(z.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${I}: ${t.substring(t.lastIndexOf("/")+1)} (${T} KB)`)}const M={data:d,url:l.url,code:l.status};s.onSuccess(M,this.stats,a,{})}catch(i){const l=performance.now();if(this.stats.loading.start=n,this.stats.loading.first=n,this.stats.loading.end=l,this.stats.loaded=0,this.stats.total=0,i instanceof Error&&i.name==="AbortError")this.stats.aborted=!0,(u=s.onAbort)==null||u.call(s,this.stats,a,{});else if(!(i instanceof Error&&i.name==="AbortError")){this.stats.aborted=!1;const d=i instanceof Error?i:new Error("Network error");s.onError({code:0,text:d.message},a,{},this.stats)}}}abort(){this.abortController&&this.abortController.abort()}destroy(){this.context=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}},this.abortController&&(this.abortController.abort(),this.abortController=null)}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const ue=({playbackUrl:r,streamUID:t,aspectRatio:e,preferNative:a=!1,autoplay:o=!1,loop:s=!1,muted:n=!1,controls:u=!0,onVideoRef:i,onClick:l})=>{const[d,h]=w.useState(1.7777777777777777),S=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;w.useEffect(()=>{if(!S)return;const c=()=>h(window.innerWidth/Math.max(1,window.innerHeight));return c(),window.addEventListener("resize",c),()=>window.removeEventListener("resize",c)},[S]);const E=w.useRef(null),[I,M]=w.useState(null),v=w.useMemo(()=>{const c=1.3333333333333333,b=16/9,f=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(f)return Math.min(b,Math.max(c,f));const y=S?d:16/9;return Math.min(b,Math.max(c,y))},[S,d,e]),T=`${I??v} / 1`,g=w.useMemo(()=>r||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[r,t]),O=w.useRef(null);w.useEffect(()=>{g&&O.current&&O.current!==g&&(console.log(`[Video Cache] ðŸŽ¬ Video changed from ${O.current.substring(O.current.lastIndexOf("/")+1)} to ${g.substring(g.lastIndexOf("/")+1)} - clearing cache`),G(async()=>{const{clearCache:c}=await Promise.resolve().then(()=>se);return{clearCache:c}},void 0).then(({clearCache:c})=>{c().catch(b=>{console.warn("[Video Cache] Failed to clear cache on video change:",b)})})),O.current=g},[g]),w.useEffect(()=>{M(null)},[g]),w.useEffect(()=>{if(!a||!E.current)return;const c=E.current;let b=!1;const f=()=>{if(!b)if(c.videoWidth>0&&c.videoHeight>0){const y=c.videoWidth/c.videoHeight,K=4/3,N=16/9,m=Math.min(N,Math.max(K,y));M(m),b=!0}else M(v),b=!0};return c.addEventListener("loadedmetadata",f),c.readyState>=1&&f(),()=>{c.removeEventListener("loadedmetadata",f)}},[a,v,g]),w.useEffect(()=>{if(!g)return;let c=null,b=null,f=!1,y=null;const N=setTimeout(()=>{const m=E.current;if(!(!m||f))if(A.isSupported()){const L={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:ae};c=new A(L),c.loadSource(g),c.attachMedia(m),c.on(A.Events.MANIFEST_PARSED,()=>{if(f||!m)return;const V=g.substring(g.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${V}`);let p=!1;y=()=>{!p&&!f&&(p=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${V}`),m&&y&&m.removeEventListener("playing",y))},m.addEventListener("playing",y),o&&!f&&m.play().catch(R=>{R.name!=="AbortError"&&R.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",R)})}),c.on(A.Events.ERROR,(V,p)=>{if(!f&&(console.error("[HLS Error]",{type:p.type,details:p.details,fatal:p.fatal,url:p.url,error:p.error,response:p.response}),p.fatal))switch(p.type){case A.ErrorTypes.NETWORK_ERROR:if(!f&&c){console.warn("HLS network error, trying to recover...",{details:p.details,url:p.url,error:p.error});try{c.startLoad()}catch(R){f||console.warn("HLS recovery failed:",R)}}break;case A.ErrorTypes.MEDIA_ERROR:if(!f&&c){console.warn("HLS media error, trying to recover...");try{c.recoverMediaError()}catch(R){f||console.warn("HLS media recovery failed:",R)}}break;default:f||console.error("HLS fatal error:",p),c&&(c.destroy(),c=null);break}})}else f||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),m.src=g,b=()=>{f||console.warn("Native HLS playback failed")},m.addEventListener("error",b),o&&!f&&m.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",L)})},0);return()=>{f=!0,clearTimeout(N);const m=E.current;if(m&&y&&(m.removeEventListener("playing",y),y=null),c){try{c.detachMedia(),c.destroy()}catch{}c=null}if(m){b&&m.removeEventListener("error",b);try{m.pause(),m.src="",m.load()}catch{}}}},[g,o]),w.useEffect(()=>{i&&i(E.current)},[i,a,g]);const q="100%",F=S?{width:"100%",maxWidth:q,maxHeight:"100%",aspectRatio:T,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:q,maxHeight:"100%",height:"var(--player-height)",aspectRatio:T,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return g?j.jsx("div",{style:F,children:j.jsx("video",{ref:E,autoPlay:o,loop:s,muted:n,controls:u,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:l?"pointer":"default"},children:"Your browser does not support the video tag."},g)}):j.jsx("div",{style:F,children:"No video available"})},fe=({open:r,onClose:t,buttonRef:e,children:a,align:o="right",minWidth:s=160})=>{const[n,u]=w.useState(null),i=w.useRef(null);if(w.useEffect(()=>{if(!r||!e.current){u(null);return}const d=()=>{if(!e.current)return;const h=e.current.getBoundingClientRect();u({top:h.bottom+8,[o]:window.innerWidth-h[o==="right"?"right":"left"]})};return d(),window.addEventListener("resize",d),window.addEventListener("scroll",d,!0),()=>{window.removeEventListener("resize",d),window.removeEventListener("scroll",d,!0)}},[r,e,o]),w.useEffect(()=>{if(!r)return;const d=h=>{i.current&&!i.current.contains(h.target)&&e.current&&!e.current.contains(h.target)&&t()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[r,t,e]),!r||!n)return null;const l=j.jsx("div",{ref:i,style:{position:"fixed",top:n.top,[o]:n[o],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:s,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:a});return J.createPortal(l,document.body)};export{ue as P,fe as a};

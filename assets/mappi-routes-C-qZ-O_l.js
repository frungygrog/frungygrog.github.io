import{r as a,j as t,d as Ve,u as _e,e as Le,L as pe,A as Ce,F as $e,f as Ge,g as Xe,h as Se,i as je,k as ke,l as Re,m as Ye,n as Je,R as Ke,c as Qe,o as Ze,p as et,q as tt}from"./vendor-react-BTN9mWiO.js";import{H as O}from"./vendor-hls-B_fsdCYC.js";import{B as nt}from"./editor-DAGTbBEv.js";import{P as at}from"./beatmap-preview-CcT7m1yb.js";const Te=a.createContext(null);function pt({children:e}){const[l,d]=a.useState([]),y=a.useRef(1),p=a.useRef(new Map),v=c=>{const h=p.current.get(c);h&&(clearTimeout(h),p.current.delete(c))},r=(c,h)=>{v(c);const f=window.setTimeout(()=>x(c),h);p.current.set(c,f)},x=a.useCallback(c=>{v(c),d(h=>h.filter(f=>f.id!==c))},[]),i=a.useCallback((c,h)=>{const f=typeof h=="number"?h:(h==null?void 0:h.durationMs)??5e3,L=typeof h=="number"?"info":(h==null?void 0:h.variant)??"info",N=(()=>{try{return window.matchMedia("(max-width: 600px), (pointer: coarse)").matches}catch{return!1}})();let j=null;return d(N?P=>{const E=P[0];if(E&&E.message===c&&E.variant===L){const _={...E,count:E.count+1,duration:f};return j=_.id,[_]}P.forEach(_=>v(_.id));const g=y.current++,D={id:g,message:c,duration:f,variant:L,count:1};return j=g,[D]}:P=>{const E=P.findIndex(_=>_.message===c&&_.variant===L);if(E!==-1){const _=[...P],$={..._[E],count:_[E].count+1};return _[E]=$,j=$.id,_}const g=y.current++,D={id:g,message:c,duration:f,variant:L,count:1};return j=g,[...P,D]}),j!=null&&r(j,f),j??-1},[]),C=a.useMemo(()=>({notify:i,close:x}),[i,x]);return t.jsxs(Te.Provider,{value:C,children:[e,t.jsx("div",{className:"toasts",children:l.map(c=>t.jsxs("div",{className:`toast ${c.variant}`,children:[t.jsxs("div",{className:"toast-text",children:[c.message,c.count>1&&t.jsxs("span",{style:{marginLeft:6,opacity:.8},children:["×",c.count]})]}),t.jsx("button",{className:"toast-close",onClick:()=>x(c.id),"aria-label":"Close",children:"×"})]},c.id))})]})}function he(){const e=a.useContext(Te);if(!e)throw new Error("useToasts must be used within ToastProvider");return e}const ge="https://api.osumappi.ng";function it(){var e;try{return((e=document.cookie.split("; ").map(l=>l.split("=")).find(([l])=>l==="csrf"))==null?void 0:e[1])||""}catch{return""}}async function U(e,l={}){const{requireAuth:d=!0,skipCsrf:y=!1,...p}=l,v={...p.headers};if(p.body&&!v["Content-Type"]&&(v["Content-Type"]="application/json"),d&&!y){const x=it();x&&(v["X-CSRF-Token"]=x)}const r=await fetch(`${ge}${e}`,{...p,credentials:"include",headers:v});if(!r.ok){const x=await r.json().catch(()=>({error:`HTTP ${r.status}`}));throw new Error(x.error||`HTTP ${r.status}: ${r.statusText}`)}return r.json()}function Ee(e){const l=new URLSearchParams;for(const[y,p]of Object.entries(e))p!=null&&l.append(y,String(p));const d=l.toString();return d?`?${d}`:""}const I={auth:{login:"/api/auth/login",logout:"/api/auth/logout",me:"/api/me"},user:{quota:"/api/me/upload_quota",notifications:"/api/me/notifications",markNotificationsRead:"/api/me/notifications/mark_read",deleteNotification:e=>`/api/me/notifications/${encodeURIComponent(e)}`},feed:{next:"/api/feed/next",batch:"/api/feed/batch",progress:e=>`/api/feed/progress${e?`?modes=${encodeURIComponent(e)}`:""}`,recent:"/api/videos/recent"},videos:{like:e=>`/api/videos/${e}/like`,view:e=>`/api/videos/${e}/view`,update:e=>`/api/videos/${e}`,delete:e=>`/api/videos/${e}`,flag:e=>`/api/videos/${e}/flag`,comments:e=>`/api/videos/${e}/comments`,get:e=>`/api/videos/${e}`},uploads:{new:"/api/uploads/new"},moddi:{posts:"/api/moddiposts",post:e=>`/api/moddiposts/${e}`,postReact:e=>`/api/moddiposts/${e}/react`,postComments:e=>`/api/moddiposts/${e}/comments`,queues:"/api/moddi/queues",queue:e=>`/api/moddi/queues/${e}`,queueSubmit:e=>`/api/moddi/queues/${e}/submit`,queueAccept:e=>`/api/moddi/queues/${e}/accept`,queueDeny:e=>`/api/moddi/queues/${e}/deny`,queueInvite:e=>`/api/moddi/queues/${e}/invite`,queueMember:(e,l)=>`/api/moddi/queues/${e}/members/${l}`,queueSubmission:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}`,queueSubmissionDelete:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}`,queueBlockUser:e=>`/api/moddi/queues/${e}/block`,queueUnblockUser:(e,l)=>`/api/moddi/queues/${e}/block/${l}`,queueBlockedUsers:e=>`/api/moddi/queues/${e}/blocked`,queueSubmissionAcknowledge:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}/acknowledge`,queueSubmissionUnacknowledge:(e,l)=>`/api/moddi/queues/${e}/submissions/${l}/acknowledge`,usersSearch:e=>`/api/moddi/users/search?q=${encodeURIComponent(e)}`},osu:{resolveBeatmap:"/api/osu/beatmap/resolve",downloadBeatmapset:e=>`/api/osu/beatmapsets/${e}/download?noVideo=1`,usersSearch:e=>`/api/osu/users/search?q=${encodeURIComponent(e)}`},users:{get:e=>`/api/users/${e}`,videos:e=>`/api/users/${e}/videos`,likes:e=>`/api/users/${e}/likes`,myVideos:"/api/me/videos"},admin:{clearViews:"/api/admin/me/clear_views",debugState:"/api/debug/state",settingsModeration:"/api/admin/settings/moderation",videosPending:"/api/admin/videos/pending",videosApprove:e=>`/api/admin/videos/${e}/approve`,videosReject:e=>`/api/admin/videos/${e}/reject`,videosAction:(e,l)=>`/api/admin/videos/${e}/${l}`,analytics:"/api/admin/analytics",usersSearch:e=>`/api/admin/users/search?q=${encodeURIComponent(e)}`,userVideos:e=>`/api/admin/users/${e}/videos`,userUpdate:e=>`/api/admin/users/${e}`,notificationsSystem:"/api/admin/notifications/system",notificationsTest:"/api/admin/notifications/test"}},Pe=({open:e,onClose:l,buttonRef:d,children:y,align:p="right",minWidth:v=160})=>{const[r,x]=a.useState(null),i=a.useRef(null);if(a.useEffect(()=>{if(!e||!d.current){x(null);return}const c=()=>{if(!d.current)return;const h=d.current.getBoundingClientRect();x({top:h.bottom+8,[p]:window.innerWidth-h[p==="right"?"right":"left"]})};return c(),window.addEventListener("resize",c),window.addEventListener("scroll",c,!0),()=>{window.removeEventListener("resize",c),window.removeEventListener("scroll",c,!0)}},[e,d,p]),a.useEffect(()=>{if(!e)return;const c=h=>{i.current&&!i.current.contains(h.target)&&d.current&&!d.current.contains(h.target)&&l()};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[e,l,d]),!e||!r)return null;const C=t.jsx("div",{ref:i,style:{position:"fixed",top:r.top,[p]:r[p],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:v,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:y});return Ve.createPortal(C,document.body)},Ne=({playbackUrl:e,streamUID:l,aspectRatio:d,preferNative:y=!1,autoplay:p=!1,loop:v=!1,muted:r=!1,controls:x=!0,onVideoRef:i,onClick:C,inOverlay:c=!1})=>{const h=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,f=a.useRef(null),[L,N]=a.useState(null),j=a.useMemo(()=>{const s=typeof d=="number"&&isFinite(d)&&d>0?d:null;return s||16/9},[d]),E=`${L??j} / 1`,g=a.useMemo(()=>e||(l?`https://videodelivery.net/${l}/manifest/video.m3u8`:null),[e,l]),D=a.useRef(null);a.useEffect(()=>{g&&(D.current=g)},[g]),a.useEffect(()=>{N(null)},[g]),a.useEffect(()=>{if(!y||!f.current)return;const s=f.current;let M=!1;const k=()=>{if(!M)if(s.videoWidth>0&&s.videoHeight>0){const q=s.videoWidth/s.videoHeight;N(q),M=!0}else N(j),M=!0};return s.addEventListener("loadedmetadata",k),s.readyState>=1&&k(),()=>{s.removeEventListener("loadedmetadata",k)}},[y,j,g]);const _=a.useRef(null),$=a.useRef(null);a.useEffect(()=>{if(!g)return;let s=_.current,M=null,k=!1,q=null;if(s&&$.current&&$.current!==g){console.log(`[HLS] URL changed from ${$.current} to ${g}, using loadSource`);try{s.stopLoad(),s.loadSource(g),$.current=g;const o=f.current;if(o)try{o.pause(),o.currentTime=0,o.load()}catch(H){console.warn("[HLS] Error resetting video element:",H)}}catch(o){console.error("[HLS] Error switching source:",o);try{s.destroy()}catch{}s=null,_.current=null,$.current=null}}if(s&&$.current===g)return console.log(`[HLS] URL unchanged (${g}), reusing existing HLS instance`),()=>{k=!0};const le=()=>{if(document.hidden&&s){const o=f.current;if(o)try{o.pause()}catch{}try{s.stopLoad()}catch{}}},B=()=>{if(k=!0,s){try{s.stopLoad(),s.detachMedia(),s.destroy()}catch{}s=null}};document.addEventListener("visibilitychange",le),window.addEventListener("beforeunload",B);const K=()=>{const o=f.current;if(!o||k)return;try{for(o.pause(),o.currentTime=0,o.src="",o.srcObject=null;o.firstChild;)o.removeChild(o.firstChild);o.load()}catch(u){console.warn("[HLS] Error resetting video element:",u)}const H=performance.now();if(console.log(`[HLS] Starting HLS setup for ${g} at ${H.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:o.readyState,isConnected:o.isConnected,paused:o.paused,currentTime:o.currentTime}),O.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const u={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const b=performance.now();s=new O(u),_.current=s,$.current=g;const F=performance.now()-b;console.log(`[HLS] HLS instance created in ${F.toFixed(2)}ms`);const A=performance.now();s.loadSource(g);const z=performance.now()-A;console.log(`[HLS] loadSource() called in ${z.toFixed(2)}ms`);const W=performance.now();s.attachMedia(o);const Q=performance.now()-W;console.log(`[HLS] attachMedia() completed in ${Q.toFixed(2)}ms`);const T=performance.now()-H;console.log(`[HLS] Total HLS setup time: ${T.toFixed(2)}ms`)}catch(b){const F=performance.now()-H;if(console.error(`[HLS] Failed to initialize HLS after ${F.toFixed(2)}ms:`,b),s){try{s.destroy()}catch{}s=null}return}s.on(O.Events.MANIFEST_PARSED,()=>{const b=performance.now()-H;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${b.toFixed(2)}ms after setup start`),k||!o)return;v&&(q=()=>{if(!(k||!o||!s))try{o.currentTime=0,o.play().catch(A=>{A.name!=="AbortError"&&A.name!=="NotAllowedError"&&console.debug("Loop play failed:",A)})}catch{o.currentTime=0,o.play().catch(()=>{})}},o.addEventListener("ended",q)),(()=>{if(!(k||!o))if(o.readyState>=2){if(p){const A=performance.now();o.play().then(()=>{const z=performance.now()-A;console.log(`[HLS] Autoplay succeeded in ${z.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(z=>{const W=performance.now()-A;z.name!=="AbortError"&&z.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${W.toFixed(2)}ms:`,z)})}}else{const A=()=>{if(!(k||!o)&&(o.removeEventListener("canplay",A),p)){const z=performance.now();o.play().then(()=>{const W=performance.now()-z;console.log(`[HLS] Autoplay succeeded in ${W.toFixed(2)}ms after canplay event`)}).catch(W=>{const Q=performance.now()-z;W.name!=="AbortError"&&W.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${Q.toFixed(2)}ms:`,W)})}};o.addEventListener("canplay",A,{once:!0})}})()}),s.on(O.Events.ERROR,(b,F)=>{if(!k&&F.fatal)switch(F.type){case O.ErrorTypes.NETWORK_ERROR:if(!k&&s)try{s.startLoad()}catch{}break;case O.ErrorTypes.MEDIA_ERROR:if(!k&&s)try{s.recoverMediaError()}catch{}break;default:s&&(s.destroy(),s=null);break}})}else k||console.warn("HLS.js not supported, falling back to native HLS"),o.src=g,o.loop=v,M=()=>{k||console.warn("Native HLS playback failed")},o.addEventListener("error",M),p&&!k&&o.play().catch(u=>{u.name!=="AbortError"&&u.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",u)})};let J=0;const V=10,X=()=>{if(k)return;if(J++,J>V){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const o=f.current;if(!o){requestAnimationFrame(X);return}if(!o.isConnected){requestAnimationFrame(X);return}K()},oe=requestAnimationFrame(()=>{requestAnimationFrame(X)});return()=>{cancelAnimationFrame(oe),k=!0,document.removeEventListener("visibilitychange",le),window.removeEventListener("beforeunload",B);const o=f.current;if(o&&q&&(o.removeEventListener("ended",q),q=null),s){try{s.stopLoad(),s.off(O.Events.MANIFEST_PARSED),s.off(O.Events.ERROR),s.off(O.Events.MEDIA_ATTACHED),s.off(O.Events.MEDIA_DETACHED),s.off(O.Events.MANIFEST_LOADED),s.off(O.Events.MEDIA_ATTACHING),s.off(O.Events.MEDIA_DETACHING),s.off(O.Events.DESTROYING),s.destroy()}catch{try{s&&s.detachMedia()}catch{}}s=null,_.current=null,$.current=null}if(o){M&&(o.removeEventListener("error",M),M=null);try{o.pause()}catch{}}}},[g,p]),a.useEffect(()=>(i&&f.current&&i(f.current),()=>{i&&i(null)}),[i,y,g]);const S=h||!c?{width:"auto",maxWidth:"100%",height:"100%",maxHeight:"100%",aspectRatio:E,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"100%",maxWidth:"100%",maxHeight:"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",aspectRatio:E,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"};return g?t.jsx("div",{style:S,children:t.jsx("video",{ref:f,autoPlay:p,loop:!1,muted:r,controls:x,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:C?"pointer":"default"},children:"Your browser does not support the video tag."})}):t.jsx("div",{style:S,children:"No video available"})};function rt({beatmapMeta:e,beatmapVersion:l}){const d=a.useRef(null),y=a.useRef(null),[p,v]=a.useState(!1),[r,x]=a.useState(!1),[i,C]=a.useState(0);a.useEffect(()=>{if(d.current&&y.current){const f=d.current.offsetWidth,L=y.current.scrollWidth;C(L),x(L>f)}},[e,l]);const c=e?t.jsxs(t.Fragment,{children:[e.artist," – ",e.title,e.mapper?` (by ${e.mapper})`:"",l?` [${l}]`:""]}):l?`[${l}]`:"Beatmap",h=i>0?Math.max(3,i/50):3;return t.jsxs(t.Fragment,{children:[t.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),t.jsxs("div",{ref:d,className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:r?"pointer":"default"},onMouseEnter:()=>r&&v(!0),onMouseLeave:()=>v(!1),children:[t.jsx("span",{ref:y,style:{display:"inline-block",animation:p&&r?`beatmap-marquee ${h}s linear infinite`:"none"},children:c}),p&&r&&t.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:c})]})]})}function st(e){return"post_type"in e?e.post_type==="mappi":!!e.stream_uid}function ot({post:e,section:l,onUpdate:d,onDelete:y,me:p}){const v=_e(),r=Le(),x=l==="mappi"?r.pathname.startsWith("/mp/feed/"):r.pathname.startsWith("/md/feed/"),i=st(e);e.id;const C=i?e.stream_uid||String(e.id||""):e.uid||String(e.id||""),c=C&&C!=="null"&&C!=="undefined"?l==="mappi"?`/mp/feed/${C}`:`/md/feed/${C}`:l==="mappi"?`/mp/feed/${e.id}`:`/md/feed/${e.id}`,[h,f]=a.useState(!1),[L,N]=a.useState(!1),[j,P]=a.useState(!1),[E,g]=a.useState(!1),[D,_]=a.useState(!1),$=a.useRef(null),S=a.useRef(null),s=a.useRef(null),[M,k]=a.useState(null),[q,le]=a.useState(null),{notify:B}=he(),[K,J]=a.useState(i?e.liked_by_me:void 0),[V,X]=a.useState(i?e.likes_count:0),[oe,o]=a.useState(i?void 0:e.reacted_by_me),[H,u]=a.useState(i?0:e.reactions_count);a.useEffect(()=>{if(i){const n=e;J(n.liked_by_me),X(n.likes_count)}else{const n=e;o(!!n.reacted_by_me),u(n.reactions_count)}},[e,i]);const[b,F]=a.useState(!1),[A,z]=a.useState(i?"":e.text??""),[W,Q]=a.useState(e.beatmap_url||""),[T,Z]=a.useState(null),[ee,Y]=a.useState(null),[xe,te]=a.useState(""),ue=a.useRef(0),be=p&&((i?e.uploader&&p.id===e.uploader.id:p.id===e.user_id)||p.is_admin||p.is_mod),ve=(()=>{const n=e.created_at;if(!n)return"";const m=Math.floor(Date.now()/1e3)-n;return m<60?"just now":m<3600?`${Math.floor(m/60)}m`:m<86400?`${Math.floor(m/3600)}h`:m<604800?`${Math.floor(m/86400)}d`:new Date(n*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();a.useEffect(()=>{if(!b&&!i){const n=e;z(n.text??""),Q(n.beatmap_url||""),Z(null),Y(null),te("")}},[e,b,i]),a.useEffect(()=>{if(!b||i)return;ue.current&&window.clearTimeout(ue.current);const n=(W||"").trim();if(!n){te(""),Z(null),Y(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(n)){te(""),Z(null),Y(null);return}return ue.current=window.setTimeout(async()=>{var w;try{let R;try{R=new URL(n)}catch{te("Invalid URL format");return}const ne=R.hash.match(/#osu\/(\d+)/),ae=ne?ne[1]:null;R.hash="";const se={url:R.toString()};ae&&(se.beatmap_id=ae);const G=await U(I.osu.resolveBeatmap+Ee(se),{requireAuth:!1}),ce=Array.isArray(G==null?void 0:G.diffs)?G.diffs:[];if(!ce.length&&!G.setId){te("No difficulties found"),Z(null),Y(null);return}if(Z({setId:Number(G.setId)||0,beatmapId:G.beatmapId??null,title:String(G.title||""),artist:String(G.artist||""),mapper:String(G.mapper||""),diffs:ce}),ce.length>0){const Oe=Number.isFinite(Number(G.beatmapId))?Number(G.beatmapId):Number((w=ce[0])==null?void 0:w.id),ie=ce.find(Ue=>Number(Ue.id)===Oe)||ce[0];Y({beatmapId:Number(ie==null?void 0:ie.id)||null,version:String((ie==null?void 0:ie.version)||""),mode:String((ie==null?void 0:ie.mode)||"standard")})}else Y(null);te("")}catch(R){te(`Failed to resolve: ${(R==null?void 0:R.message)||"Unknown error"}`),Z(null),Y(null)}},400),()=>{ue.current&&window.clearTimeout(ue.current)}},[W,b,i]),a.useEffect(()=>{if(i||!e.beatmap_url||q)return;const n=e;let m=!1;return(async()=>{try{let w;try{w=new URL(n.beatmap_url)}catch{return}const R=w.hash.match(/#osu\/(\d+)/),ne=R?R[1]:null;w.hash="";const re={url:w.toString()};if(ne?re.beatmap_id=ne:n.beatmap_id&&(re.beatmap_id=String(n.beatmap_id)),!m){const se=await U(I.osu.resolveBeatmap+Ee(re),{requireAuth:!1});(se.title||se.artist)&&le({title:se.title||null,artist:se.artist||null,mapper:se.mapper||null})}}catch{}})(),()=>{m=!0}},[e,i,q]);const Ie=async()=>{if(h||!i)return;f(!0);const n=K??!1,m=V,w=!n,R=w?V+1:Math.max(0,V-1);J(w),X(R);try{const ne=n?"DELETE":"POST",ae=await U(I.videos.like(e.id),{method:ne}),re={...e,liked_by_me:w,likes_count:ae.likes_count||R};J(w),X(ae.likes_count??R),d&&d(re)}catch{J(n),X(m),B("Failed to like",{variant:"error"})}finally{f(!1)}},Ae=async()=>{if(L||i)return;N(!0);const n=oe??!1,m=H,w=!n,R=w?H+1:Math.max(0,H-1);o(w),u(R);try{const ne=n?"DELETE":"POST",ae=await U(I.moddi.postReact(e.id),{method:ne}),re={...e,reacted_by_me:w,reactions_count:ae.reactions_count||R};o(w),u(ae.reactions_count??R),d&&d(re)}catch{o(n),u(m),B("Failed to react",{variant:"error"})}finally{N(!1)}},ye=async()=>{if(confirm(i?"Permanently delete this video?":"Permanently delete this post?")){try{const n=i?I.videos.delete(e.id):I.moddi.post(String(e.id));await U(n,{method:"DELETE"}),B(i?"Video deleted":"Post deleted",{variant:"warn"}),y&&y(e.id)}catch(n){B((n==null?void 0:n.message)||(i?"Failed to delete video":"Failed to delete post"),{variant:"error"})}g(!1)}},Me=async()=>{if(i){try{const n=!e.is_starred,m=n?"star":"unstar";await U(I.admin.videosAction(e.id,m),{method:"POST"});const w={...e,is_starred:n};d&&d(w),B(n?"Post starred":"Star removed",{variant:"success"})}catch{B("Action failed",{variant:"error"})}g(!1)}},Fe=()=>{i||(F(!0),z(e.text??""),Q(e.beatmap_url||""),Z(null),Y(null),te(""),g(!1))},ze=async()=>{if(!i)try{await U(I.moddi.post(String(e.id)),{method:"PATCH",body:JSON.stringify({text:A.trim(),beatmap_url:W.trim()||null,beatmapset_id:(T==null?void 0:T.setId)??void 0,beatmap_id:(ee==null?void 0:ee.beatmapId)??(T==null?void 0:T.beatmapId)??void 0,beatmap_version:(ee==null?void 0:ee.version)??void 0})});const n=await U(I.moddi.post(String(e.id)),{method:"GET",requireAuth:!1});d&&n.post&&d({...e,...n.post}),B("Post updated",{variant:"success"}),F(!1)}catch(n){B((n==null?void 0:n.message)||"Failed to update post",{variant:"error"})}},De=()=>{F(!1);const n=e;z(n.text??""),Q(n.beatmap_url||""),Z(null),Y(null),te("")};a.useEffect(()=>{if(!j||!S.current){k(null);return}const n=()=>{if(S.current){const m=S.current.getBoundingClientRect();k({top:m.bottom+8,right:window.innerWidth-m.right})}};return n(),window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),()=>{window.removeEventListener("resize",n),window.removeEventListener("scroll",n,!0)}},[j]),a.useEffect(()=>{if(!j)return;const n=m=>{$.current&&!$.current.contains(m.target)&&S.current&&!S.current.contains(m.target)&&P(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[j]);const qe=n=>{const m=n.target;if(m.closest("button")||m.closest(".menu-panel")||m.closest("input")||m.closest("textarea")||m.closest("select"))return;const w=m.closest("a");w&&w.getAttribute("href")!==`#${c}`||v(c)},de=i?e.uploader||{id:0,username:"Unknown",avatar_url:null}:{id:e.user_id||0,username:e.username||"Unknown",avatar_url:e.avatar_url||null},me=!i&&(oe??(e.reacted_by_me===!0||e.reacted_by_me===1)),we=!i&&e.tags&&(typeof e.tags=="string"?e.tags.split(",").map(n=>n.trim()):[]).includes("help"),fe=e.beatmapset_id,Be=e.beatmap_id,We=e.beatmap_version;return t.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",onClick:qe,children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[de.avatar_url?t.jsx(pe,{to:`/profile/${de.id}`,onClick:n=>n.stopPropagation(),style:{flexShrink:0},children:t.jsx("img",{src:de.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:de.username})}):t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),t.jsx(pe,{to:c,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:n=>{const m=n.target,w=m.closest("a");if(w&&w!==n.currentTarget){n.preventDefault(),n.stopPropagation();return}if(m.closest("button")||m.closest(".menu-panel")||m.closest("input")||m.closest("textarea")||m.closest("select")){n.preventDefault(),n.stopPropagation();return}n.stopPropagation()},children:t.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(pe,{to:`/profile/${de.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:n=>n.stopPropagation(),onMouseEnter:n=>n.currentTarget.style.color="#7dd3fc",onMouseLeave:n=>n.currentTarget.style.color="inherit",children:de.username}),i&&e.is_starred&&t.jsx(Ce,{size:14,color:"#f59e0b",title:"Starred"}),i&&e.mode&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:e.mode}),!i&&we&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[ve&&t.jsx("span",{className:"muted",style:{fontSize:13},children:ve}),be&&t.jsx("button",{ref:s,onClick:n=>{n.preventDefault(),n.stopPropagation(),g(m=>!m)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.05)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:t.jsx($e,{size:16})})]})]}),i&&x&&e.playback_url&&t.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10"},children:t.jsx(Ne,{playbackUrl:e.playback_url,streamUID:e.stream_uid,aspectRatio:e.width&&e.height?e.width/e.height:null})}),i&&!x&&e.poster_url&&t.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"#0b0d10",aspectRatio:e.width&&e.height?`${e.width} / ${e.height}`:"16 / 9",position:"relative"},children:[t.jsx("img",{src:e.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),e.duration_sec&&t.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(e.duration_sec/60),":",(e.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!i&&b?t.jsx("div",{style:{marginBottom:12},children:t.jsxs("div",{className:"col",style:{gap:8},children:[t.jsx("textarea",{value:A,onChange:n=>z(n.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),T?t.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[t.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[t.jsxs("strong",{style:{marginRight:4},children:[T.artist," – ",T.title]}),t.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",T.mapper]})]}),T.diffs.length>0&&t.jsx("select",{value:(ee==null?void 0:ee.beatmapId)??(T==null?void 0:T.beatmapId)??void 0,onChange:n=>{const m=Number(n.target.value),w=(T==null?void 0:T.diffs.find(R=>Number(R.id)===m))||null;w&&Y({beatmapId:m,version:w.version,mode:String(w.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:T.diffs.map(n=>t.jsxs("option",{value:n.id,children:[n.version," (",n.mode,")"]},n.id))}),t.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{Z(null),Y(null),Q("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):t.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:W,onChange:n=>Q(n.target.value),style:{fontSize:13,padding:"6px 8px"}}),xe&&t.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:xe}),t.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[t.jsx("button",{className:"btn secondary",onClick:De,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),t.jsx("button",{className:"btn",onClick:ze,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):t.jsxs(t.Fragment,{children:[(()=>{if(i){const n=e.description??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:n}):null}else{const n=e.text??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"rgba(255,255,255,0.9)"},children:n}):null}})(),i&&e.beatmap_title&&t.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"#7b8491",lineHeight:1.4},children:[e.beatmap_artist," – ",e.beatmap_title," ",e.beatmap_mapper?`(by ${e.beatmap_mapper})`:""," ",e.beatmap_version?`[${e.beatmap_version}]`:""]}),!b&&t.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[i&&e.beatmap_url&&!e.beatmap_title&&t.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!i&&e.beatmap_url&&(q||e.beatmapset_id||e.beatmap_id)&&t.jsx(rt,{beatmapMeta:q,beatmapVersion:e.beatmap_version}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[i&&t.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Ge,{size:12}),t.jsx("span",{children:e.views_count??0})]}),t.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Xe,{size:12}),t.jsx("span",{children:e.comments_count??0})]}),i?t.jsxs("button",{className:`chip-btn like ${K?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),Ie()},disabled:h,"aria-label":K?"Unlike":"Like",title:K?"Unlike":"Like",children:[K?t.jsx(Se,{size:16}):t.jsx(je,{size:16}),t.jsx("span",{children:V})]}):t.jsxs("button",{className:`chip-btn like ${me?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),Ae()},disabled:L,"aria-label":me?"Remove reaction":"React",title:me?"Remove reaction":"React",children:[we?t.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):me?t.jsx(Se,{size:16}):t.jsx(je,{size:16}),t.jsx("span",{children:H})]}),e.beatmap_url&&t.jsxs("button",{ref:S,className:"chip-btn link",onClick:n=>{n.preventDefault(),n.stopPropagation(),P(m=>!m)},title:"Beatmap options","aria-label":"Beatmap options",children:[t.jsx(ke,{size:16}),t.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),t.jsx(Re,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),j&&M&&e.beatmap_url&&t.jsxs("div",{ref:$,style:{position:"fixed",top:M.top,right:M.right,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsxs("a",{className:"menu-item",href:e.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>P(!1),children:[t.jsx(ke,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),fe&&t.jsx("button",{className:"menu-item",onClick:()=>{_(!0),P(!1)},children:"Preview"})]}),D&&fe&&t.jsx(nt,{open:D,onClose:()=>_(!1),downloadUrl:`${ge}${I.osu.downloadBeatmapset(fe)}`,beatmapId:Be??void 0,beatmapVersion:We??void 0}),be&&t.jsx(Pe,{open:E,onClose:()=>g(!1),buttonRef:s,minWidth:160,children:i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),Me()},children:e.is_starred?"Unstar post":"Star post"}),t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),ye()},children:"Delete video"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:Fe,children:"Edit post"}),t.jsx("button",{className:"menu-item",onClick:ye,children:"Delete post"})]})})]})}function He({comment:e,replies:l,me:d,onReply:y,onDelete:p,replyingTo:v,replyText:r,onReplyTextChange:x,onReplySubmit:i,posting:C,onCancelReply:c,section:h,repliesMap:f}){const[L,N]=a.useState(!1),j=a.useRef(null),{notify:P}=he(),[E,g]=a.useState(!1),D=e.parent_id!==null,_=d&&(d.id===e.user_id||d.is_admin||d.is_mod),$=async()=>{if(confirm("Delete this comment?"))try{const S=h==="mappi"?I.videos.comments(e.post_id)+`/${e.id}`:I.moddi.postComments(e.post_id)+`/${e.id}`;await U(S,{method:"DELETE"}),p(e.id),P("Comment deleted",{variant:"success"})}catch{P("Failed to delete comment",{variant:"error"})}finally{N(!1)}};return t.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease"},onMouseEnter:S=>S.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:S=>S.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[t.jsx("span",{style:{fontSize:13,fontWeight:500},children:e.username}),t.jsx("span",{className:"muted",style:{fontSize:11},children:new Date(e.created_at*1e3).toLocaleDateString()})]}),t.jsx("div",{style:{fontSize:14,lineHeight:1.5,wordBreak:"break-word"},children:e.text}),t.jsx("div",{style:{display:"flex",alignItems:"center",gap:12,marginTop:8},children:t.jsxs("button",{onClick:()=>y(e.id),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:12,padding:0},children:[t.jsx(Ye,{size:14}),"Reply"]})}),v===e.id&&d&&t.jsx("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid rgba(255,255,255,0.06)"},children:t.jsxs("form",{onSubmit:i,style:{display:"flex",alignItems:"flex-end",gap:6},children:[t.jsx("textarea",{placeholder:`Reply to ${e.username}...`,value:r||"",onChange:S=>x==null?void 0:x(S.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:12,resize:"none",minHeight:"28px",maxHeight:"100px",overflowY:"auto"},onInput:S=>{const s=S.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,100)}px`},autoFocus:!0}),t.jsx("button",{type:"submit",className:"btn compact",disabled:C||!(r!=null&&r.trim()),style:{padding:"5px 10px",fontSize:11,flexShrink:0},children:C?"...":"Reply"}),c&&t.jsx("button",{type:"button",onClick:c,style:{padding:"5px 10px",fontSize:11,flexShrink:0,background:"transparent",border:"1px solid rgba(255,255,255,0.12)",color:"var(--muted)",borderRadius:6,cursor:"pointer"},children:"Cancel"})]})})]}),_&&t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{ref:j,className:"icon-link",onClick:()=>N(!L),style:{width:"auto",height:"auto",padding:"4px"},title:"More options","aria-label":"More options",children:t.jsx($e,{size:16})}),t.jsx(Pe,{open:L,onClose:()=>N(!1),buttonRef:j,children:t.jsx("button",{className:"menu-item",onClick:$,style:{color:"var(--danger)"},children:"Delete"})})]})]}),l.length>0&&t.jsxs("div",{style:{marginTop:12,marginLeft:16,paddingLeft:16,borderLeft:"1px solid rgba(255,255,255,0.06)"},children:[D&&t.jsxs("button",{onClick:()=>g(!E),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:11,padding:"4px 0",marginBottom:4},children:[E?t.jsx(Re,{size:12}):t.jsx(Je,{size:12}),E?"Hide":"Show"," ",l.length," ",l.length===1?"reply":"replies"]}),(!D||E)&&t.jsx(t.Fragment,{children:l.map(S=>t.jsx(He,{comment:S,replies:(f==null?void 0:f.get(S.id))||[],me:d,onReply:y,onDelete:p,replyingTo:v,replyText:r,onReplyTextChange:x,onReplySubmit:i,posting:C,onCancelReply:c,section:h,repliesMap:f},S.id))})]})]})}const lt=({streamUID:e,playbackUrl:l,aspectRatio:d,onClose:y,headerLeft:p,headerRight:v,children:r,beatmapDownloadUrl:x,beatmapVersion:i,beatmapId:C,onOpenInEditor:c})=>{const h=typeof d=="number"&&isFinite(d)&&d>0?d:1.7777777777777777,f=!!x;return Ke.useEffect(()=>(document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}),[]),t.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:L=>L.stopPropagation(),children:[t.jsx("div",{className:"overlay-backdrop",onClick:y}),t.jsxs("div",{className:"overlay-card",onClick:L=>L.stopPropagation(),children:[t.jsx("button",{className:"overlay-close",onClick:y,"aria-label":"Close",children:t.jsx(Qe,{size:18})}),t.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:f?"500px":"auto",height:"auto",maxHeight:f?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:L=>L.stopPropagation(),children:f?t.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:t.jsx(at,{downloadUrl:x,beatmapVersion:i,beatmapId:C,onOpenInEditor:c})}):t.jsx(Ne,{streamUID:e||void 0,playbackUrl:l||void 0,aspectRatio:h,inOverlay:!0})}),(p||v||r)&&t.jsxs("div",{className:"section-panel",children:[(p||v)&&t.jsxs("div",{className:"row-between",children:[t.jsx("div",{className:"row",style:{alignItems:"center"},children:p}),v?t.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:v}):t.jsx("div",{})]}),r]})]})]})};function ft(){var X,oe,o,H;const{uid:e}=Ze(),[l,d]=et(),y=_e(),v=((X=Le().state)==null?void 0:X.returnTo)||"/mp/feed",[r,x]=a.useState(null),[i,C]=a.useState([]),[c,h]=a.useState(!0),[f,L]=a.useState(null),[N,j]=a.useState(""),[P,E]=a.useState(null),[g,D]=a.useState(!1),[_,$]=a.useState(!1),{notify:S}=he(),s=a.useRef(new Set);a.useEffect(()=>{U(I.auth.me,{requireAuth:!1}).then(u=>L(u)).catch(()=>{})},[]),a.useEffect(()=>{l.get("preview")==="true"&&$(!0)},[l]);const M=async()=>{if(e){h(!0);try{const u=await U(I.videos.get(e),{requireAuth:!1});x(u)}catch{S("Failed to load post",{variant:"error"}),y(v)}finally{h(!1)}}},k=async()=>{if(r!=null&&r.id)try{const u=await U(I.videos.comments(r.id),{requireAuth:!1});C(u.items||[])}catch{}};a.useEffect(()=>{M()},[e]),a.useEffect(()=>{r!=null&&r.id&&k()},[r==null?void 0:r.id]),a.useEffect(()=>{r!=null&&r.id&&(s.current.has(r.id)||(s.current.add(r.id),U(I.videos.view(r.id),{method:"POST"}).then(u=>{if(!u)return;const b=Number(u.views_count??0);x(F=>F?{...F,views_count:b,viewed_by_me:!0}:null)}).catch(()=>{})))},[r==null?void 0:r.id]);const q=u=>{"stream_uid"in u&&x(u)},le=()=>{y(v)},B=async u=>{if(u.preventDefault(),!(!N.trim()||!(r!=null&&r.id))){D(!0);try{await U(I.videos.comments(r.id),{method:"POST",body:JSON.stringify({text:N.trim(),parent_id:P||void 0})}),j(""),E(null),k(),M(),S("Comment posted!",{variant:"success"})}catch(b){S((b==null?void 0:b.message)||"Failed to post comment",{variant:"error"})}finally{D(!1)}}},K=u=>{C(b=>b.filter(F=>F.id!==u))};if(c)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!r)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const J=i.filter(u=>!u.parent_id),V=new Map;return i.filter(u=>u.parent_id).forEach(u=>{const b=u.parent_id;V.has(b)||V.set(b,[]),V.get(b).push(u)}),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[t.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>y(v),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:t.jsx(tt,{size:20})}),t.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:t.jsx(ot,{post:r,section:"mappi",onUpdate:q,onDelete:le,me:f})}),f&&!P&&t.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:t.jsxs("form",{onSubmit:B,style:{display:"flex",alignItems:"flex-end",gap:8},children:[t.jsx("textarea",{placeholder:"Write a comment...",value:N,onChange:u=>j(u.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:u=>{const b=u.target;b.style.height="auto",b.style.height=`${Math.min(b.scrollHeight,120)}px`}}),t.jsx("button",{type:"submit",className:"btn compact",disabled:g||!N.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:g?"...":"Post"})]})}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:J.length===0?t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):t.jsx("div",{className:"col",style:{gap:0},children:J.map(u=>t.jsx(He,{comment:u,replies:V.get(u.id)||[],me:f,section:"mappi",onReply:b=>E(b),onDelete:K,replyingTo:P,replyText:N,onReplyTextChange:j,onReplySubmit:B,posting:g,onCancelReply:()=>{E(null),j("")},repliesMap:V},u.id))})})]}),r&&_&&r.beatmapset_id&&t.jsx(lt,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{$(!1),d({})},beatmapDownloadUrl:`${ge}${I.osu.downloadBeatmapset(r.beatmapset_id)}`,beatmapId:r.beatmap_id??void 0,beatmapVersion:r.beatmap_version??void 0,onOpenInEditor:()=>{$(!1),d({}),window.location.hash="/editor"},headerLeft:t.jsxs(t.Fragment,{children:[((oe=r.uploader)==null?void 0:oe.avatar_url)&&t.jsx("img",{src:r.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),t.jsxs(pe,{to:`/profile/${(o=r.uploader)==null?void 0:o.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[t.jsx("span",{children:(H=r.uploader)==null?void 0:H.username}),r.is_starred?t.jsx(Ce,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{I as A,He as C,ot as P,pt as T,U as a,Ee as b,ge as c,Ne as d,ft as e,it as g,he as u};

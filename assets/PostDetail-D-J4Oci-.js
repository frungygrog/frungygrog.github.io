import{P as U,T as H,i as M,r as s,j as a,U as W,L as V,A as X}from"./vendor-react-DRMPtHf0.js";import{P as J}from"./Post-DWYm5GKv.js";import{C as Y}from"./Comment-DRqcbhzT.js";import{O as q}from"./Overlay-B5uJ0CNY.js";import{u as G}from"./index-DgksKqeh.js";import"./vendor-Dm_EoMJn.js";import"./Popup-CtE3GQHY.js";import"./Player-BRfwXn_C.js";import"./editor-lib-1S8E8MTP.js";import"./beatmap-preview-Cn-wWWdw.js";import"./editor-components-B-NcqUmU.js";const r="https://api.osumappi.ng";function B(l){var d;return(d=document.cookie.split("; ").map(n=>n.split("=")).find(([n])=>n===l))==null?void 0:d[1]}function le(){var F,I,N;const{uid:l}=U(),[d,n]=H(),p=M(),[e,g]=s.useState(null),[w,S]=s.useState([]),[D,P]=s.useState(!0),[x,E]=s.useState(null),[c,u]=s.useState(""),[y,b]=s.useState(null),[v,k]=s.useState(!1),[L,j]=s.useState(!1),{notify:m}=G(),C=s.useRef(new Set);s.useEffect(()=>{fetch(`${r}/api/me`,{credentials:"include"}).then(t=>t.ok?t.json():null).then(t=>E(t)).catch(()=>{})},[]),s.useEffect(()=>{d.get("preview")==="true"&&j(!0)},[d]);const T=async()=>{if(l){P(!0);try{const t=await fetch(`${r}/api/videos/${l}`,{credentials:"include"});if(t.ok){const i=await t.json();g(i)}else m("Failed to load post",{variant:"error"}),p("/mp/feed")}catch{m("Failed to load post",{variant:"error"}),p("/mp/feed")}finally{P(!1)}}},_=async()=>{if(e!=null&&e.id)try{const t=await fetch(`${r}/api/videos/${e.id}/comments`,{credentials:"include"});if(t.ok){const i=await t.json();S(i.items||[])}}catch{}};s.useEffect(()=>{T()},[l]),s.useEffect(()=>{e!=null&&e.id&&_()},[e==null?void 0:e.id]),s.useEffect(()=>{if(!(e!=null&&e.id)||C.current.has(e.id))return;C.current.add(e.id);const t=B("csrf")||"";fetch(`${r}/api/videos/${e.id}/view`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":t}}).then(i=>i.ok?i.json():null).then(i=>{if(!i)return;const o=Number(i.views_count??0);g(h=>h?{...h,views_count:o,viewed_by_me:!0}:null)}).catch(()=>{})},[e==null?void 0:e.id]);const A=t=>{"stream_uid"in t&&g(t)},z=()=>{p("/mp/feed")},R=async t=>{if(t.preventDefault(),!(!c.trim()||!(e!=null&&e.id))){k(!0);try{const i=B("csrf")||"",o=await fetch(`${r}/api/videos/${e.id}/comments`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":i},body:JSON.stringify({text:c.trim(),parent_id:y||void 0})});if(o.ok)u(""),b(null),_(),T(),m("Comment posted!",{variant:"success"});else{const h=await o.json().catch(()=>({}));m(h.error||"Failed to post comment",{variant:"error"})}}catch{m("Failed to post comment",{variant:"error"})}finally{k(!1)}}},O=t=>{S(i=>i.filter(o=>o.id!==t))};if(D)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!e)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const $=w.filter(t=>!t.parent_id),f=new Map;return w.filter(t=>t.parent_id).forEach(t=>{const i=t.parent_id;f.has(i)||f.set(i,[]),f.get(i).push(t)}),a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[a.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[a.jsx("button",{className:"icon-link",onClick:()=>p("/mp/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:a.jsx(W,{size:20})}),a.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:a.jsx(J,{post:e,section:"mappi",onUpdate:A,onDelete:z,me:x})}),x&&!y&&a.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:a.jsxs("form",{onSubmit:R,style:{display:"flex",alignItems:"flex-end",gap:8},children:[a.jsx("textarea",{placeholder:"Write a comment...",value:c,onChange:t=>u(t.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:t=>{const i=t.target;i.style.height="auto",i.style.height=`${Math.min(i.scrollHeight,120)}px`}}),a.jsx("button",{type:"submit",className:"btn compact",disabled:v||!c.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:v?"...":"Post"})]})}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:$.length===0?a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):a.jsx("div",{className:"col",style:{gap:0},children:$.map(t=>a.jsx(Y,{comment:t,replies:f.get(t.id)||[],me:x,section:"mappi",onReply:i=>b(i),onDelete:O,replyingTo:y,replyText:c,onReplyTextChange:u,onReplySubmit:R,posting:v,onCancelReply:()=>{b(null),u("")}},t.id))})})]}),e&&L&&e.beatmapset_id&&a.jsx(q,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{j(!1),n({})},beatmapDownloadUrl:`${r}/api/osu/beatmapsets/${e.beatmapset_id}/download?noVideo=1`,beatmapId:e.beatmap_id??void 0,beatmapVersion:e.beatmap_version??void 0,onOpenInEditor:()=>{j(!1),n({}),window.location.hash="/editor"},headerLeft:a.jsxs(a.Fragment,{children:[((F=e.uploader)==null?void 0:F.avatar_url)&&a.jsx("img",{src:e.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),a.jsxs(V,{to:`/profile/${(I=e.uploader)==null?void 0:I.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[a.jsx("span",{children:(N=e.uploader)==null?void 0:N.username}),e.is_starred?a.jsx(X,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{le as default};

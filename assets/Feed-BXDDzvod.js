import{N as U,g as E,e as L,r as g,j as o}from"./vendor-react-DRMPtHf0.js";import{P}from"./Post-C3eYMGYL.js";import{C as S}from"./Compose-Ah6JNJvd.js";import{a as y,b,A as C,c as D}from"./index-C6vFBVgl.js";import"./vendor-Dm_EoMJn.js";import"./Popup-CtE3GQHY.js";import"./Player-BRfwXn_C.js";import"./editor-lib-1S8E8MTP.js";import"./beatmap-preview-Cn-wWWdw.js";import"./editor-components-B-NcqUmU.js";function Q(){const{data:c}=y(),{tagFilters:d}=b();return U({queryKey:["moddi","feed",d],queryFn:async({pageParam:u=0})=>{const r=new URLSearchParams({limit:"20",offset:String(u)}),n=`${C.moddi.posts}?${r.toString()}`;return await D(n)},enabled:!!c,initialPageParam:0,getNextPageParam:(u,r)=>{var l;const n=r.reduce((p,m)=>{var i;return p+(((i=m.items)==null?void 0:i.length)||0)},0);return(((l=u.items)==null?void 0:l.length)||0)===20?n:void 0}})}function O(){const c=E(),d=L(),{data:u}=y(),{tagFilters:r}=b(),{data:n,fetchNextPage:x,hasNextPage:l,isFetching:p,isFetchingNextPage:m,refetch:i}=Q(),_=g.useMemo(()=>n!=null&&n.pages?n.pages.flatMap(e=>(e.items||[]).map(t=>({...t,user_id:t.user_id??0,username:t.username||"Unknown",avatar_url:t.avatar_url||null,text:t.text??null,uid:t.uid||String(t.id||""),reactions_count:Number(t.reactions_count??0),reacted_by_me:t.reacted_by_me??!1,comments_count:Number(t.comments_count??0)}))):[],[n]),f=g.useMemo(()=>_.filter(e=>{const s=e.tags?typeof e.tags=="string"?e.tags.split(",").map(h=>h.trim()):[]:[],t=!e.tags||s.length===0,a=s.includes("help");return r.untagged&&r.help?!0:r.untagged&&!r.help?t:!r.untagged&&r.help?a:!1}),[_,r]);g.useEffect(()=>{c.pathname==="/md/feed"&&i()},[c.pathname,i]),g.useEffect(()=>{const e=()=>{i()};return window.addEventListener("moddifilterchange",e),()=>window.removeEventListener("moddifilterchange",e)},[i]);const N=e=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(t=>({...t,items:t.items.map(a=>a.id===e.id?e:a)}))})},v=e=>{d.setQueryData(["moddi","feed"],s=>s&&{...s,pages:s.pages.map(t=>({...t,items:t.items.filter(a=>a.id!==e)}))})},j=e=>{e&&d.setQueryData(["moddi","feed"],s=>{if(!s)return s;const t={...e,user_id:e.user_id??0,username:e.username||"Unknown",avatar_url:e.avatar_url||null,text:e.text??null,uid:e.uid||String(e.id||""),reactions_count:Number(e.reactions_count??0),reacted_by_me:e.reacted_by_me??!1,comments_count:Number(e.comments_count??0)};return{...s,pages:s.pages.map((a,h)=>h===0?{...a,items:[t,...a.items||[]]}:a)}}),d.invalidateQueries({queryKey:["moddi","feed"]}),i()},F=p&&!m,M=l??!1;return o.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[o.jsx(S,{section:"moddi",onPost:j}),o.jsx("div",{style:{marginTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:o.jsxs("div",{className:"col",style:{gap:0},children:[f.length===0&&!F&&o.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No posts yet. Be the first to post!"}),f.map(e=>o.jsx(P,{post:e,section:"moddi",onUpdate:N,onDelete:v,me:u},e.id)),f.length>0&&M&&o.jsx("div",{style:{padding:"16px",textAlign:"center",borderTop:"1px solid rgba(255,255,255,0.06)"},children:o.jsx("button",{className:"btn secondary",onClick:()=>x(),disabled:m,children:m?"Loading...":"Load more"})})]})})]})}export{O as default};

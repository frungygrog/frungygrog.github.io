import{r as i,j as t,d as Je,u as $e,e as Re,L as pe,A as Te,F as Pe,f as Ke,g as Qe,h as je,i as ke,k as Ee,l as Me,m as Ze,n as et,R as tt,c as nt,o as it,p as at,q as rt}from"./vendor-react-CJJ8g4j9.js";import{H as W}from"./vendor-hls-B_fsdCYC.js";import{B as st}from"./editor-2rGn0xn5.js";import{P as ot}from"./beatmap-preview-BPnr1eYJ.js";function Ne(){if(typeof window>"u")return!1;try{const e=navigator.userAgentData;if(e&&typeof e.mobile=="boolean"&&e.mobile||window.matchMedia&&(window.matchMedia("(pointer: coarse)").matches||window.matchMedia("(hover: none)").matches))return!0;const o=navigator.userAgent||"";if(/Android|iPhone|iPad|iPod|Mobile|Silk|Kindle|Opera Mini|IEMobile|WPDesktop/i.test(o))return!0}catch{}return!1}function xt(){var h;if(typeof window>"u"||typeof document>"u")return()=>{};const e=()=>{const c=Ne();document.documentElement.classList.toggle("is-mobile",c),document.documentElement.setAttribute("data-mobile",c?"true":"false")};e();const o=["(pointer: coarse)","(hover: none)","(orientation: landscape)","(orientation: portrait)"],d=[];try{for(const c of o)if(window.matchMedia){const u=window.matchMedia(c);(h=u.addEventListener)==null||h.call(u,"change",e),d.push(u)}}catch{}return window.addEventListener("resize",e),()=>{try{d.forEach(c=>{var u;return(u=c.removeEventListener)==null?void 0:u.call(c,"change",e)}),window.removeEventListener("resize",e)}catch{}}}function bt(){if(typeof window>"u")return!1;try{const e=navigator.standalone===!0,o=window.matchMedia&&window.matchMedia("(display-mode: standalone)"),d=!!(o&&o.matches),h=window.matchMedia&&window.matchMedia("(display-mode: minimal-ui)"),c=window.matchMedia&&window.matchMedia("(display-mode: fullscreen)");return e||d||!!(h&&h.matches)||!!(c&&c.matches)}catch{return!1}}const Ae=i.createContext(null);function vt({children:e}){const[o,d]=i.useState([]),h=i.useRef(1),c=i.useRef(new Map),u=m=>{const g=c.current.get(m);g&&(clearTimeout(g),c.current.delete(m))},a=(m,g)=>{u(m);const x=window.setTimeout(()=>v(m),g);c.current.set(m,x)},v=i.useCallback(m=>{u(m),d(g=>g.filter(x=>x.id!==m))},[]),r=i.useCallback((m,g)=>{const x=typeof g=="number"?g:(g==null?void 0:g.durationMs)??5e3,C=typeof g=="number"?"info":(g==null?void 0:g.variant)??"info",M=Ne();let k=null;return d(M?P=>{const _=P[0];if(_&&_.message===m&&_.variant===C){const L={..._,count:_.count+1,duration:x};return k=L.id,[L]}P.forEach(L=>u(L.id));const b=h.current++,D={id:b,message:m,duration:x,variant:C,count:1};return k=b,[D]}:P=>{const _=P.findIndex(L=>L.message===m&&L.variant===C);if(_!==-1){const L=[...P],$={...L[_],count:L[_].count+1};return L[_]=$,k=$.id,L}const b=h.current++,D={id:b,message:m,duration:x,variant:C,count:1};return k=b,[...P,D]}),k!=null&&a(k,x),k??-1},[]),S=i.useMemo(()=>({notify:r,close:v}),[r,v]);return t.jsxs(Ae.Provider,{value:S,children:[e,t.jsx("div",{className:"toasts",children:o.map(m=>t.jsxs("div",{className:`toast ${m.variant}`,children:[t.jsxs("div",{className:"toast-text",children:[m.message,m.count>1&&t.jsxs("span",{style:{marginLeft:6,opacity:.8},children:["×",m.count]})]}),t.jsx("button",{className:"toast-close",onClick:()=>v(m.id),"aria-label":"Close",children:"×"})]},m.id))})]})}function ge(){const e=i.useContext(Ae);if(!e)throw new Error("useToasts must be used within ToastProvider");return e}const xe="https://api.osumappi.ng";function lt(){var e;try{return((e=document.cookie.split("; ").map(o=>o.split("=")).find(([o])=>o==="csrf"))==null?void 0:e[1])||""}catch{return""}}async function U(e,o={}){const{requireAuth:d=!0,skipCsrf:h=!1,...c}=o,u={...c.headers};if(c.body&&!u["Content-Type"]&&(u["Content-Type"]="application/json"),d&&!h){const v=lt();v&&(u["X-CSRF-Token"]=v)}const a=await fetch(`${xe}${e}`,{...c,credentials:"include",headers:u});if(!a.ok){const v=await a.json().catch(()=>({error:`HTTP ${a.status}`}));throw new Error(v.error||`HTTP ${a.status}: ${a.statusText}`)}return a.json()}function _e(e){const o=new URLSearchParams;for(const[h,c]of Object.entries(e))c!=null&&o.append(h,String(c));const d=o.toString();return d?`?${d}`:""}const A={auth:{login:"/api/auth/login",logout:"/api/auth/logout",me:"/api/me"},user:{quota:"/api/me/upload_quota",notifications:"/api/me/notifications",markNotificationsRead:"/api/me/notifications/mark_read",deleteNotification:e=>`/api/me/notifications/${encodeURIComponent(e)}`,pushSubscribe:"/api/me/push/subscribe",pushUnsubscribe:"/api/me/push/unsubscribe",pushList:"/api/me/push/subscriptions",pushTest:"/api/me/push/test",notifPrefs:"/api/me/notification_prefs"},feed:{next:"/api/feed/next",batch:"/api/feed/batch",progress:e=>`/api/feed/progress${e?`?modes=${encodeURIComponent(e)}`:""}`,recent:"/api/videos/recent"},videos:{like:e=>`/api/videos/${e}/like`,view:e=>`/api/videos/${e}/view`,update:e=>`/api/videos/${e}`,delete:e=>`/api/videos/${e}`,flag:e=>`/api/videos/${e}/flag`,comments:e=>`/api/videos/${e}/comments`,get:e=>`/api/videos/${e}`},uploads:{new:"/api/uploads/new"},moddi:{mySubmissions:"/api/moddi/me/submissions",posts:"/api/moddiposts",post:e=>`/api/moddiposts/${e}`,postReact:e=>`/api/moddiposts/${e}/react`,postComments:e=>`/api/moddiposts/${e}/comments`,queues:"/api/moddi/queues",queue:e=>`/api/moddi/queues/${e}`,queueSubmit:e=>`/api/moddi/queues/${e}/submit`,queueAccept:e=>`/api/moddi/queues/${e}/accept`,queueDeny:e=>`/api/moddi/queues/${e}/deny`,queueInvite:e=>`/api/moddi/queues/${e}/invite`,queueMember:(e,o)=>`/api/moddi/queues/${e}/members/${o}`,queueSubmission:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}`,queueSubmissionDelete:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}`,queueBlockUser:e=>`/api/moddi/queues/${e}/block`,queueUnblockUser:(e,o)=>`/api/moddi/queues/${e}/block/${o}`,queueBlockedUsers:e=>`/api/moddi/queues/${e}/blocked`,queueSubmissionAcknowledge:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}/acknowledge`,queueSubmissionUnacknowledge:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}/acknowledge`,usersSearch:e=>`/api/moddi/users/search?q=${encodeURIComponent(e)}`},osu:{resolveBeatmap:"/api/osu/beatmap/resolve",downloadBeatmapset:e=>`/api/osu/beatmapsets/${e}/download?noVideo=1`,usersSearch:e=>`/api/osu/users/search?q=${encodeURIComponent(e)}`},users:{get:e=>`/api/users/${e}`,videos:e=>`/api/users/${e}/videos`,likes:e=>`/api/users/${e}/likes`,myVideos:"/api/me/videos"},admin:{clearViews:"/api/admin/me/clear_views",debugState:"/api/debug/state",settingsModeration:"/api/admin/settings/moderation",videosPending:"/api/admin/videos/pending",videosApprove:e=>`/api/admin/videos/${e}/approve`,videosReject:e=>`/api/admin/videos/${e}/reject`,videosAction:(e,o)=>`/api/admin/videos/${e}/${o}`,analytics:"/api/admin/analytics",usersSearch:e=>`/api/admin/users/search?q=${encodeURIComponent(e)}`,userVideos:e=>`/api/admin/users/${e}/videos`,userUpdate:e=>`/api/admin/users/${e}`,notificationsSystem:"/api/admin/notifications/system",notificationsTest:"/api/admin/notifications/test"}},Le=/(\d{2}:\d{2}:\d{3})(?:\s+\(([\d,]+)\))?/g;function Ce(e,o){return o?`osu://edit/${e}-(${o})`:`osu://edit/${e}`}function he({text:e,className:o,style:d}){Le.lastIndex=0;const h=[];let c=0,u;for(;(u=Le.exec(e))!==null;){u.index>c&&h.push(e.substring(c,u.index));const a=u[1],v=u[2],r=u[0];h.push(t.jsx("a",{href:Ce(a,v),onClick:S=>{S.preventDefault(),window.location.href=Ce(a,v)},style:{color:"var(--primary)",textDecoration:"none",cursor:"pointer"},onMouseEnter:S=>{S.currentTarget.style.textDecoration="underline"},onMouseLeave:S=>{S.currentTarget.style.textDecoration="none"},title:"Open in osu! editor",children:r},u.index)),c=u.index+u[0].length}return c<e.length&&h.push(e.substring(c)),h.length===0?t.jsx("span",{className:o,style:d,children:e}):t.jsx("span",{className:o,style:d,children:h})}const Ie=({open:e,onClose:o,buttonRef:d,children:h,align:c="right",minWidth:u=160})=>{const[a,v]=i.useState(null),r=i.useRef(null);if(i.useEffect(()=>{if(!e||!d.current){v(null);return}const m=()=>{if(!d.current)return;const g=d.current.getBoundingClientRect();v({top:g.bottom+8,[c]:window.innerWidth-g[c==="right"?"right":"left"]})};return m(),window.addEventListener("resize",m),window.addEventListener("scroll",m,!0),()=>{window.removeEventListener("resize",m),window.removeEventListener("scroll",m,!0)}},[e,d,c]),i.useEffect(()=>{if(!e)return;const m=g=>{r.current&&!r.current.contains(g.target)&&d.current&&!d.current.contains(g.target)&&o()};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[e,o,d]),!e||!a)return null;const S=t.jsx("div",{ref:r,style:{position:"fixed",top:a.top,[c]:a[c],background:"var(--panel)",border:"1px solid var(--divider)",borderRadius:10,padding:6,zIndex:1e3,minWidth:u,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:h});return Je.createPortal(S,document.body)},He=({playbackUrl:e,streamUID:o,aspectRatio:d,preferNative:h=!1,autoplay:c=!1,loop:u=!1,muted:a=!1,controls:v=!0,onVideoRef:r,onClick:S,inOverlay:m=!1})=>{const g=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,x=i.useRef(null),[C,M]=i.useState(null),k=i.useMemo(()=>{const s=typeof d=="number"&&isFinite(d)&&d>0?d:null;return s||16/9},[d]),_=`${C??k} / 1`,b=i.useMemo(()=>e||(o?`https://videodelivery.net/${o}/manifest/video.m3u8`:null),[e,o]),D=i.useRef(null);i.useEffect(()=>{b&&(D.current=b)},[b]),i.useEffect(()=>{M(null)},[b]),i.useEffect(()=>{if(!h||!x.current)return;const s=x.current;let H=!1;const E=()=>{if(!H)if(s.videoWidth>0&&s.videoHeight>0){const q=s.videoWidth/s.videoHeight;M(q),H=!0}else M(k),H=!0};return s.addEventListener("loadedmetadata",E),s.readyState>=1&&E(),()=>{s.removeEventListener("loadedmetadata",E)}},[h,k,b]);const L=i.useRef(null),$=i.useRef(null);i.useEffect(()=>{if(!b)return;let s=L.current,H=null,E=!1,q=null;if(s&&$.current&&$.current!==b){console.log(`[HLS] URL changed from ${$.current} to ${b}, using loadSource`);try{s.stopLoad(),s.loadSource(b),$.current=b;const l=x.current;if(l)try{l.pause(),l.currentTime=0,l.load()}catch(N){console.warn("[HLS] Error resetting video element:",N)}}catch(l){console.error("[HLS] Error switching source:",l);try{s.destroy()}catch{}s=null,L.current=null,$.current=null}}if(s&&$.current===b)return console.log(`[HLS] URL unchanged (${b}), reusing existing HLS instance`),()=>{E=!0};const le=()=>{if(document.hidden&&s){const l=x.current;if(l)try{l.pause()}catch{}try{s.stopLoad()}catch{}}},B=()=>{if(E=!0,s){try{s.stopLoad(),s.detachMedia(),s.destroy()}catch{}s=null}};document.addEventListener("visibilitychange",le),window.addEventListener("beforeunload",B);const K=()=>{const l=x.current;if(!l||E)return;try{for(l.pause(),l.currentTime=0,l.src="",l.srcObject=null;l.firstChild;)l.removeChild(l.firstChild);l.load()}catch(p){console.warn("[HLS] Error resetting video element:",p)}const N=performance.now();if(console.log(`[HLS] Starting HLS setup for ${b} at ${N.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:l.readyState,isConnected:l.isConnected,paused:l.paused,currentTime:l.currentTime}),W.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const p={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const y=performance.now();s=new W(p),L.current=s,$.current=b;const z=performance.now()-y;console.log(`[HLS] HLS instance created in ${z.toFixed(2)}ms`);const I=performance.now();s.loadSource(b);const F=performance.now()-I;console.log(`[HLS] loadSource() called in ${F.toFixed(2)}ms`);const O=performance.now();s.attachMedia(l);const Q=performance.now()-O;console.log(`[HLS] attachMedia() completed in ${Q.toFixed(2)}ms`);const T=performance.now()-N;console.log(`[HLS] Total HLS setup time: ${T.toFixed(2)}ms`)}catch(y){const z=performance.now()-N;if(console.error(`[HLS] Failed to initialize HLS after ${z.toFixed(2)}ms:`,y),s){try{s.destroy()}catch{}s=null}return}s.on(W.Events.MANIFEST_PARSED,()=>{const y=performance.now()-N;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${y.toFixed(2)}ms after setup start`),E||!l)return;u&&(q=()=>{if(!(E||!l||!s))try{l.currentTime=0,l.play().catch(I=>{I.name!=="AbortError"&&I.name!=="NotAllowedError"&&console.debug("Loop play failed:",I)})}catch{l.currentTime=0,l.play().catch(()=>{})}},l.addEventListener("ended",q)),(()=>{if(!(E||!l))if(l.readyState>=2){if(c){const I=performance.now();l.play().then(()=>{const F=performance.now()-I;console.log(`[HLS] Autoplay succeeded in ${F.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(F=>{const O=performance.now()-I;F.name!=="AbortError"&&F.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${O.toFixed(2)}ms:`,F)})}}else{const I=()=>{if(!(E||!l)&&(l.removeEventListener("canplay",I),c)){const F=performance.now();l.play().then(()=>{const O=performance.now()-F;console.log(`[HLS] Autoplay succeeded in ${O.toFixed(2)}ms after canplay event`)}).catch(O=>{const Q=performance.now()-F;O.name!=="AbortError"&&O.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${Q.toFixed(2)}ms:`,O)})}};l.addEventListener("canplay",I,{once:!0})}})()}),s.on(W.Events.ERROR,(y,z)=>{if(!E&&z.fatal)switch(z.type){case W.ErrorTypes.NETWORK_ERROR:if(!E&&s)try{s.startLoad()}catch{}break;case W.ErrorTypes.MEDIA_ERROR:if(!E&&s)try{s.recoverMediaError()}catch{}break;default:s&&(s.destroy(),s=null);break}})}else E||console.warn("HLS.js not supported, falling back to native HLS"),l.src=b,l.loop=u,H=()=>{E||console.warn("Native HLS playback failed")},l.addEventListener("error",H),c&&!E&&l.play().catch(p=>{p.name!=="AbortError"&&p.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",p)})};let J=0;const V=10,X=()=>{if(E)return;if(J++,J>V){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const l=x.current;if(!l){requestAnimationFrame(X);return}if(!l.isConnected){requestAnimationFrame(X);return}K()},oe=requestAnimationFrame(()=>{requestAnimationFrame(X)});return()=>{cancelAnimationFrame(oe),E=!0,document.removeEventListener("visibilitychange",le),window.removeEventListener("beforeunload",B);const l=x.current;if(l&&q&&(l.removeEventListener("ended",q),q=null),s){try{s.stopLoad(),s.off(W.Events.MANIFEST_PARSED),s.off(W.Events.ERROR),s.off(W.Events.MEDIA_ATTACHED),s.off(W.Events.MEDIA_DETACHED),s.off(W.Events.MANIFEST_LOADED),s.off(W.Events.MEDIA_ATTACHING),s.off(W.Events.MEDIA_DETACHING),s.off(W.Events.DESTROYING),s.destroy()}catch{try{s&&s.detachMedia()}catch{}}s=null,L.current=null,$.current=null}if(l){H&&(l.removeEventListener("error",H),H=null);try{l.pause()}catch{}}}},[b,c]),i.useEffect(()=>(r&&x.current&&r(x.current),()=>{r&&r(null)}),[r,h,b]);const j=g||!m?{width:"auto",maxWidth:"100%",height:"100%",maxHeight:"100%",aspectRatio:_,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"100%",maxWidth:"100%",maxHeight:"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",aspectRatio:_,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"};return b?t.jsx("div",{style:j,children:t.jsx("video",{ref:x,autoPlay:c,loop:!1,muted:a,controls:v,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:S?"pointer":"default"},children:"Your browser does not support the video tag."})}):t.jsx("div",{style:j,children:"No video available"})};function dt({beatmapMeta:e,beatmapVersion:o}){const d=i.useRef(null),h=i.useRef(null),[c,u]=i.useState(!1),[a,v]=i.useState(!1),[r,S]=i.useState(0);i.useEffect(()=>{if(d.current&&h.current){const x=d.current.offsetWidth,C=h.current.scrollWidth;S(C),v(C>x)}},[e,o]);const m=e?t.jsxs(t.Fragment,{children:[e.artist," – ",e.title,e.mapper?` (by ${e.mapper})`:"",o?` [${o}]`:""]}):o?`[${o}]`:"Beatmap",g=r>0?Math.max(3,r/50):3;return t.jsxs(t.Fragment,{children:[t.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),t.jsxs("div",{ref:d,className:"muted one-line",style:{fontSize:12,color:"var(--muted)",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:a?"pointer":"default"},onMouseEnter:()=>a&&u(!0),onMouseLeave:()=>u(!1),children:[t.jsx("span",{ref:h,style:{display:"inline-block",animation:c&&a?`beatmap-marquee ${g}s linear infinite`:"none"},children:m}),c&&a&&t.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:m})]})]})}function ct(e){return"post_type"in e?e.post_type==="mappi":!!e.stream_uid}function ut({post:e,section:o,onUpdate:d,onDelete:h,me:c}){const u=$e(),a=Re(),v=o==="mappi"?a.pathname.startsWith("/mp/feed/"):a.pathname.startsWith("/md/feed/"),r=ct(e);e.id;const S=r?e.stream_uid||String(e.id||""):e.uid||String(e.id||""),m=S&&S!=="null"&&S!=="undefined"?o==="mappi"?`/mp/feed/${S}`:`/md/feed/${S}`:o==="mappi"?`/mp/feed/${e.id}`:`/md/feed/${e.id}`,[g,x]=i.useState(!1),[C,M]=i.useState(!1),[k,P]=i.useState(!1),[_,b]=i.useState(!1),[D,L]=i.useState(!1),$=i.useRef(null),j=i.useRef(null),s=i.useRef(null),[H,E]=i.useState(null),[q,le]=i.useState(null),{notify:B}=ge(),[K,J]=i.useState(r?e.liked_by_me:void 0),[V,X]=i.useState(r?e.likes_count:0),[oe,l]=i.useState(r?void 0:e.reacted_by_me),[N,p]=i.useState(r?0:e.reactions_count);i.useEffect(()=>{if(r){const n=e;J(n.liked_by_me),X(n.likes_count)}else{const n=e;l(!!n.reacted_by_me),p(n.reactions_count)}},[e,r]);const[y,z]=i.useState(!1),[I,F]=i.useState(r?"":e.text??""),[O,Q]=i.useState(e.beatmap_url||""),[T,Z]=i.useState(null),[ee,Y]=i.useState(null),[be,te]=i.useState(""),ue=i.useRef(0),ve=c&&((r?e.uploader&&c.id===e.uploader.id:c.id===e.user_id)||c.is_admin||c.is_mod),ye=(()=>{const n=e.created_at;if(!n)return"";const f=Math.floor(Date.now()/1e3)-n;return f<60?"just now":f<3600?`${Math.floor(f/60)}m`:f<86400?`${Math.floor(f/3600)}h`:f<604800?`${Math.floor(f/86400)}d`:new Date(n*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();i.useEffect(()=>{if(!y&&!r){const n=e;F(n.text??""),Q(n.beatmap_url||""),Z(null),Y(null),te("")}},[e,y,r]),i.useEffect(()=>{if(!y||r)return;ue.current&&window.clearTimeout(ue.current);const n=(O||"").trim();if(!n){te(""),Z(null),Y(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(n)){te(""),Z(null),Y(null);return}return ue.current=window.setTimeout(async()=>{var w;try{let R;try{R=new URL(n)}catch{te("Invalid URL format");return}const ne=R.hash.match(/#osu\/(\d+)/),ie=ne?ne[1]:null;R.hash="";const se={url:R.toString()};ie&&(se.beatmap_id=ie);const G=await U(A.osu.resolveBeatmap+_e(se),{requireAuth:!1}),ce=Array.isArray(G==null?void 0:G.diffs)?G.diffs:[];if(!ce.length&&!G.setId){te("No difficulties found"),Z(null),Y(null);return}if(Z({setId:Number(G.setId)||0,beatmapId:G.beatmapId??null,title:String(G.title||""),artist:String(G.artist||""),mapper:String(G.mapper||""),diffs:ce}),ce.length>0){const Xe=Number.isFinite(Number(G.beatmapId))?Number(G.beatmapId):Number((w=ce[0])==null?void 0:w.id),ae=ce.find(Ye=>Number(Ye.id)===Xe)||ce[0];Y({beatmapId:Number(ae==null?void 0:ae.id)||null,version:String((ae==null?void 0:ae.version)||""),mode:String((ae==null?void 0:ae.mode)||"standard")})}else Y(null);te("")}catch(R){te(`Failed to resolve: ${(R==null?void 0:R.message)||"Unknown error"}`),Z(null),Y(null)}},400),()=>{ue.current&&window.clearTimeout(ue.current)}},[O,y,r]),i.useEffect(()=>{if(r||!e.beatmap_url||q)return;const n=e;let f=!1;return(async()=>{try{let w;try{w=new URL(n.beatmap_url)}catch{return}const R=w.hash.match(/#osu\/(\d+)/),ne=R?R[1]:null;w.hash="";const re={url:w.toString()};if(ne?re.beatmap_id=ne:n.beatmap_id&&(re.beatmap_id=String(n.beatmap_id)),!f){const se=await U(A.osu.resolveBeatmap+_e(re),{requireAuth:!1});(se.title||se.artist)&&le({title:se.title||null,artist:se.artist||null,mapper:se.mapper||null})}}catch{}})(),()=>{f=!0}},[e,r,q]);const Fe=async()=>{if(g||!r)return;x(!0);const n=K??!1,f=V,w=!n,R=w?V+1:Math.max(0,V-1);J(w),X(R);try{const ne=n?"DELETE":"POST",ie=await U(A.videos.like(e.id),{method:ne}),re={...e,liked_by_me:w,likes_count:ie.likes_count||R};J(w),X(ie.likes_count??R),d&&d(re)}catch{J(n),X(f),B("Failed to like",{variant:"error"})}finally{x(!1)}},De=async()=>{if(C||r)return;M(!0);const n=oe??!1,f=N,w=!n,R=w?N+1:Math.max(0,N-1);l(w),p(R);try{const ne=n?"DELETE":"POST",ie=await U(A.moddi.postReact(e.id),{method:ne}),re={...e,reacted_by_me:w,reactions_count:ie.reactions_count||R};l(w),p(ie.reactions_count??R),d&&d(re)}catch{l(n),p(f),B("Failed to react",{variant:"error"})}finally{M(!1)}},we=async()=>{if(confirm(r?"Permanently delete this video?":"Permanently delete this post?")){try{const n=r?A.videos.delete(e.id):A.moddi.post(String(e.id));await U(n,{method:"DELETE"}),B(r?"Video deleted":"Post deleted",{variant:"warn"}),h&&h(e.id)}catch(n){B((n==null?void 0:n.message)||(r?"Failed to delete video":"Failed to delete post"),{variant:"error"})}b(!1)}},qe=async()=>{if(r){try{const n=!e.is_starred,f=n?"star":"unstar";await U(A.admin.videosAction(e.id,f),{method:"POST"});const w={...e,is_starred:n};d&&d(w),B(n?"Post starred":"Star removed",{variant:"success"})}catch{B("Action failed",{variant:"error"})}b(!1)}},Be=()=>{r||(z(!0),F(e.text??""),Q(e.beatmap_url||""),Z(null),Y(null),te(""),b(!1))},Oe=async()=>{if(!r)try{await U(A.moddi.post(String(e.id)),{method:"PATCH",body:JSON.stringify({text:I.trim(),beatmap_url:O.trim()||null,beatmapset_id:(T==null?void 0:T.setId)??void 0,beatmap_id:(ee==null?void 0:ee.beatmapId)??(T==null?void 0:T.beatmapId)??void 0,beatmap_version:(ee==null?void 0:ee.version)??void 0})});const n=await U(A.moddi.post(String(e.id)),{method:"GET",requireAuth:!1});d&&n.post&&d({...e,...n.post}),B("Post updated",{variant:"success"}),z(!1)}catch(n){B((n==null?void 0:n.message)||"Failed to update post",{variant:"error"})}},We=()=>{z(!1);const n=e;F(n.text??""),Q(n.beatmap_url||""),Z(null),Y(null),te("")};i.useEffect(()=>{if(!k||!j.current){E(null);return}const n=()=>{if(j.current){const f=j.current.getBoundingClientRect();E({top:f.bottom+8,right:window.innerWidth-f.right})}};return n(),window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),()=>{window.removeEventListener("resize",n),window.removeEventListener("scroll",n,!0)}},[k]),i.useEffect(()=>{if(!k)return;const n=f=>{$.current&&!$.current.contains(f.target)&&j.current&&!j.current.contains(f.target)&&P(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[k]);const Ue=n=>{const f=n.target;if(f.closest("button")||f.closest(".menu-panel")||f.closest("input")||f.closest("textarea")||f.closest("select"))return;const w=f.closest("a");w&&w.getAttribute("href")!==`#${m}`||u(m)},de=r?e.uploader||{id:0,username:"Unknown",avatar_url:null}:{id:e.user_id||0,username:e.username||"Unknown",avatar_url:e.avatar_url||null},me=!r&&(oe??(e.reacted_by_me===!0||e.reacted_by_me===1)),Se=!r&&e.tags&&(typeof e.tags=="string"?e.tags.split(",").map(n=>n.trim()):[]).includes("help"),fe=e.beatmapset_id,Ve=e.beatmap_id,Ge=e.beatmap_version;return t.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.01)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.025)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.01)",onClick:Ue,children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[de.avatar_url?t.jsx(pe,{to:`/profile/${de.id}`,onClick:n=>n.stopPropagation(),style:{flexShrink:0},children:t.jsx("img",{src:de.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:de.username})}):t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),t.jsx(pe,{to:m,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:n=>{const f=n.target,w=f.closest("a");if(w&&w!==n.currentTarget){n.preventDefault(),n.stopPropagation();return}if(f.closest("button")||f.closest(".menu-panel")||f.closest("input")||f.closest("textarea")||f.closest("select")){n.preventDefault(),n.stopPropagation();return}n.stopPropagation()},children:t.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(pe,{to:`/profile/${de.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:n=>n.stopPropagation(),onMouseEnter:n=>n.currentTarget.style.color="#7dd3fc",onMouseLeave:n=>n.currentTarget.style.color="inherit",children:de.username}),r&&e.is_starred&&t.jsx(Te,{size:14,color:"#f59e0b",title:"Starred"}),r&&e.mode&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:e.mode}),!r&&Se&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[ye&&t.jsx("span",{className:"muted",style:{fontSize:13},children:ye}),ve&&t.jsx("button",{ref:s,onClick:n=>{n.preventDefault(),n.stopPropagation(),b(f=>!f)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:n=>n.currentTarget.style.backgroundColor="var(--hover-overlay)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:t.jsx(Pe,{size:16})})]})]}),r&&v&&e.playback_url&&t.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"var(--panel-dark)"},children:t.jsx(He,{playbackUrl:e.playback_url,streamUID:e.stream_uid,aspectRatio:e.width&&e.height?e.width/e.height:null})}),r&&!v&&e.poster_url&&t.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"var(--panel-dark)",aspectRatio:e.width&&e.height?`${e.width} / ${e.height}`:"16 / 9",position:"relative"},children:[t.jsx("img",{src:e.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),e.duration_sec&&t.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(e.duration_sec/60),":",(e.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!r&&y?t.jsx("div",{style:{marginBottom:12},children:t.jsxs("div",{className:"col",style:{gap:8},children:[t.jsx("textarea",{value:I,onChange:n=>F(n.target.value),maxLength:200,rows:2,style:{background:"var(--panel-dark)",border:"1px solid var(--border)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),T?t.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[t.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[t.jsxs("strong",{style:{marginRight:4},children:[T.artist," – ",T.title]}),t.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",T.mapper]})]}),T.diffs.length>0&&t.jsx("select",{value:(ee==null?void 0:ee.beatmapId)??(T==null?void 0:T.beatmapId)??void 0,onChange:n=>{const f=Number(n.target.value),w=(T==null?void 0:T.diffs.find(R=>Number(R.id)===f))||null;w&&Y({beatmapId:f,version:w.version,mode:String(w.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",fontSize:12},children:T.diffs.map(n=>t.jsxs("option",{value:n.id,children:[n.version," (",n.mode,")"]},n.id))}),t.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{Z(null),Y(null),Q("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):t.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:O,onChange:n=>Q(n.target.value),style:{fontSize:13,padding:"6px 8px",background:"var(--panel-dark)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:6}}),be&&t.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:be}),t.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[t.jsx("button",{className:"btn secondary",onClick:We,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),t.jsx("button",{className:"btn",onClick:Oe,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):t.jsxs(t.Fragment,{children:[(()=>{if(r){const n=e.description??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"var(--text)"},children:t.jsx(he,{text:n})}):null}else{const n=e.text??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"var(--text)"},children:t.jsx(he,{text:n})}):null}})(),r&&e.beatmap_title&&t.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"var(--muted)",lineHeight:1.4},children:[e.beatmap_artist," – ",e.beatmap_title," ",e.beatmap_mapper?`(by ${e.beatmap_mapper})`:""," ",e.beatmap_version?`[${e.beatmap_version}]`:""]}),!y&&t.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[r&&e.beatmap_url&&!e.beatmap_title&&t.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!r&&e.beatmap_url&&(q||e.beatmapset_id||e.beatmap_id)&&t.jsx(dt,{beatmapMeta:q,beatmapVersion:e.beatmap_version}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[r&&t.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Ke,{size:12}),t.jsx("span",{children:e.views_count??0})]}),t.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Qe,{size:12}),t.jsx("span",{children:e.comments_count??0})]}),r?t.jsxs("button",{className:`chip-btn like ${K?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),Fe()},disabled:g,"aria-label":K?"Unlike":"Like",title:K?"Unlike":"Like",children:[K?t.jsx(je,{size:16}):t.jsx(ke,{size:16}),t.jsx("span",{children:V})]}):t.jsxs("button",{className:`chip-btn like ${me?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),De()},disabled:C,"aria-label":me?"Remove reaction":"React",title:me?"Remove reaction":"React",children:[Se?t.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):me?t.jsx(je,{size:16}):t.jsx(ke,{size:16}),t.jsx("span",{children:N})]}),e.beatmap_url&&t.jsxs("button",{ref:j,className:"chip-btn link",onClick:n=>{n.preventDefault(),n.stopPropagation(),P(f=>!f)},title:"Beatmap options","aria-label":"Beatmap options",children:[t.jsx(Ee,{size:16}),t.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),t.jsx(Me,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),k&&H&&e.beatmap_url&&t.jsxs("div",{ref:$,style:{position:"fixed",top:H.top,right:H.right,background:"var(--panel)",border:"1px solid var(--divider)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsxs("a",{className:"menu-item",href:e.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>P(!1),children:[t.jsx(Ee,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),fe&&t.jsx("button",{className:"menu-item",onClick:()=>{L(!0),P(!1)},children:"Preview"})]}),D&&fe&&t.jsx(st,{open:D,onClose:()=>L(!1),downloadUrl:`${xe}${A.osu.downloadBeatmapset(fe)}`,beatmapId:Ve??void 0,beatmapVersion:Ge??void 0}),ve&&t.jsx(Ie,{open:_,onClose:()=>b(!1),buttonRef:s,minWidth:160,children:r?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),qe()},children:e.is_starred?"Unstar post":"Star post"}),t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),we()},children:"Delete video"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:Be,children:"Edit post"}),t.jsx("button",{className:"menu-item",onClick:we,children:"Delete post"})]})})]})}function ze({comment:e,replies:o,me:d,onReply:h,onDelete:c,replyingTo:u,replyText:a,onReplyTextChange:v,onReplySubmit:r,posting:S,onCancelReply:m,section:g,repliesMap:x}){const[C,M]=i.useState(!1),k=i.useRef(null),{notify:P}=ge(),[_,b]=i.useState(!1),D=e.parent_id!==null,L=d&&(d.id===e.user_id||d.is_admin||d.is_mod),$=async()=>{if(confirm("Delete this comment?"))try{const j=g==="mappi"?A.videos.comments(e.post_id)+`/${e.id}`:A.moddi.postComments(e.post_id)+`/${e.id}`;await U(j,{method:"DELETE"}),c(e.id),P("Comment deleted",{variant:"success"})}catch{P("Failed to delete comment",{variant:"error"})}finally{M(!1)}};return t.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--border-subtle)",background:"var(--hover-overlay)",transition:"background-color 0.15s ease"},onMouseEnter:j=>j.currentTarget.style.backgroundColor="var(--hover-overlay-strong)",onMouseLeave:j=>j.currentTarget.style.backgroundColor="var(--hover-overlay)",children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[t.jsx("span",{style:{fontSize:13,fontWeight:500},children:e.username}),t.jsx("span",{className:"muted",style:{fontSize:11},children:new Date(e.created_at*1e3).toLocaleDateString()})]}),t.jsx("div",{style:{fontSize:14,lineHeight:1.5,wordBreak:"break-word"},children:t.jsx(he,{text:e.text})}),t.jsx("div",{style:{display:"flex",alignItems:"center",gap:12,marginTop:8},children:t.jsxs("button",{onClick:()=>h(e.id),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:12,padding:0},children:[t.jsx(Ze,{size:14}),"Reply"]})}),u===e.id&&d&&t.jsx("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border-subtle)"},children:t.jsxs("form",{onSubmit:r,style:{display:"flex",alignItems:"flex-end",gap:6},children:[t.jsx("textarea",{placeholder:`Reply to ${e.username}...`,value:a||"",onChange:j=>v==null?void 0:v(j.target.value),rows:1,style:{flex:1,background:"var(--panel-dark)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:12,resize:"none",minHeight:"28px",maxHeight:"100px",overflowY:"auto"},onInput:j=>{const s=j.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,100)}px`},autoFocus:!0}),t.jsx("button",{type:"submit",className:"btn compact",disabled:S||!(a!=null&&a.trim()),style:{padding:"5px 10px",fontSize:11,flexShrink:0},children:S?"...":"Reply"}),m&&t.jsx("button",{type:"button",onClick:m,style:{padding:"5px 10px",fontSize:11,flexShrink:0,background:"transparent",border:"1px solid var(--border)",color:"var(--muted)",borderRadius:6,cursor:"pointer"},children:"Cancel"})]})})]}),L&&t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{ref:k,className:"icon-link",onClick:()=>M(!C),style:{width:"auto",height:"auto",padding:"4px"},title:"More options","aria-label":"More options",children:t.jsx(Pe,{size:16})}),t.jsx(Ie,{open:C,onClose:()=>M(!1),buttonRef:k,children:t.jsx("button",{className:"menu-item",onClick:$,style:{color:"var(--danger)"},children:"Delete"})})]})]}),o.length>0&&t.jsxs("div",{style:{marginTop:12,marginLeft:16,paddingLeft:16,borderLeft:"1px solid var(--border-subtle)"},children:[D&&t.jsxs("button",{onClick:()=>b(!_),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:11,padding:"4px 0",marginBottom:4},children:[_?t.jsx(Me,{size:12}):t.jsx(et,{size:12}),_?"Hide":"Show"," ",o.length," ",o.length===1?"reply":"replies"]}),(!D||_)&&t.jsx(t.Fragment,{children:o.map(j=>t.jsx(ze,{comment:j,replies:(x==null?void 0:x.get(j.id))||[],me:d,onReply:h,onDelete:c,replyingTo:u,replyText:a,onReplyTextChange:v,onReplySubmit:r,posting:S,onCancelReply:m,section:g,repliesMap:x},j.id))})]})]})}const mt=({streamUID:e,playbackUrl:o,aspectRatio:d,onClose:h,headerLeft:c,headerRight:u,children:a,beatmapDownloadUrl:v,beatmapVersion:r,beatmapId:S,onOpenInEditor:m})=>{const g=typeof d=="number"&&isFinite(d)&&d>0?d:1.7777777777777777,x=!!v;return tt.useEffect(()=>(document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}),[]),t.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:C=>C.stopPropagation(),children:[t.jsx("div",{className:"overlay-backdrop",onClick:h}),t.jsxs("div",{className:"overlay-card",onClick:C=>C.stopPropagation(),children:[t.jsx("button",{className:"overlay-close",onClick:h,"aria-label":"Close",children:t.jsx(nt,{size:18})}),t.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:x?0:"auto",maxHeight:x?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:C=>C.stopPropagation(),children:x?t.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"auto",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:t.jsx(ot,{downloadUrl:v,beatmapVersion:r,beatmapId:S,onOpenInEditor:m})}):t.jsx(He,{streamUID:e||void 0,playbackUrl:o||void 0,aspectRatio:g,inOverlay:!0})}),(c||u||a)&&t.jsxs("div",{className:"section-panel",children:[(c||u)&&t.jsxs("div",{className:"row-between",children:[t.jsx("div",{className:"row",style:{alignItems:"center"},children:c}),u?t.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:u}):t.jsx("div",{})]}),a]})]})]})};function yt(){var X,oe,l,N;const{uid:e}=it(),[o,d]=at(),h=$e(),u=((X=Re().state)==null?void 0:X.returnTo)||"/mp/feed",[a,v]=i.useState(null),[r,S]=i.useState([]),[m,g]=i.useState(!0),[x,C]=i.useState(null),[M,k]=i.useState(""),[P,_]=i.useState(null),[b,D]=i.useState(!1),[L,$]=i.useState(!1),{notify:j}=ge(),s=i.useRef(new Set);i.useEffect(()=>{U(A.auth.me,{requireAuth:!1}).then(p=>C(p)).catch(()=>{})},[]),i.useEffect(()=>{o.get("preview")==="true"&&$(!0)},[o]);const H=async()=>{if(e){g(!0);try{const p=await U(A.videos.get(e),{requireAuth:!1});v(p)}catch{j("Failed to load post",{variant:"error"}),h(u)}finally{g(!1)}}},E=async()=>{if(a!=null&&a.id)try{const p=await U(A.videos.comments(a.id),{requireAuth:!1});S(p.items||[])}catch{}};i.useEffect(()=>{H()},[e]),i.useEffect(()=>{a!=null&&a.id&&E()},[a==null?void 0:a.id]),i.useEffect(()=>{a!=null&&a.id&&(s.current.has(a.id)||(s.current.add(a.id),U(A.videos.view(a.id),{method:"POST"}).then(p=>{if(!p)return;const y=Number(p.views_count??0);v(z=>z?{...z,views_count:y,viewed_by_me:!0}:null)}).catch(()=>{})))},[a==null?void 0:a.id]);const q=p=>{"stream_uid"in p&&v(p)},le=()=>{h(u)},B=async p=>{if(p.preventDefault(),!(!M.trim()||!(a!=null&&a.id))){D(!0);try{await U(A.videos.comments(a.id),{method:"POST",body:JSON.stringify({text:M.trim(),parent_id:P||void 0})}),k(""),_(null),E(),H(),j("Comment posted!",{variant:"success"})}catch(y){j((y==null?void 0:y.message)||"Failed to post comment",{variant:"error"})}finally{D(!1)}}},K=p=>{S(y=>y.filter(z=>z.id!==p))};if(m)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!a)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const J=r.filter(p=>!p.parent_id),V=new Map;return r.filter(p=>p.parent_id).forEach(p=>{const y=p.parent_id;V.has(y)||V.set(y,[]),V.get(y).push(p)}),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[t.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>h(u),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:t.jsx(rt,{size:20})}),t.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:t.jsx(ut,{post:a,section:"mappi",onUpdate:q,onDelete:le,me:x})}),x&&!P&&t.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:t.jsxs("form",{onSubmit:B,style:{display:"flex",alignItems:"flex-end",gap:8},children:[t.jsx("textarea",{placeholder:"Write a comment...",value:M,onChange:p=>k(p.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:p=>{const y=p.target;y.style.height="auto",y.style.height=`${Math.min(y.scrollHeight,120)}px`}}),t.jsx("button",{type:"submit",className:"btn compact",disabled:b||!M.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:b?"...":"Post"})]})}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:J.length===0?t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):t.jsx("div",{className:"col",style:{gap:0},children:J.map(p=>t.jsx(ze,{comment:p,replies:V.get(p.id)||[],me:x,section:"mappi",onReply:y=>_(y),onDelete:K,replyingTo:P,replyText:M,onReplyTextChange:k,onReplySubmit:B,posting:b,onCancelReply:()=>{_(null),k("")},repliesMap:V},p.id))})})]}),a&&L&&a.beatmapset_id&&t.jsx(mt,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{$(!1),d({})},beatmapDownloadUrl:`${xe}${A.osu.downloadBeatmapset(a.beatmapset_id)}`,beatmapId:a.beatmap_id??void 0,beatmapVersion:a.beatmap_version??void 0,onOpenInEditor:()=>{$(!1),d({}),window.location.hash="/editor"},headerLeft:t.jsxs(t.Fragment,{children:[((oe=a.uploader)==null?void 0:oe.avatar_url)&&t.jsx("img",{src:a.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),t.jsxs(pe,{to:`/profile/${(l=a.uploader)==null?void 0:l.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[t.jsx("span",{children:(N=a.uploader)==null?void 0:N.username}),a.is_starred?t.jsx(Te,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{A,ze as C,he as O,ut as P,vt as T,U as a,_e as b,xe as c,bt as d,xt as e,yt as f,lt as g,He as h,Ne as i,ge as u};

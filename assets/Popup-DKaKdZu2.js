var K=Object.defineProperty;var D=(o,t,e)=>t in o?K(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var R=(o,t,e)=>D(o,typeof t!="symbol"?t+"":t,e);import{r as g,j as I,Z as X}from"./vendor-react-_vsaDC62.js";import{H as A}from"./vendor-DBgzFpze.js";const Y="video-cache",Z=1,M="segments",x="manifests",G=7*24*60*60*1e3,F=500*1024*1024;let P=null,z=null;function T(){return P?Promise.resolve(P):z||(z=new Promise((o,t)=>{const e=indexedDB.open(Y,Z);e.onerror=()=>t(e.error),e.onsuccess=()=>{P=e.result,o(P)},e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(M)||r.createObjectStore(M,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),r.objectStoreNames.contains(x)||r.createObjectStore(x,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),z)}async function J(o,t=!1){try{const e=await T(),a=t?x:M,c=e.transaction([a],"readonly").objectStore(a).get(o);return new Promise(u=>{c.onsuccess=()=>{const n=c.result;if(!n){u(null);return}if(Date.now()-n.timestamp>G){V(o,t).catch(()=>{}),u(null);return}u(n.data)},c.onerror=()=>u(null)})}catch(e){return console.warn("Cache read error:",e),null}}async function W(o,t,e=!1){try{const a=await T(),r=e?x:M,c=a.transaction([r],"readwrite").objectStore(r),u={url:o,data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((n,d)=>{const s=c.put(u);s.onsuccess=()=>n(),s.onerror=()=>d(s.error)}),await U()}catch(a){console.warn("Cache write error:",a)}}async function V(o,t=!1){try{const e=await T(),a=t?x:M,i=e.transaction([a],"readwrite").objectStore(a);await new Promise((c,u)=>{const n=i.delete(o);n.onsuccess=()=>c(),n.onerror=()=>u(n.error)})}catch(e){console.warn("Cache delete error:",e)}}async function Q(){try{const o=await T();let t=0;for(const e of[M,x]){const i=o.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{i.onsuccess=()=>{const u=i.result;t+=u.reduce((n,d)=>n+d.size,0),c()},i.onerror=()=>c()})}return t}catch(o){return console.warn("Cache size calculation error:",o),0}}async function U(){try{const o=await Q();if(o<=F)return;const t=await T(),e=[];for(const r of[M,x]){const i=r===x,n=t.transaction([r],"readonly").objectStore(r).getAll();await new Promise(d=>{n.onsuccess=()=>{const s=n.result;e.push(...s.map(m=>({url:m.url,timestamp:m.timestamp,size:m.size,isManifest:i}))),d()},n.onerror=()=>d()})}e.sort((r,i)=>r.timestamp-i.timestamp);let a=o;for(const r of e){if(a<=F*.8)break;await V(r.url,r.isManifest),a-=r.size}}catch(o){console.warn("Cache cleanup error:",o)}}function ee(o){return o.includes(".m3u8")||o.endsWith("/manifest")}class te{constructor(t){R(this,"context",null);R(this,"stats");R(this,"defaultLoader",null);R(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,a){this.context=t;const r=t.url,i=ee(r);J(r,i).then(c=>{if(c){let n;i?n=new TextDecoder().decode(c):n=c;const d=performance.now();this.stats.loading.start=d,this.stats.loading.first=d,this.stats.loading.end=d,this.stats.loaded=c.byteLength,this.stats.total=c.byteLength,this.stats.aborted=!1;const s={data:n,url:r,code:200},m=i?"manifest":"segment",S=(c.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${m}: ${r.substring(r.lastIndexOf("/")+1)} (${S} KB)`),a.onSuccess(s,this.stats,t,{});return}console.log(`[Video Cache] âŒ Cache MISS - ${i?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(r,i,t,e,a)}).catch(c=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${i?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - falling back to network`,c),this.fetchFromNetwork(r,i,t,e,a)})}async fetchFromNetwork(t,e,a,r,i){var u;const c=performance.now();try{const n=this.abortController||new AbortController,d=await fetch(t,{method:a.method||"GET",headers:a.headers||{},signal:n.signal}).catch(v=>{throw v.name==="AbortError",v});if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);let s;const m=d.headers.get("content-type")||"";e||m.includes("application/vnd.apple.mpegurl")||m.includes("text")?s=await d.text():s=await d.arrayBuffer();const S=performance.now(),E=typeof s=="string"?new TextEncoder().encode(s).length:s.byteLength;this.stats.loading.start=c,this.stats.loading.first=c,this.stats.loading.end=S,this.stats.loaded=E,this.stats.total=E,this.stats.aborted=!1;const k=e?"manifest":"segment";if(s instanceof ArrayBuffer){await W(t,s,e);const v=(s.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${k}: ${t.substring(t.lastIndexOf("/")+1)} (${v} KB)`)}else{const $=new TextEncoder().encode(s);await W(t,$.buffer,e);const N=($.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${k}: ${t.substring(t.lastIndexOf("/")+1)} (${N} KB)`)}const H={data:s,url:d.url,code:d.status};i.onSuccess(H,this.stats,a,{})}catch(n){const d=performance.now();if(this.stats.loading.start=c,this.stats.loading.first=c,this.stats.loading.end=d,this.stats.loaded=0,this.stats.total=0,n instanceof Error&&n.name==="AbortError")this.stats.aborted=!0,(u=i.onAbort)==null||u.call(i,this.stats,a,{});else if(!(n instanceof Error&&n.name==="AbortError")){this.stats.aborted=!1;const s=n instanceof Error?n:new Error("Network error");i.onError({code:0,text:s.message},a,{},this.stats)}}}abort(){this.abortController&&this.abortController.abort()}destroy(){this.context=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}},this.abortController&&(this.abortController.abort(),this.abortController=null)}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const se=({playbackUrl:o,streamUID:t,aspectRatio:e,preferNative:a=!1,autoplay:r=!1,loop:i=!1,muted:c=!1,controls:u=!0,onVideoRef:n,onClick:d})=>{const[s,m]=g.useState(1.7777777777777777),S=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;g.useEffect(()=>{if(!S)return;const l=()=>m(window.innerWidth/Math.max(1,window.innerHeight));return l(),window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[S]);const E=g.useRef(null),[k,H]=g.useState(null),v=g.useMemo(()=>{const l=1.3333333333333333,b=16/9,f=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(f)return Math.min(b,Math.max(l,f));const y=S?s:16/9;return Math.min(b,Math.max(l,y))},[S,s,e]),N=`${k??v} / 1`,p=g.useMemo(()=>o||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[o,t]);g.useEffect(()=>{H(null)},[p]),g.useEffect(()=>{if(!a||!E.current)return;const l=E.current;let b=!1;const f=()=>{if(!b)if(l.videoWidth>0&&l.videoHeight>0){const y=l.videoWidth/l.videoHeight,q=4/3,j=16/9,h=Math.min(j,Math.max(q,y));H(h),b=!0}else H(v),b=!0};return l.addEventListener("loadedmetadata",f),l.readyState>=1&&f(),()=>{l.removeEventListener("loadedmetadata",f)}},[a,v,p]),g.useEffect(()=>{if(!p)return;let l=null,b=null,f=!1,y=null;const j=setTimeout(()=>{const h=E.current;if(!(!h||f))if(A.isSupported()){const C={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:te};l=new A(C),l.loadSource(p),l.attachMedia(h),l.on(A.Events.MANIFEST_PARSED,()=>{if(f||!h)return;const O=p.substring(p.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${O}`);let w=!1;y=()=>{!w&&!f&&(w=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${O}`),h&&y&&h.removeEventListener("playing",y))},h.addEventListener("playing",y),r&&!f&&h.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",L)})}),l.on(A.Events.ERROR,(O,w)=>{if(!f&&(console.error("[HLS Error]",{type:w.type,details:w.details,fatal:w.fatal,url:w.url,error:w.error,response:w.response}),w.fatal))switch(w.type){case A.ErrorTypes.NETWORK_ERROR:if(!f&&l){console.warn("HLS network error, trying to recover...",{details:w.details,url:w.url,error:w.error});try{l.startLoad()}catch(L){f||console.warn("HLS recovery failed:",L)}}break;case A.ErrorTypes.MEDIA_ERROR:if(!f&&l){console.warn("HLS media error, trying to recover...");try{l.recoverMediaError()}catch(L){f||console.warn("HLS media recovery failed:",L)}}break;default:f||console.error("HLS fatal error:",w),l&&(l.destroy(),l=null);break}})}else f||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=p,b=()=>{f||console.warn("Native HLS playback failed")},h.addEventListener("error",b),r&&!f&&h.play().catch(C=>{C.name!=="AbortError"&&C.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",C)})},0);return()=>{f=!0,clearTimeout(j);const h=E.current;if(h&&y&&(h.removeEventListener("playing",y),y=null),l){try{l.detachMedia(),l.destroy()}catch{}l=null}if(h){b&&h.removeEventListener("error",b);try{h.pause(),h.src="",h.load()}catch{}}}},[p,r]),g.useEffect(()=>{n&&n(E.current)},[n,a,p]);const B="100%",_=S?{width:"100%",maxWidth:B,maxHeight:"100%",aspectRatio:N,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:B,maxHeight:"100%",height:"var(--player-height)",aspectRatio:N,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return p?I.jsx("div",{style:_,children:I.jsx("video",{ref:E,autoPlay:r,loop:i,muted:c,controls:u,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:d?"pointer":"default"},children:"Your browser does not support the video tag."},p)}):I.jsx("div",{style:_,children:"No video available"})},ae=({open:o,onClose:t,buttonRef:e,children:a,align:r="right",minWidth:i=160})=>{const[c,u]=g.useState(null),n=g.useRef(null);if(g.useEffect(()=>{if(!o||!e.current){u(null);return}const s=()=>{if(!e.current)return;const m=e.current.getBoundingClientRect();u({top:m.bottom+8,[r]:window.innerWidth-m[r==="right"?"right":"left"]})};return s(),window.addEventListener("resize",s),window.addEventListener("scroll",s,!0),()=>{window.removeEventListener("resize",s),window.removeEventListener("scroll",s,!0)}},[o,e,r]),g.useEffect(()=>{if(!o)return;const s=m=>{n.current&&!n.current.contains(m.target)&&e.current&&!e.current.contains(m.target)&&t()};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[o,t,e]),!o||!c)return null;const d=I.jsx("div",{ref:n,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:i,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:a});return X.createPortal(d,document.body)};export{se as P,ae as a};

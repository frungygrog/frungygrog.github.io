import{r as a,j as R,Z as q}from"./vendor-react-DAI70FzT.js";import{H as s}from"./vendor-BDoj2xXt.js";const Z=({playbackUrl:v,streamUID:g,aspectRatio:c,preferNative:x=!1,autoplay:l=!1,loop:A=!1,muted:H=!1,controls:b=!0,onVideoRef:m,onClick:F})=>{const d=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,o=a.useRef(null),[_,M]=a.useState(null),k=a.useMemo(()=>{const e=typeof c=="number"&&isFinite(c)&&c>0?c:null;return e||16/9},[c]),I=`${_??k} / 1`,r=a.useMemo(()=>v||(g?`https://videodelivery.net/${g}/manifest/video.m3u8`:null),[v,g]),j=a.useRef(null);a.useEffect(()=>{r&&(j.current=r)},[r]),a.useEffect(()=>{M(null)},[r]),a.useEffect(()=>{if(!x||!o.current)return;const e=o.current;let p=!1;const n=()=>{if(!p)if(e.videoWidth>0&&e.videoHeight>0){const L=e.videoWidth/e.videoHeight;M(L),p=!0}else M(k),p=!0};return e.addEventListener("loadedmetadata",n),e.readyState>=1&&n(),()=>{e.removeEventListener("loadedmetadata",n)}},[x,k,r]);const T=a.useRef(null),E=a.useRef(null);a.useEffect(()=>{if(!r)return;let e=T.current,p=null,n=!1,L=null;if(e&&E.current&&E.current!==r){console.log(`[HLS] URL changed from ${E.current} to ${r}, using loadSource`);try{e.stopLoad(),e.loadSource(r),E.current=r;const t=o.current;if(t)try{t.pause(),t.currentTime=0,t.load()}catch(u){console.warn("[HLS] Error resetting video element:",u)}}catch(t){console.error("[HLS] Error switching source:",t);try{e.destroy()}catch{}e=null,T.current=null,E.current=null}}if(e&&E.current===r)return console.log(`[HLS] URL unchanged (${r}), reusing existing HLS instance`),()=>{n=!0};const N=()=>{if(document.hidden&&e){const t=o.current;if(t)try{t.pause()}catch{}try{e.stopLoad()}catch{}}},P=()=>{if(n=!0,e){try{e.stopLoad(),e.detachMedia(),e.destroy()}catch{}e=null}};document.addEventListener("visibilitychange",N),window.addEventListener("beforeunload",P);const O=()=>{const t=o.current;if(!t||n)return;try{for(t.pause(),t.currentTime=0,t.src="",t.srcObject=null;t.firstChild;)t.removeChild(t.firstChild);t.load()}catch(y){console.warn("[HLS] Error resetting video element:",y)}const u=performance.now();if(console.log(`[HLS] Starting HLS setup for ${r} at ${u.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:t.readyState,isConnected:t.isConnected,paused:t.paused,currentTime:t.currentTime}),s.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const y={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const w=performance.now();e=new s(y),T.current=e,E.current=r;const S=performance.now()-w;console.log(`[HLS] HLS instance created in ${S.toFixed(2)}ms`);const i=performance.now();e.loadSource(r);const f=performance.now()-i;console.log(`[HLS] loadSource() called in ${f.toFixed(2)}ms`);const h=performance.now();e.attachMedia(t);const $=performance.now()-h;console.log(`[HLS] attachMedia() completed in ${$.toFixed(2)}ms`);const U=performance.now()-u;console.log(`[HLS] Total HLS setup time: ${U.toFixed(2)}ms`)}catch(w){const S=performance.now()-u;if(console.error(`[HLS] Failed to initialize HLS after ${S.toFixed(2)}ms:`,w),e){try{e.destroy()}catch{}e=null}return}e.on(s.Events.MANIFEST_PARSED,()=>{const w=performance.now()-u;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${w.toFixed(2)}ms after setup start`),n||!t)return;A&&(L=()=>{if(!(n||!t||!e))try{t.currentTime=0,t.play().catch(i=>{i.name!=="AbortError"&&i.name!=="NotAllowedError"&&console.debug("Loop play failed:",i)})}catch{t.currentTime=0,t.play().catch(()=>{})}},t.addEventListener("ended",L)),(()=>{if(!(n||!t))if(t.readyState>=2){if(l){const i=performance.now();t.play().then(()=>{const f=performance.now()-i;console.log(`[HLS] Autoplay succeeded in ${f.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(f=>{const h=performance.now()-i;f.name!=="AbortError"&&f.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${h.toFixed(2)}ms:`,f)})}}else{const i=()=>{if(!(n||!t)&&(t.removeEventListener("canplay",i),l)){const f=performance.now();t.play().then(()=>{const h=performance.now()-f;console.log(`[HLS] Autoplay succeeded in ${h.toFixed(2)}ms after canplay event`)}).catch(h=>{const $=performance.now()-f;h.name!=="AbortError"&&h.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${$.toFixed(2)}ms:`,h)})}};t.addEventListener("canplay",i,{once:!0})}})()}),e.on(s.Events.ERROR,(w,S)=>{if(!n&&S.fatal)switch(S.type){case s.ErrorTypes.NETWORK_ERROR:if(!n&&e)try{e.startLoad()}catch{}break;case s.ErrorTypes.MEDIA_ERROR:if(!n&&e)try{e.recoverMediaError()}catch{}break;default:e&&(e.destroy(),e=null);break}})}else n||console.warn("HLS.js not supported, falling back to native HLS"),t.src=r,t.loop=A,p=()=>{n||console.warn("Native HLS playback failed")},t.addEventListener("error",p),l&&!n&&t.play().catch(y=>{y.name!=="AbortError"&&y.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",y)})};let W=0;const B=10,D=()=>{if(n)return;if(W++,W>B){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const t=o.current;if(!t){requestAnimationFrame(D);return}if(!t.isConnected){requestAnimationFrame(D);return}O()},z=requestAnimationFrame(()=>{requestAnimationFrame(D)});return()=>{cancelAnimationFrame(z),n=!0,document.removeEventListener("visibilitychange",N),window.removeEventListener("beforeunload",P);const t=o.current;if(t&&L&&(t.removeEventListener("ended",L),L=null),e){try{e.stopLoad(),e.off(s.Events.MANIFEST_PARSED),e.off(s.Events.ERROR),e.off(s.Events.MEDIA_ATTACHED),e.off(s.Events.MEDIA_DETACHED),e.off(s.Events.MANIFEST_LOADED),e.off(s.Events.MEDIA_ATTACHING),e.off(s.Events.MEDIA_DETACHING),e.off(s.Events.DESTROYING),e.destroy()}catch{try{e&&e.detachMedia()}catch{}}e=null,T.current=null,E.current=null}if(t){p&&(t.removeEventListener("error",p),p=null);try{t.pause()}catch{}}}},[r,l]),a.useEffect(()=>(m&&o.current&&m(o.current),()=>{m&&m(null)}),[m,x,r]);const C=d?{height:"100%",maxHeight:"100%",width:"auto",maxWidth:"100%",aspectRatio:I,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"auto",maxWidth:"100%",maxHeight:"100%",height:"var(--player-height)",aspectRatio:I,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1};return r?R.jsx("div",{style:C,children:R.jsx("video",{ref:o,autoPlay:l,loop:!1,muted:H,controls:b,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:F?"pointer":"default"},children:"Your browser does not support the video tag."})}):R.jsx("div",{style:C,children:"No video available"})},J=({open:v,onClose:g,buttonRef:c,children:x,align:l="right",minWidth:A=160})=>{const[H,b]=a.useState(null),m=a.useRef(null);if(a.useEffect(()=>{if(!v||!c.current){b(null);return}const d=()=>{if(!c.current)return;const o=c.current.getBoundingClientRect();b({top:o.bottom+8,[l]:window.innerWidth-o[l==="right"?"right":"left"]})};return d(),window.addEventListener("resize",d),window.addEventListener("scroll",d,!0),()=>{window.removeEventListener("resize",d),window.removeEventListener("scroll",d,!0)}},[v,c,l]),a.useEffect(()=>{if(!v)return;const d=o=>{m.current&&!m.current.contains(o.target)&&c.current&&!c.current.contains(o.target)&&g()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[v,g,c]),!v||!H)return null;const F=R.jsx("div",{ref:m,style:{position:"fixed",top:H.top,[l]:H[l],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:A,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:x});return q.createPortal(F,document.body)};export{Z as P,J as a};

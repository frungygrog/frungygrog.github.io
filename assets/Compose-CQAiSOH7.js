import{r as i,j as e,T as Se,w as Ne}from"./vendor-react-_vsaDC62.js";import{c as we,b as ke,a as Ie,i as ze}from"./editor-components-CKFEosPJ.js";import{B as Ce}from"./editor-lib-Cf56EpaA.js";import{u as Ue,a as $,A as T,b as Le}from"./index-D-vrz8OI.js";const me={standard:ze,taiko:Ie,mania:ke,catch:we},fe={standard:"Standard",taiko:"Taiko",mania:"Mania",catch:"Catch"},Re=({value:v,onChange:c})=>{const[y,h]=i.useState(!1),g=i.useRef(null);i.useEffect(()=>{if(!y)return;const u=b=>{g.current&&!g.current.contains(b.target)&&h(!1)},j=b=>{b.key==="Escape"&&h(!1)};return document.addEventListener("mousedown",u),document.addEventListener("keydown",j),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",j)}},[y]);const L=u=>e.jsxs("button",{className:`mode-option${u===v?" selected":""}`,onClick:()=>{c(u),h(!1)},role:"option","aria-selected":u===v,children:[e.jsx("img",{className:"mode-icon",src:me[u],width:24,height:24,alt:""}),e.jsx("span",{children:fe[u]})]},u);return e.jsxs("div",{className:"mode-select",ref:g,children:[e.jsxs("button",{type:"button",className:"mode-button","aria-haspopup":"listbox","aria-expanded":y,onClick:()=>h(u=>!u),children:[e.jsx("img",{className:"mode-icon",src:me[v],width:24,height:24,alt:""}),e.jsx("span",{className:"mode-label",children:fe[v]}),e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6","aria-hidden":"true",style:{marginLeft:6,opacity:.8},children:e.jsx("path",{d:"M1 1l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})})]}),y&&e.jsx("div",{className:"mode-panel",role:"listbox",children:["standard","taiko","mania","catch"].map(L)})]})};function he(v){if(!v)return"standard";const c=String(v).toLowerCase().trim();return c==="osu"||c==="0"||c==="standard"?"standard":c==="taiko"||c==="1"?"taiko":c==="catch"||c==="fruits"||c==="2"?"catch":c==="mania"||c==="3"?"mania":"standard"}function Oe({section:v,onUpload:c,onPost:y}){const{notify:h}=Ue(),g=v==="mappi",[L,u]=i.useState(!1),[j,b]=i.useState(""),[a,S]=i.useState(null),[o,p]=i.useState(null),[G,F]=i.useState(!1),[O,k]=i.useState(""),R=i.useRef(0),[Q,V]=i.useState(""),[Y,B]=i.useState("standard"),[d,Z]=i.useState(null),[D,_]=i.useState(0),[H,I]=i.useState(""),[ge,z]=i.useState(""),[ee,A]=i.useState(null),[W,P]=i.useState(""),[q,E]=i.useState(""),[te,M]=i.useState(null),[ae,K]=i.useState(!1),[se,ne]=i.useState(null),ie=100*1024*1024,J=i.useMemo(()=>d?`${d.name}:${d.size}:${d.lastModified}`:null,[d]),[C,re]=i.useState(""),[oe,le]=i.useState(!1),[w,X]=i.useState([]),xe=i.useRef(null);i.useEffect(()=>{R.current&&window.clearTimeout(R.current);const t=(j||"").trim();if(!t){k(""),S(null),p(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(t)){k(""),S(null),p(null);return}return R.current=window.setTimeout(async()=>{var s;try{let r;try{r=new URL(t)}catch{k("Invalid URL format");return}const x=r.hash.match(/#osu\/(\d+)/),l=x?x[1]:null;r.hash="";const ue={url:r.toString()};l&&(ue.beatmap_id=l);const f=await $(T.osu.resolveBeatmap+Le(ue),{requireAuth:!1}),U=Array.isArray(f==null?void 0:f.diffs)?f.diffs:[];if(!U.length&&!f.setId){k("No difficulties found"),S(null),p(null);return}if(S({setId:Number(f.setId)||0,beatmapId:f.beatmapId??null,title:String(f.title||""),artist:String(f.artist||""),mapper:String(f.mapper||""),diffs:U}),U.length>0){const ye=Number.isFinite(Number(f.beatmapId))?Number(f.beatmapId):Number((s=U[0])==null?void 0:s.id),N=U.find(je=>Number(je.id)===ye)||U[0],pe=he(N==null?void 0:N.mode);p({beatmapId:Number(N==null?void 0:N.id)||null,version:String((N==null?void 0:N.version)||""),mode:pe}),g&&B(pe)}else p(null);k("")}catch(r){const x=(r==null?void 0:r.message)||"Unknown error";k(`Failed to resolve: ${x}`),S(null),p(null)}},400),()=>{R.current&&window.clearTimeout(R.current)}},[j,g]);async function de(){return z("info"),I("Requesting upload URL..."),await $(T.uploads.new,{method:"POST",body:JSON.stringify({description:Q.slice(0,100),beatmap_url:j||void 0,size_bytes:(d==null?void 0:d.size)??void 0,mode:Y,beatmapset_id:(a==null?void 0:a.setId)??void 0,beatmap_id:(o==null?void 0:o.beatmapId)??void 0,beatmap_version:(o==null?void 0:o.version)??void 0,beatmap_title:a?`${a.title}`:void 0,beatmap_artist:a?`${a.artist}`:void 0,beatmap_mapper:a?`${a.mapper}`:void 0})})}async function ce(t,n,s="form"){await new Promise((r,x)=>{const l=new XMLHttpRequest;if(l.open("POST",t),l.upload.onprogress=m=>{m.lengthComputable&&_(Math.round(m.loaded/m.total*100))},l.onload=()=>l.status>=200&&l.status<300?r():x(new Error(`Upload failed (${l.status}) ${l.responseText||""}`)),l.onerror=()=>x(new Error("Network error")),s==="form"){const m=new FormData;m.append("file",n,n.name),l.send(m)}else l.setRequestHeader("Content-Type","application/octet-stream"),l.send(n)})}async function be(){if(!(!d||!g)){if(d.size>ie){P("File exceeds 100MB limit");return}if(typeof te=="number"&&te>60.5){E("Clip exceeds 60s limit");return}J&&(K(!0),ne(J)),_(0),z("info");try{const t=await de();A(t.streamUID);let n=t.streamUID;try{I("Uploading..."),await ce(t.uploadURL,d,"form")}catch(s){z("warn"),I(`Retrying upload... (${(s==null?void 0:s.message)||s})`);const r=await de();A(r.streamUID),n=r.streamUID,await ce(r.uploadURL,d,"binary")}z("info"),I("Processing...");for(let s=0;s<60;s++){await new Promise(r=>setTimeout(r,3e3));try{if((await $(T.videos.get(n),{requireAuth:!1})).status==="ready"){z("success"),I("Ready!"),h("Upload complete!",{variant:"success"}),Z(null),V(""),b(""),S(null),p(null),B("standard"),_(0),A(null),P(""),E(""),M(null),K(!1),ne(null),c&&c();break}}catch{}}}catch(t){z("error"),I(t.message||"Error"),h(t.message||"Upload failed",{variant:"error"})}}}const ve=async t=>{if(t.preventDefault(),!g){if(!C.trim()){h("Text is required",{variant:"error"});return}if(C.length>200){h("Text must be 200 characters or less",{variant:"error"});return}le(!0);try{const n=await $(T.moddi.posts,{method:"POST",body:JSON.stringify({text:C.trim(),beatmap_url:j.trim()||void 0,beatmapset_id:(a==null?void 0:a.setId)??void 0,beatmap_id:(o==null?void 0:o.beatmapId)??(a==null?void 0:a.beatmapId)??void 0,beatmap_version:(o==null?void 0:o.version)??void 0,tags:w.length>0?w.join(","):void 0})});if(n){console.log("Post created response:",n);const s=n==null?void 0:n.post;s?(!s.uid&&s.id&&(console.warn("Created post missing uid, using id as fallback:",s),s.uid=String(s.id)),y&&y(s)):y&&y(),h("Post created!",{variant:"success"}),re(""),b(""),S(null),p(null),k(""),F(!1),X([])}}catch{h("Failed to create post",{variant:"error"})}finally{le(!1)}}};return e.jsxs("div",{style:{background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,marginBottom:g?12:0},children:[e.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"8px 12px",minHeight:36},onClick:()=>u(!L),children:[e.jsx("span",{style:{fontWeight:600,fontSize:16,lineHeight:1},children:g?"Upload a clip":"Create a post!"}),L?e.jsx(Se,{size:16}):e.jsx(Ne,{size:16})]}),L&&e.jsx("div",{style:{padding:"12px",borderTop:"1px solid rgba(255,255,255,0.06)"},children:g?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"muted",style:{fontSize:11,lineHeight:1.4,marginBottom:12},children:"Max: 60s, 100MB. Only osu! mapping content is permitted."}),e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsxs("div",{className:"row",style:{alignItems:"center"},children:[e.jsx("span",{className:"muted",style:{fontSize:12,minWidth:80},children:"Game mode:"}),e.jsx(Re,{value:Y,onChange:B})]}),a?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[a.artist," – ",a.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",a.mapper]})]}),a.diffs.length>0&&e.jsx("select",{value:(o==null?void 0:o.beatmapId)??a.beatmapId??void 0,onChange:t=>{const n=Number(t.target.value),s=(a==null?void 0:a.diffs.find(r=>Number(r.id)===n))||null;if(s){const r=he(s.mode);p({beatmapId:n,version:s.version,mode:r}),B(r)}},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:a.diffs.map(t=>e.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>F(!0),style:{padding:"6px 12px",fontSize:13},children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{S(null),p(null),b("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional) e.g. https://osu.ppy.sh/beatmapsets/...",value:j,onChange:t=>b(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),e.jsx("textarea",{maxLength:100,placeholder:"Description (max 100 chars)",value:Q,onChange:t=>V(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:64}}),O&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:O}),e.jsxs("div",{className:"row wrap",style:{gap:8},children:[e.jsx("input",{type:"file",accept:"video/*",onChange:t=>{var r;const n=((r=t.target.files)==null?void 0:r[0])||null;if(Z(n),M(null),n&&n.size>ie?P("File exceeds 100MB limit"):P(""),n)try{const x=URL.createObjectURL(n),l=document.createElement("video");l.preload="metadata",l.src=x,l.onloadedmetadata=()=>{URL.revokeObjectURL(x);const m=Number.isFinite(l.duration)?l.duration:NaN;Number.isFinite(m)&&M(m),Number.isFinite(m)&&m>60.5?E("Clip exceeds 60s limit"):E("")},l.onerror=()=>{URL.revokeObjectURL(x),M(null)}}catch{M(null)}else E("");const s=n?`${n.name}:${n.size}:${n.lastModified}`:null;s&&s!==se&&K(!1)},style:{flex:1,minWidth:0}}),e.jsx("button",{className:"btn",onClick:be,disabled:!d||!!W||!!q||ae,style:{flexShrink:0},children:"Upload"})]}),W&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:W}),q&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:q}),d&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Selected: ",d.name," • ",(d.size/1024/1024).toFixed(1)," MB",ae&&se===J?e.jsx("span",{style:{marginLeft:6,color:"#f59e0b"},children:"(locked)"}):null]}),(D>0||H)&&e.jsxs("div",{className:"upload-status",children:[H&&e.jsx("div",{className:`chip ${ge||"info"}`,style:{fontSize:11,padding:"4px 8px"},children:H}),D>0&&e.jsx("div",{className:"progress",style:{marginTop:8},"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":D,children:e.jsx("div",{className:"progress-bar",style:{width:`${Math.min(100,Math.max(0,D))}%`}})})]}),ee&&e.jsxs("div",{className:"muted",style:{fontSize:11},children:["Stream UID: ",ee]})]})]}):e.jsx("form",{onSubmit:ve,children:e.jsxs("div",{className:"col",style:{gap:12},children:[e.jsx("textarea",{ref:xe,placeholder:"Ask for feedback! Or, say anything! Woo! (max 200 chars)",value:C,onChange:t=>re(t.target.value),maxLength:200,rows:2,style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",minHeight:50}}),a?e.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[e.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[e.jsxs("strong",{style:{marginRight:4},children:[a.artist," – ",a.title]}),e.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",a.mapper]})]}),a.diffs.length>0&&e.jsx("select",{value:(o==null?void 0:o.beatmapId)??a.beatmapId??void 0,onChange:t=>{const n=Number(t.target.value),s=(a==null?void 0:a.diffs.find(r=>Number(r.id)===n))||null;s&&p({beatmapId:n,version:s.version,mode:String(s.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"4px 8px",fontSize:12},children:a.diffs.map(t=>e.jsxs("option",{value:t.id,children:[t.version," (",t.mode,")"]},t.id))})]}):e.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:j,onChange:t=>b(t.target.value),style:{background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:12,color:"var(--text)",fontFamily:"inherit",fontSize:14}}),O&&e.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:O}),e.jsxs("div",{className:"row",style:{alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{className:"muted",style:{fontSize:11},children:"Tags:"}),e.jsx("button",{type:"button",onClick:()=>{w.includes("help")?X(w.filter(t=>t!=="help")):X([...w,"help"])},style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:w.includes("help")?"rgba(234, 179, 8, 0.2)":"rgba(255,255,255,0.05)",border:w.includes("help")?"1px solid rgba(234, 179, 8, 0.4)":"1px solid rgba(255,255,255,0.12)",color:w.includes("help")?"#fbbf24":"var(--text)",fontWeight:500,lineHeight:1.2,cursor:"pointer",transition:"all 0.15s ease"},children:"Help"})]}),e.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[a&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>F(!0),children:"Preview"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{S(null),p(null),b("")},children:"Clear"})]}),e.jsx("button",{type:"submit",className:"btn",disabled:oe||!C.trim()||C.length>200,children:oe?"Posting...":"Post"})]})]})})}),G&&a&&e.jsx(Ce,{open:G,onClose:()=>F(!1),downloadUrl:T.osu.downloadBeatmapset(a.setId),beatmapId:(o==null?void 0:o.beatmapId)??a.beatmapId??void 0,beatmapVersion:o==null?void 0:o.version})]})}export{Oe as C};

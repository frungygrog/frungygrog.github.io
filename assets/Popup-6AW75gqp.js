var Z=Object.defineProperty;var G=(r,t,e)=>t in r?Z(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var I=(r,t,e)=>G(r,typeof t!="symbol"?t+"":t,e);import{_ as J}from"./index-DiD2wuOO.js";import{r as p,j as z,Z as Q}from"./vendor-react-_vsaDC62.js";import{H as A}from"./vendor-DBgzFpze.js";const ee="video-cache",te=1,L="segments",x="manifests",re=7*24*60*60*1e3,D=500*1024*1024;let H=null,N=null;function $(){return H?Promise.resolve(H):N||(N=new Promise((r,t)=>{const e=indexedDB.open(ee,te);e.onerror=()=>t(e.error),e.onsuccess=()=>{H=e.result,r(H)},e.onupgradeneeded=s=>{const o=s.target.result;o.objectStoreNames.contains(L)||o.createObjectStore(L,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),o.objectStoreNames.contains(x)||o.createObjectStore(x,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),N)}async function U(r,t=!1){try{const e=await $(),s=t?x:L,a=e.transaction([s],"readonly").objectStore(s),n=j(r,t),m=n.substring(n.lastIndexOf("/")+1),d=r.substring(r.lastIndexOf("/")+1).substring(0,50);console.log(`[Video Cache] ðŸ” Looking up cache key: ${m} (full: ${n.substring(0,100)}...)`);const l=a.get(n);return new Promise(c=>{l.onsuccess=()=>{const h=l.result;if(!h){console.log(`[Video Cache] ðŸ” Cache lookup result: NOT FOUND for key: ${n.substring(n.lastIndexOf("/")+1)}`),c(null);return}const g=Date.now()-h.timestamp;if(g>re){console.log(`[Video Cache] â° Cache entry expired (age: ${Math.round(g/1e3/60)}min) for: ${n.substring(n.lastIndexOf("/")+1)}`),X(r,t).catch(()=>{}),c(null);return}console.log(`[Video Cache] âœ… Cache entry FOUND (age: ${Math.round(g/1e3)}s) for: ${n.substring(n.lastIndexOf("/")+1)}`),c(h.data)},l.onerror=()=>{console.log(`[Video Cache] âŒ Cache lookup ERROR for key: ${n.substring(n.lastIndexOf("/")+1)}`),c(null)}})}catch(e){return console.warn("Cache read error:",e),null}}async function F(r,t,e=!1){try{const s=await $(),o=e?x:L,n=s.transaction([o],"readwrite").objectStore(o),m=j(r,e),d=m.substring(m.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸ’¾ Storing with cache key: ${d} (full: ${m.substring(0,100)}...)`);const l={url:m,data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((c,h)=>{const g=n.put(l);g.onsuccess=()=>c(),g.onerror=()=>h(g.error)}),await ne()}catch(s){console.warn("Cache write error:",s)}}async function X(r,t=!1){try{const e=await $(),s=t?x:L,a=e.transaction([s],"readwrite").objectStore(s),n=j(r,t);await new Promise((m,d)=>{const l=a.delete(n);l.onsuccess=()=>m(),l.onerror=()=>d(l.error)})}catch(e){console.warn("Cache delete error:",e)}}async function oe(){try{const r=await $();let t=0;for(const e of[L,x]){const a=r.transaction([e],"readonly").objectStore(e).getAll();await new Promise(n=>{a.onsuccess=()=>{const m=a.result;t+=m.reduce((d,l)=>d+l.size,0),n()},a.onerror=()=>n()})}return t}catch(r){return console.warn("Cache size calculation error:",r),0}}async function ne(){try{const r=await oe();if(r<=D)return;const t=await $(),e=[];for(const o of[L,x]){const a=o===x,d=t.transaction([o],"readonly").objectStore(o).getAll();await new Promise(l=>{d.onsuccess=()=>{const c=d.result;e.push(...c.map(h=>({url:h.url,timestamp:h.timestamp,size:h.size,isManifest:a}))),l()},d.onerror=()=>l()})}e.sort((o,a)=>o.timestamp-a.timestamp);let s=r;for(const o of e){if(s<=D*.8)break;await X(o.url,o.isManifest),s-=o.size}}catch(r){console.warn("Cache cleanup error:",r)}}async function se(){try{const r=await $();for(const t of[L,x]){const s=r.transaction([t],"readwrite").objectStore(t);await new Promise((o,a)=>{const n=s.clear();n.onsuccess=()=>{console.log(`[Video Cache] ðŸ—‘ï¸ Cleared ${t} cache`),o()},n.onerror=()=>a(n.error)})}}catch(r){console.warn("Cache clear error:",r)}}function Y(r){return r.includes(".m3u8")||r.endsWith("/manifest")}function j(r,t){if(t)try{const e=new URL(r),s=new URLSearchParams(e.search),o=Array.from(s.entries()).sort(([a],[n])=>a.localeCompare(n));return e.search=new URLSearchParams(o).toString(),e.toString()}catch{return r}else try{const e=new URL(r);return e.origin+e.pathname}catch{const e=r.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return e?e[0]:r.split("?")[0]}}const ae=Object.freeze(Object.defineProperty({__proto__:null,clearCache:se,getCached:U,isManifest:Y,normalizeCacheKey:j,setCached:F},Symbol.toStringTag,{value:"Module"}));class ie{constructor(t){I(this,"context",null);I(this,"stats");I(this,"defaultLoader",null);I(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,s){this.context=t;const o=t.url,a=Y(o);U(o,a).then(n=>{if(n){let d;a?d=new TextDecoder().decode(n):d=n;const l=performance.now();this.stats.loading.start=l,this.stats.loading.first=l,this.stats.loading.end=l,this.stats.loaded=n.byteLength,this.stats.total=n.byteLength,this.stats.aborted=!1;const c={data:d,url:o,code:200},h=a?"manifest":"segment",g=(n.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${h}: ${o.substring(o.lastIndexOf("/")+1)} (${g} KB)`),s.onSuccess(c,this.stats,t,{});return}console.log(`[Video Cache] âŒ Cache MISS - ${a?"manifest":"segment"}: ${o.substring(o.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(o,a,t,e,s)}).catch(n=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${a?"manifest":"segment"}: ${o.substring(o.lastIndexOf("/")+1)} - falling back to network`,n),this.fetchFromNetwork(o,a,t,e,s)})}async fetchFromNetwork(t,e,s,o,a){var m;const n=performance.now();try{const d=this.abortController||new AbortController,l=await fetch(t,{method:s.method||"GET",headers:s.headers||{},signal:d.signal}).catch(S=>{throw S.name==="AbortError",S});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);let c;const h=l.headers.get("content-type")||"";e||h.includes("application/vnd.apple.mpegurl")||h.includes("text")?c=await l.text():c=await l.arrayBuffer();const g=performance.now(),C=typeof c=="string"?new TextEncoder().encode(c).length:c.byteLength;this.stats.loading.start=n,this.stats.loading.first=n,this.stats.loading.end=g,this.stats.loaded=C,this.stats.total=C,this.stats.aborted=!1;const P=e?"manifest":"segment";if(c instanceof ArrayBuffer){await F(t,c,e);const S=(c.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${P}: ${t.substring(t.lastIndexOf("/")+1)} (${S} KB)`)}else{const _=new TextEncoder().encode(c);await F(t,_.buffer,e);const T=(_.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${P}: ${t.substring(t.lastIndexOf("/")+1)} (${T} KB)`)}const M={data:c,url:l.url,code:l.status};a.onSuccess(M,this.stats,s,{})}catch(d){const l=performance.now();if(this.stats.loading.start=n,this.stats.loading.first=n,this.stats.loading.end=l,this.stats.loaded=0,this.stats.total=0,d instanceof Error&&d.name==="AbortError")this.stats.aborted=!0,(m=a.onAbort)==null||m.call(a,this.stats,s,{});else if(!(d instanceof Error&&d.name==="AbortError")){this.stats.aborted=!1;const c=d instanceof Error?d:new Error("Network error");a.onError({code:0,text:c.message},s,{},this.stats)}}}abort(){this.abortController&&this.abortController.abort()}destroy(){this.context=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}},this.abortController&&(this.abortController.abort(),this.abortController=null)}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const he=({playbackUrl:r,streamUID:t,aspectRatio:e,preferNative:s=!1,autoplay:o=!1,loop:a=!1,muted:n=!1,controls:m=!0,onVideoRef:d,onClick:l})=>{const[c,h]=p.useState(1.7777777777777777),g=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;p.useEffect(()=>{if(!g)return;const i=()=>h(window.innerWidth/Math.max(1,window.innerHeight));return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[g]);const C=p.useRef(null),[P,M]=p.useState(null),S=p.useMemo(()=>{const i=1.3333333333333333,y=16/9,f=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(f)return Math.min(y,Math.max(i,f));const E=g?c:16/9;return Math.min(y,Math.max(i,E))},[g,c,e]),T=`${P??S} / 1`,w=p.useMemo(()=>r||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[r,t]),k=p.useRef(null);p.useEffect(()=>{w&&k.current&&k.current!==w&&(console.log(`[Video Cache] ðŸŽ¬ Video changed from ${k.current.substring(k.current.lastIndexOf("/")+1)} to ${w.substring(w.lastIndexOf("/")+1)} - clearing cache`),J(async()=>{const{clearCache:i}=await Promise.resolve().then(()=>ae);return{clearCache:i}},void 0).then(({clearCache:i})=>{i().catch(y=>{console.warn("[Video Cache] Failed to clear cache on video change:",y)})})),k.current=w},[w]),p.useEffect(()=>{M(null)},[w]),p.useEffect(()=>{if(!s||!C.current)return;const i=C.current;let y=!1;const f=()=>{if(!y)if(i.videoWidth>0&&i.videoHeight>0){const E=i.videoWidth/i.videoHeight,R=4/3,W=16/9,V=Math.min(W,Math.max(R,E));M(V),y=!0}else M(S),y=!0};return i.addEventListener("loadedmetadata",f),i.readyState>=1&&f(),()=>{i.removeEventListener("loadedmetadata",f)}},[s,S,w]),p.useEffect(()=>{if(!w)return;let i=null,y=null,f=!1,E=null,R=null;const V=setTimeout(()=>{const u=C.current;if(!(!u||f))if(A.isSupported()){const O={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:ie};i=new A(O),i.loadSource(w),i.attachMedia(u),i.on(A.Events.MANIFEST_PARSED,()=>{if(f||!u)return;const B=w.substring(w.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${B}`);let b=!1;E=()=>{!b&&!f&&(b=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${B}`),u&&E&&u.removeEventListener("playing",E))},u.addEventListener("playing",E),a&&(R=()=>{f||!u||!i||(console.log("[Video Cache] ðŸ”„ Video ended, looping back to start (will use cache)"),u.currentTime=0,u.play().catch(v=>{v.name!=="AbortError"&&v.name!=="NotAllowedError"&&console.debug("Loop play failed:",v)}))},u.addEventListener("ended",R)),o&&!f&&u.play().catch(v=>{v.name!=="AbortError"&&v.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",v)})}),i.on(A.Events.ERROR,(B,b)=>{if(!f&&(console.error("[HLS Error]",{type:b.type,details:b.details,fatal:b.fatal,url:b.url,error:b.error,response:b.response}),b.fatal))switch(b.type){case A.ErrorTypes.NETWORK_ERROR:if(!f&&i){console.warn("HLS network error, trying to recover...",{details:b.details,url:b.url,error:b.error});try{i.startLoad()}catch(v){f||console.warn("HLS recovery failed:",v)}}break;case A.ErrorTypes.MEDIA_ERROR:if(!f&&i){console.warn("HLS media error, trying to recover...");try{i.recoverMediaError()}catch(v){f||console.warn("HLS media recovery failed:",v)}}break;default:f||console.error("HLS fatal error:",b),i&&(i.destroy(),i=null);break}})}else f||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),u.src=w,y=()=>{f||console.warn("Native HLS playback failed")},u.addEventListener("error",y),o&&!f&&u.play().catch(O=>{O.name!=="AbortError"&&O.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",O)})},0);return()=>{f=!0,clearTimeout(V);const u=C.current;if(u&&E&&(u.removeEventListener("playing",E),E=null),u&&R&&(u.removeEventListener("ended",R),R=null),i){try{i.detachMedia(),i.destroy()}catch{}i=null}if(u){y&&u.removeEventListener("error",y);try{u.pause(),u.src="",u.load()}catch{}}}},[w,o]),p.useEffect(()=>{d&&d(C.current)},[d,s,w]);const K="100%",q=g?{width:"100%",maxWidth:K,maxHeight:"100%",aspectRatio:T,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:K,maxHeight:"100%",height:"var(--player-height)",aspectRatio:T,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return w?z.jsx("div",{style:q,children:z.jsx("video",{ref:C,autoPlay:o,loop:!1,muted:n,controls:m,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:l?"pointer":"default"},children:"Your browser does not support the video tag."},w)}):z.jsx("div",{style:q,children:"No video available"})},fe=({open:r,onClose:t,buttonRef:e,children:s,align:o="right",minWidth:a=160})=>{const[n,m]=p.useState(null),d=p.useRef(null);if(p.useEffect(()=>{if(!r||!e.current){m(null);return}const c=()=>{if(!e.current)return;const h=e.current.getBoundingClientRect();m({top:h.bottom+8,[o]:window.innerWidth-h[o==="right"?"right":"left"]})};return c(),window.addEventListener("resize",c),window.addEventListener("scroll",c,!0),()=>{window.removeEventListener("resize",c),window.removeEventListener("scroll",c,!0)}},[r,e,o]),p.useEffect(()=>{if(!r)return;const c=h=>{d.current&&!d.current.contains(h.target)&&e.current&&!e.current.contains(h.target)&&t()};return document.addEventListener("mousedown",c),()=>document.removeEventListener("mousedown",c)},[r,t,e]),!r||!n)return null;const l=z.jsx("div",{ref:d,style:{position:"fixed",top:n.top,[o]:n[o],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return Q.createPortal(l,document.body)};export{he as P,fe as a};

var Ee=Object.defineProperty;var Ne=(t,s,e)=>s in t?Ee(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e;var Rt=(t,s,e)=>Ne(t,typeof s!="symbol"?s+"":s,e);import{r as v,R as kt,j as p,a as Be,b as Ae,c as be}from"./vendor-react-BUPocPCH.js";import{J as Fe}from"./vendor-zip-DT3bY-99.js";import{P as Oe}from"./beatmap-preview-Bp3JZFQW.js";function ne(t){const s=(e,n)=>{const o=t==null?void 0:t[e],i=typeof o=="number"?o:Number(o);return Number.isFinite(i)?i:n};return{AR:s("ApproachRate",s("AR",5)),CS:s("CircleSize",5),OD:s("OverallDifficulty",s("OD",5)),HP:s("HPDrainRate",s("HP",5)),SliderMultiplier:s("SliderMultiplier",1.4),SliderTickRate:s("SliderTickRate",1)}}function Me(t){return 54.4-4.48*t}function Se(t){return t<=5?1800-120*t:1200-150*(t-5)}function ke(t){return Se(t)*.4}function re(t){return t?typeof t.uninherited=="number"?t.uninherited===1:(t.beatLength??0)>0:!1}function $t(t,s){const e=t.timingPoints||[];let n=null,o=null;for(let i=0;i<e.length;i++){const r=e[i];if(r.time<=s)re(r)?n=r:o=r;else break}if(!n||!o)for(let i=e.length-1;i>=0&&(!n||!o);i--){const r=e[i];r.time<=s&&(re(r)&&!n&&(n=r),!re(r)&&!o&&(o=r))}return{base:n,inherited:o}}const At=512,Nt=384;function $e(t){const s=[];for(let i=0;i<t.length;i++){const r=t[i];(!s.length||s[s.length-1].x!==r.x||s[s.length-1].y!==r.y)&&s.push({x:r.x,y:r.y})}const e=[],n=[0];for(let i=1;i<s.length;i++){const r=s[i].x-s[i-1].x,a=s[i].y-s[i-1].y,l=Math.hypot(r,a);e.push(l),n.push(n[n.length-1]+l)}const o=n[n.length-1]||0;return{pts:s,segLen:e,cumLen:n,total:o}}function Ut(t,s){const e=t.total||1,n=Math.max(0,Math.min(e,s*e));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,o-1),r=t.cumLen[i],a=t.segLen[i]||1,l=a>0?(n-r)/a:0,c=t.pts[i],d=t.pts[Math.min(i+1,t.pts.length-1)];return{x:c.x+(d.x-c.x)*l,y:c.y+(d.y-c.y)*l}}function De(t,s){const e=t.total||1,n=Math.max(0,Math.min(e,s*e));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,Math.min(t.pts.length-2,o-1)),r=t.pts[i],a=t.pts[i+1];return Math.atan2(a.y-r.y,a.x-r.x)}function oe(t,s){const e=Math.max(0,Math.min(t.total,s));if(e<=0)return[t.pts[0]];if(e>=t.total)return t.pts.slice();const n=[];let o=0;n.push(t.pts[0]);for(let i=1;i<t.pts.length;i++){const r=t.segLen[i-1];if(o+r<e){n.push(t.pts[i]),o+=r;continue}const a=e-o,l=r>0?a/r:0,c=t.pts[i-1],d=t.pts[i];n.push({x:c.x+(d.x-c.x)*l,y:c.y+(d.y-c.y)*l});break}return n}function ze(t,s){let e=t.map(n=>({x:n.x,y:n.y}));for(;e.length>1;){const n=[];for(let o=0;o<e.length-1;o++)n.push({x:e[o].x+(e[o+1].x-e[o].x)*s,y:e[o].y+(e[o+1].y-e[o].y)*s});e=n}return e[0]}function he(t,s=64){const e=[];for(let n=0;n<=s;n++){const o=n/s;e.push(ze(t,o))}return e}function Ue(t,s=64){const e=[];if(t.length<2)return t.slice();const n=t.slice(),o=.5,i=n.length-1;for(let r=0;r<i;r++){const a=n[Math.max(0,r-1)],l=n[r],c=n[r+1],d=n[Math.min(n.length-1,r+2)];for(let u=0;u<=s;u++){const f=u/s,C=f*f,m=C*f,P=-o*f+2*o*C-o*m,N=1+(o-3)*C+(2-o)*m,L=o*f+(3-2*o)*C+(o-2)*m,y=-o*C+o*m,R=P*a.x+N*l.x+L*c.x+y*d.x,g=P*a.y+N*l.y+L*c.y+y*d.y;e.push({x:R,y:g})}}return e}function Xe(t,s=64){if(t.length!==3)return he(t,96);const[e,n,o]=t,i=n.x-e.x,r=n.y-e.y,a=o.x-e.x,l=o.y-e.y,c=i*(e.x+n.x)+r*(e.y+n.y),d=a*(e.x+o.x)+l*(e.y+o.y),u=2*(i*(o.y-n.y)-r*(o.x-n.x));if(Math.abs(u)<1e-6)return he(t,96);const f=(l*c-r*d)/u,C=(i*d-a*c)/u,m=Math.atan2(e.y-C,e.x-f),P=Math.atan2(n.y-C,n.x-f),N=Math.atan2(o.y-C,o.x-f),L=Y=>(Y%(Math.PI*2)+Math.PI*2)%(Math.PI*2),y=L(N-m),R=-L(m-N),O=L(P-m)<=y?y:R,j=Math.hypot(e.x-f,e.y-C),M=[];for(let Y=0;Y<=s;Y++){const z=Y/s,X=m+O*z;M.push({x:f+Math.cos(X)*j,y:C+Math.sin(X)*j})}return M}function fe(t,s){return t.x===s.x&&t.y===s.y}function Ye(t,s=64){const e=[];let n=t[0],o=[t[0]];for(let r=1;r<t.length;r++){const a=t[r];fe(a,n)?(o.length>=2&&e.push(o.slice()),o=[a]):(o.push(a),n=a)}o.length>=2&&e.push(o);const i=[];for(const r of e){if(r.length===2){i.length===0&&i.push(r[0]),i.push(r[1]);continue}const a=he(r,s);i.length>0&&fe(i[i.length-1],a[0])&&a.shift(),i.push(...a)}return i}function Ht(t,s){let e;return t==="L"?e=s:t==="B"?e=Ye(s,96):t==="C"?e=Ue(s,96):e=Xe(s,96),$e(e)}const Wt=new Map;function It(t){return Math.max(0,Math.min(1,t))}function Vt(t,s,e,n,o){t.beginPath(),t.arc(s,e,n,0,Math.PI*2),t.strokeStyle=o,t.lineWidth=3,t.stroke()}function qt(t,s){if(!(s.length<2)){t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)t.lineTo(s[e].x,s[e].y)}}function We(t){const s=t.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(s){const n=s[1],o=n.length===3?n.split("").map(l=>l+l).join(""):n,i=parseInt(o.slice(0,2),16),r=parseInt(o.slice(2,4),16),a=parseInt(o.slice(4,6),16);return{r:i,g:r,b:a}}const e=t.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return e?{r:Number(e[1]),g:Number(e[2]),b:Number(e[3])}:null}function _e(t,s,e,n,o,i,r,a=1){if(s.length<2)return;const l=Ot.get(s,i,e,n);if(l){t.save(),t.globalAlpha=Math.max(0,Math.min(1,r));const{entry:S,transform:mt}=l;t.translate(mt.tx,mt.ty),t.rotate(mt.angle),t.scale(mt.scale,mt.scale),t.drawImage(S.canvas,S.normMinX-S.pad,S.normMinY-S.pad),t.restore();return}const c=Ot.normalizePath(s);let d=1/0,u=1/0,f=-1/0,C=-1/0;for(const S of c)S.x<d&&(d=S.x),S.y<u&&(u=S.y),S.x>f&&(f=S.x),S.y>C&&(C=S.y);const m=Math.ceil(Math.max(e,n)/2)+2,P=Math.max(1,Math.ceil(f-d+m*2)),N=Math.max(1,Math.ceil(C-u+m*2)),L=document.createElement("canvas");L.width=P,L.height=N;const y=L.getContext("2d",{willReadFrequently:!1});y.save(),y.translate(-d+m,-u+m),y.lineCap="round",y.lineJoin="round",y.globalCompositeOperation="source-over",y.globalAlpha=1,y.lineWidth=e,qt(y,c),y.strokeStyle=o,y.stroke();const R=We(i)||{r:255,g:255,b:255},g=`rgba(${R.r}, ${R.g}, ${R.b}, 1)`;y.lineWidth=n,qt(y,c),y.strokeStyle=g,y.stroke();const I=je(),O=Ce[I];y.globalCompositeOperation="soft-light",y.globalCompositeOperation!=="soft-light"&&(y.globalCompositeOperation="screen");const j=O.highlightPasses;for(let S=0;S<j;S++){const mt=S/(j-1),tt=Math.max(1,n*(.96-.7*mt)),Tt=.15*(1-mt)*(1-mt)*a;y.lineWidth=tt,qt(y,c),y.strokeStyle=`rgba(255,255,255,${Tt.toFixed(3)})`,y.stroke()}if(O.edgePasses>0){y.globalCompositeOperation="multiply";const S=O.edgePasses;for(let mt=0;mt<S;mt++){const tt=mt/(S-1),Tt=Math.max(1,n*(.98-.08*tt)),jt=(.1-.03*tt)*a;y.lineWidth=Tt,qt(y,c),y.strokeStyle=`rgba(0,0,0,${Math.max(0,jt).toFixed(3)})`,y.stroke()}}y.restore(),Ot.set(s,i,e,n,{canvas:L,normalizedWidth:P,normalizedHeight:N,pad:m,normMinX:d,normMinY:u,lastUsed:0,accessCount:0,memoryBytes:P*N*4,pathSignature:Ot.generatePathSignature(s)});const M=s[0],Y=s[s.length-1],z=c[c.length-1],X=Math.atan2(Y.y-M.y,Y.x-M.x),ft=Math.atan2(z.y,z.x),Q=X-ft;t.save(),t.globalAlpha=Math.max(0,Math.min(1,r)),t.translate(M.x,M.y),t.rotate(Q),t.drawImage(L,d-m,u-m),t.restore()}function Jt(t,s,e,n,o,i=1,r){const a=o.hitcircle,l=o.hitcircleoverlay,c=n*2/(a.width||128),d=Math.max(1,Math.round(a.width*c)),u=Math.max(1,Math.round(a.height*c));if(t.save(),t.translate(s,e),t.globalAlpha=i,r){const f=`${a.src}|${r}|${d}x${u}`;let C=Wt.get(f);if(!C){C=document.createElement("canvas"),C.width=d,C.height=u;const m=C.getContext("2d");m.drawImage(a,0,0,d,u),m.globalCompositeOperation="source-in",m.fillStyle=r,m.fillRect(0,0,d,u),Wt.set(f,C)}t.drawImage(C,-d/2,-u/2,d,u)}else t.drawImage(a,-d/2,-u/2,d,u);l&&t.drawImage(l,-d/2,-u/2,d,u),t.restore()}function me(t,s,e,n,o,i,r){const a=i.approachcircle,l=n*2/(a.width||128),c=Math.max(1,Math.round(a.width*l)),d=Math.max(1,Math.round(a.height*l));if(t.save(),t.globalAlpha=.6*o,t.translate(s,e),r){const u=`${a.src}|approach|${r}|${c}x${d}`;let f=Wt.get(u);if(!f){f=document.createElement("canvas"),f.width=c,f.height=d;const C=f.getContext("2d");C.drawImage(a,0,0,c,d),C.globalCompositeOperation="source-in",C.fillStyle=r,C.fillRect(0,0,c,d),Wt.set(u,f)}t.drawImage(f,-c/2,-d/2,c,d)}else t.drawImage(a,-c/2,-d/2,c,d);t.restore()}function Ke(t,s,e,n,o,i=1){const r=o.sliderfollowcircle,a=n*2/(r.width||256),l=r.width*a,c=r.height*a;t.save(),t.globalAlpha=.9*It(i),t.translate(s,e),t.drawImage(r,-l/2,-c/2,l,c),t.restore()}function ge(t,s,e,n,o,i,r=1){var m;if(!o.digits||i<=0)return;const l=String(i).split("").map(P=>o.digits[Number(P)]),c=((m=l[0])==null?void 0:m.height)||32,u=n*.82*.85/c,f=l.reduce((P,N)=>P+((N==null?void 0:N.width)||20)*u,0);let C=s-f/2;t.save(),t.globalAlpha=r;for(const P of l){const N=((P==null?void 0:P.width)||20)*u,L=((P==null?void 0:P.height)||20)*u;t.drawImage(P,C,e-L/2,N,L),C+=N}t.restore()}function He(t,s,e){const n=Math.max(1,Math.round(s)),o=`${t.src}|ball|${e}|${n}`;let i=Wt.get(o);if(!i){i=document.createElement("canvas"),i.width=n,i.height=n;const r=i.getContext("2d");r.clearRect(0,0,n,n),r.drawImage(t,0,0,n,n),r.globalCompositeOperation="multiply",r.fillStyle=e,r.fillRect(0,0,n,n),r.globalCompositeOperation="destination-in",r.drawImage(t,0,0,n,n),Wt.set(o,i)}return i}function Qt(t,s,e,n,o,i,r,a,l){const c=Math.max(1,o),d=c/Math.max(1,s.width||128),u=(s.width||128)*d,f=(s.height||128)*d;if(t.save(),t.translate(e,n),t.rotate(i),l?t.globalCompositeOperation="lighter":t.globalCompositeOperation="source-over",r&&r!=="#ffffff"&&r!=="rgba(255,255,255,1)"){const C=He(s,c,r);t.globalAlpha=a,t.drawImage(C,-u/2,-f/2,u,f)}else t.globalAlpha=a,t.drawImage(s,-u/2,-f/2,u,f);t.restore()}function Ge(t,s,e,n,o,i){const r=t.createRadialGradient(s-n*.3,e-n*.3,n*.15,s,e,n);r.addColorStop(0,"rgba(255,255,255,1)"),r.addColorStop(1,o),t.save(),t.globalAlpha=i,t.fillStyle=r,t.beginPath(),t.arc(s,e,n,0,Math.PI*2),t.fill(),t.restore()}function Xt(t){return t*(2-t)}function Yt(t,s,e,n){const o=n&&n<0?100/-n:1,i=100*e*o;return t.length/Math.max(1e-6,i)*s}function Ve(t,s,e,n,o){const i=n&&n<0?100/-n:1,r=100*e*i,a=t.length/Math.max(1e-6,r),l=1/Math.max(1e-6,o),c=[];for(let d=l;d<a-.001;d+=l){const u=d/a;u>0&&u<1&&c.push(u)}return c}function Te(t,s,e){let n=1/0;for(let o=1;o<e.pts.length;o++){const i=e.pts[o-1],r=e.pts[o],a=r.x-i.x,l=r.y-i.y,c=a*a+l*l;let d=0;c>0&&(d=((t-i.x)*a+(s-i.y)*l)/c,d=Math.max(0,Math.min(1,d)));const u=i.x+a*d,f=i.y+l*d,C=Math.hypot(u-t,f-s);C<n&&(n=C)}return n}function Ft(t,s,e){const n=3*e;return{x:t-n,y:s-n}}function ue(t){const s=(t==null?void 0:t.hitObjects.length)||0,e=new Array(s).fill(0),n=new Array(s).fill(1);if(!t)return{colorIndex:e,number:n};let o=0,i=0;for(let r=0;r<s;r++){const a=t.hitObjects[r];a.newCombo?(o=o+1+(a.comboSkip||0),i=1):i=(i||1)+1,e[r]=o,n[r]=i}return{colorIndex:e,number:n}}function qe(t){const s=(t==null?void 0:t.hitObjects.length)||0,e=new Array(s).fill(0);if(!t)return e;const n=t.hitObjects,o=60,i=3;for(let r=1;r<s;r++){const a=n[r-1],l=n[r];if(l.time-a.time<=o){const d=l.x-a.x,u=l.y-a.y;if(Math.hypot(d,u)<=i){e[r]=e[r-1]+1;continue}}if(a.kind==="slider"){const d=Kt(t,a),u=Gt(t,a),f=l.time-d;if(f<=o&&f>=-o){const C=_t(l),m=C.x-u.x,P=C.y-u.y;Math.hypot(m,P)<=i&&(e[r]=e[r-1]+1)}}}return e}function Kt(t,s){if(s.kind==="circle")return s.time;if(s.kind==="spinner")return s.endTime;const{base:e,inherited:n}=$t(t,s.time),o=(e==null?void 0:e.beatLength)??500,i=n==null?void 0:n.beatLength,r=Yt(s,o,ne(t.difficulty).SliderMultiplier,i),a=Math.max(1,s.slides);return s.time+r*a}function Gt(t,s){if(s.kind==="circle")return _t(s);if(s.kind==="spinner")return{x:At/2,y:Nt/2};const e=s,n=Ht(e.curveType,e.points),o=e.length;let i=n;if(o>0&&o<n.total){const f=oe(n,o),C={pts:f,segLen:[],cumLen:[0],total:o};for(let m=1;m<f.length;m++){const P=f[m].x-f[m-1].x,N=f[m].y-f[m-1].y,L=Math.hypot(P,N);C.segLen.push(L),C.cumLen.push(C.cumLen[C.cumLen.length-1]+L)}i=C}const{base:r,inherited:a}=$t(t,e.time),l=(r==null?void 0:r.beatLength)??500,c=a==null?void 0:a.beatLength;Yt(e,l,ne(t.difficulty).SliderMultiplier,c);const u=(Math.max(1,e.slides)-1)%2===0;return Ut(i,u?1:0)}function _t(t){if(t.kind==="circle"){const e=t;return typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:{x:t.x,y:t.y}}if(t.kind==="spinner")return{x:At/2,y:Nt/2};const s=t;return typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:{x:t.x,y:t.y}}function de(t,s,e,n,o,i,r,a){if(i!==void 0&&r!==void 0&&a!==void 0&&!(i>=r-a&&i<r+240))return!1;const l=t-e,c=s-n;return Math.hypot(l,c)<=o}function Je(t,s,e,n,o,i,r,a){if(a!==void 0){const L=Kt(o,e);if(!(n>=e.time-a&&n<L+240))return!1}const l=_t(e),c=Gt(o,e),d=Ft(l.x,l.y,r);if(de(t,s,d.x,d.y,i))return!0;const u=Ft(c.x,c.y,r);if(de(t,s,u.x,u.y,i))return!0;let f=Ht(e.curveType,e.points);const C=e.length;if(C>0&&C<f.total){const L=oe(f,C),y={pts:L,segLen:[],cumLen:[0],total:C};for(let R=1;R<L.length;R++){const g=L[R].x-L[R-1].x,I=L[R].y-L[R-1].y,O=Math.hypot(g,I);y.segLen.push(O),y.cumLen.push(y.cumLen[y.cumLen.length-1]+O)}f=y}const m={x:d.x-l.x,y:d.y-l.y},P={pts:f.pts.map(L=>({x:L.x+m.x,y:L.y+m.y})),segLen:f.segLen,cumLen:f.cumLen,total:f.total};return Te(t,s,P)<=i}function Qe(t,s,e,n){if(t.kind==="circle"){const m=Ft(t.x,t.y,n);return{minX:m.x-e,minY:m.y-e,maxX:m.x+e,maxY:m.y+e}}if(t.kind==="spinner"){const m={x:At/2,y:Nt/2};return{minX:m.x-e,minY:m.y-e,maxX:m.x+e,maxY:m.y+e}}const o=t,i=Ht(o.curveType,o.points),r=_t(o),a=Gt(s,o),l=Ft(r.x,r.y,n),c=Ft(a.x,a.y,n);let d=Math.min(l.x,c.x),u=Math.min(l.y,c.y),f=Math.max(l.x,c.x),C=Math.max(l.y,c.y);for(const m of i.pts){const P=Ft(m.x,m.y,n);d=Math.min(d,P.x),u=Math.min(u,P.y),f=Math.max(f,P.x),C=Math.max(C,P.y)}return{minX:d-e,minY:u-e,maxX:f+e,maxY:C+e}}function pe(t,s,e,n,o){const i=[],r=t.hitObjects,a=1200,l=2e3,c=e-a,d=e+l,u=c-1e4;let f=0,C=r.length;for(;f<C;){const I=f+C>>>1;r[I].time<u?f=I+1:C=I}const m=f;for(f=0,C=r.length;f<C;){const I=f+C>>>1;r[I].time<=d?f=I+1:C=I}const P=f,N=Math.max(0,Math.min(At,s.minX)),L=Math.max(0,Math.min(Nt,s.minY)),y=Math.max(0,Math.min(At,s.maxX)),R=Math.max(0,Math.min(Nt,s.maxY));if(y<=N||R<=L)return[];const g={minX:N,minY:L,maxX:y,maxY:R};for(let I=m;I<P;I++){const O=r[I];let j=O.time;O.kind==="slider"?j=Kt(t,O):O.kind==="spinner"&&(j=O.endTime);const M=O.time;if(!(j>=c&&M<=d))continue;const z=o[I]||0,X=Qe(O,t,n,z);!(X.maxX<g.minX||X.minX>g.maxX||X.maxY<g.minY||X.minY>g.maxY)&&i.push(I)}return i}class Ze{constructor(){Rt(this,"cache",new Map);Rt(this,"maxSize",50);Rt(this,"accessCounter",0);Rt(this,"shapeUsageMap",new Map);Rt(this,"totalMemoryBytes",0);Rt(this,"memoryBudgetBytes");Rt(this,"stats",{hits:0,misses:0,totalRenders:0,cacheSize:0,lastFrameHits:0,lastFrameMisses:0,uniqueShapesInMap:0,get hitRate(){const s=this.hits+this.misses;return s>0?this.hits/s*100:0},get totalDrawCalls(){return this.hits+this.misses}});this.memoryBudgetBytes=this.calculateMemoryBudget()}getStats(){return this.stats.cacheSize=this.cache.size,{...this.stats}}resetFrameStats(){this.stats.lastFrameHits=0,this.stats.lastFrameMisses=0}getMaxSize(){return this.maxSize}getMemoryUsage(){return this.totalMemoryBytes}getMemoryBudget(){return this.memoryBudgetBytes}calculateMemoryBudget(){const s=navigator.hardwareConcurrency||4,e=navigator.deviceMemory||4;return s<=4||e<=4?30*1024*1024:s<=8||e<=8?50*1024*1024:80*1024*1024}resetStats(){this.stats.hits=0,this.stats.misses=0,this.stats.totalRenders=0}normalizePath(s){if(s.length<2)return s;const e=s[0],n=s.map(a=>({x:a.x-e.x,y:a.y-e.y}));let o=0;for(let a=1;a<n.length;a++){const l=n[a].x-n[a-1].x,c=n[a].y-n[a-1].y,d=Math.hypot(l,c);o+=d}if(o<1e-6)return n;const i=n[n.length-1],r=Math.atan2(i.y,i.x);if(Math.hypot(i.x,i.y)>.001){const a=Math.cos(-r),l=Math.sin(-r);return n.map(c=>({x:c.x*a-c.y*l,y:c.x*l+c.y*a}))}return n}generatePathSignature(s){if(s.length<2)return"empty";const e=this.normalizePath(s),n=Math.min(32,e.length),o=[];if(e.length<=n)for(const r of e)o.push(`${r.x.toFixed(3)},${r.y.toFixed(3)}`);else for(let r=0;r<n;r++){const a=Math.floor(r/(n-1)*(e.length-1)),l=e[a];o.push(`${l.x.toFixed(3)},${l.y.toFixed(3)}`)}let i=0;for(let r=1;r<e.length-1;r++){const a=e[r-1],l=e[r],c=e[r+1],d=l.x-a.x,u=l.y-a.y,f=c.x-l.x,C=c.y-l.y,m=Math.atan2(u,d),P=Math.atan2(C,f);i+=Math.abs(P-m)}return`${o.join("|")}-curv:${i.toFixed(2)}`}hashPath(s,e,n,o){if(s.length<2)return`empty-${e}-${Math.round(n)}-${Math.round(o)}`;const i=this.normalizePath(s),r=Math.min(14,i.length),a=[];if(i.length<=r)for(const P of i)a.push(`${P.x.toFixed(2)},${P.y.toFixed(2)}`);else for(let P=0;P<r;P++){const N=Math.floor(P/(r-1)*(i.length-1)),L=i[N];a.push(`${L.x.toFixed(2)},${L.y.toFixed(2)}`)}let l=0;for(let P=1;P<i.length;P++){const N=i[P].x-i[P-1].x,L=i[P].y-i[P-1].y;l+=Math.hypot(N,L)}let c=0;for(let P=1;P<i.length-1;P++){const N=i[P-1],L=i[P],y=i[P+1],R=L.x-N.x,g=L.y-N.y,I=y.x-L.x,O=y.y-L.y,j=Math.atan2(g,R),M=Math.atan2(O,I);c+=Math.abs(M-j)}const d=Math.round(n),u=Math.round(o),f=l.toFixed(1),C=c.toFixed(2);return`${a.join("|")}-len:${f}-curv:${C}-pts:${s.length}-${e}-${d}-${u}`}get(s,e,n,o){if(s.length<2)return null;const i=this.hashPath(s,e,n,o),r=this.cache.get(i);if(r){r.lastUsed=++this.accessCounter,r.accessCount++;const a=this.shapeUsageMap.get(i);a&&a.accessCount++,this.stats.hits++,this.stats.lastFrameHits++;const l=this.normalizePath(s),c=s[0],d=s[s.length-1],u=l[l.length-1],f=Math.atan2(d.y-c.y,d.x-c.x),C=Math.atan2(u.y,u.x);let m=f-C;for(;m>Math.PI;)m-=2*Math.PI;for(;m<-Math.PI;)m+=2*Math.PI;return{entry:r,transform:{tx:c.x,ty:c.y,angle:m,scale:1}}}return this.stats.misses++,this.stats.lastFrameMisses++,null}shouldCache(s,e,n,o,i){if(o>2e3||i>2e3)return!1;let a=0;for(let l=1;l<s.length;l++){const c=s[l].x-s[l-1].x,d=s[l].y-s[l-1].y;a+=Math.hypot(c,d)}return!(a<20)}set(s,e,n,o,i){const r=this.hashPath(s,e,n,o),a=i.canvas.width*i.canvas.height*4;if(i.memoryBytes=a,i.pathSignature=this.generatePathSignature(s),i.accessCount=0,(this.cache.size>=this.maxSize||this.totalMemoryBytes+a>this.memoryBudgetBytes)&&!this.cache.has(r)){let d=!1;if(this.shapeUsageMap.size>0){const u=[];for(const[f,C]of this.shapeUsageMap.entries())C.lastUsageTime<Date.now()-5e3&&u.push(f);if(u.length>0)for(const f of u)this.cache.delete(f),this.shapeUsageMap.delete(f),d=!0}d||this.evictByMemory(a)}const c=this.cache.get(r);c&&(this.totalMemoryBytes-=c.memoryBytes),i.lastUsed=++this.accessCounter,this.cache.set(r,i),this.totalMemoryBytes+=a,this.stats.totalRenders++}evictByMemory(s){const e=s+this.memoryBudgetBytes*.1,n=[],o=Date.now();for(const[r,a]of this.cache.entries()){const l=this.shapeUsageMap.get(r),c=l?l.lastUsageTime<o:!1,d=a.accessCount,u=a.memoryBytes;let f=0;c&&(f+=1e3),f+=u/1e3,f-=d*10,f+=(this.accessCounter-a.lastUsed)/100,n.push({key:r,entry:a,score:f})}n.sort((r,a)=>a.score-r.score);let i=0;for(const r of n){if(i>=e)break;this.cache.delete(r.key),this.shapeUsageMap.delete(r.key),this.totalMemoryBytes-=r.entry.memoryBytes,i+=r.entry.memoryBytes}}clear(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0}clearAll(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0,this.memoryBudgetBytes=this.calculateMemoryBudget()}renderShapeToCanvas(s,e,n,o,i){if(s.length<2)return null;let r=1/0,a=1/0,l=-1/0,c=-1/0;for(const g of s)g.x<r&&(r=g.x),g.y<a&&(a=g.y),g.x>l&&(l=g.x),g.y>c&&(c=g.y);const d=Math.ceil(Math.max(e,n)/2)+2,u=Math.max(1,Math.ceil(l-r+d*2)),f=Math.max(1,Math.ceil(c-a+d*2));if(!this.shouldCache(s,e,n,u,f))return null;const C=document.createElement("canvas");C.width=u,C.height=f;const m=C.getContext("2d",{willReadFrequently:!1});m.save(),m.translate(-r+d,-a+d),m.lineCap="round",m.lineJoin="round",m.globalCompositeOperation="source-over",m.globalAlpha=1,m.lineWidth=e,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let g=1;g<s.length;g++)m.lineTo(s[g].x,s[g].y);m.strokeStyle=o,m.stroke();const P=this.rgbFromCss(i)||{r:255,g:255,b:255},N=`rgba(${P.r}, ${P.g}, ${P.b}, 1)`;m.lineWidth=n,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let g=1;g<s.length;g++)m.lineTo(s[g].x,s[g].y);m.strokeStyle=N,m.stroke();const L=je(),y=Ce[L];m.globalCompositeOperation="soft-light",m.globalCompositeOperation!=="soft-light"&&(m.globalCompositeOperation="screen");const R=y.highlightPasses;for(let g=0;g<R;g++){const I=g/(R-1),O=Math.max(1,n*(.96-.7*I)),j=.15*(1-I)*(1-I);m.lineWidth=O,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let M=1;M<s.length;M++)m.lineTo(s[M].x,s[M].y);m.strokeStyle=`rgba(255,255,255,${j.toFixed(3)})`,m.stroke()}if(y.edgePasses>0){m.globalCompositeOperation="multiply";const g=y.edgePasses;for(let I=0;I<g;I++){const O=I/(g-1),j=Math.max(1,n*(.98-.08*O)),M=.1-.03*O;m.lineWidth=j,m.beginPath(),m.moveTo(s[0].x,s[0].y);for(let Y=1;Y<s.length;Y++)m.lineTo(s[Y].x,s[Y].y);m.strokeStyle=`rgba(0,0,0,${Math.max(0,M).toFixed(3)})`,m.stroke()}}return m.restore(),{canvas:C,minX:r,minY:a,pad:d}}rgbFromCss(s){const e=s.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(e){const o=e[1],i=o.length===3?o.split("").map(c=>c+c).join(""):o,r=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),l=parseInt(i.slice(4,6),16);return{r,g:a,b:l}}const n=s.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return n?{r:Number(n[1]),g:Number(n[2]),b:Number(n[3])}:null}precalculateShapes(s,e,n,o,i=240,r="#ffffff"){if(this.shapeUsageMap.clear(),!s||!s.hitObjects)return;const a=o*2,l=Math.max(1,a-8),c=Math.max(1,a-14),d=ue(s),u=new Set,f=[];for(let I=0;I<s.hitObjects.length;I++){const O=s.hitObjects[I];if(O.kind!=="slider")continue;const j=O,M=Ht(j.curveType,j.points),Y=j.length;let z=M;if(Y>0&&Y<M.total){const B=oe(M,Y),et={pts:B,segLen:[],cumLen:[0],total:Y};for(let xt=1;xt<B.length;xt++){const W=B[xt].x-B[xt-1].x,F=B[xt].y-B[xt-1].y,h=Math.hypot(W,F);et.segLen.push(h),et.cumLen.push(et.cumLen[et.cumLen.length-1]+h)}z=et}const X=d.colorIndex[I],ft=n[X%n.length],Q=this.hashPath(z.pts,ft,l,c);u.add(Q);const{base:S,inherited:mt}=$t(s,j.time),tt=(S==null?void 0:S.beatLength)??500,Tt=mt==null?void 0:mt.beatLength,jt=Yt(j,tt,e.SliderMultiplier,Tt),U=Math.max(1,j.slides),lt=j.time+jt*U+i,K=f.find(B=>B.cacheKey===Q);K?(lt>K.lastUsageTime&&(K.lastUsageTime=lt),K.sliderIndices.push(I)):f.push({cacheKey:Q,pts:z.pts,comboColor:ft,lastUsageTime:lt,sliderIndices:[I]})}const C=u.size;this.stats.uniqueShapesInMap=C;const m=200*200*4,P=Math.floor(this.memoryBudgetBytes/m);this.maxSize=Math.min(Math.ceil(C*.8),P,200);const N=6200,L=f.filter(I=>{var j;return I.sliderIndices.length>1?!0:(((j=s.hitObjects[I.sliderIndices[0]])==null?void 0:j.time)||1/0)<=N});for(const I of f)this.shapeUsageMap.set(I.cacheKey,{cacheKey:I.cacheKey,lastUsageTime:I.lastUsageTime,sliderIndices:I.sliderIndices,accessCount:0,isPreRendered:!1});const y=15;let R=0;const g=()=>{const I=R*y,O=Math.min(I+y,L.length);for(let j=I;j<O;j++){const M=L[j],Y=this.normalizePath(M.pts),z=this.renderShapeToCanvas(Y,l,c,r,M.comboColor);if(z){const X={canvas:z.canvas,normalizedWidth:z.canvas.width,normalizedHeight:z.canvas.height,pad:z.pad,normMinX:z.minX,normMinY:z.minY,lastUsed:0,accessCount:0,memoryBytes:z.canvas.width*z.canvas.height*4,pathSignature:this.generatePathSignature(M.pts)};this.set(M.pts,M.comboColor,l,c,X);const ft=this.shapeUsageMap.get(M.cacheKey);ft&&(ft.isPreRendered=!0)}}R++,O<L.length&&(typeof requestIdleCallback<"u"?requestIdleCallback(g,{timeout:100}):setTimeout(g,0))};L.length>0&&(typeof requestIdleCallback<"u"?requestIdleCallback(g,{timeout:100}):setTimeout(g,0))}evictExpiredShapes(s){const e=[];for(const[n,o]of this.shapeUsageMap.entries())if(o.lastUsageTime<s){const i=this.cache.get(n);if(i){let r=0;r+=i.memoryBytes/1e3,r-=i.accessCount*10,r-=o.accessCount*5,r+=(this.accessCounter-i.lastUsed)/100,e.push({key:n,entry:i,info:o,score:r})}}e.sort((n,o)=>o.score-n.score);for(const n of e)this.cache.has(n.key)&&(this.cache.delete(n.key),this.totalMemoryBytes-=n.entry.memoryBytes),this.shapeUsageMap.delete(n.key);this.totalMemoryBytes>this.memoryBudgetBytes&&this.evictByMemory(0)}}const Ot=new Ze;function ts(){const t=navigator.hardwareConcurrency||4,s=navigator.deviceMemory||4;return t<=4||s<=4?"low":t<=8||s<=8?"medium":"high"}const Ce={high:{highlightPasses:16,edgePasses:3},medium:{highlightPasses:10,edgePasses:2},low:{highlightPasses:8,edgePasses:1}};let ie=null;function je(){return ie===null&&(ie=ts()),ie}function ae(t,s,e,n,o,i,r,a,l,c,d,u,f,C,m="core",P=1,N=240,L,y){if(e.kind==="circle"){if(m!=="core")return;const R=e.time-r,g=n<=e.time?It((n-R)/Math.max(1,a)):1,I=n<=e.time?1:It(1-(n-e.time)/400);let O=It(g*I);if(y!==void 0&&(O=Math.max(O,y)),O<=.001)return;const j=typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:Ft(e.x,e.y,f);if(o!=null&&o.approachcircle){const Y=1+2*It((e.time-n)/Math.max(1,r));me(t,j.x,j.y,i*Y,.8*O,o,d)}o!=null&&o.hitcircle?(t.save(),Jt(t,j.x,j.y,i,o,O,d),o!=null&&o.digits&&ge(t,j.x,j.y,i,o,u,O),t.restore()):(t.save(),t.globalAlpha=O,Vt(t,j.x,j.y,i,d),t.restore())}else if(e.kind==="slider"){const R=Ht(e.curveType,e.points);let g,I,O,j,M;if(L)g=L.base,I=L.inherited,O=L.baseBeat,j=L.ih,M=L.span??Yt(e,O,l,j);else{const W=$t(s,e.time);g=W.base,I=W.inherited,O=(g==null?void 0:g.beatLength)??500,j=I==null?void 0:I.beatLength,M=Yt(e,O,l,j)}const Y=Math.max(1,e.slides),z=e.time+M*Y,X=e.time-r,ft=Math.max(1,Math.floor(r*.4)),Q=Math.max(1,N);let S=0;n<X?S=0:n<e.time?S=It((n-X)/ft):n<=z?S=1:S=It(1-(n-z)/Q),y!==void 0&&(S=Math.max(S,y));const mt=e.length;let tt=R;if(mt>0&&mt<R.total){const W=oe(R,mt),F={pts:W,segLen:[],cumLen:[0],total:mt};for(let h=1;h<W.length;h++){const ut=W[h].x-W[h-1].x,A=W[h].y-W[h-1].y,nt=Math.hypot(ut,A);F.segLen.push(nt),F.cumLen.push(F.cumLen[F.cumLen.length-1]+nt)}tt=F}const Tt=tt.pts,jt=!!C&&Te(C.x,C.y,tt)<=Math.max(6,i*.35),U=typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:Ft(e.x,e.y,f),V={x:U.x-e.x,y:U.y-e.y},lt=Tt.map(W=>({x:W.x+V.x,y:W.y+V.y})),K=i*2,B=Math.max(1,K-8),et=Math.max(1,K-14),xt=(o==null?void 0:o.sliderBorder)||"#ffffff";if(m==="body"){if(S<=.01)return;_e(t,lt,B,et,xt,d,S,1);return}if(m==="core"){const W=e.time+M*Y,F=W-r,h=n<=W?It((n-F)/Math.max(1,a)):1,ut=n<=W?1:It(1-(n-W)/400);let A=It(h*ut)*S;y!==void 0&&(A=Math.max(A,y));const nt=(Y-1)%2===0,gt=Ut(tt,nt?1:0),pt={x:gt.x+V.x,y:gt.y+V.y};if(A>.001&&(o!=null&&o.hitcircle?Jt(t,pt.x,pt.y,i,o,A,d):(t.save(),t.globalAlpha=A,Vt(t,pt.x,pt.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const yt=i*2/(o.sliderendcircle.width||128),G=o.sliderendcircle.width*yt,D=o.sliderendcircle.height*yt;t.save(),t.globalAlpha=A,t.translate(pt.x,pt.y),t.drawImage(o.sliderendcircle,-G/2,-D/2,G,D),t.restore()}if(Y>1)for(let yt=0;yt<Y-1;yt++){const D=yt%2===0?1:0,q=Ut(tt,D),rt={x:q.x+V.x,y:q.y+V.y},vt=e.time+M*(yt+1),Pt=vt-r,St=n<=vt?It((n-Pt)/Math.max(1,a)):1,Mt=n<=vt?1:It(1-(n-vt)/400),wt=It(St*Mt);if(wt>0&&(o!=null&&o.hitcircle?Jt(t,rt.x,rt.y,i,o,wt,d):(t.save(),t.globalAlpha=wt,Vt(t,rt.x,rt.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const x=i*2/(o.sliderendcircle.width||128),T=o.sliderendcircle.width*x,at=o.sliderendcircle.height*x;t.save(),t.globalAlpha=wt,t.translate(rt.x,rt.y),t.drawImage(o.sliderendcircle,-T/2,-at/2,T,at),t.restore()}}const $=U,w=e.time-r,H=n<=e.time?It((n-w)/Math.max(1,a)):1,dt=n<=e.time?1:It(1-(n-e.time)/400);let Z=It(H*dt)*S;if(y!==void 0&&(Z=Math.max(Z,y)),Z>.001)if(o!=null&&o.hitcircle){if(t.save(),Jt(t,$.x,$.y,i,o,Z,d),o.sliderstartcircle){const yt=o.sliderstartcircle,G=i*2/(yt.width||128),D=yt.width*G,q=yt.height*G;t.drawImage(yt,$.x-D/2,$.y-q/2,D,q)}o!=null&&o.digits&&ge(t,$.x,$.y,i,o,u,Z),t.restore()}else t.save(),t.globalAlpha=Z,Vt(t,$.x,$.y,i,d),t.restore();if(o!=null&&o.approachcircle&&Z>.001){const G=1+2*It((e.time-n)/Math.max(1,r));me(t,$.x,$.y,i*G,.8*Z,o,d)}}if(m==="top"&&(y!==void 0||n>=e.time&&n<=z)){let W=n-e.time,F=0,h=0;y!==void 0&&(n<e.time||n>z)?n<e.time?(W=0,F=0,h=0):(W=z-e.time,F=Y-1,h=1):(W=n-e.time,F=Math.floor(W/M),h=W%M/M);const A=F%2===0?h:1-h,nt=Ut(tt,A),gt={x:nt.x+V.x,y:nt.y+V.y};o!=null&&o.sliderfollowcircle&&S>.001&&Ke(t,gt.x,gt.y,i*1.6,o,S);const pt=Math.max(4,Math.max(1,K-6)),$=It(S);if($<=.001)return;const w=.1/Math.max(1,tt.total),H=Math.max(0,Math.min(1-w,A)),dt=Math.min(1,A+w),ht=Ut(tt,H),Z=Ut(tt,dt),yt=ht.x-Z.x,G=ht.y-Z.y,q=(-90+-Math.atan2(yt,G)*180/Math.PI)*Math.PI/180,rt=o==null?void 0:o.sliderballFrames,vt=rt&&rt.length>0,Pt=!!(o!=null&&o.sliderb),St=tt.total/(M*Y),Mt=Math.max(.15/St*(1e3/60),1e3/60),wt=vt?Math.floor(W/Mt)%rt.length:0,x=d;if(o!=null&&o.sliderbnd&&Qt(t,o.sliderbnd,gt.x,gt.y,pt,0,"#000000",$,!1),vt){const T=rt[wt];Qt(t,T,gt.x,gt.y,pt,q,x,$,!1)}else Pt?Qt(t,o.sliderb,gt.x,gt.y,pt,q,x,$,!1):Ge(t,gt.x,gt.y,pt/2,d,$);o!=null&&o.sliderbspec&&Qt(t,o.sliderbspec,gt.x,gt.y,pt,0,"#ffffff",$,!0)}if(m==="top"&&(o!=null&&o.reversearrow)&&Y>1){let W=-1;for(let F=0;F<Y-1;F++){const h=e.time+M*(F+1);if(n<h){W=F;break}}for(let F=0;F<Y-1;F++){if(W===-1)continue;let h=!1;if((F===W||W>0&&F===W-1)&&(h=!0),!h)continue;const ut=F%2===0,nt=Ut(tt,ut?1:0),gt={x:nt.x+V.x,y:nt.y+V.y},pt=De(tt,ut?1-.001:.001)+(ut?Math.PI:0),$=e.time+M*(F+1),w=$-r,H=300,dt=150,ht=((Math.min(n,$)-w)%H+H)%H;let Z=0,yt=1;if(n>$){const G=1.3-Xt(ht/H)*.3,D=1.4-G,q=Math.min(300,M),rt=It((n-$)/q);yt=G+Xt(rt)*D,Z=Xt(1-rt)}else if(n>=w){Z=It((n-w)/dt);const G=35,D=250;if(ht<G)yt=1+Xt(ht/G)*.3;else{const q=(ht-G)/(G+D);yt=1.3-Xt(q)*.3}}if(Z*=S,Z>.01){t.save(),t.globalAlpha=Z,t.translate(gt.x,gt.y),t.rotate(pt),t.scale(yt,yt);const G=i*2*.72/(o.reversearrow.width||128),D=o.reversearrow.width*G,q=o.reversearrow.height*G;t.drawImage(o.reversearrow,-D/2,-q/2,D,q),t.restore()}}}if(m==="top"&&(o!=null&&o.sliderscorepoint)){const F={x:e.x+V.x,y:e.y+V.y},h=(Y-1)%2===0,ut=Ut(tt,h?1:0),A={x:ut.x+V.x,y:ut.y+V.y};for(let nt=0;nt<Y;nt++){const gt=nt%2===1,pt=Ve(e,O,l,j,c);for(const $ of pt){const w=gt?1-$:$,H=Ut(tt,w),dt={x:H.x+V.x,y:H.y+V.y},ht=e.time+M*nt+M*$,Z=Math.hypot(dt.x-F.x,dt.y-F.y),yt=Math.hypot(dt.x-A.x,dt.y-A.y);if(Z<i||yt<i)continue;const G=ht-r;let D=0;if(n<ht?D=It((n-G)/Math.max(1,a)):D=It(1-(n-ht)/200),D*=S,D<=.001)continue;const q=i*.15;t.save(),t.globalAlpha=D,t.translate(dt.x,dt.y);const rt=o.sliderscorepoint,vt=q*2/(rt.width||64);t.drawImage(rt,-rt.width*vt/2,-rt.height*vt/2,rt.width*vt,rt.height*vt),t.restore()}}}if(m==="top"&&jt&&e.points.length>0){t.save(),t.globalAlpha=S,t.strokeStyle="#efefef",t.lineWidth=1,t.beginPath();const W=e.points[0];t.moveTo(W.x+V.x,W.y+V.y);for(let h=1;h<e.points.length;h++){const ut=e.points[h];t.lineTo(ut.x+V.x,ut.y+V.y)}t.stroke();const F=h=>{if(h===0)return!1;if(e.curveType!=="B")return h>0;const ut=e.points[h-1],A=e.points[h];return ut.x===A.x&&ut.y===A.y};for(let h=0;h<e.points.length;h++){const ut=e.points[h],A=ut.x+V.x,nt=ut.y+V.y;h===0?t.fillStyle="#efefef":F(h)?t.fillStyle="#ff0000":e.curveType==="B"?t.fillStyle="#efefef":t.fillStyle="#ff0000",t.beginPath(),t.arc(A,nt,2,0,Math.PI*2),t.fill()}t.restore()}}else if(e.kind==="spinner"){if(m!=="core")return;const R=At/2,g=Nt/2,I=e.time-r,O=800,j=e.endTime;if(y===void 0&&(n<I||n>j+O))return;let M=1;if(n<e.time?M=It((n-I)/Math.max(1,a)):n>=e.time&&(M=1-It((n-j)/O)),y!==void 0&&(M=Math.max(M,y)),M<=.001)return;const Y=15;if(o!=null&&o.spinnerBottom){const z=o.spinnerBottom,X=Y*2/(z.width||128),ft=z.width*X,Q=z.height*X;t.save(),t.globalAlpha=M,t.translate(R,g),t.drawImage(z,-ft/2,-Q/2,ft,Q),t.restore()}else t.save(),t.globalAlpha=M,t.beginPath(),t.arc(R,g,Y,0,Math.PI*2),t.strokeStyle="#f9d66b",t.lineWidth=3,t.stroke(),t.restore();if(o!=null&&o.spinnerApproachcircle){const z=o.spinnerApproachcircle,ft=Nt*.9/2,Q=Y,S=50,mt=j-e.time;let tt=0,Tt=ft;if(n>=I&&n<j+S){if(n<e.time){const jt=Math.min(a,r);tt=Math.min(1,Math.max(0,(n-I)/Math.max(1,jt))),Tt=ft}else if(n>=e.time){const jt=It((n-e.time)/Math.max(1,mt));tt=(1-It((n-j)/S))*.9,Tt=ft-(ft-Q)*jt}if(tt>.001){const jt=Tt*2/(z.width||128),U=z.width*jt,V=z.height*jt;t.save(),t.globalAlpha=tt,t.translate(R,g),t.drawImage(z,-U/2,-V/2,U,V),t.restore()}}}}}function es(t,s,e,n,o,i,r,a){const l=r.followpoint,c=32;for(let d=0;d<e.length-1;d++){const u=e[d].obj,f=e[d+1].obj,C=e[d].idx,m=e[d+1].idx,P=Kt(s,u);if(f.time-P<=0||f.newCombo)continue;const L=Gt(s,u),y=_t(f),R=Ft(L.x,L.y,a[C]||0),g=Ft(y.x,y.y,a[m]||0),I=g.x-R.x,O=g.y-R.y,j=Math.hypot(I,O);if(j<80)continue;const M=Math.floor((j-48)/c);if(M<=0)continue;const Y=u.kind==="slider"?Kt(s,u):u.time,X=f.time-Y;if(X<=0)continue;const ft=Math.atan2(O,I),S=Math.max(4,i*.15)*2/(l.width||64),mt=Math.max(1,Math.floor(o*.4));t.save(),t.globalCompositeOperation="source-over",t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high";for(let tt=0;tt<M;tt++){const jt=c*(1.5+tt)/j;if(jt>=1)continue;const U=Y+jt*X,V=U-o;let lt=0;if(n<V)lt=0;else if(n<V+mt){const et=(n-V)/mt;lt=Xt(It(et))}else if(n<U)lt=1;else{const et=(n-U)/mt;lt=1-Xt(It(et))}if(lt<=0)continue;const K=R.x+I*jt,B=R.y+O*jt;t.save(),t.globalAlpha=.9*lt,t.translate(K,B),t.rotate(ft),t.drawImage(l,-(l.width*S)/2,-(l.height*S)/2,l.width*S,l.height*S),t.restore()}t.restore()}}function Pe(t,s,e){const r=v.useRef(null),a=v.useRef(null),l=v.useRef(0);v.useEffect(()=>{const c=t.current;if(!c)return;const d=()=>{const C=c.getBoundingClientRect(),m=Math.floor(C.width),P=Math.floor(C.height);r.current&&r.current.width===m&&r.current.height===P||(r.current={width:m,height:P},a.current!==null&&clearTimeout(a.current),a.current=window.setTimeout(()=>{const N=performance.now();N-l.current>=100&&(l.current=N,s())},100))},u=window.ResizeObserver;let f=null;return u?(f=new u(d),f.observe(c)):window.addEventListener("resize",d),d(),()=>{f?f.disconnect():window.removeEventListener("resize",d),a.current!==null&&clearTimeout(a.current)}},[t,s,100,100])}const ye=({beatmap:t,timeSec:s,backgroundUrl:e,skin:n,sliderBodyCutoffPx:o=1,sliderFadeOutMs:i=240,selectedIndices:r=new Set,onSelectionChange:a})=>{const l=v.useRef(null),c=v.useRef(null),[d,u]=kt.useState(0),[f,C]=kt.useState(0),[m,P]=kt.useState(null),[N,L]=kt.useState(Ot.getStats()),y=v.useRef(0),[R,g]=kt.useState(0),I=v.useRef({lastTime:performance.now(),frameCount:0,fps:0}),[O,j]=kt.useState(!1),M=v.useRef(null),[Y,z]=kt.useState(!1),X=v.useMemo(()=>ne(t==null?void 0:t.difficulty),[t]),ft=v.useRef(!1),Q=v.useRef(null),S=v.useRef(null),mt=v.useRef(null),tt=v.useRef(null),Tt=v.useRef(null),[jt,U]=kt.useState(0),[V,lt]=kt.useState(!1);v.useEffect(()=>{if(M.current){const A=M.current.parentElement,nt=!!(A!=null&&A.classList.contains("playfield-container")&&!A.closest(".embed-preview-playfield")&&!A.closest(".embed-preview-body"));z(nt)}},[]);const K=v.useMemo(()=>Me(X.CS),[X.CS]),B=v.useMemo(()=>Se(X.AR),[X.AR]),et=v.useMemo(()=>ke(X.AR),[X.AR]),xt=v.useMemo(()=>{var gt;const A=(gt=t==null?void 0:t.colors)==null?void 0:gt.comboColors;if(A&&A.length)return A;const nt=n==null?void 0:n.comboColors;return nt&&nt.length?nt:["#FF66AA","#99CCFF","#99FF99","#FFFF66"]},[t==null?void 0:t.colors,n==null?void 0:n.comboColors]),W=v.useMemo(()=>ue(t),[t]),F=v.useMemo(()=>qe(t),[t]);v.useEffect(()=>{if(!e){c.current=null;return}const A=new Image;return A.onload=()=>{c.current=A,u(nt=>nt+1)},A.onerror=()=>{c.current=null,u(nt=>nt+1)},A.src=e,c.current=A,()=>{A.onload=null,A.onerror=null}},[e]);const h=v.useCallback(()=>{C(A=>A+1)},[]);Pe(l,h),v.useEffect(()=>{const A=l.current;if(!A)return;Ot.evictExpiredShapes(s*1e3);const nt=window.devicePixelRatio||1,gt=A.getBoundingClientRect(),pt=Math.max(100,gt.width),$=Math.max(100,gt.height);A.width=Math.round(pt*nt),A.height=Math.round($*nt);const w=A.getContext("2d",{willReadFrequently:!1});w.setTransform(nt,0,0,nt,0,0),w.globalCompositeOperation="source-over",w.clearRect(0,0,pt,$),w.fillStyle="#02060d",w.fillRect(0,0,pt,$);const H=c.current;if(H&&H.complete){const D=Math.max(pt/H.width,$/H.height),q=H.width*D,rt=H.height*D;w.globalAlpha=.2,w.drawImage(H,(pt-q)/2,($-rt)/2,q,rt),w.globalAlpha=1}const dt=16,ht=Math.min((pt-dt*2)/At,($-dt*2)/Nt),Z=(pt-At*ht)/2,yt=($-Nt*ht)/2;if(w.save(),w.translate(Z,yt),w.scale(ht,ht),w.strokeStyle="#2a3955",w.lineWidth=2/ht,w.strokeRect(0,0,At,Nt),t){const D=s*1e3,q=1200,rt=2e3,vt=t.hitObjects,Pt=D-q,St=D+rt,Mt=Pt-1e4;let wt=0,x=vt.length;for(;wt<x;){const b=wt+x>>>1;vt[b].time<Mt?wt=b+1:x=b}const T=wt;for(wt=0,x=vt.length;wt<x;){const b=wt+x>>>1;vt[b].time<=St?wt=b+1:x=b}const at=wt,J=[],_=new Set;for(let b=T;b<at;b++){const E=vt[b],ct=E.time;let st=ct+600,it;if(E.kind==="spinner")st=E.endTime;else if(E.kind==="slider"){const{base:ot,inherited:bt}=$t(t,E.time),Ct=(ot==null?void 0:ot.beatLength)??500,Et=bt==null?void 0:bt.beatLength,Lt=Yt(E,Ct,X.SliderMultiplier,Et);st=E.time+Lt*Math.max(1,E.slides),it={base:ot,inherited:bt,baseBeat:Ct,ih:Et,span:Lt}}st>=Pt&&ct<=St&&(J.push({o:E,idx:b,startTime:ct,endTime:st,timing:it}),_.add(b))}for(const b of r){if(_.has(b))continue;const E=vt[b];if(!E)continue;const ct=E.time;let st=ct+600,it;if(E.kind==="spinner")st=E.endTime;else if(E.kind==="slider"){const{base:ot,inherited:bt}=$t(t,E.time),Ct=(ot==null?void 0:ot.beatLength)??500,Et=bt==null?void 0:bt.beatLength,Lt=Yt(E,Ct,X.SliderMultiplier,Et);st=E.time+Lt*Math.max(1,E.slides),it={base:ot,inherited:bt,baseBeat:Ct,ih:Et,span:Lt}}J.push({o:E,idx:b,startTime:ct,endTime:st,timing:it,isSelected:!0})}J.sort((b,E)=>b.startTime!==E.startTime?b.startTime-E.startTime:b.idx-E.idx);const k=J.map(b=>({obj:b.o,idx:b.idx}));n!=null&&n.followpoint&&es(w,t,k,D,B,K,n,F);for(let b=J.length-1;b>=0;b--){const{o:E,idx:ct,timing:st,isSelected:it}=J[b],ot=xt[W.colorIndex[ct]%xt.length],bt=W.number[ct],Ct=F[ct],Lt=it===!0?.3:void 0;E.kind==="slider"&&ae(w,t,E,D,n,K,B,et,X.SliderMultiplier,X.SliderTickRate,ot,bt,Ct,m,"body",o,i,st,Lt),ae(w,t,E,D,n,K,B,et,X.SliderMultiplier,X.SliderTickRate,ot,bt,Ct,m,"core",o,i,st,Lt),E.kind==="slider"&&ae(w,t,E,D,n,K,B,et,X.SliderMultiplier,X.SliderTickRate,ot,0,Ct,m,"top",o,i,st,Lt)}for(const b of r){const E=vt[b];if(E){if(w.save(),w.strokeStyle="#f59e0b",w.lineWidth=2/ht,w.globalAlpha=.8,E.kind==="circle"){const ct=typeof E.stackedX=="number"&&typeof E.stackedY=="number"?{x:E.stackedX,y:E.stackedY}:Ft(E.x,E.y,F[b]);w.beginPath(),w.arc(ct.x,ct.y,K+3,0,Math.PI*2),w.stroke()}else if(E.kind==="slider"){const ct=_t(E),st=Gt(t,E),it=Ft(ct.x,ct.y,F[b]),ot=Ft(st.x,st.y,F[b]);w.beginPath(),w.arc(it.x,it.y,K+3,0,Math.PI*2),w.stroke(),w.beginPath(),w.arc(ot.x,ot.y,K+3,0,Math.PI*2),w.stroke()}w.restore()}}}if(w.restore(),V&&Q.current&&S.current){const q=Math.min((pt-32)/At,($-32)/Nt),rt=(pt-At*q)/2,vt=($-Nt*q)/2,Pt=rt+Math.min(Q.current.x,S.current.x)*q,St=vt+Math.min(Q.current.y,S.current.y)*q,Mt=rt+Math.max(Q.current.x,S.current.x)*q,wt=vt+Math.max(Q.current.y,S.current.y)*q;w.save(),w.strokeStyle="#f59e0b",w.fillStyle="rgba(245, 158, 11, 0.1)",w.lineWidth=2,w.globalAlpha=.5,w.fillRect(Pt,St,Mt-Pt,wt-St),w.strokeRect(Pt,St,Mt-Pt,wt-St),w.restore()}if(y.current++,y.current%10===0){const D=Ot.getStats();L(D),Ot.resetFrameStats()}const G=performance.now();I.current.frameCount++,G-I.current.lastTime>=1e3&&(I.current.fps=I.current.frameCount,I.current.frameCount=0,I.current.lastTime=G,g(I.current.fps))},[t,s,e,d,K,B,et,n,X.SliderMultiplier,X.SliderTickRate,o,i,f,m,r,F,jt,V]);const ut=v.useCallback((A,nt)=>{const gt=l.current;if(!gt)return null;const pt=gt.getBoundingClientRect(),$=16,w=Math.min((pt.width-$*2)/At,(pt.height-$*2)/Nt),H=(pt.width-At*w)/2,dt=(pt.height-Nt*w)/2,ht=(A-pt.left-H)/w,Z=(nt-pt.top-dt)/w;return ht>=0&&ht<=At&&Z>=0&&Z<=Nt?{x:ht,y:Z}:null},[]);return v.useEffect(()=>{const A=l.current;if(!A||!t||!a)return;const nt=w=>{const H=ut(w.clientX,w.clientY);if(P(H||null),ft.current&&mt.current){mt.current[1]={x:w.clientX,y:w.clientY};const dt=ut(mt.current[0].x,mt.current[0].y),ht=ut(mt.current[1].x,mt.current[1].y);if(dt&&ht){Q.current=dt,S.current=ht,U(G=>G+1);const Z={minX:Math.min(dt.x,ht.x),minY:Math.min(dt.y,ht.y),maxX:Math.max(dt.x,ht.x),maxY:Math.max(dt.y,ht.y)};if(Math.hypot(ht.x-dt.x,ht.y-dt.y)>0){const G=pe(t,Z,s*1e3,K,F);new Set(G);const D=(w.ctrlKey||w.metaKey)&&tt.current?new Set(tt.current):new Set;for(const q of G)D.add(q);a(D)}}else U(Z=>Z+1)}},gt=w=>{if(w.button!==0)return;const H=ut(w.clientX,w.clientY);if(!H)return;mt.current=[{x:w.clientX,y:w.clientY},{x:w.clientX,y:w.clientY}];const dt=s*1e3,ht=[],Z=B+2e3,yt=dt-Z,G=dt+Z;let D=0,q=t.hitObjects.length;for(;D<q;){const Mt=D+q>>>1;t.hitObjects[Mt].time<yt?D=Mt+1:q=Mt}const rt=D;for(D=0,q=t.hitObjects.length;D<q;){const Mt=D+q>>>1;t.hitObjects[Mt].time<=G?D=Mt+1:q=Mt}const vt=D;for(let Mt=rt;Mt<vt;Mt++){const wt=t.hitObjects[Mt],x=F[Mt];if(wt.kind==="circle"){const T=Ft(wt.x,wt.y,x);de(H.x,H.y,T.x,T.y,K,dt,wt.time,B)&&ht.push(Mt)}else wt.kind==="slider"&&Je(H.x,H.y,wt,dt,t,K,x,B)&&ht.push(Mt)}ht.sort((Mt,wt)=>t.hitObjects[Mt].time-t.hitObjects[wt].time);const Pt=ht[0],St=new Set(r);if(!w.ctrlKey&&!w.metaKey&&St.clear(),Pt!==void 0){if(ft.current=!1,lt(!1),Q.current=null,S.current=null,mt.current=null,tt.current=null,w.shiftKey&&Tt.current!==null){const Mt=Math.min(Tt.current,Pt),wt=Math.max(Tt.current,Pt);for(let x=Mt;x<=wt;x++)St.add(x)}else St.add(Pt);Tt.current=Pt,a(St)}else ft.current=!0,lt(!0),Q.current=H,S.current=H,tt.current=new Set(r),U(Mt=>Mt+1),!w.ctrlKey&&!w.metaKey&&(a(new Set),tt.current=new Set)},pt=w=>{if(ft.current&&Q.current&&S.current){const H={minX:Math.min(Q.current.x,S.current.x),minY:Math.min(Q.current.y,S.current.y),maxX:Math.max(Q.current.x,S.current.x),maxY:Math.max(Q.current.y,S.current.y)};if(Math.hypot(S.current.x-Q.current.x,S.current.y-Q.current.y)>0){const ht=pe(t,H,s*1e3,K,F),Z=w.ctrlKey||w.metaKey?new Set(r):new Set;for(const yt of ht)Z.add(yt);a(Z)}ft.current=!1,lt(!1),Q.current=null,S.current=null,mt.current=null,tt.current=null,U(ht=>ht+1)}},$=()=>{P(null)};return A.addEventListener("mousemove",nt),A.addEventListener("mousedown",gt),A.addEventListener("mouseup",pt),A.addEventListener("mouseleave",$),()=>{A.removeEventListener("mousemove",nt),A.removeEventListener("mousedown",gt),A.removeEventListener("mouseup",pt),A.removeEventListener("mouseleave",$);const w=A.getContext("2d");w&&w.clearRect(0,0,A.width,A.height)}},[t,s,K,F,r,a,ut,B]),p.jsxs("div",{ref:M,style:{position:"relative",width:"100%",height:"100%"},children:[p.jsx("canvas",{ref:l,className:"playfield",style:{width:"100%",height:"100%",display:"block"}}),Y&&p.jsxs("div",{style:{position:"absolute",top:"8px",right:"8px",background:"#0d111e",color:"#cdd6f4",borderRadius:"4px",fontFamily:"monospace",fontSize:O?"11px":"12px",lineHeight:"1.4",minWidth:O?"220px":"auto",zIndex:1e3,border:"1px solid rgba(255, 255, 255, 0.1)",overflow:"hidden"},children:[p.jsxs("div",{style:{padding:O?"8px 12px":"4px 8px",cursor:"pointer",userSelect:"none",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:O?"1px solid rgba(255,255,255,0.1)":"none",gap:"8px"},onClick:()=>j(!O),children:[O?p.jsx("span",{style:{fontWeight:600,color:"#cdd6f4",textTransform:"lowercase"},children:"performance"}):p.jsxs("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 6px",borderRadius:"4px"},children:[R," fps"]}),p.jsx("span",{style:{color:"#89b4fa",fontSize:"10px"},children:O?"▼":"▶"})]}),O&&p.jsxs("div",{style:{padding:"12px"},children:[p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"fps:"}),p.jsx("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:R})]}),p.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"slider cache (cumulative)"}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"total draw calls:"}),p.jsx("span",{style:{color:"#89b4fa"},children:N.totalDrawCalls.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache hits:"}),p.jsx("span",{style:{color:"#89b4fa"},children:N.hits.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache misses:"}),p.jsx("span",{style:{color:"#89b4fa"},children:N.misses.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hit rate:"}),p.jsxs("span",{style:{color:"#89b4fa",background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:[N.hitRate.toFixed(1),"%"]})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"unique shapes:"}),p.jsxs("span",{style:{color:"#89b4fa"},children:[N.uniqueShapesInMap||N.totalRenders," (cached: ",N.cacheSize,")"]})]}),p.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"per frame (last 10)"}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"draw calls/frame:"}),p.jsx("span",{style:{color:"#89b4fa"},children:(N.lastFrameHits+N.lastFrameMisses).toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hits/frame:"}),p.jsx("span",{style:{color:"#89b4fa"},children:N.lastFrameHits.toLocaleString()})]}),p.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px"},children:[p.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"misses/frame:"}),p.jsx("span",{style:{color:"#89b4fa"},children:N.lastFrameMisses.toLocaleString()})]})]})]})]})},xe=({isPlaying:t,onPlayPause:s,currentTime:e,duration:n,onSeek:o,onScrubStart:i,onScrubEnd:r,bpm:a,sliderVelocity:l,timingPoints:c})=>{const d=v.useRef(null),u=v.useRef(null),f=v.useRef(null),[C,m]=v.useState(!1),P=v.useRef(null),N=v.useRef(!1),L=j=>{const M=Math.max(0,Math.floor(j*1e3)),Y=Math.floor(M/6e4)%100,z=Math.floor(M%6e4/1e3)%60,X=Math.floor(M%1e3);return`${String(Y).padStart(2,"0")}:${String(z).padStart(2,"0")}.${String(X).padStart(3,"0")}`},y=v.useCallback(j=>{if(!d.current)return 0;const M=d.current.getBoundingClientRect(),Y=j-M.left;return Math.max(0,Math.min(1,Y/M.width))*n},[n]),R=j=>{m(!0),i==null||i();const M=y(j.clientX);o(M)},g=j=>{if(j.preventDefault(),j.touches.length===0)return;m(!0),i==null||i();const M=y(j.touches[0].clientX);o(M)},I=j=>{if(j.preventDefault(),!Number.isFinite(n)||n<=0)return;N.current||(N.current=!0,i==null||i()),P.current!==null&&clearTimeout(P.current);const M=j.shiftKey?1:.1,Y=j.deltaY>0?1:-1,z=Math.max(0,Math.min(n,e+Y*M));o(z),P.current=window.setTimeout(()=>{N.current=!1,r==null||r(),P.current=null},150)};v.useEffect(()=>()=>{P.current!==null&&clearTimeout(P.current)},[]),v.useEffect(()=>{if(!C)return;const j=X=>{const ft=y(X.clientX);o(ft)},M=X=>{if(X.preventDefault(),X.touches.length===0)return;const ft=y(X.touches[0].clientX);o(ft)},Y=()=>{m(!1),r==null||r()},z=X=>{if(f.current&&X.changedTouches.length>0){const ft=X.changedTouches[0],Q=document.elementFromPoint(ft.clientX,ft.clientY);Q&&f.current.contains(Q)&&X.preventDefault()}m(!1),r==null||r()};return window.addEventListener("mousemove",j),window.addEventListener("mouseup",Y),window.addEventListener("touchmove",M,{passive:!1}),window.addEventListener("touchend",z),window.addEventListener("touchcancel",z),()=>{window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",Y),window.removeEventListener("touchmove",M),window.removeEventListener("touchend",z),window.removeEventListener("touchcancel",z)}},[C,n,o,r,y]);const O=n>0?Math.max(0,Math.min(1,e/n)):0;return v.useEffect(()=>{const j=d.current,M=u.current;if(!j||!M)return;const Y=j.getBoundingClientRect(),z=Math.max(1,Math.floor(Y.width)),X=Math.max(1,Math.floor(Y.height)),ft=window.devicePixelRatio||1;(M.width!==Math.round(z*ft)||M.height!==Math.round(X*ft))&&(M.width=Math.round(z*ft),M.height=Math.round(X*ft));const Q=M.getContext("2d");Q.setTransform(ft,0,0,ft,0,0),Q.clearRect(0,0,z,X);const S=Array.isArray(c)?c:[];for(let tt=0;tt<S.length;tt++){const Tt=S[tt],jt=S[tt+1];if(typeof Tt.effects=="number"&&(Tt.effects&1)===1){const V=Math.max(0,Tt.time/1e3),lt=Math.min(n,(jt?jt.time:n*1e3)/1e3);if(lt>V){const K=Math.floor(V/n*z),B=Math.ceil(lt/n*z);Q.fillStyle="rgba(245, 158, 11, 0.4)";const et=Math.max(1,Math.round(X/1.6)),xt=Math.round((X-et)/2);Q.fillRect(K,xt,Math.max(1,B-K),et)}}}const mt=(tt,Tt,jt)=>{const U=Math.max(0,tt.time/1e3),V=Math.floor(U/(n||1)*z),lt=Math.max(1,Math.round(jt)),K=lt/2,B=X-lt/2;Q.save(),Q.strokeStyle=Tt,Q.lineWidth=lt,Q.lineCap="round",Q.beginPath(),Q.moveTo(V+.5,K),Q.lineTo(V+.5,B),Q.stroke(),Q.restore()};for(const tt of S)(typeof tt.uninherited=="number"?tt.uninherited===1:(tt.beatLength||0)>0)||mt(tt,"#22c55e",2);for(const tt of S)(typeof tt.uninherited=="number"?tt.uninherited===1:(tt.beatLength||0)>0)&&mt(tt,"#ef4444",3)},[c,n]),p.jsxs("div",{className:"editor-controls-container",ref:f,children:[p.jsxs("div",{className:"controls-timestamp",children:[p.jsx("div",{className:"timestamp-display",children:L(e)}),p.jsxs("div",{className:"timing-info",children:[p.jsxs("span",{className:"bpm-display",children:[a.toFixed(0),"BPM"]}),p.jsx("span",{className:"sv-display",children:n>0?`${Math.round(e/n*100)}%`:"0%"})]})]}),p.jsxs("div",{className:"controls-center",children:[p.jsx("button",{className:"controls-play-button",onClick:s,title:t?"Pause (Space)":"Play (Space)",children:t?p.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:[p.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),p.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]}):p.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:p.jsx("path",{d:"M8 5v14l11-7z"})})}),p.jsx("div",{className:"controls-progress-wrapper",ref:d,onMouseDown:R,onTouchStart:g,onWheel:I,children:p.jsxs("div",{className:"progress-bar-track",children:[p.jsx("canvas",{ref:u,className:"progress-markers"}),p.jsx("div",{className:"progress-bar-fill",style:{width:`${O*100}%`}}),p.jsx("div",{className:"progress-bar-thumb",style:{left:`${O*100}%`}})]})})]})]})},ve=({masterVolume:t,songVolume:s,hitsoundVolume:e,onMasterVolumeChange:n,onSongVolumeChange:o,onHitsoundVolumeChange:i})=>{const[r,a]=v.useState(!1),l=v.useRef(null),c=v.useRef(null);v.useEffect(()=>{if(!r)return;const u=f=>{l.current&&!l.current.contains(f.target)&&c.current&&!c.current.contains(f.target)&&a(!1)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[r]);const d=u=>`${Math.round(u*100)}%`;return p.jsxs("div",{className:"volume-control-wrapper",children:[p.jsx("button",{ref:c,className:"volume-control-button",onClick:u=>{u.stopPropagation(),a(!r)},"aria-label":"Volume controls","aria-expanded":r,children:t>0?p.jsx(Be,{size:20}):p.jsx(Ae,{size:20})}),r&&p.jsxs("div",{ref:l,className:"volume-control-menu",children:[p.jsxs("div",{className:"volume-control-item",children:[p.jsx("label",{className:"volume-label",children:"Master"}),p.jsxs("div",{className:"volume-slider-container",children:[p.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:t,onChange:u=>n(parseFloat(u.target.value)),className:"volume-slider"}),p.jsx("span",{className:"volume-value",children:d(t)})]})]}),p.jsxs("div",{className:"volume-control-item",children:[p.jsx("label",{className:"volume-label",children:"Song"}),p.jsxs("div",{className:"volume-slider-container",children:[p.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:s,onChange:u=>o(parseFloat(u.target.value)),className:"volume-slider"}),p.jsx("span",{className:"volume-value",children:d(s)})]})]}),p.jsxs("div",{className:"volume-control-item",children:[p.jsx("label",{className:"volume-label",children:"Hitsounds"}),p.jsxs("div",{className:"volume-slider-container",children:[p.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,onChange:u=>i(parseFloat(u.target.value)),className:"volume-slider"}),p.jsx("span",{className:"volume-value",children:d(e)})]})]})]})]})};async function we(t){const s=await Fe.loadAsync(t instanceof File?t:new Blob([t])),e=Object.keys(s.files);async function n(r){const a=s.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("text")}async function o(r){const a=s.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("arraybuffer")}function i(r){return e.find(r)}return{list:e,readText:n,readArrayBuffer:o,findFirst:i}}function Zt(t){const s=t.indexOf(":");if(s===-1)return null;const e=t.slice(0,s).trim(),n=t.slice(s+1).trim();return[e,n]}function ce(t){const s=t.split(/\r?\n/);let e="";const n={},o={},i={},r=[],a=[],l={comboColors:[]};let c="osu file format v?";for(let L=0;L<s.length;L++){const R=s[L].trim();if(R){if(L===0&&/^osu file format/.test(R)){c=R;continue}if(R.startsWith("[")&&R.endsWith("]")){e=R.slice(1,-1);continue}if(!R.startsWith("//"))switch(e){case"General":{const g=Zt(R);g&&(n[g[0]]=g[1]);break}case"Metadata":{const g=Zt(R);g&&(o[g[0]]=g[1]);break}case"Difficulty":{const g=Zt(R);if(!g)break;const I=Number(g[1]);i[g[0]]=Number.isFinite(I)?I:g[1];break}case"TimingPoints":{const g=R.split(",").map(O=>O.trim()),I={time:Number(g[0]||0),beatLength:Number(g[1]||0),meter:Number(g[2]||4),sampleSet:g[3]?Number(g[3]):void 0,sampleIndex:g[4]?Number(g[4]):void 0,volume:g[5]?Number(g[5]):void 0,uninherited:g[6]?Number(g[6]):void 0,effects:g[7]?Number(g[7]):void 0};r.push(I);break}case"Colours":{const g=Zt(R);if(!g)break;const[I,O]=g,j=M=>{const Y=M.split(",").map(S=>S.trim());if(Y.length<3)return null;const z=Math.max(0,Math.min(255,Number(Y[0]||0))),X=Math.max(0,Math.min(255,Number(Y[1]||0))),ft=Math.max(0,Math.min(255,Number(Y[2]||0))),Q=S=>S.toString(16).padStart(2,"0");return`#${Q(z)}${Q(X)}${Q(ft)}`};if(/^Combo\d+$/i.test(I)){const M=j(O);M&&l.comboColors.push(M)}else if(/^SliderBorder$/i.test(I)){const M=j(O);M&&(l.sliderBorder=M)}else if(/^SliderTrackOverride$/i.test(I)){const M=j(O);M&&(l.sliderTrackOverride=M)}break}case"HitObjects":{const g=R.split(","),I=Number(g[0]),O=Number(g[1]),j=Number(g[2]),M=Number(g[3]),Y=Number(g[4]||0),z=Q=>{if(!Q||!Q.includes(":"))return;const S=Q.split(":"),mt=S[0]!==""?Number(S[0]):void 0,tt=S[1]!==""?Number(S[1]):void 0,Tt=S[2]!==""?Number(S[2]):void 0,jt=S[3]!==""?Number(S[3]):void 0,U=S[4]&&S[4]!==""?S[4]:void 0;return{sampleSet:mt,additionSet:tt,customIndex:Tt,sampleVolume:jt,filename:U}},X=(M&4)===4,ft=(M&112)>>4;if((M&1)===1){const Q=z(g[5]);a.push({kind:"circle",x:I,y:O,time:j,hitSound:Y,hitSample:Q,newCombo:X,comboSkip:ft})}else if((M&2)===2){const Q=String(g[5]||""),[S,...mt]=Q.split("|"),tt=(S||"B").slice(0,1).toUpperCase(),Tt=Number(g[6]||1),jt=Number(g[7]||0),U=[{x:I,y:O}];for(const et of mt){const[xt,W]=et.split(":");xt&&W&&U.push({x:Number(xt),y:Number(W)})}let V;g[8]&&(V=String(g[8]).split("|").map(et=>Number(et||0)));let lt;g[9]&&(lt=String(g[9]).split("|").map(et=>{const[xt,W]=et.split(":"),F=xt&&xt!==""?Number(xt):void 0,h=W&&W!==""?Number(W):void 0;return{sampleSet:F,additionSet:h}}));const K=g[g.length-1],B=z(K);a.push({kind:"slider",x:I,y:O,time:j,hitSound:Y,curveType:tt,points:U,slides:Tt,length:jt,edgeSounds:V,edgeSets:lt,hitSample:B,newCombo:X,comboSkip:ft})}else if((M&8)===8){const Q=Number(g[5]||j),S=z(g[6]);a.push({kind:"spinner",time:j,endTime:Q,hitSample:S,newCombo:X,comboSkip:ft})}break}}}}const d=Number(n.Mode||"0"),f=["standard","taiko","catch","mania"][Math.max(0,Math.min(3,d))],C=n.AudioFilename;let m;const P=s.findIndex(L=>L.trim()==="[Events]");if(P!==-1)for(let L=P+1;L<s.length;L++){const y=s[L].trim();if(!y||y.startsWith("["))break;const R=y.match(/\"([^\"]+)\"/);if(R){m=R[1];break}}const N={comboColors:l.comboColors.length?l.comboColors:void 0,sliderBorder:l.sliderBorder,sliderTrackOverride:l.sliderTrackOverride};return{format:c,mode:f,general:n,metadata:o,difficulty:i,timingPoints:r,hitObjects:a,audioFilename:C,backgroundFilename:m,colors:N}}async function ss(t,s){var e,n,o,i;try{const r="https://esm.sh/osu-parsers@4.1.7?bundle",a="https://esm.sh/osu-standard-stable@5.0.1?bundle";let l,c;try{l=await import(r),c=await import(a)}catch{const y="osu-parsers",R="osu-standard-stable";l=await import(y),c=await import(R)}const d=new l.BeatmapDecoder,u=new c.StandardRuleset,f=u.applyToBeatmapWithMods(d.decodeFromString(t),u.createModCombination("")),C=c.Circle,m=c.Slider,P=c.Spinner,N=f.hitObjects.filter(y=>y instanceof C||y instanceof m||y instanceof P),L=Math.min(N.length,s.hitObjects.length);for(let y=0;y<L;y++){const R=N[y],g=s.hitObjects[y];if(R instanceof P)continue;const I=(R.startX??((e=R.startPosition)==null?void 0:e.x)??R.x??0)+(((n=R.stackedOffset)==null?void 0:n.x)??0),O=(R.startY??((o=R.startPosition)==null?void 0:o.y)??R.y??0)+(((i=R.stackedOffset)==null?void 0:i.y)??0);g.stackedX=I,g.stackedY=O}return s}catch{return s}}class ns{constructor(){Rt(this,"ctx",null);Rt(this,"buffer",null);Rt(this,"src",null);Rt(this,"gainNode",null);Rt(this,"startCtxTime",0);Rt(this,"startOffset",0);Rt(this,"_onTick");Rt(this,"raf",0);Rt(this,"_volume",1);Rt(this,"tick",()=>{this._onTick&&this._onTick(this.currentTime),this.raf=requestAnimationFrame(this.tick)})}get duration(){var s;return((s=this.buffer)==null?void 0:s.duration)??0}get volume(){return this._volume}set volume(s){this._volume=Math.max(0,Math.min(1,s)),this.gainNode&&(this.gainNode.gain.value=this._volume)}async load(s){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext));const e=await this.ctx.decodeAudioData(s.slice(0));this.buffer=e,this.stop()}ensureSrc(){!this.ctx||!this.buffer||(this.gainNode||(this.gainNode=this.ctx.createGain(),this.gainNode.gain.value=this._volume,this.gainNode.connect(this.ctx.destination)),this.src=this.ctx.createBufferSource(),this.src.buffer=this.buffer,this.src.connect(this.gainNode),this.src.onended=()=>{cancelAnimationFrame(this.raf),this.raf=0})}play(s){!this.ctx||!this.buffer||(this.stop(),this.ensureSrc(),this.src&&(this.startOffset=typeof s=="number"?s:this.currentTime,this.startCtxTime=this.ctx.currentTime,this.src.start(0,this.startOffset),this.tick()))}pause(){if(!this.ctx)return;const s=this.currentTime;this.stop(),this.startOffset=s}seek(s){if(!this.ctx)return;const e=!!this.src;this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,s)),e&&this.play(this.startOffset)}setPosition(s){this.ctx&&(this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,s)))}stop(){if(this.src){try{this.src.stop()}catch{}try{this.src.disconnect()}catch{}}this.src=null,this.raf&&cancelAnimationFrame(this.raf),this.raf=0}get isPlaying(){return!!this.src}get currentTime(){if(!this.ctx)return 0;if(!this.src)return Math.min(this.duration,this.startOffset);const s=this.ctx.currentTime-this.startCtxTime;return Math.max(0,Math.min(this.duration,this.startOffset+s))}onTick(s){this._onTick=s}getBuffer(){return this.buffer}getContext(){return this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx}}const te={1:"normal",2:"soft",3:"drum"};function os(t){const s=["hitnormal"];return t&2&&s.push("hitwhistle"),t&4&&s.push("hitfinish"),t&8&&s.push("hitclap"),s}class ee{constructor(s){Rt(this,"ctx");Rt(this,"buffers",new Map);Rt(this,"loading",null);Rt(this,"slideSrc",null);Rt(this,"slideGain",null);Rt(this,"whistleSrc",null);Rt(this,"whistleGain",null);Rt(this,"active",new Set);Rt(this,"masterGain",null);Rt(this,"_volume",1);this.ctx=s,this.masterGain=s.createGain(),this.masterGain.gain.value=this._volume,this.masterGain.connect(s.destination)}get volume(){return this._volume}set volume(s){this._volume=Math.max(0,Math.min(1,s)),this.masterGain&&(this.masterGain.gain.value=this._volume)}async load(s){if(s||(s="/img/"),s.endsWith("/")||(s+="/"),this.loading)return this.loading;const e=[];for(const n of["normal","soft","drum"])for(const o of["hitnormal","hitwhistle","hitfinish","hitclap","slidertick","sliderslide","sliderwhistle"])e.push(`${n}-${o}.wav`);return this.loading=(async()=>{await Promise.all(e.map(async n=>{try{const o=await fetch(s+n);if(!o.ok)return;const i=await o.arrayBuffer(),r=await this.ctx.decodeAudioData(i.slice(0));this.buffers.set(n,r)}catch{}}))})(),this.loading}playFile(s,e=0,n=.8){const o=this.buffers.get(s);if(!o)return;try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const i=this.ctx.createBufferSource(),r=this.ctx.createGain();r.gain.value=n,i.buffer=o,i.connect(r),this.masterGain?r.connect(this.masterGain):r.connect(this.ctx.destination);const a=Math.max(this.ctx.currentTime,e);i.onended=()=>{try{i.disconnect()}catch{}try{r.disconnect()}catch{}this.active.delete(i)};try{i.start(a)}catch{}this.active.add(i)}playWithFallback(s,e,n=0,o=.8){const i=[e,"normal","soft","drum"],r=new Set;for(const l of i){const c=`${l}-${s}.wav`;if(r.has(c))continue;if(r.add(c),this.buffers.get(c))return this.playFile(c,n,o),!0}const a=`${s}.wav`;return this.buffers.get(a)?(this.playFile(a,n,o),!0):!1}playHit(s,e,n){const o=os(e);for(const i of o)this.playFile(`${s}-${i}.wav`,n)}playTick(s,e){this.playFile(`${s}-slidertick.wav`,e,.7)}playReverse(s,e){this.playFile(`${s}-sliderwhistle.wav`,e,.8)}startLoop(s,e,n,o=.3){const i=[e,"normal","soft","drum"];let r;for(const c of i){const d=`${c}-${s}.wav`,u=this.buffers.get(d);if(u){r=u;break}}if(!r){const c=`${s}.wav`,d=this.buffers.get(c);if(d)r=d;else return}if(s==="sliderslide")this.stopSlide();else{if(this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const a=this.ctx.createBufferSource();a.buffer=r,a.loop=!0;const l=this.ctx.createGain();l.gain.value=typeof o=="number"?Math.max(0,Math.min(1,o)):.3,a.connect(l),this.masterGain?l.connect(this.masterGain):l.connect(this.ctx.destination);try{a.start(Math.max(this.ctx.currentTime,n||0))}catch{}s==="sliderslide"?(this.slideSrc=a,this.slideGain=l):(this.whistleSrc=a,this.whistleGain=l)}startSlide(s,e,n){this.startLoop("sliderslide",s,e,(typeof n=="number"?Math.max(0,Math.min(1,n)):1)*.3)}stopSlide(){if(this.slideSrc){try{this.slideSrc.stop()}catch{}try{this.slideSrc.disconnect()}catch{}this.slideSrc=null}if(this.slideGain){try{this.slideGain.disconnect()}catch{}this.slideGain=null}}startSliderLoops(s,e,n,o){this.startLoop("sliderslide",s,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.3),e&&this.startLoop("sliderwhistle",s,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.25)}stopSliderLoops(){if(this.stopSlide(),this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}stopAll(){this.stopSlide();for(const s of Array.from(this.active)){try{s.stop()}catch{}try{s.disconnect()}catch{}this.active.delete(s)}}}function rs(t,s){var r,a,l;const e=[],n=c=>{let d="normal";for(let u=0;u<t.timingPoints.length;u++){const f=t.timingPoints[u];if(f.time<=c&&f.sampleSet&&(d=te[f.sampleSet]||d),f.time>c)break}return d},o=(c,d,u,f)=>{const C=f&&f<0?100/-f:1,m=100*u*C;return c.length/Math.max(1e-6,m)*d},i=(c,d,u,f,C)=>{const m=f&&f<0?100/-f:1,P=100*u*m,N=c.length/Math.max(1e-6,P),L=1/Math.max(1e-6,C),y=[];for(let R=L;R<N-.001;R+=L){const g=R/N;g>0&&g<1&&y.push(g)}return y};for(const c of t.hitObjects)if(c.kind==="circle"){const d=n(c.time);e.push({timeMs:c.time,kind:"hit",set:d,bits:c.hitSound})}else if(c.kind==="slider"){const{base:d,inherited:u}=$t(t,c.time),f=(d==null?void 0:d.beatLength)??500,C=u==null?void 0:u.beatLength,m=o(c,f,s.SliderMultiplier,C),P=Math.max(1,c.slides),N=c.edgeSets&&((r=c.edgeSets[0])==null?void 0:r.sampleSet)&&te[c.edgeSets[0].sampleSet]||n(c.time),L=c.edgeSounds&&typeof c.edgeSounds[0]=="number"?c.edgeSounds[0]:c.hitSound;e.push({timeMs:c.time,kind:"hit",set:N,bits:L});const y=i(c,f,s.SliderMultiplier,C,s.SliderTickRate);for(let j=0;j<P;j++){const M=c.time+j*m;for(const Y of y)e.push({timeMs:M+Y*m,kind:"tick",set:N})}for(let j=1;j<P;j++){const M=c.time+j*m,Y=c.edgeSets&&((a=c.edgeSets[j])==null?void 0:a.sampleSet)&&te[c.edgeSets[j].sampleSet]||n(M),z=c.edgeSounds&&typeof c.edgeSounds[j]=="number"?c.edgeSounds[j]:c.hitSound;e.push({timeMs:M,kind:"reverse",set:Y,bits:z})}const R=c.time+m*P,g=P,I=c.edgeSets&&((l=c.edgeSets[g])==null?void 0:l.sampleSet)&&te[c.edgeSets[g].sampleSet]||n(R),O=c.edgeSounds&&typeof c.edgeSounds[g]=="number"?c.edgeSounds[g]:c.hitSound;e.push({timeMs:R,kind:"hit",set:I,bits:O})}else if(c.kind==="spinner"){const d=n(c.endTime);e.push({timeMs:c.endTime,kind:"hit",set:d,bits:0})}return e.sort((c,d)=>c.timeMs-d.timeMs),e}function is(t){const s={};let e="root";s[e]={};const n=t.split(/\r?\n/);for(let o of n){let i=o.trim();if(!i||i.startsWith(";")||i.startsWith("//"))continue;if(i.startsWith("[")&&i.endsWith("]")){e=i.slice(1,-1).trim(),s[e]||(s[e]={});continue}const r=i.indexOf("=");if(r===-1)continue;const a=i.slice(0,r).trim(),l=i.slice(r+1).trim();s[e][a]=l}return s}function as(t){const s=t.Colours||t.Colors||{},e=Object.keys(s).filter(o=>/^combo\d+/i.test(o)).sort((o,i)=>{const r=Number(o.replace(/[^\d]/g,"")),a=Number(i.replace(/[^\d]/g,""));return r-a}),n=[];for(const o of e){const r=s[o].split(",").map(a=>Number(a.trim())).filter(a=>Number.isFinite(a));r.length>=3&&n.push(Re(r[0],r[1],r[2]))}return n}function cs(t){const s=t.Colours||t.Colors||{},e=s.SliderBorder||s.sliderborder;if(!e)return null;const n=e.split(",").map(o=>Number(o.trim())).filter(o=>Number.isFinite(o));return n.length>=3?Re(n[0],n[1],n[2]):null}function Re(t,s,e){const n=i=>Math.max(0,Math.min(255,Math.round(i))),o=i=>n(i).toString(16).padStart(2,"0");return`#${o(t)}${o(s)}${o(e)}`}async function ls(t){t||(t="/img/"),t.endsWith("/")||(t+="/");const s={},e=async(a,l)=>{try{const c=await le(t+l);s[a]=c}catch{}};await Promise.all([e("hitcircle","hitcircle.png"),e("hitcircleoverlay","hitcircleoverlay.png"),e("approachcircle","approachcircle.png"),e("sliderfollowcircle","sliderfollowcircle.png"),e("followpoint","followpoint.png"),e("cursor","cursor.png"),e("cursortrail","cursortrail.png"),e("reversearrow","reversearrow.png"),e("sliderscorepoint","sliderscorepoint.png"),e("sliderstartcircle","sliderstartcircle.png"),e("sliderendcircle","sliderendcircle.png"),e("sliderb","sliderb.png"),e("sliderbnd","sliderb-nd.png"),e("sliderbspec","sliderb-spec.png"),e("spinnerApproachcircle","spinner-approachcircle.png"),e("spinnerBottom","spinner-bottom.png")]),s.sliderb||await e("sliderb","sliderb0.png");const n=[];for(let a=0;a<10;a++)try{const l=await le(t+`sliderb${a}.png`);n.push(l)}catch{}n.length&&(s.sliderballFrames=n);const o=[];for(let a=0;a<=9;a++){const l=`default-${a}.png`,c=le(t+l).then(d=>d).catch(()=>null);o.push(c)}const r=(await Promise.all(o)).filter(Boolean);r.length===10&&(s.digits=r);try{const a=await fetch(t+"skin.ini");if(a.ok){const l=await a.text(),c=is(l),d=as(c);d.length&&(s.comboColors=d);const u=cs(c);u&&(s.sliderBorder=u)}}catch{}return s}async function le(t){return new Promise((s,e)=>{const n=new Image;n.onload=()=>s(n),n.onerror=o=>e(o),n.src=t})}const hs=({open:t,onClose:s,downloadUrl:e,beatmapVersion:n,beatmapId:o})=>(kt.useEffect(()=>{if(t)return document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}},[t]),t?p.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",onClick:i=>i.stopPropagation(),children:[p.jsx("div",{className:"overlay-backdrop",onClick:s}),p.jsxs("div",{className:"overlay-card embed-preview-card",onClick:i=>i.stopPropagation(),children:[p.jsx("button",{className:"overlay-close",onClick:s,"aria-label":"Close embed preview",children:p.jsx(be,{size:18})}),p.jsx("div",{className:"embed-preview-body",onClick:i=>i.stopPropagation(),children:p.jsx(Oe,{downloadUrl:e,beatmapVersion:n,beatmapId:o,onOpenInEditor:()=>{s(),window.location.hash="/editor"}})})]})]}):null),se=1,ds={1:"#ffffff",2:"#ff0000",3:"#b706b7",4:"#3276e6",5:"#e6e605",6:"#843e84",7:"#e6e605",8:"#e6e605",9:"#e6e605"};function us(t,s){for(t=Math.abs(t),s=Math.abs(s);s;){const e=s;s=t%s,t=e}return t||1}const fs=({beatmap:t,currentTime:s,duration:e,onSeek:n,bookmarks:o,onScrubStart:i,onScrubEnd:r,scale:a,onScaleChange:l,beatSnapDivisor:c=4,onBeatSnapChange:d,skin:u,isPlaying:f,onPlayPause:C,selectedIndices:m=new Set,onSelectionChange:P})=>{const N=v.useRef(null),L=48,[y,R]=v.useState(a??.4),g=v.useRef(!1),I=v.useRef([0,0]),O=v.useRef(null),[,j]=v.useState(0),M=v.useRef(null),Y=v.useRef(!1);v.useEffect(()=>{a!==void 0&&R(a)},[a]);const z=(U,V,lt)=>V/2+(U-lt)/(se/y),X=(U,V,lt)=>lt+(U-V/2)*(se/y),ft=U=>[1,2,4,8,16].includes(U)?"even":[3,6,12].includes(U)?"triplets":"custom",Q=v.useRef(new Map),S=(U,V,lt)=>{const K=Math.max(1,Math.round(V)),B=`${U.src}|mini|${lt}|${K}`,et=Q.current,xt=et.get(B);if(xt)return xt;const W=document.createElement("canvas");W.width=K,W.height=K;const F=W.getContext("2d");return F.drawImage(U,0,0,K,K),F.globalCompositeOperation="multiply",F.fillStyle=lt,F.fillRect(0,0,K,K),F.globalCompositeOperation="destination-in",F.drawImage(U,0,0,K,K),et.set(B,W),W};function mt(U,V,lt,K,B,et){if(lt<=0)return;const xt=V==null?void 0:V.digits,W=Math.max(6,Math.floor(et*.75));if(xt&&xt.length===10){const h=String(lt).split("").map(nt=>xt[Number(nt)]),ut=h.reduce((nt,gt)=>nt+Math.max(1,Math.round(((gt==null?void 0:gt.width)||10)*(W/((gt==null?void 0:gt.height)||W)))),0);let A=K-ut/2;U.save();for(const nt of h){const gt=Math.max(1,Math.round(((nt==null?void 0:nt.width)||10)*(W/((nt==null?void 0:nt.height)||W)))),pt=W;nt&&U.drawImage(nt,A,B-pt/2,gt,pt),A+=gt}U.restore()}else U.save(),U.fillStyle="#fff",U.font=`bold ${W}px system-ui, sans-serif`,U.textAlign="center",U.textBaseline="middle",U.fillText(String(lt),K,B),U.restore()}function tt(U,V){const{base:lt,inherited:K}=$t(U,V.time),B=(lt==null?void 0:lt.beatLength)??500,et=K==null?void 0:K.beatLength,xt=et&&et<0?100/-et:1,F=100*Number(U.difficulty.SliderMultiplier??1)*xt;return V.length/Math.max(1e-6,F)*B}function Tt(U,V){return tt(U,V)*Math.max(1,V.slides)}const jt=v.useCallback(()=>{j(U=>U+1)},[]);return Pe(N,jt),v.useEffect(()=>{var pt;const U=N.current;if(!U)return;const V=window.devicePixelRatio||1,lt=Math.min(3,Math.max(1,V)),K=U.getBoundingClientRect(),B=Math.max(200,Math.min(K.width,1e4)),et=L,xt=16384,W=Math.min(xt,Math.max(1,Math.round(B*lt))),F=Math.min(xt,Math.max(1,Math.round(et*lt)));U.width=W,U.height=F;const h=U.getContext("2d");try{h.setTransform(lt,0,0,lt,0,0)}catch{}h.globalCompositeOperation="source-over",h.clearRect(0,0,B,et),h.fillStyle="#0f1626",h.fillRect(0,0,B,et);const ut=s*1e3,A=B/2*(se/y)+120,nt=ut-A,gt=ut+A;if(t){const{base:$}=$t(t,ut);if($&&$.beatLength>0){const w=$.beatLength,H=c,dt=$.time+w*Math.ceil((ut-$.time)/w),ht=Z=>{const yt=z(Z,B,ut);if(yt<-1||yt>B+1)return;const G=Math.round(Z-(Math.round((Z-$.time)/w)*w+$.time))===0,D=G&&Math.round((Z-$.time)/w)%($.meter||4)===0;let q="#cdd6f4";if(!G){const rt=Math.floor((Z-$.time)/w)*w+$.time,vt=Math.round((Z-rt)/(w/H)),Pt=H/us(H,vt);q=ds[Pt]||"#929292"}h.strokeStyle=q,h.lineWidth=G?2:1,h.beginPath(),h.moveTo(yt+.5,D?0:10),h.lineTo(yt+.5,D?et:et-10),h.stroke()};for(let Z=dt;Z<=gt;Z+=w/H)ht(Z);for(let Z=dt-w/H;Z>=nt;Z-=w/H)ht(Z)}}if(t){const $=t.hitObjects,w=(pt=t.colors)!=null&&pt.comboColors&&t.colors.comboColors.length?t.colors.comboColors:u!=null&&u.comboColors&&u.comboColors.length?u.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],H=new Array($.length).fill(0),dt=new Array($.length).fill(1);{let q=0;for(let rt=0;rt<$.length;rt++){const vt=$[rt];vt.newCombo&&(q=q+1+(vt.comboSkip||0)),H[rt]=q,rt===0||H[rt]!==H[rt-1]?dt[rt]=1:dt[rt]=(dt[rt-1]||1)+1}}const[ht,Z]=I.current;if(Math.abs(ht-Z)>0){const q=z(Math.min(ht,Z),B,ut),rt=z(Math.max(ht,Z),B,ut);h.fillStyle="rgba(255,255,255,0.25)",h.fillRect(Math.max(0,q),0,Math.max(0,Math.min(B,rt)-Math.max(0,q)),et)}const G=Math.floor(et*.5),D=Math.max(2,Math.floor(et*.38));for(let q=$.length-1;q>=0;q--){const rt=$[q],vt=rt.time,Pt=rt.kind==="slider"?vt+Tt(t,rt):rt.endTime??vt;if(Pt<nt||vt>gt)continue;const St=z(vt,B,ut),Mt=z(Pt,B,ut),wt=m.has(q),x=w[H[q]%w.length];if(h.fillStyle=wt?"#f59e0b":"#1f2b45",h.fillRect(Math.floor(St),0,1,et),rt.kind==="circle"){const T=u==null?void 0:u.hitcircle,at=u==null?void 0:u.hitcircleoverlay;if(T){const J=D*2,_=J/(T.width||128),k=(T.width||128)*_,b=(T.height||128)*_;h.save(),h.globalAlpha=.95;const E=S(T,Math.max(1,Math.round(J)),x);h.drawImage(E,St-k/2,G-b/2,k,b),at&&h.drawImage(at,St-k/2,G-b/2,k,b),h.restore(),mt(h,u,dt[q],St,G,D)}else h.save(),h.beginPath(),h.arc(St,G,D,0,Math.PI*2),h.fillStyle=x,h.fill(),h.restore(),mt(h,u,dt[q],St,G,D)}else if(rt.kind==="slider"){h.save();const T=Math.min(St,Mt),at=Math.max(4,Math.abs(Mt-St)),J=Math.max(6,Math.floor(et*.7)),_=Math.floor((et-J)/2),k=3;h.beginPath(),h.moveTo(T+k,_),h.lineTo(T+at-k,_),h.quadraticCurveTo(T+at,_,T+at,_+k),h.lineTo(T+at,_+J-k),h.quadraticCurveTo(T+at,_+J,T+at-k,_+J),h.lineTo(T+k,_+J),h.quadraticCurveTo(T,_+J,T,_+J-k),h.lineTo(T,_+k),h.quadraticCurveTo(T,_,T+k,_),h.closePath(),h.fillStyle=wt?"rgba(245,158,11,0.9)":x,h.globalAlpha=wt?.95:.85,h.fill(),h.restore();const b=u==null?void 0:u.hitcircle,E=u==null?void 0:u.hitcircleoverlay;if(b){const it=D*2,ot=it/(b.width||128),bt=(b.width||128)*ot,Ct=(b.height||128)*ot;h.save(),h.globalAlpha=.95;const Et=S(b,Math.max(1,Math.round(it)),x);h.drawImage(Et,St-bt/2,G-Ct/2,bt,Ct),E&&h.drawImage(E,St-bt/2,G-Ct/2,bt,Ct),h.restore(),mt(h,u,dt[q],St,G,D),h.save(),h.globalAlpha=.95;const Lt=S(b,Math.max(1,Math.round(it)),x);h.drawImage(Lt,Mt-bt/2,G-Ct/2,bt,Ct),E&&h.drawImage(E,Mt-bt/2,G-Ct/2,bt,Ct),h.restore()}const ct=rt,st=Math.max(1,ct.slides);if(st>1&&t){const it=tt(t,ct);for(let ot=1;ot<st;ot++){const bt=vt+it*ot;if(bt<nt||bt>gt)continue;const Ct=z(bt,B,ut),Et=u==null?void 0:u.reversearrow;if(Et){const Bt=Math.max(8,Math.floor(D*1.2))/(Et.width||128),Dt=(Et.width||128)*Bt,zt=(Et.height||128)*Bt;h.save(),h.globalAlpha=.9,h.translate(Ct,G),h.drawImage(Et,-Dt/2,-zt/2,Dt,zt),h.restore()}else if(b){const Lt=Math.max(4,Math.floor(D*.75)),Bt=Lt/(b.width||128),Dt=(b.width||128)*Bt,zt=(b.height||128)*Bt;h.save(),h.globalAlpha=.85;const Ie=wt?"#f59e0b":x,Le=S(b,Math.max(1,Math.round(Lt*2)),Ie);h.drawImage(Le,Ct-Dt/2,G-zt/2,Dt,zt),E&&(h.globalAlpha=.7,h.drawImage(E,Ct-Dt/2,G-zt/2,Dt,zt)),h.restore()}else h.save(),h.beginPath(),h.arc(Ct,G,Math.max(2,Math.floor(D*.6)),0,Math.PI*2),h.fillStyle=wt?"#f59e0b":x,h.globalAlpha=.85,h.fill(),h.restore()}}}else if(rt.kind==="spinner"){const at=vt-36,J=Pt-36,_=z(at,B,ut),k=z(J,B,ut),b=Math.min(_,k),E=Math.max(4,Math.abs(k-_)),ct=Math.max(6,Math.floor(et*.7)),st=Math.floor((et-ct)/2);h.save();const it=3;h.beginPath(),h.moveTo(b+it,st),h.lineTo(b+E-it,st),h.quadraticCurveTo(b+E,st,b+E,st+it),h.lineTo(b+E,st+ct-it),h.quadraticCurveTo(b+E,st+ct,b+E-it,st+ct),h.lineTo(b+it,st+ct),h.quadraticCurveTo(b,st+ct,b,st+ct-it),h.lineTo(b,st+it),h.quadraticCurveTo(b,st,b+it,st),h.closePath(),h.fillStyle=wt?"rgba(245,158,11,0.9)":"rgba(87,177,255,0.85)",h.globalAlpha=wt?.95:.85,h.fill(),h.restore();const ot=u==null?void 0:u.hitcircle,bt=u==null?void 0:u.hitcircleoverlay;if(ot){const Ct=D*2,Et=Ct/(ot.width||128),Lt=(ot.width||128)*Et,Bt=(ot.height||128)*Et;h.save(),h.globalAlpha=.95;const Dt=S(ot,Math.max(1,Math.round(Ct)),x);h.drawImage(Dt,_-Lt/2,G-Bt/2,Lt,Bt),bt&&h.drawImage(bt,_-Lt/2,G-Bt/2,Lt,Bt),h.restore(),h.save(),h.globalAlpha=.95;const zt=S(ot,Math.max(1,Math.round(Ct)),x);h.drawImage(zt,k-Lt/2,G-Bt/2,Lt,Bt),bt&&h.drawImage(bt,k-Lt/2,G-Bt/2,Lt,Bt),h.restore()}else h.save(),h.beginPath(),h.arc(_,G,D,0,Math.PI*2),h.fillStyle=x,h.fill(),h.restore(),h.save(),h.beginPath(),h.arc(k,G,D,0,Math.PI*2),h.fillStyle=x,h.fill(),h.restore()}if(Pt>vt){const T=z(Pt,B,ut);h.fillStyle=wt?"rgba(245,158,11,0.35)":"rgba(87,177,255,0.2)",h.fillRect(Math.min(St,T),et-8,Math.max(1,Math.abs(T-St)),6)}}}if(o&&o.length>0){h.fillStyle="#f59e0b";for(const $ of o){const w=$*1e3,H=z(w,B,ut);H<-6||H>B+6||(h.beginPath(),h.moveTo(H,0),h.lineTo(H+6,10),h.lineTo(H-6,10),h.closePath(),h.fill())}}h.strokeStyle="#cdd6f4",h.lineWidth=2,h.beginPath(),h.moveTo(B/2+.5,0),h.lineTo(B/2+.5,et),h.stroke(),h.beginPath(),h.moveTo(B/2-3,0),h.lineTo(B/2,3),h.lineTo(B/2+3,0),h.closePath(),h.fillStyle="#cdd6f4",h.fill(),h.beginPath(),h.moveTo(B/2-3,et),h.lineTo(B/2,et-3),h.lineTo(B/2+3,et),h.closePath(),h.fill()},[t,s,e,o,y,c,u]),v.useEffect(()=>{const U=N.current;if(!U)return;const V=lt=>{if(lt.altKey){lt.preventDefault();const xt=lt.deltaY>0?Math.max(.5,y-.1):Math.min(1.5,y+.1),W=Math.round(xt*10)/10;R(W),l==null||l(W);return}lt.preventDefault(),Y.current||(Y.current=!0,i==null||i()),M.current!==null&&clearTimeout(M.current);const K=lt.shiftKey?1:.1,B=lt.deltaY>0?1:-1,et=Math.max(0,Math.min(e,s+B*K));n(et),M.current=window.setTimeout(()=>{Y.current=!1,r==null||r(),M.current=null},150)};return U.addEventListener("wheel",V,{passive:!1}),()=>{U.removeEventListener("wheel",V),M.current!==null&&clearTimeout(M.current)}},[y,l,s,e,n,i,r]),v.useEffect(()=>{const U=N.current;if(!U||!t||!P)return;const V=K=>{const B=U.getBoundingClientRect(),et=B.width,xt=s*1e3,W=K.clientX-B.left,F=X(W,et,xt);g.current=!0;const h=40*(se/y),ut=[];for(let $=0;$<t.hitObjects.length;$++){const w=t.hitObjects[$],H=w.time,dt=w.kind==="slider"?H+Tt(t,w):w.endTime??H;w.kind==="slider"?F>=H-h&&F<=dt+h&&ut.push($):(F-h<H&&F+h>H||F-h<dt&&F+h>dt||H-h<F&&F<dt+h)&&ut.push($)}ut.sort(($,w)=>{const H=t.hitObjects[$],dt=t.hitObjects[w],ht=Math.abs(H.time-F),Z=Math.abs(dt.time-F);return ht-Z});const A=ut[0],nt=K.button===0&&(K.ctrlKey||!A&&!K.shiftKey);if(nt)I.current=[F,F],K.ctrlKey||P(new Set);else if(A!==void 0){const $=new Set(m);if(K.shiftKey&&O.current!==null){const w=Math.min(O.current,A),H=Math.max(O.current,A);for(let dt=w;dt<=H;dt++)$.add(dt)}else K.ctrlKey||K.metaKey?$.has(A)?$.delete(A):$.add(A):($.clear(),$.add(A));O.current=A,P($)}else i&&i(),n(Math.max(0,Math.min(e,F/1e3)));const gt=$=>{if(!g.current)return;const w=X(Math.max(0,Math.min(B.width,$.clientX-B.left)),et,xt);if(nt){I.current=[F,w];const H=Math.min(F,w),dt=Math.max(F,w),ht=K.ctrlKey?new Set(m):new Set;for(let Z=0;Z<t.hitObjects.length;Z++){const yt=t.hitObjects[Z],G=yt.time,D=yt.kind==="slider"?G+Tt(t,yt):yt.endTime??G;(H<G&&dt>G||H<D&&dt>D||G<dt&&D>H)&&ht.add(Z)}P(ht),j(Z=>Z+1)}else n(Math.max(0,Math.min(e,w/1e3)))},pt=()=>{g.current=!1,I.current=[0,0],nt||r&&r(),window.removeEventListener("mousemove",gt),window.removeEventListener("mouseup",pt)};window.addEventListener("mousemove",gt),window.addEventListener("mouseup",pt)},lt=K=>{if(K.preventDefault(),K.touches.length===0)return;const B=U.getBoundingClientRect(),et=B.width,xt=s*1e3,W=K.touches[0],F=X(Math.max(0,Math.min(B.width,W.clientX-B.left)),et,xt);g.current=!0,i&&i(),n(Math.max(0,Math.min(e,F/1e3)));const h=A=>{if(A.preventDefault(),!g.current||A.touches.length===0)return;const nt=A.touches[0],gt=X(Math.max(0,Math.min(B.width,nt.clientX-B.left)),et,xt);n(Math.max(0,Math.min(e,gt/1e3)))},ut=A=>{A.preventDefault(),g.current=!1,r&&r(),window.removeEventListener("touchmove",h),window.removeEventListener("touchend",ut),window.removeEventListener("touchcancel",ut)};window.addEventListener("touchmove",h,{passive:!1}),window.addEventListener("touchend",ut),window.addEventListener("touchcancel",ut)};return U.addEventListener("mousedown",V),U.addEventListener("touchstart",lt,{passive:!1}),()=>{U.removeEventListener("mousedown",V),U.removeEventListener("touchstart",lt)}},[t,s,e,n,i,r,y,m,P]),p.jsx("div",{className:"timeline-wrapper",children:p.jsxs("div",{className:"timeline-row",children:[p.jsx("canvas",{ref:N,className:"timeline",style:{height:L,display:"block"}}),p.jsxs("div",{className:"zoom-column",children:[p.jsx("button",{className:"zoom-btn small",onClick:()=>{const U=Math.min(1.5,y+.1);R(U),l==null||l(U)},children:"+"}),p.jsx("button",{className:"zoom-btn small",onClick:()=>{const U=Math.max(.5,y-.1);R(U),l==null||l(U)},children:"-"})]}),p.jsxs("div",{className:"beatsnap-vertical",children:[p.jsx("div",{className:"bs-label",children:"Beat Snap Divisor"}),p.jsxs("div",{className:"bs-value",children:["1/",c]}),p.jsxs("div",{className:"bs-arrows",children:[p.jsx("button",{className:"beat-snap-btn icon xs",title:"Prev divisor",onClick:()=>d==null?void 0:d(Math.max(1,c===16?12:c===12?9:c-1)),children:"◀"}),p.jsx("span",{className:"bs-kind",children:ft(c)}),p.jsx("button",{className:"beat-snap-btn icon xs",title:"Next divisor",onClick:()=>d==null?void 0:d(Math.min(16,c===9?12:c===12?16:c+1)),children:"▶"})]})]})]})})},xs=()=>{const[t,s]=v.useState(null),[e,n]=v.useState(void 0),o=v.useRef(void 0),[i,r]=v.useState(""),a=v.useRef(new ns),[l,c]=v.useState(0),[d,u]=v.useState(!1),[f,C]=v.useState(0),[m,P]=v.useState(null),N=v.useRef(null),L=v.useRef([]),y=v.useRef(0),R=v.useRef(0),g=v.useRef(0),I=v.useRef(0),[O,j]=v.useState([]),[M,Y]=v.useState(1),[z,X]=v.useState(!1),ft=v.useRef(!1),Q=v.useRef(!1),S=v.useRef(null),mt=v.useRef(!1),tt=v.useRef(),[Tt,jt]=v.useState(.4),[U,V]=v.useState(4),[lt,K]=v.useState(!1),[B,et]=v.useState(.6),[xt,W]=v.useState(1),[F,h]=v.useState(.6),ut=v.useRef(null),[A,nt]=v.useState([]),[gt,pt]=v.useState(""),[$,w]=v.useState(!1),[H,dt]=v.useState(!1),[ht,Z]=v.useState(new Set),yt=v.useCallback(async(x,T)=>{var at,J;Ot.clearAll(),Z(new Set);try{const _=await x.readText(T);let k=ce(_);try{k=await ss(_,k)}catch{}s(k);try{const b=k.metadata.TitleUnicode||k.metadata.Title||"",E=k.metadata.ArtistUnicode||k.metadata.Artist||"",ct=k.metadata.Creator||k.metadata.creator||"",st=k.metadata.Version||"",it=Number(k.metadata.BeatmapID||0)||null;window.dispatchEvent(new CustomEvent("editor:info",{detail:{title:b,artist:E,mapper:ct,version:st,beatmapId:it}}))}catch{}try{const b=ne(k.difficulty);L.current=rs(k,b),y.current=0;const E=(at=k.colors)!=null&&at.comboColors&&k.colors.comboColors.length?k.colors.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],ct=Me(b.CS),st=(m==null?void 0:m.sliderBorder)||((J=k.colors)==null?void 0:J.sliderBorder)||"#ffffff";Ot.precalculateShapes(k,b,E,ct,240,st)}catch{L.current=[],y.current=0}if(C(0),k.audioFilename){const b=x.findFirst(E=>E.toLowerCase().endsWith(k.audioFilename.toLowerCase()))||k.audioFilename;try{const E=await x.readArrayBuffer(b);await a.current.load(E),C(a.current.duration||0)}catch(E){console.warn("Failed to load audio:",E)}}if(k.backgroundFilename)try{const b=x.findFirst(st=>st.toLowerCase().endsWith(k.backgroundFilename.toLowerCase()))||k.backgroundFilename,E=await x.readArrayBuffer(b);o.current&&URL.revokeObjectURL(o.current);const ct=URL.createObjectURL(new Blob([E]));o.current=ct,n(ct)}catch{o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0)}else o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0);a.current.seek(0),c(0),u(!1)}catch(_){console.error("Error loading beatmap path:",_),alert(_ instanceof Error?_.message:String(_))}},[]);v.useEffect(()=>{const x=a.current;return x.onTick(T=>{ft.current||c(T)}),()=>x.stop()},[]),v.useEffect(()=>{const x=()=>K(!0);return window.addEventListener("editor:embed:preview",x),()=>window.removeEventListener("editor:embed:preview",x)},[]),v.useEffect(()=>{const x=window.__editorTransferOsz,T=window.__editorTransferPath,at=x?null:sessionStorage.getItem("editor:transfer:osz"),J=T?null:sessionStorage.getItem("editor:transfer:path");if(!x&&!at||!T&&!J)return;x?(delete window.__editorTransferOsz,delete window.__editorTransferPath):(sessionStorage.removeItem("editor:transfer:osz"),sessionStorage.removeItem("editor:transfer:path"));let _=null;return _=window.setTimeout(()=>{window.__editorTransferOsz&&(delete window.__editorTransferOsz,delete window.__editorTransferPath)},6e4),(async()=>{try{let k;if(x)k=x;else{const ot=atob(at),bt=new Uint8Array(ot.length);for(let Ct=0;Ct<ot.length;Ct++)bt[Ct]=ot.charCodeAt(Ct);k=bt.buffer}const b=T||J,E=await we(k);ut.current=E;const ct=E.list.filter(ot=>ot.toLowerCase().endsWith(".osu"));if(!ct.length)throw new Error("No .osu file in archive");const st=[];for(const ot of ct)try{const bt=await E.readText(ot),Ct=ce(bt),Et=String(Ct.metadata.Version||"");st.push({path:ot,version:Et,mode:Ct.mode})}catch{}nt(st);const it=ct.includes(b)?b:ct[0];pt(it);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:st,selected:it}}))}catch{}await yt(E,it),r("Transferred from preview"),_!==null&&clearTimeout(_)}catch(k){console.error("Failed to load transferred OSZ:",k),alert(k instanceof Error?k.message:"Failed to load transferred beatmap"),_!==null&&clearTimeout(_)}})(),()=>{_!==null&&clearTimeout(_)}},[yt]),v.useEffect(()=>{if(!lt)return;const x=T=>{T.key==="Escape"&&K(!1)};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[lt]),v.useEffect(()=>{try{localStorage.getItem("editor:welcome:hidden")==="1"||w(!0)}catch{w(!0)}},[]),v.useEffect(()=>{const x=async()=>{try{const T=a.current.getContext();if(T.state!=="running"&&await T.resume(),!N.current){const at=new ee(T);N.current=at,at.volume=F*B,await at.load().catch(()=>{})}}catch{}window.removeEventListener("pointerdown",x),window.removeEventListener("keydown",x)};return window.addEventListener("pointerdown",x,{once:!0}),window.addEventListener("keydown",x,{once:!0}),()=>{window.removeEventListener("pointerdown",x),window.removeEventListener("keydown",x)}},[]),v.useEffect(()=>{ls().then(x=>P(x)).catch(()=>P(null))},[]),v.useEffect(()=>{Ot.clearAll()},[]),v.useEffect(()=>()=>{var x;R.current&&(cancelAnimationFrame(R.current),R.current=0),a.current.stop(),Ot.clearAll(),o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),S.current!==null&&(clearTimeout(S.current),S.current=null);try{(x=N.current)==null||x.stopAll()}catch{}},[]),v.useEffect(()=>{a.current&&(a.current.volume=xt*B)},[xt,B]),v.useEffect(()=>{N.current&&(N.current.volume=F*B)},[F,B]);const G=v.useCallback(async x=>{console.log("Attempting to load OSZ file:",x.name),r(x.name);try{const T=await we(x);console.log("OSZ loaded, contents:",T.list),ut.current=T;const at=T.list.filter(_=>_.toLowerCase().endsWith(".osu"));if(!at.length)throw new Error("No .osu file in archive");const J=[];for(const _ of at)try{const k=await T.readText(_),b=ce(k),E=String(b.metadata.Version||"");J.push({path:_,version:E,mode:b.mode})}catch{}nt(J),pt(at[0]);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:J,selected:at[0]}}))}catch{}await yt(T,at[0])}catch(T){console.error("Error in onOpenOsz:",T),alert(T instanceof Error?T.message:String(T))}},[]),D=v.useMemo(()=>{if(f>0)return f;if(!t)return 0;const x=t.hitObjects[t.hitObjects.length-1];return x?(("endTime"in x?x.endTime:x.time)+2e3)/1e3:0},[f,t]),q=v.useCallback(x=>{var k;z?(a.current&&f>0&&a.current.setPosition(x),c(x)):(a.current.seek(x),c(x));const T=x*1e3,at=L.current;let J=0,_=at.length;for(;J<_;){const b=J+_>>>1;at[b].timeMs<=T?J=b+1:_=b}y.current=J;try{(k=N.current)==null||k.stopSlide()}catch{}f===0&&d&&!z&&(g.current=performance.now(),I.current=x)},[z,f,d]),rt=v.useCallback(async()=>{var J,_;if(a.current.isPlaying&&f>0||d){a.current.pause(),u(!1),a.current.isPlaying&&a.current.stop(),R.current&&(cancelAnimationFrame(R.current),R.current=0);try{(J=N.current)==null||J.stopAll()}catch{}}else{if(ft.current)return;try{const k=a.current.getContext();if(k.state!=="running"&&await k.resume(),!N.current){const b=new ee(k);N.current=b,b.volume=F*B,await b.load().catch(()=>{})}}catch{}if(f>0){const k=Math.max(0,f);let b=Math.max(0,Math.min(k,typeof l=="number"?l:0));if(b>=k-.001&&(b=0),b!==l){c(b);const E=b*1e3,ct=L.current;let st=0,it=ct.length;for(;st<it;){const ot=st+it>>>1;ct[ot].timeMs<=E?st=ot+1:it=ot}y.current=st}St.current=b,a.current.play(b),u(!0),a.current.isPlaying||u(!1);try{const E=(typeof l=="number"?l:0)*1e3,ct=L.current;let st=-1;for(let it=0;it<ct.length;it++)ct[it].timeMs<=E&&ct[it].kind==="slide_start"&&(st=it);if(st!==-1){let it=!1;for(let ot=st+1;ot<ct.length;ot++)if(ct[ot].kind==="slide_end"){it=ct[ot].timeMs>=E;break}if(it){const ot=ct[st];(_=N.current)==null||_.startSlide(ot.set)}}}catch{}}else{u(!0),g.current=performance.now();const k=Math.max(0,D||0),b=typeof l=="number"&&l>=k-.001?0:l;if(b!==l){c(b);const ct=b*1e3,st=L.current;let it=0,ot=st.length;for(;it<ot;){const bt=it+ot>>>1;st[bt].timeMs<=ct?it=bt+1:ot=bt}y.current=it}I.current=b;const E=()=>{if(ft.current){R.current=0;return}const ct=(performance.now()-g.current)/1e3,st=Math.min(D||1/0,I.current+ct);if(c(st),st>=(D||1/0)){u(!1);return}R.current=requestAnimationFrame(E)};R.current=requestAnimationFrame(E)}}},[d,f,l,D]);v.useEffect(()=>{tt.current=rt},[rt]);const vt=v.useMemo(()=>{if(!t)return{bpm:0,sliderVelocity:0};const{base:x,inherited:T}=$t(t,l*1e3),at=x?6e4/x.beatLength:0,J=T?-100/T.beatLength:1;return{bpm:at,sliderVelocity:J}},[t,l]);v.useCallback(x=>{var at;const T=(at=x.target.files)==null?void 0:at[0];if(T){console.log("File selected in input:",T.name);try{const J=a.current.getContext();if(J.state!=="running"&&J.resume(),!N.current){const _=new ee(J);N.current=_,_.volume=F*B,_.load().catch(()=>{})}}catch{}G(T).catch(J=>{console.error("Error from onOpenOsz via file input:",J),alert(String((J==null?void 0:J.message)||J))})}},[G]),v.useEffect(()=>{const x=T=>{const J=T.detail;J&&G(J).catch(_=>{alert(_ instanceof Error?_.message:String(_))})};return window.addEventListener("editor:file",x),()=>window.removeEventListener("editor:file",x)},[G]);const Pt=v.useCallback(x=>{Z(new Set(x))},[]);v.useEffect(()=>{const x=T=>{if(!(T.target&&T.target.tagName==="INPUT")&&(T.code==="KeyC"||T.code==="Keyc")&&T.ctrlKey){if(T.preventDefault(),!t||ht.size===0)return;const at=Array.from(ht).map(it=>({idx:it,obj:t.hitObjects[it]})).filter(it=>it.obj).sort((it,ot)=>it.obj.time-ot.obj.time);if(at.length===0)return;const J=at[0].obj.time,_=ue(t),k=at.map(it=>_.number[it.idx]).join(","),b=Math.floor(J/1e3/60),E=Math.floor(J/1e3%60),ct=Math.floor(J%1e3),st=`${b.toString().padStart(2,"0")}:${E.toString().padStart(2,"0")}:${ct.toString().padStart(3,"0")} (${k})`;navigator.clipboard.writeText(st).catch(()=>{});return}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[t,ht]),v.useEffect(()=>{const x=T=>{if(T.target&&T.target.tagName==="INPUT")return;if(T.code==="Space"){T.preventDefault(),tt.current&&tt.current();return}const at=T.shiftKey?1:.1;T.code==="ArrowLeft"&&(T.preventDefault(),q(Math.max(0,l-at))),T.code==="ArrowRight"&&(T.preventDefault(),q(Math.min(D,l+at))),T.code==="Home"&&(T.preventDefault(),q(0)),T.code==="End"&&(T.preventDefault(),q(D)),T.code==="KeyB"&&(T.preventDefault(),j(J=>[...J,l]))};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[rt,q,l,D]),v.useEffect(()=>{const x=T=>{var it;const at=T.target;if(!at||at.closest(".top-nav")||at.tagName==="INPUT"||at.tagName==="TEXTAREA"||T.altKey||at.closest(".timeline-wrapper")||at.closest(".editor-controls-container")||(T.preventDefault(),!Number.isFinite(D)||D<=0))return;if(!mt.current){mt.current=!0;const ot=a.current.isPlaying&&f>0;Q.current=ot,ot&&a.current.pause(),u(!1),ft.current=!0,X(!0)}S.current!==null&&clearTimeout(S.current);const J=T.shiftKey?1:.1,_=T.deltaY>0?1:-1,k=Math.max(0,Math.min(D,l+_*J));f>0&&a.current.setPosition(k),c(k);const b=k*1e3,E=L.current;let ct=0,st=E.length;for(;ct<st;){const ot=ct+st>>>1;E[ot].timeMs<=b?ct=ot+1:st=ot}y.current=ct;try{(it=N.current)==null||it.stopSlide()}catch{}S.current=window.setTimeout(()=>{mt.current=!1,ft.current=!1,X(!1),S.current=null},150)};return window.addEventListener("wheel",x,{passive:!1}),()=>{window.removeEventListener("wheel",x),S.current!==null&&clearTimeout(S.current)}},[l,D,d,f]),v.useEffect(()=>{const x=T=>{var k;const J=(k=T.detail)==null?void 0:k.path,_=ut.current;!_||!J||(pt(J),yt(_,J).then(()=>{try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:A,selected:J}}))}catch{}}))};return window.addEventListener("editor:difficulty:select",x),()=>window.removeEventListener("editor:difficulty:select",x)},[A,yt]);const St=v.useRef(0);v.useEffect(()=>{if(!t){St.current=l;return}const x=N.current;if(!x){St.current=l;return}const T=St.current,at=l;if(St.current=l,!d||z||at<=T||at-T>1)return;try{const b=a.current.getContext();if(b.state!=="running"){b.resume().catch(()=>{});return}}catch{}const J=at*1e3,_=L.current;let k=y.current;for(;k<_.length&&_[k].timeMs<=J;k++){const b=_[k];b.kind==="hit"?x.playHit(b.set,b.bits||0):b.kind==="tick"?x.playTick(b.set):b.kind==="reverse"&&(typeof b.bits=="number"?x.playHit(b.set,b.bits):x.playReverse(b.set))}y.current=k},[l,t,d,z]);const Mt=v.useCallback(()=>{const x=a.current.isPlaying&&f>0;Q.current=x,x&&a.current.pause(),R.current&&(cancelAnimationFrame(R.current),R.current=0),u(!1),ft.current=!0,X(!0)},[f]),wt=v.useCallback(async()=>{ft.current=!1,X(!1);try{const x=a.current.getContext();if(x.state!=="running"&&await x.resume(),!N.current){const T=new ee(x);N.current=T,T.volume=F*B,await T.load().catch(()=>{})}}catch{}},[F,B]);return p.jsxs("div",{className:"app fullscreen-editor",children:[p.jsx(fs,{beatmap:t,currentTime:l,duration:D,onSeek:q,bookmarks:O,onScrubStart:Mt,onScrubEnd:wt,scale:Tt,onScaleChange:jt,beatSnapDivisor:U,onBeatSnapChange:V,skin:m||void 0,isPlaying:d,onPlayPause:rt,selectedIndices:ht,onSelectionChange:Pt}),p.jsxs("div",{className:"playfield-container",children:[p.jsx(ye,{beatmap:t,timeSec:l,backgroundUrl:e,skin:m,sliderBodyCutoffPx:M,selectedIndices:ht,onSelectionChange:Pt}),p.jsx(ve,{masterVolume:B,songVolume:xt,hitsoundVolume:F,onMasterVolumeChange:et,onSongVolumeChange:W,onHitsoundVolumeChange:h})]}),p.jsx(xe,{isPlaying:d,onPlayPause:rt,currentTime:l,duration:D,onSeek:q,onScrubStart:Mt,onScrubEnd:wt,bpm:vt.bpm,sliderVelocity:vt.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints}),$&&p.jsx("div",{className:"editor-modal-overlay",children:p.jsxs("div",{className:"editor-modal",children:[p.jsx("div",{className:"modal-title",children:"Hey!"}),p.jsx("div",{className:"modal-body",children:p.jsxs("p",{children:["If you use this website solely for the editor, ",p.jsx("strong",{children:"don't"}),". This is a fork of ",p.jsx("strong",{children:"JoSu! 2.0"})," (",p.jsx("a",{href:"https://preview.tryz.id.vn/",target:"_blank",rel:"noreferrer",children:"preview.tryz.id.vn"}),") adapted specifically for this website. JoSu is superior in almost every way."]})}),p.jsxs("div",{className:"modal-actions",children:[p.jsxs("label",{className:"check-bubble",children:[p.jsx("input",{type:"checkbox",checked:H,onChange:x=>dt(x.target.checked)}),p.jsx("span",{className:"check-text",children:"Don't show this again"})]}),p.jsx("button",{className:"btn secondary",onClick:()=>{try{H&&localStorage.setItem("editor:welcome:hidden","1")}catch{}w(!1)},children:"OK"})]})]})}),lt&&p.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",children:[p.jsx("div",{className:"overlay-backdrop",onClick:()=>K(!1)}),p.jsxs("div",{className:"overlay-card embed-preview-card",children:[p.jsx("button",{className:"overlay-close",onClick:()=>K(!1),"aria-label":"Close embed preview",children:p.jsx(be,{size:18})}),p.jsx("div",{className:"embed-preview-body",children:t?p.jsxs(p.Fragment,{children:[p.jsxs("div",{className:"embed-preview-playfield",children:[p.jsx(ye,{beatmap:t,timeSec:l,backgroundUrl:e,skin:m,sliderBodyCutoffPx:M,selectedIndices:ht,onSelectionChange:Pt}),p.jsx(ve,{masterVolume:B,songVolume:xt,hitsoundVolume:F,onMasterVolumeChange:et,onSongVolumeChange:W,onHitsoundVolumeChange:h})]}),p.jsx(xe,{isPlaying:d,onPlayPause:rt,currentTime:l,duration:D,onSeek:q,bpm:vt.bpm,sliderVelocity:vt.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints})]}):p.jsx("div",{className:"embed-preview-empty",children:"Load a beatmap to see the embed preview."})})]})]})]})},vs=Object.freeze(Object.defineProperty({__proto__:null,default:hs},Symbol.toStringTag,{value:"Module"}));export{ns as A,hs as B,xe as C,xs as E,ee as H,ye as P,ve as V,we as a,ss as b,rs as c,vs as d,ls as l,ce as p,ne as r,Ot as s,$t as t};

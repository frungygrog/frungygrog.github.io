var J=Object.defineProperty;var Q=(o,t,e)=>t in o?J(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var N=(o,t,e)=>Q(o,typeof t!="symbol"?t+"":t,e);import{_ as ee}from"./index-CR5macuf.js";import{r as y,j as z,Z as te}from"./vendor-react-_vsaDC62.js";import{H as V}from"./vendor-DBgzFpze.js";const re="video-cache",oe=2,I="segments",x="manifests",P="video-tracking",ne=7*24*60*60*1e3,X=500*1024*1024,se=3;let H=null,_=null;function A(){return H?Promise.resolve(H):_||(_=new Promise((o,t)=>{const e=indexedDB.open(re,oe);e.onerror=()=>t(e.error),e.onsuccess=()=>{H=e.result,o(H)},e.onupgradeneeded=s=>{const r=s.target.result;s.oldVersion;let a;r.objectStoreNames.contains(I)?a=s.target.transaction.objectStore(I):(a=r.createObjectStore(I,{keyPath:"url"}),a.createIndex("timestamp","timestamp",{unique:!1})),a.indexNames.contains("videoId")||a.createIndex("videoId","videoId",{unique:!1});let c;r.objectStoreNames.contains(x)?c=s.target.transaction.objectStore(x):(c=r.createObjectStore(x,{keyPath:"url"}),c.createIndex("timestamp","timestamp",{unique:!1})),c.indexNames.contains("videoId")||c.createIndex("videoId","videoId",{unique:!1}),r.objectStoreNames.contains(P)||r.createObjectStore(P,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),_)}function ae(o){try{const t=o.match(/videodelivery\.net\/([^\/]+)\//);if(t)return t[1];const e=new URL(o),s=e.pathname.split("/").filter(r=>r);return s.length>0?e.origin+"/"+s[0]:e.origin}catch{return null}}async function G(o,t=!1,e){try{const s=await A(),r=t?x:I,c=s.transaction([r],"readonly").objectStore(r),n=q(o,t),h=n.substring(n.lastIndexOf("/")+1),u=o.substring(o.lastIndexOf("/")+1).substring(0,50);console.log(`[Video Cache] ðŸ” Looking up cache key: ${h} (full: ${n.substring(0,100)}...)`);const l=c.get(n);return new Promise(d=>{l.onsuccess=()=>{const w=l.result;if(!w){console.log(`[Video Cache] ðŸ” Cache lookup result: NOT FOUND for key: ${n.substring(n.lastIndexOf("/")+1)}`),d(null);return}const p=Date.now()-w.timestamp;if(p>ne){console.log(`[Video Cache] â° Cache entry expired (age: ${Math.round(p/1e3/60)}min) for: ${n.substring(n.lastIndexOf("/")+1)}`),Y(o,t).catch(()=>{}),d(null);return}console.log(`[Video Cache] âœ… Cache entry FOUND (age: ${Math.round(p/1e3)}s) for: ${n.substring(n.lastIndexOf("/")+1)}`),d(w.data)},l.onerror=()=>{console.log(`[Video Cache] âŒ Cache lookup ERROR for key: ${n.substring(n.lastIndexOf("/")+1)}`),d(null)}})}catch(s){return console.warn("Cache read error:",s),null}}async function F(o,t,e=!1,s){try{const r=await A(),a=e?x:I,n=r.transaction([a],"readwrite").objectStore(a),h=q(o,e),u=h.substring(h.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸ’¾ Storing with cache key: ${u} (full: ${h.substring(0,100)}...)`);const l=s||ae(o),d={url:h,data:t,timestamp:Date.now(),size:t.byteLength,videoId:l||void 0};await new Promise((w,p)=>{const C=n.put(d);C.onsuccess=()=>w(),C.onerror=()=>p(C.error)}),await ce()}catch(r){console.warn("Cache write error:",r)}}async function Y(o,t=!1){try{const e=await A(),s=t?x:I,a=e.transaction([s],"readwrite").objectStore(s),c=q(o,t);await new Promise((n,h)=>{const u=a.delete(c);u.onsuccess=()=>n(),u.onerror=()=>h(u.error)})}catch(e){console.warn("Cache delete error:",e)}}async function ie(){try{const o=await A();let t=0;for(const e of[I,x]){const a=o.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{a.onsuccess=()=>{const n=a.result;t+=n.reduce((h,u)=>h+u.size,0),c()},a.onerror=()=>c()})}return t}catch(o){return console.warn("Cache size calculation error:",o),0}}async function ce(){try{const o=await ie();if(o<=X)return;const t=await A(),e=[];for(const r of[I,x]){const a=r===x,h=t.transaction([r],"readonly").objectStore(r).getAll();await new Promise(u=>{h.onsuccess=()=>{const l=h.result;e.push(...l.map(d=>({url:d.url,timestamp:d.timestamp,size:d.size,isManifest:a}))),u()},h.onerror=()=>u()})}e.sort((r,a)=>r.timestamp-a.timestamp);let s=o;for(const r of e){if(s<=X*.8)break;await Y(r.url,r.isManifest),s-=r.size}}catch(o){console.warn("Cache cleanup error:",o)}}async function de(o){try{const s=(await A()).transaction([P],"readwrite").objectStore(P),r={videoId:o,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((a,c)=>{const n=s.put(r);n.onsuccess=()=>a(),n.onerror=()=>c(n.error)})}catch(t){console.warn("Video tracking error:",t)}}async function le(o){try{const r=(await A()).transaction([P],"readonly").objectStore(P).index("lastAccessed");return new Promise(a=>{const c=r.openCursor(null,"prev"),n=[];c.onsuccess=h=>{const u=h.target.result;u&&n.length<o?(n.push(u.value.videoId),u.continue()):a(n)},c.onerror=()=>a([])})}catch(t){return console.warn("Get recent videos error:",t),[]}}async function ue(o){try{const t=await A(),e=await le(se),s=new Set([o,...e]);console.log(`[Video Cache] ðŸ“‹ Keeping cache for videos: ${Array.from(s).join(", ")}`);for(const r of[I,x]){const c=t.transaction([r],"readwrite").objectStore(r),n=c.index("videoId"),h=c.getAll();await new Promise(u=>{h.onsuccess=async()=>{const l=h.result;let d=0;for(const w of l)w.videoId&&!s.has(w.videoId)&&await new Promise(p=>{const C=c.delete(w.url);C.onsuccess=()=>{d++,p()},C.onerror=()=>p()});d>0&&console.log(`[Video Cache] ðŸ—‘ï¸ Cleared ${d} cache entries from old videos`),u()},h.onerror=()=>u()})}}catch(t){console.warn("Clear old video cache error:",t)}}function Z(o){return o.includes(".m3u8")||o.endsWith("/manifest")}function q(o,t){if(t)try{const e=new URL(o),s=new URLSearchParams(e.search),r=Array.from(s.entries()).sort(([a],[c])=>a.localeCompare(c));return e.search=new URLSearchParams(r).toString(),e.toString()}catch{return o}else try{const e=new URL(o);return e.origin+e.pathname}catch{const e=o.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return e?e[0]:o.split("?")[0]}}const he=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:ue,getCached:G,isManifest:Z,normalizeCacheKey:q,setCached:F,trackVideoAccess:de},Symbol.toStringTag,{value:"Module"}));class fe{constructor(t){N(this,"context",null);N(this,"stats");N(this,"defaultLoader",null);N(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,s){this.context=t;const r=t.url,a=Z(r);let c;try{const n=r.match(/videodelivery\.net\/([^\/]+)\//);n&&(c=n[1])}catch{}G(r,a).then(n=>{if(n){let u;a?u=new TextDecoder().decode(n):u=n;const l=performance.now();this.stats.loading.start=l,this.stats.loading.first=l,this.stats.loading.end=l,this.stats.loaded=n.byteLength,this.stats.total=n.byteLength,this.stats.aborted=!1;const d={data:u,url:r,code:200},w=a?"manifest":"segment",p=(n.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${w}: ${r.substring(r.lastIndexOf("/")+1)} (${p} KB)`),s.onSuccess(d,this.stats,t,{});return}console.log(`[Video Cache] âŒ Cache MISS - ${a?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(r,a,t,e,s,c)}).catch(n=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${a?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - falling back to network`,n),this.fetchFromNetwork(r,a,t,e,s,c)})}async fetchFromNetwork(t,e,s,r,a,c){var h;const n=performance.now();try{const u=this.abortController||new AbortController,l=await fetch(t,{method:s.method||"GET",headers:s.headers||{},signal:u.signal}).catch(R=>{throw R.name==="AbortError",R});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);let d;const w=l.headers.get("content-type")||"";e||w.includes("application/vnd.apple.mpegurl")||w.includes("text")?d=await l.text():d=await l.arrayBuffer();const p=performance.now(),C=typeof d=="string"?new TextEncoder().encode(d).length:d.byteLength;this.stats.loading.start=n,this.stats.loading.first=n,this.stats.loading.end=p,this.stats.loaded=C,this.stats.total=C,this.stats.aborted=!1;const k=e?"manifest":"segment";if(d instanceof ArrayBuffer){await F(t,d,e,c);const R=(d.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${k}: ${t.substring(t.lastIndexOf("/")+1)} (${R} KB)`)}else{const $=new TextEncoder().encode(d);await F(t,$.buffer,e,c);const g=($.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${k}: ${t.substring(t.lastIndexOf("/")+1)} (${g} KB)`)}const T={data:d,url:l.url,code:l.status};a.onSuccess(T,this.stats,s,{})}catch(u){const l=performance.now();if(this.stats.loading.start=n,this.stats.loading.first=n,this.stats.loading.end=l,this.stats.loaded=0,this.stats.total=0,u instanceof Error&&u.name==="AbortError")this.stats.aborted=!0,(h=a.onAbort)==null||h.call(a,this.stats,s,{});else if(!(u instanceof Error&&u.name==="AbortError")){this.stats.aborted=!1;const d=u instanceof Error?u:new Error("Network error");a.onError({code:0,text:d.message},s,{},this.stats)}}}abort(){this.abortController&&this.abortController.abort()}destroy(){this.context=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}},this.abortController&&(this.abortController.abort(),this.abortController=null)}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const ye=({playbackUrl:o,streamUID:t,aspectRatio:e,preferNative:s=!1,autoplay:r=!1,loop:a=!1,muted:c=!1,controls:n=!0,onVideoRef:h,onClick:u})=>{const[l,d]=y.useState(1.7777777777777777),w=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;y.useEffect(()=>{if(!w)return;const i=()=>d(window.innerWidth/Math.max(1,window.innerHeight));return i(),window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[w]);const p=y.useRef(null),[C,k]=y.useState(null),T=y.useMemo(()=>{const i=1.3333333333333333,b=16/9,m=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(m)return Math.min(b,Math.max(i,m));const v=w?l:16/9;return Math.min(b,Math.max(i,v))},[w,l,e]),$=`${C??T} / 1`,g=y.useMemo(()=>o||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[o,t]),j=y.useRef(null),M=y.useMemo(()=>{if(!g)return null;try{const i=g.match(/videodelivery\.net\/([^\/]+)\//);return i?i[1]:g}catch{return g}},[g]);y.useEffect(()=>{!g||!M||(ee(async()=>{const{trackVideoAccess:i,clearOldVideoCache:b}=await Promise.resolve().then(()=>he);return{trackVideoAccess:i,clearOldVideoCache:b}},void 0).then(({trackVideoAccess:i,clearOldVideoCache:b})=>{var m;if(i(M).catch(v=>{console.warn("[Video Cache] Failed to track video access:",v)}),j.current&&j.current!==g){const v=((m=j.current.match(/videodelivery\.net\/([^\/]+)\//))==null?void 0:m[1])||j.current;console.log(`[Video Cache] ðŸŽ¬ Video changed from ${v} to ${M} - managing cache`),b(M).catch(L=>{console.warn("[Video Cache] Failed to clear old video cache:",L)})}}),j.current=g)},[g,M]),y.useEffect(()=>{k(null)},[g]),y.useEffect(()=>{if(!s||!p.current)return;const i=p.current;let b=!1;const m=()=>{if(!b)if(i.videoWidth>0&&i.videoHeight>0){const v=i.videoWidth/i.videoHeight,L=4/3,W=16/9,K=Math.min(W,Math.max(L,v));k(K),b=!0}else k(T),b=!0};return i.addEventListener("loadedmetadata",m),i.readyState>=1&&m(),()=>{i.removeEventListener("loadedmetadata",m)}},[s,T,g]),y.useEffect(()=>{if(!g)return;let i=null,b=null,m=!1,v=null,L=null;const K=setTimeout(()=>{const f=p.current;if(!(!f||m))if(V.isSupported()){const O={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:fe};i=new V(O),i.loadSource(g),i.attachMedia(f),i.on(V.Events.MANIFEST_PARSED,()=>{if(m||!f)return;const B=g.substring(g.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${B}`);let E=!1;v=()=>{!E&&!m&&(E=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${B}`),f&&v&&f.removeEventListener("playing",v))},f.addEventListener("playing",v),a&&(L=()=>{if(!(m||!f||!i)){console.log("[Video Cache] ðŸ”„ Video ended, looping back to start (will use cache)");try{i.stopLoad(),f.currentTime=0,i.startLoad(),f.play().catch(S=>{S.name!=="AbortError"&&S.name!=="NotAllowedError"&&console.debug("Loop play failed:",S)})}catch{f.currentTime=0,f.play().catch(()=>{})}}},f.addEventListener("ended",L)),r&&!m&&f.play().catch(S=>{S.name!=="AbortError"&&S.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",S)})}),i.on(V.Events.ERROR,(B,E)=>{if(!m&&(console.error("[HLS Error]",{type:E.type,details:E.details,fatal:E.fatal,url:E.url,error:E.error,response:E.response}),E.fatal))switch(E.type){case V.ErrorTypes.NETWORK_ERROR:if(!m&&i){console.warn("HLS network error, trying to recover...",{details:E.details,url:E.url,error:E.error});try{i.startLoad()}catch(S){m||console.warn("HLS recovery failed:",S)}}break;case V.ErrorTypes.MEDIA_ERROR:if(!m&&i){console.warn("HLS media error, trying to recover...");try{i.recoverMediaError()}catch(S){m||console.warn("HLS media recovery failed:",S)}}break;default:m||console.error("HLS fatal error:",E),i&&(i.destroy(),i=null);break}})}else m||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),f.src=g,b=()=>{m||console.warn("Native HLS playback failed")},f.addEventListener("error",b),r&&!m&&f.play().catch(O=>{O.name!=="AbortError"&&O.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",O)})},0);return()=>{m=!0,clearTimeout(K);const f=p.current;if(f&&v&&(f.removeEventListener("playing",v),v=null),f&&L&&(f.removeEventListener("ended",L),L=null),i){try{i.detachMedia(),i.destroy()}catch{}i=null}if(f){b&&f.removeEventListener("error",b);try{f.pause(),f.src="",f.load()}catch{}}}},[g,r]),y.useEffect(()=>{h&&h(p.current)},[h,s,g]);const D="100%",U=w?{width:"100%",maxWidth:D,maxHeight:"100%",aspectRatio:$,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:D,maxHeight:"100%",height:"var(--player-height)",aspectRatio:$,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return g?z.jsx("div",{style:U,children:z.jsx("video",{ref:p,autoPlay:r,loop:!1,muted:c,controls:n,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:u?"pointer":"default"},children:"Your browser does not support the video tag."},g)}):z.jsx("div",{style:U,children:"No video available"})},be=({open:o,onClose:t,buttonRef:e,children:s,align:r="right",minWidth:a=160})=>{const[c,n]=y.useState(null),h=y.useRef(null);if(y.useEffect(()=>{if(!o||!e.current){n(null);return}const l=()=>{if(!e.current)return;const d=e.current.getBoundingClientRect();n({top:d.bottom+8,[r]:window.innerWidth-d[r==="right"?"right":"left"]})};return l(),window.addEventListener("resize",l),window.addEventListener("scroll",l,!0),()=>{window.removeEventListener("resize",l),window.removeEventListener("scroll",l,!0)}},[o,e,r]),y.useEffect(()=>{if(!o)return;const l=d=>{h.current&&!h.current.contains(d.target)&&e.current&&!e.current.contains(d.target)&&t()};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[o,t,e]),!o||!c)return null;const u=z.jsx("div",{ref:h,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return te.createPortal(u,document.body)};export{ye as P,be as a};

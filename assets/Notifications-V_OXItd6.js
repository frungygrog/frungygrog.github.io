import{i as A,r as z,j as i,n as g,t as I,c as C,o as D,A as F,p as R,q as T,s as W}from"./vendor-react-_vsaDC62.js";import{d as q,e as P,f as $,u as _}from"./index-DqrJMO3d.js";import"./vendor-DBgzFpze.js";import"./editor-components-CKFEosPJ.js";const x="https://api.osumappi.ng";function y(r){var c;return(c=document.cookie.split("; ").map(d=>d.split("=")).find(([d])=>d===r))==null?void 0:c[1]}function X(){const{data:r=[],isLoading:c}=q(),d=P(),v=$(),{notify:n}=_(),j=A(),[o,l]=z.useState(new Set),h=async e=>{d.mutate(e,{onSuccess:()=>{}})},p=async e=>{e.startsWith("n:")&&v.mutate(e)},k=async()=>{const e=r.filter(t=>!t.read&&(t.id.startsWith("n:")||t.kind==="system"&&!t.id.startsWith("b:"))).map(t=>t.id);e.length>0&&(await h(e),n("All notifications marked as read",{variant:"success"}))},u=e=>{if(!e)return null;try{const t=JSON.parse(e);if((t==null?void 0:t.type)==="queue_invite"&&(t!=null&&t.queue_id))return t}catch{}return null},f=async(e,t)=>{if(!o.has(e.id)){l(s=>new Set(s).add(e.id));try{const s=y("csrf")||"",a=await fetch(`${x}/api/moddi/queues/${t}/accept`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":s}});if(a.ok)n("Invitation accepted!",{variant:"success"}),p(e.id),j(`/md/queues/${t}`);else{const m=await a.json().catch(()=>({}));n(m.error||"Failed to accept invitation",{variant:"error"})}}catch{n("Failed to accept invitation",{variant:"error"})}finally{l(s=>{const a=new Set(s);return a.delete(e.id),a})}}},b=async(e,t)=>{if(!o.has(e.id)){l(s=>new Set(s).add(e.id));try{const s=y("csrf")||"",a=await fetch(`${x}/api/moddi/queues/${t}/deny`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":s}});if(a.ok)n("Invitation declined",{variant:"success"}),p(e.id);else{const m=await a.json().catch(()=>({}));n(m.error||"Failed to decline invitation",{variant:"error"})}}catch{n("Failed to decline invitation",{variant:"error"})}finally{l(s=>{const a=new Set(s);return a.delete(e.id),a})}}},N=e=>u(e.text)?i.jsx(D,{size:20,color:"#a78bfa"}):e.kind==="star"?i.jsx(F,{size:20,color:"#f59e0b"}):e.kind==="likes5"?i.jsx(R,{size:20,color:"#f472b6"}):e.kind==="inspiration"?i.jsx(T,{size:20,color:"#7dd3fc"}):e.id.startsWith("b:")?i.jsx(W,{size:20,color:"#a78bfa"}):null,w=e=>u(e.text)?"Queue Invitation":e.kind==="star"?"Star":e.kind==="likes5"?"Likes":e.kind==="inspiration"?"Inspiration":e.id.startsWith("b:")?"Global":"System",S=r.filter(e=>!e.read&&!(e.id.startsWith("b:")&&e.expiresAt&&e.expiresAt<=Date.now())).length;return i.jsxs("div",{className:"col",style:{width:"100%",maxWidth:700,margin:"0 auto"},children:[i.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:16},children:[i.jsx("div",{className:"title",children:"Notifications"}),S>0&&i.jsxs("button",{className:"btn secondary",onClick:k,children:[i.jsx(g,{size:16,style:{marginRight:6}}),"Mark all read"]})]}),c?i.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"Loading..."}):r.length===0?i.jsx("div",{className:"muted",style:{textAlign:"center",padding:32},children:"No notifications yet."}):i.jsx("div",{className:"col",style:{gap:8},children:r.filter(e=>!(e.id.startsWith("b:")&&e.expiresAt&&e.expiresAt<=Date.now())).map(e=>i.jsx("div",{style:{background:e.read?"var(--panel-dark)":"var(--panel)",border:`1px solid ${e.read?"rgba(255,255,255,0.08)":"rgba(125, 211, 252, 0.3)"}`,borderRadius:12,padding:16,cursor:e.videoId?"pointer":"default",opacity:e.read?.7:1},onClick:()=>{!e.read&&e.id.startsWith("n:")&&h([e.id]),e.videoId&&(window.location.hash="/mp/feed")},children:i.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12},children:[i.jsx("div",{style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",borderRadius:"50%"},children:N(e)}),i.jsxs("div",{style:{flex:1,minWidth:0},children:[i.jsxs("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between",marginBottom:4},children:[i.jsx("strong",{style:{fontSize:14},children:w(e)}),i.jsxs("div",{className:"row",style:{alignItems:"center",gap:8},children:[i.jsx("span",{className:"muted",style:{fontSize:12},children:new Date(e.createdAt).toLocaleDateString()}),e.id.startsWith("n:")&&i.jsx("button",{className:"icon-link",onClick:t=>{t.stopPropagation(),p(e.id)},style:{padding:4},children:i.jsx(I,{size:14})})]})]}),i.jsx("div",{style:{fontSize:14,wordBreak:"break-word"},children:(()=>{const t=u(e.text);return t?`${t.inviter_username} invited you to join queue: ${t.queue_name}`:e.text||(e.kind==="star"?"One of your posts was starred!":e.kind==="likes5"?"One of your posts reached 5 likes!":e.kind==="inspiration"?"Someone is inspired by you!":"")})()}),(()=>{const t=u(e.text);return t&&!o.has(e.id)?i.jsxs("div",{className:"row",style:{gap:8,marginTop:12},children:[i.jsxs("button",{className:"btn",onClick:s=>{s.stopPropagation(),f(e,t.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[i.jsx(g,{size:14,style:{marginRight:4}}),"Accept"]}),i.jsxs("button",{className:"btn secondary",onClick:s=>{s.stopPropagation(),b(e,t.queue_id)},style:{fontSize:13,padding:"6px 12px"},children:[i.jsx(C,{size:14,style:{marginRight:4}}),"Decline"]})]}):t&&o.has(e.id)?i.jsx("div",{className:"muted",style:{fontSize:12,marginTop:8},children:"Processing..."}):null})(),e.read&&e.readAt&&i.jsxs("div",{className:"muted",style:{fontSize:11,marginTop:4},children:["Read ",new Date(e.readAt).toLocaleString()]})]})]})},e.id))})]})}export{X as default};

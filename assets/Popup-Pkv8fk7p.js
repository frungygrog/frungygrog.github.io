var Z=Object.defineProperty;var J=(o,e,t)=>e in o?Z(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var M=(o,e,t)=>J(o,typeof e!="symbol"?e+"":e,t);import{_ as Q}from"./index-C9S71Iiy.js";import{r as p,j as k,Z as tt}from"./vendor-react-_vsaDC62.js";import{H as P}from"./vendor-DBgzFpze.js";const et="video-cache",rt=2,x="segments",E="manifests",I="video-tracking",ot=7*24*60*60*1e3,U=500*1024*1024,nt=3;let _=null,T=null;function L(){return _?Promise.resolve(_):T||(T=new Promise((o,e)=>{const t=indexedDB.open(et,rt);t.onerror=()=>e(t.error),t.onsuccess=()=>{_=t.result,o(_)},t.onupgradeneeded=n=>{const r=n.target.result;n.oldVersion;let s;r.objectStoreNames.contains(x)?s=n.target.transaction.objectStore(x):(s=r.createObjectStore(x,{keyPath:"url"}),s.createIndex("timestamp","timestamp",{unique:!1})),s.indexNames.contains("videoId")||s.createIndex("videoId","videoId",{unique:!1});let c;r.objectStoreNames.contains(E)?c=n.target.transaction.objectStore(E):(c=r.createObjectStore(E,{keyPath:"url"}),c.createIndex("timestamp","timestamp",{unique:!1})),c.indexNames.contains("videoId")||c.createIndex("videoId","videoId",{unique:!1}),r.objectStoreNames.contains(I)||r.createObjectStore(I,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),T)}function st(o){try{const e=o.match(/videodelivery\.net\/([^\/]+)\//);if(e)return e[1];const t=new URL(o),n=t.pathname.split("/").filter(r=>r);return n.length>0?t.origin+"/"+n[0]:t.origin}catch{return null}}async function X(o,e=!1,t){try{const n=await L(),r=e?E:x,c=n.transaction([r],"readonly").objectStore(r),d=O(o,e),l=c.get(d);return new Promise(i=>{l.onsuccess=()=>{const u=l.result;if(!u){i(null);return}if(Date.now()-u.timestamp>ot){$(o,e).catch(()=>{}),i(null);return}i(u.data)},l.onerror=()=>{i(null)}})}catch{return null}}async function q(o,e,t=!1,n){try{const r=await L(),s=t?E:x,d=r.transaction([s],"readwrite").objectStore(s),l=O(o,t),i=n||st(o),u={url:l,data:e,timestamp:Date.now(),size:e.byteLength,videoId:i||void 0};await new Promise((f,g)=>{const b=d.put(u);b.onsuccess=()=>f(),b.onerror=()=>g(b.error)}),await it()}catch{}}async function $(o,e=!1){try{const t=await L(),n=e?E:x,s=t.transaction([n],"readwrite").objectStore(n),c=O(o,e);await new Promise((d,l)=>{const i=s.delete(c);i.onsuccess=()=>d(),i.onerror=()=>l(i.error)})}catch{}}async function at(){try{const o=await L();let e=0;for(const t of[x,E]){const s=o.transaction([t],"readonly").objectStore(t).getAll();await new Promise(c=>{s.onsuccess=()=>{const d=s.result;e+=d.reduce((l,i)=>l+i.size,0),c()},s.onerror=()=>c()})}return e}catch{return 0}}async function it(){try{const o=await at();if(o<=U)return;const e=await L(),t=[];for(const r of[x,E]){const s=r===E,l=e.transaction([r],"readonly").objectStore(r).getAll();await new Promise(i=>{l.onsuccess=()=>{const u=l.result;t.push(...u.map(f=>({url:f.url,timestamp:f.timestamp,size:f.size,isManifest:s}))),i()},l.onerror=()=>i()})}t.sort((r,s)=>r.timestamp-s.timestamp);let n=o;for(const r of t){if(n<=U*.8)break;await $(r.url,r.isManifest),n-=r.size}}catch{}}async function ct(o){try{const n=(await L()).transaction([I],"readwrite").objectStore(I),r={videoId:o,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((s,c)=>{const d=n.put(r);d.onsuccess=()=>s(),d.onerror=()=>c(d.error)})}catch{}}async function dt(o){try{const r=(await L()).transaction([I],"readonly").objectStore(I).index("lastAccessed");return new Promise(s=>{const c=r.openCursor(null,"prev"),d=[];c.onsuccess=l=>{const i=l.target.result;i&&d.length<o?(d.push(i.value.videoId),i.continue()):s(d)},c.onerror=()=>s([])})}catch{return[]}}async function lt(o){try{const e=await L(),t=await dt(nt),n=new Set([o,...t]);for(const r of[x,E]){const c=e.transaction([r],"readwrite").objectStore(r),d=c.index("videoId"),l=c.getAll();await new Promise(i=>{l.onsuccess=async()=>{const u=l.result;let f=0;for(const g of u)g.videoId&&!n.has(g.videoId)&&await new Promise(b=>{const R=c.delete(g.url);R.onsuccess=()=>{f++,b()},R.onerror=()=>b()});i()},l.onerror=()=>i()})}}catch{}}function G(o){return o.includes(".m3u8")||o.endsWith("/manifest")}function O(o,e){if(e)try{const t=new URL(o),n=new URLSearchParams(t.search),r=Array.from(n.entries()).sort(([s],[c])=>s.localeCompare(c));return t.search=new URLSearchParams(r).toString(),t.toString()}catch{return o}else try{const t=new URL(o);return t.origin+t.pathname}catch{const t=o.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return t?t[0]:o.split("?")[0]}}const ut=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:lt,getCached:X,isManifest:G,normalizeCacheKey:O,setCached:q,trackVideoAccess:ct},Symbol.toStringTag,{value:"Module"}));class ft{constructor(e){M(this,"context",null);M(this,"stats");M(this,"defaultLoader",null);M(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(e,t,n){this.context=e;const r=e.url,s=G(r);let c;try{const d=r.match(/videodelivery\.net\/([^\/]+)\//);d&&(c=d[1])}catch{}X(r,s).then(d=>{if(d){let l;s?l=new TextDecoder().decode(d):l=d;const i=performance.now();this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=i,this.stats.loaded=d.byteLength,this.stats.total=d.byteLength,this.stats.aborted=!1;const u={data:l,url:r,code:200};n.onSuccess(u,this.stats,e,{});return}this.fetchFromNetwork(r,s,e,t,n,c)}).catch(()=>{this.fetchFromNetwork(r,s,e,t,n,c)})}async fetchFromNetwork(e,t,n,r,s,c){var l;const d=performance.now();try{const i=this.abortController||new AbortController,u=await fetch(e,{method:n.method||"GET",headers:n.headers||{},signal:i.signal}).catch(A=>{throw A.name==="AbortError",A});if(!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);let f;const g=u.headers.get("content-type")||"";t||g.includes("application/vnd.apple.mpegurl")||g.includes("text")?f=await u.text():f=await u.arrayBuffer();const b=performance.now(),R=typeof f=="string"?new TextEncoder().encode(f).length:f.byteLength;if(this.stats.loading.start=d,this.stats.loading.first=d,this.stats.loading.end=b,this.stats.loaded=R,this.stats.total=R,this.stats.aborted=!1,f instanceof ArrayBuffer)await q(e,f,t,c);else{const V=new TextEncoder().encode(f);await q(e,V.buffer,t,c)}const j={data:f,url:u.url,code:u.status};s.onSuccess(j,this.stats,n,{})}catch(i){const u=performance.now();if(this.stats.loading.start=d,this.stats.loading.first=d,this.stats.loading.end=u,this.stats.loaded=0,this.stats.total=0,i instanceof Error&&i.name==="AbortError")this.stats.aborted=!0,(l=s.onAbort)==null||l.call(s,this.stats,n,{});else if(!(i instanceof Error&&i.name==="AbortError")){this.stats.aborted=!1;const f=i instanceof Error?i:new Error("Network error");s.onError({code:0,text:f.message},n,{},this.stats)}}}abort(){this.abortController&&this.abortController.abort()}destroy(){this.context=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}},this.abortController&&(this.abortController.abort(),this.abortController=null)}getStats(){return this.stats}getResponseHeader(e){return null}getCacheAge(){return null}}const bt=({playbackUrl:o,streamUID:e,aspectRatio:t,preferNative:n=!1,autoplay:r=!1,loop:s=!1,muted:c=!1,controls:d=!0,onVideoRef:l,onClick:i})=>{const[u,f]=p.useState(1.7777777777777777),g=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;p.useEffect(()=>{if(!g)return;const a=()=>f(window.innerWidth/Math.max(1,window.innerHeight));return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[g]);const b=p.useRef(null),[R,j]=p.useState(null),A=p.useMemo(()=>{const a=1.3333333333333333,y=16/9,w=typeof t=="number"&&isFinite(t)&&t>0?t:null;if(w)return Math.min(y,Math.max(a,w));const v=g?u:16/9;return Math.min(y,Math.max(a,v))},[g,u,t]),D=`${R??A} / 1`,m=p.useMemo(()=>o||(e?`https://videodelivery.net/${e}/manifest/video.m3u8`:null),[o,e]),z=p.useRef(null),N=p.useMemo(()=>{if(!m)return null;try{const a=m.match(/videodelivery\.net\/([^\/]+)\//);return a?a[1]:m}catch{return m}},[m]);p.useEffect(()=>{!m||!N||(Q(async()=>{const{trackVideoAccess:a,clearOldVideoCache:y}=await Promise.resolve().then(()=>ut);return{trackVideoAccess:a,clearOldVideoCache:y}},void 0).then(({trackVideoAccess:a,clearOldVideoCache:y})=>{a(N).catch(()=>{}),z.current&&z.current!==m&&y(N).catch(()=>{})}),z.current=m)},[m,N]),p.useEffect(()=>{j(null)},[m]),p.useEffect(()=>{if(!n||!b.current)return;const a=b.current;let y=!1;const w=()=>{if(!y)if(a.videoWidth>0&&a.videoHeight>0){const v=a.videoWidth/a.videoHeight,K=4/3,H=16/9,h=Math.min(H,Math.max(K,v));j(h),y=!0}else j(A),y=!0};return a.addEventListener("loadedmetadata",w),a.readyState>=1&&w(),()=>{a.removeEventListener("loadedmetadata",w)}},[n,A,m]),p.useEffect(()=>{if(!m)return;let a=null,y=null,w=!1,v=null;const H=setTimeout(()=>{const h=b.current;if(!(!h||w))if(P.isSupported()){const C={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:ft};a=new P(C),a.loadSource(m),a.attachMedia(h),a.on(P.Events.MANIFEST_PARSED,()=>{w||!h||(s&&(v=()=>{if(!(w||!h||!a))try{a.stopLoad(),h.currentTime=0,a.startLoad(),h.play().catch(S=>{S.name!=="AbortError"&&S.name!=="NotAllowedError"&&console.debug("Loop play failed:",S)})}catch{h.currentTime=0,h.play().catch(()=>{})}},h.addEventListener("ended",v)),r&&!w&&h.play().catch(S=>{S.name!=="AbortError"&&S.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",S)}))}),a.on(P.Events.ERROR,(S,F)=>{if(!w&&F.fatal)switch(F.type){case P.ErrorTypes.NETWORK_ERROR:if(!w&&a)try{a.startLoad()}catch{}break;case P.ErrorTypes.MEDIA_ERROR:if(!w&&a)try{a.recoverMediaError()}catch{}break;default:a&&(a.destroy(),a=null);break}})}else w||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=m,y=()=>{w||console.warn("Native HLS playback failed")},h.addEventListener("error",y),r&&!w&&h.play().catch(C=>{C.name!=="AbortError"&&C.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",C)})},0);return()=>{w=!0,clearTimeout(H);const h=b.current;if(h&&v&&(h.removeEventListener("ended",v),v=null),a){try{a.detachMedia(),a.destroy()}catch{}a=null}if(h){y&&h.removeEventListener("error",y);try{h.pause(),h.src="",h.load()}catch{}}}},[m,r]),p.useEffect(()=>{l&&l(b.current)},[l,n,m]);const W="100%",B=g?{width:"100%",maxWidth:W,maxHeight:"100%",aspectRatio:D,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:W,maxHeight:"100%",height:"var(--player-height)",aspectRatio:D,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return m?k.jsx("div",{style:B,children:k.jsx("video",{ref:b,autoPlay:r,loop:!1,muted:c,controls:d,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:i?"pointer":"default"},children:"Your browser does not support the video tag."},m)}):k.jsx("div",{style:B,children:"No video available"})},yt=({open:o,onClose:e,buttonRef:t,children:n,align:r="right",minWidth:s=160})=>{const[c,d]=p.useState(null),l=p.useRef(null);if(p.useEffect(()=>{if(!o||!t.current){d(null);return}const u=()=>{if(!t.current)return;const f=t.current.getBoundingClientRect();d({top:f.bottom+8,[r]:window.innerWidth-f[r==="right"?"right":"left"]})};return u(),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),()=>{window.removeEventListener("resize",u),window.removeEventListener("scroll",u,!0)}},[o,t,r]),p.useEffect(()=>{if(!o)return;const u=f=>{l.current&&!l.current.contains(f.target)&&t.current&&!t.current.contains(f.target)&&e()};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[o,e,t]),!o||!c)return null;const i=k.jsx("div",{ref:l,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:s,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:n});return tt.createPortal(i,document.body)};export{bt as P,yt as a};

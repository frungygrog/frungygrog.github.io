var V=Object.defineProperty;var K=(n,t,e)=>t in n?V(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var k=(n,t,e)=>K(n,typeof t!="symbol"?t+"":t,e);import{r as m,j as N,Z as D}from"./vendor-react-_vsaDC62.js";import{H as L}from"./vendor-DBgzFpze.js";const X="video-cache",Y=1,v="segments",y="manifests",Z=7*24*60*60*1e3,_=500*1024*1024;let A=null,I=null;function P(){return A?Promise.resolve(A):I||(I=new Promise((n,t)=>{const e=indexedDB.open(X,Y);e.onerror=()=>t(e.error),e.onsuccess=()=>{A=e.result,n(A)},e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(v)||r.createObjectStore(v,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1}),r.objectStoreNames.contains(y)||r.createObjectStore(y,{keyPath:"url"}).createIndex("timestamp","timestamp",{unique:!1})}}),I)}async function G(n,t=!1){try{const e=await P(),a=t?y:v,c=e.transaction([a],"readonly").objectStore(a).get(n);return new Promise(u=>{c.onsuccess=()=>{const d=c.result;if(!d){u(null);return}if(Date.now()-d.timestamp>Z){F(n,t).catch(()=>{}),u(null);return}u(d.data)},c.onerror=()=>u(null)})}catch(e){return console.warn("Cache read error:",e),null}}async function q(n,t,e=!1){try{const a=await P(),r=e?y:v,c=a.transaction([r],"readwrite").objectStore(r),u={url:n,data:t,timestamp:Date.now(),size:t.byteLength};await new Promise((d,l)=>{const o=c.put(u);o.onsuccess=()=>d(),o.onerror=()=>l(o.error)}),await Q()}catch(a){console.warn("Cache write error:",a)}}async function F(n,t=!1){try{const e=await P(),a=t?y:v,i=e.transaction([a],"readwrite").objectStore(a);await new Promise((c,u)=>{const d=i.delete(n);d.onsuccess=()=>c(),d.onerror=()=>u(d.error)})}catch(e){console.warn("Cache delete error:",e)}}async function J(){try{const n=await P();let t=0;for(const e of[v,y]){const i=n.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{i.onsuccess=()=>{const u=i.result;t+=u.reduce((d,l)=>d+l.size,0),c()},i.onerror=()=>c()})}return t}catch(n){return console.warn("Cache size calculation error:",n),0}}async function Q(){try{const n=await J();if(n<=_)return;const t=await P(),e=[];for(const r of[v,y]){const i=r===y,d=t.transaction([r],"readonly").objectStore(r).getAll();await new Promise(l=>{d.onsuccess=()=>{const o=d.result;e.push(...o.map(f=>({url:f.url,timestamp:f.timestamp,size:f.size,isManifest:i}))),l()},d.onerror=()=>l()})}e.sort((r,i)=>r.timestamp-i.timestamp);let a=n;for(const r of e){if(a<=_*.8)break;await F(r.url,r.isManifest),a-=r.size}}catch(n){console.warn("Cache cleanup error:",n)}}function U(n){return n.includes(".m3u8")||n.endsWith("/manifest")}class ee{constructor(){k(this,"context",null);k(this,"stats",null);k(this,"defaultLoader",null)}load(t,e,a){this.context=t;const r=t.url,i=U(r);G(r,i).then(c=>{if(c){const d={trequest:performance.now(),tfirst:performance.now(),tload:performance.now(),loaded:c.byteLength,total:c.byteLength};this.stats=d;const l={data:c,url:r},o=i?"manifest":"segment",f=(c.byteLength/1024).toFixed(2);console.log(`[Video Cache] âœ… Cache HIT - ${o}: ${r.substring(r.lastIndexOf("/")+1)} (${f} KB)`),a.onSuccess(l,d,t);return}console.log(`[Video Cache] âŒ Cache MISS - ${i?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - fetching from network`),this.fetchFromNetwork(r,i,t,e,a)}).catch(c=>{console.warn(`[Video Cache] âš ï¸ Cache error for ${i?"manifest":"segment"}: ${r.substring(r.lastIndexOf("/")+1)} - falling back to network`,c),this.fetchFromNetwork(r,i,t,e,a)})}async fetchFromNetwork(t,e,a,r,i){var u,d;const c=performance.now();try{const l=await fetch(t,{method:a.method||"GET",headers:a.headers||{},signal:(u=a.abortController)==null?void 0:u.signal});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);let o;const f=l.headers.get("content-type")||"";e||f.includes("application/vnd.apple.mpegurl")||f.includes("text")?o=await l.text():o=await l.arrayBuffer();const b=performance.now(),g={trequest:c,tfirst:c,tload:b,loaded:typeof o=="string"?new TextEncoder().encode(o).length:o.byteLength,total:typeof o=="string"?new TextEncoder().encode(o).length:o.byteLength},H=e?"manifest":"segment";if(o instanceof ArrayBuffer){await q(t,o,e);const S=(o.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${H}: ${t.substring(t.lastIndexOf("/")+1)} (${S} KB)`)}else{const $=new TextEncoder().encode(o);await q(t,$.buffer,e);const z=($.byteLength/1024).toFixed(2);console.log(`[Video Cache] ðŸ’¾ Cached ${H}: ${t.substring(t.lastIndexOf("/")+1)} (${z} KB)`)}const C={data:o,url:l.url};this.stats=g,i.onSuccess(C,g,a)}catch(l){const o={trequest:c,tfirst:c,tload:performance.now(),loaded:0,total:0};l instanceof Error&&l.name==="AbortError"?(d=i.onAbort)==null||d.call(i,o,a):i.onError(l instanceof Error?l:new Error("Network error"),a,o)}}abort(){}destroy(){}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const oe=({playbackUrl:n,streamUID:t,aspectRatio:e,preferNative:a=!1,autoplay:r=!1,loop:i=!1,muted:c=!1,controls:u=!0,onVideoRef:d,onClick:l})=>{const[o,f]=m.useState(1.7777777777777777),b=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;m.useEffect(()=>{if(!b)return;const s=()=>f(window.innerWidth/Math.max(1,window.innerHeight));return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[b]);const g=m.useRef(null),[H,C]=m.useState(null),S=m.useMemo(()=>{const s=1.3333333333333333,p=16/9,E=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(E)return Math.min(p,Math.max(s,E));const M=b?o:16/9;return Math.min(p,Math.max(s,M))},[b,o,e]),z=`${H??S} / 1`,w=m.useMemo(()=>n||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[n,t]);m.useEffect(()=>{C(null)},[w]),m.useEffect(()=>{if(!a||!g.current)return;const s=g.current;let p=!1;const E=()=>{if(!p)if(s.videoWidth>0&&s.videoHeight>0){const M=s.videoWidth/s.videoHeight,h=4/3,R=16/9,T=Math.min(R,Math.max(h,M));C(T),p=!0}else C(S),p=!0};return s.addEventListener("loadedmetadata",E),s.readyState>=1&&E(),()=>{s.removeEventListener("loadedmetadata",E)}},[a,S,w]),m.useEffect(()=>{if(!w)return;let s=null,p=null;const M=setTimeout(()=>{const h=g.current;if(h)if(L.isSupported()){const R={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:ee};s=new L(R),s.loadSource(w),s.attachMedia(h),s.on(L.Events.MANIFEST_PARSED,()=>{const T=w.substring(w.lastIndexOf("/")+1);console.log(`[Video Cache] ðŸŽ¬ Video ready to play: ${T}`);let x=!1;const B=()=>{x||(x=!0,console.log(`[Video Cache] â–¶ï¸ Video started playing: ${T}`),h.removeEventListener("playing",B))};h.addEventListener("playing",B),r&&h.play().catch(W=>{console.debug("Autoplay prevented:",W)})}),s.on(L.Events.ERROR,(T,x)=>{if(x.fatal)switch(x.type){case L.ErrorTypes.NETWORK_ERROR:console.warn("HLS network error, trying to recover..."),s==null||s.startLoad();break;case L.ErrorTypes.MEDIA_ERROR:console.warn("HLS media error, trying to recover..."),s==null||s.recoverMediaError();break;default:console.error("HLS fatal error:",x),s==null||s.destroy(),s=null;break}})}else console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=w,p=()=>{console.warn("Native HLS playback failed")},h.addEventListener("error",p),r&&h.play().catch(R=>{console.debug("Autoplay prevented:",R)})},0);return()=>{clearTimeout(M);const h=g.current;s&&(s.destroy(),s=null),h&&(p&&h.removeEventListener("error",p),h.src="")}},[w,r]),m.useEffect(()=>{d&&d(g.current)},[d,a,w]);const j="100%",O=b?{width:"100%",maxWidth:j,maxHeight:"100%",aspectRatio:z,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:j,maxHeight:"100%",height:"var(--player-height)",aspectRatio:z,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return w?N.jsx("div",{style:O,children:N.jsx("video",{ref:g,autoPlay:r,loop:i,muted:c,controls:u,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:l?"pointer":"default"},children:"Your browser does not support the video tag."},w)}):N.jsx("div",{style:O,children:"No video available"})},se=({open:n,onClose:t,buttonRef:e,children:a,align:r="right",minWidth:i=160})=>{const[c,u]=m.useState(null),d=m.useRef(null);if(m.useEffect(()=>{if(!n||!e.current){u(null);return}const o=()=>{if(!e.current)return;const f=e.current.getBoundingClientRect();u({top:f.bottom+8,[r]:window.innerWidth-f[r==="right"?"right":"left"]})};return o(),window.addEventListener("resize",o),window.addEventListener("scroll",o,!0),()=>{window.removeEventListener("resize",o),window.removeEventListener("scroll",o,!0)}},[n,e,r]),m.useEffect(()=>{if(!n)return;const o=f=>{d.current&&!d.current.contains(f.target)&&e.current&&!e.current.contains(f.target)&&t()};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[n,t,e]),!n||!c)return null;const l=N.jsx("div",{ref:d,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:i,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:a});return D.createPortal(l,document.body)};export{oe as P,se as a};

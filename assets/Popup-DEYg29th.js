var ie=Object.defineProperty;var de=(n,t,e)=>t in n?ie(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var M=(n,t,e)=>de(n,typeof t!="symbol"?t+"":t,e);import{_ as le}from"./index-CaZbOYPz.js";import{r as b,j as U,Z as ue}from"./vendor-react-_vsaDC62.js";import{H as L}from"./vendor-DBgzFpze.js";const fe="video-cache",me=2,O="segments",$="manifests",z="video-tracking",he=7*24*60*60*1e3,J=500*1024*1024,pe=3;let q=null,W=null;function N(){return q?Promise.resolve(q):W||(W=new Promise((n,t)=>{const e=indexedDB.open(fe,me);e.onerror=()=>t(e.error),e.onsuccess=()=>{q=e.result,n(q)},e.onupgradeneeded=s=>{const r=s.target.result;s.oldVersion;let a;r.objectStoreNames.contains(O)?a=s.target.transaction.objectStore(O):(a=r.createObjectStore(O,{keyPath:"url"}),a.createIndex("timestamp","timestamp",{unique:!1})),a.indexNames.contains("videoId")||a.createIndex("videoId","videoId",{unique:!1});let c;r.objectStoreNames.contains($)?c=s.target.transaction.objectStore($):(c=r.createObjectStore($,{keyPath:"url"}),c.createIndex("timestamp","timestamp",{unique:!1})),c.indexNames.contains("videoId")||c.createIndex("videoId","videoId",{unique:!1}),r.objectStoreNames.contains(z)||r.createObjectStore(z,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),W)}function we(n){try{const t=n.match(/videodelivery\.net\/([^\/]+)\//);if(t)return t[1];const e=new URL(n),s=e.pathname.split("/").filter(r=>r);return s.length>0?e.origin+"/"+s[0]:e.origin}catch{return null}}async function te(n,t=!1,e){const s=performance.now(),r=t?"MANIFEST":"SEGMENT";try{const a=performance.now(),c=await N(),i=performance.now()-a;console.log(`[VIDEO CACHE] IndexedDB initialized in ${i.toFixed(2)}ms`);const d=t?$:O,f=c.transaction([d],"readonly").objectStore(d),h=X(n,t),m=performance.now(),u=f.get(h);return new Promise(w=>{u.onsuccess=()=>{const y=performance.now()-m,g=performance.now()-s,x=u.result;if(!x){console.log(`[VIDEO CACHE] ${r} not found in cache (lookup took ${g.toFixed(2)}ms, request: ${y.toFixed(2)}ms)`),w(null);return}const v=Date.now()-x.timestamp;if(v>he){console.log(`[VIDEO CACHE] ${r} cache entry expired (age: ${(v/1e3).toFixed(2)}s), deleting`),re(n,t).catch(()=>{}),w(null);return}console.log(`[VIDEO CACHE] ${r} found in cache (lookup took ${g.toFixed(2)}ms, request: ${y.toFixed(2)}ms, size: ${x.data.byteLength} bytes, age: ${(v/1e3).toFixed(2)}s)`),w(x.data)},u.onerror=()=>{const y=performance.now()-s;console.error(`[VIDEO CACHE] Error looking up ${r} after ${y.toFixed(2)}ms`),w(null)}})}catch(a){const c=performance.now()-s;return console.error(`[VIDEO CACHE] Exception during ${r} lookup after ${c.toFixed(2)}ms:`,a),null}}async function oe(n,t,e=!1,s){const r=performance.now(),a=e?"MANIFEST":"SEGMENT";try{const c=performance.now(),i=await N(),d=performance.now()-c,p=e?$:O,h=i.transaction([p],"readwrite").objectStore(p),m=X(n,e),u=s||we(n),w={url:m,data:t,timestamp:Date.now(),size:t.byteLength,videoId:u||void 0},y=performance.now();await new Promise((x,v)=>{const E=h.put(w);E.onsuccess=()=>{const H=performance.now()-y;console.log(`[VIDEO CACHE] ${a} stored in IndexedDB in ${H.toFixed(2)}ms (size: ${t.byteLength} bytes)`),x()},E.onerror=()=>{const H=performance.now()-y;console.error(`[VIDEO CACHE] Error storing ${a} after ${H.toFixed(2)}ms:`,E.error),v(E.error)}});const g=performance.now()-r;console.log(`[VIDEO CACHE] Total ${a} cache write time: ${g.toFixed(2)}ms`),ye().catch(()=>{})}catch(c){const i=performance.now()-r;console.error(`[VIDEO CACHE] Exception storing ${a} after ${i.toFixed(2)}ms:`,c)}}async function re(n,t=!1){try{const e=await N(),s=t?$:O,a=e.transaction([s],"readwrite").objectStore(s),c=X(n,t);await new Promise((i,d)=>{const p=a.delete(c);p.onsuccess=()=>i(),p.onerror=()=>d(p.error)})}catch{}}async function Ee(){try{const n=await N();let t=0;for(const e of[O,$]){const a=n.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{a.onsuccess=()=>{const i=a.result;t+=i.reduce((d,p)=>d+p.size,0),c()},a.onerror=()=>c()})}return t}catch{return 0}}let K=!1,ee=0;const ge=5e3;async function ye(){const n=Date.now();if(K||n-ee<ge)return;K=!0,ee=n;const t=performance.now();try{const e=await Ee();if(e<=J){K=!1;return}console.log(`[VIDEO CACHE] Starting cache cleanup (size: ${(e/1024/1024).toFixed(2)}MB, max: ${(J/1024/1024).toFixed(2)}MB)`);const s=await N(),r=[];for(const d of[O,$]){const p=d===$,m=s.transaction([d],"readonly").objectStore(d).index("timestamp");await new Promise(u=>{const w=m.openCursor();w.onsuccess=y=>{const g=y.target.result;if(g){const x=g.value;r.push({url:x.url,timestamp:x.timestamp,size:x.size,isManifest:p}),g.continue()}else u()},w.onerror=()=>u()})}let a=e,c=0;for(const d of r){if(a<=J*.8)break;await re(d.url,d.isManifest),a-=d.size,c++}const i=performance.now()-t;console.log(`[VIDEO CACHE] Cache cleanup completed in ${i.toFixed(2)}ms (deleted ${c} entries, new size: ${(a/1024/1024).toFixed(2)}MB)`)}catch(e){const s=performance.now()-t;console.error(`[VIDEO CACHE] Cache cleanup error after ${s.toFixed(2)}ms:`,e)}finally{K=!1}}async function Se(n){try{const s=(await N()).transaction([z],"readwrite").objectStore(z),r={videoId:n,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((a,c)=>{const i=s.put(r);i.onsuccess=()=>a(),i.onerror=()=>c(i.error)})}catch{}}async function xe(n){try{const r=(await N()).transaction([z],"readonly").objectStore(z).index("lastAccessed");return new Promise(a=>{const c=r.openCursor(null,"prev"),i=[];c.onsuccess=d=>{const p=d.target.result;p&&i.length<n?(i.push(p.value.videoId),p.continue()):a(i)},c.onerror=()=>a([])})}catch{return[]}}async function be(n){try{const t=await N(),e=await xe(pe),s=new Set([n,...e]);for(const r of[O,$]){const c=t.transaction([r],"readwrite").objectStore(r),i=c.index("videoId"),d=c.getAll();await new Promise(p=>{d.onsuccess=async()=>{const f=d.result;let h=0;for(const m of f)m.videoId&&!s.has(m.videoId)&&await new Promise(u=>{const w=c.delete(m.url);w.onsuccess=()=>{h++,u()},w.onerror=()=>u()});p()},d.onerror=()=>p()})}}catch{}}function ne(n){return n.includes(".m3u8")||n.endsWith("/manifest")}function X(n,t){if(t)try{const e=new URL(n),s=new URLSearchParams(e.search),r=Array.from(s.entries()).sort(([a],[c])=>a.localeCompare(c));return e.search=new URLSearchParams(r).toString(),e.toString()}catch{return n}else try{const e=new URL(n);return e.origin+e.pathname}catch{const e=n.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return e?e[0]:n.split("?")[0]}}const Ce=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:be,getCached:te,isManifest:ne,normalizeCacheKey:X,setCached:oe,trackVideoAccess:Se},Symbol.toStringTag,{value:"Module"}));class Ae{constructor(){M(this,"cache",new Map);M(this,"maxSize",100);M(this,"maxAge",5*60*1e3)}get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.maxAge?(this.cache.delete(t),null):(this.cache.delete(t),this.cache.set(t,e),e.data):null}set(t,e){if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s&&this.cache.delete(s)}this.cache.set(t,{data:e,timestamp:Date.now()})}clear(){this.cache.clear()}}const G=new Ae;class se{constructor(t){M(this,"context",null);M(this,"stats");M(this,"defaultLoader",null);M(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,s){this.context=t;const r=t.url,a=ne(r),c=performance.now(),i=a?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Loading ${i}: ${r} at ${c.toFixed(2)}ms`);let d;try{const u=r.match(/videodelivery\.net\/([^\/]+)\//);u&&(d=u[1])}catch{}const p=performance.now(),f=G.get(r),h=performance.now()-p;if(f){const u=performance.now()-c;console.log(`[CACHE LOADER] ${i} found in memory cache in ${u.toFixed(2)}ms (lookup: ${h.toFixed(2)}ms)`);let w;a?w=new TextDecoder().decode(f):w=f;const y=performance.now();this.stats.loading.start=y,this.stats.loading.first=y,this.stats.loading.end=y,this.stats.loaded=f.byteLength,this.stats.total=f.byteLength,this.stats.aborted=!1;const g={data:w,url:r,code:200};s.onSuccess(g,this.stats,t,{});return}console.log(`[CACHE LOADER] ${i} not in memory cache (lookup took ${h.toFixed(2)}ms), checking IndexedDB`);const m=performance.now();te(r,a).then(u=>{const w=performance.now()-m;if(u){const y=performance.now()-c;console.log(`[CACHE LOADER] ${i} found in IndexedDB cache in ${y.toFixed(2)}ms (lookup: ${w.toFixed(2)}ms)`),G.set(r,u);let g;a?g=new TextDecoder().decode(u):g=u;const x=performance.now();this.stats.loading.start=x,this.stats.loading.first=x,this.stats.loading.end=x,this.stats.loaded=u.byteLength,this.stats.total=u.byteLength,this.stats.aborted=!1;const v={data:g,url:r,code:200};s.onSuccess(v,this.stats,t,{});return}console.log(`[CACHE LOADER] ${i} not in IndexedDB cache (lookup took ${w.toFixed(2)}ms), fetching from network`),this.fetchFromNetwork(r,a,t,e,s,d)}).catch(u=>{const w=performance.now()-m;console.error(`[CACHE LOADER] IndexedDB lookup error after ${w.toFixed(2)}ms:`,u),this.fetchFromNetwork(r,a,t,e,s,d)})}async fetchFromNetwork(t,e,s,r,a,c){var p;const i=performance.now(),d=e?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Fetching ${d} from network: ${t} at ${i.toFixed(2)}ms`);try{const f=this.abortController||new AbortController,h=await fetch(t,{method:s.method||"GET",headers:s.headers||{},signal:f.signal}).catch(T=>{throw T.name==="AbortError",T});if(!h.ok)throw new Error(`HTTP ${h.status}: ${h.statusText}`);let m;const u=h.headers.get("content-type")||"";e||u.includes("application/vnd.apple.mpegurl")||u.includes("text")?m=await h.text():m=await h.arrayBuffer();const w=performance.now(),y=w-i,g=typeof m=="string"?new TextEncoder().encode(m).length:m.byteLength;console.log(`[CACHE LOADER] ${d} fetched from network in ${y.toFixed(2)}ms, size: ${g} bytes`),this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=w,this.stats.loaded=g,this.stats.total=g,this.stats.aborted=!1;const x=performance.now(),v=m instanceof ArrayBuffer?m:new TextEncoder().encode(m).buffer,E=performance.now();G.set(t,v);const H=performance.now()-E;console.log(`[CACHE LOADER] ${d} stored in memory cache in ${H.toFixed(2)}ms`),oe(t,v,e,c).then(()=>{const T=performance.now()-x;console.log(`[CACHE LOADER] ${d} stored in IndexedDB in ${T.toFixed(2)}ms`)}).catch(T=>{console.error(`[CACHE LOADER] Error storing ${d} in IndexedDB:`,T)});const k={data:m,url:h.url,code:h.status};a.onSuccess(k,this.stats,s,{})}catch(f){const h=performance.now();if(this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=h,this.stats.loaded=0,this.stats.total=0,f instanceof Error&&f.name==="AbortError")this.stats.aborted=!0,(p=a.onAbort)==null||p.call(a,this.stats,s,{});else if(!(f instanceof Error&&f.name==="AbortError")){this.stats.aborted=!1;const m=f instanceof Error?f:new Error("Network error");a.onError({code:0,text:m.message},s,{},this.stats)}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=new AbortController)}destroy(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.context=null,this.defaultLoader=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const $e=Object.freeze(Object.defineProperty({__proto__:null,CachedLoader:se,memoryCache:G},Symbol.toStringTag,{value:"Module"})),He=({playbackUrl:n,streamUID:t,aspectRatio:e,preferNative:s=!1,autoplay:r=!1,loop:a=!1,muted:c=!1,controls:i=!0,onVideoRef:d,onClick:p})=>{const[f,h]=b.useState(1.7777777777777777),m=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;b.useEffect(()=>{if(!m)return;const o=()=>h(window.innerWidth/Math.max(1,window.innerHeight));return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[m]);const u=b.useRef(null),[w,y]=b.useState(null),g=b.useMemo(()=>{const o=1.3333333333333333,C=16/9,S=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(S)return Math.min(C,Math.max(o,S));const F=m?f:16/9;return Math.min(C,Math.max(o,F))},[m,f,e]),v=`${w??g} / 1`,E=b.useMemo(()=>n||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[n,t]),H=b.useRef(null),k=b.useMemo(()=>{if(!E)return null;try{const o=E.match(/videodelivery\.net\/([^\/]+)\//);return o?o[1]:E}catch{return E}},[E]);b.useEffect(()=>{!E||!k||(le(async()=>{const{trackVideoAccess:o,clearOldVideoCache:C}=await Promise.resolve().then(()=>Ce);return{trackVideoAccess:o,clearOldVideoCache:C}},void 0).then(({trackVideoAccess:o,clearOldVideoCache:C})=>{o(k).catch(()=>{}),H.current&&H.current!==E&&C(k).catch(()=>{})}),H.current=E)},[E,k]),b.useEffect(()=>{y(null)},[E]),b.useEffect(()=>{if(!s||!u.current)return;const o=u.current;let C=!1;const S=()=>{if(!C)if(o.videoWidth>0&&o.videoHeight>0){const F=o.videoWidth/o.videoHeight,B=4/3,V=16/9,Y=Math.min(V,Math.max(B,F));y(Y),C=!0}else y(g),C=!0};return o.addEventListener("loadedmetadata",S),o.readyState>=1&&S(),()=>{o.removeEventListener("loadedmetadata",S)}},[s,g,E]),b.useEffect(()=>{if(!E)return;let o=null,C=null,S=!1,F=null;const B=()=>{if(document.hidden&&o){const l=u.current;if(l)try{l.pause()}catch{}try{o.stopLoad()}catch{}}},V=()=>{if(S=!0,o){try{o.stopLoad(),o.detachMedia(),o.destroy()}catch{}o=null}};document.addEventListener("visibilitychange",B),window.addEventListener("beforeunload",V);const Y=()=>{const l=u.current;if(!l||S)return;try{for(l.pause(),l.currentTime=0,l.src="",l.srcObject=null;l.firstChild;)l.removeChild(l.firstChild);l.load()}catch{}const R=performance.now();if(console.log(`[HLS] Starting HLS setup for ${E} at ${R.toFixed(2)}ms`),L.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const _={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,startFragPrefetch:!0,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3,loader:se};try{const j=performance.now();o=new L(_);const P=performance.now()-j;console.log(`[HLS] HLS instance created in ${P.toFixed(2)}ms`);const A=performance.now();o.loadSource(E);const I=performance.now()-A;console.log(`[HLS] loadSource() called in ${I.toFixed(2)}ms`);const D=performance.now();o.attachMedia(l);const Z=performance.now()-D;console.log(`[HLS] attachMedia() completed in ${Z.toFixed(2)}ms`);const ce=performance.now()-R;console.log(`[HLS] Total HLS setup time: ${ce.toFixed(2)}ms`)}catch(j){const P=performance.now()-R;if(console.error(`[HLS] Failed to initialize HLS after ${P.toFixed(2)}ms:`,j),o){try{o.destroy()}catch{}o=null}return}o.on(L.Events.MANIFEST_PARSED,()=>{const j=performance.now()-R;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${j.toFixed(2)}ms after setup start`),S||!l)return;a&&(F=()=>{if(!(S||!l||!o))try{o.stopLoad(),l.currentTime=0,o.startLoad(),l.play().catch(A=>{A.name!=="AbortError"&&A.name!=="NotAllowedError"&&console.debug("Loop play failed:",A)})}catch{l.currentTime=0,l.play().catch(()=>{})}},l.addEventListener("ended",F)),(()=>{if(!(S||!l))if(l.readyState>=2){if(r){const A=performance.now();l.play().then(()=>{const I=performance.now()-A;console.log(`[HLS] Autoplay succeeded in ${I.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(I=>{const D=performance.now()-A;I.name!=="AbortError"&&I.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${D.toFixed(2)}ms:`,I)})}}else{const A=()=>{if(!(S||!l)&&(l.removeEventListener("canplay",A),r)){const I=performance.now();l.play().then(()=>{const D=performance.now()-I;console.log(`[HLS] Autoplay succeeded in ${D.toFixed(2)}ms after canplay event`)}).catch(D=>{const Z=performance.now()-I;D.name!=="AbortError"&&D.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${Z.toFixed(2)}ms:`,D)})}};l.addEventListener("canplay",A,{once:!0})}})()}),o.on(L.Events.ERROR,(j,P)=>{if(!S&&P.fatal)switch(P.type){case L.ErrorTypes.NETWORK_ERROR:if(!S&&o)try{o.startLoad()}catch{}break;case L.ErrorTypes.MEDIA_ERROR:if(!S&&o)try{o.recoverMediaError()}catch{}break;default:o&&(o.destroy(),o=null);break}})}else S||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),l.src=E,C=()=>{S||console.warn("Native HLS playback failed")},l.addEventListener("error",C),r&&!S&&l.play().catch(_=>{_.name!=="AbortError"&&_.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",_)})},ae=setTimeout(()=>{S||Y()},0);return()=>{clearTimeout(ae),S=!0,document.removeEventListener("visibilitychange",B),window.removeEventListener("beforeunload",V);const l=u.current;if(l&&F&&(l.removeEventListener("ended",F),F=null),o){try{o.off(L.Events.MANIFEST_PARSED),o.off(L.Events.ERROR),o.off(L.Events.MEDIA_ATTACHED),o.off(L.Events.MEDIA_DETACHED),o.off(L.Events.MANIFEST_LOADED),o.stopLoad(),o.detachMedia(),o.destroy()}catch{}o=null}if(l){C&&(l.removeEventListener("error",C),C=null);try{l.pause()}catch{}}}},[E,r]),b.useEffect(()=>{d&&d(u.current)},[d,s,E]);const T="100%",Q=m?{width:"100%",maxWidth:T,maxHeight:"100%",aspectRatio:v,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:T,maxHeight:"100%",height:"var(--player-height)",aspectRatio:v,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return E?U.jsx("div",{style:Q,children:U.jsx("video",{ref:u,autoPlay:r,loop:!1,muted:c,controls:i,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:p?"pointer":"default"},children:"Your browser does not support the video tag."})}):U.jsx("div",{style:Q,children:"No video available"})},Fe=({open:n,onClose:t,buttonRef:e,children:s,align:r="right",minWidth:a=160})=>{const[c,i]=b.useState(null),d=b.useRef(null);if(b.useEffect(()=>{if(!n||!e.current){i(null);return}const f=()=>{if(!e.current)return;const h=e.current.getBoundingClientRect();i({top:h.bottom+8,[r]:window.innerWidth-h[r==="right"?"right":"left"]})};return f(),window.addEventListener("resize",f),window.addEventListener("scroll",f,!0),()=>{window.removeEventListener("resize",f),window.removeEventListener("scroll",f,!0)}},[n,e,r]),b.useEffect(()=>{if(!n)return;const f=h=>{d.current&&!d.current.contains(h.target)&&e.current&&!e.current.contains(h.target)&&t()};return document.addEventListener("mousedown",f),()=>document.removeEventListener("mousedown",f)},[n,t,e]),!n||!c)return null;const p=U.jsx("div",{ref:d,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return ue.createPortal(p,document.body)};export{He as P,Fe as a,$e as h,Ce as v};

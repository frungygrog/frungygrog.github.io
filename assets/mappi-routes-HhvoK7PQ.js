import{r as i,j as t,d as Ke,u as Re,e as Te,L as fe,A as Pe,F as Me,f as Qe,g as Ze,h as ke,i as Ee,k as _e,l as Ne,m as et,n as tt,R as nt,c as it,o as at,p as rt,q as st}from"./vendor-react-CJJ8g4j9.js";import{H as q}from"./vendor-hls-B_fsdCYC.js";import{B as ot}from"./editor-2rGn0xn5.js";import{P as lt}from"./beatmap-preview-BPnr1eYJ.js";function Ae(){if(typeof window>"u")return!1;try{const e=navigator.userAgentData;if(e&&typeof e.mobile=="boolean"&&e.mobile||window.matchMedia&&(window.matchMedia("(pointer: coarse)").matches||window.matchMedia("(hover: none)").matches))return!0;const o=navigator.userAgent||"";if(/Android|iPhone|iPad|iPod|Mobile|Silk|Kindle|Opera Mini|IEMobile|WPDesktop/i.test(o))return!0}catch{}return!1}function vt(){var h;if(typeof window>"u"||typeof document>"u")return()=>{};const e=()=>{const d=Ae();document.documentElement.classList.toggle("is-mobile",d),document.documentElement.setAttribute("data-mobile",d?"true":"false")};e();const o=["(pointer: coarse)","(hover: none)","(orientation: landscape)","(orientation: portrait)"],l=[];try{for(const d of o)if(window.matchMedia){const u=window.matchMedia(d);(h=u.addEventListener)==null||h.call(u,"change",e),l.push(u)}}catch{}return window.addEventListener("resize",e),()=>{try{l.forEach(d=>{var u;return(u=d.removeEventListener)==null?void 0:u.call(d,"change",e)}),window.removeEventListener("resize",e)}catch{}}}function bt(){if(typeof window>"u")return!1;try{const e=navigator.standalone===!0,o=window.matchMedia&&window.matchMedia("(display-mode: standalone)"),l=!!(o&&o.matches),h=window.matchMedia&&window.matchMedia("(display-mode: minimal-ui)"),d=window.matchMedia&&window.matchMedia("(display-mode: fullscreen)");return e||l||!!(h&&h.matches)||!!(d&&d.matches)}catch{return!1}}const Ie=i.createContext(null);function yt({children:e}){const[o,l]=i.useState([]),h=i.useRef(1),d=i.useRef(new Map),u=m=>{const g=d.current.get(m);g&&(clearTimeout(g),d.current.delete(m))},s=(m,g)=>{u(m);const x=window.setTimeout(()=>v(m),g);d.current.set(m,x)},v=i.useCallback(m=>{u(m),l(g=>g.filter(x=>x.id!==m))},[]),a=i.useCallback((m,g)=>{const x=typeof g=="number"?g:(g==null?void 0:g.durationMs)??5e3,L=typeof g=="number"?"info":(g==null?void 0:g.variant)??"info",M=Ae();let C=null;return l(M?R=>{const j=R[0];if(j&&j.message===m&&j.variant===L){const E={...j,count:j.count+1,duration:x};return C=E.id,[E]}R.forEach(E=>u(E.id));const b=h.current++,z={id:b,message:m,duration:x,variant:L,count:1};return C=b,[z]}:R=>{const j=R.findIndex(E=>E.message===m&&E.variant===L);if(j!==-1){const E=[...R],T={...E[j],count:E[j].count+1};return E[j]=T,C=T.id,E}const b=h.current++,z={id:b,message:m,duration:x,variant:L,count:1};return C=b,[...R,z]}),C!=null&&s(C,x),C??-1},[]),S=i.useMemo(()=>({notify:a,close:v}),[a,v]);return t.jsxs(Ie.Provider,{value:S,children:[e,t.jsx("div",{className:"toasts",children:o.map(m=>t.jsxs("div",{className:`toast ${m.variant}`,children:[t.jsxs("div",{className:"toast-text",children:[m.message,m.count>1&&t.jsxs("span",{style:{marginLeft:6,opacity:.8},children:["×",m.count]})]}),t.jsx("button",{className:"toast-close",onClick:()=>v(m.id),"aria-label":"Close",children:"×"})]},m.id))})]})}function xe(){const e=i.useContext(Ie);if(!e)throw new Error("useToasts must be used within ToastProvider");return e}const ve="https://api.osumappi.ng";function dt(){var e;try{return((e=document.cookie.split("; ").map(o=>o.split("=")).find(([o])=>o==="csrf"))==null?void 0:e[1])||""}catch{return""}}async function B(e,o={}){const{requireAuth:l=!0,skipCsrf:h=!1,...d}=o,u={...d.headers};if(d.body&&!u["Content-Type"]&&(u["Content-Type"]="application/json"),l&&!h){const v=dt();v&&(u["X-CSRF-Token"]=v)}const s=await fetch(`${ve}${e}`,{...d,credentials:"include",headers:u});if(!s.ok){const v=await s.json().catch(()=>({error:`HTTP ${s.status}`}));throw new Error(v.error||`HTTP ${s.status}: ${s.statusText}`)}return s.json()}function Le(e){const o=new URLSearchParams;for(const[h,d]of Object.entries(e))d!=null&&o.append(h,String(d));const l=o.toString();return l?`?${l}`:""}const H={auth:{login:"/api/auth/login",logout:"/api/auth/logout",me:"/api/me"},user:{quota:"/api/me/upload_quota",notifications:"/api/me/notifications",markNotificationsRead:"/api/me/notifications/mark_read",deleteNotification:e=>`/api/me/notifications/${encodeURIComponent(e)}`,pushSubscribe:"/api/me/push/subscribe",pushUnsubscribe:"/api/me/push/unsubscribe",pushList:"/api/me/push/subscriptions",pushTest:"/api/me/push/test",notifPrefs:"/api/me/notification_prefs"},feed:{next:"/api/feed/next",batch:"/api/feed/batch",progress:e=>`/api/feed/progress${e?`?modes=${encodeURIComponent(e)}`:""}`,recent:"/api/videos/recent"},videos:{like:e=>`/api/videos/${e}/like`,view:e=>`/api/videos/${e}/view`,update:e=>`/api/videos/${e}`,delete:e=>`/api/videos/${e}`,flag:e=>`/api/videos/${e}/flag`,comments:e=>`/api/videos/${e}/comments`,get:e=>`/api/videos/${e}`},uploads:{new:"/api/uploads/new"},moddi:{mySubmissions:"/api/moddi/me/submissions",posts:"/api/moddiposts",post:e=>`/api/moddiposts/${e}`,postReact:e=>`/api/moddiposts/${e}/react`,postComments:e=>`/api/moddiposts/${e}/comments`,queues:"/api/moddi/queues",queue:e=>`/api/moddi/queues/${e}`,queueSubmit:e=>`/api/moddi/queues/${e}/submit`,queueAccept:e=>`/api/moddi/queues/${e}/accept`,queueDeny:e=>`/api/moddi/queues/${e}/deny`,queueInvite:e=>`/api/moddi/queues/${e}/invite`,queueMember:(e,o)=>`/api/moddi/queues/${e}/members/${o}`,queueSubmission:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}`,queueSubmissionDelete:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}`,queueBlockUser:e=>`/api/moddi/queues/${e}/block`,queueUnblockUser:(e,o)=>`/api/moddi/queues/${e}/block/${o}`,queueBlockedUsers:e=>`/api/moddi/queues/${e}/blocked`,queueSubmissionAcknowledge:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}/acknowledge`,queueSubmissionUnacknowledge:(e,o)=>`/api/moddi/queues/${e}/submissions/${o}/acknowledge`,usersSearch:e=>`/api/moddi/users/search?q=${encodeURIComponent(e)}`},osu:{resolveBeatmap:"/api/osu/beatmap/resolve",downloadBeatmapset:e=>`/api/osu/beatmapsets/${e}/download?noVideo=1`,usersSearch:e=>`/api/osu/users/search?q=${encodeURIComponent(e)}`},users:{get:e=>`/api/users/${e}`,videos:e=>`/api/users/${e}/videos`,likes:e=>`/api/users/${e}/likes`,myVideos:"/api/me/videos"},admin:{clearViews:"/api/admin/me/clear_views",debugState:"/api/debug/state",settingsModeration:"/api/admin/settings/moderation",videosPending:"/api/admin/videos/pending",videosApprove:e=>`/api/admin/videos/${e}/approve`,videosReject:e=>`/api/admin/videos/${e}/reject`,videosAction:(e,o)=>`/api/admin/videos/${e}/${o}`,analytics:"/api/admin/analytics",usersSearch:e=>`/api/admin/users/search?q=${encodeURIComponent(e)}`,userVideos:e=>`/api/admin/users/${e}/videos`,userUpdate:e=>`/api/admin/users/${e}`,notificationsSystem:"/api/admin/notifications/system",notificationsTest:"/api/admin/notifications/test"}},Ce=/(\d{2}:\d{2}:\d{3})(?:\s+\(([\d,]+)\))?/g;function $e(e,o){return o?`osu://edit/${e}-(${o})`:`osu://edit/${e}`}function ge({text:e,className:o,style:l}){Ce.lastIndex=0;const h=[];let d=0,u;for(;(u=Ce.exec(e))!==null;){u.index>d&&h.push(e.substring(d,u.index));const s=u[1],v=u[2],a=u[0];h.push(t.jsx("a",{href:$e(s,v),onClick:S=>{S.preventDefault(),window.location.href=$e(s,v)},style:{color:"var(--primary)",textDecoration:"none",cursor:"pointer"},onMouseEnter:S=>{S.currentTarget.style.textDecoration="underline"},onMouseLeave:S=>{S.currentTarget.style.textDecoration="none"},title:"Open in osu! editor",children:a},u.index)),d=u.index+u[0].length}return d<e.length&&h.push(e.substring(d)),h.length===0?t.jsx("span",{className:o,style:l,children:e}):t.jsx("span",{className:o,style:l,children:h})}const He=({open:e,onClose:o,buttonRef:l,children:h,align:d="right",minWidth:u=160})=>{const[s,v]=i.useState(null),a=i.useRef(null);if(i.useEffect(()=>{if(!e||!l.current){v(null);return}const m=()=>{if(!l.current)return;const g=l.current.getBoundingClientRect();v({top:g.bottom+8,[d]:window.innerWidth-g[d==="right"?"right":"left"]})};return m(),window.addEventListener("resize",m),window.addEventListener("scroll",m,!0),()=>{window.removeEventListener("resize",m),window.removeEventListener("scroll",m,!0)}},[e,l,d]),i.useEffect(()=>{if(!e)return;const m=g=>{a.current&&!a.current.contains(g.target)&&l.current&&!l.current.contains(g.target)&&o()};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[e,o,l]),!e||!s)return null;const S=t.jsx("div",{ref:a,style:{position:"fixed",top:s.top,[d]:s[d],background:"var(--panel)",border:"1px solid var(--divider)",borderRadius:10,padding:6,zIndex:1e3,minWidth:u,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:h});return Ke.createPortal(S,document.body)},ze=({playbackUrl:e,streamUID:o,aspectRatio:l,preferNative:h=!1,autoplay:d=!1,loop:u=!1,muted:s=!1,controls:v=!0,onVideoRef:a,onClick:S,inOverlay:m=!1})=>{const g=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches,x=i.useRef(null),[L,M]=i.useState(null),C=i.useMemo(()=>{const r=typeof l=="number"&&isFinite(l)&&l>0?l:null;return r||16/9},[l]),j=`${L??C} / 1`,b=i.useMemo(()=>e||(o?`https://videodelivery.net/${o}/manifest/video.m3u8`:null),[e,o]),z=i.useRef(null);i.useEffect(()=>{b&&(z.current=b)},[b]),i.useEffect(()=>{M(null)},[b]),i.useEffect(()=>{if(!h||!x.current)return;const r=x.current;let F=!1;const k=()=>{if(!F)if(r.videoWidth>0&&r.videoHeight>0){const W=r.videoWidth/r.videoHeight;M(W),F=!0}else M(C),F=!0};return r.addEventListener("loadedmetadata",k),r.readyState>=1&&k(),()=>{r.removeEventListener("loadedmetadata",k)}},[h,C,b]);const E=i.useRef(null),T=i.useRef(null);i.useEffect(()=>{if(!b)return;let r=E.current,F=null,k=!1,W=null;if(r&&T.current&&T.current!==b){console.log(`[HLS] URL changed from ${T.current} to ${b}, using loadSource`);try{r.stopLoad(),r.loadSource(b),T.current=b;const c=x.current;if(c)try{c.pause(),c.currentTime=0,c.load()}catch(N){console.warn("[HLS] Error resetting video element:",N)}}catch(c){console.error("[HLS] Error switching source:",c);try{r.destroy()}catch{}r=null,E.current=null,T.current=null}}if(r&&T.current===b)return console.log(`[HLS] URL unchanged (${b}), reusing existing HLS instance`),()=>{k=!0};const K=()=>{if(document.hidden&&r){const c=x.current;if(c)try{c.pause()}catch{}try{r.stopLoad()}catch{}}},le=()=>{if(k=!0,r){try{r.stopLoad(),r.detachMedia(),r.destroy()}catch{}r=null}};document.addEventListener("visibilitychange",K),window.addEventListener("beforeunload",le);const U=()=>{const c=x.current;if(!c||k)return;try{for(c.pause(),c.currentTime=0,c.src="",c.srcObject=null;c.firstChild;)c.removeChild(c.firstChild);c.load()}catch(p){console.warn("[HLS] Error resetting video element:",p)}const N=performance.now();if(console.log(`[HLS] Starting HLS setup for ${b} at ${N.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:c.readyState,isConnected:c.isConnected,paused:c.paused,currentTime:c.currentTime}),q.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const p={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const y=performance.now();r=new q(p),E.current=r,T.current=b;const P=performance.now()-y;console.log(`[HLS] HLS instance created in ${P.toFixed(2)}ms`);const A=performance.now();r.loadSource(b);const O=performance.now()-A;console.log(`[HLS] loadSource() called in ${O.toFixed(2)}ms`);const D=performance.now();r.attachMedia(c);const re=performance.now()-D;console.log(`[HLS] attachMedia() completed in ${re.toFixed(2)}ms`);const de=performance.now()-N;console.log(`[HLS] Total HLS setup time: ${de.toFixed(2)}ms`)}catch(y){const P=performance.now()-N;if(console.error(`[HLS] Failed to initialize HLS after ${P.toFixed(2)}ms:`,y),r){try{r.destroy()}catch{}r=null}return}r.on(q.Events.MANIFEST_PARSED,()=>{const y=performance.now()-N;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${y.toFixed(2)}ms after setup start`),k||!c)return;u&&(W=()=>{if(!(k||!c||!r))try{c.currentTime=0,c.play().catch(A=>{A.name!=="AbortError"&&A.name!=="NotAllowedError"&&console.debug("Loop play failed:",A)})}catch{c.currentTime=0,c.play().catch(()=>{})}},c.addEventListener("ended",W)),(()=>{if(!(k||!c))if(c.readyState>=2){if(d){const A=performance.now();c.play().then(()=>{const O=performance.now()-A;console.log(`[HLS] Autoplay succeeded in ${O.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(O=>{const D=performance.now()-A;O.name!=="AbortError"&&O.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${D.toFixed(2)}ms:`,O)})}}else{const A=()=>{if(!(k||!c)&&(c.removeEventListener("canplay",A),d)){const O=performance.now();c.play().then(()=>{const D=performance.now()-O;console.log(`[HLS] Autoplay succeeded in ${D.toFixed(2)}ms after canplay event`)}).catch(D=>{const re=performance.now()-O;D.name!=="AbortError"&&D.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${re.toFixed(2)}ms:`,D)})}};c.addEventListener("canplay",A,{once:!0})}})()}),r.on(q.Events.ERROR,(y,P)=>{if(!k&&P.fatal)switch(P.type){case q.ErrorTypes.NETWORK_ERROR:if(!k&&r)try{r.startLoad()}catch{}break;case q.ErrorTypes.MEDIA_ERROR:if(!k&&r)try{r.recoverMediaError()}catch{}break;default:r&&(r.destroy(),r=null);break}})}else k||console.warn("HLS.js not supported, falling back to native HLS"),c.src=b,c.loop=u,F=()=>{k||console.warn("Native HLS playback failed")},c.addEventListener("error",F),d&&!k&&c.play().catch(p=>{p.name!=="AbortError"&&p.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",p)})};let X=0;const V=10,Y=()=>{if(k)return;if(X++,X>V){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const c=x.current;if(!c){requestAnimationFrame(Y);return}if(!c.isConnected){requestAnimationFrame(Y);return}U()},Q=requestAnimationFrame(()=>{requestAnimationFrame(Y)});return()=>{cancelAnimationFrame(Q),k=!0,document.removeEventListener("visibilitychange",K),window.removeEventListener("beforeunload",le);const c=x.current;if(c&&W&&(c.removeEventListener("ended",W),W=null),r){try{r.stopLoad(),r.off(q.Events.MANIFEST_PARSED),r.off(q.Events.ERROR),r.off(q.Events.MEDIA_ATTACHED),r.off(q.Events.MEDIA_DETACHED),r.off(q.Events.MANIFEST_LOADED),r.off(q.Events.MEDIA_ATTACHING),r.off(q.Events.MEDIA_DETACHING),r.off(q.Events.DESTROYING),r.destroy()}catch{try{r&&r.detachMedia()}catch{}}r=null,E.current=null,T.current=null}if(c){F&&(c.removeEventListener("error",F),F=null);try{c.pause()}catch{}}}},[b,d]),i.useEffect(()=>(a&&x.current&&a(x.current),()=>{a&&a(null)}),[a,h,b]);const _=g||!m?{width:"auto",maxWidth:"100%",height:"100%",maxHeight:"100%",aspectRatio:j,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"}:{width:"100%",maxWidth:"100%",maxHeight:"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",aspectRatio:j,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box",minWidth:0,minHeight:0,flexShrink:1,alignSelf:"center"};return b?t.jsx("div",{style:_,children:t.jsx("video",{ref:x,autoPlay:d,loop:!1,muted:s,controls:v,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:S?"pointer":"default"},children:"Your browser does not support the video tag."})}):t.jsx("div",{style:_,children:"No video available"})};function ct({beatmapMeta:e,beatmapVersion:o}){const l=i.useRef(null),h=i.useRef(null),[d,u]=i.useState(!1),[s,v]=i.useState(!1),[a,S]=i.useState(0);i.useEffect(()=>{if(l.current&&h.current){const x=l.current.offsetWidth,L=h.current.scrollWidth;S(L),v(L>x)}},[e,o]);const m=e?t.jsxs(t.Fragment,{children:[e.artist," – ",e.title,e.mapper?` (by ${e.mapper})`:"",o?` [${o}]`:""]}):o?`[${o}]`:"Beatmap",g=a>0?Math.max(3,a/50):3;return t.jsxs(t.Fragment,{children:[t.jsx("style",{children:`
        @keyframes beatmap-marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(calc(-100% - 1em)); }
        }
      `}),t.jsxs("div",{ref:l,className:"muted one-line",style:{fontSize:12,color:"var(--muted)",flex:"0 1 auto",minWidth:0,overflow:"hidden",whiteSpace:"nowrap",position:"relative",cursor:s?"pointer":"default"},onMouseEnter:()=>s&&u(!0),onMouseLeave:()=>u(!1),children:[t.jsx("span",{ref:h,style:{display:"inline-block",animation:d&&s?`beatmap-marquee ${g}s linear infinite`:"none"},children:m}),d&&s&&t.jsx("span",{style:{display:"inline-block",paddingLeft:"1em"},children:m})]})]})}function ut(e){return"post_type"in e?e.post_type==="mappi":!!e.stream_uid}function mt({post:e,section:o,onUpdate:l,onDelete:h,me:d}){const u=Re(),v=Te().pathname.startsWith("/feed/"),a=ut(e);e.id;const S=a?e.stream_uid||String(e.id||""):e.uid||String(e.id||""),m=o==="mappi"?"/mp":"/md",g=S&&S!=="null"&&S!=="undefined"?`${m}/feed/${S}`:`${m}/feed/${e.id}`,[x,L]=i.useState(!1),[M,C]=i.useState(!1),[R,j]=i.useState(!1),[b,z]=i.useState(!1),[E,T]=i.useState(!1),_=i.useRef(null),r=i.useRef(null),F=i.useRef(null),[k,W]=i.useState(null),[K,le]=i.useState(null),{notify:U}=xe(),[X,V]=i.useState(a?e.liked_by_me:void 0),[Y,Q]=i.useState(a?e.likes_count:0),[c,N]=i.useState(a?void 0:e.reacted_by_me),[p,y]=i.useState(a?0:e.reactions_count);i.useEffect(()=>{if(a){const n=e;V(n.liked_by_me),Q(n.likes_count)}else{const n=e;N(!!n.reacted_by_me),y(n.reactions_count)}},[e,a]);const[P,A]=i.useState(!1),[O,D]=i.useState(a?"":e.text??""),[re,de]=i.useState(e.beatmap_url||""),[I,Z]=i.useState(null),[ee,J]=i.useState(null),[be,te]=i.useState(""),me=i.useRef(0),ye=d&&((a?e.uploader&&d.id===e.uploader.id:d.id===e.user_id)||d.is_admin||d.is_mod),we=(()=>{const n=e.created_at;if(!n)return"";const f=Math.floor(Date.now()/1e3)-n;return f<60?"just now":f<3600?`${Math.floor(f/60)}m`:f<86400?`${Math.floor(f/3600)}h`:f<604800?`${Math.floor(f/86400)}d`:new Date(n*1e3).toLocaleDateString("en-US",{month:"short",day:"numeric"})})();i.useEffect(()=>{if(!P&&!a){const n=e;D(n.text??""),de(n.beatmap_url||""),Z(null),J(null),te("")}},[e,P,a]),i.useEffect(()=>{if(!P||a)return;me.current&&window.clearTimeout(me.current);const n=(re||"").trim();if(!n){te(""),Z(null),J(null);return}if(!/^https?:\/\/osu\.ppy\.sh\/(beatmapsets|beatmaps)\//i.test(n)){te(""),Z(null),J(null);return}return me.current=window.setTimeout(async()=>{var w;try{let $;try{$=new URL(n)}catch{te("Invalid URL format");return}const ne=$.hash.match(/#osu\/(\d+)/),ie=ne?ne[1]:null;$.hash="";const oe={url:$.toString()};ie&&(oe.beatmap_id=ie);const G=await B(H.osu.resolveBeatmap+Le(oe),{requireAuth:!1}),ue=Array.isArray(G==null?void 0:G.diffs)?G.diffs:[];if(!ue.length&&!G.setId){te("No difficulties found"),Z(null),J(null);return}if(Z({setId:Number(G.setId)||0,beatmapId:G.beatmapId??null,title:String(G.title||""),artist:String(G.artist||""),mapper:String(G.mapper||""),diffs:ue}),ue.length>0){const Ye=Number.isFinite(Number(G.beatmapId))?Number(G.beatmapId):Number((w=ue[0])==null?void 0:w.id),ae=ue.find(Je=>Number(Je.id)===Ye)||ue[0];J({beatmapId:Number(ae==null?void 0:ae.id)||null,version:String((ae==null?void 0:ae.version)||""),mode:String((ae==null?void 0:ae.mode)||"standard")})}else J(null);te("")}catch($){te(`Failed to resolve: ${($==null?void 0:$.message)||"Unknown error"}`),Z(null),J(null)}},400),()=>{me.current&&window.clearTimeout(me.current)}},[re,P,a]),i.useEffect(()=>{if(a||!e.beatmap_url||K)return;const n=e;let f=!1;return(async()=>{try{let w;try{w=new URL(n.beatmap_url)}catch{return}const $=w.hash.match(/#osu\/(\d+)/),ne=$?$[1]:null;w.hash="";const se={url:w.toString()};if(ne?se.beatmap_id=ne:n.beatmap_id&&(se.beatmap_id=String(n.beatmap_id)),!f){const oe=await B(H.osu.resolveBeatmap+Le(se),{requireAuth:!1});(oe.title||oe.artist)&&le({title:oe.title||null,artist:oe.artist||null,mapper:oe.mapper||null})}}catch{}})(),()=>{f=!0}},[e,a,K]);const De=async()=>{if(x||!a)return;L(!0);const n=X??!1,f=Y,w=!n,$=w?Y+1:Math.max(0,Y-1);V(w),Q($);try{const ne=n?"DELETE":"POST",ie=await B(H.videos.like(e.id),{method:ne}),se={...e,liked_by_me:w,likes_count:ie.likes_count||$};V(w),Q(ie.likes_count??$),l&&l(se)}catch{V(n),Q(f),U("Failed to like",{variant:"error"})}finally{L(!1)}},qe=async()=>{if(M||a)return;C(!0);const n=c??!1,f=p,w=!n,$=w?p+1:Math.max(0,p-1);N(w),y($);try{const ne=n?"DELETE":"POST",ie=await B(H.moddi.postReact(e.id),{method:ne}),se={...e,reacted_by_me:w,reactions_count:ie.reactions_count||$};N(w),y(ie.reactions_count??$),l&&l(se)}catch{N(n),y(f),U("Failed to react",{variant:"error"})}finally{C(!1)}},Se=async()=>{if(confirm(a?"Permanently delete this video?":"Permanently delete this post?")){try{const n=a?H.videos.delete(e.id):H.moddi.post(String(e.id));await B(n,{method:"DELETE"}),U(a?"Video deleted":"Post deleted",{variant:"warn"}),h&&h(e.id)}catch(n){U((n==null?void 0:n.message)||(a?"Failed to delete video":"Failed to delete post"),{variant:"error"})}z(!1)}},Be=async()=>{if(a){try{const n=!e.is_starred,f=n?"star":"unstar";await B(H.admin.videosAction(e.id,f),{method:"POST"});const w={...e,is_starred:n};l&&l(w),U(n?"Post starred":"Star removed",{variant:"success"})}catch{U("Action failed",{variant:"error"})}z(!1)}},Oe=()=>{a||(A(!0),D(e.text??""),de(e.beatmap_url||""),Z(null),J(null),te(""),z(!1))},We=async()=>{if(!a)try{await B(H.moddi.post(String(e.id)),{method:"PATCH",body:JSON.stringify({text:O.trim(),beatmap_url:re.trim()||null,beatmapset_id:(I==null?void 0:I.setId)??void 0,beatmap_id:(ee==null?void 0:ee.beatmapId)??(I==null?void 0:I.beatmapId)??void 0,beatmap_version:(ee==null?void 0:ee.version)??void 0})});const n=await B(H.moddi.post(String(e.id)),{method:"GET",requireAuth:!1});l&&n.post&&l({...e,...n.post}),U("Post updated",{variant:"success"}),A(!1)}catch(n){U((n==null?void 0:n.message)||"Failed to update post",{variant:"error"})}},Ue=()=>{A(!1);const n=e;D(n.text??""),de(n.beatmap_url||""),Z(null),J(null),te("")};i.useEffect(()=>{if(!R||!r.current){W(null);return}const n=()=>{if(r.current){const f=r.current.getBoundingClientRect();W({top:f.bottom+8,right:window.innerWidth-f.right})}};return n(),window.addEventListener("resize",n),window.addEventListener("scroll",n,!0),()=>{window.removeEventListener("resize",n),window.removeEventListener("scroll",n,!0)}},[R]),i.useEffect(()=>{if(!R)return;const n=f=>{_.current&&!_.current.contains(f.target)&&r.current&&!r.current.contains(f.target)&&j(!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[R]);const Ve=n=>{const f=n.target;if(f.closest("button")||f.closest(".menu-panel")||f.closest("input")||f.closest("textarea")||f.closest("select"))return;const w=f.closest("a");w&&w.getAttribute("href")!==`#${g}`||u(g)},ce=a?e.uploader||{id:0,username:"Unknown",avatar_url:null}:{id:e.user_id||0,username:e.username||"Unknown",avatar_url:e.avatar_url||null},pe=!a&&(c??(e.reacted_by_me===!0||e.reacted_by_me===1)),je=!a&&e.tags&&(typeof e.tags=="string"?e.tags.split(",").map(n=>n.trim()):[]).includes("help"),he=e.beatmapset_id,Ge=e.beatmap_id,Xe=e.beatmap_version;return t.jsxs("article",{style:{padding:"16px",borderBottom:"1px solid rgba(255,255,255,0.06)",background:"var(--panel)",transition:"background-color 0.15s ease",position:"relative",cursor:"pointer"},onMouseEnter:n=>n.currentTarget.style.backgroundColor="rgba(255,255,255,0.04)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="var(--panel)",onClick:Ve,children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:12},children:[ce.avatar_url?t.jsx(fe,{to:`/profile/${ce.id}`,onClick:n=>n.stopPropagation(),style:{flexShrink:0},children:t.jsx("img",{src:ce.avatar_url,width:40,height:40,style:{borderRadius:"50%",border:"1px solid rgba(255,255,255,0.08)",display:"block"},alt:ce.username})}):t.jsx("div",{style:{width:40,height:40,borderRadius:"50%",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",flexShrink:0}}),t.jsx(fe,{to:g,style:{flex:1,minWidth:0,textDecoration:"none",color:"inherit",display:"block"},onClick:n=>{const f=n.target,w=f.closest("a");if(w&&w!==n.currentTarget){n.preventDefault(),n.stopPropagation();return}if(f.closest("button")||f.closest(".menu-panel")||f.closest("input")||f.closest("textarea")||f.closest("select")){n.preventDefault(),n.stopPropagation();return}n.stopPropagation()},children:t.jsxs("div",{style:{flex:1,minWidth:0,width:"100%"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:6,marginBottom:6},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[t.jsx(fe,{to:`/profile/${ce.id}`,style:{textDecoration:"none",color:"inherit",fontWeight:600,fontSize:14},onClick:n=>n.stopPropagation(),onMouseEnter:n=>n.currentTarget.style.color="#7dd3fc",onMouseLeave:n=>n.currentTarget.style.color="inherit",children:ce.username}),a&&e.is_starred&&t.jsx(Pe,{size:14,color:"#f59e0b",title:"Starred"}),a&&e.mode&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(125, 211, 252, 0.2)",border:"1px solid rgba(125, 211, 252, 0.4)",color:"#7dd3fc",fontWeight:500,lineHeight:1.2,textTransform:"capitalize"},children:e.mode}),!a&&je&&t.jsx("span",{style:{fontSize:10,padding:"2px 6px",borderRadius:10,background:"rgba(234, 179, 8, 0.2)",border:"1px solid rgba(234, 179, 8, 0.4)",color:"#fbbf24",fontWeight:500,lineHeight:1.2},children:"Help"})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[we&&t.jsx("span",{className:"muted",style:{fontSize:13},children:we}),ye&&t.jsx("button",{ref:F,onClick:n=>{n.preventDefault(),n.stopPropagation(),z(f=>!f)},style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4},onMouseEnter:n=>n.currentTarget.style.backgroundColor="var(--hover-overlay)",onMouseLeave:n=>n.currentTarget.style.backgroundColor="transparent","aria-label":"Post options",children:t.jsx(Me,{size:16})})]})]}),a&&v&&e.playback_url&&t.jsx("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"var(--panel-dark)"},children:t.jsx(ze,{playbackUrl:e.playback_url,streamUID:e.stream_uid,aspectRatio:e.width&&e.height?e.width/e.height:null})}),a&&!v&&e.poster_url&&t.jsxs("div",{style:{marginBottom:10,borderRadius:8,overflow:"hidden",background:"var(--panel-dark)",aspectRatio:e.width&&e.height?`${e.width} / ${e.height}`:"16 / 9",position:"relative"},children:[t.jsx("img",{src:e.poster_url,alt:"Video thumbnail",style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),e.duration_sec&&t.jsxs("div",{style:{position:"absolute",bottom:8,right:8,background:"rgba(0,0,0,0.7)",color:"#fff",padding:"2px 6px",borderRadius:4,fontSize:11,fontWeight:500},children:[Math.floor(e.duration_sec/60),":",(e.duration_sec%60).toFixed(0).padStart(2,"0")]})]}),!a&&P?t.jsx("div",{style:{marginBottom:12},children:t.jsxs("div",{className:"col",style:{gap:8},children:[t.jsx("textarea",{value:O,onChange:n=>D(n.target.value),maxLength:200,rows:2,style:{background:"var(--panel-dark)",border:"1px solid var(--border)",borderRadius:6,padding:8,color:"var(--text)",fontFamily:"inherit",fontSize:14,resize:"vertical",width:"100%"}}),I?t.jsxs("div",{className:"row",style:{alignItems:"center",gap:6,flexWrap:"wrap"},children:[t.jsxs("div",{className:"chip-btn",style:{cursor:"default",fontSize:12,padding:"4px 8px"},children:[t.jsxs("strong",{style:{marginRight:4},children:[I.artist," – ",I.title]}),t.jsxs("span",{className:"muted",style:{fontSize:11},children:["by ",I.mapper]})]}),I.diffs.length>0&&t.jsx("select",{value:(ee==null?void 0:ee.beatmapId)??(I==null?void 0:I.beatmapId)??void 0,onChange:n=>{const f=Number(n.target.value),w=(I==null?void 0:I.diffs.find($=>Number($.id)===f))||null;w&&J({beatmapId:f,version:w.version,mode:String(w.mode||"standard")})},style:{background:"var(--panel-dark)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:6,padding:"4px 8px",fontSize:12},children:I.diffs.map(n=>t.jsxs("option",{value:n.id,children:[n.version," (",n.mode,")"]},n.id))}),t.jsx("button",{className:"btn secondary",type:"button",onClick:()=>{Z(null),J(null),de("")},style:{padding:"6px 12px",fontSize:13},children:"Clear"})]}):t.jsx("input",{type:"url",placeholder:"Beatmap URL (optional)",value:re,onChange:n=>de(n.target.value),style:{fontSize:13,padding:"6px 8px",background:"var(--panel-dark)",color:"var(--text)",border:"1px solid var(--border)",borderRadius:6}}),be&&t.jsx("div",{className:"muted",style:{color:"var(--danger)",fontSize:11},children:be}),t.jsxs("div",{className:"row",style:{gap:8,justifyContent:"flex-end"},children:[t.jsx("button",{className:"btn secondary",onClick:Ue,style:{padding:"6px 12px",fontSize:13},children:"Cancel"}),t.jsx("button",{className:"btn",onClick:We,style:{padding:"6px 12px",fontSize:13},children:"Save"})]})]})}):t.jsxs(t.Fragment,{children:[(()=>{if(a){const n=e.description??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"var(--text)"},children:t.jsx(ge,{text:n})}):null}else{const n=e.text??"";return n.trim()?t.jsx("div",{style:{marginBottom:e.beatmap_url?12:10,wordBreak:"break-word",fontSize:14,lineHeight:1.6,color:"var(--text)"},children:t.jsx(ge,{text:n})}):null}})(),a&&e.beatmap_title&&t.jsxs("div",{style:{marginBottom:10,fontSize:12,color:"var(--muted)",lineHeight:1.4},children:[e.beatmap_artist," – ",e.beatmap_title," ",e.beatmap_mapper?`(by ${e.beatmap_mapper})`:""," ",e.beatmap_version?`[${e.beatmap_version}]`:""]}),!P&&t.jsxs("div",{className:"row post-actions",style:{alignItems:"center",gap:8,marginTop:8,position:"relative",justifyContent:"flex-start",flexWrap:"nowrap"},children:[a&&e.beatmap_url&&!e.beatmap_title&&t.jsx("div",{className:"muted one-line",style:{fontSize:12,color:"#7b8491",flex:"0 1 auto",minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:"Beatmap"}),!a&&e.beatmap_url&&(K||e.beatmapset_id||e.beatmap_id)&&t.jsx(ct,{beatmapMeta:K,beatmapVersion:e.beatmap_version}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexShrink:0,marginLeft:"auto"},children:[a&&t.jsxs("span",{className:"views-badge","aria-label":"Views",title:"Views",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Qe,{size:12}),t.jsx("span",{children:e.views_count??0})]}),t.jsxs("span",{className:"views-badge","aria-label":"Comments",title:"Comments",onClick:n=>{n.preventDefault(),n.stopPropagation()},children:[t.jsx(Ze,{size:12}),t.jsx("span",{children:e.comments_count??0})]}),a?t.jsxs("button",{className:`chip-btn like ${X?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),De()},disabled:x,"aria-label":X?"Unlike":"Like",title:X?"Unlike":"Like",children:[X?t.jsx(ke,{size:16}):t.jsx(Ee,{size:16}),t.jsx("span",{children:Y})]}):t.jsxs("button",{className:`chip-btn like ${pe?"liked":""}`,onClick:n=>{n.preventDefault(),n.stopPropagation(),qe()},disabled:M,"aria-label":pe?"Remove reaction":"React",title:pe?"Remove reaction":"React",children:[je?t.jsx("span",{style:{fontSize:16,lineHeight:1},children:"✋"}):pe?t.jsx(ke,{size:16}):t.jsx(Ee,{size:16}),t.jsx("span",{children:p})]}),e.beatmap_url&&t.jsxs("button",{ref:r,className:"chip-btn link",onClick:n=>{n.preventDefault(),n.stopPropagation(),j(f=>!f)},title:"Beatmap options","aria-label":"Beatmap options",children:[t.jsx(_e,{size:16}),t.jsx("span",{className:"muted",style:{fontSize:12},children:"Beatmap"}),t.jsx(Ne,{size:14,style:{marginLeft:4,opacity:.7}})]})]})]})]})]})})]}),R&&k&&e.beatmap_url&&t.jsxs("div",{ref:_,style:{position:"fixed",top:k.top,right:k.right,background:"var(--panel)",border:"1px solid var(--divider)",borderRadius:10,padding:6,zIndex:1e3,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsxs("a",{className:"menu-item",href:e.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>j(!1),children:[t.jsx(_e,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),he&&t.jsx("button",{className:"menu-item",onClick:()=>{T(!0),j(!1)},children:"Preview"})]}),E&&he&&t.jsx(ot,{open:E,onClose:()=>T(!1),downloadUrl:`${ve}${H.osu.downloadBeatmapset(he)}`,beatmapId:Ge??void 0,beatmapVersion:Xe??void 0}),ye&&t.jsx(He,{open:b,onClose:()=>z(!1),buttonRef:F,minWidth:160,children:a?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),Be()},children:e.is_starred?"Unstar post":"Star post"}),t.jsx("button",{className:"menu-item",onClick:n=>{n.preventDefault(),n.stopPropagation(),Se()},children:"Delete video"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"menu-item",onClick:Oe,children:"Edit post"}),t.jsx("button",{className:"menu-item",onClick:Se,children:"Delete post"})]})})]})}function Fe({comment:e,replies:o,me:l,onReply:h,onDelete:d,replyingTo:u,replyText:s,onReplyTextChange:v,onReplySubmit:a,posting:S,onCancelReply:m,section:g,repliesMap:x}){const[L,M]=i.useState(!1),C=i.useRef(null),{notify:R}=xe(),[j,b]=i.useState(!1),z=e.parent_id!==null,E=l&&(l.id===e.user_id||l.is_admin||l.is_mod),T=async()=>{if(confirm("Delete this comment?"))try{const _=g==="mappi"?H.videos.comments(e.post_id)+`/${e.id}`:H.moddi.postComments(e.post_id)+`/${e.id}`;await B(_,{method:"DELETE"}),d(e.id),R("Comment deleted",{variant:"success"})}catch{R("Failed to delete comment",{variant:"error"})}finally{M(!1)}};return t.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid var(--border-subtle)",background:"var(--hover-overlay)",transition:"background-color 0.15s ease"},onMouseEnter:_=>_.currentTarget.style.backgroundColor="var(--hover-overlay-strong)",onMouseLeave:_=>_.currentTarget.style.backgroundColor="var(--hover-overlay)",children:[t.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[t.jsx("span",{style:{fontSize:13,fontWeight:500},children:e.username}),t.jsx("span",{className:"muted",style:{fontSize:11},children:new Date(e.created_at*1e3).toLocaleDateString()})]}),t.jsx("div",{style:{fontSize:14,lineHeight:1.5,wordBreak:"break-word"},children:t.jsx(ge,{text:e.text})}),t.jsx("div",{style:{display:"flex",alignItems:"center",gap:12,marginTop:8},children:t.jsxs("button",{onClick:()=>h(e.id),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:12,padding:0},children:[t.jsx(et,{size:14}),"Reply"]})}),u===e.id&&l&&t.jsx("div",{style:{marginTop:8,paddingTop:8,borderTop:"1px solid var(--border-subtle)"},children:t.jsxs("form",{onSubmit:a,style:{display:"flex",alignItems:"flex-end",gap:6},children:[t.jsx("textarea",{placeholder:`Reply to ${e.username}...`,value:s||"",onChange:_=>v==null?void 0:v(_.target.value),rows:1,style:{flex:1,background:"var(--panel-dark)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:12,resize:"none",minHeight:"28px",maxHeight:"100px",overflowY:"auto"},onInput:_=>{const r=_.target;r.style.height="auto",r.style.height=`${Math.min(r.scrollHeight,100)}px`},autoFocus:!0}),t.jsx("button",{type:"submit",className:"btn compact",disabled:S||!(s!=null&&s.trim()),style:{padding:"5px 10px",fontSize:11,flexShrink:0},children:S?"...":"Reply"}),m&&t.jsx("button",{type:"button",onClick:m,style:{padding:"5px 10px",fontSize:11,flexShrink:0,background:"transparent",border:"1px solid var(--border)",color:"var(--muted)",borderRadius:6,cursor:"pointer"},children:"Cancel"})]})})]}),E&&t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{ref:C,className:"icon-link",onClick:()=>M(!L),style:{width:"auto",height:"auto",padding:"4px"},title:"More options","aria-label":"More options",children:t.jsx(Me,{size:16})}),t.jsx(He,{open:L,onClose:()=>M(!1),buttonRef:C,children:t.jsx("button",{className:"menu-item",onClick:T,style:{color:"var(--danger)"},children:"Delete"})})]})]}),o.length>0&&t.jsxs("div",{style:{marginTop:12,marginLeft:16,paddingLeft:16,borderLeft:"1px solid var(--border-subtle)"},children:[z&&t.jsxs("button",{onClick:()=>b(!j),style:{background:"transparent",border:"none",color:"var(--muted)",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:4,fontSize:11,padding:"4px 0",marginBottom:4},children:[j?t.jsx(Ne,{size:12}):t.jsx(tt,{size:12}),j?"Hide":"Show"," ",o.length," ",o.length===1?"reply":"replies"]}),(!z||j)&&t.jsx(t.Fragment,{children:o.map(_=>t.jsx(Fe,{comment:_,replies:(x==null?void 0:x.get(_.id))||[],me:l,onReply:h,onDelete:d,replyingTo:u,replyText:s,onReplyTextChange:v,onReplySubmit:a,posting:S,onCancelReply:m,section:g,repliesMap:x},_.id))})]})]})}const pt=({streamUID:e,playbackUrl:o,aspectRatio:l,onClose:h,headerLeft:d,headerRight:u,children:s,beatmapDownloadUrl:v,beatmapVersion:a,beatmapId:S,onOpenInEditor:m})=>{const g=typeof l=="number"&&isFinite(l)&&l>0?l:1.7777777777777777,x=!!v;return nt.useEffect(()=>(document.body.classList.add("overlay-open"),()=>{document.body.classList.remove("overlay-open")}),[]),t.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:L=>L.stopPropagation(),children:[t.jsx("div",{className:"overlay-backdrop",onClick:h}),t.jsxs("div",{className:"overlay-card",onClick:L=>L.stopPropagation(),children:[t.jsx("button",{className:"overlay-close",onClick:h,"aria-label":"Close",children:t.jsx(it,{size:18})}),t.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:x?0:"auto",maxHeight:x?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:L=>L.stopPropagation(),children:x?t.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"auto",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:t.jsx(lt,{downloadUrl:v,beatmapVersion:a,beatmapId:S,onOpenInEditor:m})}):t.jsx(ze,{streamUID:e||void 0,playbackUrl:o||void 0,aspectRatio:g,inOverlay:!0})}),(d||u||s)&&t.jsxs("div",{className:"section-panel",children:[(d||u)&&t.jsxs("div",{className:"row-between",children:[t.jsx("div",{className:"row",style:{alignItems:"center"},children:d}),u?t.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:u}):t.jsx("div",{})]}),s]})]})]})};function wt(){var Y,Q,c,N;const{uid:e}=at(),[o,l]=rt(),h=Re(),u=((Y=Te().state)==null?void 0:Y.returnTo)||"/feed",[s,v]=i.useState(null),[a,S]=i.useState([]),[m,g]=i.useState(!0),[x,L]=i.useState(null),[M,C]=i.useState(""),[R,j]=i.useState(null),[b,z]=i.useState(!1),[E,T]=i.useState(!1),{notify:_}=xe(),r=i.useRef(new Set);i.useEffect(()=>{B(H.auth.me,{requireAuth:!1}).then(p=>L(p)).catch(()=>{})},[]),i.useEffect(()=>{o.get("preview")==="true"&&T(!0)},[o]);const F=async()=>{if(e){g(!0);try{const p=await B(H.videos.get(e),{requireAuth:!1});v(p)}catch{_("Failed to load post",{variant:"error"}),h(u)}finally{g(!1)}}},k=async()=>{if(s!=null&&s.id)try{const p=await B(H.videos.comments(s.id),{requireAuth:!1});S(p.items||[])}catch{}};i.useEffect(()=>{F()},[e]),i.useEffect(()=>{s!=null&&s.id&&k()},[s==null?void 0:s.id]),i.useEffect(()=>{s!=null&&s.id&&(r.current.has(s.id)||(r.current.add(s.id),B(H.videos.view(s.id),{method:"POST"}).then(p=>{if(!p)return;const y=Number(p.views_count??0);v(P=>P?{...P,views_count:y,viewed_by_me:!0}:null)}).catch(()=>{})))},[s==null?void 0:s.id]);const W=p=>{"stream_uid"in p&&v(p)},K=()=>{h(u)},le=async p=>{if(p.preventDefault(),!(!M.trim()||!(s!=null&&s.id))){z(!0);try{await B(H.videos.comments(s.id),{method:"POST",body:JSON.stringify({text:M.trim(),parent_id:R||void 0})}),C(""),j(null),k(),F(),_("Comment posted!",{variant:"success"})}catch(y){_((y==null?void 0:y.message)||"Failed to post comment",{variant:"error"})}finally{z(!1)}}},U=p=>{S(y=>y.filter(P=>P.id!==p))};if(m)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!s)return t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const X=a.filter(p=>!p.parent_id),V=new Map;return a.filter(p=>p.parent_id).forEach(p=>{const y=p.parent_id;V.has(y)||V.set(y,[]),V.get(y).push(p)}),t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"feed-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[t.jsxs("div",{className:"post-detail-header",style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[t.jsx("button",{className:"icon-link hide-on-mobile",onClick:()=>h(u),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:t.jsx(st,{size:20})}),t.jsx("span",{className:"hide-on-mobile",style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:t.jsx(mt,{post:s,section:"mappi",onUpdate:W,onDelete:K,me:x})}),x&&!R&&t.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:t.jsxs("form",{onSubmit:le,style:{display:"flex",alignItems:"flex-end",gap:8},children:[t.jsx("textarea",{placeholder:"Write a comment...",value:M,onChange:p=>C(p.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:p=>{const y=p.target;y.style.height="auto",y.style.height=`${Math.min(y.scrollHeight,120)}px`}}),t.jsx("button",{type:"submit",className:"btn compact",disabled:b||!M.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:b?"...":"Post"})]})}),t.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:X.length===0?t.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):t.jsx("div",{className:"col",style:{gap:0},children:X.map(p=>t.jsx(Fe,{comment:p,replies:V.get(p.id)||[],me:x,section:"mappi",onReply:y=>j(y),onDelete:U,replyingTo:R,replyText:M,onReplyTextChange:C,onReplySubmit:le,posting:b,onCancelReply:()=>{j(null),C("")},repliesMap:V},p.id))})})]}),s&&E&&s.beatmapset_id&&t.jsx(pt,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{T(!1),l({})},beatmapDownloadUrl:`${ve}${H.osu.downloadBeatmapset(s.beatmapset_id)}`,beatmapId:s.beatmap_id??void 0,beatmapVersion:s.beatmap_version??void 0,onOpenInEditor:()=>{T(!1),l({}),window.location.hash="/editor"},headerLeft:t.jsxs(t.Fragment,{children:[((Q=s.uploader)==null?void 0:Q.avatar_url)&&t.jsx("img",{src:s.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),t.jsxs(fe,{to:`/profile/${(c=s.uploader)==null?void 0:c.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[t.jsx("span",{children:(N=s.uploader)==null?void 0:N.username}),s.is_starred?t.jsx(Pe,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{H as A,Fe as C,ge as O,mt as P,yt as T,B as a,Le as b,ve as c,bt as d,vt as e,wt as f,dt as g,ze as h,Ae as i,xe as u};

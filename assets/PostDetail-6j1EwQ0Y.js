import{j as e,c as W,P as L,T as O,e as q,r as i,U as M,L as $,A as J}from"./vendor-react-C7NF2CWg.js";import{P as V}from"./Post-BZKtk2yV.js";import{C as X}from"./Comment-DMIzDrYQ.js";import{P as Y}from"./Popup-CSCn_Y09.js";import{P as G}from"./beatmap-preview-zeCbv474.js";import{u as K,a as f,A as c,c as Q}from"./index-CT-OmWOS.js";import"./vendor-RuoRctBR.js";import"./editor-lib-BiYBlHYf.js";import"./editor-components-CZPSM51n.js";const Z=({streamUID:m,playbackUrl:g,aspectRatio:l,onClose:d,headerLeft:t,headerRight:r,children:p,beatmapDownloadUrl:u,beatmapVersion:b,beatmapId:v,onOpenInEditor:x})=>{const j=typeof l=="number"&&isFinite(l)&&l>0?l:1.7777777777777777,n=!!u;return e.jsxs("div",{className:"overlay",role:"dialog","aria-modal":"true",onClick:o=>o.stopPropagation(),children:[e.jsx("div",{className:"overlay-backdrop",onClick:d}),e.jsxs("div",{className:"overlay-card",onClick:o=>o.stopPropagation(),children:[e.jsx("button",{className:"overlay-close",onClick:d,"aria-label":"Close",children:e.jsx(W,{size:18})}),e.jsx("div",{className:"section-panel",style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:n?"500px":"auto",height:"auto",maxHeight:n?"80vh":"calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 160px)",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box",flexShrink:1,minWidth:0},onClick:o=>o.stopPropagation(),children:n?e.jsx("div",{style:{width:"100%",maxWidth:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box",minHeight:0},children:e.jsx(G,{downloadUrl:u,beatmapVersion:b,beatmapId:v,onOpenInEditor:x})}):e.jsx(Y,{streamUID:m||void 0,playbackUrl:g||void 0,aspectRatio:j})}),(t||r||p)&&e.jsxs("div",{className:"section-panel",children:[(t||r)&&e.jsxs("div",{className:"row-between",children:[e.jsx("div",{className:"row",style:{alignItems:"center"},children:t}),r?e.jsx("div",{className:"row post-actions",style:{gap:8,position:"relative"},children:r}):e.jsx("div",{})]}),p]})]})]})};function de(){var D,E,z;const{uid:m}=L(),[g,l]=O(),d=q(),[t,r]=i.useState(null),[p,u]=i.useState([]),[b,v]=i.useState(!0),[x,j]=i.useState(null),[n,o]=i.useState(""),[w,P]=i.useState(null),[S,k]=i.useState(!1),[F,N]=i.useState(!1),{notify:C}=K(),_=i.useRef(new Set);i.useEffect(()=>{f(c.auth.me,{requireAuth:!1}).then(a=>j(a)).catch(()=>{})},[]),i.useEffect(()=>{g.get("preview")==="true"&&N(!0)},[g]);const I=async()=>{if(m){v(!0);try{const a=await f(c.videos.get(m),{requireAuth:!1});r(a)}catch{C("Failed to load post",{variant:"error"}),d("/mp/feed")}finally{v(!1)}}},T=async()=>{if(t!=null&&t.id)try{const a=await f(c.videos.comments(t.id),{requireAuth:!1});u(a.items||[])}catch{}};i.useEffect(()=>{I()},[m]),i.useEffect(()=>{t!=null&&t.id&&T()},[t==null?void 0:t.id]),i.useEffect(()=>{t!=null&&t.id&&(_.current.has(t.id)||(_.current.add(t.id),f(c.videos.view(t.id),{method:"POST"}).then(a=>{if(!a)return;const s=Number(a.views_count??0);r(y=>y?{...y,views_count:s,viewed_by_me:!0}:null)}).catch(()=>{})))},[t==null?void 0:t.id]);const U=a=>{"stream_uid"in a&&r(a)},H=()=>{d("/mp/feed")},A=async a=>{if(a.preventDefault(),!(!n.trim()||!(t!=null&&t.id))){k(!0);try{await f(c.videos.comments(t.id),{method:"POST",body:JSON.stringify({text:n.trim(),parent_id:w||void 0})}),o(""),P(null),T(),I(),C("Comment posted!",{variant:"success"})}catch(s){C((s==null?void 0:s.message)||"Failed to post comment",{variant:"error"})}finally{k(!1)}}},R=a=>{u(s=>s.filter(y=>y.id!==a))};if(b)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!t)return e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const B=p.filter(a=>!a.parent_id),h=new Map;return p.filter(a=>a.parent_id).forEach(a=>{const s=a.parent_id;h.has(s)||h.set(s,[]),h.get(s).push(a)}),e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[e.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[e.jsx("button",{className:"icon-link",onClick:()=>d("/mp/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:e.jsx(M,{size:20})}),e.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:e.jsx(V,{post:t,section:"mappi",onUpdate:U,onDelete:H,me:x})}),x&&!w&&e.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:e.jsxs("form",{onSubmit:A,style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("textarea",{placeholder:"Write a comment...",value:n,onChange:a=>o(a.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:a=>{const s=a.target;s.style.height="auto",s.style.height=`${Math.min(s.scrollHeight,120)}px`}}),e.jsx("button",{type:"submit",className:"btn compact",disabled:S||!n.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:S?"...":"Post"})]})}),e.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:B.length===0?e.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):e.jsx("div",{className:"col",style:{gap:0},children:B.map(a=>e.jsx(X,{comment:a,replies:h.get(a.id)||[],me:x,section:"mappi",onReply:s=>P(s),onDelete:R,replyingTo:w,replyText:n,onReplyTextChange:o,onReplySubmit:A,posting:S,onCancelReply:()=>{P(null),o("")},repliesMap:h},a.id))})})]}),t&&F&&t.beatmapset_id&&e.jsx(Z,{streamUID:null,playbackUrl:null,aspectRatio:16/9,onClose:()=>{N(!1),l({})},beatmapDownloadUrl:`${Q}${c.osu.downloadBeatmapset(t.beatmapset_id)}`,beatmapId:t.beatmap_id??void 0,beatmapVersion:t.beatmap_version??void 0,onOpenInEditor:()=>{N(!1),l({}),window.location.hash="/editor"},headerLeft:e.jsxs(e.Fragment,{children:[((D=t.uploader)==null?void 0:D.avatar_url)&&e.jsx("img",{src:t.uploader.avatar_url,width:28,height:28,style:{borderRadius:"50%"}}),e.jsxs($,{to:`/profile/${(E=t.uploader)==null?void 0:E.id}`,style:{marginLeft:6,display:"inline-flex",alignItems:"center",gap:6,textDecoration:"none",color:"inherit",fontWeight:700},children:[e.jsx("span",{children:(z=t.uploader)==null?void 0:z.username}),t.is_starred?e.jsx(J,{size:14,color:"#f59e0b",title:"Starred"}):null]})]})})]})}export{de as default};

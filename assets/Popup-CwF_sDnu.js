var Q=Object.defineProperty;var tt=(o,e,t)=>e in o?Q(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var j=(o,e,t)=>tt(o,typeof e!="symbol"?e+"":e,t);import{_ as et}from"./index-COAtZd7A.js";import{r as p,j as H,Z as rt}from"./vendor-react-_vsaDC62.js";import{H as g}from"./vendor-DBgzFpze.js";const nt="video-cache",ot=2,x="segments",v="manifests",P="video-tracking",st=7*24*60*60*1e3,X=500*1024*1024,at=3;let O=null,k=null;function C(){return O?Promise.resolve(O):k||(k=new Promise((o,e)=>{const t=indexedDB.open(nt,ot);t.onerror=()=>e(t.error),t.onsuccess=()=>{O=t.result,o(O)},t.onupgradeneeded=s=>{const r=s.target.result;s.oldVersion;let a;r.objectStoreNames.contains(x)?a=s.target.transaction.objectStore(x):(a=r.createObjectStore(x,{keyPath:"url"}),a.createIndex("timestamp","timestamp",{unique:!1})),a.indexNames.contains("videoId")||a.createIndex("videoId","videoId",{unique:!1});let c;r.objectStoreNames.contains(v)?c=s.target.transaction.objectStore(v):(c=r.createObjectStore(v,{keyPath:"url"}),c.createIndex("timestamp","timestamp",{unique:!1})),c.indexNames.contains("videoId")||c.createIndex("videoId","videoId",{unique:!1}),r.objectStoreNames.contains(P)||r.createObjectStore(P,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),k)}function it(o){try{const e=o.match(/videodelivery\.net\/([^\/]+)\//);if(e)return e[1];const t=new URL(o),s=t.pathname.split("/").filter(r=>r);return s.length>0?t.origin+"/"+s[0]:t.origin}catch{return null}}async function $(o,e=!1,t){try{const s=await C(),r=e?v:x,c=s.transaction([r],"readonly").objectStore(r),d=z(o,e),l=c.get(d);return new Promise(i=>{l.onsuccess=()=>{const u=l.result;if(!u){i(null);return}if(Date.now()-u.timestamp>st){G(o,e).catch(()=>{}),i(null);return}i(u.data)},l.onerror=()=>{i(null)}})}catch{return null}}async function D(o,e,t=!1,s){try{const r=await C(),a=t?v:x,d=r.transaction([a],"readwrite").objectStore(a),l=z(o,t),i=s||it(o),u={url:l,data:e,timestamp:Date.now(),size:e.byteLength,videoId:i||void 0};await new Promise((f,E)=>{const b=d.put(u);b.onsuccess=()=>f(),b.onerror=()=>E(b.error)}),await dt()}catch{}}async function G(o,e=!1){try{const t=await C(),s=e?v:x,a=t.transaction([s],"readwrite").objectStore(s),c=z(o,e);await new Promise((d,l)=>{const i=a.delete(c);i.onsuccess=()=>d(),i.onerror=()=>l(i.error)})}catch{}}async function ct(){try{const o=await C();let e=0;for(const t of[x,v]){const a=o.transaction([t],"readonly").objectStore(t).getAll();await new Promise(c=>{a.onsuccess=()=>{const d=a.result;e+=d.reduce((l,i)=>l+i.size,0),c()},a.onerror=()=>c()})}return e}catch{return 0}}async function dt(){try{const o=await ct();if(o<=X)return;const e=await C(),t=[];for(const r of[x,v]){const a=r===v,l=e.transaction([r],"readonly").objectStore(r).getAll();await new Promise(i=>{l.onsuccess=()=>{const u=l.result;t.push(...u.map(f=>({url:f.url,timestamp:f.timestamp,size:f.size,isManifest:a}))),i()},l.onerror=()=>i()})}t.sort((r,a)=>r.timestamp-a.timestamp);let s=o;for(const r of t){if(s<=X*.8)break;await G(r.url,r.isManifest),s-=r.size}}catch{}}async function lt(o){try{const s=(await C()).transaction([P],"readwrite").objectStore(P),r={videoId:o,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((a,c)=>{const d=s.put(r);d.onsuccess=()=>a(),d.onerror=()=>c(d.error)})}catch{}}async function ut(o){try{const r=(await C()).transaction([P],"readonly").objectStore(P).index("lastAccessed");return new Promise(a=>{const c=r.openCursor(null,"prev"),d=[];c.onsuccess=l=>{const i=l.target.result;i&&d.length<o?(d.push(i.value.videoId),i.continue()):a(d)},c.onerror=()=>a([])})}catch{return[]}}async function ft(o){try{const e=await C(),t=await ut(at),s=new Set([o,...t]);for(const r of[x,v]){const c=e.transaction([r],"readwrite").objectStore(r),d=c.index("videoId"),l=c.getAll();await new Promise(i=>{l.onsuccess=async()=>{const u=l.result;let f=0;for(const E of u)E.videoId&&!s.has(E.videoId)&&await new Promise(b=>{const I=c.delete(E.url);I.onsuccess=()=>{f++,b()},I.onerror=()=>b()});i()},l.onerror=()=>i()})}}catch{}}function Y(o){return o.includes(".m3u8")||o.endsWith("/manifest")}function z(o,e){if(e)try{const t=new URL(o),s=new URLSearchParams(t.search),r=Array.from(s.entries()).sort(([a],[c])=>a.localeCompare(c));return t.search=new URLSearchParams(r).toString(),t.toString()}catch{return o}else try{const t=new URL(o);return t.origin+t.pathname}catch{const t=o.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return t?t[0]:o.split("?")[0]}}const ht=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:ft,getCached:$,isManifest:Y,normalizeCacheKey:z,setCached:D,trackVideoAccess:lt},Symbol.toStringTag,{value:"Module"}));class mt{constructor(e){j(this,"context",null);j(this,"stats");j(this,"defaultLoader",null);j(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(e,t,s){this.context=e;const r=e.url,a=Y(r);let c;try{const d=r.match(/videodelivery\.net\/([^\/]+)\//);d&&(c=d[1])}catch{}$(r,a).then(d=>{if(d){let l;a?l=new TextDecoder().decode(d):l=d;const i=performance.now();this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=i,this.stats.loaded=d.byteLength,this.stats.total=d.byteLength,this.stats.aborted=!1;const u={data:l,url:r,code:200};s.onSuccess(u,this.stats,e,{});return}this.fetchFromNetwork(r,a,e,t,s,c)}).catch(()=>{this.fetchFromNetwork(r,a,e,t,s,c)})}async fetchFromNetwork(e,t,s,r,a,c){var l;const d=performance.now();try{const i=this.abortController||new AbortController,u=await fetch(e,{method:s.method||"GET",headers:s.headers||{},signal:i.signal}).catch(R=>{throw R.name==="AbortError",R});if(!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);let f;const E=u.headers.get("content-type")||"";t||E.includes("application/vnd.apple.mpegurl")||E.includes("text")?f=await u.text():f=await u.arrayBuffer();const b=performance.now(),I=typeof f=="string"?new TextEncoder().encode(f).length:f.byteLength;if(this.stats.loading.start=d,this.stats.loading.first=d,this.stats.loading.end=b,this.stats.loaded=I,this.stats.total=I,this.stats.aborted=!1,f instanceof ArrayBuffer)await D(e,f,t,c);else{const V=new TextEncoder().encode(f);await D(e,V.buffer,t,c)}const M={data:f,url:u.url,code:u.status};a.onSuccess(M,this.stats,s,{})}catch(i){const u=performance.now();if(this.stats.loading.start=d,this.stats.loading.first=d,this.stats.loading.end=u,this.stats.loaded=0,this.stats.total=0,i instanceof Error&&i.name==="AbortError")this.stats.aborted=!0,(l=a.onAbort)==null||l.call(a,this.stats,s,{});else if(!(i instanceof Error&&i.name==="AbortError")){this.stats.aborted=!1;const f=i instanceof Error?i:new Error("Network error");a.onError({code:0,text:f.message},s,{},this.stats)}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=new AbortController)}destroy(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.context=null,this.defaultLoader=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}getStats(){return this.stats}getResponseHeader(e){return null}getCacheAge(){return null}}const Et=({playbackUrl:o,streamUID:e,aspectRatio:t,preferNative:s=!1,autoplay:r=!1,loop:a=!1,muted:c=!1,controls:d=!0,onVideoRef:l,onClick:i})=>{const[u,f]=p.useState(1.7777777777777777),E=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;p.useEffect(()=>{if(!E)return;const n=()=>f(window.innerWidth/Math.max(1,window.innerHeight));return n(),window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[E]);const b=p.useRef(null),[I,M]=p.useState(null),R=p.useMemo(()=>{const n=1.3333333333333333,y=16/9,m=typeof t=="number"&&isFinite(t)&&t>0?t:null;if(m)return Math.min(y,Math.max(n,m));const S=E?u:16/9;return Math.min(y,Math.max(n,S))},[E,u,t]),B=`${I??R} / 1`,w=p.useMemo(()=>o||(e?`https://videodelivery.net/${e}/manifest/video.m3u8`:null),[o,e]),q=p.useRef(null),_=p.useMemo(()=>{if(!w)return null;try{const n=w.match(/videodelivery\.net\/([^\/]+)\//);return n?n[1]:w}catch{return w}},[w]);p.useEffect(()=>{!w||!_||(et(async()=>{const{trackVideoAccess:n,clearOldVideoCache:y}=await Promise.resolve().then(()=>ht);return{trackVideoAccess:n,clearOldVideoCache:y}},void 0).then(({trackVideoAccess:n,clearOldVideoCache:y})=>{n(_).catch(()=>{}),q.current&&q.current!==w&&y(_).catch(()=>{})}),q.current=w)},[w,_]),p.useEffect(()=>{M(null)},[w]),p.useEffect(()=>{if(!s||!b.current)return;const n=b.current;let y=!1;const m=()=>{if(!y)if(n.videoWidth>0&&n.videoHeight>0){const S=n.videoWidth/n.videoHeight,N=4/3,T=16/9,K=Math.min(T,Math.max(N,S));M(K),y=!0}else M(R),y=!0};return n.addEventListener("loadedmetadata",m),n.readyState>=1&&m(),()=>{n.removeEventListener("loadedmetadata",m)}},[s,R,w]),p.useEffect(()=>{if(!w)return;let n=null,y=null,m=!1,S=null;const N=()=>{if(document.hidden&&n){const h=b.current;if(h)try{h.pause()}catch{}try{n.stopLoad()}catch{}}},T=()=>{if(m=!0,n){try{n.stopLoad(),n.detachMedia(),n.destroy()}catch{}n=null}};document.addEventListener("visibilitychange",N),window.addEventListener("beforeunload",T);const Z=setTimeout(()=>{const h=b.current;if(!(!h||m))if(g.isSupported()){const A={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,loader:mt};n=new g(A),n.loadSource(w),n.attachMedia(h),n.on(g.Events.MANIFEST_PARSED,()=>{m||!h||(a&&(S=()=>{if(!(m||!h||!n))try{n.stopLoad(),h.currentTime=0,n.startLoad(),h.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Loop play failed:",L)})}catch{h.currentTime=0,h.play().catch(()=>{})}},h.addEventListener("ended",S)),r&&!m&&h.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",L)}))}),n.on(g.Events.ERROR,(L,U)=>{if(!m&&U.fatal)switch(U.type){case g.ErrorTypes.NETWORK_ERROR:if(!m&&n)try{n.startLoad()}catch{}break;case g.ErrorTypes.MEDIA_ERROR:if(!m&&n)try{n.recoverMediaError()}catch{}break;default:n&&(n.destroy(),n=null);break}})}else m||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=w,y=()=>{m||console.warn("Native HLS playback failed")},h.addEventListener("error",y),r&&!m&&h.play().catch(A=>{A.name!=="AbortError"&&A.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",A)})},0);return()=>{m=!0,clearTimeout(Z),document.removeEventListener("visibilitychange",N),window.removeEventListener("beforeunload",T);const h=b.current;if(h&&S&&(h.removeEventListener("ended",S),S=null),n){try{n.off(g.Events.MANIFEST_PARSED),n.off(g.Events.ERROR),n.off(g.Events.MEDIA_ATTACHED),n.off(g.Events.MEDIA_DETACHED),n.off(g.Events.MANIFEST_LOADED),n.stopLoad(),n.detachMedia(),n.destroy()}catch{}n=null}if(h){y&&(h.removeEventListener("error",y),y=null);try{h.pause(),h.src="",h.srcObject=null,h.load()}catch{}}}},[w,r]),p.useEffect(()=>{l&&l(b.current)},[l,s,w]);const F="100%",W=E?{width:"100%",maxWidth:F,maxHeight:"100%",aspectRatio:B,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:F,maxHeight:"100%",height:"var(--player-height)",aspectRatio:B,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return w?H.jsx("div",{style:W,children:H.jsx("video",{ref:b,autoPlay:r,loop:!1,muted:c,controls:d,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:i?"pointer":"default"},children:"Your browser does not support the video tag."},w)}):H.jsx("div",{style:W,children:"No video available"})},gt=({open:o,onClose:e,buttonRef:t,children:s,align:r="right",minWidth:a=160})=>{const[c,d]=p.useState(null),l=p.useRef(null);if(p.useEffect(()=>{if(!o||!t.current){d(null);return}const u=()=>{if(!t.current)return;const f=t.current.getBoundingClientRect();d({top:f.bottom+8,[r]:window.innerWidth-f[r==="right"?"right":"left"]})};return u(),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),()=>{window.removeEventListener("resize",u),window.removeEventListener("scroll",u,!0)}},[o,t,r]),p.useEffect(()=>{if(!o)return;const u=f=>{l.current&&!l.current.contains(f.target)&&t.current&&!t.current.contains(f.target)&&e()};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[o,e,t]),!o||!c)return null;const i=H.jsx("div",{ref:l,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return rt.createPortal(i,document.body)};export{Et as P,gt as a};

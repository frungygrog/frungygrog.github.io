var tt=Object.defineProperty;var et=(o,e,t)=>e in o?tt(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var C=(o,e,t)=>et(o,typeof e!="symbol"?e+"":e,t);import{_ as rt}from"./index-D-vrz8OI.js";import{r as g,j as H,Z as nt}from"./vendor-react-_vsaDC62.js";import{H as v}from"./vendor-DBgzFpze.js";const ot="video-cache",st=2,A="segments",S="manifests",P="video-tracking",at=7*24*60*60*1e3,X=500*1024*1024,it=3;let z=null,k=null;function R(){return z?Promise.resolve(z):k||(k=new Promise((o,e)=>{const t=indexedDB.open(ot,st);t.onerror=()=>e(t.error),t.onsuccess=()=>{z=t.result,o(z)},t.onupgradeneeded=s=>{const r=s.target.result;s.oldVersion;let i;r.objectStoreNames.contains(A)?i=s.target.transaction.objectStore(A):(i=r.createObjectStore(A,{keyPath:"url"}),i.createIndex("timestamp","timestamp",{unique:!1})),i.indexNames.contains("videoId")||i.createIndex("videoId","videoId",{unique:!1});let l;r.objectStoreNames.contains(S)?l=s.target.transaction.objectStore(S):(l=r.createObjectStore(S,{keyPath:"url"}),l.createIndex("timestamp","timestamp",{unique:!1})),l.indexNames.contains("videoId")||l.createIndex("videoId","videoId",{unique:!1}),r.objectStoreNames.contains(P)||r.createObjectStore(P,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),k)}function ct(o){try{const e=o.match(/videodelivery\.net\/([^\/]+)\//);if(e)return e[1];const t=new URL(o),s=t.pathname.split("/").filter(r=>r);return s.length>0?t.origin+"/"+s[0]:t.origin}catch{return null}}async function $(o,e=!1,t){try{const s=await R(),r=e?S:A,l=s.transaction([r],"readonly").objectStore(r),u=q(o,e),a=l.get(u);return new Promise(c=>{a.onsuccess=()=>{const d=a.result;if(!d){c(null);return}if(Date.now()-d.timestamp>at){Y(o,e).catch(()=>{}),c(null);return}c(d.data)},a.onerror=()=>{c(null)}})}catch{return null}}async function G(o,e,t=!1,s){try{const r=await R(),i=t?S:A,u=r.transaction([i],"readwrite").objectStore(i),a=q(o,t),c=s||ct(o),d={url:a,data:e,timestamp:Date.now(),size:e.byteLength,videoId:c||void 0};await new Promise((f,b)=>{const p=u.put(d);p.onsuccess=()=>f(),p.onerror=()=>b(p.error)}),await lt()}catch{}}async function Y(o,e=!1){try{const t=await R(),s=e?S:A,i=t.transaction([s],"readwrite").objectStore(s),l=q(o,e);await new Promise((u,a)=>{const c=i.delete(l);c.onsuccess=()=>u(),c.onerror=()=>a(c.error)})}catch{}}async function dt(){try{const o=await R();let e=0;for(const t of[A,S]){const i=o.transaction([t],"readonly").objectStore(t).getAll();await new Promise(l=>{i.onsuccess=()=>{const u=i.result;e+=u.reduce((a,c)=>a+c.size,0),l()},i.onerror=()=>l()})}return e}catch{return 0}}async function lt(){try{const o=await dt();if(o<=X)return;const e=await R(),t=[];for(const r of[A,S]){const i=r===S,a=e.transaction([r],"readonly").objectStore(r).getAll();await new Promise(c=>{a.onsuccess=()=>{const d=a.result;t.push(...d.map(f=>({url:f.url,timestamp:f.timestamp,size:f.size,isManifest:i}))),c()},a.onerror=()=>c()})}t.sort((r,i)=>r.timestamp-i.timestamp);let s=o;for(const r of t){if(s<=X*.8)break;await Y(r.url,r.isManifest),s-=r.size}}catch{}}async function ut(o){try{const s=(await R()).transaction([P],"readwrite").objectStore(P),r={videoId:o,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((i,l)=>{const u=s.put(r);u.onsuccess=()=>i(),u.onerror=()=>l(u.error)})}catch{}}async function ft(o){try{const r=(await R()).transaction([P],"readonly").objectStore(P).index("lastAccessed");return new Promise(i=>{const l=r.openCursor(null,"prev"),u=[];l.onsuccess=a=>{const c=a.target.result;c&&u.length<o?(u.push(c.value.videoId),c.continue()):i(u)},l.onerror=()=>i([])})}catch{return[]}}async function ht(o){try{const e=await R(),t=await ft(it),s=new Set([o,...t]);for(const r of[A,S]){const l=e.transaction([r],"readwrite").objectStore(r),u=l.index("videoId"),a=l.getAll();await new Promise(c=>{a.onsuccess=async()=>{const d=a.result;let f=0;for(const b of d)b.videoId&&!s.has(b.videoId)&&await new Promise(p=>{const M=l.delete(b.url);M.onsuccess=()=>{f++,p()},M.onerror=()=>p()});c()},a.onerror=()=>c()})}}catch{}}function Z(o){return o.includes(".m3u8")||o.endsWith("/manifest")}function q(o,e){if(e)try{const t=new URL(o),s=new URLSearchParams(t.search),r=Array.from(s.entries()).sort(([i],[l])=>i.localeCompare(l));return t.search=new URLSearchParams(r).toString(),t.toString()}catch{return o}else try{const t=new URL(o);return t.origin+t.pathname}catch{const t=o.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return t?t[0]:o.split("?")[0]}}const mt=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:ht,getCached:$,isManifest:Z,normalizeCacheKey:q,setCached:G,trackVideoAccess:ut},Symbol.toStringTag,{value:"Module"}));class wt{constructor(){C(this,"cache",new Map);C(this,"maxSize",100);C(this,"maxAge",5*60*1e3)}get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.maxAge?(this.cache.delete(e),null):(this.cache.delete(e),this.cache.set(e,t),t.data):null}set(e,t){if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s&&this.cache.delete(s)}this.cache.set(e,{data:t,timestamp:Date.now()})}clear(){this.cache.clear()}}const D=new wt;class J{constructor(e){C(this,"context",null);C(this,"stats");C(this,"defaultLoader",null);C(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(e,t,s){this.context=e;const r=e.url,i=Z(r);let l;try{const a=r.match(/videodelivery\.net\/([^\/]+)\//);a&&(l=a[1])}catch{}const u=D.get(r);if(u){let a;i?a=new TextDecoder().decode(u):a=u;const c=performance.now();this.stats.loading.start=c,this.stats.loading.first=c,this.stats.loading.end=c,this.stats.loaded=u.byteLength,this.stats.total=u.byteLength,this.stats.aborted=!1;const d={data:a,url:r,code:200};s.onSuccess(d,this.stats,e,{});return}$(r,i).then(a=>{if(a){D.set(r,a);let c;i?c=new TextDecoder().decode(a):c=a;const d=performance.now();this.stats.loading.start=d,this.stats.loading.first=d,this.stats.loading.end=d,this.stats.loaded=a.byteLength,this.stats.total=a.byteLength,this.stats.aborted=!1;const f={data:c,url:r,code:200};s.onSuccess(f,this.stats,e,{});return}this.fetchFromNetwork(r,i,e,t,s,l)}).catch(()=>{this.fetchFromNetwork(r,i,e,t,s,l)})}async fetchFromNetwork(e,t,s,r,i,l){var a;const u=performance.now();try{const c=this.abortController||new AbortController,d=await fetch(e,{method:s.method||"GET",headers:s.headers||{},signal:c.signal}).catch(j=>{throw j.name==="AbortError",j});if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);let f;const b=d.headers.get("content-type")||"";t||b.includes("application/vnd.apple.mpegurl")||b.includes("text")?f=await d.text():f=await d.arrayBuffer();const p=performance.now(),M=typeof f=="string"?new TextEncoder().encode(f).length:f.byteLength;this.stats.loading.start=u,this.stats.loading.first=u,this.stats.loading.end=p,this.stats.loaded=M,this.stats.total=M,this.stats.aborted=!1;const I=f instanceof ArrayBuffer?f:new TextEncoder().encode(f).buffer;D.set(e,I),G(e,I,t,l).catch(()=>{});const _={data:f,url:d.url,code:d.status};i.onSuccess(_,this.stats,s,{})}catch(c){const d=performance.now();if(this.stats.loading.start=u,this.stats.loading.first=u,this.stats.loading.end=d,this.stats.loaded=0,this.stats.total=0,c instanceof Error&&c.name==="AbortError")this.stats.aborted=!0,(a=i.onAbort)==null||a.call(i,this.stats,s,{});else if(!(c instanceof Error&&c.name==="AbortError")){this.stats.aborted=!1;const f=c instanceof Error?c:new Error("Network error");i.onError({code:0,text:f.message},s,{},this.stats)}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=new AbortController)}destroy(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.context=null,this.defaultLoader=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}getStats(){return this.stats}getResponseHeader(e){return null}getCacheAge(){return null}}const Et=Object.freeze(Object.defineProperty({__proto__:null,CachedLoader:J,memoryCache:D},Symbol.toStringTag,{value:"Module"})),vt=({playbackUrl:o,streamUID:e,aspectRatio:t,preferNative:s=!1,autoplay:r=!1,loop:i=!1,muted:l=!1,controls:u=!0,onVideoRef:a,onClick:c})=>{const[d,f]=g.useState(1.7777777777777777),b=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;g.useEffect(()=>{if(!b)return;const n=()=>f(window.innerWidth/Math.max(1,window.innerHeight));return n(),window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[b]);const p=g.useRef(null),[M,I]=g.useState(null),_=g.useMemo(()=>{const n=1.3333333333333333,y=16/9,m=typeof t=="number"&&isFinite(t)&&t>0?t:null;if(m)return Math.min(y,Math.max(n,m));const L=b?d:16/9;return Math.min(y,Math.max(n,L))},[b,d,t]),F=`${M??_} / 1`,w=g.useMemo(()=>o||(e?`https://videodelivery.net/${e}/manifest/video.m3u8`:null),[o,e]),B=g.useRef(null),T=g.useMemo(()=>{if(!w)return null;try{const n=w.match(/videodelivery\.net\/([^\/]+)\//);return n?n[1]:w}catch{return w}},[w]);g.useEffect(()=>{!w||!T||(rt(async()=>{const{trackVideoAccess:n,clearOldVideoCache:y}=await Promise.resolve().then(()=>mt);return{trackVideoAccess:n,clearOldVideoCache:y}},void 0).then(({trackVideoAccess:n,clearOldVideoCache:y})=>{n(T).catch(()=>{}),B.current&&B.current!==w&&y(T).catch(()=>{})}),B.current=w)},[w,T]),g.useEffect(()=>{I(null)},[w]),g.useEffect(()=>{if(!s||!p.current)return;const n=p.current;let y=!1;const m=()=>{if(!y)if(n.videoWidth>0&&n.videoHeight>0){const L=n.videoWidth/n.videoHeight,N=4/3,O=16/9,K=Math.min(O,Math.max(N,L));I(K),y=!0}else I(_),y=!0};return n.addEventListener("loadedmetadata",m),n.readyState>=1&&m(),()=>{n.removeEventListener("loadedmetadata",m)}},[s,_,w]),g.useEffect(()=>{if(!w)return;let n=null,y=null,m=!1,L=null;const N=()=>{if(document.hidden&&n){const h=p.current;if(h)try{h.pause()}catch{}try{n.stopLoad()}catch{}}},O=()=>{if(m=!0,n){try{n.stopLoad(),n.detachMedia(),n.destroy()}catch{}n=null}};return document.addEventListener("visibilitychange",N),window.addEventListener("beforeunload",O),m||(()=>{const h=p.current;if(!(!h||m))if(v.isSupported()){const x={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:6e7,maxBufferHole:.3,maxLoadingDelay:2,startFragPrefetch:!0,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3,loader:J};try{n=new v(x),n.loadSource(w),n.attachMedia(h)}catch(E){if(console.error("Failed to initialize HLS:",E),n){try{n.destroy()}catch{}n=null}return}n.on(v.Events.MANIFEST_PARSED,()=>{m||!h||(i&&(L=()=>{if(!(m||!h||!n))try{n.stopLoad(),h.currentTime=0,n.startLoad(),h.play().catch(E=>{E.name!=="AbortError"&&E.name!=="NotAllowedError"&&console.debug("Loop play failed:",E)})}catch{h.currentTime=0,h.play().catch(()=>{})}},h.addEventListener("ended",L)),r&&!m&&h.play().catch(E=>{E.name!=="AbortError"&&E.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",E)}))}),n.on(v.Events.ERROR,(E,U)=>{if(!m&&U.fatal)switch(U.type){case v.ErrorTypes.NETWORK_ERROR:if(!m&&n)try{n.startLoad()}catch{}break;case v.ErrorTypes.MEDIA_ERROR:if(!m&&n)try{n.recoverMediaError()}catch{}break;default:n&&(n.destroy(),n=null);break}})}else m||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),h.src=w,y=()=>{m||console.warn("Native HLS playback failed")},h.addEventListener("error",y),r&&!m&&h.play().catch(x=>{x.name!=="AbortError"&&x.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",x)})})(),()=>{m=!0,document.removeEventListener("visibilitychange",N),window.removeEventListener("beforeunload",O);const h=p.current;if(h&&L&&(h.removeEventListener("ended",L),L=null),n){try{n.off(v.Events.MANIFEST_PARSED),n.off(v.Events.ERROR),n.off(v.Events.MEDIA_ATTACHED),n.off(v.Events.MEDIA_DETACHED),n.off(v.Events.MANIFEST_LOADED),n.stopLoad(),n.detachMedia(),n.destroy()}catch{}n=null}if(h){y&&(h.removeEventListener("error",y),y=null);try{h.pause(),h.src="",h.srcObject=null,h.load()}catch{}}}},[w,r]),g.useEffect(()=>{a&&a(p.current)},[a,s,w]);const V="100%",W=b?{width:"100%",maxWidth:V,maxHeight:"100%",aspectRatio:F,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:V,maxHeight:"100%",height:"var(--player-height)",aspectRatio:F,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return w?H.jsx("div",{style:W,children:H.jsx("video",{ref:p,autoPlay:r,loop:!1,muted:l,controls:u,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:c?"pointer":"default"},children:"Your browser does not support the video tag."},w)}):H.jsx("div",{style:W,children:"No video available"})},St=({open:o,onClose:e,buttonRef:t,children:s,align:r="right",minWidth:i=160})=>{const[l,u]=g.useState(null),a=g.useRef(null);if(g.useEffect(()=>{if(!o||!t.current){u(null);return}const d=()=>{if(!t.current)return;const f=t.current.getBoundingClientRect();u({top:f.bottom+8,[r]:window.innerWidth-f[r==="right"?"right":"left"]})};return d(),window.addEventListener("resize",d),window.addEventListener("scroll",d,!0),()=>{window.removeEventListener("resize",d),window.removeEventListener("scroll",d,!0)}},[o,t,r]),g.useEffect(()=>{if(!o)return;const d=f=>{a.current&&!a.current.contains(f.target)&&t.current&&!t.current.contains(f.target)&&e()};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[o,e,t]),!o||!l)return null;const c=H.jsx("div",{ref:a,style:{position:"fixed",top:l.top,[r]:l[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:i,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return nt.createPortal(c,document.body)};export{vt as P,St as a,Et as h,mt as v};

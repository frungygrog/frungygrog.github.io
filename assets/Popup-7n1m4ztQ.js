var ie=Object.defineProperty;var de=(n,t,e)=>t in n?ie(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var M=(n,t,e)=>de(n,typeof t!="symbol"?t+"":t,e);import{_ as le}from"./index-CGvrP0Rs.js";import{r as b,j as K,Z as ue}from"./vendor-react-_vsaDC62.js";import{H as T}from"./vendor-DBgzFpze.js";const fe="video-cache",me=2,O="segments",F="manifests",_="video-tracking",he=7*24*60*60*1e3,J=500*1024*1024,pe=3;let q=null,W=null;function N(){return q?Promise.resolve(q):W||(W=new Promise((n,t)=>{const e=indexedDB.open(fe,me);e.onerror=()=>t(e.error),e.onsuccess=()=>{q=e.result,n(q)},e.onupgradeneeded=s=>{const r=s.target.result;s.oldVersion;let a;r.objectStoreNames.contains(O)?a=s.target.transaction.objectStore(O):(a=r.createObjectStore(O,{keyPath:"url"}),a.createIndex("timestamp","timestamp",{unique:!1})),a.indexNames.contains("videoId")||a.createIndex("videoId","videoId",{unique:!1});let c;r.objectStoreNames.contains(F)?c=s.target.transaction.objectStore(F):(c=r.createObjectStore(F,{keyPath:"url"}),c.createIndex("timestamp","timestamp",{unique:!1})),c.indexNames.contains("videoId")||c.createIndex("videoId","videoId",{unique:!1}),r.objectStoreNames.contains(_)||r.createObjectStore(_,{keyPath:"videoId"}).createIndex("lastAccessed","lastAccessed",{unique:!1})}}),W)}function we(n){try{const t=n.match(/videodelivery\.net\/([^\/]+)\//);if(t)return t[1];const e=new URL(n),s=e.pathname.split("/").filter(r=>r);return s.length>0?e.origin+"/"+s[0]:e.origin}catch{return null}}async function oe(n,t=!1,e){const s=performance.now(),r=t?"MANIFEST":"SEGMENT";try{const a=performance.now(),c=await N(),i=performance.now()-a;console.log(`[VIDEO CACHE] IndexedDB initialized in ${i.toFixed(2)}ms`);const d=t?F:O,m=c.transaction([d],"readonly").objectStore(d),h=X(n,t),w=performance.now(),u=m.get(h);return new Promise(f=>{u.onsuccess=()=>{const x=performance.now()-w,g=performance.now()-s,S=u.result;if(!S){console.log(`[VIDEO CACHE] ${r} not found in cache (lookup took ${g.toFixed(2)}ms, request: ${x.toFixed(2)}ms)`),f(null);return}const L=Date.now()-S.timestamp;if(L>he){console.log(`[VIDEO CACHE] ${r} cache entry expired (age: ${(L/1e3).toFixed(2)}s), deleting`),ne(n,t).catch(()=>{}),f(null);return}console.log(`[VIDEO CACHE] ${r} found in cache (lookup took ${g.toFixed(2)}ms, request: ${x.toFixed(2)}ms, size: ${S.data.byteLength} bytes, age: ${(L/1e3).toFixed(2)}s)`),f(S.data)},u.onerror=()=>{const x=performance.now()-s;console.error(`[VIDEO CACHE] Error looking up ${r} after ${x.toFixed(2)}ms`),f(null)}})}catch(a){const c=performance.now()-s;return console.error(`[VIDEO CACHE] Exception during ${r} lookup after ${c.toFixed(2)}ms:`,a),null}}async function re(n,t,e=!1,s){const r=performance.now(),a=e?"MANIFEST":"SEGMENT";try{const c=performance.now(),i=await N(),d=performance.now()-c,p=e?F:O,h=i.transaction([p],"readwrite").objectStore(p),w=X(n,e),u=s||we(n),f={url:w,data:t,timestamp:Date.now(),size:t.byteLength,videoId:u||void 0},x=performance.now();await new Promise((S,L)=>{const $=h.put(f);$.onsuccess=()=>{const E=performance.now()-x;console.log(`[VIDEO CACHE] ${a} stored in IndexedDB in ${E.toFixed(2)}ms (size: ${t.byteLength} bytes)`),S()},$.onerror=()=>{const E=performance.now()-x;console.error(`[VIDEO CACHE] Error storing ${a} after ${E.toFixed(2)}ms:`,$.error),L($.error)}});const g=performance.now()-r;console.log(`[VIDEO CACHE] Total ${a} cache write time: ${g.toFixed(2)}ms`),ye().catch(()=>{})}catch(c){const i=performance.now()-r;console.error(`[VIDEO CACHE] Exception storing ${a} after ${i.toFixed(2)}ms:`,c)}}async function ne(n,t=!1){try{const e=await N(),s=t?F:O,a=e.transaction([s],"readwrite").objectStore(s),c=X(n,t);await new Promise((i,d)=>{const p=a.delete(c);p.onsuccess=()=>i(),p.onerror=()=>d(p.error)})}catch{}}async function Ee(){try{const n=await N();let t=0;for(const e of[O,F]){const a=n.transaction([e],"readonly").objectStore(e).getAll();await new Promise(c=>{a.onsuccess=()=>{const i=a.result;t+=i.reduce((d,p)=>d+p.size,0),c()},a.onerror=()=>c()})}return t}catch{return 0}}let U=!1,te=0;const ge=5e3;async function ye(){const n=Date.now();if(U||n-te<ge)return;U=!0,te=n;const t=performance.now();try{const e=await Ee();if(e<=J){U=!1;return}console.log(`[VIDEO CACHE] Starting cache cleanup (size: ${(e/1024/1024).toFixed(2)}MB, max: ${(J/1024/1024).toFixed(2)}MB)`);const s=await N(),r=[];for(const d of[O,F]){const p=d===F,w=s.transaction([d],"readonly").objectStore(d).index("timestamp");await new Promise(u=>{const f=w.openCursor();f.onsuccess=x=>{const g=x.target.result;if(g){const S=g.value;r.push({url:S.url,timestamp:S.timestamp,size:S.size,isManifest:p}),g.continue()}else u()},f.onerror=()=>u()})}let a=e,c=0;for(const d of r){if(a<=J*.8)break;await ne(d.url,d.isManifest),a-=d.size,c++}const i=performance.now()-t;console.log(`[VIDEO CACHE] Cache cleanup completed in ${i.toFixed(2)}ms (deleted ${c} entries, new size: ${(a/1024/1024).toFixed(2)}MB)`)}catch(e){const s=performance.now()-t;console.error(`[VIDEO CACHE] Cache cleanup error after ${s.toFixed(2)}ms:`,e)}finally{U=!1}}async function Se(n){try{const s=(await N()).transaction([_],"readwrite").objectStore(_),r={videoId:n,timestamp:Date.now(),lastAccessed:Date.now()};await new Promise((a,c)=>{const i=s.put(r);i.onsuccess=()=>a(),i.onerror=()=>c(i.error)})}catch{}}async function xe(n){try{const r=(await N()).transaction([_],"readonly").objectStore(_).index("lastAccessed");return new Promise(a=>{const c=r.openCursor(null,"prev"),i=[];c.onsuccess=d=>{const p=d.target.result;p&&i.length<n?(i.push(p.value.videoId),p.continue()):a(i)},c.onerror=()=>a([])})}catch{return[]}}async function be(n){try{const t=await N(),e=await xe(pe),s=new Set([n,...e]);for(const r of[O,F]){const c=t.transaction([r],"readwrite").objectStore(r),i=c.index("videoId"),d=c.getAll();await new Promise(p=>{d.onsuccess=async()=>{const m=d.result;let h=0;for(const w of m)w.videoId&&!s.has(w.videoId)&&await new Promise(u=>{const f=c.delete(w.url);f.onsuccess=()=>{h++,u()},f.onerror=()=>u()});p()},d.onerror=()=>p()})}}catch{}}function se(n){return n.includes(".m3u8")||n.endsWith("/manifest")}function X(n,t){if(t)try{const e=new URL(n),s=new URLSearchParams(e.search),r=Array.from(s.entries()).sort(([a],[c])=>a.localeCompare(c));return e.search=new URLSearchParams(r).toString(),e.toString()}catch{return n}else try{const e=new URL(n);return e.origin+e.pathname}catch{const e=n.match(/^https?:\/\/[^\/]+(\/[^?]+)/i);return e?e[0]:n.split("?")[0]}}const Ce=Object.freeze(Object.defineProperty({__proto__:null,clearOldVideoCache:be,getCached:oe,isManifest:se,normalizeCacheKey:X,setCached:re,trackVideoAccess:Se},Symbol.toStringTag,{value:"Module"}));class Ae{constructor(){M(this,"cache",new Map);M(this,"maxSize",100);M(this,"maxAge",5*60*1e3)}get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.maxAge?(this.cache.delete(t),null):(this.cache.delete(t),this.cache.set(t,e),e.data):null}set(t,e){if(this.cache.size>=this.maxSize){const s=this.cache.keys().next().value;s&&this.cache.delete(s)}this.cache.set(t,{data:e,timestamp:Date.now()})}clear(){this.cache.clear()}}const G=new Ae;class ae{constructor(t){M(this,"context",null);M(this,"stats");M(this,"defaultLoader",null);M(this,"abortController",null);this.abortController=new AbortController,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}load(t,e,s){this.context=t;const r=t.url,a=se(r),c=performance.now(),i=a?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Loading ${i}: ${r} at ${c.toFixed(2)}ms`);let d;try{const u=r.match(/videodelivery\.net\/([^\/]+)\//);u&&(d=u[1])}catch{}const p=performance.now(),m=G.get(r),h=performance.now()-p;if(m){const u=performance.now()-c;console.log(`[CACHE LOADER] ${i} found in memory cache in ${u.toFixed(2)}ms (lookup: ${h.toFixed(2)}ms)`);let f;a?f=new TextDecoder().decode(m):f=m;const x=performance.now();this.stats.loading.start=x,this.stats.loading.first=x,this.stats.loading.end=x,this.stats.loaded=m.byteLength,this.stats.total=m.byteLength,this.stats.aborted=!1;const g={data:f,url:r,code:200};s.onSuccess(g,this.stats,t,{});return}console.log(`[CACHE LOADER] ${i} not in memory cache (lookup took ${h.toFixed(2)}ms), checking IndexedDB`);const w=performance.now();oe(r,a).then(u=>{const f=performance.now()-w;if(u){const x=performance.now()-c;console.log(`[CACHE LOADER] ${i} found in IndexedDB cache in ${x.toFixed(2)}ms (lookup: ${f.toFixed(2)}ms)`),G.set(r,u);let g;a?g=new TextDecoder().decode(u):g=u;const S=performance.now();this.stats.loading.start=S,this.stats.loading.first=S,this.stats.loading.end=S,this.stats.loaded=u.byteLength,this.stats.total=u.byteLength,this.stats.aborted=!1;const L={data:g,url:r,code:200};s.onSuccess(L,this.stats,t,{});return}console.log(`[CACHE LOADER] ${i} not in IndexedDB cache (lookup took ${f.toFixed(2)}ms), fetching from network`),this.fetchFromNetwork(r,a,t,e,s,d)}).catch(u=>{const f=performance.now()-w;console.error(`[CACHE LOADER] IndexedDB lookup error after ${f.toFixed(2)}ms:`,u),this.fetchFromNetwork(r,a,t,e,s,d)})}async fetchFromNetwork(t,e,s,r,a,c){var p;const i=performance.now(),d=e?"MANIFEST":"SEGMENT";console.log(`[CACHE LOADER] Fetching ${d} from network: ${t} at ${i.toFixed(2)}ms`);try{const m=this.abortController||new AbortController,h=await fetch(t,{method:s.method||"GET",headers:s.headers||{},signal:m.signal}).catch(v=>{throw v.name==="AbortError",v});if(!h.ok)throw new Error(`HTTP ${h.status}: ${h.statusText}`);let w;const u=h.headers.get("content-type")||"";e||u.includes("application/vnd.apple.mpegurl")||u.includes("text")?w=await h.text():w=await h.arrayBuffer();const f=performance.now(),x=f-i,g=typeof w=="string"?new TextEncoder().encode(w).length:w.byteLength;console.log(`[CACHE LOADER] ${d} fetched from network in ${x.toFixed(2)}ms, size: ${g} bytes`),this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=f,this.stats.loaded=g,this.stats.total=g,this.stats.aborted=!1;const S=performance.now(),L=w instanceof ArrayBuffer?w:new TextEncoder().encode(w).buffer,$=performance.now();G.set(t,L);const E=performance.now()-$;console.log(`[CACHE LOADER] ${d} stored in memory cache in ${E.toFixed(2)}ms`),re(t,L,e,c).then(()=>{const v=performance.now()-S;console.log(`[CACHE LOADER] ${d} stored in IndexedDB in ${v.toFixed(2)}ms`)}).catch(v=>{console.error(`[CACHE LOADER] Error storing ${d} in IndexedDB:`,v)});const j={data:w,url:h.url,code:h.status};a.onSuccess(j,this.stats,s,{})}catch(m){const h=performance.now();if(this.stats.loading.start=i,this.stats.loading.first=i,this.stats.loading.end=h,this.stats.loaded=0,this.stats.total=0,m instanceof Error&&m.name==="AbortError")this.stats.aborted=!0,(p=a.onAbort)==null||p.call(a,this.stats,s,{});else if(!(m instanceof Error&&m.name==="AbortError")){this.stats.aborted=!1;const w=m instanceof Error?m:new Error("Network error");a.onError({code:0,text:w.message},s,{},this.stats)}}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=new AbortController)}destroy(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.context=null,this.defaultLoader=null,this.stats={aborted:!1,loaded:0,retry:0,total:0,chunkCount:0,bwEstimate:0,loading:{start:0,first:0,end:0},parsing:{start:0,end:0},buffering:{start:0,first:0,end:0}}}getStats(){return this.stats}getResponseHeader(t){return null}getCacheAge(){return null}}const Ie=Object.freeze(Object.defineProperty({__proto__:null,CachedLoader:ae,memoryCache:G},Symbol.toStringTag,{value:"Module"})),Fe=({playbackUrl:n,streamUID:t,aspectRatio:e,preferNative:s=!1,autoplay:r=!1,loop:a=!1,muted:c=!1,controls:i=!0,onVideoRef:d,onClick:p,videoKey:m})=>{const[h,w]=b.useState(1.7777777777777777),u=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;b.useEffect(()=>{if(!u)return;const o=()=>w(window.innerWidth/Math.max(1,window.innerHeight));return o(),window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[u]);const f=b.useRef(null),[x,g]=b.useState(null),S=b.useMemo(()=>{const o=1.3333333333333333,C=16/9,y=typeof e=="number"&&isFinite(e)&&e>0?e:null;if(y)return Math.min(C,Math.max(o,y));const H=u?h:16/9;return Math.min(C,Math.max(o,H))},[u,h,e]),$=`${x??S} / 1`,E=b.useMemo(()=>n||(t?`https://videodelivery.net/${t}/manifest/video.m3u8`:null),[n,t]),j=b.useRef(null),v=b.useMemo(()=>{if(!E)return null;try{const o=E.match(/videodelivery\.net\/([^\/]+)\//);return o?o[1]:E}catch{return E}},[E]);b.useEffect(()=>{!E||!v||(le(async()=>{const{trackVideoAccess:o,clearOldVideoCache:C}=await Promise.resolve().then(()=>Ce);return{trackVideoAccess:o,clearOldVideoCache:C}},void 0).then(({trackVideoAccess:o,clearOldVideoCache:C})=>{o(v).catch(()=>{}),j.current&&j.current!==E&&C(v).catch(()=>{})}),j.current=E)},[E,v]),b.useEffect(()=>{g(null)},[E]),b.useEffect(()=>{if(!s||!f.current)return;const o=f.current;let C=!1;const y=()=>{if(!C)if(o.videoWidth>0&&o.videoHeight>0){const H=o.videoWidth/o.videoHeight,B=4/3,V=16/9,Y=Math.min(V,Math.max(B,H));g(Y),C=!0}else g(S),C=!0};return o.addEventListener("loadedmetadata",y),o.readyState>=1&&y(),()=>{o.removeEventListener("loadedmetadata",y)}},[s,S,E]),b.useEffect(()=>{if(!E)return;let o=null,C=null,y=!1,H=null;const B=()=>{if(document.hidden&&o){const l=f.current;if(l)try{l.pause()}catch{}try{o.stopLoad()}catch{}}},V=()=>{if(y=!0,o){try{o.stopLoad(),o.detachMedia(),o.destroy()}catch{}o=null}};document.addEventListener("visibilitychange",B),window.addEventListener("beforeunload",V);const Y=()=>{const l=f.current;if(!l||y)return;const R=performance.now();if(console.log(`[HLS] Starting HLS setup for ${E} at ${R.toFixed(2)}ms`),T.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const z={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,startFragPrefetch:!0,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3,loader:ae};try{const k=performance.now();o=new T(z);const P=performance.now()-k;console.log(`[HLS] HLS instance created in ${P.toFixed(2)}ms`);const A=performance.now();o.loadSource(E);const I=performance.now()-A;console.log(`[HLS] loadSource() called in ${I.toFixed(2)}ms`);const D=performance.now();o.attachMedia(l);const Z=performance.now()-D;console.log(`[HLS] attachMedia() completed in ${Z.toFixed(2)}ms`);const ce=performance.now()-R;console.log(`[HLS] Total HLS setup time: ${ce.toFixed(2)}ms`)}catch(k){const P=performance.now()-R;if(console.error(`[HLS] Failed to initialize HLS after ${P.toFixed(2)}ms:`,k),o){try{o.destroy()}catch{}o=null}return}o.on(T.Events.MANIFEST_PARSED,()=>{const k=performance.now()-R;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${k.toFixed(2)}ms after setup start`),y||!l)return;a&&(H=()=>{if(!(y||!l||!o))try{o.stopLoad(),l.currentTime=0,o.startLoad(),l.play().catch(A=>{A.name!=="AbortError"&&A.name!=="NotAllowedError"&&console.debug("Loop play failed:",A)})}catch{l.currentTime=0,l.play().catch(()=>{})}},l.addEventListener("ended",H)),(()=>{if(!(y||!l))if(l.readyState>=2){if(r){const A=performance.now();l.play().then(()=>{const I=performance.now()-A;console.log(`[HLS] Autoplay succeeded in ${I.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(I=>{const D=performance.now()-A;I.name!=="AbortError"&&I.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${D.toFixed(2)}ms:`,I)})}}else{const A=()=>{if(!(y||!l)&&(l.removeEventListener("canplay",A),r)){const I=performance.now();l.play().then(()=>{const D=performance.now()-I;console.log(`[HLS] Autoplay succeeded in ${D.toFixed(2)}ms after canplay event`)}).catch(D=>{const Z=performance.now()-I;D.name!=="AbortError"&&D.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${Z.toFixed(2)}ms:`,D)})}};l.addEventListener("canplay",A,{once:!0})}})()}),o.on(T.Events.ERROR,(k,P)=>{if(!y&&P.fatal)switch(P.type){case T.ErrorTypes.NETWORK_ERROR:if(!y&&o)try{o.startLoad()}catch{}break;case T.ErrorTypes.MEDIA_ERROR:if(!y&&o)try{o.recoverMediaError()}catch{}break;default:o&&(o.destroy(),o=null);break}})}else y||console.warn("HLS.js not supported, falling back to native HLS (no caching)"),l.src=E,C=()=>{y||console.warn("Native HLS playback failed")},l.addEventListener("error",C),r&&!y&&l.play().catch(z=>{z.name!=="AbortError"&&z.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",z)})};return y||requestAnimationFrame(()=>{!y&&f.current&&Y()}),()=>{y=!0,document.removeEventListener("visibilitychange",B),window.removeEventListener("beforeunload",V);const l=f.current;if(l&&H&&(l.removeEventListener("ended",H),H=null),o){try{o.off(T.Events.MANIFEST_PARSED),o.off(T.Events.ERROR),o.off(T.Events.MEDIA_ATTACHED),o.off(T.Events.MEDIA_DETACHED),o.off(T.Events.MANIFEST_LOADED),o.stopLoad(),o.detachMedia(),o.destroy()}catch{}o=null}if(l){C&&(l.removeEventListener("error",C),C=null);try{for(l.pause(),l.currentTime=0,l.src="",l.srcObject=null;l.firstChild;)l.removeChild(l.firstChild);l.load()}catch{}}}},[E,r]),b.useEffect(()=>{d&&d(f.current)},[d,s,E]);const Q="100%",ee=u?{width:"100%",maxWidth:Q,maxHeight:"100%",aspectRatio:$,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:Q,maxHeight:"100%",height:"var(--player-height)",aspectRatio:$,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return E?K.jsx("div",{style:ee,children:K.jsx("video",{ref:f,autoPlay:r,loop:!1,muted:c,controls:i,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:p?"pointer":"default"},children:"Your browser does not support the video tag."},m!==void 0?`${E}-${m}`:E)}):K.jsx("div",{style:ee,children:"No video available"})},He=({open:n,onClose:t,buttonRef:e,children:s,align:r="right",minWidth:a=160})=>{const[c,i]=b.useState(null),d=b.useRef(null);if(b.useEffect(()=>{if(!n||!e.current){i(null);return}const m=()=>{if(!e.current)return;const h=e.current.getBoundingClientRect();i({top:h.bottom+8,[r]:window.innerWidth-h[r==="right"?"right":"left"]})};return m(),window.addEventListener("resize",m),window.addEventListener("scroll",m,!0),()=>{window.removeEventListener("resize",m),window.removeEventListener("scroll",m,!0)}},[n,e,r]),b.useEffect(()=>{if(!n)return;const m=h=>{d.current&&!d.current.contains(h.target)&&e.current&&!e.current.contains(h.target)&&t()};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[n,t,e]),!n||!c)return null;const p=K.jsx("div",{ref:d,style:{position:"fixed",top:c.top,[r]:c[r],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:a,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:s});return ue.createPortal(p,document.body)};export{Fe as P,He as a,Ie as h,Ce as v};

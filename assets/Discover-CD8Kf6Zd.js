import{r as i,R as q,i as Fe,j as t,D as Te,E as Le,L as we,p as De,G as Pe,I as Ae,J as Ue,K as ye,M as Oe,N as ve,A as Be}from"./vendor-react-DuIEARr3.js";import{P as qe}from"./Player-DYbH8gbg.js";import{P as Ve}from"./beatmap-preview-DJIUSb-X.js";import{u as We}from"./index-CBTvuApc.js";import"./vendor-DJ9p0TM-.js";import"./editor-lib-D944B41z.js";import"./editor-components-B-sTlePe.js";const f="https://api.osumappi.ng",g={};function Ze(){var he,be,ge;const[_,R]=i.useState(g.history||[]),[u,I]=i.useState(g.index||-1),n=u>=0?_[u]:null,[se,re]=i.useState(!1),[je,ie]=i.useState(!1),[ke,oe]=i.useState(!1),[V,D]=i.useState(!1),W=q.useRef(null),[H,X]=i.useState(!1),J=q.useRef(null),[E,Se]=i.useState(null),[Y,F]=i.useState(!1),[G,P]=i.useState(!1),K=q.useRef(null),Q=q.useRef(null),{notify:j}=We(),[A,Z]=i.useState(!0),ee=i.useRef(null),[b,N]=i.useState(g.queue||[]),x=i.useRef(g.seenIds||new Set),ae=i.useRef(new Set),te=i.useRef(!1),le=i.useRef(null),[ce,$]=i.useState(g.eligibleCount||null),[de,z]=i.useState(g.viewedCount||0),[U,C]=i.useState(!1),[k,Ce]=i.useState(()=>typeof window>"u"?!1:window.matchMedia("(max-width: 600px), (pointer: coarse)").matches);i.useEffect(()=>()=>{g.history=_,g.index=u,g.queue=b,g.seenIds=x.current,g.eligibleCount=ce,g.viewedCount=de},[_,u,b,ce,de]);function T(e){var s;return(s=document.cookie.split("; ").map(r=>r.split("=")).find(([r])=>r===e))==null?void 0:s[1]}function _e(){try{const e=Array.from(x.current).slice(-200);localStorage.setItem("feed_seen_ids",JSON.stringify(e))}catch{}}function S(){try{const e=localStorage.getItem("filter_modes"),s=(e?String(e):"standard").toLowerCase().split(",").map(a=>a.trim()).filter(Boolean),r=["standard","taiko","mania","catch"],o=Array.from(new Set(s.filter(a=>r.includes(a))));return o.length?o:["standard"]}catch{return["standard"]}}const ue=async(e=3)=>{if(te.current)return[];te.current=!0;try{const s=async()=>{const d=[];for(let v=0;v<e;v++)try{const p=Array.from(x.current).slice(-200),c=S().join(","),m=await fetch(`${f}/api/feed/next?exclude=${encodeURIComponent(p.join(","))}&modes=${encodeURIComponent(c)}`,{credentials:"include"});if(m.status===401){oe(!0);break}if(m.status===429){j("Please slow down a bit.",{durationMs:3e3,variant:"warn"});break}if(!m.ok)break;const h=await m.json(),M=h&&(h.id?h:h.video);if(!M)break;d.push(M)}catch{break}return d};if(le.current===!1){const d=await s(),v=new Set(b.map(c=>c.id)),p=d.filter(c=>!x.current.has(c.id)&&!v.has(c.id));if(p.length>0&&N(c=>[...c,...p]),p.length===0&&b.length===0)try{const c=S().join(","),m=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(c)}`,{credentials:"include"});if(m.ok){const h=await m.json();$(Number(h.eligible||0)),z(Number(h.viewed||0)),C(!!h.caught_up)}}catch{}return p}const r=Array.from(x.current).slice(-200),o=S().join(","),a=await fetch(`${f}/api/feed/batch?size=${e}&exclude=${encodeURIComponent(r.join(","))}&modes=${encodeURIComponent(o)}`,{credentials:"include"});if(a.status===401)return oe(!0),[];if(a.status===429)return j("Please slow down a bit.",{durationMs:4e3,variant:"warn"}),[];if(a.status===404){le.current=!1;const d=await s(),v=new Set(b.map(c=>c.id)),p=d.filter(c=>!x.current.has(c.id)&&!v.has(c.id));if(p.length>0&&N(c=>[...c,...p]),p.length===0&&b.length===0)try{const c=S().join(","),m=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(c)}`,{credentials:"include"});if(m.ok){const h=await m.json(),M=Number(h.eligible||0),xe=Number(h.viewed||0);$(M),z(xe);const Me=M>0&&xe>=M;C(Me)}}catch{}return p}const l=await a.json(),w=l&&Array.isArray(l.items)?l.items:[],y=new Set,ne=w.filter(d=>y.has(d.id)?!1:(y.add(d.id),!0)),ze=new Set(b.map(d=>d.id)),B=ne.filter(d=>!x.current.has(d.id)&&!ze.has(d.id));if(B.length>0&&N(d=>[...d,...B]),B.length===0&&b.length===0)try{const d=S().join(","),v=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(d)}`,{credentials:"include"});if(v.ok){const p=await v.json(),c=Number(p.eligible||0),m=Number(p.viewed||0);$(c),z(m);const h=c>0&&m>=c;C(h)}}catch{}return B}catch{return[]}finally{te.current=!1}},O=async()=>{if(!se){re(!0);try{let e=[];b.length===0&&(e=await ue(3));let s;if(b.length>0?(s=b[0],N(r=>r.slice(1))):e.length>0&&(s=e[0],e.length>1&&N(r=>[...r,...e.slice(1)])),s){if(x.current.add(s.id),_e(),R(r=>{const o=[...r.slice(0,u+1),s];return I(o.length-1),o}),!ae.current.has(s.id)){ae.current.add(s.id);const r=T("csrf")||"";try{const o=await fetch(`${f}/api/videos/${s.id}/view`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":r}});if(o.ok){const a=await o.json();a&&R(l=>{const w=[...l],y=w.findIndex(ne=>ne.id===s.id);return y!==-1&&(w[y]={...w[y],views_count:a.views_count??w[y].views_count??0,viewed_by_me:!0}),w})}}catch{}}}else try{const r=S().join(","),o=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(r)}`,{credentials:"include"});if(o.ok){const a=await o.json(),l=Number(a.eligible||0),w=Number(a.viewed||0);$(l),z(w);const y=l>0&&w>=l;C(y)}}catch{}b.length<=1&&ue(3)}finally{re(!1)}}},Re=()=>{u>0&&(I(u-1),F(!1))},Ie=()=>{if(u<_.length-1){I(u+1),F(!1);return}U||O()},L=()=>{k&&(Z(!0),ee.current&&window.clearTimeout(ee.current),ee.current=window.setTimeout(()=>Z(!1),1800))};i.useEffect(()=>{const e=()=>{const s=window.matchMedia("(max-width: 600px), (pointer: coarse)").matches;Ce(s),s||Z(!0)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const Ee=async()=>{if(n){ie(!0);try{const e=T("csrf")||"",s=n.liked_by_me?"DELETE":"POST",r=await fetch(`${f}/api/videos/${n.id}/like`,{method:s,credentials:"include",headers:{"X-CSRF-Token":e}});if(r.status===429){j("Please slow down a bit.",{durationMs:5e3,variant:"warn"});return}if(r.ok){const o=await r.json();R(a=>{const l=[...a];return l[u]={...l[u],liked_by_me:!n.liked_by_me,likes_count:o.likes_count},l})}}finally{ie(!1)}}};async function fe(e){if(!n)return;const s=T("csrf")||"";(await fetch(`${f}/api/videos/${n.id}/flag`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":s},body:JSON.stringify({reason:e})})).ok?j("Thanks for your report.",{variant:"info"}):j("Report failed",{variant:"error"}),D(!1)}i.useEffect(()=>{if(!V)return;const e=s=>{W.current&&!W.current.contains(s.target)&&D(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[V]),i.useEffect(()=>{if(!H)return;const e=s=>{J.current&&!J.current.contains(s.target)&&X(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[H]),i.useEffect(()=>{if(!G)return;const e=s=>{K.current&&!K.current.contains(s.target)&&Q.current&&!Q.current.contains(s.target)&&P(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[G]),i.useEffect(()=>{_.length===0&&O()},[]),i.useEffect(()=>{(async()=>{try{const e=S().join(","),s=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(e)}`,{credentials:"include"});if(s.ok){const r=await s.json(),o=Number(r.eligible||0),a=Number(r.viewed||0);$(o),z(a);const l=o>0&&a>=o;C(l)}}catch{}})()},[]),i.useEffect(()=>{const e=()=>{R([]),N([]),x.current.clear(),I(-1),C(!1),(async()=>{try{const s=S().join(","),r=await fetch(`${f}/api/feed/progress?modes=${encodeURIComponent(s)}`,{credentials:"include"});if(r.ok){const o=await r.json(),a=Number(o.eligible||0),l=Number(o.viewed||0);$(a),z(l),C(!1)}}catch{}O()})()};return window.addEventListener("filterchange",e),()=>window.removeEventListener("filterchange",e)},[]),i.useEffect(()=>{try{const e=localStorage.getItem("feed_seen_ids");if(e){const s=JSON.parse(e);if(Array.isArray(s))for(const r of s)typeof r=="number"&&x.current.add(r)}}catch{}},[]),i.useEffect(()=>{(async()=>{try{const e=await fetch(`${f}/api/me`,{credentials:"include"});e.ok&&Se(await e.json())}catch{}})()},[]),i.useEffect(()=>{F(!1)},[n==null?void 0:n.id]);const pe=!!(E!=null&&E.is_admin||E!=null&&E.is_mod);async function Ne(){if(!n)return;const e=T("csrf")||"",s=!n.is_starred,r=s?"star":"unstar";(await fetch(`${f}/api/admin/videos/${n.id}/${r}`,{method:"POST",credentials:"include",headers:{"X-CSRF-Token":e}})).ok?(R(a=>{const l=[...a];return l[u]={...l[u],is_starred:s},l}),X(!1),j(s?"Post starred":"Star removed",{variant:"success"})):j("Action failed",{variant:"error"})}async function me(){if(!n||!confirm("Permanently delete this video?"))return;const e=T("csrf")||"";(await fetch(`${f}/api/videos/${n.id}`,{method:"DELETE",credentials:"include",headers:{"X-CSRF-Token":e}})).ok?(j("Deleted",{variant:"warn"}),D(!1),R(r=>{const o=r.filter((a,l)=>l!==u);return o.length===0?(I(-1),setTimeout(O,0)):I(a=>Math.max(0,Math.min(a,o.length-1))),o})):alert("Delete failed")}const $e=Fe();return t.jsxs("div",{className:"player-wrap",style:{height:"100vh",height:"100dvh",width:"100%",position:"relative",overflow:"hidden",background:"#000"},children:[U&&t.jsx("div",{className:"chip info",style:{position:"absolute",top:20,left:"50%",transform:"translateX(-50%)",zIndex:10,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(10px)"},children:"You're all caught up. Check 'Feed' to watch videos you've seen already."}),t.jsx("button",{className:"nav-arrow left",onClick:()=>{L(),Re()},disabled:u<=0,"aria-label":"Previous",style:{opacity:k&&!A?0:1,pointerEvents:k&&!A?"none":"auto",position:"absolute",left:20,top:"50%",transform:"translateY(-50%)",zIndex:20,background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",border:"1px solid rgba(255,255,255,0.1)"},children:t.jsx(Te,{size:22})}),t.jsx("button",{className:"nav-arrow right",onClick:()=>{L(),Ie()},disabled:se||U&&u>=_.length-1,"aria-label":"Next",style:{opacity:k&&!A?0:1,pointerEvents:k&&!A?"none":"auto",position:"absolute",right:20,top:"50%",transform:"translateY(-50%)",zIndex:20,background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",border:"1px solid rgba(255,255,255,0.1)"},children:t.jsx(Le,{size:22})}),t.jsx("div",{className:"video-area",onMouseMove:k?L:void 0,onPointerDown:k?L:void 0,onTouchStart:k?L:void 0,style:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",background:"#000"},children:ke?t.jsxs("div",{className:"col",style:{alignItems:"center",zIndex:10},children:[t.jsx("div",{className:"muted",style:{marginBottom:8},children:"Please log in to view videos."}),t.jsx("button",{className:"btn",onClick:()=>window.location.href=`${f}/api/auth/login`,children:"Login with osu!"})]}):n?t.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative"},children:Y&&n.beatmapset_id?t.jsx("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box"},children:t.jsx(Ve,{downloadUrl:`${f}/api/osu/beatmapsets/${n.beatmapset_id}/download?noVideo=1`,beatmapId:n.beatmap_id??void 0,beatmapVersion:n.beatmap_version??void 0,onOpenInEditor:()=>{F(!1),window.location.hash="/editor"}})}):t.jsx("div",{style:{width:"100%",height:"100%",maxWidth:"100vw",maxHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(qe,{streamUID:n.stream_uid,playbackUrl:n.playback_url,aspectRatio:n!=null&&n.width&&(n!=null&&n.height)?n.width/n.height:16/9})})}):U?null:t.jsx("div",{className:"muted",style:{zIndex:10},children:"No videos yet"})}),n&&!Y&&t.jsxs("div",{style:{position:"absolute",right:16,bottom:"20%",display:"flex",flexDirection:"column",gap:20,alignItems:"center",zIndex:15,pointerEvents:"auto"},children:[t.jsx(we,{to:`/profile/${(he=n.uploader)==null?void 0:he.id}`,style:{width:48,height:48,borderRadius:"50%",border:"2px solid rgba(255,255,255,0.3)",overflow:"hidden",background:"rgba(255,255,255,0.1)",display:"flex",alignItems:"center",justifyContent:"center",textDecoration:"none"},children:(be=n.uploader)!=null&&be.avatar_url?t.jsx("img",{src:n.uploader.avatar_url,width:48,height:48,style:{borderRadius:"50%",objectFit:"cover",display:"block"},alt:n.uploader.username}):t.jsx("div",{style:{width:48,height:48,background:"rgba(255,255,255,0.1)"}})}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[t.jsx("button",{onClick:Ee,disabled:je,"aria-label":n.liked_by_me?"Unlike":"Like",title:n.liked_by_me?"Unlike":"Like",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:n.liked_by_me?"#f87171":"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:n.liked_by_me?t.jsx(De,{size:28}):t.jsx(Pe,{size:28})}),t.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:n.likes_count??0})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[t.jsx("button",{onClick:()=>$e(`/mp/feed/${n.stream_uid||n.id}`),"aria-label":"Comments",title:"Comments",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:t.jsx(Ae,{size:28})}),t.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:n.comments_count??0})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4},children:[t.jsx("div",{style:{width:48,height:48,borderRadius:"50%",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"},children:t.jsx(Ue,{size:24})}),t.jsx("span",{style:{color:"#fff",fontSize:12,fontWeight:600,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:n.views_count??0})]}),n.beatmap_url&&t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{ref:Q,onClick:()=>P(e=>!e),title:"Beatmap options","aria-label":"Beatmap options",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:t.jsx(ye,{size:24})}),G&&t.jsxs("div",{ref:K,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsxs("a",{className:"menu-item",href:n.beatmap_url,target:"_blank",rel:"noreferrer",onClick:()=>P(!1),children:[t.jsx(ye,{size:16,style:{marginRight:8}}),"osu.ppy.sh"]}),n.beatmapset_id&&t.jsx("button",{className:"menu-item",onClick:()=>{F(!0),P(!1)},children:"Preview"})]})]}),pe?t.jsxs("div",{style:{position:"relative"},children:[t.jsx("button",{onClick:()=>X(e=>!e),title:"Manage","aria-label":"Manage",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:t.jsx(ve,{size:24})}),H&&t.jsxs("div",{ref:J,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:180,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsx("button",{className:"menu-item",onClick:Ne,children:n.is_starred?"Unstar post":"Star post"}),t.jsx("button",{className:"menu-item",onClick:me,children:"Delete video"})]})]}):t.jsx("button",{onClick:()=>D(e=>!e),title:"Report","aria-label":"Report",style:{width:48,height:48,borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.5)",backdropFilter:"blur(10px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",color:"#fff",transition:"transform 0.2s ease",pointerEvents:"auto"},onMouseEnter:e=>e.currentTarget.style.transform="scale(1.1)",onMouseLeave:e=>e.currentTarget.style.transform="scale(1)",children:t.jsx(Oe,{size:24})}),V&&t.jsxs("div",{ref:W,style:{position:"absolute",bottom:60,right:0,background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:100,minWidth:160,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:[t.jsx("div",{className:"muted",style:{fontSize:12,padding:"4px 8px"},children:"Report as…"}),t.jsx("button",{className:"menu-item",onClick:()=>fe("unrelated"),children:"Unrelated"}),t.jsx("button",{className:"menu-item",onClick:()=>fe("explicit"),children:"Explicit"}),pe&&t.jsx("button",{className:"menu-item",onClick:me,children:"Delete video"})]})]}),n&&!Y&&t.jsxs("div",{style:{position:"absolute",left:16,bottom:80,right:80,zIndex:15,pointerEvents:"none",display:"flex",flexDirection:"column",gap:12},children:[t.jsx("div",{style:{display:"flex",alignItems:"center",gap:8,pointerEvents:"auto"},children:t.jsx(we,{to:`/profile/${(ge=n.uploader)==null?void 0:ge.id}`,style:{textDecoration:"none",color:"#fff",fontWeight:600,fontSize:16,display:"flex",alignItems:"center",gap:8,textShadow:"0 1px 3px rgba(0,0,0,0.8)"},children:(()=>{var o,a,l;const e=(o=n.uploader)==null?void 0:o.is_admin,s=(a=n.uploader)==null?void 0:a.is_mod,r=e?"#fff3bf":s?"#d7fbe8":"#fff";return t.jsxs(t.Fragment,{children:[t.jsxs("span",{style:{color:r},children:["@",(l=n.uploader)==null?void 0:l.username]}),n.is_starred&&t.jsx(Be,{size:16,color:"#f59e0b",title:"Starred"}),(e||s)&&t.jsx(ve,{size:14,color:r,title:e?"admin":"mod"})]})})()})}),(n.description??"").trim()&&t.jsx("div",{style:{color:"#fff",fontSize:14,lineHeight:1.5,textShadow:"0 1px 3px rgba(0,0,0,0.8)",maxWidth:"85%",wordBreak:"break-word",pointerEvents:"auto"},children:n.description}),n.beatmap_title&&t.jsxs("div",{style:{color:"rgba(255,255,255,0.9)",fontSize:13,textShadow:"0 1px 3px rgba(0,0,0,0.8)",pointerEvents:"auto"},children:[n.beatmap_artist," – ",n.beatmap_title," ",n.beatmap_mapper?`(by ${n.beatmap_mapper})`:""," ",n.beatmap_version?`[${n.beatmap_version}]`:""]})]})]})}export{Ze as default};

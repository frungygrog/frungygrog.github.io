import{P as B,i as F,r as i,j as a,U as I}from"./vendor-react-DRMPtHf0.js";import{P as D}from"./Post-B8qwSxMH.js";import{C as E}from"./Comment-Dcsz1cQG.js";import{u as z}from"./index-51UPREKH.js";import"./vendor-Dm_EoMJn.js";import"./Popup-CtE3GQHY.js";import"./Player-BRfwXn_C.js";import"./editor-lib-1S8E8MTP.js";import"./beatmap-preview-Cn-wWWdw.js";import"./editor-components-B-NcqUmU.js";const p="https://api.osumappi.ng";function A(o){var s;return(s=document.cookie.split("; ").map(n=>n.split("=")).find(([n])=>n===o))==null?void 0:s[1]}function G(){const{uid:o}=B(),s=F(),[n,h]=i.useState(null),[b,y]=i.useState([]),[P,v]=i.useState(!0),[u,T]=i.useState(null),[l,c]=i.useState(""),[f,g]=i.useState(null),[x,j]=i.useState(!1),{notify:r}=z();i.useEffect(()=>{fetch(`${p}/api/me`,{credentials:"include"}).then(e=>e.ok?e.json():null).then(e=>T(e)).catch(()=>{})},[]);const _=async()=>{if(!o||o==="null"||o==="undefined"){r("Invalid post identifier",{variant:"error"}),s("/md/feed");return}v(!0);try{const e=await fetch(`${p}/api/moddiposts/${encodeURIComponent(o)}`,{credentials:"include"});if(e.ok){const t=await e.json(),d={...t,user_id:t.user_id??0,username:t.username||"Unknown",avatar_url:t.avatar_url||null,uid:t.uid||String(t.id)||o,text:t.text??null,beatmap_url:t.beatmap_url??null,beatmapset_id:t.beatmapset_id??null,beatmap_id:t.beatmap_id??null,beatmap_version:t.beatmap_version??null,tags:t.tags??null,reactions_count:Number(t.reactions_count??0),reacted_by_me:t.reacted_by_me??!1,comments_count:Number(t.comments_count??0)};h(d)}else r("Failed to load post",{variant:"error"}),s("/md/feed")}catch{r("Failed to load post",{variant:"error"}),s("/md/feed")}finally{v(!1)}},S=async()=>{if(n!=null&&n.id)try{const e=await fetch(`${p}/api/moddiposts/${n.id}/comments`,{credentials:"include"});if(e.ok){const t=await e.json();y(t.items||[])}}catch{}};i.useEffect(()=>{_()},[o]),i.useEffect(()=>{n!=null&&n.id&&S()},[n==null?void 0:n.id]);const w=e=>{h(e)},N=()=>{s("/md/feed")},C=async e=>{if(e.preventDefault(),!(!l.trim()||!(n!=null&&n.id))){j(!0);try{const t=A("csrf")||"",d=await fetch(`${p}/api/moddiposts/${n.id}/comments`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify({text:l.trim(),parent_id:f||void 0})});if(d.ok)c(""),g(null),S(),_(),r("Comment posted!",{variant:"success"});else{const $=await d.json().catch(()=>({}));r($.error||"Failed to post comment",{variant:"error"})}}catch{r("Failed to post comment",{variant:"error"})}finally{j(!1)}}},R=e=>{y(t=>t.filter(d=>d.id!==e))};if(P)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!n)return a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const k=b.filter(e=>!e.parent_id),m=new Map;return b.filter(e=>e.parent_id).forEach(e=>{const t=e.parent_id;m.has(t)||m.set(t,[]),m.get(t).push(e)}),a.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[a.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[a.jsx("button",{className:"icon-link",onClick:()=>s("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:a.jsx(I,{size:20})}),a.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:a.jsx(D,{post:n,section:"moddi",onUpdate:w,onDelete:N,me:u})}),u&&!f&&a.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:a.jsxs("form",{onSubmit:C,style:{display:"flex",alignItems:"flex-end",gap:8},children:[a.jsx("textarea",{placeholder:"Write a comment...",value:l,onChange:e=>c(e.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:e=>{const t=e.target;t.style.height="auto",t.style.height=`${Math.min(t.scrollHeight,120)}px`}}),a.jsx("button",{type:"submit",className:"btn compact",disabled:x||!l.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:x?"...":"Post"})]})}),a.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:k.length===0?a.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):a.jsx("div",{className:"col",style:{gap:0},children:k.map(e=>a.jsx(E,{comment:e,replies:m.get(e.id)||[],me:u,section:"moddi",onReply:t=>g(t),onDelete:R,replyingTo:f,replyText:l,onReplyTextChange:c,onReplySubmit:C,posting:x,onCancelReply:()=>{g(null),c("")}},e.id))})})]})}export{G as default};

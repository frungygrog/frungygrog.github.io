import{r as o,j as I,Z as Y}from"./vendor-react-_vsaDC62.js";import{H as i}from"./vendor-DBgzFpze.js";const Q=({playbackUrl:E,streamUID:g,aspectRatio:s,preferNative:H=!1,autoplay:d=!1,loop:M=!1,muted:A=!1,controls:R=!0,onVideoRef:p,onClick:$})=>{const[l,w]=o.useState(1.7777777777777777),b=typeof window<"u"&&window.matchMedia("(pointer: fine) and (min-width: 768px)").matches;o.useEffect(()=>{if(!b)return;const e=()=>w(window.innerWidth/Math.max(1,window.innerHeight));return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[b]);const u=o.useRef(null),[B,k]=o.useState(null),N=o.useMemo(()=>{const e=1.3333333333333333,c=16/9,r=typeof s=="number"&&isFinite(s)&&s>0?s:null;if(r)return Math.min(c,Math.max(e,r));const h=b?l:16/9;return Math.min(c,Math.max(e,h))},[b,l,s]),_=`${B??N} / 1`,n=o.useMemo(()=>E||(g?`https://videodelivery.net/${g}/manifest/video.m3u8`:null),[E,g]),U=o.useRef(null);o.useEffect(()=>{n&&(U.current=n)},[n]),o.useEffect(()=>{k(null)},[n]),o.useEffect(()=>{if(!H||!u.current)return;const e=u.current;let c=!1;const r=()=>{if(!c)if(e.videoWidth>0&&e.videoHeight>0){const h=e.videoWidth/e.videoHeight,F=4/3,D=16/9,C=Math.min(D,Math.max(F,h));k(C),c=!0}else k(N),c=!0};return e.addEventListener("loadedmetadata",r),e.readyState>=1&&r(),()=>{e.removeEventListener("loadedmetadata",r)}},[H,N,n]);const T=o.useRef(null),y=o.useRef(null);o.useEffect(()=>{if(!n)return;let e=T.current,c=null,r=!1,h=null;if(e&&y.current&&y.current!==n){console.log(`[HLS] URL changed from ${y.current} to ${n}, using loadSource`);try{e.stopLoad(),e.loadSource(n),y.current=n;const t=u.current;if(t)try{t.pause(),t.currentTime=0,t.load()}catch(f){console.warn("[HLS] Error resetting video element:",f)}}catch(t){console.error("[HLS] Error switching source:",t);try{e.destroy()}catch{}e=null,T.current=null,y.current=null}}if(e&&y.current===n)return console.log(`[HLS] URL unchanged (${n}), reusing existing HLS instance`),()=>{r=!0};const F=()=>{if(document.hidden&&e){const t=u.current;if(t)try{t.pause()}catch{}try{e.stopLoad()}catch{}}},D=()=>{if(r=!0,e){try{e.stopLoad(),e.detachMedia(),e.destroy()}catch{}e=null}};document.addEventListener("visibilitychange",F),window.addEventListener("beforeunload",D);const C=()=>{const t=u.current;if(!t||r)return;try{for(t.pause(),t.currentTime=0,t.src="",t.srcObject=null;t.firstChild;)t.removeChild(t.firstChild);t.load()}catch(L){console.warn("[HLS] Error resetting video element:",L)}const f=performance.now();if(console.log(`[HLS] Starting HLS setup for ${n} at ${f.toFixed(2)}ms`),console.log("[HLS] Video element ready:",{readyState:t.readyState,isConnected:t.isConnected,paused:t.paused,currentTime:t.currentTime}),i.isSupported()){console.log("[HLS] HLS.js is supported, creating instance");const L={enableWorker:!0,lowLatencyMode:!1,backBufferLength:90,startLevel:-1,maxBufferLength:20,maxMaxBufferLength:60,maxBufferSize:60*1e3*1e3,maxBufferHole:.3,maxLoadingDelay:2,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,maxFragLoadingTimeMs:2e4,fragLoadingTimeOut:2e4,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,fragLoadingMaxRetry:3};try{const x=performance.now();e=new i(L),T.current=e,y.current=n;const S=performance.now()-x;console.log(`[HLS] HLS instance created in ${S.toFixed(2)}ms`);const a=performance.now();e.loadSource(n);const m=performance.now()-a;console.log(`[HLS] loadSource() called in ${m.toFixed(2)}ms`);const v=performance.now();e.attachMedia(t);const W=performance.now()-v;console.log(`[HLS] attachMedia() completed in ${W.toFixed(2)}ms`);const X=performance.now()-f;console.log(`[HLS] Total HLS setup time: ${X.toFixed(2)}ms`)}catch(x){const S=performance.now()-f;if(console.error(`[HLS] Failed to initialize HLS after ${S.toFixed(2)}ms:`,x),e){try{e.destroy()}catch{}e=null}return}e.on(i.Events.MANIFEST_PARSED,()=>{const x=performance.now()-f;if(console.log(`[HLS] MANIFEST_PARSED event fired at ${x.toFixed(2)}ms after setup start`),r||!t)return;M&&(h=()=>{if(!(r||!t||!e))try{t.currentTime=0,t.play().catch(a=>{a.name!=="AbortError"&&a.name!=="NotAllowedError"&&console.debug("Loop play failed:",a)})}catch{t.currentTime=0,t.play().catch(()=>{})}},t.addEventListener("ended",h)),(()=>{if(!(r||!t))if(t.readyState>=2){if(d){const a=performance.now();t.play().then(()=>{const m=performance.now()-a;console.log(`[HLS] Autoplay succeeded in ${m.toFixed(2)}ms after MANIFEST_PARSED`)}).catch(m=>{const v=performance.now()-a;m.name!=="AbortError"&&m.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${v.toFixed(2)}ms:`,m)})}}else{const a=()=>{if(!(r||!t)&&(t.removeEventListener("canplay",a),d)){const m=performance.now();t.play().then(()=>{const v=performance.now()-m;console.log(`[HLS] Autoplay succeeded in ${v.toFixed(2)}ms after canplay event`)}).catch(v=>{const W=performance.now()-m;v.name!=="AbortError"&&v.name!=="NotAllowedError"&&console.warn(`[HLS] Autoplay prevented after ${W.toFixed(2)}ms:`,v)})}};t.addEventListener("canplay",a,{once:!0})}})()}),e.on(i.Events.ERROR,(x,S)=>{if(!r&&S.fatal)switch(S.type){case i.ErrorTypes.NETWORK_ERROR:if(!r&&e)try{e.startLoad()}catch{}break;case i.ErrorTypes.MEDIA_ERROR:if(!r&&e)try{e.recoverMediaError()}catch{}break;default:e&&(e.destroy(),e=null);break}})}else r||console.warn("HLS.js not supported, falling back to native HLS"),t.src=n,t.loop=M,c=()=>{r||console.warn("Native HLS playback failed")},t.addEventListener("error",c),d&&!r&&t.play().catch(L=>{L.name!=="AbortError"&&L.name!=="NotAllowedError"&&console.debug("Autoplay prevented:",L)})};let z=0;const q=10,P=()=>{if(r)return;if(z++,z>q){console.error("[HLS] Failed to setup HLS after max attempts - video element may not be ready");return}const t=u.current;if(!t){requestAnimationFrame(P);return}if(!t.isConnected){requestAnimationFrame(P);return}C()},G=requestAnimationFrame(()=>{requestAnimationFrame(P)});return()=>{cancelAnimationFrame(G),r=!0,document.removeEventListener("visibilitychange",F),window.removeEventListener("beforeunload",D);const t=u.current;if(t&&h&&(t.removeEventListener("ended",h),h=null),e){try{e.stopLoad(),e.off(i.Events.MANIFEST_PARSED),e.off(i.Events.ERROR),e.off(i.Events.MEDIA_ATTACHED),e.off(i.Events.MEDIA_DETACHED),e.off(i.Events.MANIFEST_LOADED),e.off(i.Events.MEDIA_ATTACHING),e.off(i.Events.MEDIA_DETACHING),e.off(i.Events.DESTROYING),e.destroy()}catch{try{e&&e.detachMedia()}catch{}}e=null,T.current=null,y.current=null}if(t){c&&(t.removeEventListener("error",c),c=null);try{t.pause()}catch{}}}},[n,d]),o.useEffect(()=>(p&&u.current&&p(u.current),()=>{p&&p(null)}),[p,H,n]);const j="100%",O=b?{width:"100%",maxWidth:j,maxHeight:"100%",aspectRatio:_,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"}:{width:"auto",maxWidth:j,maxHeight:"100%",height:"var(--player-height)",aspectRatio:_,background:"#000",borderRadius:10,overflow:"hidden",display:"flex",boxSizing:"border-box"};return n?I.jsx("div",{style:O,children:I.jsx("video",{ref:u,autoPlay:d,loop:!1,muted:A,controls:R,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"contain",background:"#000",cursor:$?"pointer":"default"},children:"Your browser does not support the video tag."})}):I.jsx("div",{style:O,children:"No video available"})},V=({open:E,onClose:g,buttonRef:s,children:H,align:d="right",minWidth:M=160})=>{const[A,R]=o.useState(null),p=o.useRef(null);if(o.useEffect(()=>{if(!E||!s.current){R(null);return}const l=()=>{if(!s.current)return;const w=s.current.getBoundingClientRect();R({top:w.bottom+8,[d]:window.innerWidth-w[d==="right"?"right":"left"]})};return l(),window.addEventListener("resize",l),window.addEventListener("scroll",l,!0),()=>{window.removeEventListener("resize",l),window.removeEventListener("scroll",l,!0)}},[E,s,d]),o.useEffect(()=>{if(!E)return;const l=w=>{p.current&&!p.current.contains(w.target)&&s.current&&!s.current.contains(w.target)&&g()};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[E,g,s]),!E||!A)return null;const $=I.jsx("div",{ref:p,style:{position:"fixed",top:A.top,[d]:A[d],background:"var(--panel)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:10,padding:6,zIndex:1e3,minWidth:M,boxShadow:"0 12px 30px rgba(0,0,0,0.4)"},children:H});return Y.createPortal($,document.body)};export{Q as P,V as a};

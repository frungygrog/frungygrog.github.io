var je=Object.defineProperty;var Pe=(t,e,s)=>e in t?je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var bt=(t,e,s)=>Pe(t,typeof e!="symbol"?e+"":e,s);import{r as x,R as kt,j as g,a as Re,b as Ie,c as pe}from"./vendor-react-DuIEARr3.js";import{P as Ne}from"./beatmap-preview-DJIUSb-X.js";import{J as Be}from"./vendor-DJ9p0TM-.js";function Kt(t){const e=(s,n)=>{const o=t==null?void 0:t[s],i=typeof o=="number"?o:Number(o);return Number.isFinite(i)?i:n};return{AR:e("ApproachRate",e("AR",5)),CS:e("CircleSize",5),OD:e("OverallDifficulty",e("OD",5)),HP:e("HPDrainRate",e("HP",5)),SliderMultiplier:e("SliderMultiplier",1.4),SliderTickRate:e("SliderTickRate",1)}}function ge(t){return 54.4-4.48*t}function ye(t){return t<=5?1800-120*t:1200-150*(t-5)}function Ae(t){return ye(t)*.4}function Jt(t){return t?typeof t.uninherited=="number"?t.uninherited===1:(t.beatLength??0)>0:!1}function $t(t,e){const s=t.timingPoints||[];let n=null,o=null;for(let i=0;i<s.length;i++){const r=s[i];if(r.time<=e)Jt(r)?n=r:o=r;else break}if(!n||!o)for(let i=s.length-1;i>=0&&(!n||!o);i--){const r=s[i];r.time<=e&&(Jt(r)&&!n&&(n=r),!Jt(r)&&!o&&(o=r))}return{base:n,inherited:o}}const Ot=512,Bt=384;function Ee(t){const e=[];for(let i=0;i<t.length;i++){const r=t[i];(!e.length||e[e.length-1].x!==r.x||e[e.length-1].y!==r.y)&&e.push({x:r.x,y:r.y})}const s=[],n=[0];for(let i=1;i<e.length;i++){const r=e[i].x-e[i-1].x,a=e[i].y-e[i-1].y,h=Math.hypot(r,a);s.push(h),n.push(n[n.length-1]+h)}const o=n[n.length-1]||0;return{pts:e,segLen:s,cumLen:n,total:o}}function Ft(t,e){const s=t.total||1,n=Math.max(0,Math.min(s,e*s));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,o-1),r=t.cumLen[i],a=t.segLen[i]||1,h=a>0?(n-r)/a:0,c=t.pts[i],d=t.pts[Math.min(i+1,t.pts.length-1)];return{x:c.x+(d.x-c.x)*h,y:c.y+(d.y-c.y)*h}}function Le(t,e){const s=t.total||1,n=Math.max(0,Math.min(s,e*s));let o=1;for(;o<t.cumLen.length&&t.cumLen[o]<n;)o++;const i=Math.max(0,Math.min(t.pts.length-2,o-1)),r=t.pts[i],a=t.pts[i+1];return Math.atan2(a.y-r.y,a.x-r.x)}function re(t,e){const s=Math.max(0,Math.min(t.total,e));if(s<=0)return[t.pts[0]];if(s>=t.total)return t.pts.slice();const n=[];let o=0;n.push(t.pts[0]);for(let i=1;i<t.pts.length;i++){const r=t.segLen[i-1];if(o+r<s){n.push(t.pts[i]),o+=r;continue}const a=s-o,h=r>0?a/r:0,c=t.pts[i-1],d=t.pts[i];n.push({x:c.x+(d.x-c.x)*h,y:c.y+(d.y-c.y)*h});break}return n}function Fe(t,e){let s=t.map(n=>({x:n.x,y:n.y}));for(;s.length>1;){const n=[];for(let o=0;o<s.length-1;o++)n.push({x:s[o].x+(s[o+1].x-s[o].x)*e,y:s[o].y+(s[o+1].y-s[o].y)*e});s=n}return s[0]}function ne(t,e=64){const s=[];for(let n=0;n<=e;n++){const o=n/e;s.push(Fe(t,o))}return s}function Oe(t,e=64){const s=[];if(t.length<2)return t.slice();const n=t.slice(),o=.5,i=n.length-1;for(let r=0;r<i;r++){const a=n[Math.max(0,r-1)],h=n[r],c=n[r+1],d=n[Math.min(n.length-1,r+2)];for(let u=0;u<=e;u++){const m=u/e,S=m*m,f=S*m,N=-o*m+2*o*S-o*f,F=1+(o-3)*S+(2-o)*f,A=o*m+(3-2*o)*S+(o-2)*f,b=-o*S+o*f,T=N*a.x+F*h.x+A*c.x+b*d.x,p=N*a.y+F*h.y+A*c.y+b*d.y;s.push({x:T,y:p})}}return s}function $e(t,e=64){if(t.length!==3)return ne(t,96);const[s,n,o]=t,i=n.x-s.x,r=n.y-s.y,a=o.x-s.x,h=o.y-s.y,c=i*(s.x+n.x)+r*(s.y+n.y),d=a*(s.x+o.x)+h*(s.y+o.y),u=2*(i*(o.y-n.y)-r*(o.x-n.x));if(Math.abs(u)<1e-6)return ne(t,96);const m=(h*c-r*d)/u,S=(i*d-a*c)/u,f=Math.atan2(s.y-S,s.x-m),N=Math.atan2(n.y-S,n.x-m),F=Math.atan2(o.y-S,o.x-m),A=E=>(E%(Math.PI*2)+Math.PI*2)%(Math.PI*2),b=A(F-f),T=-A(f-F),P=A(N-f)<=b?b:T,C=Math.hypot(s.x-m,s.y-S),w=[];for(let E=0;E<=e;E++){const q=E/e,tt=f+P*q;w.push({x:m+Math.cos(tt)*C,y:S+Math.sin(tt)*C})}return w}function ce(t,e){return t.x===e.x&&t.y===e.y}function ke(t,e=64){const s=[];let n=t[0],o=[t[0]];for(let r=1;r<t.length;r++){const a=t[r];ce(a,n)?(o.length>=2&&s.push(o.slice()),o=[a]):(o.push(a),n=a)}o.length>=2&&s.push(o);const i=[];for(const r of s){if(r.length===2){i.length===0&&i.push(r[0]),i.push(r[1]);continue}const a=ne(r,e);i.length>0&&ce(i[i.length-1],a[0])&&a.shift(),i.push(...a)}return i}function ie(t,e){let s;return t==="L"?s=e:t==="B"?s=ke(e,96):t==="C"?s=Oe(e,96):s=$e(e,96),Ee(s)}const Dt=new Map;function Mt(t){return Math.max(0,Math.min(1,t))}function Wt(t,e,s,n,o){t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.strokeStyle=o,t.lineWidth=3,t.stroke()}function _t(t,e){if(!(e.length<2)){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)t.lineTo(e[s].x,e[s].y)}}function ze(t){const e=t.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(e){const n=e[1],o=n.length===3?n.split("").map(h=>h+h).join(""):n,i=parseInt(o.slice(0,2),16),r=parseInt(o.slice(2,4),16),a=parseInt(o.slice(4,6),16);return{r:i,g:r,b:a}}const s=t.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return s?{r:Number(s[1]),g:Number(s[2]),b:Number(s[3])}:null}function De(t,e,s,n,o,i,r,a=1){if(e.length<2)return;const h=At.get(e,i,s,n);if(h){t.save(),t.globalAlpha=Math.max(0,Math.min(1,r));const{entry:R,transform:_}=h;t.translate(_.tx,_.ty),t.rotate(_.angle),t.scale(_.scale,_.scale),t.drawImage(R.canvas,R.normMinX-R.pad,R.normMinY-R.pad),t.restore();return}const c=At.normalizePath(e);let d=1/0,u=1/0,m=-1/0,S=-1/0;for(const R of c)R.x<d&&(d=R.x),R.y<u&&(u=R.y),R.x>m&&(m=R.x),R.y>S&&(S=R.y);const f=Math.ceil(Math.max(s,n)/2)+2,N=Math.max(1,Math.ceil(m-d+f*2)),F=Math.max(1,Math.ceil(S-u+f*2)),A=document.createElement("canvas");A.width=N,A.height=F;const b=A.getContext("2d",{willReadFrequently:!1});b.save(),b.translate(-d+f,-u+f),b.lineCap="round",b.lineJoin="round",b.globalCompositeOperation="source-over",b.globalAlpha=1,b.lineWidth=s,_t(b,c),b.strokeStyle=o,b.stroke();const T=ze(i)||{r:255,g:255,b:255},p=`rgba(${T.r}, ${T.g}, ${T.b}, 1)`;b.lineWidth=n,_t(b,c),b.strokeStyle=p,b.stroke();const j=be(),P=ve[j];b.globalCompositeOperation="soft-light",b.globalCompositeOperation!=="soft-light"&&(b.globalCompositeOperation="screen");const C=P.highlightPasses;for(let R=0;R<C;R++){const _=R/(C-1),yt=Math.max(1,n*(.96-.7*_)),y=.15*(1-_)*(1-_)*a;b.lineWidth=yt,_t(b,c),b.strokeStyle=`rgba(255,255,255,${y.toFixed(3)})`,b.stroke()}if(P.edgePasses>0){b.globalCompositeOperation="multiply";const R=P.edgePasses;for(let _=0;_<R;_++){const yt=_/(R-1),y=Math.max(1,n*(.98-.08*yt)),W=(.1-.03*yt)*a;b.lineWidth=y,_t(b,c),b.strokeStyle=`rgba(0,0,0,${Math.max(0,W).toFixed(3)})`,b.stroke()}}b.restore(),At.set(e,i,s,n,{canvas:A,normalizedWidth:N,normalizedHeight:F,pad:f,normMinX:d,normMinY:u,lastUsed:0,accessCount:0,memoryBytes:N*F*4,pathSignature:At.generatePathSignature(e)});const w=e[0],E=e[e.length-1],q=c[c.length-1],tt=Math.atan2(E.y-w.y,E.x-w.x),rt=Math.atan2(q.y,q.x),st=tt-rt;t.save(),t.globalAlpha=Math.max(0,Math.min(1,r)),t.translate(w.x,w.y),t.rotate(st),t.drawImage(A,d-f,u-f),t.restore()}function Ht(t,e,s,n,o,i=1,r){const a=o.hitcircle,h=o.hitcircleoverlay,c=n*2/(a.width||128),d=Math.max(1,Math.round(a.width*c)),u=Math.max(1,Math.round(a.height*c));if(t.save(),t.translate(e,s),t.globalAlpha=i,r){const m=`${a.src}|${r}|${d}x${u}`;let S=Dt.get(m);if(!S){S=document.createElement("canvas"),S.width=d,S.height=u;const f=S.getContext("2d");f.drawImage(a,0,0,d,u),f.globalCompositeOperation="source-in",f.fillStyle=r,f.fillRect(0,0,d,u),Dt.set(m,S)}t.drawImage(S,-d/2,-u/2,d,u)}else t.drawImage(a,-d/2,-u/2,d,u);h&&t.drawImage(h,-d/2,-u/2,d,u),t.restore()}function le(t,e,s,n,o,i,r){const a=i.approachcircle,h=n*2/(a.width||128),c=Math.max(1,Math.round(a.width*h)),d=Math.max(1,Math.round(a.height*h));if(t.save(),t.globalAlpha=.6*o,t.translate(e,s),r){const u=`${a.src}|approach|${r}|${c}x${d}`;let m=Dt.get(u);if(!m){m=document.createElement("canvas"),m.width=c,m.height=d;const S=m.getContext("2d");S.drawImage(a,0,0,c,d),S.globalCompositeOperation="source-in",S.fillStyle=r,S.fillRect(0,0,c,d),Dt.set(u,m)}t.drawImage(m,-c/2,-d/2,c,d)}else t.drawImage(a,-c/2,-d/2,c,d);t.restore()}function Ue(t,e,s,n,o,i=1){const r=o.sliderfollowcircle,a=n*2/(r.width||256),h=r.width*a,c=r.height*a;t.save(),t.globalAlpha=.9*Mt(i),t.translate(e,s),t.drawImage(r,-h/2,-c/2,h,c),t.restore()}function he(t,e,s,n,o,i,r=1){var f;if(!o.digits||i<=0)return;const h=String(i).split("").map(N=>o.digits[Number(N)]),c=((f=h[0])==null?void 0:f.height)||32,u=n*.82*.85/c,m=h.reduce((N,F)=>N+((F==null?void 0:F.width)||20)*u,0);let S=e-m/2;t.save(),t.globalAlpha=r;for(const N of h){const F=((N==null?void 0:N.width)||20)*u,A=((N==null?void 0:N.height)||20)*u;t.drawImage(N,S,s-A/2,F,A),S+=F}t.restore()}function We(t,e,s){const n=Math.max(1,Math.round(e)),o=`${t.src}|ball|${s}|${n}`;let i=Dt.get(o);if(!i){i=document.createElement("canvas"),i.width=n,i.height=n;const r=i.getContext("2d");r.clearRect(0,0,n,n),r.drawImage(t,0,0,n,n),r.globalCompositeOperation="multiply",r.fillStyle=s,r.fillRect(0,0,n,n),r.globalCompositeOperation="destination-in",r.drawImage(t,0,0,n,n),Dt.set(o,i)}return i}function Yt(t,e,s,n,o,i,r,a,h){const c=Math.max(1,o),d=c/Math.max(1,e.width||128),u=(e.width||128)*d,m=(e.height||128)*d;if(t.save(),t.translate(s,n),t.rotate(i),h?t.globalCompositeOperation="lighter":t.globalCompositeOperation="source-over",r&&r!=="#ffffff"&&r!=="rgba(255,255,255,1)"){const S=We(e,c,r);t.globalAlpha=a,t.drawImage(S,-u/2,-m/2,u,m)}else t.globalAlpha=a,t.drawImage(e,-u/2,-m/2,u,m);t.restore()}function _e(t,e,s,n,o,i){const r=t.createRadialGradient(e-n*.3,s-n*.3,n*.15,e,s,n);r.addColorStop(0,"rgba(255,255,255,1)"),r.addColorStop(1,o),t.save(),t.globalAlpha=i,t.fillStyle=r,t.beginPath(),t.arc(e,s,n,0,Math.PI*2),t.fill(),t.restore()}function zt(t){return t*(2-t)}function Ut(t,e,s,n){const o=n&&n<0?100/-n:1,i=100*s*o;return t.length/Math.max(1e-6,i)*e}function He(t,e,s,n,o){const i=n&&n<0?100/-n:1,r=100*s*i,a=t.length/Math.max(1e-6,r),h=1/Math.max(1e-6,o),c=[];for(let d=h;d<a-.001;d+=h){const u=d/a;u>0&&u<1&&c.push(u)}return c}function Ye(t,e,s){let n=1/0;for(let o=1;o<s.pts.length;o++){const i=s.pts[o-1],r=s.pts[o],a=r.x-i.x,h=r.y-i.y,c=a*a+h*h;let d=0;c>0&&(d=((t-i.x)*a+(e-i.y)*h)/c,d=Math.max(0,Math.min(1,d)));const u=i.x+a*d,m=i.y+h*d,S=Math.hypot(u-t,m-e);S<n&&(n=S)}return n}function qt(t,e,s){const n=3*s;return{x:t-n,y:e-n}}function xe(t){const e=(t==null?void 0:t.hitObjects.length)||0,s=new Array(e).fill(0),n=new Array(e).fill(1);if(!t)return{colorIndex:s,number:n};let o=0,i=0;for(let r=0;r<e;r++){const a=t.hitObjects[r];a.newCombo?(o=o+1+(a.comboSkip||0),i=1):i=(i||1)+1,s[r]=o,n[r]=i}return{colorIndex:s,number:n}}function Ge(t){const e=(t==null?void 0:t.hitObjects.length)||0,s=new Array(e).fill(0);if(!t)return s;const n=t.hitObjects,o=60,i=3;for(let r=1;r<e;r++){const a=n[r-1],h=n[r];if(h.time-a.time<=o){const d=h.x-a.x,u=h.y-a.y;if(Math.hypot(d,u)<=i){s[r]=s[r-1]+1;continue}}if(a.kind==="slider"){const d=oe(t,a),u=we(t,a),m=h.time-d;if(m<=o&&m>=-o){const S=ae(h),f=S.x-u.x,N=S.y-u.y;Math.hypot(f,N)<=i&&(s[r]=s[r-1]+1)}}}return s}function oe(t,e){if(e.kind==="circle")return e.time;if(e.kind==="spinner")return e.endTime;const{base:s,inherited:n}=$t(t,e.time),o=(s==null?void 0:s.beatLength)??500,i=n==null?void 0:n.beatLength,r=Ut(e,o,Kt(t.difficulty).SliderMultiplier,i),a=Math.max(1,e.slides);return e.time+r*a}function we(t,e){if(e.kind==="circle")return ae(e);if(e.kind==="spinner")return{x:Ot/2,y:Bt/2};const s=e,n=ie(s.curveType,s.points),o=s.length;let i=n;if(o>0&&o<n.total){const m=re(n,o),S={pts:m,segLen:[],cumLen:[0],total:o};for(let f=1;f<m.length;f++){const N=m[f].x-m[f-1].x,F=m[f].y-m[f-1].y,A=Math.hypot(N,F);S.segLen.push(A),S.cumLen.push(S.cumLen[S.cumLen.length-1]+A)}i=S}const{base:r,inherited:a}=$t(t,s.time),h=(r==null?void 0:r.beatLength)??500,c=a==null?void 0:a.beatLength;Ut(s,h,Kt(t.difficulty).SliderMultiplier,c);const u=(Math.max(1,s.slides)-1)%2===0;return Ft(i,u?1:0)}function ae(t){if(t.kind==="circle"){const s=t;return typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:{x:t.x,y:t.y}}if(t.kind==="spinner")return{x:Ot/2,y:Bt/2};const e=t;return typeof e.stackedX=="number"&&typeof e.stackedY=="number"?{x:e.stackedX,y:e.stackedY}:{x:t.x,y:t.y}}class Xe{constructor(){bt(this,"cache",new Map);bt(this,"maxSize",50);bt(this,"accessCounter",0);bt(this,"shapeUsageMap",new Map);bt(this,"totalMemoryBytes",0);bt(this,"memoryBudgetBytes");bt(this,"stats",{hits:0,misses:0,totalRenders:0,cacheSize:0,lastFrameHits:0,lastFrameMisses:0,uniqueShapesInMap:0,get hitRate(){const e=this.hits+this.misses;return e>0?this.hits/e*100:0},get totalDrawCalls(){return this.hits+this.misses}});this.memoryBudgetBytes=this.calculateMemoryBudget()}getStats(){return this.stats.cacheSize=this.cache.size,{...this.stats}}resetFrameStats(){this.stats.lastFrameHits=0,this.stats.lastFrameMisses=0}getMaxSize(){return this.maxSize}getMemoryUsage(){return this.totalMemoryBytes}getMemoryBudget(){return this.memoryBudgetBytes}calculateMemoryBudget(){const e=navigator.hardwareConcurrency||4,s=navigator.deviceMemory||4;return e<=4||s<=4?30*1024*1024:e<=8||s<=8?50*1024*1024:80*1024*1024}resetStats(){this.stats.hits=0,this.stats.misses=0,this.stats.totalRenders=0}normalizePath(e){if(e.length<2)return e;const s=e[0],n=e.map(a=>({x:a.x-s.x,y:a.y-s.y}));let o=0;for(let a=1;a<n.length;a++){const h=n[a].x-n[a-1].x,c=n[a].y-n[a-1].y,d=Math.hypot(h,c);o+=d}if(o<1e-6)return n;const i=n[n.length-1],r=Math.atan2(i.y,i.x);if(Math.hypot(i.x,i.y)>.001){const a=Math.cos(-r),h=Math.sin(-r);return n.map(c=>({x:c.x*a-c.y*h,y:c.x*h+c.y*a}))}return n}generatePathSignature(e){if(e.length<2)return"empty";const s=this.normalizePath(e),n=Math.min(32,s.length),o=[];if(s.length<=n)for(const r of s)o.push(`${r.x.toFixed(3)},${r.y.toFixed(3)}`);else for(let r=0;r<n;r++){const a=Math.floor(r/(n-1)*(s.length-1)),h=s[a];o.push(`${h.x.toFixed(3)},${h.y.toFixed(3)}`)}let i=0;for(let r=1;r<s.length-1;r++){const a=s[r-1],h=s[r],c=s[r+1],d=h.x-a.x,u=h.y-a.y,m=c.x-h.x,S=c.y-h.y,f=Math.atan2(u,d),N=Math.atan2(S,m);i+=Math.abs(N-f)}return`${o.join("|")}-curv:${i.toFixed(2)}`}hashPath(e,s,n,o){if(e.length<2)return`empty-${s}-${Math.round(n)}-${Math.round(o)}`;const i=this.normalizePath(e),r=Math.min(14,i.length),a=[];if(i.length<=r)for(const N of i)a.push(`${N.x.toFixed(2)},${N.y.toFixed(2)}`);else for(let N=0;N<r;N++){const F=Math.floor(N/(r-1)*(i.length-1)),A=i[F];a.push(`${A.x.toFixed(2)},${A.y.toFixed(2)}`)}let h=0;for(let N=1;N<i.length;N++){const F=i[N].x-i[N-1].x,A=i[N].y-i[N-1].y;h+=Math.hypot(F,A)}let c=0;for(let N=1;N<i.length-1;N++){const F=i[N-1],A=i[N],b=i[N+1],T=A.x-F.x,p=A.y-F.y,j=b.x-A.x,P=b.y-A.y,C=Math.atan2(p,T),w=Math.atan2(P,j);c+=Math.abs(w-C)}const d=Math.round(n),u=Math.round(o),m=h.toFixed(1),S=c.toFixed(2);return`${a.join("|")}-len:${m}-curv:${S}-pts:${e.length}-${s}-${d}-${u}`}get(e,s,n,o){const i=this.hashPath(e,s,n,o),r=this.cache.get(i);if(r){r.lastUsed=++this.accessCounter,r.accessCount++;const a=this.shapeUsageMap.get(i);a&&a.accessCount++,this.stats.hits++,this.stats.lastFrameHits++;const h=this.normalizePath(e),c=e[0],d=e[e.length-1],u=h[h.length-1],m=Math.atan2(d.y-c.y,d.x-c.x),S=Math.atan2(u.y,u.x),f=m-S;return{entry:r,transform:{tx:c.x,ty:c.y,angle:f,scale:1}}}return this.stats.misses++,this.stats.lastFrameMisses++,null}shouldCache(e,s,n,o,i){if(o>2e3||i>2e3)return!1;let a=0;for(let h=1;h<e.length;h++){const c=e[h].x-e[h-1].x,d=e[h].y-e[h-1].y;a+=Math.hypot(c,d)}return!(a<20)}set(e,s,n,o,i){const r=this.hashPath(e,s,n,o),a=i.canvas.width*i.canvas.height*4;if(i.memoryBytes=a,i.pathSignature=this.generatePathSignature(e),i.accessCount=0,(this.cache.size>=this.maxSize||this.totalMemoryBytes+a>this.memoryBudgetBytes)&&!this.cache.has(r)){let d=!1;if(this.shapeUsageMap.size>0){const u=[];for(const[m,S]of this.shapeUsageMap.entries())S.lastUsageTime<Date.now()-5e3&&u.push(m);if(u.length>0)for(const m of u)this.cache.delete(m),this.shapeUsageMap.delete(m),d=!0}d||this.evictByMemory(a)}const c=this.cache.get(r);c&&(this.totalMemoryBytes-=c.memoryBytes),i.lastUsed=++this.accessCounter,this.cache.set(r,i),this.totalMemoryBytes+=a,this.stats.totalRenders++}evictByMemory(e){const s=e+this.memoryBudgetBytes*.1,n=[],o=Date.now();for(const[r,a]of this.cache.entries()){const h=this.shapeUsageMap.get(r),c=h?h.lastUsageTime<o:!1,d=a.accessCount,u=a.memoryBytes;let m=0;c&&(m+=1e3),m+=u/1e3,m-=d*10,m+=(this.accessCounter-a.lastUsed)/100,n.push({key:r,entry:a,score:m})}n.sort((r,a)=>a.score-r.score);let i=0;for(const r of n){if(i>=s)break;this.cache.delete(r.key),this.shapeUsageMap.delete(r.key),this.totalMemoryBytes-=r.entry.memoryBytes,i+=r.entry.memoryBytes}}clear(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0}clearAll(){this.cache.clear(),this.shapeUsageMap.clear(),this.totalMemoryBytes=0,this.memoryBudgetBytes=this.calculateMemoryBudget()}renderShapeToCanvas(e,s,n,o,i){if(e.length<2)return null;let r=1/0,a=1/0,h=-1/0,c=-1/0;for(const p of e)p.x<r&&(r=p.x),p.y<a&&(a=p.y),p.x>h&&(h=p.x),p.y>c&&(c=p.y);const d=Math.ceil(Math.max(s,n)/2)+2,u=Math.max(1,Math.ceil(h-r+d*2)),m=Math.max(1,Math.ceil(c-a+d*2));if(!this.shouldCache(e,s,n,u,m))return null;const S=document.createElement("canvas");S.width=u,S.height=m;const f=S.getContext("2d",{willReadFrequently:!1});f.save(),f.translate(-r+d,-a+d),f.lineCap="round",f.lineJoin="round",f.globalCompositeOperation="source-over",f.globalAlpha=1,f.lineWidth=s,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let p=1;p<e.length;p++)f.lineTo(e[p].x,e[p].y);f.strokeStyle=o,f.stroke();const N=this.rgbFromCss(i)||{r:255,g:255,b:255},F=`rgba(${N.r}, ${N.g}, ${N.b}, 1)`;f.lineWidth=n,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let p=1;p<e.length;p++)f.lineTo(e[p].x,e[p].y);f.strokeStyle=F,f.stroke();const A=be(),b=ve[A];f.globalCompositeOperation="soft-light",f.globalCompositeOperation!=="soft-light"&&(f.globalCompositeOperation="screen");const T=b.highlightPasses;for(let p=0;p<T;p++){const j=p/(T-1),P=Math.max(1,n*(.96-.7*j)),C=.15*(1-j)*(1-j);f.lineWidth=P,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let w=1;w<e.length;w++)f.lineTo(e[w].x,e[w].y);f.strokeStyle=`rgba(255,255,255,${C.toFixed(3)})`,f.stroke()}if(b.edgePasses>0){f.globalCompositeOperation="multiply";const p=b.edgePasses;for(let j=0;j<p;j++){const P=j/(p-1),C=Math.max(1,n*(.98-.08*P)),w=.1-.03*P;f.lineWidth=C,f.beginPath(),f.moveTo(e[0].x,e[0].y);for(let E=1;E<e.length;E++)f.lineTo(e[E].x,e[E].y);f.strokeStyle=`rgba(0,0,0,${Math.max(0,w).toFixed(3)})`,f.stroke()}}return f.restore(),{canvas:S,minX:r,minY:a,pad:d}}rgbFromCss(e){const s=e.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(s){const o=s[1],i=o.length===3?o.split("").map(c=>c+c).join(""):o,r=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),h=parseInt(i.slice(4,6),16);return{r,g:a,b:h}}const n=e.trim().match(/^rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return n?{r:Number(n[1]),g:Number(n[2]),b:Number(n[3])}:null}precalculateShapes(e,s,n,o,i=240,r="#ffffff"){if(this.shapeUsageMap.clear(),!e||!e.hitObjects)return;const a=o*2,h=Math.max(1,a-8),c=Math.max(1,a-14),d=xe(e),u=new Set,m=[];for(let j=0;j<e.hitObjects.length;j++){const P=e.hitObjects[j];if(P.kind!=="slider")continue;const C=P,w=ie(C.curveType,C.points),E=C.length;let q=w;if(E>0&&E<w.total){const K=re(w,E),it={pts:K,segLen:[],cumLen:[0],total:E};for(let $=1;$<K.length;$++){const l=K[$].x-K[$-1].x,U=K[$].y-K[$-1].y,lt=Math.hypot(l,U);it.segLen.push(lt),it.cumLen.push(it.cumLen[it.cumLen.length-1]+lt)}q=it}const tt=d.colorIndex[j],rt=n[tt%n.length],st=this.hashPath(q.pts,rt,h,c);u.add(st);const{base:R,inherited:_}=$t(e,C.time),yt=(R==null?void 0:R.beatLength)??500,y=_==null?void 0:_.beatLength,W=Ut(C,yt,s.SliderMultiplier,y),I=Math.max(1,C.slides),L=C.time+W*I+i,O=m.find(K=>K.cacheKey===st);O?(L>O.lastUsageTime&&(O.lastUsageTime=L),O.sliderIndices.push(j)):m.push({cacheKey:st,pts:q.pts,comboColor:rt,lastUsageTime:L,sliderIndices:[j]})}const S=u.size;this.stats.uniqueShapesInMap=S;const f=200*200*4,N=Math.floor(this.memoryBudgetBytes/f);this.maxSize=Math.min(Math.ceil(S*.8),N,200);const F=6200,A=m.filter(j=>{var C;return j.sliderIndices.length>1?!0:(((C=e.hitObjects[j.sliderIndices[0]])==null?void 0:C.time)||1/0)<=F});for(const j of m)this.shapeUsageMap.set(j.cacheKey,{cacheKey:j.cacheKey,lastUsageTime:j.lastUsageTime,sliderIndices:j.sliderIndices,accessCount:0,isPreRendered:!1});const b=15;let T=0;const p=()=>{const j=T*b,P=Math.min(j+b,A.length);for(let C=j;C<P;C++){const w=A[C],E=this.normalizePath(w.pts),q=this.renderShapeToCanvas(E,h,c,r,w.comboColor);if(q){const tt={canvas:q.canvas,normalizedWidth:q.canvas.width,normalizedHeight:q.canvas.height,pad:q.pad,normMinX:q.minX,normMinY:q.minY,lastUsed:0,accessCount:0,memoryBytes:q.canvas.width*q.canvas.height*4,pathSignature:this.generatePathSignature(w.pts)};this.set(w.pts,w.comboColor,h,c,tt);const rt=this.shapeUsageMap.get(w.cacheKey);rt&&(rt.isPreRendered=!0)}}T++,P<A.length&&(typeof requestIdleCallback<"u"?requestIdleCallback(p,{timeout:100}):setTimeout(p,0))};A.length>0&&(typeof requestIdleCallback<"u"?requestIdleCallback(p,{timeout:100}):setTimeout(p,0))}evictExpiredShapes(e){const s=[];for(const[n,o]of this.shapeUsageMap.entries())if(o.lastUsageTime<e){const i=this.cache.get(n);if(i){let r=0;r+=i.memoryBytes/1e3,r-=i.accessCount*10,r-=o.accessCount*5,r+=(this.accessCounter-i.lastUsed)/100,s.push({key:n,entry:i,info:o,score:r})}}s.sort((n,o)=>o.score-n.score);for(const n of s)this.cache.has(n.key)&&(this.cache.delete(n.key),this.totalMemoryBytes-=n.entry.memoryBytes),this.shapeUsageMap.delete(n.key);this.totalMemoryBytes>this.memoryBudgetBytes&&this.evictByMemory(0)}}const At=new Xe;function Ve(){const t=navigator.hardwareConcurrency||4,e=navigator.deviceMemory||4;return t<=4||e<=4?"low":t<=8||e<=8?"medium":"high"}const ve={high:{highlightPasses:16,edgePasses:3},medium:{highlightPasses:10,edgePasses:2},low:{highlightPasses:8,edgePasses:1}};let Qt=null;function be(){return Qt===null&&(Qt=Ve()),Qt}function Zt(t,e,s,n,o,i,r,a,h,c,d,u,m,S,f="core",N=1,F=240,A){if(s.kind==="circle"){if(f!=="core")return;const b=s.time-r,T=n<=s.time?Mt((n-b)/Math.max(1,a)):1,p=n<=s.time?1:Mt(1-(n-s.time)/400),j=Mt(T*p);if(j<=.001)return;const P=typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:qt(s.x,s.y,m);if(o!=null&&o.approachcircle){const w=1+2*Mt((s.time-n)/Math.max(1,r));le(t,P.x,P.y,i*w,.8*j,o,d)}o!=null&&o.hitcircle?(t.save(),Ht(t,P.x,P.y,i,o,j,d),o!=null&&o.digits&&he(t,P.x,P.y,i,o,u,j),t.restore()):(t.save(),t.globalAlpha=j,Wt(t,P.x,P.y,i,d),t.restore())}else if(s.kind==="slider"){const b=ie(s.curveType,s.points);let T,p,j,P,C;if(A)T=A.base,p=A.inherited,j=A.baseBeat,P=A.ih,C=A.span??Ut(s,j,h,P);else{const $=$t(e,s.time);T=$.base,p=$.inherited,j=(T==null?void 0:T.beatLength)??500,P=p==null?void 0:p.beatLength,C=Ut(s,j,h,P)}const w=Math.max(1,s.slides),E=s.time+C*w,q=s.time-r,tt=Math.max(1,Math.floor(r*.4)),rt=Math.max(1,F);let st=0;n<q?st=0:n<s.time?st=Mt((n-q)/tt):n<=E?st=1:st=Mt(1-(n-E)/rt);const R=s.length;let _=b;if(R>0&&R<b.total){const $=re(b,R),l={pts:$,segLen:[],cumLen:[0],total:R};for(let U=1;U<$.length;U++){const lt=$[U].x-$[U-1].x,J=$[U].y-$[U-1].y,dt=Math.hypot(lt,J);l.segLen.push(dt),l.cumLen.push(l.cumLen[l.cumLen.length-1]+dt)}_=l}const yt=_.pts,y=!!S&&Ye(S.x,S.y,_)<=Math.max(6,i*.35),W=typeof s.stackedX=="number"&&typeof s.stackedY=="number"?{x:s.stackedX,y:s.stackedY}:qt(s.x,s.y,m),I={x:W.x-s.x,y:W.y-s.y},et=yt.map($=>({x:$.x+I.x,y:$.y+I.y})),L=i*2,O=Math.max(1,L-8),K=Math.max(1,L-14),it=(o==null?void 0:o.sliderBorder)||"#ffffff";if(f==="body"){if(st<=.01)return;De(t,et,O,K,it,d,st,1);return}if(f==="core"){const $=s.time+C*w,l=$-r,U=n<=$?Mt((n-l)/Math.max(1,a)):1,lt=n<=$?1:Mt(1-(n-$)/400),J=Mt(U*lt)*st,dt=(w-1)%2===0,mt=Ft(_,dt?1:0),ot={x:mt.x+I.x,y:mt.y+I.y};if(J>.001&&(o!=null&&o.hitcircle?Ht(t,ot.x,ot.y,i,o,J,d):(t.save(),t.globalAlpha=J,Wt(t,ot.x,ot.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const Z=i*2/(o.sliderendcircle.width||128),G=o.sliderendcircle.width*Z,nt=o.sliderendcircle.height*Z;t.save(),t.globalAlpha=J,t.translate(ot.x,ot.y),t.drawImage(o.sliderendcircle,-G/2,-nt/2,G,nt),t.restore()}if(w>1)for(let Z=0;Z<w-1;Z++){const nt=Z%2===0?1:0,k=Ft(_,nt),V={x:k.x+I.x,y:k.y+I.y},gt=s.time+C*(Z+1),vt=gt-r,Pt=n<=gt?Mt((n-vt)/Math.max(1,a)):1,v=n<=gt?1:Mt(1-(n-gt)/400),M=Mt(Pt*v);if(M>0&&(o!=null&&o.hitcircle?Ht(t,V.x,V.y,i,o,M,d):(t.save(),t.globalAlpha=M,Wt(t,V.x,V.y,i,d),t.restore()),o!=null&&o.sliderendcircle)){const z=i*2/(o.sliderendcircle.width||128),H=o.sliderendcircle.width*z,Y=o.sliderendcircle.height*z;t.save(),t.globalAlpha=M,t.translate(V.x,V.y),t.drawImage(o.sliderendcircle,-H/2,-Y/2,H,Y),t.restore()}}const Q=W,pt=s.time-r,St=n<=s.time?Mt((n-pt)/Math.max(1,a)):1,xt=n<=s.time?1:Mt(1-(n-s.time)/400),wt=Mt(St*xt)*st;if(wt>.001)if(o!=null&&o.hitcircle){if(t.save(),Ht(t,Q.x,Q.y,i,o,wt,d),o.sliderstartcircle){const Z=o.sliderstartcircle,G=i*2/(Z.width||128),nt=Z.width*G,k=Z.height*G;t.drawImage(Z,Q.x-nt/2,Q.y-k/2,nt,k)}o!=null&&o.digits&&he(t,Q.x,Q.y,i,o,u,wt),t.restore()}else t.save(),t.globalAlpha=wt,Wt(t,Q.x,Q.y,i,d),t.restore();if(o!=null&&o.approachcircle&&wt>.001){const G=1+2*Mt((s.time-n)/Math.max(1,r));le(t,Q.x,Q.y,i*G,.8*wt,o,d)}}if(f==="top"&&n>=s.time&&n<=E){const $=n-s.time,l=Math.floor($/C),U=$%C/C,J=l%2===0?U:1-U,dt=Ft(_,J),mt={x:dt.x+I.x,y:dt.y+I.y};o!=null&&o.sliderfollowcircle&&st>.001&&Ue(t,mt.x,mt.y,i*1.6,o,st);const ot=Math.max(4,Math.max(1,L-6)),Q=Mt(st);if(Q<=.001)return;const pt=.1/Math.max(1,_.total),St=Math.max(0,Math.min(1-pt,J)),xt=Math.min(1,J+pt),ut=Ft(_,St),wt=Ft(_,xt),Z=ut.x-wt.x,G=ut.y-wt.y,k=(-90+-Math.atan2(Z,G)*180/Math.PI)*Math.PI/180,V=o==null?void 0:o.sliderballFrames,gt=V&&V.length>0,vt=!!(o!=null&&o.sliderb),Pt=_.total/(C*w),v=Math.max(.15/Pt*(1e3/60),1e3/60),M=gt?Math.floor($/v)%V.length:0,z=d;if(o!=null&&o.sliderbnd&&Yt(t,o.sliderbnd,mt.x,mt.y,ot,0,"#000000",Q,!1),gt){const H=V[M];Yt(t,H,mt.x,mt.y,ot,k,z,Q,!1)}else vt?Yt(t,o.sliderb,mt.x,mt.y,ot,k,z,Q,!1):_e(t,mt.x,mt.y,ot/2,d,Q);o!=null&&o.sliderbspec&&Yt(t,o.sliderbspec,mt.x,mt.y,ot,0,"#ffffff",Q,!0)}if(f==="top"&&(o!=null&&o.reversearrow)&&w>1){let $=-1;for(let l=0;l<w-1;l++){const U=s.time+C*(l+1);if(n<U){$=l;break}}for(let l=0;l<w-1;l++){if($===-1)continue;let U=!1;if((l===$||$>0&&l===$-1)&&(U=!0),!U)continue;const lt=l%2===0,dt=Ft(_,lt?1:0),mt={x:dt.x+I.x,y:dt.y+I.y},ot=Le(_,lt?1-.001:.001)+(lt?Math.PI:0),Q=s.time+C*(l+1),pt=Q-r,St=300,xt=150,ut=((Math.min(n,Q)-pt)%St+St)%St;let wt=0,Z=1;if(n>Q){const G=1.3-zt(ut/St)*.3,nt=1.4-G,k=Math.min(300,C),V=Mt((n-Q)/k);Z=G+zt(V)*nt,wt=zt(1-V)}else if(n>=pt){wt=Mt((n-pt)/xt);const G=35,nt=250;if(ut<G)Z=1+zt(ut/G)*.3;else{const k=(ut-G)/(G+nt);Z=1.3-zt(k)*.3}}if(wt*=st,wt>.01){t.save(),t.globalAlpha=wt,t.translate(mt.x,mt.y),t.rotate(ot),t.scale(Z,Z);const G=i*2*.72/(o.reversearrow.width||128),nt=o.reversearrow.width*G,k=o.reversearrow.height*G;t.drawImage(o.reversearrow,-nt/2,-k/2,nt,k),t.restore()}}}if(f==="top"&&(o!=null&&o.sliderscorepoint)){const l={x:s.x+I.x,y:s.y+I.y},U=(w-1)%2===0,lt=Ft(_,U?1:0),J={x:lt.x+I.x,y:lt.y+I.y};for(let dt=0;dt<w;dt++){const mt=dt%2===1,ot=He(s,j,h,P,c);for(const Q of ot){const pt=mt?1-Q:Q,St=Ft(_,pt),xt={x:St.x+I.x,y:St.y+I.y},ut=s.time+C*dt+C*Q,wt=Math.hypot(xt.x-l.x,xt.y-l.y),Z=Math.hypot(xt.x-J.x,xt.y-J.y);if(wt<i||Z<i)continue;const G=ut-r;let nt=0;if(n<ut?nt=Mt((n-G)/Math.max(1,a)):nt=Mt(1-(n-ut)/200),nt*=st,nt<=.001)continue;const k=i*.15;t.save(),t.globalAlpha=nt,t.translate(xt.x,xt.y);const V=o.sliderscorepoint,gt=k*2/(V.width||64);t.drawImage(V,-V.width*gt/2,-V.height*gt/2,V.width*gt,V.height*gt),t.restore()}}}if(f==="top"&&y&&s.points.length>0){t.save(),t.globalAlpha=st,t.strokeStyle="#efefef",t.lineWidth=1,t.beginPath();const $=s.points[0];t.moveTo($.x+I.x,$.y+I.y);for(let U=1;U<s.points.length;U++){const lt=s.points[U];t.lineTo(lt.x+I.x,lt.y+I.y)}t.stroke();const l=U=>{if(U===0)return!1;if(s.curveType!=="B")return U>0;const lt=s.points[U-1],J=s.points[U];return lt.x===J.x&&lt.y===J.y};for(let U=0;U<s.points.length;U++){const lt=s.points[U],J=lt.x+I.x,dt=lt.y+I.y;U===0?t.fillStyle="#efefef":l(U)?t.fillStyle="#ff0000":s.curveType==="B"?t.fillStyle="#efefef":t.fillStyle="#ff0000",t.beginPath(),t.arc(J,dt,2,0,Math.PI*2),t.fill()}t.restore()}}else if(s.kind==="spinner"){if(f!=="core")return;const b=Ot/2,T=Bt/2,p=s.time-r,j=800,P=s.endTime;if(n<p||n>P+j)return;let C=1;if(n<s.time?C=Mt((n-p)/Math.max(1,a)):n>=s.time&&(C=1-Mt((n-P)/j)),C<=.001)return;const w=15;if(o!=null&&o.spinnerBottom){const E=o.spinnerBottom,q=w*2/(E.width||128),tt=E.width*q,rt=E.height*q;t.save(),t.globalAlpha=C,t.translate(b,T),t.drawImage(E,-tt/2,-rt/2,tt,rt),t.restore()}else t.save(),t.globalAlpha=C,t.beginPath(),t.arc(b,T,w,0,Math.PI*2),t.strokeStyle="#f9d66b",t.lineWidth=3,t.stroke(),t.restore();if(o!=null&&o.spinnerApproachcircle){const E=o.spinnerApproachcircle,tt=Bt*.9/2,rt=w,st=50,R=P-s.time;let _=0,yt=tt;if(n>=p&&n<P+st){if(n<s.time){const y=Math.min(a,r);_=Math.min(1,Math.max(0,(n-p)/Math.max(1,y))),yt=tt}else if(n>=s.time){const y=Mt((n-s.time)/Math.max(1,R));_=(1-Mt((n-P)/st))*.9,yt=tt-(tt-rt)*y}if(_>.001){const y=yt*2/(E.width||128),W=E.width*y,I=E.height*y;t.save(),t.globalAlpha=_,t.translate(b,T),t.drawImage(E,-W/2,-I/2,W,I),t.restore()}}}}}function qe(t,e,s,n,o,i,r,a){const h=r.followpoint,c=32;for(let d=0;d<s.length-1;d++){const u=s[d].obj,m=s[d+1].obj,S=s[d].idx,f=s[d+1].idx,N=oe(e,u);if(m.time-N<=0||m.newCombo)continue;const A=we(e,u),b=ae(m),T=qt(A.x,A.y,a[S]||0),p=qt(b.x,b.y,a[f]||0),j=p.x-T.x,P=p.y-T.y,C=Math.hypot(j,P);if(C<80)continue;const w=Math.floor((C-48)/c);if(w<=0)continue;const E=u.kind==="slider"?oe(e,u):u.time,tt=m.time-E;if(tt<=0)continue;const rt=Math.atan2(P,j),R=Math.max(4,i*.15)*2/(h.width||64),_=Math.max(1,Math.floor(o*.4));t.save(),t.globalCompositeOperation="source-over",t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high";for(let yt=0;yt<w;yt++){const W=c*(1.5+yt)/C;if(W>=1)continue;const I=E+W*tt,et=I-o;let L=0;if(n<et)L=0;else if(n<et+_){const it=(n-et)/_;L=zt(Mt(it))}else if(n<I)L=1;else{const it=(n-I)/_;L=1-zt(Mt(it))}if(L<=0)continue;const O=T.x+j*W,K=T.y+P*W;t.save(),t.globalAlpha=.9*L,t.translate(O,K),t.rotate(rt),t.drawImage(h,-(h.width*R)/2,-(h.height*R)/2,h.width*R,h.height*R),t.restore()}t.restore()}}function Me(t,e,s){const r=x.useRef(null),a=x.useRef(null),h=x.useRef(0);x.useEffect(()=>{const c=t.current;if(!c)return;const d=()=>{const S=c.getBoundingClientRect(),f=Math.floor(S.width),N=Math.floor(S.height);r.current&&r.current.width===f&&r.current.height===N||(r.current={width:f,height:N},a.current!==null&&clearTimeout(a.current),a.current=window.setTimeout(()=>{const F=performance.now();F-h.current>=100&&(h.current=F,e())},100))},u=window.ResizeObserver;let m=null;return u?(m=new u(d),m.observe(c)):window.addEventListener("resize",d),d(),()=>{m?m.disconnect():window.removeEventListener("resize",d),a.current!==null&&clearTimeout(a.current)}},[t,e,100,100])}const de=({beatmap:t,timeSec:e,backgroundUrl:s,skin:n,sliderBodyCutoffPx:o=1,sliderFadeOutMs:i=240})=>{const r=x.useRef(null),a=x.useRef(null),[h,c]=kt.useState(0),[d,u]=kt.useState(0),[m,S]=kt.useState(null),[f,N]=kt.useState(At.getStats()),F=x.useRef(0),[A,b]=kt.useState(0),T=x.useRef({lastTime:performance.now(),frameCount:0,fps:0}),[p,j]=kt.useState(!0),P=x.useRef(null),[C,w]=kt.useState(!1),E=x.useMemo(()=>Kt(t==null?void 0:t.difficulty),[t]);x.useEffect(()=>{if(P.current){const y=P.current.parentElement,W=!!(y!=null&&y.classList.contains("playfield-container")&&!y.closest(".embed-preview-playfield")&&!y.closest(".embed-preview-body"));w(W)}},[]);const q=x.useMemo(()=>ge(E.CS),[E.CS]),tt=x.useMemo(()=>ye(E.AR),[E.AR]),rt=x.useMemo(()=>Ae(E.AR),[E.AR]),st=x.useMemo(()=>{var I;const y=(I=t==null?void 0:t.colors)==null?void 0:I.comboColors;if(y&&y.length)return y;const W=n==null?void 0:n.comboColors;return W&&W.length?W:["#FF66AA","#99CCFF","#99FF99","#FFFF66"]},[t==null?void 0:t.colors,n==null?void 0:n.comboColors]),R=x.useMemo(()=>xe(t),[t]),_=x.useMemo(()=>Ge(t),[t]);x.useEffect(()=>{if(!s){a.current=null;return}const y=new Image;return y.onload=()=>{a.current=y,c(W=>W+1)},y.onerror=()=>{a.current=null,c(W=>W+1)},y.src=s,a.current=y,()=>{y.onload=null,y.onerror=null}},[s]);const yt=x.useCallback(()=>{u(y=>y+1)},[]);return Me(r,yt),x.useEffect(()=>{const y=r.current;if(!y)return;At.evictExpiredShapes(e*1e3);const W=window.devicePixelRatio||1,I=y.getBoundingClientRect(),et=Math.max(100,I.width),L=Math.max(100,I.height);y.width=Math.round(et*W),y.height=Math.round(L*W);const O=y.getContext("2d",{willReadFrequently:!1});O.setTransform(W,0,0,W,0,0),O.globalCompositeOperation="source-over",O.clearRect(0,0,et,L),O.fillStyle="#02060d",O.fillRect(0,0,et,L);const K=a.current;if(K&&K.complete){const J=Math.max(et/K.width,L/K.height),dt=K.width*J,mt=K.height*J;O.globalAlpha=.2,O.drawImage(K,(et-dt)/2,(L-mt)/2,dt,mt),O.globalAlpha=1}const it=16,$=Math.min((et-it*2)/Ot,(L-it*2)/Bt),l=(et-Ot*$)/2,U=(L-Bt*$)/2;if(O.save(),O.translate(l,U),O.scale($,$),O.strokeStyle="#2a3955",O.lineWidth=2/$,O.strokeRect(0,0,Ot,Bt),t){const J=e*1e3,dt=1200,mt=2e3,ot=t.hitObjects,Q=J-dt,pt=J+mt,St=Q-1e4;let xt=0,ut=ot.length;for(;xt<ut;){const k=xt+ut>>>1;ot[k].time<St?xt=k+1:ut=k}const wt=xt;for(xt=0,ut=ot.length;xt<ut;){const k=xt+ut>>>1;ot[k].time<=pt?xt=k+1:ut=k}const Z=xt,G=[];for(let k=wt;k<Z;k++){const V=ot[k],gt=V.time;let vt=gt+600,Pt;if(V.kind==="spinner")vt=V.endTime;else if(V.kind==="slider"){const{base:v,inherited:M}=$t(t,V.time),z=(v==null?void 0:v.beatLength)??500,H=M==null?void 0:M.beatLength,Y=Ut(V,z,E.SliderMultiplier,H);vt=V.time+Y*Math.max(1,V.slides),Pt={base:v,inherited:M,baseBeat:z,ih:H,span:Y}}vt>=Q&&gt<=pt&&G.push({o:V,idx:k,startTime:gt,endTime:vt,timing:Pt})}G.sort((k,V)=>k.startTime!==V.startTime?k.startTime-V.startTime:k.idx-V.idx);const nt=G.map(k=>({obj:k.o,idx:k.idx}));n!=null&&n.followpoint&&qe(O,t,nt,J,tt,q,n,_);for(let k=G.length-1;k>=0;k--){const{o:V,idx:gt,timing:vt}=G[k],Pt=st[R.colorIndex[gt]%st.length],v=R.number[gt],M=_[gt];V.kind==="slider"&&Zt(O,t,V,J,n,q,tt,rt,E.SliderMultiplier,E.SliderTickRate,Pt,v,M,m,"body",o,i,vt),Zt(O,t,V,J,n,q,tt,rt,E.SliderMultiplier,E.SliderTickRate,Pt,v,M,m,"core",o,i,vt),V.kind==="slider"&&Zt(O,t,V,J,n,q,tt,rt,E.SliderMultiplier,E.SliderTickRate,Pt,0,M,m,"top",o,i,vt)}}if(O.restore(),F.current++,F.current%10===0){const J=At.getStats();N(J),At.resetFrameStats()}const lt=performance.now();T.current.frameCount++,lt-T.current.lastTime>=1e3&&(T.current.fps=T.current.frameCount,T.current.frameCount=0,T.current.lastTime=lt,b(T.current.fps))},[t,e,s,h,q,tt,rt,n,E.SliderMultiplier,E.SliderTickRate,o,i,d,m]),x.useEffect(()=>{const y=r.current;if(!y)return;const W=et=>{const L=y.getBoundingClientRect(),O=16,K=Math.min((L.width-O*2)/Ot,(L.height-O*2)/Bt),it=(L.width-Ot*K)/2,$=(L.height-Bt*K)/2,l=(et.clientX-L.left-it)/K,U=(et.clientY-L.top-$)/K;l>=0&&l<=Ot&&U>=0&&U<=Bt?S({x:l,y:U}):S(null)},I=()=>{S(null)};return y.addEventListener("mousemove",W),y.addEventListener("mouseleave",I),()=>{y.removeEventListener("mousemove",W),y.removeEventListener("mouseleave",I)}},[]),g.jsxs("div",{ref:P,style:{position:"relative",width:"100%",height:"100%"},children:[g.jsx("canvas",{ref:r,className:"playfield",style:{width:"100%",height:"100%",display:"block"}}),C&&g.jsxs("div",{style:{position:"absolute",top:"8px",right:"8px",background:"#0d111e",color:"#cdd6f4",borderRadius:"4px",fontFamily:"monospace",fontSize:"11px",lineHeight:"1.4",minWidth:"220px",zIndex:1e3,border:"1px solid rgba(255, 255, 255, 0.1)",overflow:"hidden"},children:[g.jsxs("div",{style:{padding:"8px 12px",cursor:"pointer",userSelect:"none",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:p?"1px solid rgba(255,255,255,0.1)":"none"},onClick:()=>j(!p),children:[g.jsx("span",{style:{fontWeight:600,color:"#cdd6f4",textTransform:"lowercase"},children:"performance"}),g.jsx("span",{style:{color:"#89b4fa",fontSize:"10px"},children:p?"▼":"▶"})]}),p&&g.jsxs("div",{style:{padding:"12px"},children:[g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"fps:"}),g.jsx("span",{style:{color:"#89b4fa",fontWeight:600,background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:A})]}),g.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"slider cache (cumulative)"}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"total draw calls:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.totalDrawCalls.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache hits:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.hits.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"cache misses:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.misses.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hit rate:"}),g.jsxs("span",{style:{color:"#89b4fa",background:"#141b2e",padding:"2px 8px",borderRadius:"4px"},children:[f.hitRate.toFixed(1),"%"]})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",paddingBottom:"4px",borderBottom:"1px solid rgba(255,255,255,0.1)"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"unique shapes:"}),g.jsxs("span",{style:{color:"#89b4fa"},children:[f.uniqueShapesInMap||f.totalRenders," (cached: ",f.cacheSize,")"]})]}),g.jsx("div",{style:{fontWeight:600,marginBottom:"4px",fontSize:"10px",color:"#89b4fa",textTransform:"lowercase"},children:"per frame (last 10)"}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"draw calls/frame:"}),g.jsx("span",{style:{color:"#89b4fa"},children:(f.lastFrameHits+f.lastFrameMisses).toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"hits/frame:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.lastFrameHits.toLocaleString()})]}),g.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px"},children:[g.jsx("span",{style:{color:"#cdd6f4",textTransform:"lowercase"},children:"misses/frame:"}),g.jsx("span",{style:{color:"#89b4fa"},children:f.lastFrameMisses.toLocaleString()})]})]})]})]})},ue=({isPlaying:t,onPlayPause:e,currentTime:s,duration:n,onSeek:o,onScrubStart:i,onScrubEnd:r,bpm:a,sliderVelocity:h,timingPoints:c})=>{const d=x.useRef(null),u=x.useRef(null),[m,S]=x.useState(!1),f=x.useRef(null),N=x.useRef(!1),F=j=>{const P=Math.max(0,Math.floor(j*1e3)),C=Math.floor(P/6e4)%100,w=Math.floor(P%6e4/1e3)%60,E=Math.floor(P%1e3);return`${String(C).padStart(2,"0")}:${String(w).padStart(2,"0")}.${String(E).padStart(3,"0")}`},A=j=>{if(!d.current)return;const P=d.current.getBoundingClientRect(),C=j.clientX-P.left,w=Math.max(0,Math.min(1,C/P.width));o(w*n)},b=j=>{S(!0),i==null||i(),A(j)},T=j=>{if(j.preventDefault(),!Number.isFinite(n)||n<=0)return;N.current||(N.current=!0,i==null||i()),f.current!==null&&clearTimeout(f.current);const P=j.shiftKey?1:.1,C=j.deltaY>0?1:-1,w=Math.max(0,Math.min(n,s+C*P));o(w),f.current=window.setTimeout(()=>{N.current=!1,r==null||r(),f.current=null},150)};x.useEffect(()=>()=>{f.current!==null&&clearTimeout(f.current)},[]),x.useEffect(()=>{if(!m)return;const j=C=>{if(!d.current)return;const w=d.current.getBoundingClientRect(),E=C.clientX-w.left,q=Math.max(0,Math.min(1,E/w.width));o(q*n)},P=()=>{S(!1),r==null||r()};return window.addEventListener("mousemove",j),window.addEventListener("mouseup",P),()=>{window.removeEventListener("mousemove",j),window.removeEventListener("mouseup",P)}},[m,n,o,r]);const p=n>0?Math.max(0,Math.min(1,s/n)):0;return x.useEffect(()=>{const j=d.current,P=u.current;if(!j||!P)return;const C=j.getBoundingClientRect(),w=Math.max(1,Math.floor(C.width)),E=Math.max(1,Math.floor(C.height)),q=window.devicePixelRatio||1;(P.width!==Math.round(w*q)||P.height!==Math.round(E*q))&&(P.width=Math.round(w*q),P.height=Math.round(E*q));const tt=P.getContext("2d");tt.setTransform(q,0,0,q,0,0),tt.clearRect(0,0,w,E);const rt=Array.isArray(c)?c:[];for(let R=0;R<rt.length;R++){const _=rt[R],yt=rt[R+1];if(typeof _.effects=="number"&&(_.effects&1)===1){const W=Math.max(0,_.time/1e3),I=Math.min(n,(yt?yt.time:n*1e3)/1e3);if(I>W){const et=Math.floor(W/n*w),L=Math.ceil(I/n*w);tt.fillStyle="rgba(245, 158, 11, 0.4)";const O=Math.max(1,Math.round(E/1.6)),K=Math.round((E-O)/2);tt.fillRect(et,K,Math.max(1,L-et),O)}}}const st=(R,_,yt)=>{const y=Math.max(0,R.time/1e3),W=Math.floor(y/(n||1)*w),I=Math.max(1,Math.round(yt)),et=I/2,L=E-I/2;tt.save(),tt.strokeStyle=_,tt.lineWidth=I,tt.lineCap="round",tt.beginPath(),tt.moveTo(W+.5,et),tt.lineTo(W+.5,L),tt.stroke(),tt.restore()};for(const R of rt)(typeof R.uninherited=="number"?R.uninherited===1:(R.beatLength||0)>0)||st(R,"#22c55e",2);for(const R of rt)(typeof R.uninherited=="number"?R.uninherited===1:(R.beatLength||0)>0)&&st(R,"#ef4444",3)},[c,n]),g.jsxs("div",{className:"editor-controls-container",children:[g.jsxs("div",{className:"controls-timestamp",children:[g.jsx("div",{className:"timestamp-display",children:F(s)}),g.jsxs("div",{className:"timing-info",children:[g.jsxs("span",{className:"bpm-display",children:[a.toFixed(0),"BPM"]}),g.jsx("span",{className:"sv-display",children:n>0?`${Math.round(s/n*100)}%`:"0%"})]})]}),g.jsxs("div",{className:"controls-center",children:[g.jsx("button",{className:"controls-play-button",onClick:e,title:t?"Pause (Space)":"Play (Space)",children:t?g.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:[g.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),g.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]}):g.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:g.jsx("path",{d:"M8 5v14l11-7z"})})}),g.jsx("div",{className:"controls-progress-wrapper",ref:d,onMouseDown:b,onWheel:T,children:g.jsxs("div",{className:"progress-bar-track",children:[g.jsx("canvas",{ref:u,className:"progress-markers"}),g.jsx("div",{className:"progress-bar-fill",style:{width:`${p*100}%`}}),g.jsx("div",{className:"progress-bar-thumb",style:{left:`${p*100}%`}})]})})]})]})},fe=({masterVolume:t,songVolume:e,hitsoundVolume:s,onMasterVolumeChange:n,onSongVolumeChange:o,onHitsoundVolumeChange:i})=>{const[r,a]=x.useState(!1),h=x.useRef(null),c=x.useRef(null);x.useEffect(()=>{if(!r)return;const u=m=>{h.current&&!h.current.contains(m.target)&&c.current&&!c.current.contains(m.target)&&a(!1)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[r]);const d=u=>`${Math.round(u*100)}%`;return g.jsxs("div",{className:"volume-control-wrapper",children:[g.jsx("button",{ref:c,className:"volume-control-button",onClick:u=>{u.stopPropagation(),a(!r)},"aria-label":"Volume controls","aria-expanded":r,children:t>0?g.jsx(Re,{size:20}):g.jsx(Ie,{size:20})}),r&&g.jsxs("div",{ref:h,className:"volume-control-menu",children:[g.jsxs("div",{className:"volume-control-item",children:[g.jsx("label",{className:"volume-label",children:"Master"}),g.jsxs("div",{className:"volume-slider-container",children:[g.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:t,onChange:u=>n(parseFloat(u.target.value)),className:"volume-slider"}),g.jsx("span",{className:"volume-value",children:d(t)})]})]}),g.jsxs("div",{className:"volume-control-item",children:[g.jsx("label",{className:"volume-label",children:"Song"}),g.jsxs("div",{className:"volume-slider-container",children:[g.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:e,onChange:u=>o(parseFloat(u.target.value)),className:"volume-slider"}),g.jsx("span",{className:"volume-value",children:d(e)})]})]}),g.jsxs("div",{className:"volume-control-item",children:[g.jsx("label",{className:"volume-label",children:"Hitsounds"}),g.jsxs("div",{className:"volume-slider-container",children:[g.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:s,onChange:u=>i(parseFloat(u.target.value)),className:"volume-slider"}),g.jsx("span",{className:"volume-value",children:d(s)})]})]})]})]})};async function me(t){const e=await Be.loadAsync(t instanceof File?t:new Blob([t])),s=Object.keys(e.files);async function n(r){const a=e.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("text")}async function o(r){const a=e.file(r);if(!a)throw new Error(`Not found: ${r}`);return a.async("arraybuffer")}function i(r){return s.find(r)}return{list:s,readText:n,readArrayBuffer:o,findFirst:i}}function Gt(t){const e=t.indexOf(":");if(e===-1)return null;const s=t.slice(0,e).trim(),n=t.slice(e+1).trim();return[s,n]}function te(t){const e=t.split(/\r?\n/);let s="";const n={},o={},i={},r=[],a=[],h={comboColors:[]};let c="osu file format v?";for(let A=0;A<e.length;A++){const T=e[A].trim();if(T){if(A===0&&/^osu file format/.test(T)){c=T;continue}if(T.startsWith("[")&&T.endsWith("]")){s=T.slice(1,-1);continue}if(!T.startsWith("//"))switch(s){case"General":{const p=Gt(T);p&&(n[p[0]]=p[1]);break}case"Metadata":{const p=Gt(T);p&&(o[p[0]]=p[1]);break}case"Difficulty":{const p=Gt(T);if(!p)break;const j=Number(p[1]);i[p[0]]=Number.isFinite(j)?j:p[1];break}case"TimingPoints":{const p=T.split(",").map(P=>P.trim()),j={time:Number(p[0]||0),beatLength:Number(p[1]||0),meter:Number(p[2]||4),sampleSet:p[3]?Number(p[3]):void 0,sampleIndex:p[4]?Number(p[4]):void 0,volume:p[5]?Number(p[5]):void 0,uninherited:p[6]?Number(p[6]):void 0,effects:p[7]?Number(p[7]):void 0};r.push(j);break}case"Colours":{const p=Gt(T);if(!p)break;const[j,P]=p,C=w=>{const E=w.split(",").map(R=>R.trim());if(E.length<3)return null;const q=Math.max(0,Math.min(255,Number(E[0]||0))),tt=Math.max(0,Math.min(255,Number(E[1]||0))),rt=Math.max(0,Math.min(255,Number(E[2]||0))),st=R=>R.toString(16).padStart(2,"0");return`#${st(q)}${st(tt)}${st(rt)}`};if(/^Combo\d+$/i.test(j)){const w=C(P);w&&h.comboColors.push(w)}else if(/^SliderBorder$/i.test(j)){const w=C(P);w&&(h.sliderBorder=w)}else if(/^SliderTrackOverride$/i.test(j)){const w=C(P);w&&(h.sliderTrackOverride=w)}break}case"HitObjects":{const p=T.split(","),j=Number(p[0]),P=Number(p[1]),C=Number(p[2]),w=Number(p[3]),E=Number(p[4]||0),q=st=>{if(!st||!st.includes(":"))return;const R=st.split(":"),_=R[0]!==""?Number(R[0]):void 0,yt=R[1]!==""?Number(R[1]):void 0,y=R[2]!==""?Number(R[2]):void 0,W=R[3]!==""?Number(R[3]):void 0,I=R[4]&&R[4]!==""?R[4]:void 0;return{sampleSet:_,additionSet:yt,customIndex:y,sampleVolume:W,filename:I}},tt=(w&4)===4,rt=(w&112)>>4;if((w&1)===1){const st=q(p[5]);a.push({kind:"circle",x:j,y:P,time:C,hitSound:E,hitSample:st,newCombo:tt,comboSkip:rt})}else if((w&2)===2){const st=String(p[5]||""),[R,..._]=st.split("|"),yt=(R||"B").slice(0,1).toUpperCase(),y=Number(p[6]||1),W=Number(p[7]||0),I=[{x:j,y:P}];for(const it of _){const[$,l]=it.split(":");$&&l&&I.push({x:Number($),y:Number(l)})}let et;p[8]&&(et=String(p[8]).split("|").map(it=>Number(it||0)));let L;p[9]&&(L=String(p[9]).split("|").map(it=>{const[$,l]=it.split(":"),U=$&&$!==""?Number($):void 0,lt=l&&l!==""?Number(l):void 0;return{sampleSet:U,additionSet:lt}}));const O=p[p.length-1],K=q(O);a.push({kind:"slider",x:j,y:P,time:C,hitSound:E,curveType:yt,points:I,slides:y,length:W,edgeSounds:et,edgeSets:L,hitSample:K,newCombo:tt,comboSkip:rt})}else if((w&8)===8){const st=Number(p[5]||C),R=q(p[6]);a.push({kind:"spinner",time:C,endTime:st,hitSample:R,newCombo:tt,comboSkip:rt})}break}}}}const d=Number(n.Mode||"0"),m=["standard","taiko","catch","mania"][Math.max(0,Math.min(3,d))],S=n.AudioFilename;let f;const N=e.findIndex(A=>A.trim()==="[Events]");if(N!==-1)for(let A=N+1;A<e.length;A++){const b=e[A].trim();if(!b||b.startsWith("["))break;const T=b.match(/\"([^\"]+)\"/);if(T){f=T[1];break}}const F={comboColors:h.comboColors.length?h.comboColors:void 0,sliderBorder:h.sliderBorder,sliderTrackOverride:h.sliderTrackOverride};return{format:c,mode:m,general:n,metadata:o,difficulty:i,timingPoints:r,hitObjects:a,audioFilename:S,backgroundFilename:f,colors:F}}async function Ke(t,e){var s,n,o,i;try{const r="https://esm.sh/osu-parsers@4.1.7?bundle",a="https://esm.sh/osu-standard-stable@5.0.1?bundle";let h,c;try{h=await import(r),c=await import(a)}catch{const b="osu-parsers",T="osu-standard-stable";h=await import(b),c=await import(T)}const d=new h.BeatmapDecoder,u=new c.StandardRuleset,m=u.applyToBeatmapWithMods(d.decodeFromString(t),u.createModCombination("")),S=c.Circle,f=c.Slider,N=c.Spinner,F=m.hitObjects.filter(b=>b instanceof S||b instanceof f||b instanceof N),A=Math.min(F.length,e.hitObjects.length);for(let b=0;b<A;b++){const T=F[b],p=e.hitObjects[b];if(T instanceof N)continue;const j=(T.startX??((s=T.startPosition)==null?void 0:s.x)??T.x??0)+(((n=T.stackedOffset)==null?void 0:n.x)??0),P=(T.startY??((o=T.startPosition)==null?void 0:o.y)??T.y??0)+(((i=T.stackedOffset)==null?void 0:i.y)??0);p.stackedX=j,p.stackedY=P}return e}catch{return e}}class Je{constructor(){bt(this,"ctx",null);bt(this,"buffer",null);bt(this,"src",null);bt(this,"gainNode",null);bt(this,"startCtxTime",0);bt(this,"startOffset",0);bt(this,"_onTick");bt(this,"raf",0);bt(this,"_volume",1);bt(this,"tick",()=>{this._onTick&&this._onTick(this.currentTime),this.raf=requestAnimationFrame(this.tick)})}get duration(){var e;return((e=this.buffer)==null?void 0:e.duration)??0}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this.gainNode&&(this.gainNode.gain.value=this._volume)}async load(e){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext));const s=await this.ctx.decodeAudioData(e.slice(0));this.buffer=s,this.stop()}ensureSrc(){!this.ctx||!this.buffer||(this.gainNode||(this.gainNode=this.ctx.createGain(),this.gainNode.gain.value=this._volume,this.gainNode.connect(this.ctx.destination)),this.src=this.ctx.createBufferSource(),this.src.buffer=this.buffer,this.src.connect(this.gainNode),this.src.onended=()=>{cancelAnimationFrame(this.raf),this.raf=0})}play(e){!this.ctx||!this.buffer||(this.stop(),this.ensureSrc(),this.src&&(this.startOffset=typeof e=="number"?e:this.currentTime,this.startCtxTime=this.ctx.currentTime,this.src.start(0,this.startOffset),this.tick()))}pause(){if(!this.ctx)return;const e=this.currentTime;this.stop(),this.startOffset=e}seek(e){if(!this.ctx)return;const s=!!this.src;this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,e)),s&&this.play(this.startOffset)}setPosition(e){this.ctx&&(this.stop(),this.startOffset=Math.max(0,Math.min(this.duration,e)))}stop(){if(this.src){try{this.src.stop()}catch{}try{this.src.disconnect()}catch{}}this.src=null,this.raf&&cancelAnimationFrame(this.raf),this.raf=0}get isPlaying(){return!!this.src}get currentTime(){if(!this.ctx)return 0;if(!this.src)return Math.min(this.duration,this.startOffset);const e=this.ctx.currentTime-this.startCtxTime;return Math.max(0,Math.min(this.duration,this.startOffset+e))}onTick(e){this._onTick=e}getBuffer(){return this.buffer}getContext(){return this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx}}const Xt={1:"normal",2:"soft",3:"drum"};function Qe(t){const e=["hitnormal"];return t&2&&e.push("hitwhistle"),t&4&&e.push("hitfinish"),t&8&&e.push("hitclap"),e}class Vt{constructor(e){bt(this,"ctx");bt(this,"buffers",new Map);bt(this,"loading",null);bt(this,"slideSrc",null);bt(this,"slideGain",null);bt(this,"whistleSrc",null);bt(this,"whistleGain",null);bt(this,"active",new Set);bt(this,"masterGain",null);bt(this,"_volume",1);this.ctx=e,this.masterGain=e.createGain(),this.masterGain.gain.value=this._volume,this.masterGain.connect(e.destination)}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this.masterGain&&(this.masterGain.gain.value=this._volume)}async load(e){if(e||(e="/img/"),e.endsWith("/")||(e+="/"),this.loading)return this.loading;const s=[];for(const n of["normal","soft","drum"])for(const o of["hitnormal","hitwhistle","hitfinish","hitclap","slidertick","sliderslide","sliderwhistle"])s.push(`${n}-${o}.wav`);return this.loading=(async()=>{await Promise.all(s.map(async n=>{try{const o=await fetch(e+n);if(!o.ok)return;const i=await o.arrayBuffer(),r=await this.ctx.decodeAudioData(i.slice(0));this.buffers.set(n,r)}catch{}}))})(),this.loading}playFile(e,s=0,n=.8){const o=this.buffers.get(e);if(!o)return;try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const i=this.ctx.createBufferSource(),r=this.ctx.createGain();r.gain.value=n,i.buffer=o,i.connect(r),this.masterGain?r.connect(this.masterGain):r.connect(this.ctx.destination);const a=Math.max(this.ctx.currentTime,s);i.onended=()=>{try{i.disconnect()}catch{}try{r.disconnect()}catch{}this.active.delete(i)};try{i.start(a)}catch{}this.active.add(i)}playWithFallback(e,s,n=0,o=.8){const i=[s,"normal","soft","drum"],r=new Set;for(const h of i){const c=`${h}-${e}.wav`;if(r.has(c))continue;if(r.add(c),this.buffers.get(c))return this.playFile(c,n,o),!0}const a=`${e}.wav`;return this.buffers.get(a)?(this.playFile(a,n,o),!0):!1}playHit(e,s,n){const o=Qe(s);for(const i of o)this.playFile(`${e}-${i}.wav`,n)}playTick(e,s){this.playFile(`${e}-slidertick.wav`,s,.7)}playReverse(e,s){this.playFile(`${e}-sliderwhistle.wav`,s,.8)}startLoop(e,s,n,o=.3){const i=[s,"normal","soft","drum"];let r;for(const c of i){const d=`${c}-${e}.wav`,u=this.buffers.get(d);if(u){r=u;break}}if(!r){const c=`${e}.wav`,d=this.buffers.get(c);if(d)r=d;else return}if(e==="sliderslide")this.stopSlide();else{if(this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}try{this.ctx.state!=="running"&&this.ctx.resume().catch(()=>{})}catch{}const a=this.ctx.createBufferSource();a.buffer=r,a.loop=!0;const h=this.ctx.createGain();h.gain.value=typeof o=="number"?Math.max(0,Math.min(1,o)):.3,a.connect(h),this.masterGain?h.connect(this.masterGain):h.connect(this.ctx.destination);try{a.start(Math.max(this.ctx.currentTime,n||0))}catch{}e==="sliderslide"?(this.slideSrc=a,this.slideGain=h):(this.whistleSrc=a,this.whistleGain=h)}startSlide(e,s,n){this.startLoop("sliderslide",e,s,(typeof n=="number"?Math.max(0,Math.min(1,n)):1)*.3)}stopSlide(){if(this.slideSrc){try{this.slideSrc.stop()}catch{}try{this.slideSrc.disconnect()}catch{}this.slideSrc=null}if(this.slideGain){try{this.slideGain.disconnect()}catch{}this.slideGain=null}}startSliderLoops(e,s,n,o){this.startLoop("sliderslide",e,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.3),s&&this.startLoop("sliderwhistle",e,n,(typeof o=="number"?Math.max(0,Math.min(1,o)):1)*.25)}stopSliderLoops(){if(this.stopSlide(),this.whistleSrc){try{this.whistleSrc.stop()}catch{}try{this.whistleSrc.disconnect()}catch{}this.whistleSrc=null}if(this.whistleGain){try{this.whistleGain.disconnect()}catch{}this.whistleGain=null}}stopAll(){this.stopSlide();for(const e of Array.from(this.active)){try{e.stop()}catch{}try{e.disconnect()}catch{}this.active.delete(e)}}}function Ze(t,e){var r,a,h;const s=[],n=c=>{let d="normal";for(let u=0;u<t.timingPoints.length;u++){const m=t.timingPoints[u];if(m.time<=c&&m.sampleSet&&(d=Xt[m.sampleSet]||d),m.time>c)break}return d},o=(c,d,u,m)=>{const S=m&&m<0?100/-m:1,f=100*u*S;return c.length/Math.max(1e-6,f)*d},i=(c,d,u,m,S)=>{const f=m&&m<0?100/-m:1,N=100*u*f,F=c.length/Math.max(1e-6,N),A=1/Math.max(1e-6,S),b=[];for(let T=A;T<F-.001;T+=A){const p=T/F;p>0&&p<1&&b.push(p)}return b};for(const c of t.hitObjects)if(c.kind==="circle"){const d=n(c.time);s.push({timeMs:c.time,kind:"hit",set:d,bits:c.hitSound})}else if(c.kind==="slider"){const{base:d,inherited:u}=$t(t,c.time),m=(d==null?void 0:d.beatLength)??500,S=u==null?void 0:u.beatLength,f=o(c,m,e.SliderMultiplier,S),N=Math.max(1,c.slides),F=c.edgeSets&&((r=c.edgeSets[0])==null?void 0:r.sampleSet)&&Xt[c.edgeSets[0].sampleSet]||n(c.time),A=c.edgeSounds&&typeof c.edgeSounds[0]=="number"?c.edgeSounds[0]:c.hitSound;s.push({timeMs:c.time,kind:"hit",set:F,bits:A});const b=i(c,m,e.SliderMultiplier,S,e.SliderTickRate);for(let C=0;C<N;C++){const w=c.time+C*f;for(const E of b)s.push({timeMs:w+E*f,kind:"tick",set:F})}for(let C=1;C<N;C++){const w=c.time+C*f,E=c.edgeSets&&((a=c.edgeSets[C])==null?void 0:a.sampleSet)&&Xt[c.edgeSets[C].sampleSet]||n(w),q=c.edgeSounds&&typeof c.edgeSounds[C]=="number"?c.edgeSounds[C]:c.hitSound;s.push({timeMs:w,kind:"reverse",set:E,bits:q})}const T=c.time+f*N,p=N,j=c.edgeSets&&((h=c.edgeSets[p])==null?void 0:h.sampleSet)&&Xt[c.edgeSets[p].sampleSet]||n(T),P=c.edgeSounds&&typeof c.edgeSounds[p]=="number"?c.edgeSounds[p]:c.hitSound;s.push({timeMs:T,kind:"hit",set:j,bits:P})}else if(c.kind==="spinner"){const d=n(c.endTime);s.push({timeMs:c.endTime,kind:"hit",set:d,bits:0})}return s.sort((c,d)=>c.timeMs-d.timeMs),s}function ts(t){const e={};let s="root";e[s]={};const n=t.split(/\r?\n/);for(let o of n){let i=o.trim();if(!i||i.startsWith(";")||i.startsWith("//"))continue;if(i.startsWith("[")&&i.endsWith("]")){s=i.slice(1,-1).trim(),e[s]||(e[s]={});continue}const r=i.indexOf("=");if(r===-1)continue;const a=i.slice(0,r).trim(),h=i.slice(r+1).trim();e[s][a]=h}return e}function es(t){const e=t.Colours||t.Colors||{},s=Object.keys(e).filter(o=>/^combo\d+/i.test(o)).sort((o,i)=>{const r=Number(o.replace(/[^\d]/g,"")),a=Number(i.replace(/[^\d]/g,""));return r-a}),n=[];for(const o of s){const r=e[o].split(",").map(a=>Number(a.trim())).filter(a=>Number.isFinite(a));r.length>=3&&n.push(Se(r[0],r[1],r[2]))}return n}function ss(t){const e=t.Colours||t.Colors||{},s=e.SliderBorder||e.sliderborder;if(!s)return null;const n=s.split(",").map(o=>Number(o.trim())).filter(o=>Number.isFinite(o));return n.length>=3?Se(n[0],n[1],n[2]):null}function Se(t,e,s){const n=i=>Math.max(0,Math.min(255,Math.round(i))),o=i=>n(i).toString(16).padStart(2,"0");return`#${o(t)}${o(e)}${o(s)}`}async function ns(t){t||(t="/img/"),t.endsWith("/")||(t+="/");const e={},s=async(a,h)=>{try{const c=await ee(t+h);e[a]=c}catch{}};await Promise.all([s("hitcircle","hitcircle.png"),s("hitcircleoverlay","hitcircleoverlay.png"),s("approachcircle","approachcircle.png"),s("sliderfollowcircle","sliderfollowcircle.png"),s("followpoint","followpoint.png"),s("cursor","cursor.png"),s("cursortrail","cursortrail.png"),s("reversearrow","reversearrow.png"),s("sliderscorepoint","sliderscorepoint.png"),s("sliderstartcircle","sliderstartcircle.png"),s("sliderendcircle","sliderendcircle.png"),s("sliderb","sliderb.png"),s("sliderbnd","sliderb-nd.png"),s("sliderbspec","sliderb-spec.png"),s("spinnerApproachcircle","spinner-approachcircle.png"),s("spinnerBottom","spinner-bottom.png")]),e.sliderb||await s("sliderb","sliderb0.png");const n=[];for(let a=0;a<10;a++)try{const h=await ee(t+`sliderb${a}.png`);n.push(h)}catch{}n.length&&(e.sliderballFrames=n);const o=[];for(let a=0;a<=9;a++){const h=`default-${a}.png`,c=ee(t+h).then(d=>d).catch(()=>null);o.push(c)}const r=(await Promise.all(o)).filter(Boolean);r.length===10&&(e.digits=r);try{const a=await fetch(t+"skin.ini");if(a.ok){const h=await a.text(),c=ts(h),d=es(c);d.length&&(e.comboColors=d);const u=ss(c);u&&(e.sliderBorder=u)}}catch{}return e}async function ee(t){return new Promise((e,s)=>{const n=new Image;n.onload=()=>e(n),n.onerror=o=>s(o),n.src=t})}const ds=({open:t,onClose:e,downloadUrl:s,beatmapVersion:n,beatmapId:o})=>t?g.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",onClick:i=>i.stopPropagation(),children:[g.jsx("div",{className:"overlay-backdrop",onClick:e}),g.jsxs("div",{className:"overlay-card embed-preview-card",onClick:i=>i.stopPropagation(),children:[g.jsx("button",{className:"overlay-close",onClick:e,"aria-label":"Close embed preview",children:g.jsx(pe,{size:18})}),g.jsx("div",{className:"embed-preview-body",onClick:i=>i.stopPropagation(),children:g.jsx(Ne,{downloadUrl:s,beatmapVersion:n,beatmapId:o,onOpenInEditor:()=>{e(),window.location.hash="/editor"}})})]})]}):null,se=1,os={1:"#ffffff",2:"#ff0000",3:"#b706b7",4:"#3276e6",5:"#e6e605",6:"#843e84",7:"#e6e605",8:"#e6e605",9:"#e6e605"};function rs(t,e){for(t=Math.abs(t),e=Math.abs(e);e;){const s=e;e=t%e,t=s}return t||1}const is=({beatmap:t,currentTime:e,duration:s,onSeek:n,bookmarks:o,onScrubStart:i,onScrubEnd:r,scale:a,onScaleChange:h,beatSnapDivisor:c=4,onBeatSnapChange:d,skin:u,isPlaying:m,onPlayPause:S})=>{const f=x.useRef(null),N=48,[F,A]=x.useState(a??.4),b=x.useRef(!1),T=x.useRef([0,0]),p=x.useRef(new Set),[,j]=x.useState(0),P=x.useRef(null),C=x.useRef(!1);x.useEffect(()=>{a!==void 0&&A(a)},[a]);const w=(y,W,I)=>W/2+(y-I)/(se/F),E=(y,W,I)=>I+(y-W/2)*(se/F),q=y=>[1,2,4,8,16].includes(y)?"even":[3,6,12].includes(y)?"triplets":"custom",tt=x.useRef(new Map),rt=(y,W,I)=>{const et=Math.max(1,Math.round(W)),L=`${y.src}|mini|${I}|${et}`,O=tt.current,K=O.get(L);if(K)return K;const it=document.createElement("canvas");it.width=et,it.height=et;const $=it.getContext("2d");return $.drawImage(y,0,0,et,et),$.globalCompositeOperation="multiply",$.fillStyle=I,$.fillRect(0,0,et,et),$.globalCompositeOperation="destination-in",$.drawImage(y,0,0,et,et),O.set(L,it),it};function st(y,W,I,et,L,O){if(I<=0)return;const K=W==null?void 0:W.digits,it=Math.max(6,Math.floor(O*.75));if(K&&K.length===10){const l=String(I).split("").map(J=>K[Number(J)]),U=l.reduce((J,dt)=>J+Math.max(1,Math.round(((dt==null?void 0:dt.width)||10)*(it/((dt==null?void 0:dt.height)||it)))),0);let lt=et-U/2;y.save();for(const J of l){const dt=Math.max(1,Math.round(((J==null?void 0:J.width)||10)*(it/((J==null?void 0:J.height)||it)))),mt=it;J&&y.drawImage(J,lt,L-mt/2,dt,mt),lt+=dt}y.restore()}else y.save(),y.fillStyle="#fff",y.font=`bold ${it}px system-ui, sans-serif`,y.textAlign="center",y.textBaseline="middle",y.fillText(String(I),et,L),y.restore()}function R(y,W){const{base:I,inherited:et}=$t(y,W.time),L=(I==null?void 0:I.beatLength)??500,O=et==null?void 0:et.beatLength,K=O&&O<0?100/-O:1,$=100*Number(y.difficulty.SliderMultiplier??1)*K;return W.length/Math.max(1e-6,$)*L}function _(y,W){return R(y,W)*Math.max(1,W.slides)}const yt=x.useCallback(()=>{j(y=>y+1)},[]);return Me(f,yt),x.useEffect(()=>{var mt;const y=f.current;if(!y)return;const W=window.devicePixelRatio||1,I=Math.min(3,Math.max(1,W)),et=y.getBoundingClientRect(),L=Math.max(200,Math.min(et.width,1e4)),O=N,K=16384,it=Math.min(K,Math.max(1,Math.round(L*I))),$=Math.min(K,Math.max(1,Math.round(O*I)));y.width=it,y.height=$;const l=y.getContext("2d");try{l.setTransform(I,0,0,I,0,0)}catch{}l.globalCompositeOperation="source-over",l.clearRect(0,0,L,O),l.fillStyle="#0f1626",l.fillRect(0,0,L,O);const U=e*1e3,lt=L/2*(se/F)+120,J=U-lt,dt=U+lt;if(t){const{base:ot}=$t(t,U);if(ot&&ot.beatLength>0){const Q=ot.beatLength,pt=c,St=ot.time+Q*Math.ceil((U-ot.time)/Q),xt=ut=>{const wt=w(ut,L,U);if(wt<-1||wt>L+1)return;const Z=Math.round(ut-(Math.round((ut-ot.time)/Q)*Q+ot.time))===0,G=Z&&Math.round((ut-ot.time)/Q)%(ot.meter||4)===0;let nt="#cdd6f4";if(!Z){const k=Math.floor((ut-ot.time)/Q)*Q+ot.time,V=Math.round((ut-k)/(Q/pt)),gt=pt/rs(pt,V);nt=os[gt]||"#929292"}l.strokeStyle=nt,l.lineWidth=Z?2:1,l.beginPath(),l.moveTo(wt+.5,G?0:10),l.lineTo(wt+.5,G?O:O-10),l.stroke()};for(let ut=St;ut<=dt;ut+=Q/pt)xt(ut);for(let ut=St-Q/pt;ut>=J;ut-=Q/pt)xt(ut)}}if(t){const ot=t.hitObjects,Q=(mt=t.colors)!=null&&mt.comboColors&&t.colors.comboColors.length?t.colors.comboColors:u!=null&&u.comboColors&&u.comboColors.length?u.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],pt=new Array(ot.length).fill(0),St=new Array(ot.length).fill(1);{let nt=0;for(let k=0;k<ot.length;k++){const V=ot[k];V.newCombo&&(nt=nt+1+(V.comboSkip||0)),pt[k]=nt,k===0||pt[k]!==pt[k-1]?St[k]=1:St[k]=(St[k-1]||1)+1}}const[xt,ut]=T.current;if(Math.abs(xt-ut)>0){const nt=w(Math.min(xt,ut),L,U),k=w(Math.max(xt,ut),L,U);l.fillStyle="rgba(255,255,255,0.25)",l.fillRect(Math.max(0,nt),0,Math.max(0,Math.min(L,k)-Math.max(0,nt)),O)}const Z=Math.floor(O*.5),G=Math.max(2,Math.floor(O*.38));for(let nt=ot.length-1;nt>=0;nt--){const k=ot[nt],V=k.time,gt=k.kind==="slider"?V+_(t,k):k.endTime??V;if(gt<J||V>dt)continue;const vt=w(V,L,U),Pt=w(gt,L,U),v=p.current.has(nt),M=Q[pt[nt]%Q.length];if(l.fillStyle=v?"#f59e0b":"#1f2b45",l.fillRect(Math.floor(vt),0,1,O),k.kind==="circle"){const z=u==null?void 0:u.hitcircle,H=u==null?void 0:u.hitcircleoverlay;if(z){const Y=G*2,B=Y/(z.width||128),D=(z.width||128)*B,X=(z.height||128)*B;l.save(),l.globalAlpha=.95;const at=rt(z,Math.max(1,Math.round(Y)),M);l.drawImage(at,vt-D/2,Z-X/2,D,X),H&&l.drawImage(H,vt-D/2,Z-X/2,D,X),l.restore(),st(l,u,St[nt],vt,Z,G)}else l.save(),l.beginPath(),l.arc(vt,Z,G,0,Math.PI*2),l.fillStyle=M,l.fill(),l.restore(),st(l,u,St[nt],vt,Z,G)}else if(k.kind==="slider"){l.save();const z=Math.min(vt,Pt),H=Math.max(4,Math.abs(Pt-vt)),Y=Math.max(6,Math.floor(O*.7)),B=Math.floor((O-Y)/2),D=3;l.beginPath(),l.moveTo(z+D,B),l.lineTo(z+H-D,B),l.quadraticCurveTo(z+H,B,z+H,B+D),l.lineTo(z+H,B+Y-D),l.quadraticCurveTo(z+H,B+Y,z+H-D,B+Y),l.lineTo(z+D,B+Y),l.quadraticCurveTo(z,B+Y,z,B+Y-D),l.lineTo(z,B+D),l.quadraticCurveTo(z,B,z+D,B),l.closePath(),l.fillStyle=v?"rgba(245,158,11,0.9)":M,l.globalAlpha=v?.95:.85,l.fill(),l.restore();const X=u==null?void 0:u.hitcircle,at=u==null?void 0:u.hitcircleoverlay;if(X){const ct=G*2,Ct=ct/(X.width||128),Tt=(X.width||128)*Ct,jt=(X.height||128)*Ct;l.save(),l.globalAlpha=.95;const Nt=rt(X,Math.max(1,Math.round(ct)),M);l.drawImage(Nt,vt-Tt/2,Z-jt/2,Tt,jt),at&&l.drawImage(at,vt-Tt/2,Z-jt/2,Tt,jt),l.restore(),st(l,u,St[nt],vt,Z,G),l.save(),l.globalAlpha=.95;const Rt=rt(X,Math.max(1,Math.round(ct)),M);l.drawImage(Rt,Pt-Tt/2,Z-jt/2,Tt,jt),at&&l.drawImage(at,Pt-Tt/2,Z-jt/2,Tt,jt),l.restore()}const ft=k,ht=Math.max(1,ft.slides);if(ht>1&&t){const ct=R(t,ft);for(let Ct=1;Ct<ht;Ct++){const Tt=V+ct*Ct;if(Tt<J||Tt>dt)continue;const jt=w(Tt,L,U),Nt=u==null?void 0:u.reversearrow;if(Nt){const It=Math.max(8,Math.floor(G*1.2))/(Nt.width||128),Et=(Nt.width||128)*It,Lt=(Nt.height||128)*It;l.save(),l.globalAlpha=.9,l.translate(jt,Z),l.drawImage(Nt,-Et/2,-Lt/2,Et,Lt),l.restore()}else if(X){const Rt=Math.max(4,Math.floor(G*.75)),It=Rt/(X.width||128),Et=(X.width||128)*It,Lt=(X.height||128)*It;l.save(),l.globalAlpha=.85;const Te=v?"#f59e0b":M,Ce=rt(X,Math.max(1,Math.round(Rt*2)),Te);l.drawImage(Ce,jt-Et/2,Z-Lt/2,Et,Lt),at&&(l.globalAlpha=.7,l.drawImage(at,jt-Et/2,Z-Lt/2,Et,Lt)),l.restore()}else l.save(),l.beginPath(),l.arc(jt,Z,Math.max(2,Math.floor(G*.6)),0,Math.PI*2),l.fillStyle=v?"#f59e0b":M,l.globalAlpha=.85,l.fill(),l.restore()}}}else if(k.kind==="spinner"){const H=V-36,Y=gt-36,B=w(H,L,U),D=w(Y,L,U),X=Math.min(B,D),at=Math.max(4,Math.abs(D-B)),ft=Math.max(6,Math.floor(O*.7)),ht=Math.floor((O-ft)/2);l.save();const ct=3;l.beginPath(),l.moveTo(X+ct,ht),l.lineTo(X+at-ct,ht),l.quadraticCurveTo(X+at,ht,X+at,ht+ct),l.lineTo(X+at,ht+ft-ct),l.quadraticCurveTo(X+at,ht+ft,X+at-ct,ht+ft),l.lineTo(X+ct,ht+ft),l.quadraticCurveTo(X,ht+ft,X,ht+ft-ct),l.lineTo(X,ht+ct),l.quadraticCurveTo(X,ht,X+ct,ht),l.closePath(),l.fillStyle=v?"rgba(245,158,11,0.9)":"rgba(87,177,255,0.85)",l.globalAlpha=v?.95:.85,l.fill(),l.restore();const Ct=u==null?void 0:u.hitcircle,Tt=u==null?void 0:u.hitcircleoverlay;if(Ct){const jt=G*2,Nt=jt/(Ct.width||128),Rt=(Ct.width||128)*Nt,It=(Ct.height||128)*Nt;l.save(),l.globalAlpha=.95;const Et=rt(Ct,Math.max(1,Math.round(jt)),M);l.drawImage(Et,B-Rt/2,Z-It/2,Rt,It),Tt&&l.drawImage(Tt,B-Rt/2,Z-It/2,Rt,It),l.restore(),l.save(),l.globalAlpha=.95;const Lt=rt(Ct,Math.max(1,Math.round(jt)),M);l.drawImage(Lt,D-Rt/2,Z-It/2,Rt,It),Tt&&l.drawImage(Tt,D-Rt/2,Z-It/2,Rt,It),l.restore()}else l.save(),l.beginPath(),l.arc(B,Z,G,0,Math.PI*2),l.fillStyle=M,l.fill(),l.restore(),l.save(),l.beginPath(),l.arc(D,Z,G,0,Math.PI*2),l.fillStyle=M,l.fill(),l.restore()}if(gt>V){const z=w(gt,L,U);l.fillStyle=v?"rgba(245,158,11,0.35)":"rgba(87,177,255,0.2)",l.fillRect(Math.min(vt,z),O-8,Math.max(1,Math.abs(z-vt)),6)}}}if(o&&o.length>0){l.fillStyle="#f59e0b";for(const ot of o){const Q=ot*1e3,pt=w(Q,L,U);pt<-6||pt>L+6||(l.beginPath(),l.moveTo(pt,0),l.lineTo(pt+6,10),l.lineTo(pt-6,10),l.closePath(),l.fill())}}l.strokeStyle="#cdd6f4",l.lineWidth=2,l.beginPath(),l.moveTo(L/2+.5,0),l.lineTo(L/2+.5,O),l.stroke(),l.beginPath(),l.moveTo(L/2-3,0),l.lineTo(L/2,3),l.lineTo(L/2+3,0),l.closePath(),l.fillStyle="#cdd6f4",l.fill(),l.beginPath(),l.moveTo(L/2-3,O),l.lineTo(L/2,O-3),l.lineTo(L/2+3,O),l.closePath(),l.fill()},[t,e,s,o,F,c,u]),x.useEffect(()=>{const y=f.current;if(!y)return;const W=I=>{if(I.altKey){I.preventDefault();const K=I.deltaY>0?Math.max(.5,F-.1):Math.min(1.5,F+.1),it=Math.round(K*10)/10;A(it),h==null||h(it);return}I.preventDefault(),C.current||(C.current=!0,i==null||i()),P.current!==null&&clearTimeout(P.current);const et=I.shiftKey?1:.1,L=I.deltaY>0?1:-1,O=Math.max(0,Math.min(s,e+L*et));n(O),P.current=window.setTimeout(()=>{C.current=!1,r==null||r(),P.current=null},150)};return y.addEventListener("wheel",W,{passive:!1}),()=>{y.removeEventListener("wheel",W),P.current!==null&&clearTimeout(P.current)}},[F,h,e,s,n,i,r]),x.useEffect(()=>{const y=f.current;if(!y)return;const W=I=>{const et=y.getBoundingClientRect(),L=et.width,O=e*1e3,K=E(I.clientX-et.left,L,O);b.current=!0,I.ctrlKey?T.current=[K,K]:(i&&i(),n(Math.max(0,Math.min(s,K/1e3))));const it=l=>{if(!b.current)return;const U=E(Math.max(0,Math.min(et.width,l.clientX-et.left)),L,O);if(I.ctrlKey){if(T.current=[K,U],t){const lt=Math.min(K,U),J=Math.max(K,U),dt=new Set;for(let mt=0;mt<t.hitObjects.length;mt++){const ot=t.hitObjects[mt],Q=ot.time,pt=ot.kind==="slider"?Q+_(t,ot):ot.endTime??Q;(lt<Q&&J>Q||lt<pt&&J>pt||Q<J&&pt>lt)&&dt.add(mt)}p.current=dt}j(lt=>lt+1)}else n(Math.max(0,Math.min(s,U/1e3)))},$=()=>{b.current=!1,I.ctrlKey||r&&r(),window.removeEventListener("mousemove",it),window.removeEventListener("mouseup",$)};window.addEventListener("mousemove",it),window.addEventListener("mouseup",$)};return y.addEventListener("mousedown",W),()=>{y.removeEventListener("mousedown",W)}},[t,e,s,n,i,r]),g.jsx("div",{className:"timeline-wrapper",children:g.jsxs("div",{className:"timeline-row",children:[g.jsx("canvas",{ref:f,className:"timeline",style:{height:N,display:"block"}}),g.jsxs("div",{className:"zoom-column",children:[g.jsx("button",{className:"zoom-btn small",onClick:()=>{const y=Math.min(1.5,F+.1);A(y),h==null||h(y)},children:"+"}),g.jsx("button",{className:"zoom-btn small",onClick:()=>{const y=Math.max(.5,F-.1);A(y),h==null||h(y)},children:"-"})]}),g.jsxs("div",{className:"beatsnap-vertical",children:[g.jsx("div",{className:"bs-label",children:"Beat Snap Divisor"}),g.jsxs("div",{className:"bs-value",children:["1/",c]}),g.jsxs("div",{className:"bs-arrows",children:[g.jsx("button",{className:"beat-snap-btn icon xs",title:"Prev divisor",onClick:()=>d==null?void 0:d(Math.max(1,c===16?12:c===12?9:c-1)),children:"◀"}),g.jsx("span",{className:"bs-kind",children:q(c)}),g.jsx("button",{className:"beat-snap-btn icon xs",title:"Next divisor",onClick:()=>d==null?void 0:d(Math.min(16,c===9?12:c===12?16:c+1)),children:"▶"})]})]})]})})},us=()=>{const[t,e]=x.useState(null),[s,n]=x.useState(void 0),o=x.useRef(void 0),[i,r]=x.useState(""),a=x.useRef(new Je),[h,c]=x.useState(0),[d,u]=x.useState(!1),[m,S]=x.useState(0),[f,N]=x.useState(null),F=x.useRef(null),A=x.useRef([]),b=x.useRef(0),T=x.useRef(0),p=x.useRef(0),j=x.useRef(0),[P,C]=x.useState([]),[w,E]=x.useState(1),[q,tt]=x.useState(!1),rt=x.useRef(!1),st=x.useRef(!1),R=x.useRef(null),_=x.useRef(!1),yt=x.useRef(),[y,W]=x.useState(.4),[I,et]=x.useState(4),[L,O]=x.useState(!1),[K,it]=x.useState(.6),[$,l]=x.useState(1),[U,lt]=x.useState(.6),J=x.useRef(null),[dt,mt]=x.useState([]),[ot,Q]=x.useState(""),[pt,St]=x.useState(!1),[xt,ut]=x.useState(!1),wt=x.useCallback(async(v,M)=>{var z,H;At.clearAll();try{const Y=await v.readText(M);let B=te(Y);try{B=await Ke(Y,B)}catch{}e(B);try{const D=B.metadata.TitleUnicode||B.metadata.Title||"",X=B.metadata.ArtistUnicode||B.metadata.Artist||"",at=B.metadata.Creator||B.metadata.creator||"",ft=B.metadata.Version||"",ht=Number(B.metadata.BeatmapID||0)||null;window.dispatchEvent(new CustomEvent("editor:info",{detail:{title:D,artist:X,mapper:at,version:ft,beatmapId:ht}}))}catch{}try{const D=Kt(B.difficulty);A.current=Ze(B,D),b.current=0;const X=(z=B.colors)!=null&&z.comboColors&&B.colors.comboColors.length?B.colors.comboColors:["#FF66AA","#99CCFF","#99FF99","#FFFF66"],at=ge(D.CS),ft=(f==null?void 0:f.sliderBorder)||((H=B.colors)==null?void 0:H.sliderBorder)||"#ffffff";At.precalculateShapes(B,D,X,at,240,ft)}catch{A.current=[],b.current=0}if(S(0),B.audioFilename){const D=v.findFirst(X=>X.toLowerCase().endsWith(B.audioFilename.toLowerCase()))||B.audioFilename;try{const X=await v.readArrayBuffer(D);await a.current.load(X),S(a.current.duration||0)}catch(X){console.warn("Failed to load audio:",X)}}if(B.backgroundFilename)try{const D=v.findFirst(ft=>ft.toLowerCase().endsWith(B.backgroundFilename.toLowerCase()))||B.backgroundFilename,X=await v.readArrayBuffer(D);o.current&&URL.revokeObjectURL(o.current);const at=URL.createObjectURL(new Blob([X]));o.current=at,n(at)}catch{o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0)}else o.current&&(URL.revokeObjectURL(o.current),o.current=void 0),n(void 0);a.current.seek(0),c(0),u(!1)}catch(Y){console.error("Error loading beatmap path:",Y),alert(Y instanceof Error?Y.message:String(Y))}},[]);x.useEffect(()=>{const v=a.current;return v.onTick(M=>{rt.current||c(M)}),()=>v.stop()},[]),x.useEffect(()=>{const v=()=>O(!0);return window.addEventListener("editor:embed:preview",v),()=>window.removeEventListener("editor:embed:preview",v)},[]),x.useEffect(()=>{const v=window.__editorTransferOsz,M=window.__editorTransferPath,z=v?null:sessionStorage.getItem("editor:transfer:osz"),H=M?null:sessionStorage.getItem("editor:transfer:path");if(!v&&!z||!M&&!H)return;v?(delete window.__editorTransferOsz,delete window.__editorTransferPath):(sessionStorage.removeItem("editor:transfer:osz"),sessionStorage.removeItem("editor:transfer:path"));let Y=null;return Y=window.setTimeout(()=>{window.__editorTransferOsz&&(delete window.__editorTransferOsz,delete window.__editorTransferPath)},6e4),(async()=>{try{let B;if(v)B=v;else{const ct=atob(z),Ct=new Uint8Array(ct.length);for(let Tt=0;Tt<ct.length;Tt++)Ct[Tt]=ct.charCodeAt(Tt);B=Ct.buffer}const D=M||H,X=await me(B);J.current=X;const at=X.list.filter(ct=>ct.toLowerCase().endsWith(".osu"));if(!at.length)throw new Error("No .osu file in archive");const ft=[];for(const ct of at)try{const Ct=await X.readText(ct),Tt=te(Ct),jt=String(Tt.metadata.Version||"");ft.push({path:ct,version:jt,mode:Tt.mode})}catch{}mt(ft);const ht=at.includes(D)?D:at[0];Q(ht);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:ft,selected:ht}}))}catch{}await wt(X,ht),r("Transferred from preview"),Y!==null&&clearTimeout(Y)}catch(B){console.error("Failed to load transferred OSZ:",B),alert(B instanceof Error?B.message:"Failed to load transferred beatmap"),Y!==null&&clearTimeout(Y)}})(),()=>{Y!==null&&clearTimeout(Y)}},[wt]),x.useEffect(()=>{if(!L)return;const v=M=>{M.key==="Escape"&&O(!1)};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)},[L]),x.useEffect(()=>{try{localStorage.getItem("editor:welcome:hidden")==="1"||St(!0)}catch{St(!0)}},[]),x.useEffect(()=>{const v=async()=>{try{const M=a.current.getContext();if(M.state!=="running"&&await M.resume(),!F.current){const z=new Vt(M);F.current=z,await z.load().catch(()=>{})}}catch{}window.removeEventListener("pointerdown",v),window.removeEventListener("keydown",v)};return window.addEventListener("pointerdown",v,{once:!0}),window.addEventListener("keydown",v,{once:!0}),()=>{window.removeEventListener("pointerdown",v),window.removeEventListener("keydown",v)}},[]),x.useEffect(()=>{ns().then(v=>N(v)).catch(()=>N(null))},[]),x.useEffect(()=>{a.current&&(a.current.volume=$*K)},[$,K]),x.useEffect(()=>{F.current&&(F.current.volume=U*K)},[U,K]);const Z=x.useCallback(async v=>{console.log("Attempting to load OSZ file:",v.name),r(v.name);try{const M=await me(v);console.log("OSZ loaded, contents:",M.list),J.current=M;const z=M.list.filter(Y=>Y.toLowerCase().endsWith(".osu"));if(!z.length)throw new Error("No .osu file in archive");const H=[];for(const Y of z)try{const B=await M.readText(Y),D=te(B),X=String(D.metadata.Version||"");H.push({path:Y,version:X,mode:D.mode})}catch{}mt(H),Q(z[0]);try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:H,selected:z[0]}}))}catch{}await wt(M,z[0])}catch(M){console.error("Error in onOpenOsz:",M),alert(M instanceof Error?M.message:String(M))}},[]),G=x.useMemo(()=>{if(m>0)return m;if(!t)return 0;const v=t.hitObjects[t.hitObjects.length-1];return v?(("endTime"in v?v.endTime:v.time)+2e3)/1e3:0},[m,t]),nt=x.useCallback(v=>{var B;q?(a.current&&m>0&&a.current.setPosition(v),c(v)):(a.current.seek(v),c(v));const M=v*1e3,z=A.current;let H=0,Y=z.length;for(;H<Y;){const D=H+Y>>>1;z[D].timeMs<=M?H=D+1:Y=D}b.current=H;try{(B=F.current)==null||B.stopSlide()}catch{}m===0&&d&&!q&&(p.current=performance.now(),j.current=v)},[q,m,d]),k=x.useCallback(async()=>{var H,Y;if(a.current.isPlaying&&m>0||d){a.current.pause(),u(!1),a.current.isPlaying&&a.current.stop(),T.current&&(cancelAnimationFrame(T.current),T.current=0);try{(H=F.current)==null||H.stopAll()}catch{}}else{if(rt.current)return;try{const B=a.current.getContext();if(B.state!=="running"&&await B.resume(),!F.current){const D=new Vt(B);F.current=D,await D.load().catch(()=>{})}}catch{}if(m>0){const B=Math.max(0,m);let D=Math.max(0,Math.min(B,typeof h=="number"?h:0));if(D>=B-.001&&(D=0),D!==h){c(D);const X=D*1e3,at=A.current;let ft=0,ht=at.length;for(;ft<ht;){const ct=ft+ht>>>1;at[ct].timeMs<=X?ft=ct+1:ht=ct}b.current=ft}gt.current=D,a.current.play(D),u(!0),a.current.isPlaying||u(!1);try{const X=(typeof h=="number"?h:0)*1e3,at=A.current;let ft=-1;for(let ht=0;ht<at.length;ht++)at[ht].timeMs<=X&&at[ht].kind==="slide_start"&&(ft=ht);if(ft!==-1){let ht=!1;for(let ct=ft+1;ct<at.length;ct++)if(at[ct].kind==="slide_end"){ht=at[ct].timeMs>=X;break}if(ht){const ct=at[ft];(Y=F.current)==null||Y.startSlide(ct.set)}}}catch{}}else{u(!0),p.current=performance.now();const B=Math.max(0,G||0),D=typeof h=="number"&&h>=B-.001?0:h;if(D!==h){c(D);const at=D*1e3,ft=A.current;let ht=0,ct=ft.length;for(;ht<ct;){const Ct=ht+ct>>>1;ft[Ct].timeMs<=at?ht=Ct+1:ct=Ct}b.current=ht}j.current=D;const X=()=>{if(rt.current){T.current=0;return}const at=(performance.now()-p.current)/1e3,ft=Math.min(G||1/0,j.current+at);if(c(ft),ft>=(G||1/0)){u(!1);return}T.current=requestAnimationFrame(X)};T.current=requestAnimationFrame(X)}}},[d,m,h,G]);x.useEffect(()=>{yt.current=k},[k]);const V=x.useMemo(()=>{if(!t)return{bpm:0,sliderVelocity:0};const{base:v,inherited:M}=$t(t,h*1e3),z=v?6e4/v.beatLength:0,H=M?-100/M.beatLength:1;return{bpm:z,sliderVelocity:H}},[t,h]);x.useCallback(v=>{var z;const M=(z=v.target.files)==null?void 0:z[0];if(M){console.log("File selected in input:",M.name);try{const H=a.current.getContext();if(H.state!=="running"&&H.resume(),!F.current){const Y=new Vt(H);F.current=Y,Y.load().catch(()=>{})}}catch{}Z(M).catch(H=>{console.error("Error from onOpenOsz via file input:",H),alert(String((H==null?void 0:H.message)||H))})}},[Z]),x.useEffect(()=>{const v=M=>{const H=M.detail;H&&Z(H).catch(Y=>{alert(Y instanceof Error?Y.message:String(Y))})};return window.addEventListener("editor:file",v),()=>window.removeEventListener("editor:file",v)},[Z]),x.useEffect(()=>{const v=M=>{if(M.target&&M.target.tagName==="INPUT")return;if(M.code==="Space"){M.preventDefault(),yt.current&&yt.current();return}const z=M.shiftKey?1:.1;M.code==="ArrowLeft"&&(M.preventDefault(),nt(Math.max(0,h-z))),M.code==="ArrowRight"&&(M.preventDefault(),nt(Math.min(G,h+z))),M.code==="Home"&&(M.preventDefault(),nt(0)),M.code==="End"&&(M.preventDefault(),nt(G)),M.code==="KeyB"&&(M.preventDefault(),C(H=>[...H,h]))};return window.addEventListener("keydown",v),()=>window.removeEventListener("keydown",v)},[k,nt,h,G]),x.useEffect(()=>{const v=M=>{var ht;const z=M.target;if(!z||z.closest(".top-nav")||z.tagName==="INPUT"||z.tagName==="TEXTAREA"||M.altKey||z.closest(".timeline-wrapper")||z.closest(".editor-controls-container")||(M.preventDefault(),!Number.isFinite(G)||G<=0))return;if(!_.current){_.current=!0;const ct=a.current.isPlaying&&m>0;st.current=ct,ct&&a.current.pause(),u(!1),rt.current=!0,tt(!0)}R.current!==null&&clearTimeout(R.current);const H=M.shiftKey?1:.1,Y=M.deltaY>0?1:-1,B=Math.max(0,Math.min(G,h+Y*H));m>0&&a.current.setPosition(B),c(B);const D=B*1e3,X=A.current;let at=0,ft=X.length;for(;at<ft;){const ct=at+ft>>>1;X[ct].timeMs<=D?at=ct+1:ft=ct}b.current=at;try{(ht=F.current)==null||ht.stopSlide()}catch{}R.current=window.setTimeout(()=>{_.current=!1,rt.current=!1,tt(!1),R.current=null},150)};return window.addEventListener("wheel",v,{passive:!1}),()=>{window.removeEventListener("wheel",v),R.current!==null&&clearTimeout(R.current)}},[h,G,d,m]),x.useEffect(()=>{const v=M=>{var B;const H=(B=M.detail)==null?void 0:B.path,Y=J.current;!Y||!H||(Q(H),wt(Y,H).then(()=>{try{window.dispatchEvent(new CustomEvent("editor:difficulty:list",{detail:{items:dt,selected:H}}))}catch{}}))};return window.addEventListener("editor:difficulty:select",v),()=>window.removeEventListener("editor:difficulty:select",v)},[dt,wt]);const gt=x.useRef(0);x.useEffect(()=>{if(!t){gt.current=h;return}const v=F.current;if(!v){gt.current=h;return}const M=gt.current,z=h;if(gt.current=h,!d||q||z<=M||z-M>1)return;try{const D=a.current.getContext();if(D.state!=="running"){D.resume().catch(()=>{});return}}catch{}const H=z*1e3,Y=A.current;let B=b.current;for(;B<Y.length&&Y[B].timeMs<=H;B++){const D=Y[B];D.kind==="hit"?v.playHit(D.set,D.bits||0):D.kind==="tick"?v.playTick(D.set):D.kind==="reverse"&&(typeof D.bits=="number"?v.playHit(D.set,D.bits):v.playReverse(D.set))}b.current=B},[h,t,d,q]);const vt=x.useCallback(()=>{const v=a.current.isPlaying&&m>0;st.current=v,v&&a.current.pause(),T.current&&(cancelAnimationFrame(T.current),T.current=0),u(!1),rt.current=!0,tt(!0)},[m]),Pt=x.useCallback(async()=>{rt.current=!1,tt(!1);try{const v=a.current.getContext();if(v.state!=="running"&&await v.resume(),!F.current){const M=new Vt(v);F.current=M,await M.load().catch(()=>{})}}catch{}},[]);return g.jsxs("div",{className:"app fullscreen-editor",children:[g.jsx(is,{beatmap:t,currentTime:h,duration:G,onSeek:nt,bookmarks:P,onScrubStart:vt,onScrubEnd:Pt,scale:y,onScaleChange:W,beatSnapDivisor:I,onBeatSnapChange:et,skin:f||void 0,isPlaying:d,onPlayPause:k}),g.jsxs("div",{className:"playfield-container",children:[g.jsx(de,{beatmap:t,timeSec:h,backgroundUrl:s,skin:f,sliderBodyCutoffPx:w}),g.jsx(fe,{masterVolume:K,songVolume:$,hitsoundVolume:U,onMasterVolumeChange:it,onSongVolumeChange:l,onHitsoundVolumeChange:lt})]}),g.jsx(ue,{isPlaying:d,onPlayPause:k,currentTime:h,duration:G,onSeek:nt,onScrubStart:vt,onScrubEnd:Pt,bpm:V.bpm,sliderVelocity:V.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints}),pt&&g.jsx("div",{className:"editor-modal-overlay",children:g.jsxs("div",{className:"editor-modal",children:[g.jsx("div",{className:"modal-title",children:"Hey!"}),g.jsx("div",{className:"modal-body",children:g.jsxs("p",{children:["If you use this website solely for the editor, ",g.jsx("strong",{children:"don't"}),". This is a fork of ",g.jsx("strong",{children:"JoSu! 2.0"})," (",g.jsx("a",{href:"https://preview.tryz.id.vn/",target:"_blank",rel:"noreferrer",children:"preview.tryz.id.vn"}),") adapted specifically for this website. JoSu is superior in almost every way."]})}),g.jsxs("div",{className:"modal-actions",children:[g.jsxs("label",{className:"check-bubble",children:[g.jsx("input",{type:"checkbox",checked:xt,onChange:v=>ut(v.target.checked)}),g.jsx("span",{className:"check-text",children:"Don't show this again"})]}),g.jsx("button",{className:"btn secondary",onClick:()=>{try{xt&&localStorage.setItem("editor:welcome:hidden","1")}catch{}St(!1)},children:"OK"})]})]})}),L&&g.jsxs("div",{className:"overlay editor-embed-overlay",role:"dialog","aria-modal":"true",children:[g.jsx("div",{className:"overlay-backdrop",onClick:()=>O(!1)}),g.jsxs("div",{className:"overlay-card embed-preview-card",children:[g.jsx("button",{className:"overlay-close",onClick:()=>O(!1),"aria-label":"Close embed preview",children:g.jsx(pe,{size:18})}),g.jsx("div",{className:"embed-preview-body",children:t?g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"embed-preview-playfield",children:[g.jsx(de,{beatmap:t,timeSec:h,backgroundUrl:s,skin:f,sliderBodyCutoffPx:w}),g.jsx(fe,{masterVolume:K,songVolume:$,hitsoundVolume:U,onMasterVolumeChange:it,onSongVolumeChange:l,onHitsoundVolumeChange:lt})]}),g.jsx(ue,{isPlaying:d,onPlayPause:k,currentTime:h,duration:G,onSeek:nt,bpm:V.bpm,sliderVelocity:V.sliderVelocity,timingPoints:t==null?void 0:t.timingPoints})]}):g.jsx("div",{className:"embed-preview-empty",children:"Load a beatmap to see the embed preview."})})]})]})]})};export{Je as A,ds as B,ue as C,us as E,Vt as H,de as P,fe as V,me as a,Ke as b,Ze as c,ns as l,te as p,Kt as r,$t as t};

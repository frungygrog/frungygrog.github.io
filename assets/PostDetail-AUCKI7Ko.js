import{K as E,N as D,r as n,j as s,P as z}from"./vendor-react-Bj2Cd7tG.js";import{P as A}from"./Post-CoqyTAhn.js";import{C as I}from"./Comment-Cj0oHYhA.js";import{u as H}from"./index-BY_UqR_j.js";import"./vendor-CBpd7OPg.js";import"./Popup-BlKZUnaV.js";import"./Player-6g6U1utb.js";import"./editor-lib-FG3lxfNK.js";import"./beatmap-preview-C7RhKmiP.js";import"./editor-components-B-SB05wW.js";const f="https://api.osumappi.ng";function L(l){var r;return(r=document.cookie.split("; ").map(e=>e.split("=")).find(([e])=>e===l))==null?void 0:r[1]}function Q(){const{uid:l}=E(),r=D(),[e,b]=n.useState(null),[j,v]=n.useState([]),[N,S]=n.useState(!0),[g,R]=n.useState(null),[c,p]=n.useState(""),[h,x]=n.useState(null),[y,C]=n.useState(!1),{notify:m}=H();n.useEffect(()=>{fetch(`${f}/api/me`,{credentials:"include"}).then(t=>t.ok?t.json():null).then(t=>R(t)).catch(()=>{})},[]);const P=async()=>{var t,o,d;if(l){S(!0);try{const a=await fetch(`${f}/api/moddiposts/${l}`,{credentials:"include"});if(a.ok){const i=await a.json(),B={...i,user_id:i.user_id??((t=i.author)==null?void 0:t.id),username:i.username??((o=i.author)==null?void 0:o.username),avatar_url:i.avatar_url??((d=i.author)==null?void 0:d.avatar_url),uid:i.uid||String(i.id)||l};b(B)}else{const i=await a.text().catch(()=>"");console.error("Failed to load moddi post:",a.status,i),m("Failed to load post",{variant:"error"}),r("/md/feed")}}catch(a){console.error("Error loading moddi post:",a),m("Failed to load post",{variant:"error"}),r("/md/feed")}finally{S(!1)}}},k=async()=>{if(e!=null&&e.id)try{const t=await fetch(`${f}/api/moddiposts/${e.id}/comments`,{credentials:"include"});if(t.ok){const o=await t.json();v(o.items||[])}}catch{}};n.useEffect(()=>{P()},[l]),n.useEffect(()=>{e!=null&&e.id&&k()},[e==null?void 0:e.id]);const _=t=>{b(t)},F=()=>{r("/md/feed")},T=async t=>{if(t.preventDefault(),!(!c.trim()||!(e!=null&&e.id))){C(!0);try{const o=L("csrf")||"",d=await fetch(`${f}/api/moddiposts/${e.id}/comments`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":o},body:JSON.stringify({text:c.trim(),parent_id:h||void 0})});if(d.ok)p(""),x(null),k(),P(),m("Comment posted!",{variant:"success"});else{const a=await d.json().catch(()=>({}));m(a.error||"Failed to post comment",{variant:"error"})}}catch{m("Failed to post comment",{variant:"error"})}finally{C(!1)}}},$=t=>{v(o=>o.filter(d=>d.id!==t))};if(N)return s.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Loading..."});if(!e)return s.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"Post not found"});const w=j.filter(t=>!t.parent_id),u=new Map;return j.filter(t=>t.parent_id).forEach(t=>{const o=t.parent_id;u.has(o)||u.set(o,[]),u.get(o).push(t)}),s.jsxs("div",{style:{width:"100%",maxWidth:"600px",margin:"0 auto",padding:"0 16px"},children:[s.jsxs("div",{style:{paddingTop:16,marginBottom:12,display:"flex",alignItems:"center",gap:12},children:[s.jsx("button",{className:"icon-link",onClick:()=>r("/md/feed"),style:{width:"auto",height:"auto",padding:"4px",background:"transparent"},title:"Back","aria-label":"Back",children:s.jsx(z,{size:20})}),s.jsx("span",{style:{fontSize:20,fontWeight:600,lineHeight:1},children:"Post"})]}),s.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:s.jsx(A,{post:e,section:"moddi",onUpdate:_,onDelete:F,me:g})}),g&&!h&&s.jsx("div",{style:{marginTop:12,marginBottom:12,padding:"8px 12px",background:"rgba(255,255,255,0.01)",border:"1px solid rgba(255,255,255,0.06)",borderRadius:6},children:s.jsxs("form",{onSubmit:T,style:{display:"flex",alignItems:"flex-end",gap:8},children:[s.jsx("textarea",{placeholder:"Write a comment...",value:c,onChange:t=>p(t.target.value),rows:1,style:{flex:1,background:"#0b0d10",border:"1px solid rgba(255,255,255,0.12)",borderRadius:6,padding:"6px 10px",color:"var(--text)",fontFamily:"inherit",fontSize:13,resize:"none",minHeight:"32px",maxHeight:"120px",overflowY:"auto"},onInput:t=>{const o=t.target;o.style.height="auto",o.style.height=`${Math.min(o.scrollHeight,120)}px`}}),s.jsx("button",{type:"submit",className:"btn compact",disabled:y||!c.trim(),style:{padding:"6px 12px",fontSize:12,flexShrink:0},children:y?"...":"Post"})]})}),s.jsx("div",{style:{borderTop:"1px solid rgba(255,255,255,0.06)",borderBottom:"1px solid rgba(255,255,255,0.06)"},children:w.length===0?s.jsx("div",{className:"muted",style:{textAlign:"center",padding:48},children:"No comments yet. Be the first to comment!"}):s.jsx("div",{className:"col",style:{gap:0},children:w.map(t=>s.jsx(I,{comment:t,replies:u.get(t.id)||[],me:g,section:"moddi",onReply:o=>x(o),onDelete:$,replyingTo:h,replyText:c,onReplyTextChange:p,onReplySubmit:T,posting:y,onCancelReply:()=>{x(null),p("")}},t.id))})})]})}export{Q as default};
